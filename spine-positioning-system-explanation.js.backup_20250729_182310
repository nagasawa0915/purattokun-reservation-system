// ğŸ¯ Spineç·¨é›†ã‚·ã‚¹ãƒ†ãƒ  v2.0 - ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ“ãƒ«ãƒ‰ç‰ˆ
// ã‚·ãƒ³ãƒ—ãƒ«ãƒ»ä¿å®ˆæ€§ãƒ»å‹•ä½œç¢ºå®Ÿæ€§ã‚’é‡è¦–ã—ãŸè¨­è¨ˆ

console.log('ğŸš€ Spineç·¨é›†ã‚·ã‚¹ãƒ†ãƒ  v2.0 èª­ã¿è¾¼ã¿é–‹å§‹');

// ========== åŸºæœ¬è¨­å®šãƒ»ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ========== //

// ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡
let isCharacterEditMode = false;
// Canvasç·¨é›†ãƒ¢ãƒ¼ãƒ‰å‰Šé™¤

// æ“ä½œçŠ¶æ…‹
let isDragging = false;
let isResizing = false;
let activeHandle = null;

// ãƒã‚¦ã‚¹æ“ä½œè¨˜éŒ²
let startMousePos = { x: 0, y: 0 };
let startElementState = {};

// DOMè¦ç´ å‚ç…§
let character = null;
// characterCanvaså‰Šé™¤ï¼šä¸è¦
let editConfirmPanel = null;
let coordinateDisplay = null;

// ä¿å­˜çŠ¶æ…‹ï¼ˆlocalStorageç”¨ãƒ»%åº§æ¨™ç³»çµ±ä¸€ãƒ»spine-sample-simple.htmlã®CSSå€¤ã¨ä¸€è‡´ï¼‰
let savedState = {
    character: { left: '35%', top: '75%', width: '25%' }
    // â˜ï¸ spine-sample-simple.htmlã®CSSå€¤ã¨å®Œå…¨ä¸€è‡´
};

console.log('âœ… v2.0 åŸºæœ¬è¨­å®šå®Œäº†');

// ========== DOMåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ  ========== //

function initializeDOMElements() {
    console.log('ğŸ”§ DOMåˆæœŸåŒ–é–‹å§‹');
    
    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¦ç´ ã‚’å–å¾—
    character = document.querySelector('#purattokun-canvas') || 
               document.querySelector('canvas[data-spine-character]') ||
               document.querySelector('#purattokun-fallback');
    
    if (!character) {
        console.error('âŒ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return false;
    }
    
    console.log('âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¦ç´ å–å¾—:', character.tagName);

    // Canvasè¦ç´ ã®å ´åˆã€ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä½œæˆ
    if (character.tagName === 'CANVAS') {
        console.log('âš ï¸ Canvasè¦ç´ æ¤œå‡º: ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä½œæˆã—ã¾ã™');
        
        // æ—¢å­˜ã®ãƒ©ãƒƒãƒ‘ãƒ¼ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        let existingWrapper = character.parentElement;
        if (existingWrapper && existingWrapper.classList.contains('character-wrapper')) {
            console.log('ğŸ”„ æ—¢å­˜ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’å†åˆ©ç”¨ã—ã¾ã™');
            character = existingWrapper;
        } else {
            // ğŸ¯ ä¿®æ­£: å®Ÿéš›ã®CSSè¨ˆç®—å€¤ã‚’æ­£ç¢ºã«å–å¾—
            const computedStyle = window.getComputedStyle(character);
            const parentRect = character.parentElement.getBoundingClientRect();
            
            const actualLeftPx = parseFloat(computedStyle.left);
            const actualTopPx = parseFloat(computedStyle.top);
            const actualWidthPx = parseFloat(computedStyle.width);
            const actualHeightPx = parseFloat(computedStyle.height);
            
            const actualLeftPercent = ((actualLeftPx / parentRect.width) * 100).toFixed(1);
            const actualTopPercent = ((actualTopPx / parentRect.height) * 100).toFixed(1);
            
            console.log("ğŸ”§ ãƒ©ãƒƒãƒ‘ãƒ¼ä½ç½®è¨ˆç®—ï¼ˆä¿®æ­£ç‰ˆï¼‰:", {
                computed_left: actualLeftPx + "px â†’ " + actualLeftPercent + "%",
                computed_top: actualTopPx + "px â†’ " + actualTopPercent + "%",
                width: actualWidthPx + "px",
                height: actualHeightPx + "px"
            });
            
            const characterWrapper = document.createElement('div');
            characterWrapper.className = 'character-wrapper demo-character';
            characterWrapper.style.cssText = `
                position: absolute;
                left: ${actualLeftPercent}%;
                top: ${actualTopPercent}%;
                width: ${actualWidthPx}px;
                height: ${actualHeightPx}px;
                transform: translate(-50%, -50%);
                cursor: move;
                border: 2px dashed rgba(255, 107, 107, 0.3);
                border-radius: 8px;
                transition: border-color 0.3s;
            `;
            
            // Canvasè¦ç´ ã‚’ãƒ©ãƒƒãƒ‘ãƒ¼ã§åŒ…ã‚€
            const parent = character.parentElement;
            parent.insertBefore(characterWrapper, character);
            characterWrapper.appendChild(character);
            
            // Canvasè¦ç´ ã®ä½ç½®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ©ãƒƒãƒ‘ãƒ¼ãŒåˆ¶å¾¡ï¼‰
            character.style.position = 'static';
            character.style.left = '';
            character.style.top = '';
            character.style.transform = '';
            
            // characterã‚’ãƒ©ãƒƒãƒ‘ãƒ¼ã«æ›´æ–°
            character = characterWrapper;
            
            console.log('âœ… Canvasè¦ç´ ãƒ©ãƒƒãƒ‘ãƒ¼ä½œæˆå®Œäº†');
        }
    }
    
    // ä¿å­˜çŠ¶æ…‹èª­ã¿è¾¼ã¿
    loadSavedState();
    
    // UIè¦ç´ ä½œæˆ
    createCoordinateDisplay();
    createConfirmPanel();
    
    // åˆæœŸçŠ¶æ…‹è¨­å®šï¼ˆcharacterè¦ç´ ãŒç¢ºå®Ÿã«å–å¾—ã•ã‚ŒãŸå¾Œã«å®Ÿè¡Œï¼‰
    if (character) {
        setupCharacterInitialState();
    } else {
        console.warn('âš ï¸ characterè¦ç´ ãŒnullã®ãŸã‚ã€åˆæœŸçŠ¶æ…‹è¨­å®šã‚’ã‚¹ã‚­ãƒƒãƒ—');
    }
    
    console.log('âœ… DOMåˆæœŸåŒ–å®Œäº†');
    return true;
}

// ğŸ—‘ï¸ Canvasä½œæˆå‰Šé™¤ï¼šä¸è¦ï¼ˆç›´æ¥characterè¦ç´ ã‚’ç·¨é›†ï¼‰

function setupCharacterInitialState() {
    console.log('ğŸ”§ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸçŠ¶æ…‹è¨­å®šé–‹å§‹ï¼ˆgetComputedStyleä½¿ç”¨ï¼‰');
    
    // characterè¦ç´ ã®å­˜åœ¨ç¢ºèª
    if (!character) {
        console.error('âŒ setupCharacterInitialState: characterè¦ç´ ãŒnullã§ã™');
        return;
    }
    
    // ğŸ¯ getComputedStyleã§å®Ÿéš›ã®ãƒ–ãƒ©ã‚¦ã‚¶è¨ˆç®—å€¤ã‚’å–å¾—
    const computedStyle = window.getComputedStyle(character);
    const parentRect = character.parentElement.getBoundingClientRect();
    
    // pxå€¤ã‚’%ã«å¤‰æ›
    const computedLeftPx = parseFloat(computedStyle.left);
    const computedTopPx = parseFloat(computedStyle.top);
    const computedWidthPx = parseFloat(computedStyle.width);
    
    const computedLeftPercent = ((computedLeftPx / parentRect.width) * 100).toFixed(1);
    const computedTopPercent = ((computedTopPx / parentRect.height) * 100).toFixed(1);
    const computedWidthPercent = ((computedWidthPx / parentRect.width) * 100).toFixed(1);
    
    console.log('ğŸ“Š ãƒ–ãƒ©ã‚¦ã‚¶è¨ˆç®—å€¤åˆ†æ:', {
        computed_px: {
            left: computedLeftPx + 'px',
            top: computedTopPx + 'px', 
            width: computedWidthPx + 'px'
        },
        computed_percent: {
            left: computedLeftPercent + '%',
            top: computedTopPercent + '%',
            width: computedWidthPercent + '%'
        },
        css_style: {
            left: character.style.left,
            top: character.style.top,
            width: character.style.width
        },
        saved_state: savedState.character
    });
    
    // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ãŒãªã„å ´åˆã®ã¿ã€è¨ˆç®—å€¤ãƒ™ãƒ¼ã‚¹ã§è¨­å®š
    if (!character.style.left) {
        character.style.left = computedLeftPercent + '%';
        console.log('âœ… leftè¨­å®š:', computedLeftPercent + '%');
    }
    if (!character.style.top) {
        character.style.top = computedTopPercent + '%';
        console.log('âœ… topè¨­å®š:', computedTopPercent + '%');
    }
    if (!character.style.width) {
        character.style.width = computedWidthPercent + '%';
        console.log('âœ… widthè¨­å®š:', computedWidthPercent + '%');
    }
    
    // åŸºæœ¬è¨­å®šã¯å¸¸ã«é©ç”¨
    character.style.position = 'absolute';
    character.style.transform = 'translate(-50%, -50%)';  // ä¸­å¿ƒç‚¹åŸºæº–
    
    console.log('âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸçŠ¶æ…‹è¨­å®šå®Œäº†ï¼ˆè¨ˆç®—å€¤ãƒ™ãƒ¼ã‚¹ï¼‰:', {
        left: character.style.left,
        top: character.style.top,
        width: character.style.width
    });
}

function createCoordinateDisplay() {
    coordinateDisplay = document.getElementById('coordinate-display');
    if (!coordinateDisplay) {
        coordinateDisplay = document.createElement('div');
        coordinateDisplay.id = 'coordinate-display';
        coordinateDisplay.style.cssText = `
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            display: none;
        `;
        document.body.appendChild(coordinateDisplay);
    }
    console.log('âœ… åº§æ¨™è¡¨ç¤ºä½œæˆå®Œäº†');
}

function createConfirmPanel() {
    editConfirmPanel = document.getElementById('edit-confirm-panel');
    if (!editConfirmPanel) {
        editConfirmPanel = document.createElement('div');
        editConfirmPanel.id = 'edit-confirm-panel';
        editConfirmPanel.className = 'confirm-panel';
        editConfirmPanel.innerHTML = `
            <div style="text-align: center; padding: 15px;">
                <p style="margin-bottom: 15px; font-weight: bold;">ç·¨é›†ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ</p>
                <button class="save-btn" onclick="confirmEdit()" style="margin-right: 10px; padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">ä¿å­˜</button>
                <button class="cancel-btn" onclick="cancelEdit()" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        `;
        editConfirmPanel.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 2px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
        `;
        document.body.appendChild(editConfirmPanel);
    }
    console.log('âœ… ç¢ºå®šãƒ‘ãƒãƒ«ä½œæˆå®Œäº†');
}

// ========== å¤–éƒ¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ========== //

function startCharacterEdit() {
    console.log('ğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼ˆè¨ˆç®—å€¤ãƒ™ãƒ¼ã‚¹ä½ç½®ä¿æŒï¼‰');
    
    // DOMåˆæœŸåŒ–ã‚’å…ˆã«å®Ÿè¡Œ
    if (!initializeDOMElements()) {
        console.error('âŒ DOMåˆæœŸåŒ–å¤±æ•—');
        return;
    }
    
    // characterè¦ç´ ã®å­˜åœ¨ç¢ºèª
    if (!character) {
        console.error('âŒ characterè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    
    // ğŸ¯ ç·¨é›†é–‹å§‹å‰ã®å®Ÿéš›ã®è¨ˆç®—å€¤ã‚’æ­£ç¢ºã«è¨˜éŒ²
    const computedStyle = window.getComputedStyle(character);
    const parentRect = character.parentElement.getBoundingClientRect();
    
    // pxå€¤ã‚’%ã«å¤‰æ›
    const actualLeftPx = parseFloat(computedStyle.left);
    const actualTopPx = parseFloat(computedStyle.top);
    const actualWidthPx = parseFloat(computedStyle.width);
    
    const actualLeftPercent = ((actualLeftPx / parentRect.width) * 100).toFixed(1);
    const actualTopPercent = ((actualTopPx / parentRect.height) * 100).toFixed(1);
    const actualWidthPercent = ((actualWidthPx / parentRect.width) * 100).toFixed(1);
    
    const preEditState = {
        computed_left: actualLeftPercent + '%',
        computed_top: actualTopPercent + '%',
        computed_width: actualWidthPercent + '%',
        style_left: character.style.left,
        style_top: character.style.top,
        style_width: character.style.width
    };
    
    console.log('ğŸ“ ç·¨é›†é–‹å§‹å‰ã®æ­£ç¢ºãªä½ç½®è¨˜éŒ²:', preEditState);
    
    // ğŸ”§ ç·¨é›†é–‹å§‹å¾Œã€å®Ÿéš›ã®è¨ˆç®—å€¤ã§æ­£ç¢ºã«å¾©å…ƒ
    console.log('ğŸ”§ æ­£ç¢ºãªä½ç½®å¾©å…ƒå®Ÿè¡Œ...');
    character.style.left = preEditState.computed_left;
    character.style.top = preEditState.computed_top;
    character.style.width = preEditState.computed_width;
    
    console.log('âœ… ä½ç½®å¾©å…ƒå®Œäº†:', {
        å¾©å…ƒå¾Œ_left: character.style.left,
        å¾©å…ƒå¾Œ_top: character.style.top,
        å¾©å…ƒå¾Œ_width: character.style.width
    });
    
    isCharacterEditMode = true;
    character.classList.add('edit-mode');
    
    // ãƒãƒ³ãƒ‰ãƒ«ä½œæˆ
    createHandles();
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    setupEventListeners();
    
    // UIæ›´æ–°
    updateUI();
    showConfirmPanel();
    
    console.log('âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–å®Œäº†ï¼ˆè¨ˆç®—å€¤ãƒ™ãƒ¼ã‚¹ä¿æŒï¼‰');
}

// ğŸ—‘ï¸ Canvasç·¨é›†æ©Ÿèƒ½å‰Šé™¤ï¼šè¡¨ç¤ºç¯„å›²ç·¨é›†ã¯ä¸è¦

// ========== ã‚³ã‚¢æ©Ÿèƒ½ï¼šç§»å‹•ãƒ»ä¿å­˜ãƒ»å¾©å…ƒ ========== //

function setupEventListeners() {
    console.log('ğŸ”§ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šé–‹å§‹');
    
    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆ
    if (isCharacterEditMode && character) {
        character.addEventListener('mousedown', startCharacterDrag);
    }
    
    // Canvasç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤ï¼šä¸è¦
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    
    console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
}

function startCharacterDrag(e) {
    // ãƒãƒ³ãƒ‰ãƒ«åˆ¤å®šã‚’å³å¯†ã«è¡Œã†
    if (!isCharacterEditMode || 
        e.target.classList.contains('handle') || 
        e.target.closest('.handle') ||
        isResizing) {
        console.log('ğŸš« characterç§»å‹•ã‚’ã‚¹ã‚­ãƒƒãƒ—:', {
            isCharacterEditMode,
            isHandle: e.target.classList.contains('handle'),
            isResizing
        });
        return;
    }
    
    console.log('ğŸ¯ characterç§»å‹•é–‹å§‹ï¼ˆ%ãƒ™ãƒ¼ã‚¹ï¼‰');
    e.preventDefault();
    isDragging = true;
    startMousePos = { x: e.clientX, y: e.clientY };
    
    // ç¾åœ¨ã®%ä½ç½®ã‚’è¨˜éŒ²
    startElementState = {
        leftPercent: parseFloat(character.style.left) || 35,
        topPercent: parseFloat(character.style.top) || 75
    };
    
    updateCoordinateDisplay();
    console.log('ğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ï¼ˆ%åº§æ¨™ï¼‰:', startElementState);
}

// ğŸ—‘ï¸ Canvasç§»å‹•å‰Šé™¤ï¼šä¸è¦

function handleMouseMove(e) {
    if (!isDragging && !isResizing) return;
    
    const deltaX = e.clientX - startMousePos.x;
    const deltaY = e.clientY - startMousePos.y;
    
    // ãƒªã‚µã‚¤ã‚ºã‚’å„ªå…ˆå‡¦ç†ï¼ˆãƒãƒ³ãƒ‰ãƒ«æ“ä½œï¼‰
    if (isResizing) {
        console.log('ğŸ”§ ãƒªã‚µã‚¤ã‚ºå‡¦ç†:', { deltaX, deltaY });
        performResize(deltaX, deltaY);
    } else if (isDragging) {
        console.log('ğŸ”§ ç§»å‹•å‡¦ç†:', { deltaX, deltaY });
        if (isCharacterEditMode) {
            moveCharacter(deltaX, deltaY);
        }
    }
    
    updateCoordinateDisplay();
}

function moveCharacter(deltaX, deltaY) {
    // ãƒã‚¦ã‚¹ç§»å‹•é‡ã‚’ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆ%ã«å¤‰æ›
    const parentRect = character.parentElement.getBoundingClientRect();
    const deltaXPercent = (deltaX / parentRect.width) * 100;
    const deltaYPercent = (deltaY / parentRect.height) * 100;
    
    let newLeftPercent = startElementState.leftPercent + deltaXPercent;
    let newTopPercent = startElementState.topPercent + deltaYPercent;
    
    // å¢ƒç•Œåˆ¶é™ï¼ˆ%ãƒ™ãƒ¼ã‚¹ï¼‰
    newLeftPercent = Math.max(5, Math.min(95, newLeftPercent));
    newTopPercent = Math.max(5, Math.min(95, newTopPercent));
    
    // %åº§æ¨™ã§ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
    character.style.left = newLeftPercent + '%';
    character.style.top = newTopPercent + '%';
    
    console.log('ğŸ”§ ç§»å‹•æ›´æ–°ï¼ˆ%ï¼‰:', {
        left: newLeftPercent.toFixed(1) + '%',
        top: newTopPercent.toFixed(1) + '%'
    });
}

// ğŸ—‘ï¸ Canvasç§»å‹•å‰Šé™¤ï¼šä¸è¦

function handleMouseUp() {
    if (isDragging || isResizing) {
        console.log('ğŸ”„ æ“ä½œçµ‚äº†:', { isDragging, isResizing });
        
        // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
        isDragging = false;
        isResizing = false;
        activeHandle = null;
        
        // CSSçŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
        if (character) {
            character.classList.remove('dragging', 'resize-mode');
        }
        // characterCanvaså‰Šé™¤æ¸ˆã¿ï¼šä¸è¦
        
        console.log('âœ… çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆå®Œäº†');
    }
}

function updateCoordinateDisplay() {
    if (!coordinateDisplay) return;
    
    coordinateDisplay.style.display = 'block';
    
    if (isCharacterEditMode && character) {
        const left = character.style.left || '35%';
        const top = character.style.top || '75%';
        const width = character.style.width || '25%';
        coordinateDisplay.textContent = `ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼: ${left}, ${top}, W=${width}`;
    }
}

function updateUI() {
    // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·¨é›†ã®ã¿ï¼‰
    const charBtn = document.getElementById('edit-character-btn');
    
    if (charBtn) {
        charBtn.textContent = isCharacterEditMode ? 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·¨é›†ä¸­...' : 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·¨é›†';
        charBtn.style.background = isCharacterEditMode ? '#4caf50' : '#ff6b6b';
    }
}

function showConfirmPanel() {
    if (editConfirmPanel) {
        editConfirmPanel.style.display = 'block';
    }
}

function hideConfirmPanel() {
    if (editConfirmPanel) {
        editConfirmPanel.style.display = 'none';
    }
}

// ========== ä¿å­˜ãƒ»å¾©å…ƒã‚·ã‚¹ãƒ†ãƒ  ========== //

function loadSavedState() {
    try {
        const saved = localStorage.getItem('spine-positioning-state');
        if (saved) {
            const loadedState = JSON.parse(saved);
            
            console.log('ğŸ“Š localStorageèª­ã¿è¾¼ã¿åˆ†æ:', {
                loaded: loadedState,
                default: savedState
            });
            
            // ğŸ”§ å¤ã„é–“é•ã£ãŸå€¤ã®æ¤œè¨¼ãƒ»ä¿®æ­£
            if (loadedState.character) {
                // topå€¤ãŒ50%ã®å ´åˆã¯é–“é•ã£ãŸå¤ã„å€¤ãªã®ã§ä¿®æ­£
                if (loadedState.character.top === '50%') {
                    console.log('ğŸ”§ å¤ã„é–“é•ã£ãŸtopå€¤æ¤œå‡ºãƒ»ä¿®æ­£:', loadedState.character.top, 'â†’ 75%');
                    loadedState.character.top = '75%';
                }
                
                // pxå˜ä½ã®å ´åˆã¯%ã«çµ±ä¸€
                if (loadedState.character.width && loadedState.character.width.includes('px')) {
                    console.log('ğŸ”§ pxå˜ä½æ¤œå‡ºãƒ»%ã«ä¿®æ­£:', loadedState.character.width, 'â†’ 25%');
                    loadedState.character.width = '25%';
                }
            }
            
            savedState = { ...savedState, ...loadedState };
            console.log('âœ… ä¿å­˜çŠ¶æ…‹èª­ã¿è¾¼ã¿ãƒ»æ¤œè¨¼å®Œäº†:', savedState);
        } else {
            console.log('ğŸ“ localStorageæœªä¿å­˜ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ä½¿ç”¨:', savedState);
        }
    } catch (e) {
        console.warn('âš ï¸ localStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
    }
}

function confirmEdit() {
    console.log('ğŸ’¾ ç·¨é›†å†…å®¹ä¿å­˜é–‹å§‹ï¼ˆ%ãƒ™ãƒ¼ã‚¹ï¼‰');
    
    // ç¾åœ¨ã®%çŠ¶æ…‹ã‚’ä¿å­˜
    if (character) {
        savedState.character = {
            left: character.style.left,     // ä¾‹: "35%"
            top: character.style.top,       // ä¾‹: "75%"
            width: character.style.width    // ä¾‹: "25%"
        };
    }
    
    // localStorageä¿å­˜
    try {
        localStorage.setItem('spine-positioning-state', JSON.stringify(savedState));
        console.log('âœ… ä¿å­˜å®Œäº†ï¼ˆ%åº§æ¨™ï¼‰:', savedState);
        
        if (coordinateDisplay) {
            coordinateDisplay.textContent = 'âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆ%åº§æ¨™ï¼‰';
            setTimeout(() => {
                coordinateDisplay.style.display = 'none';
            }, 2000);
        }
    } catch (e) {
        console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
    }
    
    endEditMode();
}

function cancelEdit() {
    console.log('ğŸ”„ ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ« - ãƒªãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ');
    
    if (coordinateDisplay) {
        coordinateDisplay.textContent = 'ğŸ”„ å‰å›ä¿å­˜ã—ãŸçŠ¶æ…‹ã«æˆ»ã—ã¦ã„ã¾ã™...';
    }
    
    setTimeout(() => {
        location.reload();
    }, 500);
}

function endEditMode() {
    console.log('ğŸ”„ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰çµ‚äº†');
    
    endCharacterEditMode();
    hideConfirmPanel();
    
    if (coordinateDisplay) {
        coordinateDisplay.style.display = 'none';
    }
}

function endCharacterEditMode() {
    isCharacterEditMode = false;
    
    if (character) {
        character.classList.remove('edit-mode');
        
        // ãƒãƒ³ãƒ‰ãƒ«å‰Šé™¤
        const handles = character.querySelectorAll('.handle');
        handles.forEach(handle => handle.remove());
    }
    
    updateUI();
    console.log('âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·¨é›†ãƒ¢ãƒ¼ãƒ‰çµ‚äº†');
}

// ğŸ—‘ï¸ Canvasç·¨é›†ãƒ¢ãƒ¼ãƒ‰çµ‚äº†é–¢æ•°å‰Šé™¤ï¼šä¸è¦

// ========== ã‚·ãƒ³ãƒ—ãƒ«ãƒ»ãƒãƒ³ãƒ‰ãƒ«ã‚·ã‚¹ãƒ†ãƒ  ========== //

function createHandles() {
    console.log('ğŸ”§ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒãƒ³ãƒ‰ãƒ«ä½œæˆé–‹å§‹');
    
    // æ—¢å­˜ãƒãƒ³ãƒ‰ãƒ«å‰Šé™¤
    const existingHandles = character.querySelectorAll('.handle');
    existingHandles.forEach(handle => handle.remove());
    
    // ãƒãƒ³ãƒ‰ãƒ«å®šç¾©ï¼ˆå¯¾è§’å›ºå®šç‚¹æ‹¡ç¸®ã‚·ã‚¹ãƒ†ãƒ ï¼‰
    const handlePositions = [
        // 4éš…ã®ç·‘ãƒãƒ³ãƒ‰ãƒ«ï¼ˆå¯¾è§’å›ºå®šç‚¹æ‹¡ç¸®ï¼‰
        { pos: 'nw', title: 'å¯¾è§’æ‹¡ç¸®ï¼ˆå³ä¸‹ã‚’å›ºå®šç‚¹ã¨ã—ã¦æ‹¡ç¸®ï¼‰', type: 'corner' },
        { pos: 'ne', title: 'å¯¾è§’æ‹¡ç¸®ï¼ˆå·¦ä¸‹ã‚’å›ºå®šç‚¹ã¨ã—ã¦æ‹¡ç¸®ï¼‰', type: 'corner' },
        { pos: 'sw', title: 'å¯¾è§’æ‹¡ç¸®ï¼ˆå³ä¸Šã‚’å›ºå®šç‚¹ã¨ã—ã¦æ‹¡ç¸®ï¼‰', type: 'corner' },
        { pos: 'se', title: 'å¯¾è§’æ‹¡ç¸®ï¼ˆå·¦ä¸Šã‚’å›ºå®šç‚¹ã¨ã—ã¦æ‹¡ç¸®ï¼‰', type: 'corner' },
        // è¾ºã®ä¸­å¤®ã®é’ãƒãƒ³ãƒ‰ãƒ«ï¼ˆåå¯¾å´å›ºå®šç‚¹æ‹¡ç¸®ï¼‰
        { pos: 'n', title: 'ä¸Šè¾ºï¼šä¸‹è¾ºã‚’å›ºå®šç‚¹ã¨ã—ã¦æ‹¡ç¸®', type: 'edge' },
        { pos: 's', title: 'ä¸‹è¾ºï¼šä¸Šè¾ºã‚’å›ºå®šç‚¹ã¨ã—ã¦æ‹¡ç¸®', type: 'edge' },
        { pos: 'w', title: 'å·¦è¾ºï¼šå³è¾ºã‚’å›ºå®šç‚¹ã¨ã—ã¦æ‹¡ç¸®', type: 'edge' },
        { pos: 'e', title: 'å³è¾ºï¼šå·¦è¾ºã‚’å›ºå®šç‚¹ã¨ã—ã¦æ‹¡ç¸®', type: 'edge' },
        // ä¸­å¤®ã®æ©™ãƒãƒ³ãƒ‰ãƒ«ï¼ˆä¸­å¿ƒæ‹¡ç¸®ï¼‰
        { pos: 'center', title: 'ä¸­å¿ƒæ‹¡ç¸®ï¼ˆä½ç½®å›ºå®šã§ã‚µã‚¤ã‚ºå¤‰æ›´ï¼‰', type: 'center' }
    ];
    
    // ãƒãƒ³ãƒ‰ãƒ«è¦ç´ ä½œæˆ
    handlePositions.forEach(handleDef => {
        const handle = document.createElement('div');
        handle.className = `handle ${handleDef.pos}`;
        handle.title = handleDef.title;
        handle.dataset.position = handleDef.pos;
        
        // ãƒãƒ³ãƒ‰ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«
        handle.style.cssText = `
            position: absolute;
            width: 12px;
            height: 12px;
            border: 2px solid #333;
            border-radius: 50%;
            cursor: pointer;
            z-index: 100;
            transition: all 0.2s;
        `;
        
        // ä½ç½®è¨­å®šã¨ã‚«ãƒ©ãƒ¼è¨­å®š
        switch (handleDef.pos) {
            // ğŸŸ¢ 4éš…ã®ç·‘ãƒãƒ³ãƒ‰ãƒ«ï¼ˆå¯¾è§’å›ºå®šç‚¹æ‹¡ç¸®ï¼‰
            case 'nw':
                handle.style.top = '-6px';
                handle.style.left = '-6px';
                handle.style.background = '#4caf50';
                break;
            case 'ne':
                handle.style.top = '-6px';
                handle.style.right = '-6px';
                handle.style.background = '#4caf50';
                break;
            case 'sw':
                handle.style.bottom = '-6px';
                handle.style.left = '-6px';
                handle.style.background = '#4caf50';
                break;
            case 'se':
                handle.style.bottom = '-6px';
                handle.style.right = '-6px';
                handle.style.background = '#4caf50';
                break;
            // ğŸ”µ è¾ºã®ä¸­å¤®ã®é’ãƒãƒ³ãƒ‰ãƒ«ï¼ˆåå¯¾å´å›ºå®šç‚¹æ‹¡ç¸®ï¼‰
            case 'n':
                handle.style.top = '-6px';
                handle.style.left = '50%';
                handle.style.transform = 'translateX(-50%)';
                handle.style.background = '#2196f3';
                break;
            case 's':
                handle.style.bottom = '-6px';
                handle.style.left = '50%';
                handle.style.transform = 'translateX(-50%)';
                handle.style.background = '#2196f3';
                break;
            case 'w':
                handle.style.left = '-6px';
                handle.style.top = '50%';
                handle.style.transform = 'translateY(-50%)';
                handle.style.background = '#2196f3';
                break;
            case 'e':
                handle.style.right = '-6px';
                handle.style.top = '50%';
                handle.style.transform = 'translateY(-50%)';
                handle.style.background = '#2196f3';
                break;
            // ğŸŸ  ä¸­å¤®ã®æ©™ãƒãƒ³ãƒ‰ãƒ«ï¼ˆä¸­å¿ƒæ‹¡ç¸®ï¼‰
            case 'center':
                handle.style.top = '50%';
                handle.style.left = '50%';
                handle.style.transform = 'translate(-50%, -50%)';
                handle.style.background = '#ff9800';
                handle.style.width = '16px';
                handle.style.height = '16px';
                break;
        }
        
        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå¯¾è§’å›ºå®šç‚¹æ‹¡ç¸®ã‚·ã‚¹ãƒ†ãƒ ï¼‰
        handle.addEventListener('mousedown', (e) => {
            console.log('ğŸ¯ ãƒãƒ³ãƒ‰ãƒ«mousedown:', handleDef.pos, handleDef.type);
            e.stopPropagation();
            e.preventDefault();
            // characterè¦ç´ ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–
            isDragging = false;
            isResizing = false;
            startFixedPointResize(e, handleDef.pos, handleDef.type);
        }, true); // ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿè¡Œ
        
        character.appendChild(handle);
    });
    
    console.log('âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒãƒ³ãƒ‰ãƒ«ä½œæˆå®Œäº†');
}

// ğŸ—‘ï¸ Canvasãƒãƒ³ãƒ‰ãƒ«ä½œæˆå‰Šé™¤ï¼šä¸è¦

function startFixedPointResize(e, position, type) {
    console.log('ğŸ¯ å¯¾è§’å›ºå®šç‚¹æ‹¡ç¸®é–‹å§‹ï¼ˆ%ãƒ™ãƒ¼ã‚¹ï¼‰:', { position, type });
    
    e.preventDefault();
    e.stopPropagation();
    
    // ç¢ºå®Ÿã«çŠ¶æ…‹è¨­å®š
    isDragging = false; // ç§»å‹•ãƒ¢ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹åŒ–
    isResizing = true;  // ãƒªã‚µã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–
    activeHandle = { dataset: { position, type } };
    startMousePos = { x: e.clientX, y: e.clientY };
    
    // ç¾åœ¨ã®%çŠ¶æ…‹ã‚’è¨˜éŒ²
    const currentLeftPercent = parseFloat(character.style.left) || 35;
    const currentTopPercent = parseFloat(character.style.top) || 75;
    const currentWidthPercent = parseFloat(character.style.width) || 25;
    
    startElementState = {
        leftPercent: currentLeftPercent,
        topPercent: currentTopPercent,
        widthPercent: currentWidthPercent,
        // å›ºå®šç‚¹%åº§æ¨™ï¼ˆå¯¾è§’å›ºå®šç‚¹è¨ˆç®—ç”¨ï¼‰
        leftEdgePercent: currentLeftPercent - currentWidthPercent / 2,
        rightEdgePercent: currentLeftPercent + currentWidthPercent / 2,
        topEdgePercent: currentTopPercent - currentWidthPercent / 2,     // æ­£æ–¹å½¢æ¯”ç‡æƒ³å®š
        bottomEdgePercent: currentTopPercent + currentWidthPercent / 2
    };
    
    character.classList.add('resize-mode');
    console.log('âœ… å¯¾è§’å›ºå®šç‚¹æ‹¡ç¸®æº–å‚™å®Œäº†ï¼ˆ%åº§æ¨™ï¼‰:', startElementState);
}

// ğŸ—‘ï¸ Canvasæ‹¡ç¸®å‰Šé™¤ï¼šä¸è¦

function performResize(deltaX, deltaY) {
    if (!activeHandle) return;
    
    const position = activeHandle.dataset.position;
    const type = activeHandle.dataset.type || 'character';
    
    console.log('ğŸ”§ ãƒªã‚µã‚¤ã‚ºå®Ÿè¡Œ:', { position, type, deltaX, deltaY });
    
    // Canvasç·¨é›†å‰Šé™¤ï¼šã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·¨é›†ã®ã¿å¯¾å¿œ
    if (type === 'character' || type === 'corner' || type === 'edge' || type === 'center') {
        performCharacterResize(deltaX, deltaY, position);
    }
}

function performCharacterResize(deltaX, deltaY, position) {
    const type = activeHandle.dataset.type;
    let newLeftPercent = startElementState.leftPercent;
    let newTopPercent = startElementState.topPercent;
    let newWidthPercent = startElementState.widthPercent;
    
    // ãƒã‚¦ã‚¹ç§»å‹•é‡ã‚’%ã‚¹ã‚±ãƒ¼ãƒ«ã«å¤‰æ›ï¼ˆæ„Ÿåº¦èª¿æ•´ï¼‰
    const parentRect = character.parentElement.getBoundingClientRect();
    const scaleFactorX = (deltaX / parentRect.width) * 100;
    const scaleFactorY = (deltaY / parentRect.height) * 100;
    const combinedScaleFactor = (scaleFactorX + scaleFactorY) / 2; // å¹³å‡å€¤
    
    // %ãƒ™ãƒ¼ã‚¹ã§ã®ã‚µã‚¤ã‚ºå¤‰æ›´
    const sizeChange = combinedScaleFactor * 0.5; // æ„Ÿåº¦èª¿æ•´
    newWidthPercent = Math.max(5, Math.min(50, startElementState.widthPercent + sizeChange));
    
    console.log('ğŸ“Š %ãƒ™ãƒ¼ã‚¹ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—:', {
        deltaX, deltaY, scaleFactorX, scaleFactorY, combinedScaleFactor,
        sizeChange, newWidthPercent, type, position
    });
    
    if (type === 'center') {
        // ğŸŸ  ä¸­å¿ƒæ‹¡ç¸®ï¼šä½ç½®å›ºå®šã§ã‚µã‚¤ã‚ºã®ã¿å¤‰æ›´
        // newLeftPercent, newTopPercentã¯ãã®ã¾ã¾ï¼ˆä½ç½®ç¶­æŒï¼‰
        
    } else if (type === 'corner') {
        // ğŸŸ¢ è§’ãƒãƒ³ãƒ‰ãƒ«ï¼šå¯¾è§’ã®è§’ã‚’å›ºå®šç‚¹ã¨ã—ã¦æ‹¡ç¸®
        const halfSizeChange = (newWidthPercent - startElementState.widthPercent) / 2;
        
        switch (position) {
            case 'nw': // å·¦ä¸Š â†’ å³ä¸‹ã‚’å›ºå®šç‚¹ã¨ã—ã¦æ‹¡ç¸®
                newLeftPercent = startElementState.rightEdgePercent - newWidthPercent / 2;
                newTopPercent = startElementState.bottomEdgePercent - newWidthPercent / 2;
                break;
            case 'ne': // å³ä¸Š â†’ å·¦ä¸‹ã‚’å›ºå®šç‚¹ã¨ã—ã¦æ‹¡ç¸®
                newLeftPercent = startElementState.leftEdgePercent + newWidthPercent / 2;
                newTopPercent = startElementState.bottomEdgePercent - newWidthPercent / 2;
                break;
            case 'sw': // å·¦ä¸‹ â†’ å³ä¸Šã‚’å›ºå®šç‚¹ã¨ã—ã¦æ‹¡ç¸®
                newLeftPercent = startElementState.rightEdgePercent - newWidthPercent / 2;
                newTopPercent = startElementState.topEdgePercent + newWidthPercent / 2;
                break;
            case 'se': // å³ä¸‹ â†’ å·¦ä¸Šã‚’å›ºå®šç‚¹ã¨ã—ã¦æ‹¡ç¸®
                newLeftPercent = startElementState.leftEdgePercent + newWidthPercent / 2;
                newTopPercent = startElementState.topEdgePercent + newWidthPercent / 2;
                break;
        }
        
    } else if (type === 'edge') {
        // ğŸ”µ è¾ºãƒãƒ³ãƒ‰ãƒ«ï¼šåå¯¾å´ã®è¾ºã‚’å›ºå®šç‚¹ã¨ã—ã¦æ‹¡ç¸®
        switch (position) {
            case 'n': // ä¸Šè¾º â†’ ä¸‹è¾ºã‚’å›ºå®šã¨ã—ã¦æ‹¡ç¸®
                newTopPercent = startElementState.bottomEdgePercent - newWidthPercent / 2;
                break;
            case 's': // ä¸‹è¾º â†’ ä¸Šè¾ºã‚’å›ºå®šã¨ã—ã¦æ‹¡ç¸®
                newTopPercent = startElementState.topEdgePercent + newWidthPercent / 2;
                break;
            case 'w': // å·¦è¾º â†’ å³è¾ºã‚’å›ºå®šã¨ã—ã¦æ‹¡ç¸®
                newLeftPercent = startElementState.rightEdgePercent - newWidthPercent / 2;
                break;
            case 'e': // å³è¾º â†’ å·¦è¾ºã‚’å›ºå®šã¨ã—ã¦æ‹¡ç¸®
                newLeftPercent = startElementState.leftEdgePercent + newWidthPercent / 2;
                break;
        }
    }
    
    // %åº§æ¨™ã§ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
    character.style.left = newLeftPercent + '%';
    character.style.top = newTopPercent + '%';
    character.style.width = newWidthPercent + '%';
    
    console.log('ğŸ¨ %ãƒ™ãƒ¼ã‚¹CSSé©ç”¨:', {
        left: newLeftPercent.toFixed(1) + '%',
        top: newTopPercent.toFixed(1) + '%',
        width: newWidthPercent.toFixed(1) + '%'
    });
    
    updateCoordinateDisplay();
}

// ğŸ—‘ï¸ Canvasæ‹¡ç¸®å‰Šé™¤ï¼šä¸è¦

console.log('ğŸ¯ Spineç·¨é›†ã‚·ã‚¹ãƒ†ãƒ  v2.0 èª­ã¿è¾¼ã¿å®Œäº† - å…¨æ©Ÿèƒ½å®Ÿè£…æ¸ˆã¿');