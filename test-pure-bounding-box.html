<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PureBoundingBox 🆕BB外クリック機能テスト</title>
    <style>
        body {
            background: #f0f0f0;
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
            /* 👁️ タッチイベント最適化 */
            touch-action: none;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-area {
            position: relative;
            width: 800px;
            height: 500px;
            background: #e8f4f8;
            border: 2px solid #007cba;
            margin: 20px auto;
            border-radius: 10px;
            /* タッチアクション最適化 */
            touch-action: none;
        }
        .layout-anchor {
            position: absolute;
            background: rgba(255, 107, 107, 0.3);
            border: 2px solid #ff6b6b;
            border-radius: 8px;
            /* 中心基準配置 - 本番システムと同じ */
            transform: translate(-50%, -50%);
            /* タッチアクション最適化 */
            touch-action: none;
        }
        .interactive {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-weight: bold;
            cursor: pointer;
            /* CSS変数オフセット対応 */
            transform: translate(var(--tx, 0), var(--ty, 0));
            /* タッチアクション最適化 */
            touch-action: none;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #005a8a;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #007cba; }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin: 0 5px;
        }
        .status.active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.inactive {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .instructions {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .instructions h3 {
            margin-top: 0;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🆕 PureBoundingBox - BB外クリック機能テスト</h1>
        
        <div class="instructions">
            <h3>📝 テスト手順</h3>
            <ol>
                <li><strong>「選択開始」</strong>ボタンをクリック → 青いBB框が表示されます</li>
                <li><strong>赤いボックス内</strong>でドラッグ → 位置が変わります（%→pxスワップ）</li>
                <li><strong>灰色のエリアをクリック</strong> → BBが非表示になります（px→%スワップ）</li>
                <li><strong>ログで動作確認</strong> → コミット処理やlocalStorage保存が実行されるか確認</li>
            </ol>
            <p><strong>🎯 期待動作</strong>：本番環境（index.html?edit=true）と同じ選択解除動作</p>
        </div>
        
        <div class="controls">
            <button onclick="startBoundingBoxTest()">BB選択開始</button>
            <button onclick="hideBoundingBox()">BB非表示</button>
            <button onclick="showCurrentPosition()">Current Position</button>
            <button onclick="testManualDeselect()">Manual Deselect</button>
            <button onclick="clearLog()">Log Clear</button>
        </div>
        
        <div>
            状態: 
            <span id="bb-status" class="status inactive">BB Inactive</span>
            <span id="drag-status" class="status inactive">Drag Inactive</span>
            <span id="outside-click-status" class="status inactive">Outside Click Inactive</span>
        </div>
        
        <!-- 🎯 メインテストエリア -->
        <div class="test-area" id="test-area">
            <!-- 本番システム互換のlayout-anchor -->
            <div class="layout-anchor" id="test-target" style="left: 30%; top: 40%; width: 120px; height: 80px;">
                <div class="interactive">
                    <span>Test Element<br>🎯 Click & Drag</span>
                </div>
            </div>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <!-- 🕹️ PureBoundingBox マイクロモジュール群 -->
    <script src="micromodules/bounding-box/PureBoundingBoxCore.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxBounds.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxUI.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxEvents.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBox.js"></script>
    
    <script>
        const logElement = document.getElementById('log');
        const bbStatusElement = document.getElementById('bb-status');
        const dragStatusElement = document.getElementById('drag-status');
        const outsideClickStatusElement = document.getElementById('outside-click-status');
        let currentBoundingBox = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            const logLine = `[${timestamp}] ${message}\n`;
            
            const span = document.createElement('span');
            span.className = className;
            span.textContent = logLine;
            logElement.appendChild(span);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            logElement.innerHTML = '';
        }
        
        function updateStatus(bbVisible, isDragging, outsideClickActive) {
            bbStatusElement.textContent = bbVisible ? 'BB Active' : 'BB Inactive';
            bbStatusElement.className = `status ${bbVisible ? 'active' : 'inactive'}`;
            
            dragStatusElement.textContent = isDragging ? 'Dragging' : 'Drag Inactive';
            dragStatusElement.className = `status ${isDragging ? 'active' : 'inactive'}`;
            
            outsideClickStatusElement.textContent = outsideClickActive ? 'Outside Click Listening' : 'Outside Click Inactive';
            outsideClickStatusElement.className = `status ${outsideClickActive ? 'active' : 'inactive'}`;
        }
        
        // 🆕 BB選択開始テスト
        async function startBoundingBoxTest() {
            log('=== BB選択開始テスト ===', 'success');
            
            try {
                // 既存のBBがある場合はクリーンアップ
                if (currentBoundingBox) {
                    currentBoundingBox.cleanup();
                    currentBoundingBox = null;
                }
                
                const targetElement = document.getElementById('test-target');
                if (!targetElement) {
                    throw new Error('テスト要素が見つかりません');
                }
                
                log('🎯 ターゲット要素確認完了');
                
                // PureBoundingBoxインスタンス作成
                currentBoundingBox = new PureBoundingBox({
                    targetElement: targetElement,
                    nodeId: 'test-element-bb'
                });
                
                log('🔧 PureBoundingBoxインスタンス作成完了');
                
                // BB実行開始
                const result = await currentBoundingBox.execute({ visible: true });
                
                if (result.success) {
                    log('✅ BB実行成功', 'success');
                    log(`  nodeId: ${result.nodeId}`);
                    log(`  bounds: ${JSON.stringify(result.bounds)}`);
                    updateStatus(true, false, true);
                    
                    // 🆕 カスタムイベントリスナー登録
                    document.addEventListener('boundingBoxDeselected', onBoundingBoxDeselected);
                    log('📡 boundingBoxDeselectedイベントリスナー登録完了');
                    
                } else {
                    throw new Error(result.error || '不明なエラー');
                }
                
            } catch (error) {
                log(`❌ BB選択開始エラー: ${error.message}`, 'error');
                updateStatus(false, false, false);
            }
        }
        
        // 🆕 BB選択解除イベントハンドラー
        function onBoundingBoxDeselected(event) {
            log('=== BB選択解除イベント受信 ===', 'info');
            log(`  nodeId: ${event.detail.nodeId}`);
            log(`  finalPosition:`, 'info');
            log(`    left: ${event.detail.finalPosition.left}`);
            log(`    top: ${event.detail.finalPosition.top}`);
            log(`    width: ${event.detail.finalPosition.width}`);
            log(`    height: ${event.detail.finalPosition.height}`);
            log(`  timestamp: ${event.detail.timestamp}`);
            
            updateStatus(false, false, false);
            log('✅ BB選択解除イベント処理完了', 'success');
        }
        
        // BB手動非表示
        function hideBoundingBox() {
            if (currentBoundingBox) {
                currentBoundingBox.hide();
                updateStatus(false, false, false);
                log('🙈 BB手動非表示完了');
            } else {
                log('⚠️ BBインスタンスがありません', 'warning');
            }
        }
        
        // 現在位置表示
        function showCurrentPosition() {
            const targetElement = document.getElementById('test-target');
            if (!targetElement) return;
            
            const style = targetElement.style;
            const computedStyle = getComputedStyle(targetElement);
            const interactive = targetElement.querySelector('.interactive');
            
            log('=== 現在位置情報 ===', 'info');
            log(`Style値:`);
            log(`  left: ${style.left}`);
            log(`  top: ${style.top}`);
            log(`  width: ${style.width}`);
            log(`  height: ${style.height}`);
            log(`  transform: ${style.transform}`);
            
            if (interactive) {
                const interactiveCS = getComputedStyle(interactive);
                const tx = interactiveCS.getPropertyValue('--tx');
                const ty = interactiveCS.getPropertyValue('--ty');
                log(`CSS変数:`);
                log(`  --tx: ${tx}`);
                log(`  --ty: ${ty}`);
            }
            
            // getBoundingClientRect情報
            const rect = targetElement.getBoundingClientRect();
            const parentRect = targetElement.parentElement.getBoundingClientRect();
            log(`コンピューター値:`);
            log(`  rect: ${rect.left.toFixed(1)}, ${rect.top.toFixed(1)}, ${rect.width.toFixed(1)} x ${rect.height.toFixed(1)}`);
            log(`  parent: ${parentRect.left.toFixed(1)}, ${parentRect.top.toFixed(1)}, ${parentRect.width.toFixed(1)} x ${parentRect.height.toFixed(1)}`);
        }
        
        // 手動選択解除テスト
        function testManualDeselect() {
            if (currentBoundingBox && currentBoundingBox.events) {
                log('🔄 手動選択解除テスト実行');
                currentBoundingBox.events.deselectBoundingBox();
            } else {
                log('⚠️ BBインスタンスまたはEventsモジュールがありません', 'warning');
            }
        }
        
        // ドラッグ状態監視
        function monitorDragState() {
            setInterval(() => {
                if (currentBoundingBox && currentBoundingBox.core) {
                    const isDragging = currentBoundingBox.core.dragState.isDragging;
                    const wasUpdated = dragStatusElement.textContent.includes('Dragging') !== isDragging;
                    
                    if (wasUpdated) {
                        updateStatus(
                            currentBoundingBox.core.uiState.visible,
                            isDragging,
                            currentBoundingBox.events.isListeningForOutsideClicks
                        );
                    }
                }
            }, 100);
        }
        
        // オリジナルのconsoleをラップ
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            if (!args.join(' ').includes('👁️') || args.join(' ').includes('BB')) {
                log(args.join(' '), 'info');
            }
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            log(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            log(args.join(' '), 'warning');
        };
        
        // ページ読み込み時
        window.addEventListener('load', () => {
            log('🌐 PureBoundingBox BB外クリックテストページ読み込み完了');
            log('');
            log('🎯 テスト目標:');
            log('  1. BB選択開始時の座標スワップ (%→px)');
            log('  2. BB外クリック時の選択解除 (px→%)');
            log('  3. 座標コミット処理の正常動作');
            log('  4. localStorage連携の確認');
            log('  5. カスタムイベント発火の確認');
            log('');
            log('▶️ 「BB選択開始」ボタンでテスト開始');
            
            // ドラッグ状態監視開始
            monitorDragState();
        });
        
        // クリーンアップ
        window.addEventListener('beforeunload', () => {
            if (currentBoundingBox) {
                currentBoundingBox.cleanup();
            }
        });
    </script>
</body>
</html>