<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PureBoundingBox ğŸ†•BBå¤–ã‚¯ãƒªãƒƒã‚¯æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            background: #f0f0f0;
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
            /* ğŸ‘ï¸ ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆæœ€é©åŒ– */
            touch-action: none;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-area {
            position: relative;
            width: 800px;
            height: 500px;
            background: #e8f4f8;
            border: 2px solid #007cba;
            margin: 20px auto;
            border-radius: 10px;
            /* ã‚¿ãƒƒãƒã‚¢ã‚¯ã‚·ãƒ§ãƒ³æœ€é©åŒ– */
            touch-action: none;
        }
        .layout-anchor {
            position: absolute;
            background: rgba(255, 107, 107, 0.3);
            border: 2px solid #ff6b6b;
            border-radius: 8px;
            /* ä¸­å¿ƒåŸºæº–é…ç½® - æœ¬ç•ªã‚·ã‚¹ãƒ†ãƒ ã¨åŒã˜ */
            transform: translate(-50%, -50%);
            /* ã‚¿ãƒƒãƒã‚¢ã‚¯ã‚·ãƒ§ãƒ³æœ€é©åŒ– */
            touch-action: none;
        }
        .interactive {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-weight: bold;
            cursor: pointer;
            /* CSSå¤‰æ•°ã‚ªãƒ•ã‚»ãƒƒãƒˆå¯¾å¿œ */
            transform: translate(var(--tx, 0), var(--ty, 0));
            /* ã‚¿ãƒƒãƒã‚¢ã‚¯ã‚·ãƒ§ãƒ³æœ€é©åŒ– */
            touch-action: none;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #005a8a;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #007cba; }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin: 0 5px;
        }
        .status.active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.inactive {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .instructions {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .instructions h3 {
            margin-top: 0;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ†• PureBoundingBox - BBå¤–ã‚¯ãƒªãƒƒã‚¯æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="instructions">
            <h3>ğŸ“ ãƒ†ã‚¹ãƒˆæ‰‹é †</h3>
            <ol>
                <li><strong>ã€Œé¸æŠé–‹å§‹ã€</strong>ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ é’ã„BBæ¡†ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>
                <li><strong>èµ¤ã„ãƒœãƒƒã‚¯ã‚¹å†…</strong>ã§ãƒ‰ãƒ©ãƒƒã‚° â†’ ä½ç½®ãŒå¤‰ã‚ã‚Šã¾ã™ï¼ˆ%â†’pxã‚¹ãƒ¯ãƒƒãƒ—ï¼‰</li>
                <li><strong>ç°è‰²ã®ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯</strong> â†’ BBãŒéè¡¨ç¤ºã«ãªã‚Šã¾ã™ï¼ˆpxâ†’%ã‚¹ãƒ¯ãƒƒãƒ—ï¼‰</li>
                <li><strong>ãƒ­ã‚°ã§å‹•ä½œç¢ºèª</strong> â†’ ã‚³ãƒŸãƒƒãƒˆå‡¦ç†ã‚„localStorageä¿å­˜ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‹ç¢ºèª</li>
            </ol>
            <p><strong>ğŸ¯ æœŸå¾…å‹•ä½œ</strong>ï¼šæœ¬ç•ªç’°å¢ƒï¼ˆindex.html?edit=trueï¼‰ã¨åŒã˜é¸æŠè§£é™¤å‹•ä½œ</p>
        </div>
        
        <div class="controls">
            <button onclick="startBoundingBoxTest()">BBé¸æŠé–‹å§‹</button>
            <button onclick="hideBoundingBox()">BBéè¡¨ç¤º</button>
            <button onclick="showCurrentPosition()">Current Position</button>
            <button onclick="testManualDeselect()">Manual Deselect</button>
            <button onclick="clearLog()">Log Clear</button>
        </div>
        
        <div>
            çŠ¶æ…‹: 
            <span id="bb-status" class="status inactive">BB Inactive</span>
            <span id="drag-status" class="status inactive">Drag Inactive</span>
            <span id="outside-click-status" class="status inactive">Outside Click Inactive</span>
        </div>
        
        <!-- ğŸ¯ ãƒ¡ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆã‚¨ãƒªã‚¢ -->
        <div class="test-area" id="test-area">
            <!-- æœ¬ç•ªã‚·ã‚¹ãƒ†ãƒ äº’æ›ã®layout-anchor -->
            <div class="layout-anchor" id="test-target" style="left: 30%; top: 40%; width: 120px; height: 80px;">
                <div class="interactive">
                    <span>Test Element<br>ğŸ¯ Click & Drag</span>
                </div>
            </div>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <!-- ğŸ•¹ï¸ PureBoundingBox ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç¾¤ -->
    <script src="micromodules/bounding-box/PureBoundingBoxCore.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxBounds.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxUI.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxEvents.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBox.js"></script>
    
    <script>
        const logElement = document.getElementById('log');
        const bbStatusElement = document.getElementById('bb-status');
        const dragStatusElement = document.getElementById('drag-status');
        const outsideClickStatusElement = document.getElementById('outside-click-status');
        let currentBoundingBox = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            const logLine = `[${timestamp}] ${message}\n`;
            
            const span = document.createElement('span');
            span.className = className;
            span.textContent = logLine;
            logElement.appendChild(span);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            logElement.innerHTML = '';
        }
        
        function updateStatus(bbVisible, isDragging, outsideClickActive) {
            bbStatusElement.textContent = bbVisible ? 'BB Active' : 'BB Inactive';
            bbStatusElement.className = `status ${bbVisible ? 'active' : 'inactive'}`;
            
            dragStatusElement.textContent = isDragging ? 'Dragging' : 'Drag Inactive';
            dragStatusElement.className = `status ${isDragging ? 'active' : 'inactive'}`;
            
            outsideClickStatusElement.textContent = outsideClickActive ? 'Outside Click Listening' : 'Outside Click Inactive';
            outsideClickStatusElement.className = `status ${outsideClickActive ? 'active' : 'inactive'}`;
        }
        
        // ğŸ†• BBé¸æŠé–‹å§‹ãƒ†ã‚¹ãƒˆ
        async function startBoundingBoxTest() {
            log('=== BBé¸æŠé–‹å§‹ãƒ†ã‚¹ãƒˆ ===', 'success');
            
            try {
                // æ—¢å­˜ã®BBãŒã‚ã‚‹å ´åˆã¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                if (currentBoundingBox) {
                    currentBoundingBox.cleanup();
                    currentBoundingBox = null;
                }
                
                const targetElement = document.getElementById('test-target');
                if (!targetElement) {
                    throw new Error('ãƒ†ã‚¹ãƒˆè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                log('ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¦ç´ ç¢ºèªå®Œäº†');
                
                // PureBoundingBoxã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                currentBoundingBox = new PureBoundingBox({
                    targetElement: targetElement,
                    nodeId: 'test-element-bb'
                });
                
                log('ğŸ”§ PureBoundingBoxã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆå®Œäº†');
                
                // BBå®Ÿè¡Œé–‹å§‹
                const result = await currentBoundingBox.execute({ visible: true });
                
                if (result.success) {
                    log('âœ… BBå®Ÿè¡ŒæˆåŠŸ', 'success');
                    log(`  nodeId: ${result.nodeId}`);
                    log(`  bounds: ${JSON.stringify(result.bounds)}`);
                    updateStatus(true, false, true);
                    
                    // ğŸ†• ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
                    document.addEventListener('boundingBoxDeselected', onBoundingBoxDeselected);
                    log('ğŸ“¡ boundingBoxDeselectedã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²å®Œäº†');
                    
                } else {
                    throw new Error(result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
                }
                
            } catch (error) {
                log(`âŒ BBé¸æŠé–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStatus(false, false, false);
            }
        }
        
        // ğŸ†• BBé¸æŠè§£é™¤ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        function onBoundingBoxDeselected(event) {
            log('=== BBé¸æŠè§£é™¤ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ ===', 'info');
            log(`  nodeId: ${event.detail.nodeId}`);
            log(`  finalPosition:`, 'info');
            log(`    left: ${event.detail.finalPosition.left}`);
            log(`    top: ${event.detail.finalPosition.top}`);
            log(`    width: ${event.detail.finalPosition.width}`);
            log(`    height: ${event.detail.finalPosition.height}`);
            log(`  timestamp: ${event.detail.timestamp}`);
            
            updateStatus(false, false, false);
            log('âœ… BBé¸æŠè§£é™¤ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†å®Œäº†', 'success');
        }
        
        // BBæ‰‹å‹•éè¡¨ç¤º
        function hideBoundingBox() {
            if (currentBoundingBox) {
                currentBoundingBox.hide();
                updateStatus(false, false, false);
                log('ğŸ™ˆ BBæ‰‹å‹•éè¡¨ç¤ºå®Œäº†');
            } else {
                log('âš ï¸ BBã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
            }
        }
        
        // ç¾åœ¨ä½ç½®è¡¨ç¤º
        function showCurrentPosition() {
            const targetElement = document.getElementById('test-target');
            if (!targetElement) return;
            
            const style = targetElement.style;
            const computedStyle = getComputedStyle(targetElement);
            const interactive = targetElement.querySelector('.interactive');
            
            log('=== ç¾åœ¨ä½ç½®æƒ…å ± ===', 'info');
            log(`Styleå€¤:`);
            log(`  left: ${style.left}`);
            log(`  top: ${style.top}`);
            log(`  width: ${style.width}`);
            log(`  height: ${style.height}`);
            log(`  transform: ${style.transform}`);
            
            if (interactive) {
                const interactiveCS = getComputedStyle(interactive);
                const tx = interactiveCS.getPropertyValue('--tx');
                const ty = interactiveCS.getPropertyValue('--ty');
                log(`CSSå¤‰æ•°:`);
                log(`  --tx: ${tx}`);
                log(`  --ty: ${ty}`);
            }
            
            // getBoundingClientRectæƒ…å ±
            const rect = targetElement.getBoundingClientRect();
            const parentRect = targetElement.parentElement.getBoundingClientRect();
            log(`ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼å€¤:`);
            log(`  rect: ${rect.left.toFixed(1)}, ${rect.top.toFixed(1)}, ${rect.width.toFixed(1)} x ${rect.height.toFixed(1)}`);
            log(`  parent: ${parentRect.left.toFixed(1)}, ${parentRect.top.toFixed(1)}, ${parentRect.width.toFixed(1)} x ${parentRect.height.toFixed(1)}`);
        }
        
        // æ‰‹å‹•é¸æŠè§£é™¤ãƒ†ã‚¹ãƒˆ
        function testManualDeselect() {
            if (currentBoundingBox && currentBoundingBox.events) {
                log('ğŸ”„ æ‰‹å‹•é¸æŠè§£é™¤ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ');
                currentBoundingBox.events.deselectBoundingBox();
            } else {
                log('âš ï¸ BBã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¾ãŸã¯Eventsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
            }
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ç›£è¦–
        function monitorDragState() {
            setInterval(() => {
                if (currentBoundingBox && currentBoundingBox.core) {
                    const isDragging = currentBoundingBox.core.dragState.isDragging;
                    const wasUpdated = dragStatusElement.textContent.includes('Dragging') !== isDragging;
                    
                    if (wasUpdated) {
                        updateStatus(
                            currentBoundingBox.core.uiState.visible,
                            isDragging,
                            currentBoundingBox.events.isListeningForOutsideClicks
                        );
                    }
                }
            }, 100);
        }
        
        // ã‚ªãƒªã‚¸ãƒŠãƒ«ã®consoleã‚’ãƒ©ãƒƒãƒ—
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            if (!args.join(' ').includes('ğŸ‘ï¸') || args.join(' ').includes('BB')) {
                log(args.join(' '), 'info');
            }
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            log(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            log(args.join(' '), 'warning');
        };
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
        window.addEventListener('load', () => {
            log('ğŸŒ PureBoundingBox BBå¤–ã‚¯ãƒªãƒƒã‚¯ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            log('');
            log('ğŸ¯ ãƒ†ã‚¹ãƒˆç›®æ¨™:');
            log('  1. BBé¸æŠé–‹å§‹æ™‚ã®åº§æ¨™ã‚¹ãƒ¯ãƒƒãƒ— (%â†’px)');
            log('  2. BBå¤–ã‚¯ãƒªãƒƒã‚¯æ™‚ã®é¸æŠè§£é™¤ (pxâ†’%)');
            log('  3. åº§æ¨™ã‚³ãƒŸãƒƒãƒˆå‡¦ç†ã®æ­£å¸¸å‹•ä½œ');
            log('  4. localStorageé€£æºã®ç¢ºèª');
            log('  5. ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ã®ç¢ºèª');
            log('');
            log('â–¶ï¸ ã€ŒBBé¸æŠé–‹å§‹ã€ãƒœã‚¿ãƒ³ã§ãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            // ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ç›£è¦–é–‹å§‹
            monitorDragState();
        });
        
        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (currentBoundingBox) {
                currentBoundingBox.cleanup();
            }
        });
    </script>
</body>
</html>