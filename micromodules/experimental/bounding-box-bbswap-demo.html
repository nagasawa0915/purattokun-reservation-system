<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PureBoundingBox v4.0 BBã‚¹ãƒ¯ãƒƒãƒ—ãƒ‡ãƒ¢ - åº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡æ›¿æ©Ÿèƒ½</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
            overflow: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        
        .title {
            font-size: 2rem;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.8;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            overflow-y: auto;
        }
        
        .demo-workspace {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .workspace-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
        }
        
        .test-element {
            position: absolute;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: transform 0.2s ease;
            user-select: none;
        }
        
        .test-element:hover {
            transform: scale(1.05);
        }
        
        .test-element.selected {
            box-shadow: 0 0 0 3px #ff6b6b, 0 0 20px rgba(255, 107, 107, 0.5);
            animation: selectedPulse 2s infinite;
        }
        
        @keyframes selectedPulse {
            0%, 100% { box-shadow: 0 0 0 3px #ff6b6b, 0 0 20px rgba(255, 107, 107, 0.5); }
            50% { box-shadow: 0 0 0 6px #ff6b6b, 0 0 30px rgba(255, 107, 107, 0.8); }
        }
        
        .controls {
            margin-bottom: 20px;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-title {
            color: #feca57;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            width: 100%;
            margin-bottom: 8px;
            display: block;
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn.primary {
            background: rgba(255, 107, 107, 0.8);
            border-color: rgba(255, 107, 107, 1);
        }
        
        .btn.primary:hover {
            background: rgba(255, 107, 107, 1);
        }
        
        .btn.success {
            background: rgba(46, 204, 113, 0.8);
            border-color: rgba(46, 204, 113, 1);
        }
        
        .btn.success:hover {
            background: rgba(46, 204, 113, 1);
        }
        
        .btn.warning {
            background: rgba(241, 196, 15, 0.8);
            border-color: rgba(241, 196, 15, 1);
            color: black;
        }
        
        .btn.warning:hover {
            background: rgba(241, 196, 15, 1);
        }
        
        .info-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .info-title {
            color: #feca57;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .info-item .label {
            color: #74b9ff;
            font-weight: bold;
        }
        
        .info-item .value {
            color: white;
            font-family: monospace;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            border-left: 3px solid #ff6b6b;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 5px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .log-time {
            color: #74b9ff;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .log-message {
            color: white;
            flex: 1;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
        }
        
        .status.idle {
            background: rgba(108, 117, 125, 0.8);
            color: white;
        }
        
        .status.editing {
            background: rgba(255, 193, 7, 0.8);
            color: black;
        }
        
        .status.success {
            background: rgba(40, 167, 69, 0.8);
            color: white;
        }
        
        .status.error {
            background: rgba(220, 53, 69, 0.8);
            color: white;
        }
        
        .coordinate-display {
            font-family: 'Courier New', monospace;
            font-size: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-line;
        }
        
        /* BBã‚¹ãƒ¯ãƒƒãƒ—UIå¼·åŒ–ã‚¹ã‚¿ã‚¤ãƒ« */
        .bb-swap-container {
            animation: bbSwapAppear 0.3s ease-out !important;
        }
        
        @keyframes bbSwapAppear {
            from { 
                opacity: 0; 
                transform: scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }
        
        .bb-swap-handle {
            transition: all 0.2s ease !important;
        }
        
        .bb-swap-handle:hover {
            background: #ff4757 !important;
            transform: scale(1.2) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">ğŸ¯ PureBoundingBox v4.0 BBã‚¹ãƒ¯ãƒƒãƒ—ãƒ‡ãƒ¢</h1>
            <p class="subtitle">åº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡æ›¿æ©Ÿèƒ½ - Idle â†” EditingçŠ¶æ…‹é·ç§»ã‚·ã‚¹ãƒ†ãƒ </p>
        </div>
        
        <div class="main-content">
            <!-- å·¦ãƒ‘ãƒãƒ«: æ“ä½œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
            <div class="control-panel">
                <div class="control-group">
                    <div class="control-title">ğŸ® åŸºæœ¬æ“ä½œ</div>
                    <button class="btn primary" onclick="createTestElement()">ãƒ†ã‚¹ãƒˆè¦ç´ ä½œæˆ</button>
                    <button class="btn success" onclick="startBBSwapDemo()">BBã‚¹ãƒ¯ãƒƒãƒ—é–‹å§‹</button>
                    <button class="btn warning" onclick="endBBSwapDemo()">BBã‚¹ãƒ¯ãƒƒãƒ—çµ‚äº†</button>
                    <button class="btn" onclick="clearAllElements()">ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
                </div>
                
                <div class="control-group">
                    <div class="control-title">ğŸ§ª é«˜åº¦ãªãƒ†ã‚¹ãƒˆ</div>
                    <button class="btn" onclick="testMultipleElements()">è¤‡æ•°è¦ç´ ãƒ†ã‚¹ãƒˆ</button>
                    <button class="btn" onclick="testCoordinateTransform()">åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆ</button>
                    <button class="btn" onclick="testStateTransition()">çŠ¶æ…‹é·ç§»ãƒ†ã‚¹ãƒˆ</button>
                    <button class="btn" onclick="testErrorRecovery()">ã‚¨ãƒ©ãƒ¼å›å¾©ãƒ†ã‚¹ãƒˆ</button>
                </div>
                
                <div class="control-group">
                    <div class="control-title">ğŸ“Š ãƒ‡ãƒãƒƒã‚°ãƒ»è¨ºæ–­</div>
                    <button class="btn" onclick="showCoordinateInfo()">åº§æ¨™æƒ…å ±è¡¨ç¤º</button>
                    <button class="btn" onclick="validateAllStates()">çŠ¶æ…‹æ¤œè¨¼</button>
                    <button class="btn" onclick="exportStateSnapshot()">çŠ¶æ…‹ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button class="btn" onclick="runFullTest()">å®Œå…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                </div>
                
                <!-- çŠ¶æ…‹è¡¨ç¤º -->
                <div class="info-panel">
                    <div class="info-title">ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="label">çŠ¶æ…‹:</span>
                            <span class="value status idle" id="current-state">idle</span>
                        </div>
                        <div class="info-item">
                            <span class="label">è¦ç´ æ•°:</span>
                            <span class="value" id="element-count">0</span>
                        </div>
                        <div class="info-item">
                            <span class="label">é¸æŠä¸­:</span>
                            <span class="value" id="selected-element">ãªã—</span>
                        </div>
                        <div class="info-item">
                            <span class="label">ç·¨é›†ä¸­:</span>
                            <span class="value" id="editing-status">âŒ</span>
                        </div>
                    </div>
                    
                    <div class="coordinate-display" id="coordinate-display">
                        åº§æ¨™æƒ…å ±: è¦ç´ ã‚’é¸æŠã—ã¦ãã ã•ã„
                    </div>
                </div>
            </div>
            
            <!-- ä¸­å¤®: ãƒ‡ãƒ¢ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ -->
            <div class="demo-workspace" id="demo-workspace">
                <div class="workspace-grid"></div>
                <!-- ãƒ†ã‚¹ãƒˆè¦ç´ ãŒã“ã“ã«å‹•çš„ç”Ÿæˆã•ã‚Œã¾ã™ -->
            </div>
            
            <!-- å³ãƒ‘ãƒãƒ«: ãƒ­ã‚°ã¨æƒ…å ± -->
            <div class="control-panel">
                <div class="control-group">
                    <div class="control-title">ğŸ“ æ“ä½œãƒ­ã‚°</div>
                    <div class="log" id="log-output">
                        <div class="log-entry">
                            <span class="log-time">[åˆæœŸåŒ–]</span>
                            <span class="log-message">BBã‚¹ãƒ¯ãƒƒãƒ—ãƒ‡ãƒ¢æº–å‚™å®Œäº†</span>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-title">ğŸ’¡ ä½¿ç”¨æ–¹æ³•</div>
                    <div class="info-panel">
                        <div style="font-size: 11px; line-height: 1.5;">
                            <strong>ğŸ“‹ åŸºæœ¬æ“ä½œ:</strong><br>
                            1. ã€Œãƒ†ã‚¹ãƒˆè¦ç´ ä½œæˆã€ã§è¦ç´ è¿½åŠ <br>
                            2. è¦ç´ ã‚¯ãƒªãƒƒã‚¯ â†’ BBã‚¹ãƒ¯ãƒƒãƒ—é–‹å§‹<br>
                            3. ãƒ‰ãƒ©ãƒƒã‚°ãƒ»ãƒªã‚µã‚¤ã‚ºã§ç·¨é›†<br>
                            4. å¤–å´ã‚¯ãƒªãƒƒã‚¯ â†’ ç¢ºå®š<br><br>
                            
                            <strong>ğŸ¯ BBã‚¹ãƒ¯ãƒƒãƒ—æ©Ÿèƒ½:</strong><br>
                            â€¢ <span style="color: #feca57;">Idle â†’ Editing</span>: originalTransformä¿å­˜<br>
                            â€¢ <span style="color: #ff6b6b;">åº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡æ›¿</span>: DOM â†” BBåº§æ¨™ç³»<br>
                            â€¢ <span style="color: #2ecc71;">Editing â†’ Idle</span>: åº§æ¨™é€†å¤‰æ›<br><br>
                            
                            <strong>âŒ¨ï¸ ã‚­ãƒ¼æ“ä½œ:</strong><br>
                            â€¢ Shift: ç­‰æ¯”ã‚¹ã‚±ãƒ¼ãƒ«<br>
                            â€¢ Alt: ä¸­å¿ƒåŸºæº–<br>
                            â€¢ ESC: ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«<br>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-title">ğŸ”§ æŠ€è¡“ä»•æ§˜</div>
                    <div class="info-panel" style="font-size: 10px;">
                        <strong>å®Ÿè£…æ©Ÿèƒ½:</strong><br>
                        âœ… åº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡æ›¿<br>
                        âœ… çŠ¶æ…‹é·ç§»ç®¡ç†<br>
                        âœ… originalTransformä¿å­˜<br>
                        âœ… é«˜ç²¾åº¦åº§æ¨™å¤‰æ›<br>
                        âœ… ã‚¨ãƒ©ãƒ¼å›å¾©æ©Ÿèƒ½<br>
                        âœ… ãƒãƒ«ãƒè¦ç´ å¯¾å¿œ<br>
                        âœ… ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ©Ÿèƒ½<br>
                        âœ… å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PureBoundingBox v4.0 BBSwap èª­ã¿è¾¼ã¿ -->
    <script src="PureBoundingBox_v4_BBSwap.js"></script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ç®¡ç†
        let demoState = {
            elements: [],
            currentBBSwap: null,
            selectedElement: null,
            elementCounter: 0
        };
        
        let logElement = document.getElementById('log-output');
        
        // ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#74b9ff',
                success: '#2ecc71',
                warning: '#f39c12',
                error: '#e74c3c'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-time">[${timestamp}]</span>
                <span class="log-message" style="color: ${colors[type]}">${message}</span>
            `;
            
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[BBSwapDemo] ${message}`);
            updateStatusDisplay();
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°
        function updateStatusDisplay() {
            const stateEl = document.getElementById('current-state');
            const countEl = document.getElementById('element-count');
            const selectedEl = document.getElementById('selected-element');
            const editingEl = document.getElementById('editing-status');
            const coordEl = document.getElementById('coordinate-display');
            
            // çŠ¶æ…‹è¡¨ç¤º
            const currentState = demoState.currentBBSwap ? 
                demoState.currentBBSwap.getState().currentState : 'idle';
            
            stateEl.textContent = currentState;
            stateEl.className = `value status ${currentState}`;
            
            // è¦ç´ æ•°
            countEl.textContent = demoState.elements.length;
            
            // é¸æŠä¸­è¦ç´ 
            selectedEl.textContent = demoState.selectedElement ? 
                demoState.selectedElement.textContent : 'ãªã—';
            
            // ç·¨é›†çŠ¶æ…‹
            const isEditing = demoState.currentBBSwap && 
                demoState.currentBBSwap.getState().isEditing;
            editingEl.textContent = isEditing ? 'âœ…' : 'âŒ';
            
            // åº§æ¨™è¡¨ç¤º
            if (demoState.selectedElement && demoState.currentBBSwap) {
                const state = demoState.currentBBSwap.getState();
                coordEl.textContent = `ç¾åœ¨åº§æ¨™: (${Math.round(state.transform.x)}, ${Math.round(state.transform.y)})
ã‚¹ã‚±ãƒ¼ãƒ«: (${state.transform.scaleX.toFixed(2)}, ${state.transform.scaleY.toFixed(2)})
å›è»¢: ${state.transform.rotation.toFixed(1)}Â°
originalTransform: ${state.originalTransform ? 'ä¿å­˜æ¸ˆã¿' : 'æœªä¿å­˜'}`;
            } else {
                coordEl.textContent = 'åº§æ¨™æƒ…å ±: è¦ç´ ã‚’é¸æŠã—ã¦ãã ã•ã„';
            }
        }
        
        // ãƒ†ã‚¹ãƒˆè¦ç´ ä½œæˆ
        function createTestElement() {
            const workspace = document.getElementById('demo-workspace');
            const element = document.createElement('div');
            
            demoState.elementCounter++;
            const elementId = `test-element-${demoState.elementCounter}`;
            
            element.className = 'test-element';
            element.id = elementId;
            element.textContent = `è¦ç´ ${demoState.elementCounter}`;
            element.style.cssText = `
                left: ${100 + Math.random() * 300}px;
                top: ${100 + Math.random() * 200}px;
                width: ${80 + Math.random() * 80}px;
                height: ${60 + Math.random() * 60}px;
            `;
            
            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ: BBã‚¹ãƒ¯ãƒƒãƒ—é–‹å§‹
            element.addEventListener('click', async (e) => {
                e.stopPropagation();
                await selectElement(element);
            });
            
            workspace.appendChild(element);
            demoState.elements.push(element);
            
            log(`ãƒ†ã‚¹ãƒˆè¦ç´ ä½œæˆ: ${elementId}`, 'success');
        }
        
        // è¦ç´ é¸æŠãƒ»BBã‚¹ãƒ¯ãƒƒãƒ—é–‹å§‹
        async function selectElement(element) {
            try {
                // æ—¢å­˜ã®é¸æŠã‚’ã‚¯ãƒªã‚¢
                if (demoState.currentBBSwap) {
                    await demoState.currentBBSwap.onDeselectOrClickOutside();
                }
                
                // æ—¢å­˜ã®é¸æŠè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
                demoState.elements.forEach(el => el.classList.remove('selected'));
                
                // æ–°ã—ã„é¸æŠ
                element.classList.add('selected');
                demoState.selectedElement = element;
                
                // BBã‚¹ãƒ¯ãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                demoState.currentBBSwap = new PureBoundingBox({
                    targetElement: element,
                    nodeId: element.id,
                    enableBBSwap: true,
                    originalSpace: {origin: 'top-left', unit: 'px'},
                    bbSpace: {origin: 'center', unit: 'px'}
                });
                
                // BBã‚¹ãƒ¯ãƒƒãƒ—é–‹å§‹
                const result = await demoState.currentBBSwap.onSelect(element.id);
                
                log(`BBã‚¹ãƒ¯ãƒƒãƒ—é–‹å§‹: ${element.id} - ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'}`, 
                    result.success ? 'success' : 'error');
                
                if (result.originalTransform) {
                    log(`originalTransform: (${Math.round(result.originalTransform.x)}, ${Math.round(result.originalTransform.y)})`, 'info');
                }
                
            } catch (error) {
                log(`BBã‚¹ãƒ¯ãƒƒãƒ—é–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // BBã‚¹ãƒ¯ãƒƒãƒ—ãƒ‡ãƒ¢é–‹å§‹
        async function startBBSwapDemo() {
            if (demoState.elements.length === 0) {
                log('ãƒ†ã‚¹ãƒˆè¦ç´ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšè¦ç´ ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚', 'warning');
                return;
            }
            
            // æœ€åˆã®è¦ç´ ã‚’é¸æŠ
            const firstElement = demoState.elements[0];
            await selectElement(firstElement);
            
            log('BBã‚¹ãƒ¯ãƒƒãƒ—ãƒ‡ãƒ¢é–‹å§‹ - è¦ç´ ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç·¨é›†ã—ã¦ãã ã•ã„', 'success');
        }
        
        // BBã‚¹ãƒ¯ãƒƒãƒ—çµ‚äº†
        async function endBBSwapDemo() {
            if (demoState.currentBBSwap) {
                await demoState.currentBBSwap.onDeselectOrClickOutside();
                demoState.currentBBSwap = null;
            }
            
            if (demoState.selectedElement) {
                demoState.selectedElement.classList.remove('selected');
                demoState.selectedElement = null;
            }
            
            log('BBã‚¹ãƒ¯ãƒƒãƒ—ãƒ‡ãƒ¢çµ‚äº†', 'warning');
        }
        
        // ã™ã¹ã¦ã‚¯ãƒªã‚¢
        function clearAllElements() {
            // BBã‚¹ãƒ¯ãƒƒãƒ—ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            if (demoState.currentBBSwap) {
                demoState.currentBBSwap.cleanup();
                demoState.currentBBSwap = null;
            }
            
            // è¦ç´ å‰Šé™¤
            demoState.elements.forEach(element => element.remove());
            demoState.elements = [];
            demoState.selectedElement = null;
            demoState.elementCounter = 0;
            
            log('ã™ã¹ã¦ã‚¯ãƒªã‚¢å®Œäº†', 'warning');
        }
        
        // è¤‡æ•°è¦ç´ ãƒ†ã‚¹ãƒˆ
        async function testMultipleElements() {
            log('è¤‡æ•°è¦ç´ ãƒ†ã‚¹ãƒˆé–‹å§‹...', 'info');
            
            // 3ã¤ã®è¦ç´ ã‚’ä½œæˆ
            for (let i = 0; i < 3; i++) {
                createTestElement();
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            log('è¤‡æ•°è¦ç´ ä½œæˆå®Œäº†ã€‚å„è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠåˆ‡ã‚Šæ›¿ãˆã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚', 'success');
        }
        
        // åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆ
        async function testCoordinateTransform() {
            if (!demoState.currentBBSwap || !demoState.selectedElement) {
                log('åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆã«ã¯BBã‚¹ãƒ¯ãƒƒãƒ—ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™', 'warning');
                return;
            }
            
            log('åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆé–‹å§‹...', 'info');
            
            const state = demoState.currentBBSwap.getState();
            log(`å¤‰æ›å‰: (${Math.round(state.transform.x)}, ${Math.round(state.transform.y)})`, 'info');
            
            // åº§æ¨™ã‚’å¤‰æ›´ã—ã¦ã¿ã‚‹
            await demoState.currentBBSwap.onManipulate({x: 50, y: 30});
            
            const newState = demoState.currentBBSwap.getState();
            log(`å¤‰æ›å¾Œ: (${Math.round(newState.transform.x)}, ${Math.round(newState.transform.y)})`, 'success');
        }
        
        // çŠ¶æ…‹é·ç§»ãƒ†ã‚¹ãƒˆ
        async function testStateTransition() {
            log('çŠ¶æ…‹é·ç§»ãƒ†ã‚¹ãƒˆé–‹å§‹...', 'info');
            
            if (demoState.elements.length === 0) {
                createTestElement();
            }
            
            const element = demoState.elements[0];
            
            // Idle â†’ Editing
            await selectElement(element);
            log('çŠ¶æ…‹é·ç§»: Idle â†’ Editing âœ…', 'success');
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Editing â†’ Idle
            await endBBSwapDemo();
            log('çŠ¶æ…‹é·ç§»: Editing â†’ Idle âœ…', 'success');
            
            log('çŠ¶æ…‹é·ç§»ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
        }
        
        // ã‚¨ãƒ©ãƒ¼å›å¾©ãƒ†ã‚¹ãƒˆ
        async function testErrorRecovery() {
            log('ã‚¨ãƒ©ãƒ¼å›å¾©ãƒ†ã‚¹ãƒˆé–‹å§‹...', 'info');
            
            try {
                // ç„¡åŠ¹ãªè¦ç´ ã§BBã‚¹ãƒ¯ãƒƒãƒ—ã‚’è©¦è¡Œ
                const invalidElement = document.createElement('div');
                const bbSwap = new PureBoundingBox({
                    targetElement: invalidElement,
                    nodeId: 'invalid-test'
                });
                
                // è¦ªã«è¿½åŠ ã›ãšã«é¸æŠã‚’è©¦è¡Œï¼ˆã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹ï¼‰
                await bbSwap.onSelect('invalid-test');
                
            } catch (error) {
                log(`æœŸå¾…ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ: ${error.message}`, 'success');
            }
            
            // ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸çŠ¶æ…‹ã«å¾©å¸°ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
            if (demoState.currentBBSwap) {
                const state = demoState.currentBBSwap.getState();
                log(`ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: ${state.currentState} - æ­£å¸¸å¾©å¸°ç¢ºèª`, 'success');
            }
            
            log('ã‚¨ãƒ©ãƒ¼å›å¾©ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
        }
        
        // åº§æ¨™æƒ…å ±è¡¨ç¤º
        function showCoordinateInfo() {
            if (!demoState.selectedElement) {
                log('åº§æ¨™æƒ…å ±è¡¨ç¤º: è¦ç´ ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
                return;
            }
            
            const element = demoState.selectedElement;
            const rect = element.getBoundingClientRect();
            const style = window.getComputedStyle(element);
            
            log(`=== ${element.id} åº§æ¨™æƒ…å ± ===`, 'info');
            log(`CSSä½ç½®: left=${style.left}, top=${style.top}`, 'info');
            log(`Rect: (${Math.round(rect.left)}, ${Math.round(rect.top)}) ${Math.round(rect.width)}x${Math.round(rect.height)}`, 'info');
            log(`Transform: ${style.transform}`, 'info');
            
            if (demoState.currentBBSwap) {
                const state = demoState.currentBBSwap.getState();
                log(`BBçŠ¶æ…‹: ${state.currentState}, ç·¨é›†ä¸­: ${state.isEditing}`, 'info');
                if (state.originalTransform) {
                    log(`Original: (${Math.round(state.originalTransform.x)}, ${Math.round(state.originalTransform.y)})`, 'info');
                }
            }
        }
        
        // çŠ¶æ…‹æ¤œè¨¼
        function validateAllStates() {
            log('=== ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹æ¤œè¨¼ ===', 'info');
            log(`è¦ç´ æ•°: ${demoState.elements.length}`, 'info');
            log(`é¸æŠä¸­è¦ç´ : ${demoState.selectedElement ? demoState.selectedElement.id : 'ãªã—'}`, 'info');
            log(`BBã‚¹ãƒ¯ãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: ${demoState.currentBBSwap ? 'å­˜åœ¨' : 'ãªã—'}`, 'info');
            
            if (demoState.currentBBSwap) {
                const state = demoState.currentBBSwap.getState();
                log(`BBã‚¹ãƒ¯ãƒƒãƒ—çŠ¶æ…‹: ${state.currentState}`, 'info');
                log(`ç·¨é›†ä¸­: ${state.isEditing}`, 'info');
                log(`originalTransform: ${state.originalTransform ? 'ä¿å­˜æ¸ˆã¿' : 'æœªä¿å­˜'}`, 'info');
            }
            
            log('çŠ¶æ…‹æ¤œè¨¼å®Œäº†', 'success');
        }
        
        // çŠ¶æ…‹ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportStateSnapshot() {
            const snapshot = {
                timestamp: new Date().toISOString(),
                elementCount: demoState.elements.length,
                selectedElement: demoState.selectedElement?.id || null,
                hasBBSwap: !!demoState.currentBBSwap
            };
            
            if (demoState.currentBBSwap) {
                snapshot.bbSwapState = demoState.currentBBSwap.getState();
            }
            
            console.log('BBã‚¹ãƒ¯ãƒƒãƒ—ãƒ‡ãƒ¢çŠ¶æ…‹ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ:', snapshot);
            log(`çŠ¶æ…‹ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå‡ºåŠ›å®Œäº† (ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèª)`, 'success');
        }
        
        // å®Œå…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runFullTest() {
            log('ğŸ§ª å®Œå…¨ãƒ†ã‚¹ãƒˆé–‹å§‹...', 'info');
            
            // 1. è¦ç´ ä½œæˆ
            createTestElement();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 2. BBã‚¹ãƒ¯ãƒƒãƒ—é–‹å§‹
            await startBBSwapDemo();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 3. åº§æ¨™å¤‰æ›
            await testCoordinateTransform();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 4. çŠ¶æ…‹æ¤œè¨¼
            validateAllStates();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 5. çµ‚äº†
            await endBBSwapDemo();
            
            log('ğŸ‰ å®Œå…¨ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
        }
        
        // ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚¯ãƒªãƒƒã‚¯ï¼ˆBBã‚¹ãƒ¯ãƒƒãƒ—çµ‚äº†ï¼‰
        document.getElementById('demo-workspace').addEventListener('click', async (e) => {
            if (e.target.id === 'demo-workspace' || e.target.classList.contains('workspace-grid')) {
                await endBBSwapDemo();
            }
        });
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', async (e) => {
            if (e.key === 'Escape' && demoState.currentBBSwap) {
                await endBBSwapDemo();
                log('ESCã‚­ãƒ¼ã§BBã‚¹ãƒ¯ãƒƒãƒ—çµ‚äº†', 'warning');
            }
        });
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('load', () => {
            log('ğŸš€ BBã‚¹ãƒ¯ãƒƒãƒ—ãƒ‡ãƒ¢åˆæœŸåŒ–å®Œäº†', 'success');
            log('ğŸ“‹ ã€Œãƒ†ã‚¹ãƒˆè¦ç´ ä½œæˆã€â†’è¦ç´ ã‚¯ãƒªãƒƒã‚¯â†’ç·¨é›†â†’å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§ç¢ºå®š', 'info');
            updateStatusDisplay();
            
            // å®šæœŸçš„ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            setInterval(updateStatusDisplay, 1000);
        });
        
        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            clearAllElements();
        });
    </script>
</body>
</html>