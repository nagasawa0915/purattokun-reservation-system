<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PureBoundingBox v4.0 BB„Çπ„ÉØ„ÉÉ„Éó„Éá„É¢ - Â∫ßÊ®ô„É¨„Ç§„É§„ÉºÂàáÊõøÊ©üËÉΩ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
            overflow: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        
        .title {
            font-size: 2rem;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.8;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            overflow-y: auto;
        }
        
        .demo-workspace {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .workspace-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
        }
        
        .test-element {
            position: absolute;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: transform 0.2s ease;
            user-select: none;
        }
        
        .test-element:hover {
            transform: scale(1.05);
        }
        
        .test-element.selected {
            box-shadow: 0 0 0 3px #ff6b6b, 0 0 20px rgba(255, 107, 107, 0.5);
            animation: selectedPulse 2s infinite;
        }
        
        @keyframes selectedPulse {
            0%, 100% { box-shadow: 0 0 0 3px #ff6b6b, 0 0 20px rgba(255, 107, 107, 0.5); }
            50% { box-shadow: 0 0 0 6px #ff6b6b, 0 0 30px rgba(255, 107, 107, 0.8); }
        }
        
        .controls {
            margin-bottom: 20px;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-title {
            color: #feca57;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            width: 100%;
            margin-bottom: 8px;
            display: block;
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn.primary {
            background: rgba(255, 107, 107, 0.8);
            border-color: rgba(255, 107, 107, 1);
        }
        
        .btn.primary:hover {
            background: rgba(255, 107, 107, 1);
        }
        
        .btn.success {
            background: rgba(46, 204, 113, 0.8);
            border-color: rgba(46, 204, 113, 1);
        }
        
        .btn.success:hover {
            background: rgba(46, 204, 113, 1);
        }
        
        .btn.warning {
            background: rgba(241, 196, 15, 0.8);
            border-color: rgba(241, 196, 15, 1);
            color: black;
        }
        
        .btn.warning:hover {
            background: rgba(241, 196, 15, 1);
        }
        
        .info-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .info-title {
            color: #feca57;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .info-item .label {
            color: #74b9ff;
            font-weight: bold;
        }
        
        .info-item .value {
            color: white;
            font-family: monospace;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            border-left: 3px solid #ff6b6b;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 5px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .log-time {
            color: #74b9ff;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .log-message {
            color: white;
            flex: 1;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
        }
        
        .status.idle {
            background: rgba(108, 117, 125, 0.8);
            color: white;
        }
        
        .status.editing {
            background: rgba(255, 193, 7, 0.8);
            color: black;
        }
        
        .status.success {
            background: rgba(40, 167, 69, 0.8);
            color: white;
        }
        
        .status.error {
            background: rgba(220, 53, 69, 0.8);
            color: white;
        }
        
        .coordinate-display {
            font-family: 'Courier New', monospace;
            font-size: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-line;
        }
        
        /* BB„Çπ„ÉØ„ÉÉ„ÉóUIÂº∑Âåñ„Çπ„Çø„Ç§„É´ */
        .bb-swap-container {
            animation: bbSwapAppear 0.3s ease-out !important;
        }
        
        @keyframes bbSwapAppear {
            from { 
                opacity: 0; 
                transform: scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }
        
        .bb-swap-handle {
            transition: all 0.2s ease !important;
        }
        
        .bb-swap-handle:hover {
            background: #ff4757 !important;
            transform: scale(1.2) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üéØ PureBoundingBox v4.0 BB„Çπ„ÉØ„ÉÉ„Éó„Éá„É¢</h1>
            <p class="subtitle">Â∫ßÊ®ô„É¨„Ç§„É§„ÉºÂàáÊõøÊ©üËÉΩ - Idle ‚Üî EditingÁä∂ÊÖãÈÅ∑Áßª„Ç∑„Çπ„ÉÜ„É†</p>
        </div>
        
        <div class="main-content">
            <!-- Â∑¶„Éë„Éç„É´: Êìç‰Ωú„Ç≥„É≥„Éà„É≠„Éº„É´ -->
            <div class="control-panel">
                <div class="control-group">
                    <div class="control-title">üéÆ Âü∫Êú¨Êìç‰Ωú</div>
                    <button class="btn primary" onclick="createTestElement()">„ÉÜ„Çπ„ÉàË¶ÅÁ¥†‰ΩúÊàê</button>
                    <button class="btn success" onclick="startBBSwapDemo()">BB„Çπ„ÉØ„ÉÉ„ÉóÈñãÂßã</button>
                    <button class="btn warning" onclick="endBBSwapDemo()">BB„Çπ„ÉØ„ÉÉ„ÉóÁµÇ‰∫Ü</button>
                    <button class="btn" onclick="clearAllElements()">„Åô„Åπ„Å¶„ÇØ„É™„Ç¢</button>
                </div>
                
                <div class="control-group">
                    <div class="control-title">üß™ È´òÂ∫¶„Å™„ÉÜ„Çπ„Éà</div>
                    <button class="btn" onclick="testMultipleElements()">Ë§áÊï∞Ë¶ÅÁ¥†„ÉÜ„Çπ„Éà</button>
                    <button class="btn" onclick="testCoordinateTransform()">Â∫ßÊ®ôÂ§âÊèõ„ÉÜ„Çπ„Éà</button>
                    <button class="btn" onclick="testStateTransition()">Áä∂ÊÖãÈÅ∑Áßª„ÉÜ„Çπ„Éà</button>
                    <button class="btn" onclick="testErrorRecovery()">„Ç®„É©„ÉºÂõûÂæ©„ÉÜ„Çπ„Éà</button>
                </div>
                
                <div class="control-group">
                    <div class="control-title">üìä „Éá„Éê„ÉÉ„Ç∞„ÉªË®∫Êñ≠</div>
                    <button class="btn" onclick="showCoordinateInfo()">Â∫ßÊ®ôÊÉÖÂ†±Ë°®Á§∫</button>
                    <button class="btn" onclick="validateAllStates()">Áä∂ÊÖãÊ§úË®º</button>
                    <button class="btn" onclick="exportStateSnapshot()">Áä∂ÊÖã„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                    <button class="btn" onclick="runFullTest()">ÂÆåÂÖ®„ÉÜ„Çπ„ÉàÂÆüË°å</button>
                </div>
                
                <!-- Áä∂ÊÖãË°®Á§∫ -->
                <div class="info-panel">
                    <div class="info-title">üìä ÁèæÂú®„ÅÆÁä∂ÊÖã</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="label">Áä∂ÊÖã:</span>
                            <span class="value status idle" id="current-state">idle</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Ë¶ÅÁ¥†Êï∞:</span>
                            <span class="value" id="element-count">0</span>
                        </div>
                        <div class="info-item">
                            <span class="label">ÈÅ∏Êäû‰∏≠:</span>
                            <span class="value" id="selected-element">„Å™„Åó</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Á∑®ÈõÜ‰∏≠:</span>
                            <span class="value" id="editing-status">‚ùå</span>
                        </div>
                    </div>
                    
                    <div class="coordinate-display" id="coordinate-display">
                        Â∫ßÊ®ôÊÉÖÂ†±: Ë¶ÅÁ¥†„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                    </div>
                </div>
            </div>
            
            <!-- ‰∏≠Â§Æ: „Éá„É¢„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ -->
            <div class="demo-workspace" id="demo-workspace">
                <div class="workspace-grid"></div>
                <!-- „ÉÜ„Çπ„ÉàË¶ÅÁ¥†„Åå„Åì„Åì„Å´ÂãïÁöÑÁîüÊàê„Åï„Çå„Åæ„Åô -->
            </div>
            
            <!-- Âè≥„Éë„Éç„É´: „É≠„Ç∞„Å®ÊÉÖÂ†± -->
            <div class="control-panel">
                <div class="control-group">
                    <div class="control-title">üìù Êìç‰Ωú„É≠„Ç∞</div>
                    <div class="log" id="log-output">
                        <div class="log-entry">
                            <span class="log-time">[ÂàùÊúüÂåñ]</span>
                            <span class="log-message">BB„Çπ„ÉØ„ÉÉ„Éó„Éá„É¢Ê∫ñÂÇôÂÆå‰∫Ü</span>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-title">üí° ‰ΩøÁî®ÊñπÊ≥ï</div>
                    <div class="info-panel">
                        <div style="font-size: 11px; line-height: 1.5;">
                            <strong>üìã Âü∫Êú¨Êìç‰Ωú:</strong><br>
                            1. „Äå„ÉÜ„Çπ„ÉàË¶ÅÁ¥†‰ΩúÊàê„Äç„ÅßË¶ÅÁ¥†ËøΩÂä†<br>
                            2. Ë¶ÅÁ¥†„ÇØ„É™„ÉÉ„ÇØ ‚Üí BB„Çπ„ÉØ„ÉÉ„ÉóÈñãÂßã<br>
                            3. „Éâ„É©„ÉÉ„Ç∞„Éª„É™„Çµ„Ç§„Ç∫„ÅßÁ∑®ÈõÜ<br>
                            4. Â§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ ‚Üí Á¢∫ÂÆö<br><br>
                            
                            <strong>üéØ BB„Çπ„ÉØ„ÉÉ„ÉóÊ©üËÉΩ:</strong><br>
                            ‚Ä¢ <span style="color: #feca57;">Idle ‚Üí Editing</span>: originalTransform‰øùÂ≠ò<br>
                            ‚Ä¢ <span style="color: #ff6b6b;">Â∫ßÊ®ô„É¨„Ç§„É§„ÉºÂàáÊõø</span>: DOM ‚Üî BBÂ∫ßÊ®ôÁ≥ª<br>
                            ‚Ä¢ <span style="color: #2ecc71;">Editing ‚Üí Idle</span>: Â∫ßÊ®ôÈÄÜÂ§âÊèõ<br><br>
                            
                            <strong>‚å®Ô∏è „Ç≠„ÉºÊìç‰Ωú:</strong><br>
                            ‚Ä¢ Shift: Á≠âÊØî„Çπ„Ç±„Éº„É´<br>
                            ‚Ä¢ Alt: ‰∏≠ÂøÉÂü∫Ê∫ñ<br>
                            ‚Ä¢ ESC: Á∑®ÈõÜ„Ç≠„É£„É≥„Çª„É´<br>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-title">üîß ÊäÄË°ì‰ªïÊßò</div>
                    <div class="info-panel" style="font-size: 10px;">
                        <strong>ÂÆüË£ÖÊ©üËÉΩ:</strong><br>
                        ‚úÖ Â∫ßÊ®ô„É¨„Ç§„É§„ÉºÂàáÊõø<br>
                        ‚úÖ Áä∂ÊÖãÈÅ∑ÁßªÁÆ°ÁêÜ<br>
                        ‚úÖ originalTransform‰øùÂ≠ò<br>
                        ‚úÖ È´òÁ≤æÂ∫¶Â∫ßÊ®ôÂ§âÊèõ<br>
                        ‚úÖ „Ç®„É©„ÉºÂõûÂæ©Ê©üËÉΩ<br>
                        ‚úÖ „Éû„É´„ÉÅË¶ÅÁ¥†ÂØæÂøú<br>
                        ‚úÖ „Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„ÉàÊ©üËÉΩ<br>
                        ‚úÖ ÂÆåÂÖ®„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PureBoundingBox v4.0 BBSwap Ë™≠„ÅøËæº„Åø -->
    <script src="PureBoundingBox_v4_BBSwap.js"></script>
    
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Áä∂ÊÖãÁÆ°ÁêÜ
        let demoState = {
            elements: [],
            currentBBSwap: null,
            selectedElement: null,
            elementCounter: 0
        };
        
        let logElement = document.getElementById('log-output');
        
        // „É≠„Ç∞Âá∫ÂäõÈñ¢Êï∞
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#74b9ff',
                success: '#2ecc71',
                warning: '#f39c12',
                error: '#e74c3c'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-time">[${timestamp}]</span>
                <span class="log-message" style="color: ${colors[type]}">${message}</span>
            `;
            
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[BBSwapDemo] ${message}`);
            updateStatusDisplay();
        }
        
        // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫Êõ¥Êñ∞
        function updateStatusDisplay() {
            const stateEl = document.getElementById('current-state');
            const countEl = document.getElementById('element-count');
            const selectedEl = document.getElementById('selected-element');
            const editingEl = document.getElementById('editing-status');
            const coordEl = document.getElementById('coordinate-display');
            
            // Áä∂ÊÖãË°®Á§∫
            const currentState = demoState.currentBBSwap ? 
                demoState.currentBBSwap.getState().currentState : 'idle';
            
            stateEl.textContent = currentState;
            stateEl.className = `value status ${currentState}`;
            
            // Ë¶ÅÁ¥†Êï∞
            countEl.textContent = demoState.elements.length;
            
            // ÈÅ∏Êäû‰∏≠Ë¶ÅÁ¥†
            selectedEl.textContent = demoState.selectedElement ? 
                demoState.selectedElement.textContent : '„Å™„Åó';
            
            // Á∑®ÈõÜÁä∂ÊÖã
            const isEditing = demoState.currentBBSwap && 
                demoState.currentBBSwap.getState().isEditing;
            editingEl.textContent = isEditing ? '‚úÖ' : '‚ùå';
            
            // Â∫ßÊ®ôË°®Á§∫
            if (demoState.selectedElement && demoState.currentBBSwap) {
                const state = demoState.currentBBSwap.getState();
                coordEl.textContent = `ÁèæÂú®Â∫ßÊ®ô: (${Math.round(state.transform.x)}, ${Math.round(state.transform.y)})
„Çπ„Ç±„Éº„É´: (${state.transform.scaleX.toFixed(2)}, ${state.transform.scaleY.toFixed(2)})
ÂõûËª¢: ${state.transform.rotation.toFixed(1)}¬∞
originalTransform: ${state.originalTransform ? '‰øùÂ≠òÊ∏à„Åø' : 'Êú™‰øùÂ≠ò'}`;
            } else {
                coordEl.textContent = 'Â∫ßÊ®ôÊÉÖÂ†±: Ë¶ÅÁ¥†„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            }
        }
        
        // „ÉÜ„Çπ„ÉàË¶ÅÁ¥†‰ΩúÊàê
        function createTestElement() {
            const workspace = document.getElementById('demo-workspace');
            const element = document.createElement('div');
            
            demoState.elementCounter++;
            const elementId = `test-element-${demoState.elementCounter}`;
            
            element.className = 'test-element';
            element.id = elementId;
            element.textContent = `Ë¶ÅÁ¥†${demoState.elementCounter}`;
            element.style.cssText = `
                left: ${100 + Math.random() * 300}px;
                top: ${100 + Math.random() * 200}px;
                width: ${80 + Math.random() * 80}px;
                height: ${60 + Math.random() * 60}px;
            `;
            
            // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà: BB„Çπ„ÉØ„ÉÉ„ÉóÈñãÂßã
            element.addEventListener('click', async (e) => {
                e.stopPropagation();
                await selectElement(element);
            });
            
            workspace.appendChild(element);
            demoState.elements.push(element);
            
            log(`„ÉÜ„Çπ„ÉàË¶ÅÁ¥†‰ΩúÊàê: ${elementId}`, 'success');
        }
        
        // Ë¶ÅÁ¥†ÈÅ∏Êäû„ÉªBB„Çπ„ÉØ„ÉÉ„ÉóÈñãÂßã
        async function selectElement(element) {
            try {
                // Êó¢Â≠ò„ÅÆÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
                if (demoState.currentBBSwap) {
                    await demoState.currentBBSwap.onDeselectOrClickOutside();
                }
                
                // Êó¢Â≠ò„ÅÆÈÅ∏ÊäûË°®Á§∫„Çí„ÇØ„É™„Ç¢
                demoState.elements.forEach(el => el.classList.remove('selected'));
                
                // Êñ∞„Åó„ÅÑÈÅ∏Êäû
                element.classList.add('selected');
                demoState.selectedElement = element;
                
                // BB„Çπ„ÉØ„ÉÉ„Éó„Ç§„É≥„Çπ„Çø„É≥„Çπ‰ΩúÊàê
                demoState.currentBBSwap = new PureBoundingBox({
                    targetElement: element,
                    nodeId: element.id,
                    enableBBSwap: true,
                    originalSpace: {origin: 'top-left', unit: 'px'},
                    bbSpace: {origin: 'center', unit: 'px'}
                });
                
                // BB„Çπ„ÉØ„ÉÉ„ÉóÈñãÂßã
                const result = await demoState.currentBBSwap.onSelect(element.id);
                
                log(`BB„Çπ„ÉØ„ÉÉ„ÉóÈñãÂßã: ${element.id} - ${result.success ? 'ÊàêÂäü' : 'Â§±Êïó'}`, 
                    result.success ? 'success' : 'error');
                
                if (result.originalTransform) {
                    log(`originalTransform: (${Math.round(result.originalTransform.x)}, ${Math.round(result.originalTransform.y)})`, 'info');
                }
                
            } catch (error) {
                log(`BB„Çπ„ÉØ„ÉÉ„ÉóÈñãÂßã„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }
        
        // BB„Çπ„ÉØ„ÉÉ„Éó„Éá„É¢ÈñãÂßã
        async function startBBSwapDemo() {
            if (demoState.elements.length === 0) {
                log('„ÉÜ„Çπ„ÉàË¶ÅÁ¥†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Åæ„ÅöË¶ÅÁ¥†„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'warning');
                return;
            }
            
            // ÊúÄÂàù„ÅÆË¶ÅÁ¥†„ÇíÈÅ∏Êäû
            const firstElement = demoState.elements[0];
            await selectElement(firstElement);
            
            log('BB„Çπ„ÉØ„ÉÉ„Éó„Éá„É¢ÈñãÂßã - Ë¶ÅÁ¥†„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶Á∑®ÈõÜ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'success');
        }
        
        // BB„Çπ„ÉØ„ÉÉ„ÉóÁµÇ‰∫Ü
        async function endBBSwapDemo() {
            if (demoState.currentBBSwap) {
                await demoState.currentBBSwap.onDeselectOrClickOutside();
                demoState.currentBBSwap = null;
            }
            
            if (demoState.selectedElement) {
                demoState.selectedElement.classList.remove('selected');
                demoState.selectedElement = null;
            }
            
            log('BB„Çπ„ÉØ„ÉÉ„Éó„Éá„É¢ÁµÇ‰∫Ü', 'warning');
        }
        
        // „Åô„Åπ„Å¶„ÇØ„É™„Ç¢
        function clearAllElements() {
            // BB„Çπ„ÉØ„ÉÉ„Éó„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            if (demoState.currentBBSwap) {
                demoState.currentBBSwap.cleanup();
                demoState.currentBBSwap = null;
            }
            
            // Ë¶ÅÁ¥†ÂâäÈô§
            demoState.elements.forEach(element => element.remove());
            demoState.elements = [];
            demoState.selectedElement = null;
            demoState.elementCounter = 0;
            
            log('„Åô„Åπ„Å¶„ÇØ„É™„Ç¢ÂÆå‰∫Ü', 'warning');
        }
        
        // Ë§áÊï∞Ë¶ÅÁ¥†„ÉÜ„Çπ„Éà
        async function testMultipleElements() {
            log('Ë§áÊï∞Ë¶ÅÁ¥†„ÉÜ„Çπ„ÉàÈñãÂßã...', 'info');
            
            // 3„Å§„ÅÆË¶ÅÁ¥†„Çí‰ΩúÊàê
            for (let i = 0; i < 3; i++) {
                createTestElement();
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            log('Ë§áÊï∞Ë¶ÅÁ¥†‰ΩúÊàêÂÆå‰∫Ü„ÄÇÂêÑË¶ÅÁ¥†„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏ÊäûÂàá„ÇäÊõø„Åà„Çí„ÉÜ„Çπ„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'success');
        }
        
        // Â∫ßÊ®ôÂ§âÊèõ„ÉÜ„Çπ„Éà
        async function testCoordinateTransform() {
            if (!demoState.currentBBSwap || !demoState.selectedElement) {
                log('Â∫ßÊ®ôÂ§âÊèõ„ÉÜ„Çπ„Éà„Å´„ÅØBB„Çπ„ÉØ„ÉÉ„Éó„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô', 'warning');
                return;
            }
            
            log('Â∫ßÊ®ôÂ§âÊèõ„ÉÜ„Çπ„ÉàÈñãÂßã...', 'info');
            
            const state = demoState.currentBBSwap.getState();
            log(`Â§âÊèõÂâç: (${Math.round(state.transform.x)}, ${Math.round(state.transform.y)})`, 'info');
            
            // Â∫ßÊ®ô„ÇíÂ§âÊõ¥„Åó„Å¶„Åø„Çã
            await demoState.currentBBSwap.onManipulate({x: 50, y: 30});
            
            const newState = demoState.currentBBSwap.getState();
            log(`Â§âÊèõÂæå: (${Math.round(newState.transform.x)}, ${Math.round(newState.transform.y)})`, 'success');
        }
        
        // Áä∂ÊÖãÈÅ∑Áßª„ÉÜ„Çπ„Éà
        async function testStateTransition() {
            log('Áä∂ÊÖãÈÅ∑Áßª„ÉÜ„Çπ„ÉàÈñãÂßã...', 'info');
            
            if (demoState.elements.length === 0) {
                createTestElement();
            }
            
            const element = demoState.elements[0];
            
            // Idle ‚Üí Editing
            await selectElement(element);
            log('Áä∂ÊÖãÈÅ∑Áßª: Idle ‚Üí Editing ‚úÖ', 'success');
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Editing ‚Üí Idle
            await endBBSwapDemo();
            log('Áä∂ÊÖãÈÅ∑Áßª: Editing ‚Üí Idle ‚úÖ', 'success');
            
            log('Áä∂ÊÖãÈÅ∑Áßª„ÉÜ„Çπ„ÉàÂÆå‰∫Ü', 'success');
        }
        
        // „Ç®„É©„ÉºÂõûÂæ©„ÉÜ„Çπ„Éà
        async function testErrorRecovery() {
            log('„Ç®„É©„ÉºÂõûÂæ©„ÉÜ„Çπ„ÉàÈñãÂßã...', 'info');
            
            try {
                // ÁÑ°Âäπ„Å™Ë¶ÅÁ¥†„ÅßBB„Çπ„ÉØ„ÉÉ„Éó„ÇíË©¶Ë°å
                const invalidElement = document.createElement('div');
                const bbSwap = new PureBoundingBox({
                    targetElement: invalidElement,
                    nodeId: 'invalid-test'
                });
                
                // Ë¶™„Å´ËøΩÂä†„Åõ„Åö„Å´ÈÅ∏Êäû„ÇíË©¶Ë°åÔºà„Ç®„É©„Éº„ÇíÁô∫Áîü„Åï„Åõ„ÇãÔºâ
                await bbSwap.onSelect('invalid-test');
                
            } catch (error) {
                log(`ÊúüÂæÖ„Åï„Çå„Åü„Ç®„É©„Éº„Çí„Ç≠„É£„ÉÉ„ÉÅ: ${error.message}`, 'success');
            }
            
            // „Ç∑„Çπ„ÉÜ„É†„ÅåÊ≠£Â∏∏Áä∂ÊÖã„Å´Âæ©Â∏∞„Åô„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
            if (demoState.currentBBSwap) {
                const state = demoState.currentBBSwap.getState();
                log(`„Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã: ${state.currentState} - Ê≠£Â∏∏Âæ©Â∏∞Á¢∫Ë™ç`, 'success');
            }
            
            log('„Ç®„É©„ÉºÂõûÂæ©„ÉÜ„Çπ„ÉàÂÆå‰∫Ü', 'success');
        }
        
        // Â∫ßÊ®ôÊÉÖÂ†±Ë°®Á§∫
        function showCoordinateInfo() {
            if (!demoState.selectedElement) {
                log('Â∫ßÊ®ôÊÉÖÂ†±Ë°®Á§∫: Ë¶ÅÁ¥†„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'warning');
                return;
            }
            
            const element = demoState.selectedElement;
            const rect = element.getBoundingClientRect();
            const style = window.getComputedStyle(element);
            
            log(`=== ${element.id} Â∫ßÊ®ôÊÉÖÂ†± ===`, 'info');
            log(`CSS‰ΩçÁΩÆ: left=${style.left}, top=${style.top}`, 'info');
            log(`Rect: (${Math.round(rect.left)}, ${Math.round(rect.top)}) ${Math.round(rect.width)}x${Math.round(rect.height)}`, 'info');
            log(`Transform: ${style.transform}`, 'info');
            
            if (demoState.currentBBSwap) {
                const state = demoState.currentBBSwap.getState();
                log(`BBÁä∂ÊÖã: ${state.currentState}, Á∑®ÈõÜ‰∏≠: ${state.isEditing}`, 'info');
                if (state.originalTransform) {
                    log(`Original: (${Math.round(state.originalTransform.x)}, ${Math.round(state.originalTransform.y)})`, 'info');
                }
            }
        }
        
        // Áä∂ÊÖãÊ§úË®º
        function validateAllStates() {
            log('=== „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãÊ§úË®º ===', 'info');
            log(`Ë¶ÅÁ¥†Êï∞: ${demoState.elements.length}`, 'info');
            log(`ÈÅ∏Êäû‰∏≠Ë¶ÅÁ¥†: ${demoState.selectedElement ? demoState.selectedElement.id : '„Å™„Åó'}`, 'info');
            log(`BB„Çπ„ÉØ„ÉÉ„Éó„Ç§„É≥„Çπ„Çø„É≥„Çπ: ${demoState.currentBBSwap ? 'Â≠òÂú®' : '„Å™„Åó'}`, 'info');
            
            if (demoState.currentBBSwap) {
                const state = demoState.currentBBSwap.getState();
                log(`BB„Çπ„ÉØ„ÉÉ„ÉóÁä∂ÊÖã: ${state.currentState}`, 'info');
                log(`Á∑®ÈõÜ‰∏≠: ${state.isEditing}`, 'info');
                log(`originalTransform: ${state.originalTransform ? '‰øùÂ≠òÊ∏à„Åø' : 'Êú™‰øùÂ≠ò'}`, 'info');
            }
            
            log('Áä∂ÊÖãÊ§úË®ºÂÆå‰∫Ü', 'success');
        }
        
        // Áä∂ÊÖã„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportStateSnapshot() {
            const snapshot = {
                timestamp: new Date().toISOString(),
                elementCount: demoState.elements.length,
                selectedElement: demoState.selectedElement?.id || null,
                hasBBSwap: !!demoState.currentBBSwap
            };
            
            if (demoState.currentBBSwap) {
                snapshot.bbSwapState = demoState.currentBBSwap.getState();
            }
            
            console.log('BB„Çπ„ÉØ„ÉÉ„Éó„Éá„É¢Áä∂ÊÖã„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà:', snapshot);
            log(`Áä∂ÊÖã„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„ÉàÂá∫ÂäõÂÆå‰∫Ü („Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç)`, 'success');
        }
        
        // ÂÆåÂÖ®„ÉÜ„Çπ„ÉàÂÆüË°å
        async function runFullTest() {
            log('üß™ ÂÆåÂÖ®„ÉÜ„Çπ„ÉàÈñãÂßã...', 'info');
            
            // 1. Ë¶ÅÁ¥†‰ΩúÊàê
            createTestElement();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 2. BB„Çπ„ÉØ„ÉÉ„ÉóÈñãÂßã
            await startBBSwapDemo();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 3. Â∫ßÊ®ôÂ§âÊèõ
            await testCoordinateTransform();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 4. Áä∂ÊÖãÊ§úË®º
            validateAllStates();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 5. ÁµÇ‰∫Ü
            await endBBSwapDemo();
            
            log('üéâ ÂÆåÂÖ®„ÉÜ„Çπ„ÉàÂÆå‰∫Ü', 'success');
        }
        
        // „ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„ÇØ„É™„ÉÉ„ÇØÔºàBB„Çπ„ÉØ„ÉÉ„ÉóÁµÇ‰∫ÜÔºâ
        document.getElementById('demo-workspace').addEventListener('click', async (e) => {
            if (e.target.id === 'demo-workspace' || e.target.classList.contains('workspace-grid')) {
                await endBBSwapDemo();
            }
        });
        
        // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
        document.addEventListener('keydown', async (e) => {
            if (e.key === 'Escape' && demoState.currentBBSwap) {
                await endBBSwapDemo();
                log('ESC„Ç≠„Éº„ÅßBB„Çπ„ÉØ„ÉÉ„ÉóÁµÇ‰∫Ü', 'warning');
            }
        });
        
        // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„ÅÆÂàùÊúüÂåñ
        window.addEventListener('load', () => {
            log('üöÄ BB„Çπ„ÉØ„ÉÉ„Éó„Éá„É¢ÂàùÊúüÂåñÂÆå‰∫Ü', 'success');
            log('üìã „Äå„ÉÜ„Çπ„ÉàË¶ÅÁ¥†‰ΩúÊàê„Äç‚ÜíË¶ÅÁ¥†„ÇØ„É™„ÉÉ„ÇØ‚ÜíÁ∑®ÈõÜ‚ÜíÂ§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„ÅßÁ¢∫ÂÆö', 'info');
            updateStatusDisplay();
            
            // ÂÆöÊúüÁöÑ„Å´„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
            setInterval(updateStatusDisplay, 1000);
        });
        
        // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        window.addEventListener('beforeunload', () => {
            clearAllElements();
        });
    </script>
</body>
</html>