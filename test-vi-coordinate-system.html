<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ VIåº§æ¨™ç³» å‹•ä½œæ¤œè¨¼ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', monospace;
            background: linear-gradient(45deg, #2c3e50, #3498db);
            min-height: 100vh;
            color: #ecf0f1;
        }
        
        .test-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(52, 73, 94, 0.9);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .hero-section {
            position: relative;
            width: 90vw;
            max-width: none;
            min-width: 400px;
            height: 60vh;
            min-height: 300px;
            background: linear-gradient(135deg, #e74c3c 0%, #f39c12 50%, #e67e22 100%);
            border-radius: 12px;
            margin: 20px auto;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .test-character {
            position: absolute;
            left: 30%;
            top: 40%;
            width: 15%;
            height: 20%;
            background: radial-gradient(circle, #9b59b6, #8e44ad);
            border: 4px solid #fff;
            border-radius: 50%;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            box-shadow: 0 4px 16px rgba(155, 89, 182, 0.4);
            transition: all 0.3s ease;
        }
        
        .test-character:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.6);
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .control-group {
            background: rgba(44, 62, 80, 0.8);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .control-group h3 {
            margin: 0 0 10px 0;
            color: #3498db;
            font-size: 0.9rem;
        }
        
        button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
            transition: all 0.2s ease;
            margin: 2px;
        }
        
        button:hover {
            background: linear-gradient(45deg, #2980b9, #1f618d);
            transform: translateY(-1px);
        }
        
        button.danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        button.danger:hover {
            background: linear-gradient(45deg, #c0392b, #a93226);
        }
        
        .status-panel {
            background: rgba(44, 62, 80, 0.9);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #27ae60;
        }
        
        .log-container {
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.75rem;
            line-height: 1.4;
        }
        
        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .log-entry.info { color: #3498db; }
        .log-entry.success { color: #27ae60; }
        .log-entry.warning { color: #f39c12; }
        .log-entry.error { color: #e74c3c; }
        .log-entry.vi { color: #9b59b6; font-weight: bold; }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .metric {
            background: rgba(0,0,0,0.3);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 0.75rem;
        }
        
        .metric-label {
            color: #95a5a6;
            font-size: 0.7rem;
        }
        
        .metric-value {
            color: #ecf0f1;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .resize-test {
            background: rgba(52, 152, 219, 0.2);
            border: 2px dashed #3498db;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .resize-test h3 {
            color: #3498db;
            margin: 0 0 10px 0;
        }
        
        .highlight {
            background: rgba(241, 196, 15, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            color: #f1c40f;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¯ VIåº§æ¨™ç³»ï¼ˆViewport-Independentï¼‰å‹•ä½œæ¤œè¨¼</h1>
        <p><strong>ç›®çš„:</strong> PureBoundingBoxAutoPin Phase 2ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ¯”ç‡å¤‰å‹•å•é¡Œã®è§£æ±ºæ¤œè¨¼</p>
        
        <div class="hero-section" id="test-hero">
            <div class="test-character" id="test-character">
                VI Test
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <h3>ğŸ“ VIåº§æ¨™ç³»ãƒ†ã‚¹ãƒˆ</h3>
                <button onclick="testVICalculation()">VIè¨ˆç®—ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="simulateResize()">ãƒªã‚µã‚¤ã‚ºæ¨¡æ“¬</button>
                <button onclick="testAspectRatioChange()">ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”å¤‰æ›´</button>
            </div>
            
            <div class="control-group">
                <h3>ğŸ”„ æ¯”ç‡ä¿æŒãƒ†ã‚¹ãƒˆ</h3>
                <button onclick="savePosition()">ä½ç½®ä¿å­˜</button>
                <button onclick="restorePosition()">ä½ç½®å¾©å…ƒ</button>
                <button onclick="testRatioMaintenance()">æ¯”ç‡ä¿æŒç¢ºèª</button>
            </div>
            
            <div class="control-group">
                <h3>ğŸ¯ AutoPinçµ±åˆ</h3>
                <button onclick="initAutoPin()">AutoPinåˆæœŸåŒ–</button>
                <button onclick="testAutoPinVI()">AutoPin VIé€£æº</button>
                <button onclick="cleanupAutoPin()">AutoPinå‰Šé™¤</button>
            </div>
            
            <div class="control-group">
                <h3>ğŸ§¹ ç®¡ç†</h3>
                <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
                <button onclick="resetTest()">ãƒ†ã‚¹ãƒˆãƒªã‚»ãƒƒãƒˆ</button>
                <button class="danger" onclick="clearStorage()">ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒªã‚¢</button>
            </div>
        </div>
        
        <div class="resize-test">
            <h3>ğŸ“ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºãƒ†ã‚¹ãƒˆ</h3>
            <p>ãƒ–ãƒ©ã‚¦ã‚¶ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ãƒªã‚µã‚¤ã‚ºã—ã¦ã€VIåº§æ¨™ç³»ã®è‡ªå‹•è£œæ­£ã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>
            <div class="metrics-grid">
                <div class="metric">
                    <div class="metric-label">ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚º</div>
                    <div class="metric-value" id="window-size">-</div>
                </div>
                <div class="metric">
                    <div class="metric-label">è¦ªè¦ç´ ã‚µã‚¤ã‚º</div>
                    <div class="metric-value" id="parent-size">-</div>
                </div>
                <div class="metric">
                    <div class="metric-label">ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”</div>
                    <div class="metric-value" id="aspect-ratio">-</div>
                </div>
                <div class="metric">
                    <div class="metric-label">VIè£œæ­£</div>
                    <div class="metric-value" id="vi-compensation">-</div>
                </div>
            </div>
        </div>
        
        <div class="status-panel">
            <h3>ğŸ“Š VIåº§æ¨™ç³»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
            <div id="vi-status">åˆæœŸåŒ–å¾…æ©Ÿä¸­...</div>
        </div>
        
        <div class="log-container" id="log-container">
            <div class="log-entry info">ğŸ¯ VIåº§æ¨™ç³»æ¤œè¨¼ãƒ†ã‚¹ãƒˆèµ·å‹•å®Œäº†</div>
        </div>
    </div>
    
    <!-- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ -->
    <script src="micromodules/bounding-box/PureBoundingBoxCore.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxUI.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxEvents.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxAutoPin.js"></script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let testCharacter = document.getElementById('test-character');
        let heroSection = document.getElementById('test-hero');
        let autoPinInstance = null;
        let baseAspectRatio = null;
        let baseContentRect = null;
        
        // ãƒ­ã‚°å‡ºåŠ›ã‚·ã‚¹ãƒ†ãƒ 
        function log(message, type = 'info') {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°
        function updateMetrics() {
            const windowSize = `${window.innerWidth}Ã—${window.innerHeight}`;
            const parentRect = heroSection.getBoundingClientRect();
            const parentSize = `${parentRect.width.toFixed(0)}Ã—${parentRect.height.toFixed(0)}`;
            const aspectRatio = (parentRect.width / parentRect.height).toFixed(3);
            
            document.getElementById('window-size').textContent = windowSize;
            document.getElementById('parent-size').textContent = parentSize;
            document.getElementById('aspect-ratio').textContent = aspectRatio;
            
            // VIè£œæ­£è¨ˆç®—
            if (baseAspectRatio) {
                const currentAspectRatio = parentRect.width / parentRect.height;
                const aspectRatioChange = currentAspectRatio / baseAspectRatio;
                const compensation = Math.abs(aspectRatioChange - 1.0);
                document.getElementById('vi-compensation').textContent = 
                    `${(compensation * 100).toFixed(2)}%`;
                
                if (compensation > 0.05) {
                    document.getElementById('vi-compensation').style.color = '#e74c3c';
                } else {
                    document.getElementById('vi-compensation').style.color = '#27ae60';
                }
            }
        }
        
        // VIåº§æ¨™ç³»è¨ˆç®—ãƒ†ã‚¹ãƒˆ
        function testVICalculation() {
            log('ğŸ¯ VIåº§æ¨™ç³»è¨ˆç®—ãƒ†ã‚¹ãƒˆé–‹å§‹', 'vi');
            
            const parentRect = heroSection.getBoundingClientRect();
            const currentContentRect = {
                x: 0,
                y: 0,
                width: parentRect.width,
                height: parentRect.height,
                containerRect: parentRect
            };
            
            // åŸºæº–å€¤ãŒãªã„å ´åˆã¯ç¾åœ¨å€¤ã‚’åŸºæº–ã¨ã™ã‚‹
            if (!baseContentRect) {
                baseContentRect = {...currentContentRect};
                baseAspectRatio = parentRect.width / parentRect.height;
                log(`ğŸ“ åŸºæº–ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”è¨­å®š: ${baseAspectRatio.toFixed(3)}`, 'info');
            }
            
            // PureBoundingBoxAutoPinã®VIè¨ˆç®—ã‚’æ¨¡æ“¬
            try {
                // æ¨¡æ“¬çš„ãªVIè¨ˆç®—ï¼ˆå®Ÿéš›ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ï¼‰
                if (autoPinInstance) {
                    const viRatio = autoPinInstance.calculateViewportIndependentRatio(
                        currentContentRect, baseContentRect
                    );
                    
                    log(`âœ… VIè¨ˆç®—å®Œäº†:`, 'success');
                    log(`  - aspectRatioChange: ${viRatio.aspectRatioChange.toFixed(3)}`, 'info');
                    log(`  - isRatioStable: ${viRatio.isRatioStable}`, 'info');
                    log(`  - viScale: ${viRatio.viScaleX.toFixed(3)}Ã—${viRatio.viScaleY.toFixed(3)}`, 'info');
                    
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                    document.getElementById('vi-status').innerHTML = 
                        `ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”å¤‰åŒ–: <span class="highlight">${viRatio.aspectRatioChange.toFixed(3)}</span> | ` +
                        `å®‰å®šæ€§: <span class="highlight">${viRatio.isRatioStable ? 'STABLE' : 'UNSTABLE'}</span>`;
                } else {
                    log('âš ï¸ AutoPinã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
                }
            } catch (error) {
                log(`âŒ VIè¨ˆç®—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ãƒªã‚µã‚¤ã‚ºæ¨¡æ“¬
        function simulateResize() {
            log('ğŸ”„ ãƒªã‚µã‚¤ã‚ºæ¨¡æ“¬é–‹å§‹', 'info');
            
            const heroSection = document.getElementById('test-hero');
            const currentWidth = heroSection.style.width || '90vw';
            
            if (currentWidth === '90vw') {
                heroSection.style.width = '70vw';
                heroSection.style.height = '70vh';
                log('ğŸ“ ã‚µã‚¤ã‚ºå¤‰æ›´: 90vwÃ—60vh â†’ 70vwÃ—70vh', 'info');
            } else {
                heroSection.style.width = '90vw';
                heroSection.style.height = '60vh';
                log('ğŸ“ ã‚µã‚¤ã‚ºå¤‰æ›´: 70vwÃ—70vh â†’ 90vwÃ—60vh', 'info');
            }
            
            setTimeout(() => {
                updateMetrics();
                testVICalculation();
            }, 100);
        }
        
        // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”å¤‰æ›´ãƒ†ã‚¹ãƒˆ
        function testAspectRatioChange() {
            log('ğŸ“ ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”å¤‰æ›´ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            
            const heroSection = document.getElementById('test-hero');
            const currentHeight = heroSection.style.height || '60vh';
            
            if (currentHeight === '60vh') {
                heroSection.style.height = '40vh';
                log('ğŸ“ ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”å¤‰æ›´: 60vh â†’ 40vhï¼ˆæ¨ªé•·åŒ–ï¼‰', 'info');
            } else {
                heroSection.style.height = '60vh';
                log('ğŸ“ ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”å¤‰æ›´: 40vh â†’ 60vhï¼ˆæ¨™æº–åŒ–ï¼‰', 'info');
            }
            
            setTimeout(() => {
                updateMetrics();
                testVICalculation();
            }, 100);
        }
        
        // AutoPinåˆæœŸåŒ–
        function initAutoPin() {
            try {
                log('ğŸ¯ AutoPinåˆæœŸåŒ–é–‹å§‹', 'info');
                
                // æ¨¡æ“¬çš„ãªElementObserver
                const mockObserver = {
                    observe: function(element, callback, options) {
                        log('ğŸ“¡ æ¨¡æ“¬Observerã«ã‚ˆã‚‹BBè¦ç´ ç›£è¦–é–‹å§‹', 'info');
                        
                        // ResizeObserverã«ã‚ˆã‚‹ç›£è¦–
                        const resizeObserver = new ResizeObserver(entries => {
                            for (const entry of entries) {
                                const rect = entry.contentRect;
                                callback(rect, 'resize');
                            }
                        });
                        
                        resizeObserver.observe(element);
                        
                        return function unobserve() {
                            resizeObserver.disconnect();
                            log('ğŸ“¡ æ¨¡æ“¬Observerç›£è¦–åœæ­¢', 'info');
                        };
                    }
                };
                
                // AutoPinã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                const mockCore = {
                    config: { nodeId: 'vi-test-character' }
                };
                
                autoPinInstance = new PureBoundingBoxAutoPin(mockCore, mockObserver);
                
                log('âœ… AutoPinåˆæœŸåŒ–å®Œäº†', 'success');
                
            } catch (error) {
                log(`âŒ AutoPinåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // AutoPin VIé€£æºãƒ†ã‚¹ãƒˆ
        function testAutoPinVI() {
            if (!autoPinInstance) {
                log('âš ï¸ å…ˆã«AutoPinåˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            
            try {
                log('ğŸ”— AutoPin VIé€£æºãƒ†ã‚¹ãƒˆé–‹å§‹', 'vi');
                
                // æ¨¡æ“¬ä¿å­˜ãƒ‡ãƒ¼ã‚¿ï¼ˆè©³ç´°ç‰ˆï¼‰
                const characterRect = testCharacter.getBoundingClientRect();
                const heroRect = heroSection.getBoundingClientRect();
                
                const saveData = {
                    targetElement: heroSection, // èƒŒæ™¯è¦ç´ ã¨ã—ã¦æŒ‡å®š
                    spineElement: testCharacter, // Spineè¦ç´ ã¨ã—ã¦æŒ‡å®š
                    bounds: {
                        left: characterRect.left,
                        top: characterRect.top,
                        width: characterRect.width,
                        height: characterRect.height,
                        x: characterRect.x,
                        y: characterRect.y
                    }
                };
                
                log(`ğŸ“Š AutoPiné©ç”¨ãƒ‡ãƒ¼ã‚¿:`, 'info');
                log(`  - èƒŒæ™¯è¦ç´ : ${heroRect.width.toFixed(0)}Ã—${heroRect.height.toFixed(0)}px`, 'info');
                log(`  - Spineè¦ç´ : ${characterRect.width.toFixed(0)}Ã—${characterRect.height.toFixed(0)}px`, 'info');
                log(`  - ç›¸å¯¾ä½ç½®: ${((characterRect.left - heroRect.left) / heroRect.width * 100).toFixed(1)}%, ${((characterRect.top - heroRect.top) / heroRect.height * 100).toFixed(1)}%`, 'info');
                
                // AutoPiné©ç”¨
                autoPinInstance.applyAutoPinOnSave(saveData).then(result => {
                    if (result.success) {
                        log(`âœ… AutoPiné©ç”¨æˆåŠŸ: ${result.message}`, 'success');
                        log(`âš¡ å‡¦ç†æ™‚é–“: ${result.processingTime.toFixed(2)}ms`, 'info');
                        
                        if (result.pinConfig) {
                            log(`ğŸ¯ ãƒ”ãƒ³è¨­å®šè©³ç´°:`, 'vi');
                            log(`  - ã‚¢ãƒ³ã‚«ãƒ¼: ${result.pinConfig.anchor}`, 'info');
                            log(`  - Phase: ${result.pinConfig.phase}`, 'info');
                            log(`  - ID: ${result.pinConfig.id}`, 'info');
                        }
                    } else {
                        log(`âš ï¸ AutoPiné©ç”¨çµæœ: ${result.error || result.fallback}`, 'warning');
                        if (result.fallbackMode) {
                            log(`ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ: ${result.message}`, 'info');
                        }
                    }
                }).catch(error => {
                    log(`âŒ AutoPin Promise ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                });
                
            } catch (error) {
                log(`âŒ AutoPin VIé€£æºã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('AutoPin VIé€£æºè©³ç´°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // AutoPinã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        function cleanupAutoPin() {
            if (autoPinInstance) {
                autoPinInstance.cleanup();
                autoPinInstance = null;
                log('ğŸ§¹ AutoPinã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†', 'success');
            } else {
                log('âš ï¸ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹AutoPinãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
            }
        }
        
        // ä½ç½®ä¿å­˜ãƒ»å¾©å…ƒï¼ˆVIæ¯”ç‡å¯¾å¿œç‰ˆï¼‰
        function savePosition() {
            const position = {
                left: testCharacter.style.left,
                top: testCharacter.style.top,
                width: testCharacter.style.width,
                height: testCharacter.style.height
            };
            
            const parentRect = heroSection.getBoundingClientRect();
            
            // VIæ¯”ç‡ãƒ‡ãƒ¼ã‚¿ï¼ˆå®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
            const widthPercent = parseFloat(testCharacter.style.width) || 15; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ15%
            const heightPercent = parseFloat(testCharacter.style.height) || 20; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ20%
            
            const viRatio = {
                baseWidthRatio: widthPercent / 100,
                baseHeightRatio: heightPercent / 100,
                baseAspectRatio: parentRect.width / parentRect.height,
                timestamp: Date.now()
            };
            
            log(`ğŸ“Š VIæ¯”ç‡ãƒ‡ãƒ¼ã‚¿ä¿å­˜:`, 'vi');
            log(`  - baseWidthRatio: ${viRatio.baseWidthRatio.toFixed(4)}`, 'info');
            log(`  - baseHeightRatio: ${viRatio.baseHeightRatio.toFixed(4)}`, 'info');
            log(`  - baseAspectRatio: ${viRatio.baseAspectRatio.toFixed(4)}`, 'info');
            
            const saveData = {
                position,
                viRatio,
                windowSize: { width: window.innerWidth, height: window.innerHeight },
                parentSize: { width: parentRect.width, height: parentRect.height }
            };
            
            localStorage.setItem('vi-test-position', JSON.stringify(saveData));
            log('ğŸ’¾ ä½ç½®ä¿å­˜å®Œäº†ï¼ˆVIæ¯”ç‡ãƒ‡ãƒ¼ã‚¿å«ã‚€ï¼‰', 'success');
        }
        
        function restorePosition() {
            const savedData = localStorage.getItem('vi-test-position');
            if (!savedData) {
                log('âš ï¸ ä¿å­˜ã•ã‚ŒãŸä½ç½®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                return;
            }
            
            try {
                const data = JSON.parse(savedData);
                
                if (data.viRatio) {
                    // VIåº§æ¨™ç³»ã§ã®å¾©å…ƒ
                    const parentRect = heroSection.getBoundingClientRect();
                    const currentAspectRatio = parentRect.width / parentRect.height;
                    const aspectRatioChange = currentAspectRatio / data.viRatio.baseAspectRatio;
                    
                    log(`ğŸ”„ VIæ¯”ç‡å¾©å…ƒ: ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”å¤‰åŒ– ${aspectRatioChange.toFixed(3)}`, 'vi');
                    
                    // VIè£œæ­£é©ç”¨ï¼ˆãƒ‡ãƒãƒƒã‚°å¼·åŒ–ç‰ˆï¼‰
                    const aspectRatioThreshold = Math.abs(aspectRatioChange - 1.0);
                    log(`ğŸ” ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”è£œæ­£åˆ¤å®š: threshold=${aspectRatioThreshold.toFixed(4)} (>0.05: ${aspectRatioThreshold > 0.05})`, 'vi');
                    
                    if (aspectRatioThreshold > 0.05) {
                        // å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ä»˜ãVIè£œæ­£è¨ˆç®—
                        const baseWidthRatio = data.viRatio.baseWidthRatio || 0.15; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ15%
                        const baseHeightRatio = data.viRatio.baseHeightRatio || 0.20; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ20%
                        
                        const compensationWidth = (aspectRatioChange - 1.0) * baseWidthRatio;
                        const compensationHeight = (1.0 / aspectRatioChange - 1.0) * baseHeightRatio;
                        
                        log(`ğŸ“Š VIè£œæ­£è¨ˆç®—è©³ç´°:`, 'vi');
                        log(`  - baseWidthRatio: ${data.viRatio.baseWidthRatio ? data.viRatio.baseWidthRatio.toFixed(4) : 'null'}`, 'info');
                        log(`  - baseHeightRatio: ${data.viRatio.baseHeightRatio ? data.viRatio.baseHeightRatio.toFixed(4) : 'null'}`, 'info');
                        log(`  - aspectRatioChange: ${aspectRatioChange.toFixed(4)}`, 'info');
                        log(`  - compensationWidth: ${compensationWidth ? compensationWidth.toFixed(6) : 'null'}`, 'info');
                        log(`  - compensationHeight: ${compensationHeight ? compensationHeight.toFixed(6) : 'null'}`, 'info');
                        
                        const adjustedWidthPct = (baseWidthRatio + compensationWidth) * 100;
                        const adjustedHeightPct = (baseHeightRatio + compensationHeight) * 100;
                        
                        testCharacter.style.width = adjustedWidthPct.toFixed(2) + '%';
                        testCharacter.style.height = adjustedHeightPct.toFixed(2) + '%';
                        
                        log(`âœ¨ VIè£œæ­£é©ç”¨: ã‚µã‚¤ã‚ºè£œæ­£ W:${compensationWidth.toFixed(4)} H:${compensationHeight.toFixed(4)}`, 'vi');
                    } else {
                        testCharacter.style.width = (data.viRatio.baseWidthRatio * 100).toFixed(2) + '%';
                        testCharacter.style.height = (data.viRatio.baseHeightRatio * 100).toFixed(2) + '%';
                    }
                    
                    // ä½ç½®å¾©å…ƒ
                    testCharacter.style.left = data.position.left;
                    testCharacter.style.top = data.position.top;
                    
                    log('âœ… VIåº§æ¨™ç³»ä½ç½®å¾©å…ƒå®Œäº†', 'success');
                } else {
                    // å¾“æ¥ã®å¾©å…ƒ
                    testCharacter.style.left = data.position.left;
                    testCharacter.style.top = data.position.top;
                    testCharacter.style.width = data.position.width;
                    testCharacter.style.height = data.position.height;
                    
                    log('ğŸ“Š å¾“æ¥æ–¹å¼ã§ä½ç½®å¾©å…ƒå®Œäº†', 'info');
                }
                
            } catch (error) {
                log(`âŒ ä½ç½®å¾©å…ƒã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        function testRatioMaintenance() {
            log('ğŸ§ª æ¯”ç‡ä¿æŒãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            
            // ç¾åœ¨ã®ä½ç½®ã‚’ä¿å­˜
            savePosition();
            
            // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºã‚’æ¨¡æ“¬å¤‰æ›´
            setTimeout(() => {
                simulateResize();
                
                setTimeout(() => {
                    // ä½ç½®ã‚’å¾©å…ƒ
                    restorePosition();
                    log('ğŸ¯ æ¯”ç‡ä¿æŒãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                }, 500);
            }, 200);
        }
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function clearLog() {
            document.getElementById('log-container').innerHTML = 
                '<div class="log-entry info">ğŸ“‹ ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†</div>';
        }
        
        function resetTest() {
            testCharacter.style.cssText = 'position: absolute; left: 30%; top: 40%; width: 15%; height: 20%;';
            heroSection.style.cssText = '';
            baseAspectRatio = null;
            baseContentRect = null;
            updateMetrics();
            log('ğŸ”„ ãƒ†ã‚¹ãƒˆç’°å¢ƒãƒªã‚»ãƒƒãƒˆå®Œäº†', 'info');
        }
        
        function clearStorage() {
            localStorage.removeItem('vi-test-position');
            log('ğŸ§¹ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒªã‚¢å®Œäº†', 'info');
        }
        
        // åˆæœŸåŒ–ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        window.addEventListener('resize', () => {
            updateMetrics();
            if (baseContentRect) {
                testVICalculation();
            }
        });
        
        // åˆæœŸãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°
        updateMetrics();
        
        log('ğŸ¯ VIåº§æ¨™ç³»æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†', 'success');
        log('ğŸ“‹ ä½¿ç”¨æ–¹æ³•: ä¸Šè¨˜ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã§å„æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„', 'info');
        log('ğŸ”§ æ¨å¥¨æ‰‹é †: 1) AutoPinåˆæœŸåŒ– â†’ 2) VIè¨ˆç®—ãƒ†ã‚¹ãƒˆ â†’ 3) ãƒªã‚µã‚¤ã‚ºãƒ†ã‚¹ãƒˆ', 'info');
    </script>
</body>
</html>