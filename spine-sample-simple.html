<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã‚·ãƒ³ãƒ—ãƒ«Spineã‚·ãƒ¼ãƒ³</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #f0f0f0;
        font-family: Arial, sans-serif;
      }

      .scene-container {
        position: relative;
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;  /* ãƒªã‚µã‚¤ã‚ºå•é¡Œä¿®æ­£: 50px auto â†’ 0 auto */
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .background-image {
        width: 100%;
        height: auto;
        display: block;
      }

      /* Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”¨Canvas */
      #purattokun-canvas {
        position: absolute;
        left: 35%;  /* èƒŒæ™¯ç”»åƒåŒæœŸï¼ˆè¦ªè¦ç´ åŸºæº–ï¼‰ */
        top: 75%;   /* èƒŒæ™¯ç”»åƒåŒæœŸï¼ˆè¦ªè¦ç´ åŸºæº–ï¼‰ */
        transform: translate(-50%, -50%);
        width: 25%;  /* èƒŒæ™¯ç”»åƒã¨åŒã˜æ¯”ä¾‹æ‹¡ç¸® */
        aspect-ratio: 3/2; /* Canvasæ¯”ç‡çµ±ä¸€ï¼ˆ300:200 = 3:2ï¼‰æ½°ã‚Œé˜²æ­¢ */
        z-index: 10;
        display: none;
        cursor: pointer; /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ */
        border: 2px dashed rgba(255, 0, 0, 0.3); /* ãƒ‡ãƒãƒƒã‚°ç”¨å¢ƒç•Œç·š */
        background: rgba(255, 255, 0, 0.05); /* ãƒ‡ãƒãƒƒã‚°ç”¨èƒŒæ™¯ */
      }

      /* ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šç¯„å›²ã®è¦–è¦šåŒ– */
      .click-area-visualizer {
        position: absolute;
        border: 3px solid rgba(0, 255, 0, 0.8); /* ç·‘è‰²ã®åˆ¤å®šç¯„å›² */
        background: rgba(0, 255, 0, 0.1); /* è–„ã„ç·‘ã®èƒŒæ™¯ */
        pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€šã™ */
        display: none; /* åˆæœŸã¯éè¡¨ç¤º */
        box-sizing: border-box;
      }

      /* åˆ¤å®šç¯„å›²è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
      .debug-controls {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 1000;
      }

      .debug-btn {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 8px 16px;
        margin: 4px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }

      .debug-btn:hover {
        background: #45a049;
      }

      .debug-btn.active {
        background: #ff6b6b;
      }

      /* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒ */
      #purattokun-fallback {
        position: absolute;
        left: 35%;  /* Canvasä½ç½®ã¨åŒæœŸï¼ˆèƒŒæ™¯ç”»åƒåŸºæº–ï¼‰ */
        top: 75%;   /* Canvasä½ç½®ã¨åŒæœŸï¼ˆèƒŒæ™¯ç”»åƒåŸºæº–ï¼‰ */
        transform: translate(-50%, -50%);
        width: 10%;  /* èƒŒæ™¯ç”»åƒã¨åŒã˜æ¯”ä¾‹æ‹¡ç¸® */
        aspect-ratio: 1/1; /* æ­£æ–¹å½¢ç¶­æŒï¼ˆæ½°ã‚Œé˜²æ­¢ï¼‰ */
        object-fit: contain;
        z-index: 10;
        display: block;
      }
    </style>
  </head>
  <body>
    <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
    <div class="debug-controls">
      <div>ğŸ¯ ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šãƒ‡ãƒãƒƒã‚°</div>
      <button id="toggle-click-area" class="debug-btn">åˆ¤å®šç¯„å›²è¡¨ç¤º</button>
      <button id="toggle-canvas-border" class="debug-btn">Canvaså¢ƒç•Œè¡¨ç¤º</button>
    </div>

    <div class="scene-container">
      <!-- èƒŒæ™¯ç”»åƒ -->
      <img
        src="assets/images/ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼TOP.png"
        alt="èƒŒæ™¯"
        class="background-image"
      />

      <!-- Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆCanvasï¼‰ -->
      <canvas id="purattokun-canvas" width="300" height="200"></canvas>
      
      <!-- ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šç¯„å›²ã®è¦–è¦šåŒ– -->
      <div id="click-area-visualizer" class="click-area-visualizer"></div>

      <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒ -->
      <img
        src="assets/images/purattokunn.png"
        alt="ã·ã‚‰ã£ã¨ãã‚“"
        id="purattokun-fallback"
      />
    </div>

    <!-- Spine WebGL Runtime -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.*/dist/iife/spine-webgl.js"></script>

    <script>
      // Spine WebGLã®èª­ã¿è¾¼ã¿å¾…ã¡
      async function waitForSpine() {
        return new Promise((resolve, reject) => {
          let checkCount = 0;
          const maxChecks = 50;

          const checkSpine = () => {
            checkCount++;
            if (typeof spine !== "undefined") {
              console.log("âœ… Spine WebGLèª­ã¿è¾¼ã¿å®Œäº†");
              resolve();
            } else if (checkCount >= maxChecks) {
              reject(new Error("Spine WebGLèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ"));
            } else {
              setTimeout(checkSpine, 100);
            }
          };

          checkSpine();
        });
      }

      // ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å¾…ã¡
      async function waitForAssets(assetManager) {
        return new Promise((resolve, reject) => {
          let checkCount = 0;
          const maxChecks = 50;

          const checkAssets = () => {
            checkCount++;
            if (assetManager.isLoadingComplete()) {
              console.log("âœ… ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å®Œäº†");
              resolve();
            } else if (checkCount >= maxChecks) {
              reject(new Error("ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ"));
            } else {
              setTimeout(checkAssets, 100);
            }
          };

          checkAssets();
        });
      }

      // Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸåŒ–
      async function initSpineCharacter() {
        try {
          await waitForSpine();

          const canvas = document.getElementById("purattokun-canvas");
          const fallback = document.getElementById("purattokun-fallback");

          const gl = canvas.getContext("webgl", { alpha: true });
          if (!gl) {
            throw new Error("WebGLæœªå¯¾å¿œ");
          }

          // ã‚¢ã‚»ãƒƒãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
          const basePath = "./assets/spine/characters/purattokun/";
          const assetManager = new spine.AssetManager(gl, basePath);

          assetManager.loadTextureAtlas("purattokun.atlas");
          assetManager.loadJson("purattokun.json");

          await waitForAssets(assetManager);

          // Spineã‚¹ã‚±ãƒ«ãƒˆãƒ³æ§‹ç¯‰
          const atlas = assetManager.get("purattokun.atlas");
          const atlasLoader = new spine.AtlasAttachmentLoader(atlas);
          const skeletonJson = new spine.SkeletonJson(atlasLoader);
          const skeletonData = skeletonJson.readSkeletonData(
            assetManager.get("purattokun.json")
          );

          const skeleton = new spine.Skeleton(skeletonData);
          skeleton.x = 0; // Canvasä¸­å¤®ï¼ˆæ­£ã—ã„åŸç‚¹ä½ç½®ï¼‰
          skeleton.y = -100; // Canvasä¸­å¤®ï¼ˆæ­£ã—ã„åŸç‚¹ä½ç½®ï¼‰
          skeleton.scaleX = skeleton.scaleY = 0.55; // CLAUDE.mdã®æ¨å¥¨å€¤

          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
          const animationStateData = new spine.AnimationStateData(
            skeleton.data
          );
          const animationState = new spine.AnimationState(animationStateData);

          // ç™»å ´â†’å¾…æ©Ÿã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹é–‹å§‹
          if (
            skeleton.data.findAnimation("syutugen") &&
            skeleton.data.findAnimation("taiki")
          ) {
            console.log("ğŸ¬ syutugenï¼ˆç™»å ´ï¼‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹");
            animationState.setAnimation(0, "syutugen", false); // 1å›ã®ã¿å†ç”Ÿ
            animationState.addAnimation(0, "taiki", true, 0); // å®Œäº†å¾Œã«å¾…æ©Ÿãƒ«ãƒ¼ãƒ—
          } else if (skeleton.data.findAnimation("taiki")) {
            console.log("ğŸ¬ taikiï¼ˆå¾…æ©Ÿï¼‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆsyutugenãªã—ï¼‰");
            animationState.setAnimation(0, "taiki", true);
          }

          // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼
          const renderer = new spine.SceneRenderer(canvas, gl);

          // æç”»ãƒ«ãƒ¼ãƒ—
          let lastTime = Date.now() / 1000;
          function render() {
            const now = Date.now() / 1000;
            const delta = now - lastTime;
            lastTime = now;

            animationState.update(delta);
            animationState.apply(skeleton);
            skeleton.updateWorldTransform();

            gl.clearColor(0, 0, 0, 0);
            gl.clear(gl.COLOR_BUFFER_BIT);
            gl.viewport(0, 0, canvas.width, canvas.height);

            renderer.begin();
            renderer.drawSkeleton(skeleton, true);
            renderer.end();

            requestAnimationFrame(render);
          }
          render();

          // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒä½ç½®åˆ¤å®šï¼‰
          canvas.addEventListener("click", (event) => {
            // Canvaså†…ã®ç›¸å¯¾åº§æ¨™ã‚’å–å¾—
            const rect = canvas.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const clickY = event.clientY - rect.top;
            
            // Canvaså†…åº§æ¨™ã‚’0-1ã®ç¯„å›²ã«æ­£è¦åŒ–
            const normalizedX = clickX / rect.width;
            const normalizedY = clickY / rect.height;
            
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã®ç¯„å›²ã‚’å®šç¾©ï¼ˆCanvasä¸­å¤®ä»˜è¿‘ï¼‰
            // skeleton.x=0, skeleton.y=-100 ã®ä½ç½®ã‚’è€ƒæ…®
            const charCenterX = 0.5; // Canvasä¸­å¤®ï¼ˆ50%ï¼‰
            const charCenterY = 0.6; // Canvasä¸­å¤®ã‚ˆã‚Šå°‘ã—ä¸‹ï¼ˆ60%ï¼‰
            const charWidth = 0.4;   // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¹…ï¼ˆ40%ï¼‰
            const charHeight = 0.5;  // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é«˜ã•ï¼ˆ50%ï¼‰
            
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
            const withinX = Math.abs(normalizedX - charCenterX) < charWidth / 2;
            const withinY = Math.abs(normalizedY - charCenterY) < charHeight / 2;
            
            if (withinX && withinY) {
              // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒå†…ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã®ã¿ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
              if (skeleton.data.findAnimation("yarare")) {
                console.log("ğŸ¯ yarareï¼ˆã‚„ã‚‰ã‚Œï¼‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹");
                animationState.setAnimation(0, "yarare", false); // 1å›ã®ã¿å†ç”Ÿ
                animationState.addAnimation(0, "taiki", true, 0); // å®Œäº†å¾Œã«å¾…æ©Ÿå¾©å¸°
              } else {
                console.log("âš ï¸ yarareã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
              }
            } else {
              console.log("ğŸ” ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒå¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãªã—ï¼‰");
            }
          });

          // ğŸ¯ ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šç¯„å›²ã®è¦–è¦šåŒ–æ©Ÿèƒ½
          const visualizer = document.getElementById("click-area-visualizer");
          
          function updateClickAreaVisualizer() {
            const rect = canvas.getBoundingClientRect();
            
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã®ç¯„å›²è¨­å®šï¼ˆä¸Šè¨˜ã®åˆ¤å®šã¨åŒã˜å€¤ï¼‰
            const charCenterX = 0.5;  // Canvasä¸­å¤®ï¼ˆ50%ï¼‰
            const charCenterY = 0.6;  // Canvasä¸­å¤®ã‚ˆã‚Šå°‘ã—ä¸‹ï¼ˆ60%ï¼‰
            const charWidth = 0.4;    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¹…ï¼ˆ40%ï¼‰
            const charHeight = 0.5;   // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é«˜ã•ï¼ˆ50%ï¼‰
            
            // åˆ¤å®šç¯„å›²ã®å®Ÿéš›ã®ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ã‚’è¨ˆç®—
            const areaWidth = rect.width * charWidth;
            const areaHeight = rect.height * charHeight;
            const areaLeft = rect.left + (rect.width * charCenterX) - (areaWidth / 2);
            const areaTop = rect.top + (rect.height * charCenterY) - (areaHeight / 2);
            
            // è¦–è¦šåŒ–è¦ç´ ã®ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’æ›´æ–°
            visualizer.style.position = "fixed";
            visualizer.style.left = areaLeft + "px";
            visualizer.style.top = areaTop + "px";
            visualizer.style.width = areaWidth + "px";
            visualizer.style.height = areaHeight + "px";
          }
          
          // åˆæœŸä½ç½®è¨­å®šã¨ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
          updateClickAreaVisualizer();
          window.addEventListener("resize", updateClickAreaVisualizer);

          // æˆåŠŸæ™‚ï¼šCanvasè¡¨ç¤ºã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯éè¡¨ç¤º
          canvas.style.display = "block";
          fallback.style.display = "none";

          console.log("âœ… Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸåŒ–å®Œäº†");

          // åˆ©ç”¨å¯èƒ½ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’ãƒ­ã‚°å‡ºåŠ›
          console.log("ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³:");
          for (let i = 0; i < skeleton.data.animations.length; i++) {
            console.log(`  - ${skeleton.data.animations[i].name}`);
          }
        } catch (error) {
          console.error("âŒ Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸåŒ–å¤±æ•—:", error);
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒã®ã¾ã¾è¡¨ç¤º
        }
      }

      // åˆæœŸåŒ–å®Ÿè¡Œ
      window.addEventListener("load", () => {
        setTimeout(initSpineCharacter, 500);
      });

      // ğŸ® ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½
      document.addEventListener("DOMContentLoaded", () => {
        const toggleClickAreaBtn = document.getElementById("toggle-click-area");
        const toggleCanvasBorderBtn = document.getElementById("toggle-canvas-border");
        const visualizer = document.getElementById("click-area-visualizer");
        const canvas = document.getElementById("purattokun-canvas");

        let clickAreaVisible = false;
        let canvasBorderVisible = true; // åˆæœŸçŠ¶æ…‹ã§ã¯è¡¨ç¤º

        // ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šç¯„å›²ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        toggleClickAreaBtn.addEventListener("click", () => {
          clickAreaVisible = !clickAreaVisible;
          visualizer.style.display = clickAreaVisible ? "block" : "none";
          toggleClickAreaBtn.textContent = clickAreaVisible ? "åˆ¤å®šç¯„å›²éè¡¨ç¤º" : "åˆ¤å®šç¯„å›²è¡¨ç¤º";
          toggleClickAreaBtn.classList.toggle("active", clickAreaVisible);
        });

        // Canvaså¢ƒç•Œç·šã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        toggleCanvasBorderBtn.addEventListener("click", () => {
          canvasBorderVisible = !canvasBorderVisible;
          canvas.style.border = canvasBorderVisible 
            ? "2px dashed rgba(255, 0, 0, 0.3)" 
            : "none";
          canvas.style.background = canvasBorderVisible 
            ? "rgba(255, 255, 0, 0.05)" 
            : "transparent";
          toggleCanvasBorderBtn.textContent = canvasBorderVisible ? "Canvaså¢ƒç•Œéè¡¨ç¤º" : "Canvaså¢ƒç•Œè¡¨ç¤º";
          toggleCanvasBorderBtn.classList.toggle("active", canvasBorderVisible);
        });

        // åˆæœŸçŠ¶æ…‹è¨­å®š
        toggleCanvasBorderBtn.classList.add("active");
      });
    </script>
  </body>
</html>
