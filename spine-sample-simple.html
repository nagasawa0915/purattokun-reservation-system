<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã‚·ãƒ³ãƒ—ãƒ«Spineã‚·ãƒ¼ãƒ³</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #f0f0f0;
        font-family: Arial, sans-serif;
      }

      .scene-container {
        position: relative;
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;  /* ãƒªã‚µã‚¤ã‚ºå•é¡Œä¿®æ­£: 50px auto â†’ 0 auto */
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .background-image {
        width: 100%;
        height: auto;
        display: block;
      }

      /* Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”¨Canvas */
      #purattokun-canvas {
        position: absolute;
        left: 35%;  /* èƒŒæ™¯ç”»åƒåŒæœŸï¼ˆè¦ªè¦ç´ åŸºæº–ï¼‰ */
        top: 75%;   /* èƒŒæ™¯ç”»åƒåŒæœŸï¼ˆè¦ªè¦ç´ åŸºæº–ï¼‰ */
        transform: translate(-50%, -50%);
        width: 30%;  /* èƒŒæ™¯ç”»åƒã¨åŒã˜æ¯”ä¾‹æ‹¡ç¸® */
        aspect-ratio: 3/2; /* Canvasæ¯”ç‡çµ±ä¸€ï¼ˆ300:200 = 3:2ï¼‰æ½°ã‚Œé˜²æ­¢ */
        z-index: 10;
        display: block; /* å¸¸ã«è¡¨ç¤ºï¼ˆSpineå¤±æ•—æ™‚ã‚‚æ ã‚’è¡¨ç¤ºï¼‰ */
        cursor: pointer; /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ */
      }


      /* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒ */
      #purattokun-fallback {
        position: absolute;
        left: 35%;  /* Canvasä½ç½®ã¨åŒæœŸï¼ˆèƒŒæ™¯ç”»åƒåŸºæº–ï¼‰ */
        top: 75%;   /* Canvasä½ç½®ã¨åŒæœŸï¼ˆèƒŒæ™¯ç”»åƒåŸºæº–ï¼‰ */
        transform: translate(-50%, -50%);
        width: 10%;  /* èƒŒæ™¯ç”»åƒã¨åŒã˜æ¯”ä¾‹æ‹¡ç¸® */
        aspect-ratio: 1/1; /* æ­£æ–¹å½¢ç¶­æŒï¼ˆæ½°ã‚Œé˜²æ­¢ï¼‰ */
        object-fit: contain;
        z-index: 10;
        display: block;
      }
    </style>
  </head>
  <body>

    <div class="scene-container">
      <!-- èƒŒæ™¯ç”»åƒ -->
      <img
        src="assets/images/ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼TOP.png"
        alt="èƒŒæ™¯"
        class="background-image"
      />

      <!-- Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆCanvasï¼‰ -->
      <canvas id="purattokun-canvas" width="300" height="200"></canvas>
      

      <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒ -->
      <img
        src="assets/images/purattokunn.png"
        alt="ã·ã‚‰ã£ã¨ãã‚“"
        id="purattokun-fallback"
      />

      <!-- HTMLè¨­å®šåˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ  -->
      <div id="purattokun-config" style="display: none;"
           data-x="35"            <!-- æ¨ªä½ç½®ï¼š35%ï¼ˆèƒŒæ™¯ç”»åƒåŸºæº–ï¼‰ -->
           data-y="75"            <!-- ç¸¦ä½ç½®ï¼š75%ï¼ˆèƒŒæ™¯ç”»åƒåŸºæº–ï¼‰ -->
           data-scale="0.55"      <!-- ã‚µã‚¤ã‚ºï¼š0.55å€ -->
           data-fade-delay="1500" <!-- å‡ºç¾é…å»¶ï¼ˆmsï¼‰ -->
           data-fade-duration="2000"> <!-- ãƒ•ã‚§ãƒ¼ãƒ‰æ™‚é–“ï¼ˆmsï¼‰ -->
      </div>
    </div>

    <!-- Spine WebGL Runtime -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.*/dist/iife/spine-webgl.js"></script>

    <script>
      // Spine WebGLã®èª­ã¿è¾¼ã¿å¾…ã¡
      async function waitForSpine() {
        return new Promise((resolve, reject) => {
          let checkCount = 0;
          const maxChecks = 50;

          const checkSpine = () => {
            checkCount++;
            if (typeof spine !== "undefined") {
              console.log("âœ… Spine WebGLèª­ã¿è¾¼ã¿å®Œäº†");
              resolve();
            } else if (checkCount >= maxChecks) {
              reject(new Error("Spine WebGLèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ"));
            } else {
              setTimeout(checkSpine, 100);
            }
          };

          checkSpine();
        });
      }

      // ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å¾…ã¡
      async function waitForAssets(assetManager) {
        return new Promise((resolve, reject) => {
          let checkCount = 0;
          const maxChecks = 50;

          const checkAssets = () => {
            checkCount++;
            if (assetManager.isLoadingComplete()) {
              console.log("âœ… ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å®Œäº†");
              resolve();
            } else if (checkCount >= maxChecks) {
              reject(new Error("ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ"));
            } else {
              setTimeout(checkAssets, 100);
            }
          };

          checkAssets();
        });
      }

      // Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸåŒ–
      async function initSpineCharacter() {
        try {
          await waitForSpine();

          const canvas = document.getElementById("purattokun-canvas");
          const fallback = document.getElementById("purattokun-fallback");

          const gl = canvas.getContext("webgl", { alpha: true });
          if (!gl) {
            throw new Error("WebGLæœªå¯¾å¿œ");
          }

          // ã‚¢ã‚»ãƒƒãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
          const basePath = "./assets/spine/characters/purattokun/";
          const assetManager = new spine.AssetManager(gl, basePath);

          assetManager.loadTextureAtlas("purattokun.atlas");
          assetManager.loadJson("purattokun.json");

          await waitForAssets(assetManager);

          // Spineã‚¹ã‚±ãƒ«ãƒˆãƒ³æ§‹ç¯‰
          const atlas = assetManager.get("purattokun.atlas");
          const atlasLoader = new spine.AtlasAttachmentLoader(atlas);
          const skeletonJson = new spine.SkeletonJson(atlasLoader);
          const skeletonData = skeletonJson.readSkeletonData(
            assetManager.get("purattokun.json")
          );

          const skeleton = new spine.Skeleton(skeletonData);
          
          // ğŸ¯ HTMLè¨­å®šåˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ï¼šè¨­å®šå€¤ã®èª­ã¿å–ã‚Šï¼ˆè¨­å®šãŒã‚ã‚Œã°é©ç”¨ï¼‰
          const config = document.getElementById("purattokun-config");
          let configScale = 0.55; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
          
          if (config) {
            // HTMLè¨­å®šãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿é©ç”¨
            const dataScale = config.getAttribute("data-scale");
            if (dataScale) {
              configScale = parseFloat(dataScale);
            }
            
            // ä½ç½®è¨­å®šã‚‚èª­ã¿å–ã‚Šï¼ˆCSSè¨­å®šã¯ç¶­æŒã€å¿…è¦æ™‚ã®ã¿ä¸Šæ›¸ãï¼‰
            const dataX = config.getAttribute("data-x");
            const dataY = config.getAttribute("data-y");
            if (dataX) canvas.style.left = dataX + "%";
            if (dataY) canvas.style.top = dataY + "%";
            if (dataX) fallback.style.left = dataX + "%";
            if (dataY) fallback.style.top = dataY + "%";
          }

          skeleton.x = 0; // Canvasä¸­å¤®ï¼ˆæ­£ã—ã„åŸç‚¹ä½ç½®ï¼‰
          skeleton.y = -100; // Canvasä¸­å¤®ï¼ˆæ­£ã—ã„åŸç‚¹ä½ç½®ï¼‰
          skeleton.scaleX = skeleton.scaleY = configScale; // HTMLè¨­å®šã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤

          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
          const animationStateData = new spine.AnimationStateData(
            skeleton.data
          );
          const animationState = new spine.AnimationState(animationStateData);

          // ç™»å ´â†’å¾…æ©Ÿã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹é–‹å§‹
          if (
            skeleton.data.findAnimation("syutugen") &&
            skeleton.data.findAnimation("taiki")
          ) {
            console.log("ğŸ¬ syutugenï¼ˆç™»å ´ï¼‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹");
            animationState.setAnimation(0, "syutugen", false); // 1å›ã®ã¿å†ç”Ÿ
            animationState.addAnimation(0, "taiki", true, 0); // å®Œäº†å¾Œã«å¾…æ©Ÿãƒ«ãƒ¼ãƒ—
          } else if (skeleton.data.findAnimation("taiki")) {
            console.log("ğŸ¬ taikiï¼ˆå¾…æ©Ÿï¼‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆsyutugenãªã—ï¼‰");
            animationState.setAnimation(0, "taiki", true);
          }

          // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼
          const renderer = new spine.SceneRenderer(canvas, gl);

          // æç”»ãƒ«ãƒ¼ãƒ—
          let lastTime = Date.now() / 1000;
          function render() {
            const now = Date.now() / 1000;
            const delta = now - lastTime;
            lastTime = now;

            animationState.update(delta);
            animationState.apply(skeleton);
            skeleton.updateWorldTransform();

            gl.clearColor(0, 0, 0, 0);
            gl.clear(gl.COLOR_BUFFER_BIT);
            gl.viewport(0, 0, canvas.width, canvas.height);

            renderer.begin();
            renderer.drawSkeleton(skeleton, true);
            renderer.end();

            requestAnimationFrame(render);
          }
          render();

          // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒä½ç½®åˆ¤å®šï¼‰
          canvas.addEventListener("click", (event) => {
            // Canvaså†…ã®ç›¸å¯¾åº§æ¨™ã‚’å–å¾—
            const rect = canvas.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const clickY = event.clientY - rect.top;
            
            // Canvaså†…åº§æ¨™ã‚’0-1ã®ç¯„å›²ã«æ­£è¦åŒ–
            const normalizedX = clickX / rect.width;
            const normalizedY = clickY / rect.height;
            
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã®ç¯„å›²ã‚’å®šç¾©ï¼ˆCanvasä¸­å¤®ä»˜è¿‘ï¼‰
            // skeleton.x=0, skeleton.y=-100 ã®ä½ç½®ã‚’è€ƒæ…®
            const charCenterX = 0.5; // Canvasä¸­å¤®ï¼ˆ50%ï¼‰
            const charCenterY = 0.6; // Canvasä¸­å¤®ã‚ˆã‚Šå°‘ã—ä¸‹ï¼ˆ60%ï¼‰
            const charWidth = 0.4;   // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¹…ï¼ˆ40%ï¼‰
            const charHeight = 0.5;  // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é«˜ã•ï¼ˆ50%ï¼‰
            
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
            const withinX = Math.abs(normalizedX - charCenterX) < charWidth / 2;
            const withinY = Math.abs(normalizedY - charCenterY) < charHeight / 2;
            
            if (withinX && withinY) {
              // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒå†…ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã®ã¿ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
              if (skeleton.data.findAnimation("yarare")) {
                console.log("ğŸ¯ yarareï¼ˆã‚„ã‚‰ã‚Œï¼‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹");
                animationState.setAnimation(0, "yarare", false); // 1å›ã®ã¿å†ç”Ÿ
                animationState.addAnimation(0, "taiki", true, 0); // å®Œäº†å¾Œã«å¾…æ©Ÿå¾©å¸°
              } else {
                console.log("âš ï¸ yarareã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
              }
            } else {
              console.log("ğŸ” ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒå¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãªã—ï¼‰");
            }
          });


          // æˆåŠŸæ™‚ï¼šCanvasè¡¨ç¤ºã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯éè¡¨ç¤º
          canvas.style.opacity = "1";
          fallback.style.opacity = "0";

          console.log("âœ… Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸåŒ–å®Œäº†");

          // åˆ©ç”¨å¯èƒ½ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’ãƒ­ã‚°å‡ºåŠ›
          console.log("ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³:");
          for (let i = 0; i < skeleton.data.animations.length; i++) {
            console.log(`  - ${skeleton.data.animations[i].name}`);
          }
        } catch (error) {
          console.error("âŒ Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸåŒ–å¤±æ•—:", error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ï¼šCanvaséè¡¨ç¤ºã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º
          canvas.style.opacity = "0";
          fallback.style.opacity = "1";
        }
      }

      // åˆæœŸåŒ–å®Ÿè¡Œ
      window.addEventListener("load", () => {
        setTimeout(initSpineCharacter, 500);
      });

      // ğŸ¯ HTMLè¨­å®šåˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ï¼šè¨­å®šå€¤å¤‰æ›´æ™‚ã®å‹•çš„æ›´æ–°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
      function updateCharacterFromConfig() {
        const config = document.getElementById("purattokun-config");
        const canvas = document.getElementById("purattokun-canvas");
        const fallback = document.getElementById("purattokun-fallback");
        
        if (config && canvas && fallback) {
          // dataå±æ€§ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿é©ç”¨ï¼ˆCSSè¨­å®šã‚’ä¸Šæ›¸ãã—ãªã„ï¼‰
          const dataX = config.getAttribute("data-x");
          const dataY = config.getAttribute("data-y");
          
          if (dataX) {
            canvas.style.left = dataX + "%";
            fallback.style.left = dataX + "%";
          }
          if (dataY) {
            canvas.style.top = dataY + "%";
            fallback.style.top = dataY + "%";
          }
          
          console.log(`ğŸ“ HTMLè¨­å®šé©ç”¨: ${dataX || 'CSSå€¤'}%, ${dataY || 'CSSå€¤'}%`);
        }
      }

      // åˆæœŸåŒ–æ™‚ã«HTMLè¨­å®šã‚’é©ç”¨ï¼ˆè¨­å®šè¿½åŠ æ–¹å¼ï¼‰
      document.addEventListener("DOMContentLoaded", () => {
        updateCharacterFromConfig();
      });

      // ========== ğŸ¯ ç·¨é›†ã‚·ã‚¹ãƒ†ãƒ çµ±åˆï¼ˆspine-sample-simple.htmlç”¨ï¼‰ ==========

      // ç·¨é›†ã‚·ã‚¹ãƒ†ãƒ å‹•çš„èª­ã¿è¾¼ã¿
      function loadEditingSystem() {
        console.log('ğŸ”„ ç·¨é›†ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿é–‹å§‹...');
        
        // ç·¨é›†ã‚·ã‚¹ãƒ†ãƒ ã®CSSèª­ã¿è¾¼ã¿
        const editCSS = document.createElement('link');
        editCSS.rel = 'stylesheet';
        editCSS.href = 'spine-positioning-system-explanation.css';
        document.head.appendChild(editCSS);
        
        // ç·¨é›†ã‚·ã‚¹ãƒ†ãƒ ã®JSèª­ã¿è¾¼ã¿
        const editJS = document.createElement('script');
        editJS.src = 'spine-positioning-system-explanation.js';
        editJS.onload = function() {
          console.log('âœ… ç·¨é›†ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿å®Œäº†');
          initEditingMode();
        };
        editJS.onerror = function() {
          console.error('âŒ ç·¨é›†ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿å¤±æ•—');
          alert('ç·¨é›†ã‚·ã‚¹ãƒ†ãƒ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚spine-positioning-system-explanation.html ã‹ã‚‰å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        };
        document.head.appendChild(editJS);
      }

      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
      function initEditingMode() {
        console.log('ğŸ¯ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–é–‹å§‹');
        
        // ç·¨é›†ãƒ‘ãƒãƒ«ã‚’ä½œæˆ
        const editPanel = document.createElement('div');
        editPanel.id = 'edit-control-panel';
        editPanel.innerHTML = `
          <div id="edit-panel-container" style="position: fixed; top: 20px; right: 20px; background: white; padding: 8px; border-radius: 6px; box-shadow: 0 1px 6px rgba(0,0,0,0.15); z-index: 1001; font-family: sans-serif; min-width: 110px; cursor: move;">
            <div id="edit-panel-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; cursor: move;">
              <span style="font-size: 11px; font-weight: bold; color: #ff6b6b;">ğŸ¯ ç·¨é›†</span>
              <button id="panel-minimize-btn" style="background: none; border: none; font-size: 10px; cursor: pointer; color: #666; padding: 0;">âˆ’</button>
            </div>
            <div id="edit-panel-content" style="display: flex; flex-direction: column; gap: 4px;">
              <button id="edit-character-btn" style="padding: 4px 8px; background: #ff6b6b; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·¨é›†</button>
              <button id="exit-edit-btn" style="padding: 4px 8px; background: #95A5A6; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;">ç·¨é›†çµ‚äº†</button>
              <div id="coordinate-display" style="margin-top: 4px; padding: 4px; background: #f8f9fa; border-radius: 3px; font-size: 8px; color: #666; line-height: 1.1;">
                ç·¨é›†ãƒ¢ãƒ¼ãƒ‰å¾…æ©Ÿä¸­...
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(editPanel);
        
        // ç·¨é›†ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        setupEditingEvents();
        
        // ãƒ‘ãƒãƒ«ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã‚’è¨­å®š
        setupPanelDragging();
      }

      // ãƒ‘ãƒãƒ«ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½è¨­å®š
      function setupPanelDragging() {
        const panelContainer = document.getElementById('edit-panel-container');
        const panelHeader = document.getElementById('edit-panel-header');
        const minimizeBtn = document.getElementById('panel-minimize-btn');
        const panelContent = document.getElementById('edit-panel-content');
        
        if (!panelContainer || !panelHeader) return;
        
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let isMinimized = false;
        
        // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
        panelHeader.addEventListener('mousedown', (e) => {
          // æœ€å°åŒ–ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯ãƒ‰ãƒ©ãƒƒã‚°ã—ãªã„
          if (e.target === minimizeBtn) return;
          
          isDragging = true;
          const rect = panelContainer.getBoundingClientRect();
          dragOffset.x = e.clientX - rect.left;
          dragOffset.y = e.clientY - rect.top;
          
          panelContainer.style.transition = 'none';
          document.addEventListener('mousemove', handleDrag);
          document.addEventListener('mouseup', handleDragEnd);
          e.preventDefault();
        });
        
        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­
        function handleDrag(e) {
          if (!isDragging) return;
          
          const newX = e.clientX - dragOffset.x;
          const newY = e.clientY - dragOffset.y;
          
          // ç”»é¢ç«¯ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ã‚ˆã†åˆ¶é™
          const maxX = window.innerWidth - panelContainer.offsetWidth;
          const maxY = window.innerHeight - panelContainer.offsetHeight;
          
          const boundedX = Math.max(0, Math.min(newX, maxX));
          const boundedY = Math.max(0, Math.min(newY, maxY));
          
          panelContainer.style.left = boundedX + 'px';
          panelContainer.style.top = boundedY + 'px';
          panelContainer.style.right = 'auto'; // rightãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç„¡åŠ¹åŒ–
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
        function handleDragEnd() {
          isDragging = false;
          panelContainer.style.transition = '';
          document.removeEventListener('mousemove', handleDrag);
          document.removeEventListener('mouseup', handleDragEnd);
          
          // ä½ç½®ã‚’è¨˜æ†¶ï¼ˆlocalStorageï¼‰
          const rect = panelContainer.getBoundingClientRect();
          localStorage.setItem('editPanelPosition', JSON.stringify({
            x: rect.left,
            y: rect.top
          }));
        }
        
        // æœ€å°åŒ–/å¾©å…ƒæ©Ÿèƒ½
        minimizeBtn.addEventListener('click', () => {
          isMinimized = !isMinimized;
          
          if (isMinimized) {
            panelContent.style.display = 'none';
            minimizeBtn.textContent = '+';
            panelContainer.style.minWidth = '60px';
          } else {
            panelContent.style.display = 'flex';
            minimizeBtn.textContent = 'âˆ’';
            panelContainer.style.minWidth = '110px';
          }
          
          // æœ€å°åŒ–çŠ¶æ…‹ã‚’è¨˜æ†¶
          localStorage.setItem('editPanelMinimized', isMinimized);
        });
        
        // ä¿å­˜ã•ã‚ŒãŸä½ç½®ã¨çŠ¶æ…‹ã‚’å¾©å…ƒ
        const savedPosition = localStorage.getItem('editPanelPosition');
        const savedMinimized = localStorage.getItem('editPanelMinimized');
        
        if (savedPosition) {
          const pos = JSON.parse(savedPosition);
          panelContainer.style.left = pos.x + 'px';
          panelContainer.style.top = pos.y + 'px';
          panelContainer.style.right = 'auto';
        }
        
        if (savedMinimized === 'true') {
          panelContent.style.display = 'none';
          minimizeBtn.textContent = '+';
          panelContainer.style.minWidth = '60px';
          isMinimized = true;
        }
      }

      // ç·¨é›†ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      function setupEditingEvents() {
        console.log('âš™ï¸ ç·¨é›†ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šä¸­...');
        
        document.getElementById('edit-character-btn').addEventListener('click', () => {
          console.log('ğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹');
          // spine-positioning-system-explanation.js ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—
          if (typeof startCharacterEdit === 'function') {
            startCharacterEdit();
          } else {
            console.error('âŒ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·¨é›†æ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            alert('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç·¨é›†æ©Ÿèƒ½ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç·¨é›†ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          }
        });
        
        // Canvasç·¨é›†ãƒœã‚¿ãƒ³å‰Šé™¤ï¼šè¡¨ç¤ºç¯„å›²ç·¨é›†ã¯ä¸è¦
        
        document.getElementById('exit-edit-btn').addEventListener('click', () => {
          if (confirm('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ')) {
            window.location.href = window.location.pathname; // ?edit=true ã‚’å‰Šé™¤
          }
        });
      }

      // ğŸ¯ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('edit') === 'true') {
        console.log('ğŸ¯ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ');
        // DOMContentLoadedå¾Œã«ç·¨é›†ã‚·ã‚¹ãƒ†ãƒ ã‚’èª­ã¿è¾¼ã¿
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', loadEditingSystem);
        } else {
          loadEditingSystem();
        }
      }
    </script>
  </body>
</html>
