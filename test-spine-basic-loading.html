<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 Spine基本読み込みテスト - ぷらっとくん</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        
        .title {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: bold;
        }
        
        .control-panel {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .control-button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .primary-button {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
        }
        
        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,107,107,0.4);
        }
        
        .secondary-button {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            color: white;
        }
        
        .secondary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78,205,196,0.4);
        }
        
        .spine-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 20px;
            position: relative;
        }
        
        #spine-canvas {
            border: 2px solid #ddd;
            border-radius: 8px;
            background: transparent;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            padding: 20px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .info-panel {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info-panel h3 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        
        .info-panel ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .info-panel li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">
            🧪 Spine基本読み込みテスト - ぷらっとくん
        </div>
        
        <div class="info-panel">
            <h3>🎯 テスト内容</h3>
            <ul>
                <li><strong>対象キャラクター</strong>: ぷらっとくん (purattokun)</li>
                <li><strong>テスト方法</strong>: 既存の成功パターンを使用</li>
                <li><strong>ファイル</strong>: assets/spine/characters/purattokun/</li>
                <li><strong>アニメーション</strong>: syutugen（出現） → taiki（待機）</li>
                <li><strong>エンジン</strong>: 既存のSpine統合システム</li>
            </ul>
        </div>
        
        <div class="control-panel">
            <button class="control-button primary-button" onclick="loadSpineBasic()">
                🚀 基本読み込み開始
            </button>
            <button class="control-button secondary-button" onclick="playAnimationTest('syutugen')">
                🎬 出現アニメ
            </button>
            <button class="control-button secondary-button" onclick="playAnimationTest('taiki')">
                😊 待機アニメ
            </button>
            <button class="control-button secondary-button" onclick="playAnimationTest('yarare')">
                😵 やられアニメ
            </button>
            <button class="control-button secondary-button" onclick="clearTestLog()">
                🗑️ ログクリア
            </button>
        </div>
        
        <div class="spine-container">
            <canvas id="spine-canvas" width="400" height="400"></canvas>
        </div>
        
        <div class="log-container" id="log-display">
            🧪 Spine基本読み込みテストログ - 準備中...\n
        </div>
    </div>

    <!-- Spine WebGL Runtime（CDN版・index.htmlと同じ） -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.24/dist/iife/spine-webgl.js"></script>

    <script>
        // グローバル変数
        let canvas = null;
        let gl = null;
        let assetManager = null;
        let skeleton = null;
        let animationState = null;
        let logDisplay = null;
        
        // アニメーション統合制御
        let isAnimationRunning = false;

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            logDisplay = document.getElementById('log-display');
            testLog('🧪 Spine基本読み込みテストシステム起動', 'success');
            testLog('📁 使用ファイル: assets/spine/characters/purattokun/', 'info');
        });
        
        // アセット読み込み待機用ヘルパー関数（index.htmlから移植）
        function waitForAssets(assetManager) {
            return new Promise((resolve, reject) => {
                function check() {
                    if (assetManager.isLoadingComplete()) {
                        resolve();
                    } else if (assetManager.hasErrors()) {
                        reject(new Error('Asset loading failed: ' + assetManager.getErrors()));
                    } else {
                        setTimeout(check, 100);
                    }
                }
                check();
            });
        }

        // ログ表示関数
        function testLog(message, type = 'info') {
            if (!logDisplay) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const statusIcon = type === 'error' ? '❌' : 
                              type === 'success' ? '✅' : 
                              type === 'warning' ? '⚠️' : 'ℹ️';
            
            const logLine = `[${timestamp}] ${statusIcon} ${message}\n`;
            logDisplay.textContent += logLine;
            logDisplay.scrollTop = logDisplay.scrollHeight;
            
            console.log(`Spineテスト: ${message}`);
        }

        // 基本的なSpine読み込み（既存パターンベース）
        async function loadSpineBasic() {
            testLog('🚀 Spine基本読み込み開始', 'info');
            
            try {
                // Canvas初期化
                canvas = document.getElementById('spine-canvas');
                if (!canvas) {
                    throw new Error('Canvas要素が見つかりません');
                }
                
                testLog('📐 Canvas初期化成功', 'success');
                
                // WebGL初期化（最適化設定）
                gl = canvas.getContext('webgl', {
                    alpha: true,
                    premultipliedAlpha: true,
                    antialias: true,
                    depth: false,
                    stencil: false
                });
                
                if (!gl) {
                    throw new Error('WebGL初期化失敗');
                }
                
                testLog('✅ WebGL初期化成功（最適化設定適用）', 'success');
                
                // Spine WebGLライブラリ確認
                if (!window.spine) {
                    throw new Error('Spine WebGLライブラリが読み込まれていません');
                }
                
                testLog('📚 Spine WebGLライブラリ確認済み', 'info');
                testLog(`📋 利用可能プロパティ: ${Object.keys(window.spine).join(', ')}`, 'info');
                
                // webglサブモジュール確認
                if (window.spine.webgl) {
                    testLog(`🔍 spine.webgl クラス: ${Object.keys(window.spine.webgl).join(', ')}`, 'info');
                } else {
                    testLog('⚠️ spine.webgl が見つかりません', 'warning');
                }
                
                // アセットマネージャ初期化（index.htmlと同じ方式）
                assetManager = new spine.AssetManager(gl, 'assets/spine/characters/purattokun/');
                
                // ファイル読み込み（ベースパス相対）
                assetManager.loadTextureAtlas('purattokun.atlas');
                assetManager.loadJson('purattokun.json');
                
                testLog('📁 Spineファイル読み込み開始', 'info');
                
                // 読み込み完了待機（index.htmlと同じヘルパー関数使用）
                await waitForAssets(assetManager);
                
                testLog('✅ Spineアセット読み込み完了', 'success');
                initializeSkeleton();
                
            } catch (error) {
                testLog(`❌ 初期化エラー: ${error.message}`, 'error');
                console.error('Spine初期化エラー:', error);
            }
        }
        
        // スケルトン初期化
        function initializeSkeleton() {
            try {
                testLog('🦴 スケルトン初期化開始', 'info');
                
                // アトラス・スケルトンデータ取得（index.htmlと同じ方式）
                const atlas = assetManager.get('purattokun.atlas');
                const atlasLoader = new spine.AtlasAttachmentLoader(atlas);
                const skeletonJson = new spine.SkeletonJson(atlasLoader);
                
                const skeletonData = skeletonJson.readSkeletonData(assetManager.get('purattokun.json'));
                
                // スケルトン作成（index.htmlと同じ方式）
                skeleton = new spine.Skeleton(skeletonData);
                
                // キャラクター位置設定（index.htmlと同じ）
                skeleton.x = 0;
                skeleton.y = -100; // index.htmlと同じpositionY値
                skeleton.scaleX = skeleton.scaleY = 0.55; // index.htmlと同じscale値
                
                // アニメーションステート初期化
                const animationStateData = new spine.AnimationStateData(skeleton.data);
                animationState = new spine.AnimationState(animationStateData);
                
                // デフォルトアニメーション設定
                animationState.setAnimation(0, 'taiki', true);
                
                testLog('✅ スケルトン初期化完了', 'success');
                testLog('🎬 デフォルトアニメーション（taiki）開始', 'info');
                
                // レンダラー初期化（index.htmlと同じ方式）
                const renderer = new spine.SceneRenderer(canvas, gl);
                
                // 描画開始
                isAnimationRunning = true;
                let lastTime = Date.now() / 1000;
                
                function render() {
                    if (!isAnimationRunning || !skeleton || !animationState) {
                        return;
                    }
                    
                    try {
                        const now = Date.now() / 1000;
                        const delta = now - lastTime;
                        lastTime = now;
                        
                        // アニメーション更新
                        animationState.update(delta);
                        animationState.apply(skeleton);
                        skeleton.updateWorldTransform();
                        
                        // 画面クリア・ビューポート設定
                        gl.clearColor(0, 0, 0, 0);
                        gl.clear(gl.COLOR_BUFFER_BIT);
                        gl.viewport(0, 0, canvas.width, canvas.height);
                        
                        // 描画（index.htmlと同じ3段階方式）
                        renderer.begin();
                        renderer.drawSkeleton(skeleton, true);
                        renderer.end();
                        
                    } catch (error) {
                        testLog(`❌ 描画エラー: ${error.message}`, 'error');
                        console.error('描画エラー:', error);
                        isAnimationRunning = false;
                        return;
                    }
                    
                    requestAnimationFrame(render);
                }
                
                requestAnimationFrame(render);
                
                testLog('🎉 Spine基本読み込み完全成功！', 'success');
                
            } catch (error) {
                testLog(`❌ スケルトン初期化エラー: ${error.message}`, 'error');
                console.error('スケルトン初期化エラー:', error);
            }
        }
        
        // アニメーション再生テスト
        function playAnimationTest(animationName) {
            if (!animationState) {
                testLog('❌ アニメーション未初期化（先に基本読み込みを実行してください）', 'error');
                return;
            }
            
            testLog(`🎬 アニメーションテスト: ${animationName}`, 'info');
            
            try {
                if (animationName === 'syutugen') {
                    // 出現 → 待機の自然遷移
                    animationState.setAnimation(0, 'syutugen', false);
                    animationState.addAnimation(0, 'taiki', true, 0);
                    testLog('📋 出現→待機の自然遷移設定', 'info');
                } else {
                    // 単発アニメーション
                    const loop = animationName === 'taiki';
                    animationState.setAnimation(0, animationName, loop);
                    testLog(`📋 ${animationName}アニメーション設定（ループ: ${loop}）`, 'info');
                }
            } catch (error) {
                testLog(`❌ アニメーション再生エラー: ${error.message}`, 'error');
                console.error('アニメーション再生エラー:', error);
            }
        }
        
        // ログクリア
        function clearTestLog() {
            if (logDisplay) {
                logDisplay.textContent = '🗑️ ログクリアされました\n';
            }
            testLog('🧪 ログクリア実行', 'info');
        }
        
        // クリーンアップ
        window.addEventListener('beforeunload', () => {
            isAnimationRunning = false;
            if (assetManager) {
                assetManager.dispose();
            }
        });
        
        // デバッグ用グローバル関数
        window.spineBasicDebug = {
            canvas: () => canvas,
            gl: () => gl,
            skeleton: () => skeleton,
            animationState: () => animationState,
            assetManager: () => assetManager
        };
        
        // 初期化完了ログ
        console.log('🧪 Spine基本読み込みテストシステム初期化完了');
        console.log('デバッグ用: window.spineBasicDebug でアクセス可能');
    </script>
</body>
</html>