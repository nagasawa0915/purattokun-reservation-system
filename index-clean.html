<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>クリーンテスト環境 - 動的Spineキャラクター実験</title>
    <style>
        /* 基本リセット */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #f0f0f0;
            font-family: Arial, sans-serif;
        }

        /* 🔑 重要：シーンコンテナ（レスポンシブ基準） */
        .scene-container {
            position: relative;           /* 子要素の絶対位置基準 */
            width: 100%;                 /* 画面幅に合わせる */
            max-width: 1200px;           /* 最大幅制限 */
            margin: 0 auto;              /* 中央寄せ */
            background: white;           
            border-radius: 10px;         
            overflow: hidden;            /* はみ出し防止 */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* 🎯 重要：背景画像（基準となる要素） */
        .background-image {
            width: 100%;                 /* コンテナ幅に合わせる */
            height: auto;                /* 縦横比維持 */
            display: block;              /* inline要素の隙間除去 */
        }

        /* 🎮 動的に追加されるSpineキャラクター用のベーススタイル */
        .dynamic-spine-canvas {
            position: absolute;
            cursor: pointer;
            z-index: 10;
        }

        /* 🎯 ドラッグ&ドロップエリア */
        .drop-zone {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 300px;
            height: 200px;
            border: 3px dashed #007bff;
            background: rgba(0, 123, 255, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 100;
        }

        .drop-zone.dragover {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.2);
        }

        .drop-zone-content {
            color: #007bff;
            font-weight: bold;
        }

        /* 🎯 コントロールパネル */
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .controls h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .controls button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .controls button:hover {
            background: #0056b3;
        }

        /* 📊 ログエリア */
        .log-area {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            height: 150px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 8px;
            overflow-y: auto;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="scene-container">
        <!-- 背景画像（基準となる要素） -->
        <img src="assets/images/クラウドパートナーTOP.png" alt="背景" class="background-image">
        
        <!-- 🎯 ドラッグ&ドロップエリア -->
        <div class="drop-zone" id="drop-zone">
            <div class="drop-zone-content">
                <h4>📦 Spineファイルをここにドロップ</h4>
                <p>.json, .atlas, .png ファイル<br>または フォルダをドロップ</p>
            </div>
        </div>
        
        <!-- 🎯 コントロールパネル -->
        <div class="controls">
            <h3>🎮 動的Spine実験</h3>
            <button onclick="loadTestCharacter('purattokun')">ぷらっとくん追加</button>
            <button onclick="loadTestCharacter('nezumi')">ねずみ追加</button>
            <button onclick="clearAllCharacters()">全キャラクター削除</button>
            <button onclick="toggleDebugMode()">デバッグ表示切替</button>
        </div>
        
        <!-- 📊 ログエリア -->
        <div class="log-area" id="log-area"></div>
    </div>

    <!-- Spine WebGL Runtime -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.24/dist/iife/spine-webgl.js"></script>
    
    <script>
        // 🎯 動的Spineキャラクター管理システム
        const dynamicSpineSystem = {
            characters: {},
            nextCharacterId: 1,
            debugMode: false
        };

        // 📝 ログ機能
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('log-area');
            const colors = {
                info: '#00ff00',
                warn: '#ffff00', 
                error: '#ff0000',
                success: '#00ff88'
            };
            
            const logElement = document.createElement('div');
            logElement.style.color = colors[type] || colors.info;
            logElement.textContent = `[${timestamp}] ${message}`;
            
            logArea.appendChild(logElement);
            logArea.scrollTop = logArea.scrollHeight;
            
            console.log(`[動的Spine] ${message}`);
        }

        // 🎮 テストキャラクター読み込み
        async function loadTestCharacter(characterType) {
            const characterConfigs = {
                'purattokun': {
                    basePath: './assets/spine/characters/purattokun/',
                    atlasFile: 'purattokun.atlas',
                    jsonFile: 'purattokun.json',
                    scale: 0.55,
                    position: { x: 35, y: 75 },
                    size: { width: 25 }
                },
                'nezumi': {
                    basePath: './assets/spine/characters/nezumi/',
                    atlasFile: 'nezumi.atlas', 
                    jsonFile: 'nezumi.json',
                    scale: 0.45,
                    position: { x: 60, y: 45 },
                    size: { width: 20 }
                }
            };

            const config = characterConfigs[characterType];
            if (!config) {
                log(`エラー: 未知のキャラクタータイプ: ${characterType}`, 'error');
                return;
            }

            const characterId = `dynamic_${characterType}_${dynamicSpineSystem.nextCharacterId++}`;
            log(`${characterType} キャラクター追加開始 (ID: ${characterId})`);

            try {
                await createDynamicSpineCharacter(characterId, config);
                log(`✅ ${characterType} キャラクター追加成功`, 'success');
            } catch (error) {
                log(`❌ ${characterType} キャラクター追加失敗: ${error.message}`, 'error');
            }
        }

        // 🔧 動的Spineキャラクター作成
        async function createDynamicSpineCharacter(characterId, config) {
            log(`Canvas要素作成中... (${characterId})`);

            // Canvas要素を動的作成
            const canvas = document.createElement('canvas');
            canvas.id = `canvas_${characterId}`;
            canvas.width = 300;
            canvas.height = 200;
            canvas.className = 'dynamic-spine-canvas';
            
            // 位置設定
            canvas.style.left = `${config.position.x}%`;
            canvas.style.top = `${config.position.y}%`;
            canvas.style.width = `${config.size.width}%`;
            canvas.style.transform = 'translate(-50%, -50%)';
            canvas.style.aspectRatio = '3/2';

            // シーンに追加
            document.querySelector('.scene-container').appendChild(canvas);
            log(`Canvas要素追加完了 (${canvas.id})`);

            // Spine WebGL読み込み待ち
            await waitForSpine();
            log(`Spine WebGL利用可能確認済み`);

            // WebGLコンテキスト取得
            const gl = canvas.getContext("webgl", { alpha: true });
            if (!gl) {
                throw new Error("WebGL未対応");
            }
            log(`WebGLコンテキスト取得成功`);

            // アセットマネージャー作成
            log(`アセット読み込み開始: ${config.basePath}`);
            const assetManager = new spine.AssetManager(gl, config.basePath);
            assetManager.loadTextureAtlas(config.atlasFile);
            assetManager.loadJson(config.jsonFile);

            await waitForAssets(assetManager);
            log(`アセット読み込み完了 (atlas: ${config.atlasFile}, json: ${config.jsonFile})`);

            // Spineスケルトン構築
            const atlas = assetManager.get(config.atlasFile);
            const atlasLoader = new spine.AtlasAttachmentLoader(atlas);
            const skeletonJson = new spine.SkeletonJson(atlasLoader);
            const skeletonData = skeletonJson.readSkeletonData(
                assetManager.get(config.jsonFile)
            );

            const skeleton = new spine.Skeleton(skeletonData);
            skeleton.x = 0;
            skeleton.y = -100; // キャラクターによる調整
            skeleton.scaleX = skeleton.scaleY = config.scale;

            log(`Spineスケルトン構築完了 (scale: ${config.scale})`);

            // アニメーション設定
            const animationStateData = new spine.AnimationStateData(skeleton.data);
            const animationState = new spine.AnimationState(animationStateData);

            // レンダラー作成
            const renderer = new spine.SceneRenderer(canvas, gl);
            log(`レンダラー作成完了`);

            // デフォルトアニメーション設定
            const animations = skeleton.data.animations.map(anim => anim.name);
            log(`利用可能アニメーション: ${animations.join(', ')}`);
            
            if (animations.includes('taiki')) {
                animationState.setAnimation(0, 'taiki', true);
                log(`デフォルトアニメーション設定: taiki (loop)`);
            } else if (animations.length > 0) {
                animationState.setAnimation(0, animations[0], true);
                log(`デフォルトアニメーション設定: ${animations[0]} (loop)`);
            }

            // 描画ループ開始
            let lastTime = Date.now() / 1000;
            function render() {
                const now = Date.now() / 1000;
                const delta = now - lastTime;
                lastTime = now;

                animationState.update(delta);
                animationState.apply(skeleton);
                skeleton.updateWorldTransform();

                gl.clearColor(0, 0, 0, 0);
                gl.clear(gl.COLOR_BUFFER_BIT);
                gl.viewport(0, 0, canvas.width, canvas.height);

                renderer.begin();
                renderer.drawSkeleton(skeleton, true);
                renderer.end();

                requestAnimationFrame(render);
            }
            render();
            log(`描画ループ開始`);

            // クリックハンドラー設定
            canvas.addEventListener('click', () => {
                log(`${characterId} クリックされました`);
                if (animations.includes('yarare')) {
                    animationState.setAnimation(0, 'yarare', false);
                    animationState.addAnimation(0, 'taiki', true, 0);
                }
            });

            // キャラクター情報保存
            dynamicSpineSystem.characters[characterId] = {
                canvas, skeleton, animationState, renderer, config, animations
            };

            log(`🎯 動的キャラクター追加完了: ${characterId}`, 'success');
        }

        // 🧹 全キャラクター削除
        function clearAllCharacters() {
            const characterIds = Object.keys(dynamicSpineSystem.characters);
            log(`全キャラクター削除開始 (${characterIds.length}個)`);

            characterIds.forEach(characterId => {
                const character = dynamicSpineSystem.characters[characterId];
                if (character && character.canvas) {
                    character.canvas.remove();
                }
                delete dynamicSpineSystem.characters[characterId];
            });

            log(`✅ 全キャラクター削除完了`, 'success');
        }

        // 🔍 デバッグ表示切替
        function toggleDebugMode() {
            dynamicSpineSystem.debugMode = !dynamicSpineSystem.debugMode;
            log(`デバッグモード: ${dynamicSpineSystem.debugMode ? 'ON' : 'OFF'}`);
            
            Object.values(dynamicSpineSystem.characters).forEach(character => {
                if (character.canvas) {
                    character.canvas.style.border = dynamicSpineSystem.debugMode 
                        ? '2px solid red' : 'none';
                }
            });
        }

        // 📦 ドラッグ&ドロップ機能（将来実装）
        function setupDragDrop() {
            const dropZone = document.getElementById('drop-zone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                log('ファイルドロップ機能は将来実装予定', 'warn');
            });
        }

        // 🔧 ユーティリティ関数 (元のindex.htmlから移植)
        async function waitForSpine() {
            return new Promise((resolve, reject) => {
                let checkCount = 0;
                const maxChecks = 50;

                const checkSpine = () => {
                    checkCount++;
                    if (typeof spine !== "undefined") {
                        log("✅ Spine WebGL読み込み完了");
                        resolve();
                    } else if (checkCount >= maxChecks) {
                        reject(new Error("Spine WebGL読み込みタイムアウト"));
                    } else {
                        setTimeout(checkSpine, 100);
                    }
                };

                checkSpine();
            });
        }

        async function waitForAssets(assetManager) {
            return new Promise((resolve, reject) => {
                let checkCount = 0;
                const maxChecks = 50;

                const checkAssets = () => {
                    checkCount++;
                    if (assetManager.isLoadingComplete()) {
                        log("✅ アセット読み込み完了");
                        resolve();
                    } else if (checkCount >= maxChecks) {
                        reject(new Error("アセット読み込みタイムアウト"));
                    } else {
                        setTimeout(checkAssets, 100);
                    }
                };

                checkAssets();
            });
        }

        // 🚀 システム初期化
        window.addEventListener("load", () => {
            log("🎯 動的Spine実験環境 初期化完了", 'success');
            log("📖 使用方法:", 'info');
            log("  1. 「ぷらっとくん追加」「ねずみ追加」ボタンで動的キャラクター追加", 'info');
            log("  2. 「全キャラクター削除」で全削除", 'info');
            log("  3. 「デバッグ表示切替」でCanvas境界線表示", 'info');
            log("  4. キャラクターをクリックでアニメーション再生", 'info');
            
            setupDragDrop();
        });

        // デバッグ用グローバル関数
        window.dynamicSpineDebug = {
            system: dynamicSpineSystem,
            log,
            loadTestCharacter,
            clearAllCharacters,
            toggleDebugMode
        };
    </script>
</body>
</html>