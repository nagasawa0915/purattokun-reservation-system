<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¯ãƒªãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆç’°å¢ƒ - å‹•çš„Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å®Ÿé¨“</title>
    <style>
        /* åŸºæœ¬ãƒªã‚»ãƒƒãƒˆ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #f0f0f0;
            font-family: Arial, sans-serif;
        }

        /* ğŸ”‘ é‡è¦ï¼šã‚·ãƒ¼ãƒ³ã‚³ãƒ³ãƒ†ãƒŠï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–åŸºæº–ï¼‰ */
        .scene-container {
            position: relative;           /* å­è¦ç´ ã®çµ¶å¯¾ä½ç½®åŸºæº– */
            width: 100%;                 /* ç”»é¢å¹…ã«åˆã‚ã›ã‚‹ */
            max-width: 1200px;           /* æœ€å¤§å¹…åˆ¶é™ */
            margin: 0 auto;              /* ä¸­å¤®å¯„ã› */
            background: white;           
            border-radius: 10px;         
            overflow: hidden;            /* ã¯ã¿å‡ºã—é˜²æ­¢ */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* ğŸ¯ é‡è¦ï¼šèƒŒæ™¯ç”»åƒï¼ˆåŸºæº–ã¨ãªã‚‹è¦ç´ ï¼‰ */
        .background-image {
            width: 100%;                 /* ã‚³ãƒ³ãƒ†ãƒŠå¹…ã«åˆã‚ã›ã‚‹ */
            height: auto;                /* ç¸¦æ¨ªæ¯”ç¶­æŒ */
            display: block;              /* inlineè¦ç´ ã®éš™é–“é™¤å» */
        }

        /* ğŸ® å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”¨ã®ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
        .dynamic-spine-canvas {
            position: absolute;
            cursor: pointer;
            z-index: 10;
        }

        /* ğŸ¯ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ */
        .drop-zone {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 300px;
            height: 200px;
            border: 3px dashed #007bff;
            background: rgba(0, 123, 255, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 100;
        }

        .drop-zone.dragover {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.2);
        }

        .drop-zone-content {
            color: #007bff;
            font-weight: bold;
        }

        /* ğŸ¯ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .controls h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .controls button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .controls button:hover {
            background: #0056b3;
        }

        /* ğŸ“Š ãƒ­ã‚°ã‚¨ãƒªã‚¢ */
        .log-area {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            height: 150px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 8px;
            overflow-y: auto;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="scene-container">
        <!-- èƒŒæ™¯ç”»åƒï¼ˆåŸºæº–ã¨ãªã‚‹è¦ç´ ï¼‰ -->
        <img src="assets/images/ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼TOP.png" alt="èƒŒæ™¯" class="background-image">
        
        <!-- ğŸ¯ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
        <div class="drop-zone" id="drop-zone">
            <div class="drop-zone-content">
                <h4>ğŸ“¦ Spineãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—</h4>
                <p>.json, .atlas, .png ãƒ•ã‚¡ã‚¤ãƒ«<br>ã¾ãŸã¯ ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</p>
            </div>
        </div>
        
        <!-- ğŸ¯ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div class="controls">
            <h3>ğŸ® å‹•çš„Spineå®Ÿé¨“</h3>
            <button onclick="loadTestCharacter('purattokun')">ã·ã‚‰ã£ã¨ãã‚“è¿½åŠ </button>
            <button onclick="loadTestCharacter('nezumi')">ã­ãšã¿è¿½åŠ </button>
            <button onclick="clearAllCharacters()">å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤</button>
            <button onclick="toggleDebugMode()">ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºåˆ‡æ›¿</button>
        </div>
        
        <!-- ğŸ“Š ãƒ­ã‚°ã‚¨ãƒªã‚¢ -->
        <div class="log-area" id="log-area"></div>
    </div>

    <!-- Spine WebGL Runtime -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.24/dist/iife/spine-webgl.js"></script>
    
    <script>
        // ğŸ¯ å‹•çš„Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
        const dynamicSpineSystem = {
            characters: {},
            nextCharacterId: 1,
            debugMode: false
        };

        // ğŸ“ ãƒ­ã‚°æ©Ÿèƒ½
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('log-area');
            const colors = {
                info: '#00ff00',
                warn: '#ffff00', 
                error: '#ff0000',
                success: '#00ff88'
            };
            
            const logElement = document.createElement('div');
            logElement.style.color = colors[type] || colors.info;
            logElement.textContent = `[${timestamp}] ${message}`;
            
            logArea.appendChild(logElement);
            logArea.scrollTop = logArea.scrollHeight;
            
            console.log(`[å‹•çš„Spine] ${message}`);
        }

        // ğŸ® ãƒ†ã‚¹ãƒˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿
        async function loadTestCharacter(characterType) {
            const characterConfigs = {
                'purattokun': {
                    basePath: './assets/spine/characters/purattokun/',
                    atlasFile: 'purattokun.atlas',
                    jsonFile: 'purattokun.json',
                    scale: 0.55,
                    position: { x: 35, y: 75 },
                    size: { width: 25 }
                },
                'nezumi': {
                    basePath: './assets/spine/characters/nezumi/',
                    atlasFile: 'nezumi.atlas', 
                    jsonFile: 'nezumi.json',
                    scale: 0.45,
                    position: { x: 60, y: 45 },
                    size: { width: 20 }
                }
            };

            const config = characterConfigs[characterType];
            if (!config) {
                log(`ã‚¨ãƒ©ãƒ¼: æœªçŸ¥ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ—: ${characterType}`, 'error');
                return;
            }

            const characterId = `dynamic_${characterType}_${dynamicSpineSystem.nextCharacterId++}`;
            log(`${characterType} ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ é–‹å§‹ (ID: ${characterId})`);

            try {
                await createDynamicSpineCharacter(characterId, config);
                log(`âœ… ${characterType} ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ æˆåŠŸ`, 'success');
            } catch (error) {
                log(`âŒ ${characterType} ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // ğŸ”§ å‹•çš„Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½œæˆ
        async function createDynamicSpineCharacter(characterId, config) {
            log(`Canvasè¦ç´ ä½œæˆä¸­... (${characterId})`);

            // Canvasè¦ç´ ã‚’å‹•çš„ä½œæˆ
            const canvas = document.createElement('canvas');
            canvas.id = `canvas_${characterId}`;
            canvas.width = 300;
            canvas.height = 200;
            canvas.className = 'dynamic-spine-canvas';
            
            // ä½ç½®è¨­å®š
            canvas.style.left = `${config.position.x}%`;
            canvas.style.top = `${config.position.y}%`;
            canvas.style.width = `${config.size.width}%`;
            canvas.style.transform = 'translate(-50%, -50%)';
            canvas.style.aspectRatio = '3/2';

            // ã‚·ãƒ¼ãƒ³ã«è¿½åŠ 
            document.querySelector('.scene-container').appendChild(canvas);
            log(`Canvasè¦ç´ è¿½åŠ å®Œäº† (${canvas.id})`);

            // Spine WebGLèª­ã¿è¾¼ã¿å¾…ã¡
            await waitForSpine();
            log(`Spine WebGLåˆ©ç”¨å¯èƒ½ç¢ºèªæ¸ˆã¿`);

            // WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
            const gl = canvas.getContext("webgl", { alpha: true });
            if (!gl) {
                throw new Error("WebGLæœªå¯¾å¿œ");
            }
            log(`WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—æˆåŠŸ`);

            // ã‚¢ã‚»ãƒƒãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ä½œæˆ
            log(`ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿é–‹å§‹: ${config.basePath}`);
            const assetManager = new spine.AssetManager(gl, config.basePath);
            assetManager.loadTextureAtlas(config.atlasFile);
            assetManager.loadJson(config.jsonFile);

            await waitForAssets(assetManager);
            log(`ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å®Œäº† (atlas: ${config.atlasFile}, json: ${config.jsonFile})`);

            // Spineã‚¹ã‚±ãƒ«ãƒˆãƒ³æ§‹ç¯‰
            const atlas = assetManager.get(config.atlasFile);
            const atlasLoader = new spine.AtlasAttachmentLoader(atlas);
            const skeletonJson = new spine.SkeletonJson(atlasLoader);
            const skeletonData = skeletonJson.readSkeletonData(
                assetManager.get(config.jsonFile)
            );

            const skeleton = new spine.Skeleton(skeletonData);
            skeleton.x = 0;
            skeleton.y = -100; // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ã‚ˆã‚‹èª¿æ•´
            skeleton.scaleX = skeleton.scaleY = config.scale;

            log(`Spineã‚¹ã‚±ãƒ«ãƒˆãƒ³æ§‹ç¯‰å®Œäº† (scale: ${config.scale})`);

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
            const animationStateData = new spine.AnimationStateData(skeleton.data);
            const animationState = new spine.AnimationState(animationStateData);

            // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ä½œæˆ
            const renderer = new spine.SceneRenderer(canvas, gl);
            log(`ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ä½œæˆå®Œäº†`);

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
            const animations = skeleton.data.animations.map(anim => anim.name);
            log(`åˆ©ç”¨å¯èƒ½ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: ${animations.join(', ')}`);
            
            if (animations.includes('taiki')) {
                animationState.setAnimation(0, 'taiki', true);
                log(`ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š: taiki (loop)`);
            } else if (animations.length > 0) {
                animationState.setAnimation(0, animations[0], true);
                log(`ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š: ${animations[0]} (loop)`);
            }

            // æç”»ãƒ«ãƒ¼ãƒ—é–‹å§‹
            let lastTime = Date.now() / 1000;
            function render() {
                const now = Date.now() / 1000;
                const delta = now - lastTime;
                lastTime = now;

                animationState.update(delta);
                animationState.apply(skeleton);
                skeleton.updateWorldTransform();

                gl.clearColor(0, 0, 0, 0);
                gl.clear(gl.COLOR_BUFFER_BIT);
                gl.viewport(0, 0, canvas.width, canvas.height);

                renderer.begin();
                renderer.drawSkeleton(skeleton, true);
                renderer.end();

                requestAnimationFrame(render);
            }
            render();
            log(`æç”»ãƒ«ãƒ¼ãƒ—é–‹å§‹`);

            // ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­å®š
            canvas.addEventListener('click', () => {
                log(`${characterId} ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ`);
                if (animations.includes('yarare')) {
                    animationState.setAnimation(0, 'yarare', false);
                    animationState.addAnimation(0, 'taiki', true, 0);
                }
            });

            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ä¿å­˜
            dynamicSpineSystem.characters[characterId] = {
                canvas, skeleton, animationState, renderer, config, animations
            };

            log(`ğŸ¯ å‹•çš„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ å®Œäº†: ${characterId}`, 'success');
        }

        // ğŸ§¹ å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤
        function clearAllCharacters() {
            const characterIds = Object.keys(dynamicSpineSystem.characters);
            log(`å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤é–‹å§‹ (${characterIds.length}å€‹)`);

            characterIds.forEach(characterId => {
                const character = dynamicSpineSystem.characters[characterId];
                if (character && character.canvas) {
                    character.canvas.remove();
                }
                delete dynamicSpineSystem.characters[characterId];
            });

            log(`âœ… å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤å®Œäº†`, 'success');
        }

        // ğŸ” ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºåˆ‡æ›¿
        function toggleDebugMode() {
            dynamicSpineSystem.debugMode = !dynamicSpineSystem.debugMode;
            log(`ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ${dynamicSpineSystem.debugMode ? 'ON' : 'OFF'}`);
            
            Object.values(dynamicSpineSystem.characters).forEach(character => {
                if (character.canvas) {
                    character.canvas.style.border = dynamicSpineSystem.debugMode 
                        ? '2px solid red' : 'none';
                }
            });
        }

        // ğŸ“¦ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
        function setupDragDrop() {
            const dropZone = document.getElementById('drop-zone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                log('ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã¯å°†æ¥å®Ÿè£…äºˆå®š', 'warn');
            });
        }

        // ğŸ”§ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° (å…ƒã®index.htmlã‹ã‚‰ç§»æ¤)
        async function waitForSpine() {
            return new Promise((resolve, reject) => {
                let checkCount = 0;
                const maxChecks = 50;

                const checkSpine = () => {
                    checkCount++;
                    if (typeof spine !== "undefined") {
                        log("âœ… Spine WebGLèª­ã¿è¾¼ã¿å®Œäº†");
                        resolve();
                    } else if (checkCount >= maxChecks) {
                        reject(new Error("Spine WebGLèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ"));
                    } else {
                        setTimeout(checkSpine, 100);
                    }
                };

                checkSpine();
            });
        }

        async function waitForAssets(assetManager) {
            return new Promise((resolve, reject) => {
                let checkCount = 0;
                const maxChecks = 50;

                const checkAssets = () => {
                    checkCount++;
                    if (assetManager.isLoadingComplete()) {
                        log("âœ… ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å®Œäº†");
                        resolve();
                    } else if (checkCount >= maxChecks) {
                        reject(new Error("ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ"));
                    } else {
                        setTimeout(checkAssets, 100);
                    }
                };

                checkAssets();
            });
        }

        // ğŸš€ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        window.addEventListener("load", () => {
            log("ğŸ¯ å‹•çš„Spineå®Ÿé¨“ç’°å¢ƒ åˆæœŸåŒ–å®Œäº†", 'success');
            log("ğŸ“– ä½¿ç”¨æ–¹æ³•:", 'info');
            log("  1. ã€Œã·ã‚‰ã£ã¨ãã‚“è¿½åŠ ã€ã€Œã­ãšã¿è¿½åŠ ã€ãƒœã‚¿ãƒ³ã§å‹•çš„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ ", 'info');
            log("  2. ã€Œå…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤ã€ã§å…¨å‰Šé™¤", 'info');
            log("  3. ã€Œãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºåˆ‡æ›¿ã€ã§Canvaså¢ƒç•Œç·šè¡¨ç¤º", 'info');
            log("  4. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ", 'info');
            
            setupDragDrop();
        });

        // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        window.dynamicSpineDebug = {
            system: dynamicSpineSystem,
            log,
            loadTestCharacter,
            clearAllCharacters,
            toggleDebugMode
        };
    </script>
</body>
</html>