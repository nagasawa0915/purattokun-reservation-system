<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spine ã‚µãƒ³ãƒ—ãƒ«ï¼ˆæ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ å®Ÿæ¼”ç‰ˆï¼‰</title>
    <style>
        /* spine-positioning-system-explanation.htmlã‹ã‚‰æŠ½å‡º */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
            line-height: 1.8;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            background: white;
            padding: 30px 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #ff6b6b;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .section {
            background: white;
            margin-bottom: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .section-content {
            padding: 30px;
        }

        /* æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ å®Ÿæ¼”ã®CSS - ãã®ã¾ã¾æŠ½å‡º */
        .background-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            overflow: hidden;
        }

        .background-image {
            width: 100%;
            height: auto;
            display: block;
        }

        /* é…ç½®è¦ç´ ã®å…±é€šCSS */
        .positioned-element {
            position: absolute;
            z-index: 10;
            pointer-events: auto;
        }

        /* ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½è¦ç´  */
        .draggable-character {
            cursor: move;
            transition: transform 0.1s ease;
        }

        .draggable-character:hover {
            transform: scale(1.05);
        }

        /* ãƒ‡ãƒ¢ç”¨Canvasï¼ˆæ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ å®Ÿæ¼”ï¼‰ */
        #demo-purattokun-canvas {
            left: 35%;
            top: 75%;
            transform: translate(-50%, -50%);
            width: 160px;
            height: 160px;
            border: 3px solid red !important;
            background: rgba(255, 255, 0, 0.3) !important;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒ */
        #demo-fallback-image {
            left: 35%;
            top: 75%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            object-fit: contain;
            display: block;
            border: 3px solid green !important;
            background: rgba(0, 255, 0, 0.2) !important;
        }


        .demo-controls {
            text-align: center;
            margin-top: 20px;
        }

        .demo-button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .demo-button:hover {
            background: #ff5252;
        }

        #coordinateDisplay {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }

        .visual-demo {
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ® Spine ã‚µãƒ³ãƒ—ãƒ«ï¼ˆæ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ å®Ÿæ¼”ç‰ˆï¼‰</h1>
            <p>spine-positioning-system-explanation.htmlã®æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ å®Ÿæ¼”éƒ¨åˆ†ã‚’æŠ½å‡º</p>
        </div>

        <!-- æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ å®Ÿæ¼” - ãã®ã¾ã¾æŠ½å‡º -->
        <div class="section">
            <div class="section-header">
                ğŸ  æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ å®Ÿæ¼”ï¼ˆæœ¬ç•ªç’°å¢ƒã¨åŒã˜ï¼‰
            </div>
            <div class="section-content">
                <p>ä»¥ä¸‹ã¯ç¾åœ¨ã®index.htmlã¨<strong>å…¨ãåŒã˜ã‚·ã‚¹ãƒ†ãƒ </strong>ã§ã™ã€‚</p>

                <div class="visual-demo">
                    <!-- æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ å®Ÿæ¼”ã®HTMLæ§‹é€ ã‚’ãã®ã¾ã¾ -->
                    <div class="background-container">
                        <!-- èƒŒæ™¯ç”»åƒï¼ˆã‚µã‚¤ã‚ºã®åŸºæº–ï¼‰ -->
                        <img src="assets/images/ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼TOP.png" 
                             alt="ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼èƒŒæ™¯ç”»åƒ" 
                             class="background-image">
                        
                        <!-- é›²è¦ç´ ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¯¾è±¡ï¼‰ -->
                        <img src="assets/images/kumo1.png" alt="é›²1" class="animated-element cloud" style="position: absolute; opacity: 0.7; pointer-events: none; z-index: 5; left: 10%; top: 15%; width: 8%;">
                        <img src="assets/images/kumo2.png" alt="é›²2" class="animated-element cloud" style="position: absolute; opacity: 0.7; pointer-events: none; z-index: 5; left: 70%; top: 20%; width: 6%;">
                        
                        <!-- é…ç½®è¦ç´ ï¼ˆèƒŒæ™¯åŸºæº–ãƒ»ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ï¼‰ -->
                        <canvas id="demo-purattokun-canvas" class="positioned-element draggable-character" style="display: none;"></canvas>
                        
                        <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨é™çš„ç”»åƒï¼ˆWebGLæœªå¯¾å¿œæ™‚ã«ç¢ºå®Ÿã«è¡¨ç¤ºï¼‰ -->
                        <img src="assets/images/purattokunn.png" 
                             alt="ã·ã‚‰ã£ã¨ãã‚“" 
                             id="demo-fallback-image"
                             class="positioned-element draggable-character"
                             style="object-fit: contain; display: block; border: 2px dashed rgba(255, 107, 107, 0.3);"
                             onload="console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸ')"
                             onerror="console.error('âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—'); this.style.border='3px solid red'; this.alt='ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'">

                    </div>
                    <div class="demo-controls">
                        <button class="demo-button" onclick="forceFallback()">ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º</button>
                        <button class="demo-button" onclick="showCoordinates()">åº§æ¨™è¡¨ç¤º</button>
                        <button class="demo-button" onclick="debugCanvas()">Canvasè©³ç´°è¨ºæ–­</button>
                        <button class="demo-button" onclick="testCanvasDraw()">Canvasæç”»ãƒ†ã‚¹ãƒˆ</button>
                    </div>
                    <div id="coordinateDisplay" style="text-align: center; margin-top: 10px; font-weight: bold;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Spine WebGL Runtime -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.*/dist/iife/spine-webgl.js"></script>

    <script>
        // spine-positioning-system-explanation.htmlã‹ã‚‰æŠ½å‡ºã—ãŸé–¢æ•°ç¾¤

        let skeleton, animationState, spineLoaded = false;
        const coordinateDisplay = document.getElementById('coordinateDisplay');
        const screen = document.querySelector('.background-container');
        const character = document.getElementById('demo-fallback-image'); // fallbackè¦ç´ ã‚’åŸºæº–ã¨ã™ã‚‹

        // Spine WebGL ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
        async function waitForSpine() {
            return new Promise((resolve, reject) => {
                let checkCount = 0;
                const maxChecks = 100;
                
                const checkSpine = () => {
                    checkCount++;
                    if (typeof spine !== 'undefined') {
                        console.log('âœ… Spine WebGL èª­ã¿è¾¼ã¿å®Œäº†');
                        resolve();
                    } else if (checkCount >= maxChecks) {
                        reject(new Error('Spine WebGL èª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
                    } else {
                        setTimeout(checkSpine, 100);
                    }
                };
                
                checkSpine();
            });
        }

        // ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å®Œäº†ã¾ã§å¾…æ©Ÿ
        async function waitForAssets(assetManager) {
            return new Promise((resolve, reject) => {
                let checkCount = 0;
                const maxChecks = 100;
                
                const checkAssets = () => {
                    checkCount++;
                    if (assetManager.isLoadingComplete()) {
                        console.log('âœ… ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
                        resolve();
                    } else if (checkCount >= maxChecks) {
                        reject(new Error('ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
                    } else {
                        setTimeout(checkAssets, 100);
                    }
                };
                
                checkAssets();
            });
        }

        // Spine WebGL ãƒ‡ãƒ¢åˆæœŸåŒ–ï¼ˆãã®ã¾ã¾æŠ½å‡ºï¼‰
        async function initSpineDemo() {
            try {
                // Spine WebGL ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
                await waitForSpine();
                
                const canvas = document.getElementById('demo-purattokun-canvas');
                if (!canvas) {
                    throw new Error('Canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                // WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
                const gl = canvas.getContext('webgl', { alpha: true });
                if (!gl) {
                    throw new Error('WebGLãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // Canvasã‚µã‚¤ã‚ºè¨­å®š
                canvas.width = 160;
                canvas.height = 160;
                
                console.log('ğŸ“ Spineãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­...');
                
                // ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿ï¼ˆãƒ‘ã‚¹ä¿®æ­£ï¼‰
                const basePath = './assets/spine/characters/purattokun/';
                const assetManager = new spine.AssetManager(gl, basePath);
                
                console.log('ğŸ”„ Spineã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿é–‹å§‹:', basePath);
                
                // ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
                try {
                    assetManager.loadTextureAtlas('purattokun.atlas');
                    assetManager.loadJson('purattokun.json');
                    console.log('âœ… ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿è¦æ±‚é€ä¿¡å®Œäº†');
                } catch (loadError) {
                    console.error('âŒ ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿è¦æ±‚ã‚¨ãƒ©ãƒ¼:', loadError);
                    throw loadError;
                }
                
                // ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å®Œäº†ã¾ã§å¾…æ©Ÿ
                await waitForAssets(assetManager);
                
                console.log('ğŸ¬ ã·ã‚‰ã£ã¨ãã‚“æº–å‚™ä¸­...');
                
                // Spine setup
                const atlas = assetManager.get('purattokun.atlas');
                const atlasLoader = new spine.AtlasAttachmentLoader(atlas);
                const skeletonJson = new spine.SkeletonJson(atlasLoader);
                const skeletonData = skeletonJson.readSkeletonData(assetManager.get('purattokun.json'));
                
                skeleton = new spine.Skeleton(skeletonData);
                skeleton.x = 0;
                skeleton.y = 0;
                skeleton.scaleX = skeleton.scaleY = 0.5;
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
                const animationStateData = new spine.AnimationStateData(skeleton.data);
                animationState = new spine.AnimationState(animationStateData);
                
                // å¾…æ©Ÿã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
                if (skeleton.data.findAnimation('taiki')) {
                    animationState.setAnimation(0, 'taiki', true);
                } else if (skeleton.data.animations.length > 0) {
                    animationState.setAnimation(0, skeleton.data.animations[0].name, true);
                }
                
                // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼è¨­å®š
                const renderer = new spine.SceneRenderer(canvas, gl);
                
                // ã‚«ãƒ¡ãƒ©ã®åˆæœŸåŒ–çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
                console.log('Renderer camera check:', {
                    camera: renderer.camera,
                    projection: renderer.camera ? renderer.camera.projection : 'undefined',
                    methods: renderer.camera ? Object.getOwnPropertyNames(renderer.camera) : 'no camera'
                });
                
                // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—é–‹å§‹
                let lastTime = Date.now() / 1000;
                function render() {
                    const now = Date.now() / 1000;
                    const delta = now - lastTime;
                    lastTime = now;
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
                    animationState.update(delta);
                    animationState.apply(skeleton);
                    skeleton.updateWorldTransform();
                    
                    // æç”»
                    gl.clearColor(0, 0, 0, 0);
                    gl.clear(gl.COLOR_BUFFER_BIT);
                    gl.viewport(0, 0, canvas.width, canvas.height);
                    
                    renderer.begin();
                    renderer.drawSkeleton(skeleton, true);
                    renderer.end();
                    
                    requestAnimationFrame(render);
                }
                render();
                
                spineLoaded = true;
                console.log('âœ… ã·ã‚‰ã£ã¨ãã‚“æº–å‚™å®Œäº†ï¼');

                // æˆåŠŸæ™‚ã¯Canvasã‚’è¡¨ç¤ºã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’éè¡¨ç¤º
                canvas.style.display = 'block';
                document.getElementById('demo-fallback-image').style.display = 'none';
                
            } catch (error) {
                console.error('âŒ SpineåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒã‚’è¡¨ç¤º
                const canvas = document.getElementById('demo-purattokun-canvas');
                const fallback = document.getElementById('demo-fallback-image');
                if (canvas && fallback) {
                    canvas.style.display = 'none';
                    fallback.style.display = 'block';
                    console.log('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒã‚’ä½¿ç”¨ä¸­');
                }
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒã®å¼·åˆ¶è¡¨ç¤º
        function forceFallback() {
            const canvas = document.getElementById('demo-purattokun-canvas');
            const fallback = document.getElementById('demo-fallback-image');
            
            if (canvas && fallback) {
                canvas.style.display = 'none';
                fallback.style.display = 'block';
                fallback.style.border = '3px solid blue';
                coordinateDisplay.innerHTML = 'âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒè¡¨ç¤ºä¸­ï¼ˆé’æ ï¼‰';
                console.log('ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒã«å¼·åˆ¶åˆ‡ã‚Šæ›¿ãˆ');
            } else {
                coordinateDisplay.innerHTML = 'âŒ è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                console.error('Canvas ã¾ãŸã¯ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }

        function showCoordinates() {
            const rect = screen.getBoundingClientRect();
            const charRect = character.getBoundingClientRect();
            const centerX = ((charRect.left + charRect.width/2 - rect.left) / rect.width * 100).toFixed(1);
            const centerY = ((charRect.top + charRect.height/2 - rect.top) / rect.height * 100).toFixed(1);
            coordinateDisplay.innerHTML = `ç¾åœ¨ä½ç½®: ${centerX}%, ${centerY}%`;
        }

        function debugCanvas() {
            const canvas = document.getElementById('demo-purattokun-canvas');
            const fallback = document.getElementById('demo-fallback-image');
            
            if (!canvas) {
                coordinateDisplay.innerHTML = 'âŒ Canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            const gl = canvas.getContext('webgl');
            
            coordinateDisplay.innerHTML = `
                ğŸ“Š Canvasè©³ç´°è¨ºæ–­:<br>
                â€¢ å†…éƒ¨ã‚µã‚¤ã‚º: ${canvas.width} x ${canvas.height}<br>
                â€¢ è¡¨ç¤ºã‚µã‚¤ã‚º: ${rect.width} x ${rect.height}<br>
                â€¢ WebGL: ${gl ? 'âœ…å¯¾å¿œ' : 'âŒæœªå¯¾å¿œ'}<br>
                â€¢ ä½ç½®: (${Math.round(rect.left)}, ${Math.round(rect.top)})<br>
                â€¢ è¡¨ç¤ºçŠ¶æ…‹: ${canvas.style.display || 'block'}<br>
                â€¢ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çŠ¶æ…‹: ${fallback ? fallback.style.display || 'block' : 'ä¸æ˜'}
            `;
        }

        function testCanvasDraw() {
            const canvas = document.getElementById('demo-purattokun-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            if (ctx) {
                // Canvas 2Dæç”»ãƒ†ã‚¹ãƒˆ
                ctx.fillStyle = 'red';
                ctx.fillRect(10, 10, 60, 60);
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.fillText('TEST', 25, 45);
                coordinateDisplay.innerHTML = 'âœ… Canvas 2Dæç”»ãƒ†ã‚¹ãƒˆå®Œäº†ï¼ˆèµ¤ã„å››è§’ãŒè¦‹ãˆã¾ã™ã‹ï¼Ÿï¼‰';
                
                // Canvasè¡¨ç¤ºã‚’å¼·åˆ¶çš„ã«æœ‰åŠ¹åŒ–
                canvas.style.display = 'block';
                const fallback = document.getElementById('demo-fallback-image');
                if (fallback) fallback.style.display = 'none';
            } else {
                coordinateDisplay.innerHTML = 'âŒ Canvas 2Dæç”»ã«å¤±æ•—';
            }
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        window.addEventListener('load', () => {
            console.log('ğŸ“„ æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ å®Ÿæ¼”ã‚µãƒ³ãƒ—ãƒ«èª­ã¿è¾¼ã¿å®Œäº†');
            
            // åˆæœŸçŠ¶æ…‹ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒã‚’è¡¨ç¤º
            forceFallback();
            
            // SpineåˆæœŸåŒ–ã‚’è©¦è¡Œ
            setTimeout(() => {
                initSpineDemo().then(() => {
                    console.log('æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ å®Ÿæ¼”ã®Spineã‚‚åˆæœŸåŒ–å®Œäº†');
                }).catch((error) => {
                    console.log('æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ å®Ÿæ¼”ã®SpineåˆæœŸåŒ–å¤±æ•—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½¿ç”¨ï¼‰:', error);
                });
            }, 1000);
        });
    </script>
</body>
</html>