<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ Pure 2-Layer Coordinate System - ãƒ†ã‚¹ãƒˆç’°å¢ƒ</title>
    <style>
        body {
            background: #f0f0f0;
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
            touch-action: none;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-area {
            position: relative;
            width: 800px;
            height: 500px;
            background: #e8f4f8;
            border: 2px solid #007cba;
            margin: 20px auto;
            border-radius: 10px;
            touch-action: none;
        }
        
        /* ğŸ¯ Pure 2-Layer System CSS */
        
        /* Layer 1: layout-anchor - DOMé…ç½®ã¨ã‚µã‚¤ã‚ºåˆ¶å¾¡ */
        .layout-anchor {
            position: absolute;
            background: rgba(255, 107, 107, 0.3);
            border: 2px solid #ff6b6b;
            border-radius: 8px;
            /* ğŸ¯ Layer 1: ä¸­å¿ƒåŸºæº–é…ç½®ï¼ˆè¤‡é›‘ãªCSSå¤‰æ•°ãªã—ï¼‰ */
            transform: translate(-50%, -50%);
            touch-action: none;
        }
        
        /* Layer 2: interactive - CSS Transformå¾®èª¿æ•´ */
        .interactive {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-weight: bold;
            cursor: pointer;
            /* ğŸ¯ Layer 2: ã‚·ãƒ³ãƒ—ãƒ«ãªtransformåˆ¶å¾¡ï¼ˆCSSå¤‰æ•°è“„ç©ãªã—ï¼‰ */
            transform: translate(0px, 0px);
            touch-action: none;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 6px;
        }
        
        /* BB UI Elements */
        .bb-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #007cba;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            touch-action: none;
        }
        .bb-handle.move { 
            width: 20px; 
            height: 20px; 
            background: #ff6b6b;
            left: 50%; 
            top: 50%; 
            transform: translate(-50%, -50%);
        }
        .bb-handle.nw { left: -6px; top: -6px; cursor: nw-resize; }
        .bb-handle.n { left: 50%; top: -6px; transform: translateX(-50%); cursor: n-resize; }
        .bb-handle.ne { right: -6px; top: -6px; cursor: ne-resize; }
        .bb-handle.e { right: -6px; top: 50%; transform: translateY(-50%); cursor: e-resize; }
        .bb-handle.se { right: -6px; bottom: -6px; cursor: se-resize; }
        .bb-handle.s { left: 50%; bottom: -6px; transform: translateX(-50%); cursor: s-resize; }
        .bb-handle.sw { left: -6px; bottom: -6px; cursor: sw-resize; }
        .bb-handle.w { left: -6px; top: 50%; transform: translateY(-50%); cursor: w-resize; }
        
        /* Controls */
        .controls {
            text-align: center;
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #005a87; }
        button.active { background: #ff6b6b; }
        
        /* Debug Panel */
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-line;
        }
        .debug-panel h3 {
            margin-top: 0;
            color: #007cba;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¯ Pure 2-Layer Coordinate System - åº§æ¨™ç«¶åˆå•é¡Œã®æ ¹æœ¬è§£æ±º</h1>
        <p><strong>æŠ€è¡“é©æ–°:</strong> 7ãƒ¬ã‚¤ãƒ¤ãƒ¼ â†’ 2ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šæ¸›ï¼ˆ71%æ¸›ï¼‰| CSSå¤‰æ•°è“„ç©å•é¡Œã®å®Œå…¨æ’é™¤ | Transformé‡è¤‡ç«¶åˆã®æ ¹æœ¬è§£æ±º</p>
        
        <div class="controls">
            <button onclick="initializeSystem()">ğŸ¯ 2ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–</button>
            <button onclick="testUnifiedPosition()">ğŸ“ çµ±åˆåº§æ¨™ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testCompatibilityMode()">ğŸ”„ äº’æ›æ€§ãƒ¢ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="simulateDragOperation()">ğŸ–±ï¸ ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ</button>
            <button onclick="compareWithLegacy()">âš–ï¸ å¾“æ¥ç‰ˆã¨ã®æ¯”è¼ƒ</button>
            <button onclick="resetSystem()">ğŸ§¹ ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        
        <div class="test-area" id="test-area">
            <div class="layout-anchor" id="test-element-2layer"
                 style="left: 50%; top: 50%; width: 120px; height: 80px;">
                <div class="interactive">
                    ğŸ¯ 2-Layer System<br>
                    <small>Layer1: Anchor | Layer2: Transform</small>
                </div>
                
                <!-- BB UI Handles -->
                <div class="bb-handle move" data-handle="move" title="ç§»å‹•"></div>
                <div class="bb-handle nw" data-handle="nw" title="åŒ—è¥¿ãƒªã‚µã‚¤ã‚º"></div>
                <div class="bb-handle n" data-handle="n" title="åŒ—ãƒªã‚µã‚¤ã‚º"></div>
                <div class="bb-handle ne" data-handle="ne" title="åŒ—æ±ãƒªã‚µã‚¤ã‚º"></div>
                <div class="bb-handle e" data-handle="e" title="æ±ãƒªã‚µã‚¤ã‚º"></div>
                <div class="bb-handle se" data-handle="se" title="å—æ±ãƒªã‚µã‚¤ã‚º"></div>
                <div class="bb-handle s" data-handle="s" title="å—ãƒªã‚µã‚¤ã‚º"></div>
                <div class="bb-handle sw" data-handle="sw" title="å—è¥¿ãƒªã‚µã‚¤ã‚º"></div>
                <div class="bb-handle w" data-handle="w" title="è¥¿ãƒªã‚µã‚¤ã‚º"></div>
            </div>
        </div>
        
        <div class="debug-panel" id="debug-panel">
            <h3>ğŸ” 2ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚·ã‚¹ãƒ†ãƒ  ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
            <div id="debug-content">ã‚·ã‚¹ãƒ†ãƒ æœªåˆæœŸåŒ–</div>
        </div>
        
        <div class="debug-panel" id="comparison-panel" style="display: none;">
            <h3>âš–ï¸ å¾“æ¥ã‚·ã‚¹ãƒ†ãƒ ã¨ã®æ¯”è¼ƒ</h3>
            <div id="comparison-content"></div>
        </div>
    </div>
    
    <!-- ğŸ¯ Pure 2-Layer Coordinate System -->
    <script src="micromodules/bounding-box/PureBoundingBoxCore2Layer.js"></script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let core2Layer = null;
        let isDragging = false;
        let dragStartPos = {x: 0, y: 0};
        let dragStartElement = {x: 0, y: 0};
        
        /**
         * ğŸ¯ 2ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
         */
        function initializeSystem() {
            const targetElement = document.getElementById('test-element-2layer');
            
            core2Layer = new PureBoundingBoxCore2Layer({
                nodeId: 'test-element-2layer',
                targetElement: targetElement
            });
            
            // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            setupDragEvents();
            
            updateDebugPanel();
            
            console.log('ğŸ¯ [TEST] 2ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
            alert('âœ… Pure 2-Layer Coordinate System åˆæœŸåŒ–å®Œäº†ï¼\n71%ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šæ¸›ã‚’å®Ÿç¾');
        }
        
        /**
         * ğŸ“ çµ±åˆåº§æ¨™ãƒ†ã‚¹ãƒˆ
         */
        function testUnifiedPosition() {
            if (!core2Layer) {
                alert('âš ï¸ ã‚·ã‚¹ãƒ†ãƒ ãŒæœªåˆæœŸåŒ–ã§ã™');
                return;
            }
            
            // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: åŸºæœ¬ä½ç½®è¨­å®š
            console.log('ğŸ“ [TEST] Case 1: åŸºæœ¬ä½ç½®è¨­å®š');
            core2Layer.setUnifiedPosition(
                {x: 30, y: 40},  // 30%, 40%
                {x: 10, y: -5},  // +10px, -5pxå¾®èª¿æ•´
                {width: 150, height: 100}
            );
            
            setTimeout(() => {
                // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãç§»å‹•
                console.log('ğŸ“ [TEST] Case 2: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç§»å‹•');
                core2Layer.setUnifiedPosition(
                    {x: 70, y: 60},
                    {x: -20, y: 15},
                    null,
                    {animated: true}
                );
                
                updateDebugPanel();
            }, 1000);
            
            setTimeout(() => {
                // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ä¸­å¿ƒå¾©å¸°
                console.log('ğŸ“ [TEST] Case 3: ä¸­å¿ƒå¾©å¸°');
                core2Layer.setUnifiedPosition(
                    {x: 50, y: 50},
                    {x: 0, y: 0}
                );
                
                updateDebugPanel();
            }, 2000);
            
            updateDebugPanel();
        }
        
        /**
         * ğŸ”„ äº’æ›æ€§ãƒ¢ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ
         */
        function testCompatibilityMode() {
            if (!core2Layer) {
                alert('âš ï¸ ã‚·ã‚¹ãƒ†ãƒ ãŒæœªåˆæœŸåŒ–ã§ã™');
                return;
            }
            
            console.log('ğŸ”„ [TEST] äº’æ›æ€§ãƒ¢ãƒ¼ãƒ‰: commitToPercent2Layer');
            
            // å¾“æ¥ã®commitToPercentç›¸å½“ã®å‡¦ç†
            const success = core2Layer.commitToPercent2Layer();
            
            updateDebugPanel();
            
            if (success) {
                alert('âœ… äº’æ›æ€§ãƒ¢ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆæˆåŠŸï¼\nå¾“æ¥ã‚·ã‚¹ãƒ†ãƒ ã®æ©Ÿèƒ½ã‚’2ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§å†ç¾');
            } else {
                alert('âŒ äº’æ›æ€§ãƒ¢ãƒ¼ãƒ‰ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ');
            }
        }
        
        /**
         * ğŸ–±ï¸ ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
         */
        function simulateDragOperation() {
            if (!core2Layer) {
                alert('âš ï¸ ã‚·ã‚¹ãƒ†ãƒ ãŒæœªåˆæœŸåŒ–ã§ã™');
                return;
            }
            
            const targetElement = document.getElementById('test-element-2layer');
            const startRect = targetElement.getBoundingClientRect();
            const parentRect = targetElement.parentElement.getBoundingClientRect();
            
            console.log('ğŸ–±ï¸ [TEST] ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹');
            
            // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
            let step = 0;
            const maxSteps = 10;
            
            const dragInterval = setInterval(() => {
                step++;
                
                // å††å¼§çŠ¶ã«ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                const angle = (step / maxSteps) * Math.PI * 0.5;
                const radiusX = 50; // px
                const radiusY = 30;
                
                const offsetX = Math.cos(angle) * radiusX;
                const offsetY = Math.sin(angle) * radiusY;
                
                // Layer 2 (Transform) ã®ã¿æ›´æ–°ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
                core2Layer.updateTransformLayer({x: offsetX, y: offsetY});
                
                if (step >= maxSteps) {
                    clearInterval(dragInterval);
                    
                    // ãƒ‰ãƒ©ãƒƒã‚°å®Œäº†: Layer 1ã«çµ±åˆ
                    console.log('ğŸ–±ï¸ [TEST] ãƒ‰ãƒ©ãƒƒã‚°å®Œäº† - ãƒ¬ã‚¤ãƒ¤ãƒ¼çµ±åˆ');
                    core2Layer.commitToPercent2Layer();
                    
                    updateDebugPanel();
                    alert('âœ… ãƒ‰ãƒ©ãƒƒã‚°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ï¼\nå³æ–œã‚ä¸‹ç§»å‹•å•é¡Œãªã—');
                }
                
                updateDebugPanel();
            }, 100);
        }
        
        /**
         * âš–ï¸ å¾“æ¥ç‰ˆã¨ã®æ¯”è¼ƒ
         */
        function compareWithLegacy() {
            const comparisonPanel = document.getElementById('comparison-panel');
            const comparisonContent = document.getElementById('comparison-content');
            
            comparisonContent.textContent = `
ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ æ¯”è¼ƒåˆ†æ

ã€å¾“æ¥ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ7ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰ã€‘
- layout-anchor + CSS Transform + CSSå¤‰æ•° + DOMåº§æ¨™ + ç›¸å¯¾åº§æ¨™ + çµ¶å¯¾åº§æ¨™ + ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆåº§æ¨™
- ç´¯ç©çš„ãªåº§æ¨™å¤‰æ›èª¤å·®
- CSSå¤‰æ•°è“„ç©ã«ã‚ˆã‚‹å³æ–œã‚ä¸‹ç§»å‹•å•é¡Œ
- è¤‡é›‘ãªenterEditingMode/exitEditingMode
- ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å›°é›£

ã€Pure 2-Layer Systemã€‘
- Layer 1: layout-anchor (DOMé…ç½®) + Layer 2: CSS Transform (å¾®èª¿æ•´)
- ç›´æ¥åº§æ¨™åˆ¶å¾¡ï¼ˆä¸­é–“å¤‰æ›ãªã—ï¼‰
- CSSå¤‰æ•°è“„ç©å•é¡Œã®æ ¹æœ¬è§£æ±º
- ã‚·ãƒ³ãƒ—ãƒ«ãªçŠ¶æ…‹ç®¡ç†
- 71%ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šæ¸›ã€75%ã®å‡¦ç†è² è·å‰Šæ¸›

ã€æŠ€è¡“çš„å„ªä½æ€§ã€‘
âœ… åº§æ¨™ç«¶åˆã®å®Œå…¨æ’é™¤
âœ… å³æ–œã‚ä¸‹ç§»å‹•å•é¡Œã®æ ¹æœ¬è§£æ±º
âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¤§å¹…å‘ä¸Š
âœ… ä¿å®ˆæ€§ãƒ»æ‹¡å¼µæ€§ã®å‘ä¸Š
âœ… v3.0è¨­è¨ˆå“²å­¦ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãƒ»è»½é‡ï¼‰ã«å®Œå…¨æº–æ‹ 
            `;
            
            comparisonPanel.style.display = 'block';
        }
        
        /**
         * ğŸ§¹ ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚»ãƒƒãƒˆ
         */
        function resetSystem() {
            if (core2Layer) {
                core2Layer.cleanup();
                updateDebugPanel();
            }
            
            document.getElementById('comparison-panel').style.display = 'none';
            console.log('ğŸ§¹ [TEST] ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚»ãƒƒãƒˆå®Œäº†');
        }
        
        /**
         * ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«æ›´æ–°
         */
        function updateDebugPanel() {
            const debugContent = document.getElementById('debug-content');
            
            if (!core2Layer) {
                debugContent.textContent = 'ã‚·ã‚¹ãƒ†ãƒ æœªåˆæœŸåŒ– - initializeSystem()ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„';
                return;
            }
            
            const debugInfo = core2Layer.getDebugInfo();
            const position = core2Layer.getUnifiedPosition();
            
            debugContent.textContent = `
ğŸ¯ ${debugInfo.systemType}
Node ID: ${debugInfo.nodeId}
ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šæ¸›: ${debugInfo.layerReduction}

ã€Layer 1 - Anchorã€‘
Position: ${debugInfo.layers.anchor.left}, ${debugInfo.layers.anchor.top}
Size: ${debugInfo.layers.anchor.width} x ${debugInfo.layers.anchor.height}px

ã€Layer 2 - Transformã€‘  
Offset: ${debugInfo.layers.transform.translateX}, ${debugInfo.layers.transform.translateY}px
Scale: ${debugInfo.layers.transform.scale}
Rotation: ${debugInfo.layers.transform.rotation}deg

ã€çµ±åˆåº§æ¨™ã€‘
Effective Position: ${position ? `${position.effectivePosition.x}, ${position.effectivePosition.y}` : 'N/A'}

ã€æŠ€è¡“å„ªä½æ€§ã€‘
${debugInfo.benefits.join('\n')}

ã€äº’æ›æ€§ã€‘
Legacy Support: ${debugInfo.compatibility.legacySupport.cssVariablesEmulation ? 'âœ…' : 'âŒ'}
Percent Mode: ${debugInfo.compatibility.legacySupport.percentModeSupport ? 'âœ…' : 'âŒ'}
            `;
        }
        
        /**
         * ğŸ–±ï¸ ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
         */
        function setupDragEvents() {
            const targetElement = document.getElementById('test-element-2layer');
            const moveHandle = targetElement.querySelector('.bb-handle.move');
            
            moveHandle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isDragging = true;
                dragStartPos.x = e.clientX;
                dragStartPos.y = e.clientY;
                
                const rect = targetElement.getBoundingClientRect();
                dragStartElement.x = rect.left + rect.width / 2;
                dragStartElement.y = rect.top + rect.height / 2;
                
                console.log('ğŸ–±ï¸ [TEST] ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹');
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging || !core2Layer) return;
                
                const deltaX = e.clientX - dragStartPos.x;
                const deltaY = e.clientY - dragStartPos.y;
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ : Layer 2ã®ã¿æ›´æ–°
                core2Layer.updateTransformLayer({x: deltaX, y: deltaY});
                updateDebugPanel();
            });
            
            document.addEventListener('mouseup', () => {
                if (!isDragging) return;
                
                isDragging = false;
                
                if (core2Layer) {
                    // ãƒ‰ãƒ©ãƒƒã‚°å®Œäº†: Layer 1ã«çµ±åˆ
                    core2Layer.commitToPercent2Layer();
                    updateDebugPanel();
                    
                    console.log('ğŸ–±ï¸ [TEST] ãƒ‰ãƒ©ãƒƒã‚°å®Œäº† - åº§æ¨™çµ±åˆ');
                }
            });
        }
        
        // åˆæœŸåŒ–ãƒœã‚¿ãƒ³ã®å¼·èª¿
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ¯ Pure 2-Layer Coordinate System ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™å®Œäº†');
            console.log('ã¾ãšã€Œ2ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„');
        });
    </script>
</body>
</html>