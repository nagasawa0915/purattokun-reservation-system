<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€å°ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ— - Spine Editor v4.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #2d2d2d;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            display: grid;
            grid-template-areas: 
                "toolbar toolbar toolbar"
                "outliner preview properties"
                "outliner preview properties";
            grid-template-columns: 250px 1fr 250px;
            grid-template-rows: 50px 1fr;
            height: 100vh;
        }
        
        .toolbar {
            grid-area: toolbar;
            background: #1e1e1e;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 12px;
            border-bottom: 1px solid #404040;
        }
        
        .toolbar button {
            background: #404040;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .toolbar button:hover {
            background: #505050;
        }
        
        .toolbar button.primary {
            background: #007acc;
        }
        
        .toolbar button.primary:hover {
            background: #1a8cff;
        }
        
        .outliner {
            grid-area: outliner;
            background: #252525;
            border-right: 1px solid #404040;
            padding: 12px;
            overflow-y: auto;
        }
        
        .preview {
            grid-area: preview;
            background: #1a1a1a;
            position: relative;
            overflow: hidden;
        }
        
        .properties {
            grid-area: properties;
            background: #252525;
            border-left: 1px solid #404040;
            padding: 12px;
            overflow-y: auto;
        }
        
        .panel-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid #404040;
        }
        
        .file-tree {
            font-size: 12px;
        }
        
        .file-item {
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 3px;
            margin: 2px 0;
        }
        
        .file-item:hover {
            background: #404040;
        }
        
        .file-item.selected {
            background: #007acc;
        }
        
        .property-group {
            margin-bottom: 16px;
        }
        
        .property-label {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #cccccc;
        }
        
        .property-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .property-row label {
            font-size: 11px;
            width: 20px;
            color: #999999;
        }
        
        .property-input {
            background: #404040;
            border: 1px solid #606060;
            color: white;
            padding: 4px 6px;
            border-radius: 3px;
            font-size: 11px;
            width: 60px;
        }
        
        .property-input:focus {
            outline: none;
            border-color: #007acc;
        }
        
        .property-select {
            background: #404040;
            border: 1px solid #606060;
            color: white;
            padding: 4px 6px;
            border-radius: 3px;
            font-size: 11px;
            width: 100px;
        }
        
        .property-select:focus {
            outline: none;
            border-color: #007acc;
        }
        
        .layer-controls {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        
        .layer-btn {
            background: #404040;
            border: 1px solid #606060;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .layer-btn:hover {
            background: #505050;
        }
        
        .character-layers {
            font-size: 12px;
        }
        
        .layer-item {
            background: #353535;
            border: 1px solid #505050;
            border-radius: 4px;
            margin: 4px 0;
            padding: 8px;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .layer-item:hover {
            background: #404040;
        }
        
        .layer-item.selected {
            background: #007acc;
            border-color: #1a8cff;
        }
        
        .layer-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        .layer-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .layer-name {
            font-weight: 600;
            font-size: 12px;
        }
        
        .layer-animation {
            font-size: 10px;
            color: #aaaaaa;
            margin-top: 2px;
        }
        
        .layer-z {
            font-size: 10px;
            color: #888888;
            background: #2d2d2d;
            padding: 2px 6px;
            border-radius: 8px;
        }
        
        .preview-canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid #404040;
            background: #f0f0f0;
        }
        
        .status-bar {
            position: absolute;
            bottom: 8px;
            left: 8px;
            font-size: 11px;
            color: #888888;
        }
        
        .bounding-box {
            position: absolute;
            border: 2px solid #007acc;
            background: rgba(0, 122, 204, 0.1);
            cursor: move;
            z-index: 1000;
            display: none;
            box-shadow: 0 0 12px rgba(0, 122, 204, 0.3);
            transition: all 0.1s ease;
        }
        
        .bounding-box.active {
            display: block;
        }
        
        .bounding-box:hover {
            background: rgba(0, 122, 204, 0.15);
            box-shadow: 0 0 16px rgba(0, 122, 204, 0.4);
        }
        
        .bounding-box-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #007acc;
            border: 2px solid #ffffff;
            border-radius: 50%;
            z-index: 1001;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.1s ease;
        }
        
        .bounding-box-handle:hover {
            background: #1a8cff;
            transform: scale(1.2);
        }
        
        .handle-nw { top: -6px; left: -6px; cursor: nw-resize; }
        .handle-ne { top: -6px; right: -6px; cursor: ne-resize; }
        .handle-sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .handle-se { bottom: -6px; right: -6px; cursor: se-resize; }
        .handle-n { top: -6px; left: 50%; margin-left: -6px; cursor: n-resize; }
        .handle-s { bottom: -6px; left: 50%; margin-left: -6px; cursor: s-resize; }
        .handle-w { top: 50%; left: -6px; margin-top: -6px; cursor: w-resize; }
        .handle-e { top: 50%; right: -6px; margin-top: -6px; cursor: e-resize; }
        
        .drag-handle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #007acc;
            border: 1px solid #ffffff;
            border-radius: 50%;
            cursor: move;
            z-index: 1000;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #888888;
            font-size: 14px;
        }
        
        .error {
            color: #ff6b6b;
        }
        
        .success {
            color: #51cf66;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
        <div class="toolbar">
            <button id="btn-select-hp">HPãƒ•ã‚©ãƒ«ãƒ€é¸æŠ</button>
            <button id="btn-select-spine">Spineãƒ•ã‚©ãƒ«ãƒ€é¸æŠ</button>
            <button id="btn-quick-save" class="primary">âš¡ Quick Save (Ctrl+S)</button>
            <button id="btn-project-save">ğŸ’¾ Project Save</button>
            <button id="btn-export">ğŸ“¦ Export</button>
            <span id="project-status">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœªé¸æŠ</span>
        </div>
        
        <!-- ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒŠãƒ¼ -->
        <div class="outliner">
            <div class="panel-title">ğŸ­ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ & ãƒ¬ã‚¤ãƒ¤ãƒ¼</div>
            <div id="character-layers" class="character-layers">
                <div class="loading">Spineãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            </div>
        </div>
        
        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
        <div class="preview">
            <canvas id="preview-canvas" class="preview-canvas" width="640" height="360"></canvas>
            <div class="status-bar" id="status-bar">æº–å‚™å®Œäº†</div>
        </div>
        
        <!-- ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ‘ãƒãƒ« -->
        <div class="properties">
            <div class="panel-title">ğŸ›ï¸ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£</div>
            
            <div class="property-group">
                <div class="property-label">ä½ç½®</div>
                <div class="property-row">
                    <label>X</label>
                    <input type="number" class="property-input" id="prop-x" value="0" step="1">
                </div>
                <div class="property-row">
                    <label>Y</label>
                    <input type="number" class="property-input" id="prop-y" value="0" step="1">
                </div>
            </div>
            
            <div class="property-group">
                <div class="property-label">ã‚¹ã‚±ãƒ¼ãƒ«</div>
                <div class="property-row">
                    <label>X</label>
                    <input type="number" class="property-input" id="prop-scale-x" value="1.0" step="0.1">
                </div>
                <div class="property-row">
                    <label>Y</label>
                    <input type="number" class="property-input" id="prop-scale-y" value="1.0" step="0.1">
                </div>
            </div>
            
            <div class="property-group">
                <div class="property-label">å›è»¢</div>
                <div class="property-row">
                    <label>Â°</label>
                    <input type="number" class="property-input" id="prop-rotation" value="0" step="1">
                </div>
            </div>
            
            <div class="property-group">
                <div class="property-label">ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</div>
                <div class="property-row">
                    <select class="property-select" id="prop-animation">
                        <option value="idle">idle</option>
                        <option value="walk">walk</option>
                        <option value="run">run</option>
                    </select>
                </div>
            </div>
            
            <div class="property-group">
                <div class="property-label">Zé †</div>
                <div class="property-row">
                    <label>Z</label>
                    <input type="number" class="property-input" id="prop-z-index" value="0" step="1">
                </div>
                <div class="layer-controls">
                    <button class="layer-btn" id="btn-bring-forward">â†‘ å‰ã¸</button>
                    <button class="layer-btn" id="btn-send-backward">â†“ å¾Œã‚ã¸</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ”¹å–„ç‰ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†
        class ImprovedProjectManager {
            constructor() {
                this.project = null;
                this.selectedCharacter = null;
                this.characters = new Map();
                this.availableAnimations = new Map(); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã”ã¨ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§
                this.isDirty = false; // æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚‹ã‹
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.updateStatus('ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æº–å‚™å®Œäº†');
            }
            
            bindEvents() {
                // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
                document.getElementById('btn-select-hp').addEventListener('click', () => {
                    this.selectHPFolder();
                });
                
                document.getElementById('btn-select-spine').addEventListener('click', () => {
                    this.selectSpineFolder();
                });
                
                // 2æ®µéšä¿å­˜ã‚·ã‚¹ãƒ†ãƒ 
                document.getElementById('btn-quick-save').addEventListener('click', () => {
                    this.quickSave();
                });
                
                document.getElementById('btn-project-save').addEventListener('click', () => {
                    this.projectSave();
                });
                
                document.getElementById('btn-export').addEventListener('click', () => {
                    this.exportProject();
                });
                
                // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 's') {
                        e.preventDefault();
                        this.quickSave();
                    }
                });
                
                // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å¤‰æ›´
                ['prop-x', 'prop-y', 'prop-scale-x', 'prop-scale-y', 'prop-rotation', 'prop-z-index'].forEach(id => {
                    document.getElementById(id).addEventListener('input', (e) => {
                        this.updateCharacterProperty(id.replace('prop-', ''), e.target.value);
                        this.markDirty();
                    });
                });
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é¸æŠ
                document.getElementById('prop-animation').addEventListener('change', (e) => {
                    this.updateCharacterAnimation(e.target.value);
                    this.markDirty();
                });
                
                // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
                document.getElementById('btn-bring-forward').addEventListener('click', () => {
                    this.bringForward();
                });
                
                document.getElementById('btn-send-backward').addEventListener('click', () => {
                    this.sendBackward();
                });
                
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªãƒƒã‚¯
                document.getElementById('preview-canvas').addEventListener('click', (e) => {
                    this.handleCanvasClick(e);
                });
            }
            
            selectHPFolder() {
                // ãƒ¢ãƒƒã‚¯: HPãƒ•ã‚©ãƒ«ãƒ€é¸æŠ
                this.updateStatus('HPãƒ•ã‚©ãƒ«ãƒ€: D:/example/homepage');
                this.updateFileTree([
                    { name: 'index.html', type: 'file' },
                    { name: 'assets', type: 'folder' },
                    { name: 'css', type: 'folder' }
                ]);
            }
            
            selectSpineFolder() {
                // å®Ÿéš›ã®Spineãƒ•ã‚©ãƒ«ãƒ€é¸æŠæº–å‚™
                this.updateStatus('Spineãƒ•ã‚©ãƒ«ãƒ€é¸æŠæº–å‚™ä¸­...');
                this.initializeSpineSystem();
            }
            
            initializeSpineSystem() {
                // å®ŸSpineã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
                console.log('ğŸ¯ å®ŸSpineã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚­ãƒ£ãƒ³ãƒã‚¹ã®æº–å‚™
                this.setupSpineCanvas();
                
                // Spine WebGLãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿æº–å‚™
                this.loadSpineLibrary();
            }
            
            setupSpineCanvas() {
                const preview = document.querySelector('.preview');
                
                // æ—¢å­˜ã®canvasãŒã‚ã‚Œã°å‰Šé™¤
                const existingCanvas = preview.querySelector('canvas');
                if (existingCanvas) {
                    existingCanvas.remove();
                }
                
                // Spineç”¨WebGLã‚­ãƒ£ãƒ³ãƒã‚¹ä½œæˆ
                const canvas = document.createElement('canvas');
                canvas.id = 'spine-webgl-canvas';
                canvas.width = preview.clientWidth;
                canvas.height = preview.clientHeight;
                canvas.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: transparent;
                `;
                
                preview.appendChild(canvas);
                console.log('âœ… Spine WebGLã‚­ãƒ£ãƒ³ãƒã‚¹æº–å‚™å®Œäº†');
            }
            
            loadSpineLibrary() {
                // TODO: å®Ÿéš›ã®Spine WebGLãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿
                console.log('ğŸ“š Spine WebGLãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿æº–å‚™...');
                this.updateStatus('å®ŸSpineãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æº–å‚™å®Œäº†');
            }
            
            drawMockCharacter(character) {
                const canvas = document.getElementById('preview-canvas');
                const ctx = canvas.getContext('2d');
                
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªã‚¢
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ã‚°ãƒªãƒƒãƒ‰æç”»
                this.drawGrid(ctx, canvas);
                
                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä»£æ›¿è¡¨ç¤ºï¼ˆçŸ©å½¢ï¼‰
                const { x, y, scaleX, scaleY, rotation } = character.transform;
                
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(rotation * Math.PI / 180);
                ctx.scale(scaleX, scaleY);
                
                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä»£æ›¿çŸ©å½¢
                ctx.fillStyle = '#007acc40';
                ctx.strokeStyle = '#007acc';
                ctx.lineWidth = 2;
                ctx.fillRect(-30, -40, 60, 80);
                ctx.strokeRect(-30, -40, 60, 80);
                
                // åå‰è¡¨ç¤º
                ctx.fillStyle = '#007acc';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(character.name, 0, 50);
                
                ctx.restore();
                
                // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«
                this.drawDragHandle(x, y);
            }
            
            drawGrid(ctx, canvas) {
                ctx.strokeStyle = '#404040';
                ctx.lineWidth = 1;
                
                // ç¸¦ç·š
                for (let x = 0; x <= canvas.width; x += 20) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                
                // æ¨ªç·š
                for (let y = 0; y <= canvas.height; y += 20) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
                
                // ä¸­å¤®ç·š
                ctx.strokeStyle = '#007acc';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(canvas.width/2, 0);
                ctx.lineTo(canvas.width/2, canvas.height);
                ctx.moveTo(0, canvas.height/2);
                ctx.lineTo(canvas.width, canvas.height/2);
                ctx.stroke();
            }
            
            drawDragHandle(x, y) {
                const handle = document.createElement('div');
                handle.className = 'drag-handle';
                handle.style.left = `${x - 4}px`;
                handle.style.top = `${y - 4}px`;
                
                const preview = document.querySelector('.preview');
                // æ—¢å­˜ã®ãƒãƒ³ãƒ‰ãƒ«ã‚’å‰Šé™¤
                preview.querySelectorAll('.drag-handle').forEach(h => h.remove());
                preview.appendChild(handle);
                
                this.makeDraggable(handle);
            }
            
            makeDraggable(handle) {
                let isDragging = false;
                let startX, startY;
                
                handle.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    startX = e.clientX - handle.offsetLeft;
                    startY = e.clientY - handle.offsetTop;
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    const x = e.clientX - startX;
                    const y = e.clientY - startY;
                    
                    handle.style.left = `${x}px`;
                    handle.style.top = `${y}px`;
                    
                    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®æ›´æ–°
                    if (this.selectedCharacter) {
                        const character = this.characters.get(this.selectedCharacter);
                        character.transform.x = x + 4;
                        character.transform.y = y + 4;
                        this.updatePropertiesPanel(character);
                        this.drawMockCharacter(character);
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
            }
            
            selectCharacter(characterId) {
                this.selectedCharacter = characterId;
                const character = this.characters.get(characterId);
                if (character) {
                    this.updatePropertiesPanel(character);
                }
                
                // ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒŠãƒ¼ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.remove('selected');
                });
                const item = document.querySelector(`[data-id="${characterId}"]`);
                if (item) {
                    item.classList.add('selected');
                }
            }
            
            updatePropertiesPanel(character) {
                const { x, y, scaleX, scaleY, rotation } = character.transform;
                document.getElementById('prop-x').value = Math.round(x);
                document.getElementById('prop-y').value = Math.round(y);
                document.getElementById('prop-scale-x').value = scaleX;
                document.getElementById('prop-scale-y').value = scaleY;
                document.getElementById('prop-rotation').value = rotation;
                document.getElementById('prop-z-index').value = character.zIndex;
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é¸æŠã‚’æ›´æ–°
                const animationSelect = document.getElementById('prop-animation');
                const availableAnims = this.availableAnimations.get(character.name) || ['idle'];
                
                // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‹•çš„æ›´æ–°
                animationSelect.innerHTML = '';
                availableAnims.forEach(anim => {
                    const option = document.createElement('option');
                    option.value = anim;
                    option.textContent = anim;
                    option.selected = anim === character.animation;
                    animationSelect.appendChild(option);
                });
            }
            
            // å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å†æç”»
            redrawAllCharacters() {
                // Zé †ã§ã‚½ãƒ¼ãƒˆã—ã¦æç”»
                const sortedCharacters = Array.from(this.characters.values())
                    .sort((a, b) => a.zIndex - b.zIndex);
                
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªã‚¢
                const canvas = document.getElementById('preview-canvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ã‚°ãƒªãƒƒãƒ‰æç”»
                this.drawGrid(ctx, canvas);
                
                // å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é †ç•ªã«æç”»
                sortedCharacters.forEach(character => {
                    this.drawMockCharacter(character, false); // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãªã—
                });
                
                // é¸æŠä¸­ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’æœ€å¾Œã«æç”»
                if (this.selectedCharacter) {
                    const selected = this.characters.get(this.selectedCharacter);
                    if (selected) {
                        this.drawBoundingBox(selected);
                    }
                }
            }
            
            // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹æç”»
            drawBoundingBox(character) {
                const preview = document.querySelector('.preview');
                
                // æ—¢å­˜ã®ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
                preview.querySelectorAll('.bounding-box').forEach(box => box.remove());
                
                const { x, y, scaleX, scaleY, rotation } = character.transform;
                
                // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½œæˆ
                const boundingBox = document.createElement('div');
                boundingBox.className = 'bounding-box active';
                
                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å®Ÿéš›ã®ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦èª¿æ•´
                const width = 60 * Math.abs(scaleX);
                const height = 80 * Math.abs(scaleY);
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢å†…ã®ç›¸å¯¾åº§æ¨™ã§é…ç½®ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ä½ç½®ã¨å®Œå…¨åŒæœŸï¼‰
                const previewRect = preview.getBoundingClientRect();
                const centerX = previewRect.width / 2;
                const centerY = previewRect.height / 2;
                
                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ä¸­å¿ƒåº§æ¨™ã‹ã‚‰ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã®å·¦ä¸Šåº§æ¨™ã‚’è¨ˆç®—
                const boxLeft = centerX + x - width/2;
                const boxTop = centerY + y - height/2;
                
                boundingBox.style.left = `${boxLeft}px`;
                boundingBox.style.top = `${boxTop}px`;
                boundingBox.style.width = `${width}px`;
                boundingBox.style.height = `${height}px`;
                boundingBox.style.transform = `rotate(${rotation}deg)`;
                
                // 8ã¤ã®ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«è¿½åŠ 
                const handles = ['nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'];
                handles.forEach(position => {
                    const handle = document.createElement('div');
                    handle.className = `bounding-box-handle handle-${position}`;
                    boundingBox.appendChild(handle);
                });
                
                preview.appendChild(boundingBox);
                
                // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ
                this.makeBoundingBoxDraggable(boundingBox, character);
            }
            
            // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«ã™ã‚‹
            makeBoundingBoxDraggable(boundingBox, character) {
                let isDragging = false;
                let startMouseX, startMouseY;
                let startCharacterX, startCharacterY;
                
                boundingBox.addEventListener('mousedown', (e) => {
                    if (e.target === boundingBox) {
                        isDragging = true;
                        
                        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢åŸºæº–ã®åº§æ¨™ç³»ã§ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ä½ç½®ã‚’è¨˜éŒ²
                        const preview = document.querySelector('.preview');
                        const previewRect = preview.getBoundingClientRect();
                        
                        startMouseX = e.clientX - previewRect.left;
                        startMouseY = e.clientY - previewRect.top;
                        startCharacterX = character.transform.x;
                        startCharacterY = character.transform.y;
                        
                        e.preventDefault();
                        
                        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                        boundingBox.style.opacity = '0.8';
                    }
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢åŸºæº–ã®ç¾åœ¨ãƒã‚¦ã‚¹ä½ç½®
                    const preview = document.querySelector('.preview');
                    const previewRect = preview.getBoundingClientRect();
                    const currentMouseX = e.clientX - previewRect.left;
                    const currentMouseY = e.clientY - previewRect.top;
                    
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­å¿ƒåŸºæº–ã®åº§æ¨™ç³»ã§ã®ç§»å‹•é‡ã‚’è¨ˆç®—
                    const deltaX = currentMouseX - startMouseX;
                    const deltaY = currentMouseY - startMouseY;
                    
                    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åº§æ¨™ã‚’æ›´æ–°
                    character.transform.x = startCharacterX + deltaX;
                    character.transform.y = startCharacterY + deltaY;
                    
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
                    this.updatePropertiesPanel(character);
                    this.redrawAllCharacters();
                });
                
                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        
                        // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†ã®è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ
                        boundingBox.style.opacity = '1';
                        
                        this.markDirty();
                        console.log(`ğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ ${character.name} ã‚’ç§»å‹•: (${character.transform.x.toFixed(1)}, ${character.transform.y.toFixed(1)})`);
                    }
                });
            }
            
            updateCharacterProperty(property, value) {
                if (!this.selectedCharacter) return;
                
                const character = this.characters.get(this.selectedCharacter);
                if (!character) return;
                
                const numValue = parseFloat(value) || 0;
                
                switch (property) {
                    case 'x':
                        character.transform.x = numValue;
                        break;
                    case 'y':
                        character.transform.y = numValue;
                        break;
                    case 'scale-x':
                        character.transform.scaleX = numValue;
                        break;
                    case 'scale-y':
                        character.transform.scaleY = numValue;
                        break;
                    case 'rotation':
                        character.transform.rotation = numValue;
                        break;
                    case 'z-index':
                        character.zIndex = numValue;
                        break;
                }
                
                this.redrawAllCharacters();
            }
            
            updateCharacterLayers() {
                const layersContainer = document.getElementById('character-layers');
                
                // Zé †ã§ã‚½ãƒ¼ãƒˆï¼ˆé«˜ã„é †ï¼‰
                const sortedCharacters = Array.from(this.characters.values())
                    .sort((a, b) => b.zIndex - a.zIndex);
                
                let html = '';
                sortedCharacters.forEach(character => {
                    const isSelected = character.id === this.selectedCharacter;
                    html += `
                        <div class="layer-item ${isSelected ? 'selected' : ''}" 
                             data-id="${character.id}" 
                             draggable="true">
                            <div class="layer-info">
                                <div class="layer-name">ğŸ­ ${character.name}</div>
                                <div class="layer-animation">ğŸ¬ ${character.animation || 'idle'}</div>
                            </div>
                            <div class="layer-z">Z: ${character.zIndex}</div>
                        </div>
                    `;
                });
                
                layersContainer.innerHTML = html;
                
                // ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
                layersContainer.querySelectorAll('.layer-item').forEach(item => {
                    // ã‚¯ãƒªãƒƒã‚¯é¸æŠ
                    item.addEventListener('click', () => {
                        this.selectCharacter(item.dataset.id);
                    });
                    
                    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆZé †å¤‰æ›´ï¼‰
                    item.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', item.dataset.id);
                        item.classList.add('dragging');
                    });
                    
                    item.addEventListener('dragend', () => {
                        item.classList.remove('dragging');
                    });
                    
                    item.addEventListener('dragover', (e) => {
                        e.preventDefault();
                    });
                    
                    item.addEventListener('drop', (e) => {
                        e.preventDefault();
                        const draggedId = e.dataTransfer.getData('text/plain');
                        const targetId = item.dataset.id;
                        this.reorderLayers(draggedId, targetId);
                    });
                });
            }
            
            handleCanvasClick(e) {
                const canvas = e.target;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                console.log(`Canvas clicked at: (${Math.round(x)}, ${Math.round(y)})`);
            }
            
            // æœªä¿å­˜çŠ¶æ…‹ç®¡ç†
            markDirty() {
                this.isDirty = true;
                this.updateStatus('æœªä¿å­˜ã®å¤‰æ›´ã‚ã‚Š âš ï¸', 'error');
            }
            
            // Quick Saveï¼ˆåº§æ¨™ã®ã¿ï¼‰
            quickSave() {
                const characterData = Array.from(this.characters.values()).map(char => ({
                    id: char.id,
                    transform: { ...char.transform },
                    zIndex: char.zIndex,
                    animation: char.animation
                }));
                
                console.log('âš¡ Quick Saveå®Ÿè¡Œ:', characterData);
                this.updateStatus('é…ç½®ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº† âš¡', 'success');
                this.isDirty = false;
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«é…ç½®ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                localStorage.setItem('spine-editor-v4-placement', JSON.stringify(characterData));
            }
            
            // Project Saveï¼ˆå…¨ä½“ä¿å­˜ï¼‰
            projectSave() {
                const projectData = {
                    version: 1,
                    project: {
                        name: 'Spine Project v4',
                        created: new Date().toISOString(),
                        modified: new Date().toISOString()
                    },
                    characters: Array.from(this.characters.values()),
                    availableAnimations: Object.fromEntries(this.availableAnimations),
                    meta: { isDirty: this.isDirty }
                };
                
                console.log('ğŸ’¾ Project Saveå®Ÿè¡Œ:', projectData);
                this.updateStatus('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ä¿å­˜å®Œäº† ğŸ’¾', 'success');
                this.isDirty = false;
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«å…¨ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                localStorage.setItem('spine-editor-v4-project', JSON.stringify(projectData));
            }
            
            exportProject() {
                console.log('ğŸ“¦ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–‹å§‹...');
                this.updateStatus('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå‡¦ç†ä¸­...');
                
                setTimeout(() => {
                    this.updateStatus('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº† â†’ dist/index.html', 'success');
                }, 1000);
            }
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ›´
            updateCharacterAnimation(animationName) {
                if (!this.selectedCharacter) return;
                
                const character = this.characters.get(this.selectedCharacter);
                if (character) {
                    character.animation = animationName;
                    console.log(`ğŸ¬ ${character.name} ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ›´: ${animationName}`);
                    this.updateCharacterLayers(); // ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
                }
            }
            
            // ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åº: å‰ã¸
            bringForward() {
                if (!this.selectedCharacter) return;
                
                const character = this.characters.get(this.selectedCharacter);
                if (character) {
                    character.zIndex++;
                    this.updatePropertiesPanel(character);
                    this.updateCharacterLayers();
                    this.redrawAllCharacters();
                    this.markDirty();
                }
            }
            
            // ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åº: å¾Œã‚ã¸
            sendBackward() {
                if (!this.selectedCharacter) return;
                
                const character = this.characters.get(this.selectedCharacter);
                if (character) {
                    character.zIndex--;
                    this.updatePropertiesPanel(character);
                    this.updateCharacterLayers();
                    this.redrawAllCharacters();
                    this.markDirty();
                }
            }
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã«ã‚ˆã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºå¤‰æ›´
            reorderLayers(draggedId, targetId) {
                if (draggedId === targetId) return;
                
                const draggedChar = this.characters.get(draggedId);
                const targetChar = this.characters.get(targetId);
                
                if (draggedChar && targetChar) {
                    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®Zå€¤ã‚’å–å¾—ã—ã€ãƒ‰ãƒ©ãƒƒã‚°ã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚’ãã®ä¸Šã«é…ç½®
                    draggedChar.zIndex = targetChar.zIndex + 1;
                    
                    console.log(`ğŸ”„ ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºå¤‰æ›´: ${draggedChar.name} â†’ Z:${draggedChar.zIndex}`);
                    
                    this.updateCharacterLayers();
                    this.redrawAllCharacters();
                    this.markDirty();
                    
                    // ãƒ‰ãƒ©ãƒƒã‚°ã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠ
                    this.selectCharacter(draggedId);
                }
            }
            
            updateStatus(message, type = '') {
                const status = document.getElementById('project-status');
                status.textContent = message;
                status.className = type;
                
                const statusBar = document.getElementById('status-bar');
                statusBar.textContent = message;
            }
        }
        
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ Spine Editor v4.0 - æ”¹å–„ç‰ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—é–‹å§‹');
            new ImprovedProjectManager();
        });
    </script>
</body>
</html>