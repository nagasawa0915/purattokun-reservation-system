<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊúÄÂ∞è„Éó„É≠„Éà„Çø„Ç§„Éó - Spine Editor v4.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #2d2d2d;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            display: grid;
            grid-template-areas: 
                "toolbar toolbar toolbar"
                "outliner preview properties"
                "outliner preview properties";
            grid-template-columns: 250px 1fr 250px;
            grid-template-rows: 50px 1fr;
            height: 100vh;
        }
        
        .toolbar {
            grid-area: toolbar;
            background: #1e1e1e;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 12px;
            border-bottom: 1px solid #404040;
        }
        
        .toolbar button {
            background: #404040;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .toolbar button:hover {
            background: #505050;
        }
        
        .toolbar button.primary {
            background: #007acc;
        }
        
        .toolbar button.primary:hover {
            background: #1a8cff;
        }
        
        .outliner {
            grid-area: outliner;
            background: #252525;
            border-right: 1px solid #404040;
            padding: 12px;
            overflow-y: auto;
        }
        
        .preview {
            grid-area: preview;
            background: #1a1a1a;
            position: relative;
            overflow: hidden;
        }
        
        .properties {
            grid-area: properties;
            background: #252525;
            border-left: 1px solid #404040;
            padding: 12px;
            overflow-y: auto;
        }
        
        .panel-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid #404040;
        }
        
        .file-tree {
            font-size: 12px;
        }
        
        .file-item {
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 3px;
            margin: 2px 0;
        }
        
        .file-item:hover {
            background: #404040;
        }
        
        .file-item.selected {
            background: #007acc;
        }
        
        .property-group {
            margin-bottom: 16px;
        }
        
        .property-label {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #cccccc;
        }
        
        .property-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .property-row label {
            font-size: 11px;
            width: 20px;
            color: #999999;
        }
        
        .property-input {
            background: #404040;
            border: 1px solid #606060;
            color: white;
            padding: 4px 6px;
            border-radius: 3px;
            font-size: 11px;
            width: 60px;
        }
        
        .property-input:focus {
            outline: none;
            border-color: #007acc;
        }
        
        .property-select {
            background: #404040;
            border: 1px solid #606060;
            color: white;
            padding: 4px 6px;
            border-radius: 3px;
            font-size: 11px;
            width: 100px;
        }
        
        .property-select:focus {
            outline: none;
            border-color: #007acc;
        }
        
        .layer-controls {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        
        .layer-btn {
            background: #404040;
            border: 1px solid #606060;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .layer-btn:hover {
            background: #505050;
        }
        
        .character-layers {
            font-size: 12px;
        }
        
        .layer-item {
            background: #353535;
            border: 1px solid #505050;
            border-radius: 4px;
            margin: 4px 0;
            padding: 8px;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .layer-item:hover {
            background: #404040;
        }
        
        .layer-item.selected {
            background: #007acc;
            border-color: #1a8cff;
        }
        
        .layer-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        .layer-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .layer-name {
            font-weight: 600;
            font-size: 12px;
        }
        
        .layer-animation {
            font-size: 10px;
            color: #aaaaaa;
            margin-top: 2px;
        }
        
        .layer-z {
            font-size: 10px;
            color: #888888;
            background: #2d2d2d;
            padding: 2px 6px;
            border-radius: 8px;
        }
        
        .preview-canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid #404040;
            background: #f0f0f0;
        }
        
        .status-bar {
            position: absolute;
            bottom: 8px;
            left: 8px;
            font-size: 11px;
            color: #888888;
        }
        
        .bounding-box {
            position: absolute;
            border: 2px solid #007acc;
            background: rgba(0, 122, 204, 0.1);
            cursor: move;
            z-index: 1000;
            display: none;
            box-shadow: 0 0 12px rgba(0, 122, 204, 0.3);
            transition: all 0.1s ease;
        }
        
        .bounding-box.active {
            display: block;
        }
        
        .bounding-box:hover {
            background: rgba(0, 122, 204, 0.15);
            box-shadow: 0 0 16px rgba(0, 122, 204, 0.4);
        }
        
        .bounding-box-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #007acc;
            border: 2px solid #ffffff;
            border-radius: 50%;
            z-index: 1001;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.1s ease;
        }
        
        .bounding-box-handle:hover {
            background: #1a8cff;
            transform: scale(1.2);
        }
        
        .handle-nw { top: -6px; left: -6px; cursor: nw-resize; }
        .handle-ne { top: -6px; right: -6px; cursor: ne-resize; }
        .handle-sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .handle-se { bottom: -6px; right: -6px; cursor: se-resize; }
        .handle-n { top: -6px; left: 50%; margin-left: -6px; cursor: n-resize; }
        .handle-s { bottom: -6px; left: 50%; margin-left: -6px; cursor: s-resize; }
        .handle-w { top: 50%; left: -6px; margin-top: -6px; cursor: w-resize; }
        .handle-e { top: 50%; right: -6px; margin-top: -6px; cursor: e-resize; }
        
        .drag-handle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #007acc;
            border: 1px solid #ffffff;
            border-radius: 50%;
            cursor: move;
            z-index: 1000;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #888888;
            font-size: 14px;
        }
        
        .error {
            color: #ff6b6b;
        }
        
        .success {
            color: #51cf66;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- „ÉÑ„Éº„É´„Éê„Éº -->
        <div class="toolbar">
            <button id="btn-select-hp">HP„Éï„Ç©„É´„ÉÄÈÅ∏Êäû</button>
            <button id="btn-select-spine">Spine„Éï„Ç©„É´„ÉÄÈÅ∏Êäû</button>
            <button id="btn-quick-save" class="primary">‚ö° Quick Save (Ctrl+S)</button>
            <button id="btn-project-save">üíæ Project Save</button>
            <button id="btn-export">üì¶ Export</button>
            <span id="project-status">„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊú™ÈÅ∏Êäû</span>
        </div>
        
        <!-- „Ç¢„Ç¶„Éà„É©„Ç§„Éä„Éº -->
        <div class="outliner">
            <div class="panel-title">üé≠ „Ç≠„É£„É©„ÇØ„Çø„Éº & „É¨„Ç§„É§„Éº</div>
            <div id="character-layers" class="character-layers">
                <div class="loading">Spine„Éï„Ç©„É´„ÉÄ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
            </div>
        </div>
        
        <!-- „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢ -->
        <div class="preview">
            <canvas id="preview-canvas" class="preview-canvas" width="640" height="360"></canvas>
            <div class="status-bar" id="status-bar">Ê∫ñÂÇôÂÆå‰∫Ü</div>
        </div>
        
        <!-- „Éó„É≠„Éë„ÉÜ„Ç£„Éë„Éç„É´ -->
        <div class="properties">
            <div class="panel-title">üéõÔ∏è „Éó„É≠„Éë„ÉÜ„Ç£</div>
            
            <div class="property-group">
                <div class="property-label">‰ΩçÁΩÆ</div>
                <div class="property-row">
                    <label>X</label>
                    <input type="number" class="property-input" id="prop-x" value="0" step="1">
                </div>
                <div class="property-row">
                    <label>Y</label>
                    <input type="number" class="property-input" id="prop-y" value="0" step="1">
                </div>
            </div>
            
            <div class="property-group">
                <div class="property-label">„Çπ„Ç±„Éº„É´</div>
                <div class="property-row">
                    <label>X</label>
                    <input type="number" class="property-input" id="prop-scale-x" value="1.0" step="0.1">
                </div>
                <div class="property-row">
                    <label>Y</label>
                    <input type="number" class="property-input" id="prop-scale-y" value="1.0" step="0.1">
                </div>
            </div>
            
            <div class="property-group">
                <div class="property-label">ÂõûËª¢</div>
                <div class="property-row">
                    <label>¬∞</label>
                    <input type="number" class="property-input" id="prop-rotation" value="0" step="1">
                </div>
            </div>
            
            <div class="property-group">
                <div class="property-label">„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥</div>
                <div class="property-row">
                    <select class="property-select" id="prop-animation">
                        <option value="idle">idle</option>
                        <option value="walk">walk</option>
                        <option value="run">run</option>
                    </select>
                </div>
            </div>
            
            <div class="property-group">
                <div class="property-label">ZÈ†Ü</div>
                <div class="property-row">
                    <label>Z</label>
                    <input type="number" class="property-input" id="prop-z-index" value="0" step="1">
                </div>
                <div class="layer-controls">
                    <button class="layer-btn" id="btn-bring-forward">‚Üë Ââç„Å∏</button>
                    <button class="layer-btn" id="btn-send-backward">‚Üì Âæå„Çç„Å∏</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÊîπÂñÑÁâà„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜ
        class ImprovedProjectManager {
            constructor() {
                this.project = null;
                this.selectedCharacter = null;
                this.characters = new Map();
                this.availableAnimations = new Map(); // „Ç≠„É£„É©„ÇØ„Çø„Éº„Åî„Å®„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰∏ÄË¶ß
                this.isDirty = false; // Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Åå„ÅÇ„Çã„Åã
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.updateStatus('„Éó„É≠„Éà„Çø„Ç§„ÉóÊ∫ñÂÇôÂÆå‰∫Ü');
            }
            
            bindEvents() {
                // „Éï„Ç©„É´„ÉÄÈÅ∏ÊäûÔºà„É¢„ÉÉ„ÇØÔºâ
                document.getElementById('btn-select-hp').addEventListener('click', () => {
                    this.selectHPFolder();
                });
                
                document.getElementById('btn-select-spine').addEventListener('click', () => {
                    this.selectSpineFolder();
                });
                
                // 2ÊÆµÈöé‰øùÂ≠ò„Ç∑„Çπ„ÉÜ„É†
                document.getElementById('btn-quick-save').addEventListener('click', () => {
                    this.quickSave();
                });
                
                document.getElementById('btn-project-save').addEventListener('click', () => {
                    this.projectSave();
                });
                
                document.getElementById('btn-export').addEventListener('click', () => {
                    this.exportProject();
                });
                
                // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 's') {
                        e.preventDefault();
                        this.quickSave();
                    }
                });
                
                // „Éó„É≠„Éë„ÉÜ„Ç£Â§âÊõ¥
                ['prop-x', 'prop-y', 'prop-scale-x', 'prop-scale-y', 'prop-rotation', 'prop-z-index'].forEach(id => {
                    document.getElementById(id).addEventListener('input', (e) => {
                        this.updateCharacterProperty(id.replace('prop-', ''), e.target.value);
                        this.markDirty();
                    });
                });
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈÅ∏Êäû
                document.getElementById('prop-animation').addEventListener('change', (e) => {
                    this.updateCharacterAnimation(e.target.value);
                    this.markDirty();
                });
                
                // „É¨„Ç§„É§„Éº„Ç≥„É≥„Éà„É≠„Éº„É´
                document.getElementById('btn-bring-forward').addEventListener('click', () => {
                    this.bringForward();
                });
                
                document.getElementById('btn-send-backward').addEventListener('click', () => {
                    this.sendBackward();
                });
                
                // „Ç≠„É£„É≥„Éê„Çπ„ÇØ„É™„ÉÉ„ÇØ
                document.getElementById('preview-canvas').addEventListener('click', (e) => {
                    this.handleCanvasClick(e);
                });
            }
            
            selectHPFolder() {
                // „É¢„ÉÉ„ÇØ: HP„Éï„Ç©„É´„ÉÄÈÅ∏Êäû
                this.updateStatus('HP„Éï„Ç©„É´„ÉÄ: D:/example/homepage');
                this.updateFileTree([
                    { name: 'index.html', type: 'file' },
                    { name: 'assets', type: 'folder' },
                    { name: 'css', type: 'folder' }
                ]);
            }
            
            selectSpineFolder() {
                // ÂÆüÈöõ„ÅÆSpine„Éï„Ç©„É´„ÉÄÈÅ∏ÊäûÊ∫ñÂÇô
                this.updateStatus('Spine„Éï„Ç©„É´„ÉÄÈÅ∏ÊäûÊ∫ñÂÇô‰∏≠...');
                this.initializeSpineSystem();
            }
            
            initializeSpineSystem() {
                // ÂÆüSpine„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
                console.log('üéØ ÂÆüSpine„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÈñãÂßã');
                
                // „Éó„É¨„Éì„É•„Éº„Ç≠„É£„É≥„Éê„Çπ„ÅÆÊ∫ñÂÇô
                this.setupSpineCanvas();
                
                // Spine WebGL„É©„Ç§„Éñ„É©„É™„ÅÆË™≠„ÅøËæº„ÅøÊ∫ñÂÇô
                this.loadSpineLibrary();
            }
            
            setupSpineCanvas() {
                const preview = document.querySelector('.preview');
                
                // Êó¢Â≠ò„ÅÆcanvas„Åå„ÅÇ„Çå„Å∞ÂâäÈô§
                const existingCanvas = preview.querySelector('canvas');
                if (existingCanvas) {
                    existingCanvas.remove();
                }
                
                // SpineÁî®WebGL„Ç≠„É£„É≥„Éê„Çπ‰ΩúÊàê
                const canvas = document.createElement('canvas');
                canvas.id = 'spine-webgl-canvas';
                canvas.width = preview.clientWidth;
                canvas.height = preview.clientHeight;
                canvas.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: transparent;
                `;
                
                preview.appendChild(canvas);
                console.log('‚úÖ Spine WebGL„Ç≠„É£„É≥„Éê„ÇπÊ∫ñÂÇôÂÆå‰∫Ü');
            }
            
            loadSpineLibrary() {
                // TODO: ÂÆüÈöõ„ÅÆSpine WebGL„É©„Ç§„Éñ„É©„É™Ë™≠„ÅøËæº„Åø
                console.log('üìö Spine WebGL„É©„Ç§„Éñ„É©„É™Ë™≠„ÅøËæº„ÅøÊ∫ñÂÇô...');
                this.updateStatus('ÂÆüSpine„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÊ∫ñÂÇôÂÆå‰∫Ü');
            }
            
            drawMockCharacter(character) {
                const canvas = document.getElementById('preview-canvas');
                const ctx = canvas.getContext('2d');
                
                // „Ç≠„É£„É≥„Éê„Çπ„ÇØ„É™„Ç¢
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // „Ç∞„É™„ÉÉ„ÉâÊèèÁîª
                this.drawGrid(ctx, canvas);
                
                // „Ç≠„É£„É©„ÇØ„Çø„Éº‰ª£ÊõøË°®Á§∫ÔºàÁü©ÂΩ¢Ôºâ
                const { x, y, scaleX, scaleY, rotation } = character.transform;
                
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(rotation * Math.PI / 180);
                ctx.scale(scaleX, scaleY);
                
                // „Ç≠„É£„É©„ÇØ„Çø„Éº‰ª£ÊõøÁü©ÂΩ¢
                ctx.fillStyle = '#007acc40';
                ctx.strokeStyle = '#007acc';
                ctx.lineWidth = 2;
                ctx.fillRect(-30, -40, 60, 80);
                ctx.strokeRect(-30, -40, 60, 80);
                
                // ÂêçÂâçË°®Á§∫
                ctx.fillStyle = '#007acc';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(character.name, 0, 50);
                
                ctx.restore();
                
                // „Éâ„É©„ÉÉ„Ç∞„Éè„É≥„Éâ„É´
                this.drawDragHandle(x, y);
            }
            
            drawGrid(ctx, canvas) {
                ctx.strokeStyle = '#404040';
                ctx.lineWidth = 1;
                
                // Á∏¶Á∑ö
                for (let x = 0; x <= canvas.width; x += 20) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                
                // Ê®™Á∑ö
                for (let y = 0; y <= canvas.height; y += 20) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
                
                // ‰∏≠Â§ÆÁ∑ö
                ctx.strokeStyle = '#007acc';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(canvas.width/2, 0);
                ctx.lineTo(canvas.width/2, canvas.height);
                ctx.moveTo(0, canvas.height/2);
                ctx.lineTo(canvas.width, canvas.height/2);
                ctx.stroke();
            }
            
            drawDragHandle(x, y) {
                const handle = document.createElement('div');
                handle.className = 'drag-handle';
                handle.style.left = `${x - 4}px`;
                handle.style.top = `${y - 4}px`;
                
                const preview = document.querySelector('.preview');
                // Êó¢Â≠ò„ÅÆ„Éè„É≥„Éâ„É´„ÇíÂâäÈô§
                preview.querySelectorAll('.drag-handle').forEach(h => h.remove());
                preview.appendChild(handle);
                
                this.makeDraggable(handle);
            }
            
            makeDraggable(handle) {
                let isDragging = false;
                let startX, startY;
                
                handle.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    startX = e.clientX - handle.offsetLeft;
                    startY = e.clientY - handle.offsetTop;
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    const x = e.clientX - startX;
                    const y = e.clientY - startY;
                    
                    handle.style.left = `${x}px`;
                    handle.style.top = `${y}px`;
                    
                    // „Ç≠„É£„É©„ÇØ„Çø„Éº‰ΩçÁΩÆÊõ¥Êñ∞
                    if (this.selectedCharacter) {
                        const character = this.characters.get(this.selectedCharacter);
                        character.transform.x = x + 4;
                        character.transform.y = y + 4;
                        this.updatePropertiesPanel(character);
                        this.drawMockCharacter(character);
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
            }
            
            selectCharacter(characterId) {
                this.selectedCharacter = characterId;
                const character = this.characters.get(characterId);
                if (character) {
                    this.updatePropertiesPanel(character);
                }
                
                // „Ç¢„Ç¶„Éà„É©„Ç§„Éä„Éº„Åß„Éè„Ç§„É©„Ç§„Éà
                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.remove('selected');
                });
                const item = document.querySelector(`[data-id="${characterId}"]`);
                if (item) {
                    item.classList.add('selected');
                }
            }
            
            updatePropertiesPanel(character) {
                const { x, y, scaleX, scaleY, rotation } = character.transform;
                document.getElementById('prop-x').value = Math.round(x);
                document.getElementById('prop-y').value = Math.round(y);
                document.getElementById('prop-scale-x').value = scaleX;
                document.getElementById('prop-scale-y').value = scaleY;
                document.getElementById('prop-rotation').value = rotation;
                document.getElementById('prop-z-index').value = character.zIndex;
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈÅ∏Êäû„ÇíÊõ¥Êñ∞
                const animationSelect = document.getElementById('prop-animation');
                const availableAnims = this.availableAnimations.get(character.name) || ['idle'];
                
                // „Ç™„Éó„Ç∑„Éß„É≥„ÇíÂãïÁöÑÊõ¥Êñ∞
                animationSelect.innerHTML = '';
                availableAnims.forEach(anim => {
                    const option = document.createElement('option');
                    option.value = anim;
                    option.textContent = anim;
                    option.selected = anim === character.animation;
                    animationSelect.appendChild(option);
                });
            }
            
            // ÂÖ®„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÂÜçÊèèÁîª
            redrawAllCharacters() {
                // ZÈ†Ü„Åß„ÇΩ„Éº„Éà„Åó„Å¶ÊèèÁîª
                const sortedCharacters = Array.from(this.characters.values())
                    .sort((a, b) => a.zIndex - b.zIndex);
                
                // „Ç≠„É£„É≥„Éê„Çπ„ÇØ„É™„Ç¢
                const canvas = document.getElementById('preview-canvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // „Ç∞„É™„ÉÉ„ÉâÊèèÁîª
                this.drawGrid(ctx, canvas);
                
                // ÂêÑ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÈ†ÜÁï™„Å´ÊèèÁîª
                sortedCharacters.forEach(character => {
                    this.drawMockCharacter(character, false); // „Éê„Ç¶„É≥„Éá„Ç£„É≥„Ç∞„Éú„ÉÉ„ÇØ„Çπ„Å™„Åó
                });
                
                // ÈÅ∏Êäû‰∏≠„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆ„Éê„Ç¶„É≥„Éá„Ç£„É≥„Ç∞„Éú„ÉÉ„ÇØ„Çπ„ÇíÊúÄÂæå„Å´ÊèèÁîª
                if (this.selectedCharacter) {
                    const selected = this.characters.get(this.selectedCharacter);
                    if (selected) {
                        this.drawBoundingBox(selected);
                    }
                }
            }
            
            // „Éê„Ç¶„É≥„Éá„Ç£„É≥„Ç∞„Éú„ÉÉ„ÇØ„ÇπÊèèÁîª
            drawBoundingBox(character) {
                const preview = document.querySelector('.preview');
                
                // Êó¢Â≠ò„ÅÆ„Éê„Ç¶„É≥„Éá„Ç£„É≥„Ç∞„Éú„ÉÉ„ÇØ„Çπ„ÇíÂâäÈô§
                preview.querySelectorAll('.bounding-box').forEach(box => box.remove());
                
                const { x, y, scaleX, scaleY, rotation } = character.transform;
                
                // „Éê„Ç¶„É≥„Éá„Ç£„É≥„Ç∞„Éú„ÉÉ„ÇØ„Çπ‰ΩúÊàê
                const boundingBox = document.createElement('div');
                boundingBox.className = 'bounding-box active';
                
                // „Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÂÆüÈöõ„ÅÆ„Çµ„Ç§„Ç∫„Å´Âêà„Çè„Åõ„Å¶Ë™øÊï¥
                const width = 60 * Math.abs(scaleX);
                const height = 80 * Math.abs(scaleY);
                
                // „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢ÂÜÖ„ÅÆÁõ∏ÂØæÂ∫ßÊ®ô„ÅßÈÖçÁΩÆÔºà„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆ‰ΩçÁΩÆ„Å®ÂÆåÂÖ®ÂêåÊúüÔºâ
                const previewRect = preview.getBoundingClientRect();
                const centerX = previewRect.width / 2;
                const centerY = previewRect.height / 2;
                
                // „Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆ‰∏≠ÂøÉÂ∫ßÊ®ô„Åã„Çâ„Éê„Ç¶„É≥„Éá„Ç£„É≥„Ç∞„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂ∑¶‰∏äÂ∫ßÊ®ô„ÇíË®àÁÆó
                const boxLeft = centerX + x - width/2;
                const boxTop = centerY + y - height/2;
                
                boundingBox.style.left = `${boxLeft}px`;
                boundingBox.style.top = `${boxTop}px`;
                boundingBox.style.width = `${width}px`;
                boundingBox.style.height = `${height}px`;
                boundingBox.style.transform = `rotate(${rotation}deg)`;
                
                // 8„Å§„ÅÆ„É™„Çµ„Ç§„Ç∫„Éè„É≥„Éâ„É´ËøΩÂä†
                const handles = ['nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'];
                handles.forEach(position => {
                    const handle = document.createElement('div');
                    handle.className = `bounding-box-handle handle-${position}`;
                    boundingBox.appendChild(handle);
                });
                
                preview.appendChild(boundingBox);
                
                // „Éê„Ç¶„É≥„Éá„Ç£„É≥„Ç∞„Éú„ÉÉ„ÇØ„Çπ„ÅÆ„Éâ„É©„ÉÉ„Ç∞„Ç§„Éô„É≥„Éà
                this.makeBoundingBoxDraggable(boundingBox, character);
            }
            
            // „Éê„Ç¶„É≥„Éá„Ç£„É≥„Ç∞„Éú„ÉÉ„ÇØ„Çπ„Çí„Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ„Å´„Åô„Çã
            makeBoundingBoxDraggable(boundingBox, character) {
                let isDragging = false;
                let startMouseX, startMouseY;
                let startCharacterX, startCharacterY;
                
                boundingBox.addEventListener('mousedown', (e) => {
                    if (e.target === boundingBox) {
                        isDragging = true;
                        
                        // „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢Âü∫Ê∫ñ„ÅÆÂ∫ßÊ®ôÁ≥ª„Åß„Éâ„É©„ÉÉ„Ç∞ÈñãÂßã‰ΩçÁΩÆ„ÇíË®òÈå≤
                        const preview = document.querySelector('.preview');
                        const previewRect = preview.getBoundingClientRect();
                        
                        startMouseX = e.clientX - previewRect.left;
                        startMouseY = e.clientY - previewRect.top;
                        startCharacterX = character.transform.x;
                        startCharacterY = character.transform.y;
                        
                        e.preventDefault();
                        
                        // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆË¶ñË¶ö„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
                        boundingBox.style.opacity = '0.8';
                    }
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    // „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢Âü∫Ê∫ñ„ÅÆÁèæÂú®„Éû„Ç¶„Çπ‰ΩçÁΩÆ
                    const preview = document.querySelector('.preview');
                    const previewRect = preview.getBoundingClientRect();
                    const currentMouseX = e.clientX - previewRect.left;
                    const currentMouseY = e.clientY - previewRect.top;
                    
                    // „Éó„É¨„Éì„É•„Éº‰∏≠ÂøÉÂü∫Ê∫ñ„ÅÆÂ∫ßÊ®ôÁ≥ª„Åß„ÅÆÁßªÂãïÈáè„ÇíË®àÁÆó
                    const deltaX = currentMouseX - startMouseX;
                    const deltaY = currentMouseY - startMouseY;
                    
                    // „Ç≠„É£„É©„ÇØ„Çø„ÉºÂ∫ßÊ®ô„ÇíÊõ¥Êñ∞
                    character.transform.x = startCharacterX + deltaX;
                    character.transform.y = startCharacterY + deltaY;
                    
                    // „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞
                    this.updatePropertiesPanel(character);
                    this.redrawAllCharacters();
                });
                
                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        
                        // „Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫Ü„ÅÆË¶ñË¶ö„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Çí„É™„Çª„ÉÉ„Éà
                        boundingBox.style.opacity = '1';
                        
                        this.markDirty();
                        console.log(`üéØ „Ç≠„É£„É©„ÇØ„Çø„Éº ${character.name} „ÇíÁßªÂãï: (${character.transform.x.toFixed(1)}, ${character.transform.y.toFixed(1)})`);
                    }
                });
            }
            
            updateCharacterProperty(property, value) {
                if (!this.selectedCharacter) return;
                
                const character = this.characters.get(this.selectedCharacter);
                if (!character) return;
                
                const numValue = parseFloat(value) || 0;
                
                switch (property) {
                    case 'x':
                        character.transform.x = numValue;
                        break;
                    case 'y':
                        character.transform.y = numValue;
                        break;
                    case 'scale-x':
                        character.transform.scaleX = numValue;
                        break;
                    case 'scale-y':
                        character.transform.scaleY = numValue;
                        break;
                    case 'rotation':
                        character.transform.rotation = numValue;
                        break;
                    case 'z-index':
                        character.zIndex = numValue;
                        break;
                }
                
                this.redrawAllCharacters();
            }
            
            updateCharacterLayers() {
                const layersContainer = document.getElementById('character-layers');
                
                // ZÈ†Ü„Åß„ÇΩ„Éº„ÉàÔºàÈ´ò„ÅÑÈ†ÜÔºâ
                const sortedCharacters = Array.from(this.characters.values())
                    .sort((a, b) => b.zIndex - a.zIndex);
                
                let html = '';
                sortedCharacters.forEach(character => {
                    const isSelected = character.id === this.selectedCharacter;
                    html += `
                        <div class="layer-item ${isSelected ? 'selected' : ''}" 
                             data-id="${character.id}" 
                             draggable="true">
                            <div class="layer-info">
                                <div class="layer-name">üé≠ ${character.name}</div>
                                <div class="layer-animation">üé¨ ${character.animation || 'idle'}</div>
                            </div>
                            <div class="layer-z">Z: ${character.zIndex}</div>
                        </div>
                    `;
                });
                
                layersContainer.innerHTML = html;
                
                // „Ç§„Éô„É≥„ÉàËøΩÂä†
                layersContainer.querySelectorAll('.layer-item').forEach(item => {
                    // „ÇØ„É™„ÉÉ„ÇØÈÅ∏Êäû
                    item.addEventListener('click', () => {
                        this.selectCharacter(item.dataset.id);
                    });
                    
                    // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÔºàZÈ†ÜÂ§âÊõ¥Ôºâ
                    item.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', item.dataset.id);
                        item.classList.add('dragging');
                    });
                    
                    item.addEventListener('dragend', () => {
                        item.classList.remove('dragging');
                    });
                    
                    item.addEventListener('dragover', (e) => {
                        e.preventDefault();
                    });
                    
                    item.addEventListener('drop', (e) => {
                        e.preventDefault();
                        const draggedId = e.dataTransfer.getData('text/plain');
                        const targetId = item.dataset.id;
                        this.reorderLayers(draggedId, targetId);
                    });
                });
            }
            
            handleCanvasClick(e) {
                const canvas = e.target;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                console.log(`Canvas clicked at: (${Math.round(x)}, ${Math.round(y)})`);
            }
            
            // Êú™‰øùÂ≠òÁä∂ÊÖãÁÆ°ÁêÜ
            markDirty() {
                this.isDirty = true;
                this.updateStatus('Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„ÅÇ„Çä ‚ö†Ô∏è', 'error');
            }
            
            // Quick SaveÔºàÂ∫ßÊ®ô„ÅÆ„ÅøÔºâ
            quickSave() {
                const characterData = Array.from(this.characters.values()).map(char => ({
                    id: char.id,
                    transform: { ...char.transform },
                    zIndex: char.zIndex,
                    animation: char.animation
                }));
                
                console.log('‚ö° Quick SaveÂÆüË°å:', characterData);
                this.updateStatus('ÈÖçÁΩÆ„Éá„Éº„Çø‰øùÂ≠òÂÆå‰∫Ü ‚ö°', 'success');
                this.isDirty = false;
                
                // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´ÈÖçÁΩÆ„Éá„Éº„Çø‰øùÂ≠ò
                localStorage.setItem('spine-editor-v4-placement', JSON.stringify(characterData));
            }
            
            // Project SaveÔºàÂÖ®‰Ωì‰øùÂ≠òÔºâ
            projectSave() {
                const projectData = {
                    version: 1,
                    project: {
                        name: 'Spine Project v4',
                        created: new Date().toISOString(),
                        modified: new Date().toISOString()
                    },
                    characters: Array.from(this.characters.values()),
                    availableAnimations: Object.fromEntries(this.availableAnimations),
                    meta: { isDirty: this.isDirty }
                };
                
                console.log('üíæ Project SaveÂÆüË°å:', projectData);
                this.updateStatus('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂÖ®‰Ωì‰øùÂ≠òÂÆå‰∫Ü üíæ', 'success');
                this.isDirty = false;
                
                // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´ÂÖ®„Éá„Éº„Çø‰øùÂ≠ò
                localStorage.setItem('spine-editor-v4-project', JSON.stringify(projectData));
            }
            
            exportProject() {
                console.log('üì¶ „Ç®„ÇØ„Çπ„Éù„Éº„ÉàÈñãÂßã...');
                this.updateStatus('„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂá¶ÁêÜ‰∏≠...');
                
                setTimeout(() => {
                    this.updateStatus('„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂÆå‰∫Ü ‚Üí dist/index.html', 'success');
                }, 1000);
            }
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Â§âÊõ¥
            updateCharacterAnimation(animationName) {
                if (!this.selectedCharacter) return;
                
                const character = this.characters.get(this.selectedCharacter);
                if (character) {
                    character.animation = animationName;
                    console.log(`üé¨ ${character.name} „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Â§âÊõ¥: ${animationName}`);
                    this.updateCharacterLayers(); // „É¨„Ç§„É§„ÉºË°®Á§∫„ÇíÊõ¥Êñ∞
                }
            }
            
            // „É¨„Ç§„É§„ÉºÈ†ÜÂ∫è: Ââç„Å∏
            bringForward() {
                if (!this.selectedCharacter) return;
                
                const character = this.characters.get(this.selectedCharacter);
                if (character) {
                    character.zIndex++;
                    this.updatePropertiesPanel(character);
                    this.updateCharacterLayers();
                    this.redrawAllCharacters();
                    this.markDirty();
                }
            }
            
            // „É¨„Ç§„É§„ÉºÈ†ÜÂ∫è: Âæå„Çç„Å∏
            sendBackward() {
                if (!this.selectedCharacter) return;
                
                const character = this.characters.get(this.selectedCharacter);
                if (character) {
                    character.zIndex--;
                    this.updatePropertiesPanel(character);
                    this.updateCharacterLayers();
                    this.redrawAllCharacters();
                    this.markDirty();
                }
            }
            
            // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Å´„Çà„Çã„É¨„Ç§„É§„ÉºÈ†ÜÂ∫èÂ§âÊõ¥
            reorderLayers(draggedId, targetId) {
                if (draggedId === targetId) return;
                
                const draggedChar = this.characters.get(draggedId);
                const targetChar = this.characters.get(targetId);
                
                if (draggedChar && targetChar) {
                    // „Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆZÂÄ§„ÇíÂèñÂæó„Åó„ÄÅ„Éâ„É©„ÉÉ„Ç∞„Åï„Çå„Åü„Ç≠„É£„É©„Çí„Åù„ÅÆ‰∏ä„Å´ÈÖçÁΩÆ
                    draggedChar.zIndex = targetChar.zIndex + 1;
                    
                    console.log(`üîÑ „É¨„Ç§„É§„ÉºÈ†ÜÂ∫èÂ§âÊõ¥: ${draggedChar.name} ‚Üí Z:${draggedChar.zIndex}`);
                    
                    this.updateCharacterLayers();
                    this.redrawAllCharacters();
                    this.markDirty();
                    
                    // „Éâ„É©„ÉÉ„Ç∞„Åï„Çå„Åü„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÈÅ∏Êäû
                    this.selectCharacter(draggedId);
                }
            }
            
            updateStatus(message, type = '') {
                const status = document.getElementById('project-status');
                status.textContent = message;
                status.className = type;
                
                const statusBar = document.getElementById('status-bar');
                statusBar.textContent = message;
            }
        }
        
        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Spine Editor v4.0 - ÊîπÂñÑÁâà„Éó„É≠„Éà„Çø„Ç§„ÉóÈñãÂßã');
            new ImprovedProjectManager();
        });
    </script>
</body>
</html>