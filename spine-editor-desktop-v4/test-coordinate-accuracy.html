<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº§æ¨™ç²¾åº¦ãƒ†ã‚¹ãƒˆ - Spine Editor v4.0</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', monospace;
            margin: 20px;
            background: #f8f9fa;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .summary {
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
        }
        canvas {
            border: 1px solid #ddd;
            margin: 10px 0;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .test-point {
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Spine Editor v4.0 - åº§æ¨™ç²¾åº¦ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-container">
        <h2>ğŸ“ CoordinateUtils ç²¾åº¦ãƒ†ã‚¹ãƒˆ</h2>
        <div id="coordinate-test-results"></div>
    </div>

    <div class="test-container">
        <h2>ğŸ¯ ãƒ†ã‚¹ãƒˆãƒã‚¤ãƒ³ãƒˆå¯è¦–åŒ–</h2>
        <canvas id="test-canvas" width="640" height="360"></canvas>
        <div class="test-grid" id="test-points-grid"></div>
    </div>

    <div class="test-container">
        <h2>ğŸ“Š DPRå¯¾å¿œãƒ†ã‚¹ãƒˆ</h2>
        <div id="dpr-test-results"></div>
    </div>

    <div class="test-container">
        <h2>âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</h2>
        <div id="performance-test-results"></div>
    </div>

    <!-- TypeScript/JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ -->
    <script>
        // CoordinateUtils ã®JavaScriptç§»æ¤ç‰ˆ
        class CoordinateUtils {
            static domToSpine(domPoint, canvasSize) {
                return {
                    x: domPoint.x - canvasSize.width / 2,
                    y: canvasSize.height / 2 - domPoint.y
                };
            }

            static spineToDom(spinePoint, canvasSize) {
                return {
                    x: spinePoint.x + canvasSize.width / 2,
                    y: canvasSize.height / 2 - spinePoint.y
                };
            }

            static testRoundTripAccuracy(originalPoint, canvasSize) {
                const spinePoint = this.domToSpine(originalPoint, canvasSize);
                const backToDom = this.spineToDom(spinePoint, canvasSize);
                
                const dx = backToDom.x - originalPoint.x;
                const dy = backToDom.y - originalPoint.y;
                return Math.sqrt(dx * dx + dy * dy);
            }

            static snapToGrid(point, gridSize) {
                if (gridSize <= 0) return point;
                return {
                    x: Math.round(point.x / gridSize) * gridSize,
                    y: Math.round(point.y / gridSize) * gridSize
                };
            }

            static distance(pointA, pointB) {
                const dx = pointB.x - pointA.x;
                const dy = pointB.y - pointA.y;
                return Math.sqrt(dx * dx + dy * dy);
            }
        }

        // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å®šç¾©
        const TEST_CASES = [
            { name: "å·¦ä¸Šè§’", point: { x: 0, y: 0 }, expected: "åŸç‚¹å¤‰æ›" },
            { name: "ä¸­å¤®", point: { x: 320, y: 180 }, expected: "SpineåŸç‚¹(0,0)" },
            { name: "å³ä¸‹è§’", point: { x: 640, y: 360 }, expected: "æœ€å¤§åº§æ¨™" },
            { name: "ç¬¬1è±¡é™", point: { x: 480, y: 90 }, expected: "æ­£ã®é ˜åŸŸ" },
            { name: "ç¬¬3è±¡é™", point: { x: 160, y: 270 }, expected: "è² ã®é ˜åŸŸ" },
            { name: "å°æ•°ç‚¹1", point: { x: 100.5, y: 200.7 }, expected: "äºœãƒ”ã‚¯ã‚»ãƒ«ç²¾åº¦" },
            { name: "å°æ•°ç‚¹2", point: { x: 255.3, y: 128.9 }, expected: "ç«¯æ•°å‡¦ç†" },
            { name: "å¢ƒç•Œè¿‘å‚", point: { x: 1, y: 1 }, expected: "å¢ƒç•Œå€¤" },
            { name: "å¢ƒç•Œè¿‘å‚", point: { x: 639, y: 359 }, expected: "å¢ƒç•Œå€¤" },
            { name: "æ¥µå°å€¤", point: { x: 0.1, y: 0.1 }, expected: "æ¥µå°åº§æ¨™" }
        ];

        const CANVAS_SIZE = { width: 640, height: 360 };

        // ãƒ¡ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        function runCoordinateTests() {
            const resultsContainer = document.getElementById('coordinate-test-results');
            let allPassed = true;
            let totalError = 0;
            let maxError = 0;

            resultsContainer.innerHTML = '<div class="info">ğŸ”„ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';

            setTimeout(() => {
                let html = '';
                
                TEST_CASES.forEach((testCase, index) => {
                    const error = CoordinateUtils.testRoundTripAccuracy(testCase.point, CANVAS_SIZE);
                    const passed = error < 1.0; // 1pxä»¥å†…
                    
                    totalError += error;
                    maxError = Math.max(maxError, error);
                    
                    if (!passed) allPassed = false;
                    
                    html += `
                        <div class="test-result ${passed ? 'pass' : 'fail'}">
                            ${passed ? 'âœ…' : 'âŒ'} ${testCase.name}: 
                            (${testCase.point.x}, ${testCase.point.y}) 
                            èª¤å·®: ${error.toFixed(6)}px
                            ${passed ? '' : ' âš ï¸ åŸºæº–è¶…é'}
                        </div>
                    `;
                });

                const avgError = totalError / TEST_CASES.length;
                
                html += `
                    <div class="summary ${allPassed ? 'pass' : 'fail'}">
                        ğŸ“Š ç·åˆçµæœ: ${allPassed ? 'âœ… å…¨ãƒ†ã‚¹ãƒˆåˆæ ¼' : 'âŒ å¤±æ•—ã‚ã‚Š'}
                    </div>
                    <div class="info">
                        ğŸ“ˆ å¹³å‡èª¤å·®: ${avgError.toFixed(6)}px<br>
                        ğŸ“ˆ æœ€å¤§èª¤å·®: ${maxError.toFixed(6)}px<br>
                        ğŸ“ˆ åŸºæº–: 1.0pxä»¥å†…
                    </div>
                `;
                
                resultsContainer.innerHTML = html;
            }, 100);
        }

        // å¯è¦–åŒ–ãƒ†ã‚¹ãƒˆ
        function drawTestPoints() {
            const canvas = document.getElementById('test-canvas');
            const ctx = canvas.getContext('2d');
            const grid = document.getElementById('test-points-grid');
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªã‚¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ã‚°ãƒªãƒƒãƒ‰æç”»
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let x = 0; x <= canvas.width; x += 40) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y <= canvas.height; y += 40) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // ä¸­å¤®ç·š
            ctx.strokeStyle = '#007bff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(canvas.width/2, 0);
            ctx.lineTo(canvas.width/2, canvas.height);
            ctx.moveTo(0, canvas.height/2);
            ctx.lineTo(canvas.width, canvas.height/2);
            ctx.stroke();
            
            // ãƒ†ã‚¹ãƒˆãƒã‚¤ãƒ³ãƒˆæç”»
            let gridHtml = '';
            TEST_CASES.forEach((testCase, index) => {
                const point = testCase.point;
                const spineCoord = CoordinateUtils.domToSpine(point, CANVAS_SIZE);
                const error = CoordinateUtils.testRoundTripAccuracy(point, CANVAS_SIZE);
                
                // ç‚¹ã‚’æç”»
                ctx.fillStyle = error < 1.0 ? '#28a745' : '#dc3545';
                ctx.beginPath();
                ctx.arc(point.x, point.y, 4, 0, 2 * Math.PI);
                ctx.fill();
                
                // ãƒ©ãƒ™ãƒ«
                ctx.fillStyle = '#333';
                ctx.font = '10px monospace';
                ctx.fillText(`${index + 1}`, point.x + 6, point.y - 6);
                
                // ã‚°ãƒªãƒƒãƒ‰æƒ…å ±
                gridHtml += `
                    <div class="test-point">
                        <strong>${index + 1}. ${testCase.name}</strong><br>
                        DOM: (${point.x}, ${point.y})<br>
                        Spine: (${spineCoord.x.toFixed(1)}, ${spineCoord.y.toFixed(1)})<br>
                        èª¤å·®: ${error.toFixed(4)}px
                    </div>
                `;
            });
            
            grid.innerHTML = gridHtml;
        }

        // DPRãƒ†ã‚¹ãƒˆ
        function runDPRTest() {
            const resultsContainer = document.getElementById('dpr-test-results');
            const dpr = window.devicePixelRatio || 1;
            
            const testPoint = { x: 100, y: 100 };
            const physicalPoint = {
                x: testPoint.x * dpr,
                y: testPoint.y * dpr
            };
            const backToCss = {
                x: physicalPoint.x / dpr,
                y: physicalPoint.y / dpr
            };
            
            const dprError = CoordinateUtils.distance(testPoint, backToCss);
            
            resultsContainer.innerHTML = `
                <div class="info">
                    ğŸ–¥ï¸ Device Pixel Ratio: ${dpr}<br>
                    ğŸ“± CSS â†’ ç‰©ç† â†’ CSS å¤‰æ›ãƒ†ã‚¹ãƒˆ
                </div>
                <div class="test-result ${dprError < 0.001 ? 'pass' : 'fail'}">
                    ${dprError < 0.001 ? 'âœ…' : 'âŒ'} DPRå¤‰æ›ç²¾åº¦: ${dprError.toFixed(6)}px
                </div>
            `;
        }

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
        function runPerformanceTest() {
            const resultsContainer = document.getElementById('performance-test-results');
            
            resultsContainer.innerHTML = '<div class="info">ğŸ”„ æ€§èƒ½ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';
            
            setTimeout(() => {
                const iterations = 10000;
                const testPoint = { x: 320, y: 180 };
                
                const startTime = performance.now();
                for (let i = 0; i < iterations; i++) {
                    CoordinateUtils.testRoundTripAccuracy(testPoint, CANVAS_SIZE);
                }
                const endTime = performance.now();
                
                const totalTime = endTime - startTime;
                const timePerOp = totalTime / iterations;
                
                resultsContainer.innerHTML = `
                    <div class="test-result ${timePerOp < 0.01 ? 'pass' : 'fail'}">
                        âš¡ ${iterations.toLocaleString()}å›å¤‰æ›: ${totalTime.toFixed(2)}ms
                    </div>
                    <div class="test-result ${timePerOp < 0.01 ? 'pass' : 'fail'}">
                        âš¡ 1å›ã‚ãŸã‚Š: ${(timePerOp * 1000).toFixed(3)}Âµs
                        ${timePerOp < 0.01 ? '(è‰¯å¥½)' : '(è¦æ”¹å–„)'}
                    </div>
                `;
            }, 100);
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ§ª åº§æ¨™ç²¾åº¦ãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            runCoordinateTests();
            drawTestPoints();
            runDPRTest();
            runPerformanceTest();
        });
    </script>
</body>
</html>