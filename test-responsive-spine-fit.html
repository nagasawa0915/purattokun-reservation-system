<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>背景画像完全フィット・レスポンシブテスト</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f0f0;
            overflow-x: hidden;
        }

        /* メインコンテナ */
        .responsive-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* 背景画像エリア */
        .background-area {
            position: absolute;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 70%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 600"><rect width="800" height="600" fill="%23e8f4f8"/><rect x="100" y="200" width="600" height="200" fill="%23d1ecf1" stroke="%234a90a4" stroke-width="3" rx="20"/><circle cx="200" cy="300" r="80" fill="%23b8e6b8" stroke="%23228b22" stroke-width="4"/><circle cx="600" cy="300" r="60" fill="%23ffb6c1" stroke="%23ff69b4" stroke-width="3"/><text x="400" y="330" font-family="Arial" font-size="24" fill="%23333" text-anchor="middle">背景画像サンプル</text></svg>') center/contain no-repeat;
            border: 2px solid #333;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        /* Spineキャラクター配置エリア */
        .spine-container {
            position: absolute;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, #ff6b6b, #ee5a6f);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
            cursor: pointer;
            transform-origin: center center;
            /* CSS変数でサイズ・位置制御 */
            transform: translate(var(--spine-x, 0), var(--spine-y, 0)) scale(var(--spine-scale, 1));
        }

        .spine-container:hover {
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
            transform: translate(var(--spine-x, 0), var(--spine-y, 0)) scale(calc(var(--spine-scale, 1) * 1.1));
        }

        /* コントロールパネル */
        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 280px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .control-group input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }

        .control-group .value-display {
            font-size: 12px;
            color: #666;
            text-align: right;
        }

        .control-button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .control-button:hover {
            background: #ee5a6f;
        }

        .status-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            margin-top: 15px;
        }

        /* デバッグ情報表示 */
        .debug-overlay {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-width: 400px;
            z-index: 1000;
        }

        /* レスポンシブ調整 */
        @media (max-width: 768px) {
            .control-panel {
                position: relative;
                top: 10px;
                right: 10px;
                width: calc(100% - 20px);
                margin-bottom: 20px;
            }

            .background-area {
                top: 180px;
                left: 5%;
                width: 90%;
                height: 60vh;
            }

            .debug-overlay {
                position: relative;
                bottom: auto;
                left: auto;
                margin: 10px;
                width: calc(100% - 20px);
            }
        }

        /* アニメーション定義 */
        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .responsive-container.active {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="responsive-container" id="responsiveContainer">
        <!-- 背景画像エリア -->
        <div class="background-area" id="backgroundArea"></div>
        
        <!-- Spineキャラクター -->
        <div class="spine-container" id="spineContainer">
            <div>ぷらっと<br>くん</div>
        </div>
    </div>

    <!-- コントロールパネル -->
    <div class="control-panel">
        <h3>🎯 レスポンシブフィット制御</h3>
        
        <div class="control-group">
            <label>背景領域選択</label>
            <select id="regionSelect">
                <option value="shop-front">お店前エリア</option>
                <option value="road-area">道路エリア</option>
                <option value="center-area">中央エリア</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>フィット比率: <span id="ratioValue">1.0</span></label>
            <input type="range" id="ratioSlider" min="0.5" max="2.0" step="0.1" value="1.0">
        </div>
        
        <div class="control-group">
            <label>フィットモード</label>
            <select id="fitModeSelect">
                <option value="contain">完全収まり</option>
                <option value="cover">エリア全体</option>
                <option value="exact">正確サイズ</option>
            </select>
        </div>
        
        <button class="control-button" id="toggleSystem">システム ON/OFF</button>
        <button class="control-button" id="resetPosition">位置リセット</button>
        <button class="control-button" id="testResize">リサイズテスト</button>
        
        <div class="status-display" id="statusDisplay">
            システム待機中...
        </div>
    </div>

    <!-- デバッグ情報 -->
    <div class="debug-overlay" id="debugOverlay">
        <div><strong>🔍 リアルタイム情報</strong></div>
        <div>背景サイズ: <span id="bgSize">未取得</span></div>
        <div>領域サイズ: <span id="regionSize">未取得</span></div>
        <div>キャラ位置: <span id="spinePos">未取得</span></div>
        <div>縮尺比率: <span id="scaleInfo">未取得</span></div>
        <div>ウィンドウ: <span id="windowSize">未取得</span></div>
    </div>

    <script>
        // 🎯 背景画像完全フィット・レスポンシブシステム実装
        class ResponsiveSpineFitSystem {
            constructor(options = {}) {
                this.backgroundElement = options.backgroundElement;
                this.spineContainer = options.spineContainer;
                this.debugOverlay = options.debugOverlay;
                
                // 背景領域定義（%ベース）
                this.regions = new Map([
                    ['shop-front', { x: 15, y: 35, width: 20, height: 30, fitMode: 'contain' }],
                    ['road-area', { x: 65, y: 35, width: 15, height: 25, fitMode: 'contain' }],
                    ['center-area', { x: 35, y: 25, width: 30, height: 50, fitMode: 'contain' }]
                ]);
                
                this.currentRegion = 'shop-front';
                this.baseRatio = 1.0;
                this.isActive = false;
                this.observers = new Map();
                
                // 基準メトリクス
                this.baseMetrics = {
                    bgWidth: 0,
                    bgHeight: 0,
                    spineWidth: 100,
                    spineHeight: 100
                };
                
                this.init();
            }
            
            init() {
                this.calculateBaseMetrics();
                this.setupEventListeners();
                this.setupBackgroundObserver();
                this.updateDebugInfo();
                this.start();
            }
            
            calculateBaseMetrics() {
                const bgRect = this.backgroundElement.getBoundingClientRect();
                this.baseMetrics.bgWidth = bgRect.width;
                this.baseMetrics.bgHeight = bgRect.height;
                
                const spineRect = this.spineContainer.getBoundingClientRect();
                this.baseMetrics.spineWidth = spineRect.width;
                this.baseMetrics.spineHeight = spineRect.height;
            }
            
            setupBackgroundObserver() {
                const observer = new ResizeObserver((entries) => {
                    for (const entry of entries) {
                        this.onBackgroundResize(entry);
                    }
                });
                
                observer.observe(this.backgroundElement);
                this.observers.set('background', observer);
                
                // ウィンドウリサイズも監視
                window.addEventListener('resize', () => {
                    setTimeout(() => this.updateAll(), 100);
                });
            }
            
            onBackgroundResize(entry) {
                if (!this.isActive) return;
                
                const { width, height } = entry.contentRect;
                console.log(`🔄 背景リサイズ検出: ${width}x${height}`);
                
                this.adjustSpineToFit(width, height);
                this.updateDebugInfo();
            }
            
            adjustSpineToFit(bgWidth, bgHeight) {
                const region = this.regions.get(this.currentRegion);
                if (!region) return;
                
                // ◯領域の絶対座標・サイズ計算
                const regionData = {
                    x: bgWidth * (region.x / 100),
                    y: bgHeight * (region.y / 100),
                    width: bgWidth * (region.width / 100),
                    height: bgHeight * (region.height / 100)
                };
                
                // フィット縮尺計算
                const scaleX = regionData.width / this.baseMetrics.spineWidth;
                const scaleY = regionData.height / this.baseMetrics.spineHeight;
                let fitScale = Math.min(scaleX, scaleY) * this.baseRatio;
                
                // フィットモード適用
                const fitMode = region.fitMode || 'contain';
                if (fitMode === 'cover') {
                    fitScale = Math.max(scaleX, scaleY) * this.baseRatio;
                } else if (fitMode === 'exact') {
                    fitScale = this.baseRatio;
                }
                
                // 背景要素の位置を考慮した絶対位置計算
                const bgRect = this.backgroundElement.getBoundingClientRect();
                const absoluteX = bgRect.left + regionData.x + (regionData.width / 2);
                const absoluteY = bgRect.top + regionData.y + (regionData.height / 2);
                
                // CSS変数で位置・スケール制御
                this.spineContainer.style.setProperty('--spine-x', `${absoluteX - bgRect.left}px`);
                this.spineContainer.style.setProperty('--spine-y', `${absoluteY - bgRect.top}px`);
                this.spineContainer.style.setProperty('--spine-scale', fitScale);
                
                // 絶対位置設定
                this.spineContainer.style.left = `${absoluteX - (this.baseMetrics.spineWidth * fitScale) / 2}px`;
                this.spineContainer.style.top = `${absoluteY - (this.baseMetrics.spineHeight * fitScale) / 2}px`;
                
                console.log(`✅ フィット適用 - 位置:(${Math.round(absoluteX)}, ${Math.round(absoluteY)}), スケール:${fitScale.toFixed(2)}`);
            }
            
            updateAll() {
                const bgRect = this.backgroundElement.getBoundingClientRect();
                this.adjustSpineToFit(bgRect.width, bgRect.height);
                this.updateDebugInfo();
            }
            
            setupEventListeners() {
                // 地域選択
                document.getElementById('regionSelect').addEventListener('change', (e) => {
                    this.currentRegion = e.target.value;
                    this.updateAll();
                    this.updateStatus(`地域変更: ${e.target.value}`);
                });
                
                // 比率調整
                const ratioSlider = document.getElementById('ratioSlider');
                ratioSlider.addEventListener('input', (e) => {
                    this.baseRatio = parseFloat(e.target.value);
                    document.getElementById('ratioValue').textContent = this.baseRatio;
                    this.updateAll();
                });
                
                // フィットモード
                document.getElementById('fitModeSelect').addEventListener('change', (e) => {
                    const region = this.regions.get(this.currentRegion);
                    if (region) {
                        region.fitMode = e.target.value;
                        this.updateAll();
                        this.updateStatus(`フィットモード: ${e.target.value}`);
                    }
                });
                
                // システムトグル
                document.getElementById('toggleSystem').addEventListener('click', () => {
                    this.isActive = !this.isActive;
                    document.getElementById('toggleSystem').textContent = 
                        this.isActive ? 'システム OFF' : 'システム ON';
                    this.updateStatus(this.isActive ? 'システム開始' : 'システム停止');
                    
                    if (this.isActive) {
                        this.updateAll();
                    }
                });
                
                // 位置リセット
                document.getElementById('resetPosition').addEventListener('click', () => {
                    this.spineContainer.style.removeProperty('--spine-x');
                    this.spineContainer.style.removeProperty('--spine-y');
                    this.spineContainer.style.removeProperty('--spine-scale');
                    this.spineContainer.style.left = '';
                    this.spineContainer.style.top = '';
                    this.updateStatus('位置リセット完了');
                });
                
                // リサイズテスト
                document.getElementById('testResize').addEventListener('click', () => {
                    this.testResize();
                });
            }
            
            testResize() {
                const container = document.getElementById('responsiveContainer');
                container.classList.add('active');
                
                // アニメーション付きでサイズを変更
                const originalWidth = this.backgroundElement.style.width || '80%';
                const originalHeight = this.backgroundElement.style.height || '70%';
                
                // 小さくする
                this.backgroundElement.style.width = '60%';
                this.backgroundElement.style.height = '50%';
                this.updateStatus('リサイズテスト: 縮小');
                
                setTimeout(() => {
                    // 大きくする
                    this.backgroundElement.style.width = '90%';
                    this.backgroundElement.style.height = '80%';
                    this.updateStatus('リサイズテスト: 拡大');
                }, 1000);
                
                setTimeout(() => {
                    // 元に戻す
                    this.backgroundElement.style.width = originalWidth;
                    this.backgroundElement.style.height = originalHeight;
                    this.updateStatus('リサイズテスト: 完了');
                    container.classList.remove('active');
                }, 2000);
            }
            
            updateDebugInfo() {
                if (!this.debugOverlay) return;
                
                const bgRect = this.backgroundElement.getBoundingClientRect();
                const spineRect = this.spineContainer.getBoundingClientRect();
                const region = this.regions.get(this.currentRegion);
                
                document.getElementById('bgSize').textContent = 
                    `${Math.round(bgRect.width)}×${Math.round(bgRect.height)}`;
                
                if (region) {
                    const regionWidth = bgRect.width * (region.width / 100);
                    const regionHeight = bgRect.height * (region.height / 100);
                    document.getElementById('regionSize').textContent = 
                        `${Math.round(regionWidth)}×${Math.round(regionHeight)}`;
                }
                
                document.getElementById('spinePos').textContent = 
                    `(${Math.round(spineRect.left)}, ${Math.round(spineRect.top)})`;
                
                const currentScale = this.spineContainer.style.getPropertyValue('--spine-scale') || '1';
                document.getElementById('scaleInfo').textContent = 
                    `${parseFloat(currentScale).toFixed(2)}x`;
                
                document.getElementById('windowSize').textContent = 
                    `${window.innerWidth}×${window.innerHeight}`;
            }
            
            updateStatus(message) {
                const statusEl = document.getElementById('statusDisplay');
                statusEl.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            }
            
            start() {
                this.isActive = true;
                document.getElementById('toggleSystem').textContent = 'システム OFF';
                this.updateAll();
                this.updateStatus('システム開始完了');
            }
            
            destroy() {
                this.observers.forEach(observer => observer.disconnect());
                this.observers.clear();
                this.updateStatus('システム停止');
            }
        }

        // 🚀 システム初期化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🎯 背景画像完全フィット・レスポンシブシステム初期化中...');
            
            const system = new ResponsiveSpineFitSystem({
                backgroundElement: document.getElementById('backgroundArea'),
                spineContainer: document.getElementById('spineContainer'),
                debugOverlay: document.getElementById('debugOverlay')
            });
            
            // グローバル参照（デバッグ用）
            window.responsiveSpineFitSystem = system;
            
            console.log('✅ システム初期化完了');
            console.log('🎮 F12コンソールで "responsiveSpineFitSystem" からシステム制御可能');
            
            // 定期的なデバッグ情報更新
            setInterval(() => {
                if (system.isActive) {
                    system.updateDebugInfo();
                }
            }, 500);
        });

        // 🔧 デバッグ用関数
        window.debugResponsiveSystem = () => {
            const system = window.responsiveSpineFitSystem;
            if (!system) {
                console.log('❌ システムが初期化されていません');
                return;
            }
            
            console.log('🎯 ResponsiveSpineFitSystem デバッグ情報:');
            console.log('- 現在の地域:', system.currentRegion);
            console.log('- ベース比率:', system.baseRatio);
            console.log('- システム状態:', system.isActive ? 'ON' : 'OFF');
            console.log('- 定義済み地域:', Array.from(system.regions.keys()));
            console.log('- 基準メトリクス:', system.baseMetrics);
        };
    </script>
</body>
</html>