<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Observer Phase 0 - Unit Tests</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #007acc;
        }
        
        .test-result {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .test-result.pass {
            border-left: 4px solid #28a745;
        }
        
        .test-result.fail {
            border-left: 4px solid #dc3545;
            background: #fff5f5;
        }
        
        .test-container {
            position: relative;
            width: 400px;
            height: 300px;
            background: #e9ecef;
            border: 2px solid #6c757d;
            margin: 10px 0;
        }
        
        .test-element {
            width: 200px;
            height: 150px;
            background: #007acc;
            opacity: 0.7;
        }
        
        .nested-positioned {
            position: relative;
            width: 300px;
            height: 200px;
            background: #17a2b8;
            margin: 20px;
            padding: 15px;
        }
        
        .deeply-nested {
            position: absolute;
            top: 50px;
            left: 30px;
            width: 100px;
            height: 80px;
            background: #ffc107;
        }
        
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Observer Phase 0 - Unit Tests</h1>
    <p>åŸºç›¤ã‚¹ãƒ‘ã‚¤ã‚¯: resolveFittedContent / findContainer ã®å˜ä½“ãƒ†ã‚¹ãƒˆ</p>
    
    <div class="controls">
        <button onclick="runAllTests()">ğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ çµæœã‚¯ãƒªã‚¢</button>
        <button onclick="testResolveFittedContent()">ğŸ“¦ resolveFittedContent ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testFindContainer()">ğŸ¯ findContainer ãƒ†ã‚¹ãƒˆ</button>
    </div>
    
    <div id="test-results"></div>
    
    <!-- ãƒ†ã‚¹ãƒˆç”¨DOMæ§‹é€  -->
    <div class="test-section">
        <h3>ğŸ“¦ resolveFittedContent ãƒ†ã‚¹ãƒˆç”¨è¦ç´ </h3>
        <div class="test-container" id="test-container-1">
            <div class="test-element" id="test-element-1">contain ãƒ†ã‚¹ãƒˆ</div>
        </div>
        
        <div class="test-container" id="test-container-2" style="width: 300px; height: 600px;">
            <div class="test-element" id="test-element-2" style="width: 150px; height: 200px;">cover ãƒ†ã‚¹ãƒˆ</div>
        </div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ¯ findContainer ãƒ†ã‚¹ãƒˆç”¨è¦ç´ </h3>
        <div class="nested-positioned" id="positioned-parent">
            <div style="margin: 10px;">
                <div class="deeply-nested" id="nested-target">nested ãƒ†ã‚¹ãƒˆ</div>
            </div>
        </div>
        
        <div style="margin: 20px;">
            <div style="padding: 10px;">
                <div id="no-positioned-target" style="background: #fd7e14; padding: 10px;">
                    positionedè¦ªãªã— ãƒ†ã‚¹ãƒˆ
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { resolveFittedContent, debugFittedContent, parseObjectPosition } from './micromodules/observer/utils/resolveFittedContent.js';
        import { findContainer, debugCoordinateSystem, testNestedContainerSearch, diagnoseCoordinateSystem } from './micromodules/observer/utils/findContainer.js';
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        window.resolveFittedContent = resolveFittedContent;
        window.findContainer = findContainer;
        window.debugFittedContent = debugFittedContent;
        window.debugCoordinateSystem = debugCoordinateSystem;
        
        let testResults = [];
        
        function addTestResult(name, passed, details) {
            const result = { name, passed, details, timestamp: new Date() };
            testResults.push(result);
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
            resultDiv.innerHTML = `
                <strong>${passed ? 'âœ…' : 'âŒ'} ${name}</strong><br>
                ${details}
            `;
            
            document.getElementById('test-results').appendChild(resultDiv);
        }
        
        function clearResults() {
            testResults = [];
            document.getElementById('test-results').innerHTML = '';
        }
        
        // resolveFittedContent ãƒ†ã‚¹ãƒˆç¾¤
        function testResolveFittedContent() {
            console.group('ğŸ§ª resolveFittedContent Tests');
            
            // ãƒ†ã‚¹ãƒˆ 1: contain ãƒ¢ãƒ¼ãƒ‰
            testContainMode();
            
            // ãƒ†ã‚¹ãƒˆ 2: cover ãƒ¢ãƒ¼ãƒ‰  
            testCoverMode();
            
            // ãƒ†ã‚¹ãƒˆ 3: fill ãƒ¢ãƒ¼ãƒ‰
            testFillMode();
            
            // ãƒ†ã‚¹ãƒˆ 4: none ãƒ¢ãƒ¼ãƒ‰
            testNoneMode();
            
            // ãƒ†ã‚¹ãƒˆ 5: object-position ãƒ†ã‚¹ãƒˆ
            testObjectPositions();
            
            console.groupEnd();
        }
        
        function testContainMode() {
            const rect = { width: 400, height: 300 };
            const logical = { w: 600, h: 400 };
            const result = resolveFittedContent(rect, logical, 'contain', '50% 50%');
            
            // contain: min(400/600, 300/400) = min(0.667, 0.75) = 0.667
            // contentW = 600 * 0.667 = 400, contentH = 400 * 0.667 = 266.67
            // padX = (400 - 400) / 2 = 0, padY = (300 - 266.67) / 2 = 16.67
            
            const expectedScale = Math.min(400/600, 300/400);
            const expectedW = 600 * expectedScale;
            const expectedH = 400 * expectedScale;
            const expectedPadY = (300 - expectedH) / 2;
            
            const tolerance = 0.1;
            const passed = 
                Math.abs(result.contentW - expectedW) < tolerance &&
                Math.abs(result.contentH - expectedH) < tolerance &&
                Math.abs(result.padX - 0) < tolerance &&
                Math.abs(result.padY - expectedPadY) < tolerance;
            
            addTestResult(
                'contain ãƒ¢ãƒ¼ãƒ‰è¨ˆç®—',
                passed,
                `æœŸå¾…å€¤: ${expectedW.toFixed(2)}Ã—${expectedH.toFixed(2)}, pad(0, ${expectedPadY.toFixed(2)})<br>` +
                `å®Ÿéš›å€¤: ${result.contentW.toFixed(2)}Ã—${result.contentH.toFixed(2)}, pad(${result.padX.toFixed(2)}, ${result.padY.toFixed(2)})`
            );
        }
        
        function testCoverMode() {
            const rect = { width: 400, height: 300 };
            const logical = { w: 600, h: 400 };
            const result = resolveFittedContent(rect, logical, 'cover', '50% 50%');
            
            // cover: max(400/600, 300/400) = max(0.667, 0.75) = 0.75
            const expectedScale = Math.max(400/600, 300/400);
            const expectedW = 600 * expectedScale;
            const expectedH = 400 * expectedScale;
            const expectedPadX = (400 - expectedW) / 2;
            
            const tolerance = 0.1;
            const passed = 
                Math.abs(result.contentW - expectedW) < tolerance &&
                Math.abs(result.contentH - expectedH) < tolerance &&
                Math.abs(result.padX - expectedPadX) < tolerance &&
                Math.abs(result.padY - 0) < tolerance;
            
            addTestResult(
                'cover ãƒ¢ãƒ¼ãƒ‰è¨ˆç®—',
                passed,
                `æœŸå¾…å€¤: ${expectedW.toFixed(2)}Ã—${expectedH.toFixed(2)}, pad(${expectedPadX.toFixed(2)}, 0)<br>` +
                `å®Ÿéš›å€¤: ${result.contentW.toFixed(2)}Ã—${result.contentH.toFixed(2)}, pad(${result.padX.toFixed(2)}, ${result.padY.toFixed(2)})`
            );
        }
        
        function testFillMode() {
            const rect = { width: 400, height: 300 };
            const logical = { w: 600, h: 400 };
            const result = resolveFittedContent(rect, logical, 'fill', '50% 50%');
            
            // fill: è¦ç´ ã‚µã‚¤ã‚ºãã®ã¾ã¾ã€ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãªã—
            const passed = 
                result.contentW === 400 &&
                result.contentH === 300 &&
                result.padX === 0 &&
                result.padY === 0;
            
            addTestResult(
                'fill ãƒ¢ãƒ¼ãƒ‰è¨ˆç®—',
                passed,
                `æœŸå¾…å€¤: 400Ã—300, pad(0, 0)<br>` +
                `å®Ÿéš›å€¤: ${result.contentW}Ã—${result.contentH}, pad(${result.padX}, ${result.padY})`
            );
        }
        
        function testNoneMode() {
            const rect = { width: 400, height: 300 };
            const logical = { w: 600, h: 400 };
            const result = resolveFittedContent(rect, logical, 'none', '50% 50%');
            
            // none: è«–ç†ã‚µã‚¤ã‚ºãã®ã¾ã¾ã€ä¸­å¤®é…ç½®
            const expectedPadX = (400 - 600) / 2; // -100
            const expectedPadY = (300 - 400) / 2; // -50
            
            const passed = 
                result.contentW === 600 &&
                result.contentH === 400 &&
                result.padX === expectedPadX &&
                result.padY === expectedPadY;
            
            addTestResult(
                'none ãƒ¢ãƒ¼ãƒ‰è¨ˆç®—',
                passed,
                `æœŸå¾…å€¤: 600Ã—400, pad(${expectedPadX}, ${expectedPadY})<br>` +
                `å®Ÿéš›å€¤: ${result.contentW}Ã—${result.contentH}, pad(${result.padX}, ${result.padY})`
            );
        }
        
        function testObjectPositions() {
            const rect = { width: 400, height: 300 };
            const logical = { w: 200, h: 200 }; // æ­£æ–¹å½¢ã§ç°¡å˜ã«
            
            // contain ã§ 200Ã—200 â†’ scale = min(400/200, 300/200) = min(2, 1.5) = 1.5
            // content = 200Ã—200, available = (400-300)=100Ã—(300-300)=0
            
            const testCases = [
                { pos: '0% 0%', expectedX: 0, expectedY: 0, name: 'left top' },
                { pos: '100% 100%', expectedX: 100, expectedY: 0, name: 'right bottom' },
                { pos: '50% 50%', expectedX: 50, expectedY: 0, name: 'center center' }
            ];
            
            testCases.forEach(testCase => {
                const result = resolveFittedContent(rect, logical, 'contain', testCase.pos);
                
                const tolerance = 0.1;
                const passed = 
                    Math.abs(result.padX - testCase.expectedX) < tolerance &&
                    Math.abs(result.padY - testCase.expectedY) < tolerance;
                
                addTestResult(
                    `object-position: ${testCase.pos} (${testCase.name})`,
                    passed,
                    `æœŸå¾…pad: (${testCase.expectedX}, ${testCase.expectedY})<br>` +
                    `å®Ÿéš›pad: (${result.padX.toFixed(2)}, ${result.padY.toFixed(2)})`
                );
            });
        }
        
        // findContainer ãƒ†ã‚¹ãƒˆç¾¤
        function testFindContainer() {
            console.group('ğŸ§ª findContainer Tests');
            
            // ãƒ†ã‚¹ãƒˆ 1: positionedè¦ªãŒã‚ã‚‹å ´åˆ
            testPositionedParent();
            
            // ãƒ†ã‚¹ãƒˆ 2: positionedè¦ªãŒãªã„å ´åˆ
            testNoPositionedParent();
            
            // ãƒ†ã‚¹ãƒˆ 3: è¤‡é›‘ãªãƒã‚¹ãƒˆæ§‹é€ 
            testNestedStructure();
            
            console.groupEnd();
        }
        
        function testPositionedParent() {
            const target = document.getElementById('nested-target');
            const container = findContainer(target);
            const expectedContainer = document.getElementById('positioned-parent');
            
            const passed = container === expectedContainer;
            
            addTestResult(
                'positionedè¦ªã®æ¤œå‡º',
                passed,
                `æœŸå¾…: ${expectedContainer.id}<br>` +
                `å®Ÿéš›: ${container.id || container.tagName}`
            );
        }
        
        function testNoPositionedParent() {
            const target = document.getElementById('no-positioned-target');
            const container = findContainer(target);
            
            const passed = container === document.body;
            
            addTestResult(
                'positionedè¦ªãªã—â†’body',
                passed,
                `æœŸå¾…: BODY<br>` +
                `å®Ÿéš›: ${container.tagName}`
            );
        }
        
        function testNestedStructure() {
            const target = document.getElementById('nested-target');
            const testResult = testNestedContainerSearch(target);
            
            // éšå±¤ãƒã‚§ãƒ¼ãƒ³æ¤œè¨¼
            const hasPositioned = testResult.hierarchyChain.some(item => item.isPositioned && item.element !== document.body);
            const correctContainer = testResult.selectedContainer.id === 'positioned-parent';
            
            const passed = hasPositioned && correctContainer;
            
            addTestResult(
                'è¤‡é›‘ãƒã‚¹ãƒˆæ§‹é€ è§£æ',
                passed,
                `éšå±¤æ•°: ${testResult.totalLevels}<br>` +
                `positionedæ¤œå‡º: ${hasPositioned}<br>` +
                `é¸æŠã‚³ãƒ³ãƒ†ãƒŠ: ${testResult.selectedContainer.id || testResult.selectedContainer.tagName}`
            );
        }
        
        // çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        function runAllTests() {
            clearResults();
            console.clear();
            
            console.log('ğŸš€ Observer Phase 0 - Full Unit Test Suite');
            
            testResolveFittedContent();
            testFindContainer();
            
            // çµæœã‚µãƒãƒªãƒ¼
            const totalTests = testResults.length;
            const passedTests = testResults.filter(r => r.passed).length;
            const failedTests = totalTests - passedTests;
            
            addTestResult(
                'ğŸ“Š ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼',
                failedTests === 0,
                `åˆè¨ˆ: ${totalTests}, æˆåŠŸ: ${passedTests}, å¤±æ•—: ${failedTests}<br>` +
                `æˆåŠŸç‡: ${((passedTests / totalTests) * 100).toFixed(1)}%`
            );
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
        window.runAllTests = runAllTests;
        window.clearResults = clearResults;
        window.testResolveFittedContent = testResolveFittedContent;
        window.testFindContainer = testFindContainer;
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«åŸºæœ¬æƒ…å ±è¡¨ç¤º
        document.addEventListener('DOMContentLoaded', () => {
            console.log('âœ… Observer Phase 0 Unit Tests loaded');
            console.log('ğŸ¯ Run: runAllTests() for full test suite');
            console.log('ğŸ” Debug: debugFittedContent(rect, logical, fit, pos, result)');
            console.log('ğŸ” Debug: debugCoordinateSystem(element)');
        });
    </script>
</body>
</html>