<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>🎯 CanvasResizeController v2.0 Phase 1 テスト</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      .subtitle {
        font-size: 1.2em;
        opacity: 0.9;
        margin-top: 10px;
      }

      .test-layout {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 30px;
        margin-top: 30px;
      }

      .canvas-area {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .canvas-container {
        position: relative;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        overflow: hidden;
        margin-bottom: 20px;
      }

      #test-canvas {
        border-radius: 15px;
        background: linear-gradient(45deg, #ff6b6b22, #4ecdc422);
        border: 2px dashed rgba(255, 255, 255, 0.3);
      }

      .canvas-info {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        border-radius: 10px;
        font-family: monospace;
        font-size: 0.9em;
        width: 100%;
        max-width: 400px;
      }

      /* ControlPanel スタイル */
      .canvas-resize-controller {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        height: fit-content;
      }

      .control-header h3 {
        margin: 0 0 15px 0;
        color: #ffd700;
      }

      .status-display {
        background: rgba(0, 0, 0, 0.2);
        padding: 8px 12px;
        border-radius: 5px;
        font-size: 0.9em;
        margin-bottom: 20px;
      }

      .control-section {
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .control-section.disabled {
        opacity: 0.5;
      }

      .control-section h4 {
        margin: 0 0 15px 0;
        color: #87ceeb;
        font-size: 1.1em;
      }

      .input-group {
        margin: 12px 0;
      }

      .input-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 0.9em;
        color: rgba(255, 255, 255, 0.9);
      }

      .input-group input {
        width: 100%;
        padding: 8px;
        border-radius: 5px;
        border: none;
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        font-size: 0.9em;
      }

      .input-group input[type="range"] {
        background: transparent;
        color: white;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
        flex: 1;
      }

      .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn.primary {
        background: linear-gradient(45deg, #ff6b6b, #ee5a52);
      }

      .btn.success {
        background: linear-gradient(45deg, #51cf66, #40c057);
      }

      .info-display {
        background: rgba(0, 0, 0, 0.3);
        padding: 12px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 0.8em;
        line-height: 1.4;
      }

      .log-area {
        background: rgba(0, 0, 0, 0.4);
        padding: 15px;
        border-radius: 10px;
        height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 0.8em;
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-top: 20px;
        white-space: pre-wrap;
      }

      /* Phase 1 インジケーター */
      .phase-indicator {
        background: linear-gradient(45deg, #51cf66, #40c057);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8em;
        display: inline-block;
        margin-left: 10px;
      }

      @media (max-width: 768px) {
        .test-layout {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- ヘッダー -->
      <div class="header">
        <h1>🎯 CanvasResizeController v2.0</h1>
        <div class="subtitle">
          統合編集機能付きCanvas制御マイクロモジュール
          <span class="phase-indicator">Phase 1 実装完了</span>
        </div>
      </div>

      <div class="test-layout">
        <!-- Canvas表示エリア -->
        <div class="canvas-area">
          <div class="canvas-container" id="canvas-container">
            <canvas id="test-canvas" width="400" height="400"></canvas>
          </div>
          
          <div class="canvas-info" id="external-canvas-info">
            <strong>📊 Canvas情報:</strong><br>
            <div id="external-info-content">読み込み待機中...</div>
          </div>
        </div>

        <!-- 操作パネル（ここに動的生成される） -->
        <div id="control-panel-container">
          <!-- CanvasResizeController.createControlPanel() で生成 -->
        </div>
      </div>

      <!-- ログエリア -->
      <div class="log-area" id="log-area"></div>
    </div>

    <!-- CanvasResizeController v2.0 -->
    <script src="micromodules/canvas-resize/CanvasResizeController.js"></script>

    <script>
      /**
       * 🎯 CanvasResizeController v2.0 Phase 1 テスト環境
       * 
       * Phase 1 実装機能:
       * ✅ Canvas解像度制御（正方形）
       * ✅ キャラクタースケール・位置調整
       * ✅ 基本UI操作パネル
       * ✅ 透明背景対応
       * ✅ 固定表示サイズ
       */
      class CanvasResizeControllerV2Test {
        constructor() {
          this.canvas = document.getElementById("test-canvas");
          this.logArea = document.getElementById("log-area");
          this.spineRenderer = null; // Phase 1では模擬実装
          
          // 模擬Spineキャラクター作成
          this.createMockSpineRenderer();
          
          // CanvasResizeController v2.0 インスタンス作成
          this.controller = new CanvasResizeController({
            canvas: this.canvas,
            spineRenderer: this.spineRenderer,
            onLog: (message) => this.addLog(message),
            onError: (message) => this.addLog(`🔴 ${message}`),
            enableLogging: true,
            config: {
              defaultSize: 400,
              fixedDisplaySize: 350,
              transparentBackground: true
            }
          });
          
          this.initializeTest();
        }

        /**
         * 🎭 模擬Spineキャラクター作成
         */
        createMockSpineRenderer() {
          // Phase 1テスト用の模擬オブジェクト
          this.spineRenderer = {
            skeleton: {
              scaleX: 1.0,
              scaleY: 1.0,
              x: 200,
              y: 200
            }
          };
          
          this.addLog('🎭 模擬Spineキャラクター作成完了（Phase 1テスト用）');
        }

        /**
         * 🚀 テスト環境初期化
         */
        initializeTest() {
          // 操作パネル作成
          const panelContainer = document.getElementById('control-panel-container');
          this.controller.createControlPanel(panelContainer);
          
          // 初期情報更新
          this.updateExternalInfo();
          
          // Canvas描画テスト
          this.drawTestPattern();
          
          // 定期的な情報更新
          setInterval(() => {
            this.updateExternalInfo();
            this.controller.updateInfo();
          }, 1000);
          
          this.addLog('🚀 CanvasResizeController v2.0 Phase 1 テスト環境 起動完了');
          this.addLog('✅ 実装済み: Canvas解像度制御・キャラクター制御・基本UI');
          this.addLog('📋 Phase 2予定: BB統合操作・統合ドラッグ・リサイズ');
        }

        /**
         * 🎨 Canvasテストパターン描画
         */
        drawTestPattern() {
          const ctx = this.canvas.getContext('2d');
          
          // 透明背景クリア
          ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
          
          // 中央十字線
          ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
          ctx.lineWidth = 1;
          ctx.setLineDash([5, 5]);
          
          const centerX = this.canvas.width / 2;
          const centerY = this.canvas.height / 2;
          
          ctx.beginPath();
          ctx.moveTo(centerX, 0);
          ctx.lineTo(centerX, this.canvas.height);
          ctx.moveTo(0, centerY);
          ctx.lineTo(this.canvas.width, centerY);
          ctx.stroke();
          
          // 模擬キャラクター位置表示
          if (this.spineRenderer && this.spineRenderer.skeleton) {
            const char = this.spineRenderer.skeleton;
            
            ctx.fillStyle = 'rgba(255, 107, 107, 0.7)';
            ctx.fillRect(char.x - 20 * char.scaleX, char.y - 20 * char.scaleY, 
                        40 * char.scaleX, 40 * char.scaleY);
            
            ctx.fillStyle = 'white';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('🐱', char.x, char.y + 5);
            
            // 情報表示
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.font = '10px monospace';
            ctx.textAlign = 'left';
            ctx.fillText(`Scale: ${char.scaleX.toFixed(1)}`, 10, 20);
            ctx.fillText(`Pos: (${Math.round(char.x)}, ${Math.round(char.y)})`, 10, 35);
          }
          
          // Canvas情報
          ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
          ctx.font = '10px monospace';
          ctx.textAlign = 'right';
          ctx.fillText(`Canvas: ${this.canvas.width}x${this.canvas.height}`, 
                      this.canvas.width - 10, this.canvas.height - 20);
          ctx.fillText(`Display: ${this.canvas.style.width} x ${this.canvas.style.height}`, 
                      this.canvas.width - 10, this.canvas.height - 10);
        }

        /**
         * 📊 外部情報表示更新
         */
        updateExternalInfo() {
          const infoContent = document.getElementById('external-info-content');
          if (!infoContent) return;

          const state = this.controller.getState();
          
          let info = `Canvas解像度: ${state.canvas.width}x${state.canvas.height}px\n`;
          info += `Canvas表示: ${state.canvas.displayWidth} x ${state.canvas.displayHeight}\n`;
          
          if (state.character) {
            info += `\n📍 キャラクター:\n`;
            info += `  スケール: ${state.character.scale.x.toFixed(1)}\n`;
            info += `  位置: (${Math.round(state.character.position.x)}, ${Math.round(state.character.position.y)})`;
          } else {
            info += `\n⚠️ キャラクター: 未読み込み`;
          }
          
          infoContent.textContent = info;
          
          // Canvas再描画
          this.drawTestPattern();
        }

        /**
         * 📋 ログ追加
         */
        addLog(message) {
          const timestamp = new Date().toLocaleTimeString();
          this.logArea.textContent += `[${timestamp}] ${message}\n`;
          this.logArea.scrollTop = this.logArea.scrollHeight;
        }
      }

      // 🚀 初期化
      document.addEventListener("DOMContentLoaded", () => {
        window.testController = new CanvasResizeControllerV2Test();
      });
    </script>
  </body>
</html>