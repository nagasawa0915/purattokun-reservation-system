<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº§æ¨™è¨ºæ–­ãƒ†ã‚¹ãƒˆï¼ˆè»½é‡ç‰ˆï¼‰</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .test-canvas {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 150px;
            background: #ffcccc;
            border: 2px solid #ff6666;
        }
        .bounding-box {
            position: absolute;
            border: 2px solid #66ff66;
            background: rgba(102, 255, 102, 0.2);
            display: none;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” åº§æ¨™è¨ºæ–­ãƒ†ã‚¹ãƒˆï¼ˆè»½é‡ç‰ˆï¼‰</h1>
    
    <div>
        <button onclick="testCoordinates()">åº§æ¨™ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <button onclick="showBoundingBox()">ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤º</button>
        <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
    </div>

    <div style="position: relative; width: 800px; height: 600px; border: 1px solid #ccc; margin: 20px 0;">
        <div id="testCanvas" class="test-canvas">ãƒ†ã‚¹ãƒˆCanvas</div>
        <div id="boundingBox" class="bounding-box"></div>
    </div>

    <div id="log" class="log">ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...\n</div>

    <script>
        let logDiv = document.getElementById('log');
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function testCoordinates() {
            addLog('=== åº§æ¨™ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            const canvas = document.getElementById('testCanvas');
            const rect = canvas.getBoundingClientRect();
            const parentRect = canvas.parentElement.getBoundingClientRect();
            
            // CSS borderå¹…ã‚’å–å¾—
            const computedStyle = getComputedStyle(canvas);
            const borderLeft = parseFloat(computedStyle.borderLeftWidth) || 0;
            const borderTop = parseFloat(computedStyle.borderTopWidth) || 0;
            const borderRight = parseFloat(computedStyle.borderRightWidth) || 0;
            const borderBottom = parseFloat(computedStyle.borderBottomWidth) || 0;
            
            // clientWidth/clientHeightï¼ˆborderå«ã¾ãªã„ç´”ç²‹ã‚µã‚¤ã‚ºï¼‰
            const clientWidth = canvas.clientWidth;
            const clientHeight = canvas.clientHeight;
            
            addLog(`Canvas rectï¼ˆborderå«ã‚€ï¼‰: left=${rect.left}, top=${rect.top}, width=${rect.width}, height=${rect.height}`);
            addLog(`Canvas border: left=${borderLeft}px, top=${borderTop}px, right=${borderRight}px, bottom=${borderBottom}px`);
            addLog(`Canvas clientï¼ˆborderå«ã¾ãªã„ï¼‰: width=${clientWidth}, height=${clientHeight}`);
            addLog(`Parent rect: left=${parentRect.left}, top=${parentRect.top}`);
            addLog(`ç›¸å¯¾ä½ç½®: x=${rect.left - parentRect.left}, y=${rect.top - parentRect.top}`);
            
            // Canvasä¸­å¤®ç‚¹è¨ˆç®—ï¼ˆborderè€ƒæ…®ï¼‰
            // æ–¹æ³•1: rectåº§æ¨™ + borderåˆ†èª¿æ•´
            const centerX1 = Math.round((rect.left + borderLeft + clientWidth / 2) * 100) / 100;
            const centerY1 = Math.round((rect.top + borderTop + clientHeight / 2) * 100) / 100;
            
            // æ–¹æ³•2: rectä¸­å¤®ã‹ã‚‰ç®—å‡ºï¼ˆå¾“æ¥æ–¹å¼ï¼‰
            const centerX2 = Math.round((rect.left + rect.width / 2) * 100) / 100;
            const centerY2 = Math.round((rect.top + rect.height / 2) * 100) / 100;
            
            addLog(`Canvasä¸­å¤®ç‚¹ï¼ˆborderè€ƒæ…®ç‰ˆï¼‰: x=${centerX1}, y=${centerY1}`);
            addLog(`Canvasä¸­å¤®ç‚¹ï¼ˆå¾“æ¥ç‰ˆï¼‰: x=${centerX2}, y=${centerY2}`);
            addLog(`å·®åˆ†: x=${Math.abs(centerX1 - centerX2)}, y=${Math.abs(centerY1 - centerY2)}`);
            
            // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½ç½®è¨ˆç®—ï¼ˆborderè€ƒæ…®ç‰ˆï¼‰
            const boundingWidth = 120;
            const boundingHeight = 90;
            const boundingLeft1 = Math.round((centerX1 - boundingWidth / 2) * 100) / 100;
            const boundingTop1 = Math.round((centerY1 - boundingHeight / 2) * 100) / 100;
            const boundingLeft2 = Math.round((centerX2 - boundingWidth / 2) * 100) / 100;
            const boundingTop2 = Math.round((centerY2 - boundingHeight / 2) * 100) / 100;
            
            addLog(`ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½ç½®ï¼ˆborderè€ƒæ…®ç‰ˆï¼‰: left=${boundingLeft1}, top=${boundingTop1}`);
            addLog(`ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½ç½®ï¼ˆå¾“æ¥ç‰ˆï¼‰: left=${boundingLeft2}, top=${boundingTop2}`);
            addLog(`ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚º: width=${boundingWidth}, height=${boundingHeight}`);
        }

        function showBoundingBox() {
            addLog('=== ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºãƒ†ã‚¹ãƒˆ ===');
            
            const canvas = document.getElementById('testCanvas');
            const boundingBox = document.getElementById('boundingBox');
            const rect = canvas.getBoundingClientRect();
            const parentRect = canvas.parentElement.getBoundingClientRect();
            
            // CSS borderå¹…ã‚’å–å¾—
            const computedStyle = getComputedStyle(canvas);
            const canvasBorderLeft = parseFloat(computedStyle.borderLeftWidth) || 0;
            const canvasBorderTop = parseFloat(computedStyle.borderTopWidth) || 0;
            
            // BoundingBox borderå¹…ã‚’å–å¾—
            const boundingBoxStyle = getComputedStyle(boundingBox);
            const boxBorderLeft = parseFloat(boundingBoxStyle.borderLeftWidth) || 0;
            const boxBorderTop = parseFloat(boundingBoxStyle.borderTopWidth) || 0;
            
            // clientã‚µã‚¤ã‚ºï¼ˆborderå«ã¾ãªã„ç´”ç²‹ã‚µã‚¤ã‚ºï¼‰
            const canvasClientWidth = canvas.clientWidth;
            const canvasClientHeight = canvas.clientHeight;
            
            // Canvasä¸­å¤®ç‚¹è¨ˆç®—ï¼ˆborderè€ƒæ…®ç‰ˆï¼‰
            const centerX = Math.round((rect.left + canvasBorderLeft + canvasClientWidth / 2) * 100) / 100;
            const centerY = Math.round((rect.top + canvasBorderTop + canvasClientHeight / 2) * 100) / 100;
            
            const boundingWidth = 120;
            const boundingHeight = 90;
            
            // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹å·¦ä¸Šåº§æ¨™è¨ˆç®—ï¼ˆborderè€ƒæ…®ï¼‰
            // Canvasä¸­å¤®ã‹ã‚‰ã€BoundingBoxã®ä¸­å¤®ï¼ˆclientã‚µã‚¤ã‚ºã®ä¸­å¤®ï¼‰ã¾ã§ã®è·é›¢ã‚’è¨ˆç®—
            const boxClientCenterX = boundingWidth / 2;  // clientWidthåŸºæº–ã®ä¸­å¤®
            const boxClientCenterY = boundingHeight / 2; // clientHeightåŸºæº–ã®ä¸­å¤®
            
            // çµ¶å¯¾åº§æ¨™ã§ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã®å·¦ä¸Šã‚’è¨ˆç®—
            const absoluteBoundingLeft = centerX - boxClientCenterX - boxBorderLeft;
            const absoluteBoundingTop = centerY - boxClientCenterY - boxBorderTop;
            
            // è¦ªè¦ç´ åŸºæº–ã®ç›¸å¯¾åº§æ¨™ã«å¤‰æ›
            const relativeLeft = Math.round((absoluteBoundingLeft - parentRect.left) * 100) / 100;
            const relativeTop = Math.round((absoluteBoundingTop - parentRect.top) * 100) / 100;
            
            addLog(`Canvas border: left=${canvasBorderLeft}px, top=${canvasBorderTop}px`);
            addLog(`Canvas client size: ${canvasClientWidth}x${canvasClientHeight}`);
            addLog(`Canvasä¸­å¤®åº§æ¨™ï¼ˆçµ¶å¯¾ãƒ»borderè€ƒæ…®ï¼‰: (${centerX}, ${centerY})`);
            addLog(`BoundingBox border: left=${boxBorderLeft}px, top=${boxBorderTop}px`);
            addLog(`ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹å·¦ä¸Šï¼ˆçµ¶å¯¾ãƒ»borderè€ƒæ…®ï¼‰: (${absoluteBoundingLeft}, ${absoluteBoundingTop})`);
            addLog(`è¦ªè¦ç´ åº§æ¨™: (${parentRect.left}, ${parentRect.top})`);
            addLog(`ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½ç½®ï¼ˆç›¸å¯¾ï¼‰: (${relativeLeft}, ${relativeTop})`);
            
            // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºï¼ˆæ•´æ•°ãƒ”ã‚¯ã‚»ãƒ«å€¤ã§è¨­å®šï¼‰
            boundingBox.style.left = Math.round(relativeLeft) + 'px';
            boundingBox.style.top = Math.round(relativeTop) + 'px';
            boundingBox.style.width = boundingWidth + 'px';
            boundingBox.style.height = boundingHeight + 'px';
            boundingBox.style.display = 'block';
            
            addLog('âœ… ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºå®Œäº†ï¼ˆborderè€ƒæ…®ç‰ˆï¼‰');
            
            // ä½ç½®æ¤œè¨¼ï¼ˆborderè€ƒæ…®ã®é«˜ç²¾åº¦æ¤œè¨¼ï¼‰
            setTimeout(() => {
                const newRect = boundingBox.getBoundingClientRect();
                
                // BoundingBoxã®ä¸­å¤®ç‚¹è¨ˆç®—ï¼ˆborderè€ƒæ…®ï¼‰
                const boxClientWidth = boundingBox.clientWidth;
                const boxClientHeight = boundingBox.clientHeight;
                const boxBorderLeftActual = parseFloat(getComputedStyle(boundingBox).borderLeftWidth) || 0;
                const boxBorderTopActual = parseFloat(getComputedStyle(boundingBox).borderTopWidth) || 0;
                
                const boxCenterX = Math.round((newRect.left + boxBorderLeftActual + boxClientWidth / 2) * 100) / 100;
                const boxCenterY = Math.round((newRect.top + boxBorderTopActual + boxClientHeight / 2) * 100) / 100;
                
                addLog(`æ¤œè¨¼: ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹å®Ÿéš›ã®rect = (${newRect.left}, ${newRect.top}, ${newRect.width}, ${newRect.height})`);
                addLog(`æ¤œè¨¼: ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ client size = ${boxClientWidth}x${boxClientHeight}`);
                addLog(`æ¤œè¨¼: ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä¸­å¤®ï¼ˆborderè€ƒæ…®ï¼‰ = (${boxCenterX}, ${boxCenterY})`);
                
                const deltaX = Math.round(Math.abs(boxCenterX - centerX) * 100) / 100;
                const deltaY = Math.round(Math.abs(boxCenterY - centerY) * 100) / 100;
                
                addLog(`æ¤œè¨¼: Canvasä¸­å¤®ã¨ã®å·® = (${deltaX}, ${deltaY})`);
                
                if (deltaX < 0.1 && deltaY < 0.1) {
                    addLog('âœ… åº§æ¨™è¨ˆç®—å®Œç’§: ä¸­å¤®ç‚¹ãŒå®Œå…¨ä¸€è‡´ï¼ˆèª¤å·®0.1pxæœªæº€ï¼‰');
                } else if (deltaX < 0.5 && deltaY < 0.5) {
                    addLog('âœ… åº§æ¨™è¨ˆç®—æ­£å¸¸: ä¸­å¤®ç‚¹ãŒä¸€è‡´ï¼ˆèª¤å·®0.5pxæœªæº€ï¼‰');
                } else if (deltaX < 1 && deltaY < 1) {
                    addLog('âš ï¸ åº§æ¨™è¨ˆç®—: ã‚ãšã‹ãªèª¤å·®ã‚ã‚Šï¼ˆ1pxæœªæº€ï¼‰');
                } else {
                    addLog('âŒ åº§æ¨™è¨ˆç®—ç•°å¸¸: ä¸­å¤®ç‚¹ãŒãšã‚Œã¦ã„ã¾ã™');
                    
                    // è©³ç´°è¨ºæ–­
                    addLog(`è©³ç´°è¨ºæ–­:`);
                    addLog(`  Canvas rect: ${rect.left}, ${rect.top}, ${rect.width}, ${rect.height}`);
                    addLog(`  Canvas borderè€ƒæ…®ä¸­å¤®: (${centerX}, ${centerY})`);
                    addLog(`  BoundingBox rect: ${newRect.left}, ${newRect.top}, ${newRect.width}, ${newRect.height}`);
                    addLog(`  BoundingBox borderè€ƒæ…®ä¸­å¤®: (${boxCenterX}, ${boxCenterY})`);
                    addLog(`  è¨ˆç®—å€¤ vs å®Ÿéš›å€¤ã®å·®: left=${Math.abs(absoluteBoundingLeft - newRect.left)}, top=${Math.abs(absoluteBoundingTop - newRect.top)}`);
                }
            }, 100);
        }

        function clearLog() {
            logDiv.textContent = 'ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...\n';
        }

        // åˆæœŸåŒ–
        window.addEventListener('load', () => {
            addLog('ğŸ¯ è»½é‡åº§æ¨™è¨ºæ–­ãƒ†ã‚¹ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
            addLog('ã€Œåº§æ¨™ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã§è¨ˆç®—éç¨‹ã‚’ç¢ºèªã§ãã¾ã™');
        });
    </script>
</body>
</html>