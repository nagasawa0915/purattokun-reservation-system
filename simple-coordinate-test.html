<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>座標診断テスト（軽量版）</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .test-canvas {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 150px;
            background: #ffcccc;
            border: 2px solid #ff6666;
        }
        .bounding-box {
            position: absolute;
            border: 2px solid #66ff66;
            background: rgba(102, 255, 102, 0.2);
            display: none;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>🔍 座標診断テスト（軽量版）</h1>
    
    <div>
        <button onclick="testCoordinates()">座標テスト実行</button>
        <button onclick="showBoundingBox()">バウンディングボックス表示</button>
        <button onclick="clearLog()">ログクリア</button>
    </div>

    <div style="position: relative; width: 800px; height: 600px; border: 1px solid #ccc; margin: 20px 0;">
        <div id="testCanvas" class="test-canvas">テストCanvas</div>
        <div id="boundingBox" class="bounding-box"></div>
    </div>

    <div id="log" class="log">ログがここに表示されます...\n</div>

    <script>
        let logDiv = document.getElementById('log');
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function testCoordinates() {
            addLog('=== 座標テスト開始 ===');
            
            const canvas = document.getElementById('testCanvas');
            const rect = canvas.getBoundingClientRect();
            const parentRect = canvas.parentElement.getBoundingClientRect();
            
            // CSS border幅を取得
            const computedStyle = getComputedStyle(canvas);
            const borderLeft = parseFloat(computedStyle.borderLeftWidth) || 0;
            const borderTop = parseFloat(computedStyle.borderTopWidth) || 0;
            const borderRight = parseFloat(computedStyle.borderRightWidth) || 0;
            const borderBottom = parseFloat(computedStyle.borderBottomWidth) || 0;
            
            // clientWidth/clientHeight（border含まない純粋サイズ）
            const clientWidth = canvas.clientWidth;
            const clientHeight = canvas.clientHeight;
            
            addLog(`Canvas rect（border含む）: left=${rect.left}, top=${rect.top}, width=${rect.width}, height=${rect.height}`);
            addLog(`Canvas border: left=${borderLeft}px, top=${borderTop}px, right=${borderRight}px, bottom=${borderBottom}px`);
            addLog(`Canvas client（border含まない）: width=${clientWidth}, height=${clientHeight}`);
            addLog(`Parent rect: left=${parentRect.left}, top=${parentRect.top}`);
            addLog(`相対位置: x=${rect.left - parentRect.left}, y=${rect.top - parentRect.top}`);
            
            // Canvas中央点計算（border考慮）
            // 方法1: rect座標 + border分調整
            const centerX1 = Math.round((rect.left + borderLeft + clientWidth / 2) * 100) / 100;
            const centerY1 = Math.round((rect.top + borderTop + clientHeight / 2) * 100) / 100;
            
            // 方法2: rect中央から算出（従来方式）
            const centerX2 = Math.round((rect.left + rect.width / 2) * 100) / 100;
            const centerY2 = Math.round((rect.top + rect.height / 2) * 100) / 100;
            
            addLog(`Canvas中央点（border考慮版）: x=${centerX1}, y=${centerY1}`);
            addLog(`Canvas中央点（従来版）: x=${centerX2}, y=${centerY2}`);
            addLog(`差分: x=${Math.abs(centerX1 - centerX2)}, y=${Math.abs(centerY1 - centerY2)}`);
            
            // バウンディングボックス位置計算（border考慮版）
            const boundingWidth = 120;
            const boundingHeight = 90;
            const boundingLeft1 = Math.round((centerX1 - boundingWidth / 2) * 100) / 100;
            const boundingTop1 = Math.round((centerY1 - boundingHeight / 2) * 100) / 100;
            const boundingLeft2 = Math.round((centerX2 - boundingWidth / 2) * 100) / 100;
            const boundingTop2 = Math.round((centerY2 - boundingHeight / 2) * 100) / 100;
            
            addLog(`バウンディングボックス位置（border考慮版）: left=${boundingLeft1}, top=${boundingTop1}`);
            addLog(`バウンディングボックス位置（従来版）: left=${boundingLeft2}, top=${boundingTop2}`);
            addLog(`バウンディングボックスサイズ: width=${boundingWidth}, height=${boundingHeight}`);
        }

        function showBoundingBox() {
            addLog('=== バウンディングボックス表示テスト ===');
            
            const canvas = document.getElementById('testCanvas');
            const boundingBox = document.getElementById('boundingBox');
            const rect = canvas.getBoundingClientRect();
            const parentRect = canvas.parentElement.getBoundingClientRect();
            
            // CSS border幅を取得
            const computedStyle = getComputedStyle(canvas);
            const canvasBorderLeft = parseFloat(computedStyle.borderLeftWidth) || 0;
            const canvasBorderTop = parseFloat(computedStyle.borderTopWidth) || 0;
            
            // BoundingBox border幅を取得
            const boundingBoxStyle = getComputedStyle(boundingBox);
            const boxBorderLeft = parseFloat(boundingBoxStyle.borderLeftWidth) || 0;
            const boxBorderTop = parseFloat(boundingBoxStyle.borderTopWidth) || 0;
            
            // clientサイズ（border含まない純粋サイズ）
            const canvasClientWidth = canvas.clientWidth;
            const canvasClientHeight = canvas.clientHeight;
            
            // Canvas中央点計算（border考慮版）
            const centerX = Math.round((rect.left + canvasBorderLeft + canvasClientWidth / 2) * 100) / 100;
            const centerY = Math.round((rect.top + canvasBorderTop + canvasClientHeight / 2) * 100) / 100;
            
            const boundingWidth = 120;
            const boundingHeight = 90;
            
            // バウンディングボックス左上座標計算（border考慮）
            // Canvas中央から、BoundingBoxの中央（clientサイズの中央）までの距離を計算
            const boxClientCenterX = boundingWidth / 2;  // clientWidth基準の中央
            const boxClientCenterY = boundingHeight / 2; // clientHeight基準の中央
            
            // 絶対座標でバウンディングボックスの左上を計算
            const absoluteBoundingLeft = centerX - boxClientCenterX - boxBorderLeft;
            const absoluteBoundingTop = centerY - boxClientCenterY - boxBorderTop;
            
            // 親要素基準の相対座標に変換
            const relativeLeft = Math.round((absoluteBoundingLeft - parentRect.left) * 100) / 100;
            const relativeTop = Math.round((absoluteBoundingTop - parentRect.top) * 100) / 100;
            
            addLog(`Canvas border: left=${canvasBorderLeft}px, top=${canvasBorderTop}px`);
            addLog(`Canvas client size: ${canvasClientWidth}x${canvasClientHeight}`);
            addLog(`Canvas中央座標（絶対・border考慮）: (${centerX}, ${centerY})`);
            addLog(`BoundingBox border: left=${boxBorderLeft}px, top=${boxBorderTop}px`);
            addLog(`バウンディングボックス左上（絶対・border考慮）: (${absoluteBoundingLeft}, ${absoluteBoundingTop})`);
            addLog(`親要素座標: (${parentRect.left}, ${parentRect.top})`);
            addLog(`バウンディングボックス位置（相対）: (${relativeLeft}, ${relativeTop})`);
            
            // バウンディングボックス表示（整数ピクセル値で設定）
            boundingBox.style.left = Math.round(relativeLeft) + 'px';
            boundingBox.style.top = Math.round(relativeTop) + 'px';
            boundingBox.style.width = boundingWidth + 'px';
            boundingBox.style.height = boundingHeight + 'px';
            boundingBox.style.display = 'block';
            
            addLog('✅ バウンディングボックス表示完了（border考慮版）');
            
            // 位置検証（border考慮の高精度検証）
            setTimeout(() => {
                const newRect = boundingBox.getBoundingClientRect();
                
                // BoundingBoxの中央点計算（border考慮）
                const boxClientWidth = boundingBox.clientWidth;
                const boxClientHeight = boundingBox.clientHeight;
                const boxBorderLeftActual = parseFloat(getComputedStyle(boundingBox).borderLeftWidth) || 0;
                const boxBorderTopActual = parseFloat(getComputedStyle(boundingBox).borderTopWidth) || 0;
                
                const boxCenterX = Math.round((newRect.left + boxBorderLeftActual + boxClientWidth / 2) * 100) / 100;
                const boxCenterY = Math.round((newRect.top + boxBorderTopActual + boxClientHeight / 2) * 100) / 100;
                
                addLog(`検証: バウンディングボックス実際のrect = (${newRect.left}, ${newRect.top}, ${newRect.width}, ${newRect.height})`);
                addLog(`検証: バウンディングボックス client size = ${boxClientWidth}x${boxClientHeight}`);
                addLog(`検証: バウンディングボックス中央（border考慮） = (${boxCenterX}, ${boxCenterY})`);
                
                const deltaX = Math.round(Math.abs(boxCenterX - centerX) * 100) / 100;
                const deltaY = Math.round(Math.abs(boxCenterY - centerY) * 100) / 100;
                
                addLog(`検証: Canvas中央との差 = (${deltaX}, ${deltaY})`);
                
                if (deltaX < 0.1 && deltaY < 0.1) {
                    addLog('✅ 座標計算完璧: 中央点が完全一致（誤差0.1px未満）');
                } else if (deltaX < 0.5 && deltaY < 0.5) {
                    addLog('✅ 座標計算正常: 中央点が一致（誤差0.5px未満）');
                } else if (deltaX < 1 && deltaY < 1) {
                    addLog('⚠️ 座標計算: わずかな誤差あり（1px未満）');
                } else {
                    addLog('❌ 座標計算異常: 中央点がずれています');
                    
                    // 詳細診断
                    addLog(`詳細診断:`);
                    addLog(`  Canvas rect: ${rect.left}, ${rect.top}, ${rect.width}, ${rect.height}`);
                    addLog(`  Canvas border考慮中央: (${centerX}, ${centerY})`);
                    addLog(`  BoundingBox rect: ${newRect.left}, ${newRect.top}, ${newRect.width}, ${newRect.height}`);
                    addLog(`  BoundingBox border考慮中央: (${boxCenterX}, ${boxCenterY})`);
                    addLog(`  計算値 vs 実際値の差: left=${Math.abs(absoluteBoundingLeft - newRect.left)}, top=${Math.abs(absoluteBoundingTop - newRect.top)}`);
                }
            }, 100);
        }

        function clearLog() {
            logDiv.textContent = 'ログがここに表示されます...\n';
        }

        // 初期化
        window.addEventListener('load', () => {
            addLog('🎯 軽量座標診断テスト読み込み完了');
            addLog('「座標テスト実行」ボタンで計算過程を確認できます');
        });
    </script>
</body>
</html>