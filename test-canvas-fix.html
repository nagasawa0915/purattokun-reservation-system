<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvaså•é¡Œä¿®æ­£ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { margin: 20px; font-family: Arial, sans-serif; }
        .test-container {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
        }
        .canvas-container {
            position: relative;
            width: 400px;
            height: 300px;
            margin: 20px auto;
            border: 2px solid blue;
            background: #f0f0f0;
        }
        .test-canvas {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid red;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            background: #007cba;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #e8f4fd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Canvaså•é¡Œä¿®æ­£ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-container">
        <h2>ãƒ†ã‚¹ãƒˆ1: Canvasä½œæˆã¨åŸºæœ¬æç”»</h2>
        <div class="canvas-container">
            <canvas id="test1" class="test-canvas" width="100" height="100"></canvas>
        </div>
        <button onclick="test1Draw()">Canvas 2Dæç”»ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="test1WebGL()">WebGLæç”»ãƒ†ã‚¹ãƒˆ</button>
        <div class="result" id="result1">çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>
    
    <div class="test-container">
        <h2>ãƒ†ã‚¹ãƒˆ2: CSS ã‚µã‚¤ã‚ºæ˜ç¤º</h2>
        <div class="canvas-container">
            <canvas id="test2" class="test-canvas" width="100" height="100" style="width: 100px; height: 100px;"></canvas>
        </div>
        <button onclick="test2Draw()">æç”»ãƒ†ã‚¹ãƒˆ</button>
        <div class="result" id="result2">çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>
    
    <div class="test-container">
        <h2>ãƒ†ã‚¹ãƒˆ3: å‹•çš„ã‚µã‚¤ã‚ºè¨­å®š</h2>
        <div class="canvas-container">
            <canvas id="test3" class="test-canvas"></canvas>
        </div>
        <button onclick="test3Setup()">å‹•çš„ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</button>
        <button onclick="test3Draw()">æç”»ãƒ†ã‚¹ãƒˆ</button>
        <div class="result" id="result3">çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>
    
    <div class="test-container">
        <h2>ãƒ†ã‚¹ãƒˆ4: Spineçµ±åˆãƒ†ã‚¹ãƒˆ</h2>
        <div class="canvas-container">
            <canvas id="test4" class="test-canvas"></canvas>
        </div>
        <button onclick="test4Setup()">Spineã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</button>
        <button onclick="test4Fallback()">ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º</button>
        <div class="result" id="result4">çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
        
        <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒ -->
        <img src="assets/images/purattokunn.png" 
             id="fallback4" 
             style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; display: none; border: 2px solid orange;">
    </div>

    <!-- Spine WebGL Runtime -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.*/dist/iife/spine-webgl.js"></script>
    
    <script>
        function updateResult(id, message) {
            document.getElementById(id).innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
        }
        
        // ãƒ†ã‚¹ãƒˆ1: åŸºæœ¬Canvasæç”»
        function test1Draw() {
            const canvas = document.getElementById('test1');
            const ctx = canvas.getContext('2d');
            
            console.log('Test1 Canvas info:', {
                width: canvas.width,
                height: canvas.height,
                clientWidth: canvas.clientWidth,
                clientHeight: canvas.clientHeight
            });
            
            // èƒŒæ™¯ã‚’ã‚¯ãƒªã‚¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // èƒŒæ™¯è‰²
            ctx.fillStyle = 'yellow';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // èµ¤ã„å††
            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.arc(50, 50, 30, 0, 2 * Math.PI);
            ctx.fill();
            
            // ãƒ†ã‚­ã‚¹ãƒˆ
            ctx.fillStyle = 'black';
            ctx.font = '12px Arial';
            ctx.fillText('TEST1', 35, 55);
            
            updateResult('result1', 'âœ… Canvas 2Dæç”»å®Œäº†ï¼ˆé»„è‰²èƒŒæ™¯+èµ¤ã„å††ãŒè¦‹ãˆã¾ã™ã‹ï¼Ÿï¼‰');
        }
        
        function test1WebGL() {
            const canvas = document.getElementById('test1');
            const gl = canvas.getContext('webgl', { alpha: false });
            
            if (!gl) {
                updateResult('result1', 'âŒ WebGLæœªå¯¾å¿œ');
                return;
            }
            
            // ç·‘è‰²ã§ã‚¯ãƒªã‚¢
            gl.clearColor(0.0, 1.0, 0.0, 1.0);
            gl.clear(gl.COLOR_BUFFER_BIT);
            
            updateResult('result1', 'âœ… WebGLæç”»å®Œäº†ï¼ˆç·‘è‰²ãŒè¦‹ãˆã¾ã™ã‹ï¼Ÿï¼‰');
        }
        
        // ãƒ†ã‚¹ãƒˆ2: CSS ã‚µã‚¤ã‚ºæ˜ç¤º
        function test2Draw() {
            const canvas = document.getElementById('test2');
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = 'blue';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = 'white';
            ctx.font = '14px Arial';
            ctx.fillText('TEST2', 30, 55);
            
            updateResult('result2', 'âœ… CSSæ˜ç¤ºæç”»å®Œäº†ï¼ˆé’è‰²èƒŒæ™¯ãŒè¦‹ãˆã¾ã™ã‹ï¼Ÿï¼‰');
        }
        
        // ãƒ†ã‚¹ãƒˆ3: å‹•çš„ã‚µã‚¤ã‚ºè¨­å®š
        function test3Setup() {
            const canvas = document.getElementById('test3');
            
            // å‹•çš„ã«ã‚µã‚¤ã‚ºã‚’è¨­å®š
            canvas.width = 120;
            canvas.height = 120;
            canvas.style.width = '120px';
            canvas.style.height = '120px';
            
            updateResult('result3', 'âœ… å‹•çš„ã‚µã‚¤ã‚ºè¨­å®šå®Œäº† (120x120)');
        }
        
        function test3Draw() {
            const canvas = document.getElementById('test3');
            const ctx = canvas.getContext('2d');
            
            // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, 'purple');
            gradient.addColorStop(1, 'pink');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = 'white';
            ctx.font = '16px Arial';
            ctx.fillText('TEST3', 40, 65);
            
            updateResult('result3', 'âœ… å‹•çš„Canvasæç”»å®Œäº†ï¼ˆç´«â†’ãƒ”ãƒ³ã‚¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ãˆã¾ã™ã‹ï¼Ÿï¼‰');
        }
        
        // ãƒ†ã‚¹ãƒˆ4: Spineçµ±åˆ
        async function test4Setup() {
            try {
                const canvas = document.getElementById('test4');
                
                // ã‚µã‚¤ã‚ºè¨­å®š
                canvas.width = 100;
                canvas.height = 100;
                canvas.style.width = '100px';
                canvas.style.height = '100px';
                
                const gl = canvas.getContext('webgl', { alpha: true });
                if (!gl) {
                    throw new Error('WebGLæœªå¯¾å¿œ');
                }
                
                updateResult('result4', 'ğŸ”„ Spineèª­ã¿è¾¼ã¿ä¸­...');
                
                // ã‚¢ã‚»ãƒƒãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
                const basePath = 'assets/spine/characters/purattokun/';
                const assetManager = new spine.AssetManager(gl, basePath);
                assetManager.loadTextureAtlas('purattokun.atlas');
                assetManager.loadJson('purattokun.json');
                
                // ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å¾…ã¡
                await new Promise((resolve, reject) => {
                    let checkCount = 0;
                    const maxChecks = 50;
                    
                    const checkAssets = () => {
                        checkCount++;
                        if (assetManager.isLoadingComplete()) {
                            resolve();
                        } else if (checkCount > maxChecks) {
                            reject(new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
                        } else {
                            setTimeout(checkAssets, 100);
                        }
                    };
                    checkAssets();
                });
                
                // Spineè¨­å®š
                const atlas = assetManager.get('purattokun.atlas');
                const atlasLoader = new spine.AtlasAttachmentLoader(atlas);
                const skeletonJson = new spine.SkeletonJson(atlasLoader);
                const skeletonData = skeletonJson.readSkeletonData(assetManager.get('purattokun.json'));
                
                const skeleton = new spine.Skeleton(skeletonData);
                skeleton.x = canvas.width / 2;
                skeleton.y = canvas.height / 2;
                skeleton.scaleX = skeleton.scaleY = 2.0;  // å¤§ããªã‚¹ã‚±ãƒ¼ãƒ«
                
                const animationStateData = new spine.AnimationStateData(skeleton.data);
                const animationState = new spine.AnimationState(animationStateData);
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
                if (skeleton.data.findAnimation('taiki')) {
                    animationState.setAnimation(0, 'taiki', true);
                }
                
                // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼
                const renderer = new spine.SceneRenderer(canvas, gl);
                let lastTime = Date.now() / 1000;
                
                function render() {
                    const now = Date.now() / 1000;
                    const delta = now - lastTime;
                    lastTime = now;
                    
                    animationState.update(delta);
                    animationState.apply(skeleton);
                    skeleton.updateWorldTransform();
                    
                    gl.clearColor(0, 0, 0, 0);
                    gl.clear(gl.COLOR_BUFFER_BIT);
                    gl.viewport(0, 0, canvas.width, canvas.height);
                    
                    renderer.begin();
                    renderer.drawSkeleton(skeleton, true);
                    renderer.end();
                    
                    requestAnimationFrame(render);
                }
                
                render();
                updateResult('result4', 'âœ… SpineåˆæœŸåŒ–æˆåŠŸï¼ˆã·ã‚‰ã£ã¨ãã‚“ãŒè¦‹ãˆã¾ã™ã‹ï¼Ÿï¼‰');
                
            } catch (error) {
                updateResult('result4', 'âŒ SpineåˆæœŸåŒ–å¤±æ•—: ' + error.message);
            }
        }
        
        function test4Fallback() {
            const canvas = document.getElementById('test4');
            const fallback = document.getElementById('fallback4');
            
            canvas.style.display = 'none';
            fallback.style.display = 'block';
            
            updateResult('result4', 'âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒè¡¨ç¤ºä¸­');
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®è‡ªå‹•ãƒ†ã‚¹ãƒˆ
        window.addEventListener('load', () => {
            console.log('Canvasä¿®æ­£ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
        });
    </script>
</body>
</html>