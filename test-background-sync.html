<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>背景同期診断テスト</title>
    <style>
        .test-container {
            width: 80%;
            height: 400px;
            margin: 20px auto;
            position: relative;
            background: url('assets/images/nekohouse_02.webp') no-repeat center center;
            background-size: cover;
            border: 2px solid #333;
        }
        
        .test-character {
            position: absolute;
            left: 35%;
            top: 75%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            background: #ff6b6b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .mobile-character {
            left: 50%;
            top: 65%;
        }
        
        .controls {
            text-align: center;
            margin: 20px;
        }
        
        .controls button {
            margin: 10px;
            padding: 10px 20px;
            background: #007cba;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .results {
            margin: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
            font-family: monospace;
        }
        
        @media (max-width: 768px) {
            .test-character {
                left: 50%;
                top: 65%;
            }
        }
    </style>
</head>
<body>
    <h1>背景同期診断テスト</h1>
    
    <div class="test-container">
        <div class="test-character" id="test-character">
            テスト<br>キャラ
        </div>
    </div>
    
    <div class="controls">
        <button onclick="runMatrixTransformTest()">Matrix Transform解析</button>
        <button onclick="runViewportConversionTest()">Viewport変換テスト</button>
        <button onclick="runBackgroundSyncTest()">背景同期診断</button>
        <button onclick="clearResults()">結果クリア</button>
    </div>
    
    <div class="results" id="test-results">
        テスト結果がここに表示されます
    </div>

    <script>
        function log(message) {
            const results = document.getElementById('test-results');
            results.innerHTML += message + '<br>';
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = 'テスト結果がここに表示されます';
        }
        
        function runMatrixTransformTest() {
            log('=== Matrix Transform解析テスト開始 ===');
            
            const character = document.getElementById('test-character');
            const computedStyle = window.getComputedStyle(character);
            const transformStr = computedStyle.transform;
            
            log('Transform値: ' + transformStr);
            
            const matrixMatch = transformStr.match(/matrix\(([\d\s,.-]+)\)/);
            if (matrixMatch) {
                const values = matrixMatch[1].split(',').map(v => parseFloat(v.trim()));
                const translateX = values[4];
                const translateY = values[5];
                
                log('Matrix分析結果:');
                log('  translateX: ' + translateX + 'px');
                log('  translateY: ' + translateY + 'px');
                
                const rect = character.getBoundingClientRect();
                log('要素サイズ:');
                log('  width: ' + rect.width + 'px');
                log('  height: ' + rect.height + 'px');
                
                // translate(-50%, -50%)チェック
                const halfWidth = rect.width / 2;
                const halfHeight = rect.height / 2;
                
                if (Math.abs(Math.abs(translateX) - halfWidth) < 5) {
                    log('✅ translateX(-50%)が正常に検出されました');
                } else {
                    log('❌ translateX(-50%)が異常です');
                }
                
                if (Math.abs(Math.abs(translateY) - halfHeight) < 5) {
                    log('✅ translateY(-50%)が正常に検出されました');
                } else {
                    log('❌ translateY(-50%)が異常です');
                }
            } else {
                log('❌ Matrix形式のtransformが見つかりません');
            }
            
            log('=== Matrix Transform解析テスト完了 ===');
        }
        
        function runViewportConversionTest() {
            log('=== Viewport変換テスト開始 ===');
            
            const character = document.getElementById('test-character');
            const parent = character.parentElement;
            
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const parentRect = parent.getBoundingClientRect();
            
            log('画面サイズ: ' + viewportWidth + 'x' + viewportHeight);
            log('親要素サイズ: ' + parentRect.width + 'x' + parentRect.height);
            
            // 35vw, 75vhをパーセンテージに変換
            const vwValue = 35;
            const vhValue = 75;
            
            const parentPercentX = (vwValue * viewportWidth / 100) / parentRect.width * 100;
            const parentPercentY = (vhValue * viewportHeight / 100) / parentRect.height * 100;
            
            log('変換結果:');
            log('  35vw → ' + parentPercentX.toFixed(2) + '%');
            log('  75vh → ' + parentPercentY.toFixed(2) + '%');
            
            // 現在の位置と比較
            const computedStyle = window.getComputedStyle(character);
            const currentLeft = parseFloat(computedStyle.left.replace('%', ''));
            const currentTop = parseFloat(computedStyle.top.replace('%', ''));
            
            log('現在の位置: ' + currentLeft + '%, ' + currentTop + '%');
            log('差分: left=' + Math.abs(currentLeft - parentPercentX).toFixed(2) + 
                '%, top=' + Math.abs(currentTop - parentPercentY).toFixed(2) + '%');
            
            log('=== Viewport変換テスト完了 ===');
        }
        
        function runBackgroundSyncTest() {
            log('=== 背景同期診断テスト開始 ===');
            
            const character = document.getElementById('test-character');
            const parent = character.parentElement;
            
            // 背景画像情報
            const computedStyle = window.getComputedStyle(parent);
            const backgroundImage = computedStyle.backgroundImage;
            const backgroundPosition = computedStyle.backgroundPosition;
            const backgroundSize = computedStyle.backgroundSize;
            
            log('背景画像設定:');
            log('  image: ' + backgroundImage);
            log('  position: ' + backgroundPosition);
            log('  size: ' + backgroundSize);
            
            // キャラクター位置情報
            const charRect = character.getBoundingClientRect();
            const parentRect = parent.getBoundingClientRect();
            
            const relativeX = ((charRect.left + charRect.width/2 - parentRect.left) / parentRect.width * 100).toFixed(2);
            const relativeY = ((charRect.top + charRect.height/2 - parentRect.top) / parentRect.height * 100).toFixed(2);
            
            log('キャラクター位置:');
            log('  親要素内での位置: ' + relativeX + '%, ' + relativeY + '%');
            log('  画面上の位置: ' + charRect.left + ', ' + charRect.top);
            
            // レスポンシブ対応チェック
            const isMobile = window.innerWidth <= 768;
            log('レスポンシブ状態: ' + (isMobile ? 'モバイル' : 'デスクトップ'));
            
            log('=== 背景同期診断テスト完了 ===');
        }
        
        // ページ読み込み時に初期情報表示
        window.addEventListener('load', function() {
            log('背景同期診断テストページが読み込まれました');
            log('各ボタンをクリックしてテストを実行してください');
        });
        
        // リサイズ時の動作確認
        window.addEventListener('resize', function() {
            log('--- リサイズイベント発生 ---');
            log('新しい画面サイズ: ' + window.innerWidth + 'x' + window.innerHeight);
        });
    </script>
</body>
</html>