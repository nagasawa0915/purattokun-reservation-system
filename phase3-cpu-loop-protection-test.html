<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 3: CPU無限ループ対策テスト</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .test-container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            margin: 20px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button { 
            background: #3742fa; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px 10px 5px 0; 
            font-size: 14px;
        }
        .test-button:hover { 
            background: #2f32ff; 
        }
        .danger-button { 
            background: #ff4757; 
        }
        .danger-button:hover { 
            background: #ff3838; 
        }
        .success-button { 
            background: #2ed573; 
        }
        .success-button:hover { 
            background: #17c555; 
        }
        .warning-button { 
            background: #ffa502; 
        }
        .warning-button:hover { 
            background: #ff9500; 
        }
        .status-panel { 
            background: #f8f9fa; 
            padding: 15px; 
            border-left: 4px solid #3742fa; 
            margin: 10px 0; 
            border-radius: 0 5px 5px 0;
        }
        .dashboard { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin: 20px 0; 
        }
        .metric-card { 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            border-left: 4px solid #2ed573; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .metric-value { 
            font-size: 24px; 
            font-weight: bold; 
            color: #2ed573; 
        }
        .metric-label { 
            color: #666; 
            font-size: 14px; 
            margin-top: 5px; 
        }
        .console-output { 
            background: #1e1e1e; 
            color: #fff; 
            padding: 15px; 
            border-radius: 5px; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            max-height: 400px; 
            overflow-y: auto; 
            margin: 10px 0;
        }
        .log-entry { 
            margin: 2px 0; 
            padding: 2px 0; 
        }
        .log-error { color: #ff4757; }
        .log-warn { color: #ffa502; }
        .log-success { color: #2ed573; }
        .log-info { color: #3742fa; }
        h1 { color: #333; text-align: center; }
        h2 { color: #3742fa; border-bottom: 2px solid #3742fa; padding-bottom: 10px; }
        .code-snippet { 
            background: #f8f9fa; 
            padding: 10px; 
            border-left: 4px solid #ffa502; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            margin: 10px 0; 
            border-radius: 0 5px 5px 0;
        }
    </style>
</head>
<body>
    <h1>🚨 Phase 3: CPU無限ループ対策システム テスト環境</h1>
    
    <div class="test-container">
        <h2>📊 リアルタイム監視ダッシュボード</h2>
        <div id="dashboard" class="dashboard">
            <div class="metric-card">
                <div class="metric-value" id="cpu-usage">0%</div>
                <div class="metric-label">CPU使用率推定</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="loop-count">0</div>
                <div class="metric-label">ループ検出数</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="brake-status">無効</div>
                <div class="metric-label">緊急ブレーキ</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="total-logs">0</div>
                <div class="metric-label">総ログ数</div>
            </div>
        </div>
        
        <div class="status-panel" id="system-status">
            システム初期化中...
        </div>
    </div>

    <div class="test-container">
        <h2>🔧 基本機能テスト</h2>
        <button class="test-button success-button" onclick="testBasicFunctions()">
            ✅ 基本機能動作確認
        </button>
        <button class="test-button" onclick="startCPUMonitoring()">
            ⚡ CPU監視開始
        </button>
        <button class="test-button warning-button" onclick="stopCPUMonitoring()">
            ⏹️ CPU監視停止
        </button>
        <button class="test-button" onclick="enableEmergencyBrake()">
            🚨 緊急ブレーキ有効化
        </button>
        <button class="test-button success-button" onclick="performHealthCheck()">
            🏥 ヘルスチェック実行
        </button>
    </div>

    <div class="test-container">
        <h2>⚠️ 危険パターン検出テスト</h2>
        <button class="test-button warning-button" onclick="testDangerousPatterns()">
            🔍 危険コードパターン検出
        </button>
        <button class="test-button danger-button" onclick="testWhileAsyncPattern()">
            🚨 while+async問題再現
        </button>
        <button class="test-button danger-button" onclick="testHighFrequencyLoop()">
            🔄 高頻度ループ問題再現
        </button>
        
        <div class="code-snippet" id="dangerous-code-example">
            検出対象の危険コード例:
            <br>while (condition) { await someAsyncFunction(); }
            <br>setInterval(heavyFunction, 5); // 5ms間隔
            <br>for (let i = 0; i < 1000000; i++) { /* heavy sync work */ }
        </div>
    </div>

    <div class="test-container">
        <h2>🔄 無限ループ検出テスト</h2>
        <button class="test-button warning-button" onclick="testInfiniteLoopDetection()">
            🔍 無限ループ検出テスト
        </button>
        <button class="test-button danger-button" onclick="simulateInfiniteLoop()">
            🚨 無限ループシミュレート（安全版）
        </button>
        <button class="test-button danger-button" onclick="simulateLoadingCompleteLoop()">
            🔄 isLoadingComplete無限ループ再現
        </button>
    </div>

    <div class="test-container">
        <h2>📋 ログ・コンソール出力</h2>
        <button class="test-button" onclick="clearConsoleOutput()">
            🧹 表示クリア
        </button>
        <button class="test-button success-button" onclick="updateDashboard()">
            🔄 ダッシュボード更新
        </button>
        <div id="console-output" class="console-output">
            <!-- ログ出力がここに表示される -->
        </div>
    </div>

    <!-- ConsoleManager読み込み -->
    <script src="assets/js/console-manager.js"></script>
    
    <script>
        // ==============================
        // Phase 3 テスト制御システム
        // ==============================
        
        let testState = {
            cpuMonitoringActive: false,
            emergencyBrakeActive: false,
            infiniteLoopCount: 0,
            totalLogs: 0
        };

        // ダッシュボード更新
        function updateDashboard() {
            const dashboard = ConsoleManager.getPerformanceDashboard();
            
            document.getElementById('cpu-usage').textContent = 
                dashboard.cpuMonitoring.currentCPU.toFixed(1) + '%';
            document.getElementById('loop-count').textContent = 
                dashboard.infiniteLoopDetection.monitored;
            document.getElementById('brake-status').textContent = 
                dashboard.emergencyBrake.enabled ? '有効' : '無効';
            document.getElementById('total-logs').textContent = 
                dashboard.statistics.totalLogs;
                
            // ダッシュボードの色を状態に応じて変更
            const cpuCard = document.getElementById('cpu-usage').parentElement;
            const cpuValue = dashboard.cpuMonitoring.currentCPU;
            if (cpuValue > 20) {
                cpuCard.style.borderLeftColor = '#ff4757';
                document.getElementById('cpu-usage').style.color = '#ff4757';
            } else if (cpuValue > 15) {
                cpuCard.style.borderLeftColor = '#ffa502';
                document.getElementById('cpu-usage').style.color = '#ffa502';
            } else {
                cpuCard.style.borderLeftColor = '#2ed573';
                document.getElementById('cpu-usage').style.color = '#2ed573';
            }
        }

        // コンソール出力表示（ブラウザコンソールの内容を画面に表示）
        function addConsoleLog(message, type = 'info') {
            const output = document.getElementById('console-output');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(logEntry);
            output.scrollTop = output.scrollHeight;
            
            testState.totalLogs++;
        }

        // ==============================
        // 基本機能テスト
        // ==============================
        
        function testBasicFunctions() {
            addConsoleLog('📋 基本機能テスト開始', 'info');
            
            // Phase 1-3 の基本機能をテスト
            ConsoleManager.log('Phase 1 テスト: 基本ログ出力', 'INFO', 'SYSTEM');
            ConsoleManager.success('Phase 1 テスト: 成功ログ', 'SYSTEM');
            ConsoleManager.warn('Phase 1 テスト: 警告ログ', 'SYSTEM');
            
            // Phase 2 機能テスト
            ConsoleManager.startPhase('test-phase');
            ConsoleManager.preserveImportant(['重要メッセージテスト']);
            ConsoleManager.completePhase('test-phase', true);
            
            // Phase 3 機能テスト
            const health = ConsoleManager.performHealthCheck();
            
            addConsoleLog('✅ 基本機能テスト完了', 'success');
            updateDashboard();
        }

        function startCPUMonitoring() {
            addConsoleLog('⚡ CPU監視開始', 'info');
            
            ConsoleManager.startCPUMonitoring({
                threshold: 15,
                interval: 2000, // 2秒間隔でテスト
                alertCallback: (data) => {
                    addConsoleLog(`🚨 CPU負荷警告: ${data.cpu}%`, 'warn');
                    updateDashboard();
                }
            });
            
            testState.cpuMonitoringActive = true;
            updateStatusPanel('CPU監視が開始されました');
        }

        function stopCPUMonitoring() {
            addConsoleLog('⏹️ CPU監視停止', 'info');
            ConsoleManager.stopCPUMonitoring();
            testState.cpuMonitoringActive = false;
            updateStatusPanel('CPU監視が停止されました');
        }

        function enableEmergencyBrake() {
            addConsoleLog('🚨 緊急ブレーキ有効化', 'warn');
            
            ConsoleManager.enableEmergencyBrake({
                cpuThreshold: 20,
                logLimit: 5
            });
            
            testState.emergencyBrakeActive = true;
            updateStatusPanel('緊急ブレーキシステムが有効化されました');
            updateDashboard();
        }

        function performHealthCheck() {
            addConsoleLog('🏥 システムヘルスチェック実行', 'info');
            
            const health = ConsoleManager.performHealthCheck();
            
            addConsoleLog(`ヘルスステータス: ${health.status}`, 
                health.status === 'HEALTHY' ? 'success' : 
                health.status === 'WARNING' ? 'warn' : 'error');
                
            if (health.warnings.length > 0) {
                health.warnings.forEach(warning => {
                    addConsoleLog(`⚠️ 警告: ${warning}`, 'warn');
                });
            }
            
            if (health.errors.length > 0) {
                health.errors.forEach(error => {
                    addConsoleLog(`❌ エラー: ${error}`, 'error');
                });
            }
            
            updateDashboard();
        }

        // ==============================
        // 危険パターン検出テスト
        // ==============================
        
        function testDangerousPatterns() {
            addConsoleLog('🔍 危険パターン検出テスト開始', 'info');
            
            const dangerousCode = `
                // 危険パターン1: while + async/await
                while (isLoading) {
                    await checkStatus();
                    console.log('waiting...');
                }
                
                // 危険パターン2: 高頻度setInterval
                setInterval(heavyFunction, 5);
                
                // 危険パターン3: 重い同期処理
                for (let i = 0; i < 1000000; i++) {
                    someHeavyCalculation();
                    processData(i);
                }
            `;
            
            const patterns = ConsoleManager.detectDangerousPattern(dangerousCode);
            
            addConsoleLog(`検出された危険パターン: ${patterns.length}件`, 
                patterns.length > 0 ? 'warn' : 'success');
                
            patterns.forEach(pattern => {
                addConsoleLog(`🚨 ${pattern.name}: ${pattern.description}`, 'warn');
                addConsoleLog(`💡 推奨: ${pattern.recommendation}`, 'info');
            });
        }

        function testWhileAsyncPattern() {
            addConsoleLog('🚨 while+async問題パターン検出テスト', 'warn');
            
            const whileAsyncCode = `
                while (condition) {
                    await someAsyncFunction();
                }
            `;
            
            const patterns = ConsoleManager.detectDangerousPattern(whileAsyncCode);
            addConsoleLog(`while+asyncパターン検出: ${patterns.length > 0 ? 'YES' : 'NO'}`, 
                patterns.length > 0 ? 'error' : 'success');
        }

        function testHighFrequencyLoop() {
            addConsoleLog('🔄 高頻度ループパターン検出テスト', 'warn');
            
            const highFreqCode = `
                setInterval(updateUI, 1);
                setInterval(processData, 5);
            `;
            
            const patterns = ConsoleManager.detectDangerousPattern(highFreqCode);
            addConsoleLog(`高頻度ループパターン検出: ${patterns.length > 0 ? 'YES' : 'NO'}`, 
                patterns.length > 0 ? 'error' : 'success');
        }

        // ==============================
        // 無限ループ検出テスト
        // ==============================
        
        function testInfiniteLoopDetection() {
            addConsoleLog('🔍 無限ループ検出システムテスト', 'info');
            
            // テストメソッド登録
            ConsoleManager.detectInfiniteLoop('testMethod', { maxCalls: 10, timeWindow: 2000 });
            
            addConsoleLog('無限ループ検出システムが設定されました（testMethod: 10回/2秒）', 'info');
            updateDashboard();
        }

        function simulateInfiniteLoop() {
            addConsoleLog('🚨 無限ループシミュレート開始（安全版）', 'warn');
            
            // 安全な無限ループシミュレート
            let count = 0;
            const maxIterations = 35; // 確実に検出されるように30回より多く
            
            const simulateLoop = () => {
                if (count >= maxIterations) {
                    addConsoleLog('安全版無限ループシミュレート完了', 'success');
                    return;
                }
                
                // 無限ループ検出呼び出し
                const detected = ConsoleManager.detectInfiniteLoop('simulateMethod', { 
                    maxCalls: 25, 
                    timeWindow: 3000 
                });
                
                if (detected) {
                    addConsoleLog(`🔄 無限ループ検出! (${count + 1}回目)`, 'error');
                    testState.infiniteLoopCount++;
                }
                
                count++;
                
                // 短い間隔で次の呼び出しをスケジュール
                setTimeout(simulateLoop, 50); // 50ms間隔で呼び出し
            };
            
            simulateLoop();
            updateDashboard();
        }

        function simulateLoadingCompleteLoop() {
            addConsoleLog('🔄 isLoadingComplete無限ループ再現テスト', 'error');
            
            // 今回経験した実際の問題パターンを安全に再現
            let loadingCheckCount = 0;
            const maxChecks = 40; // 30回の制限を超えてテスト
            
            const checkLoadingComplete = () => {
                if (loadingCheckCount >= maxChecks) {
                    addConsoleLog('isLoadingComplete再現テスト完了', 'success');
                    return;
                }
                
                // 実際の問題と同じパターンをシミュレート
                const detected = ConsoleManager.detectInfiniteLoop('isLoadingComplete', { 
                    maxCalls: 30, 
                    timeWindow: 3000 
                });
                
                if (detected && loadingCheckCount > 25) {
                    addConsoleLog('🚨 isLoadingComplete無限ループ検出!', 'error');
                    
                    // 緊急ブレーキの自動有効化をテスト
                    if (!testState.emergencyBrakeActive) {
                        addConsoleLog('🚨 緊急ブレーキ自動有効化', 'warn');
                        testState.emergencyBrakeActive = true;
                    }
                }
                
                loadingCheckCount++;
                
                // 実際の問題と同じような高頻度呼び出し
                setTimeout(checkLoadingComplete, 30); // 30ms間隔
            };
            
            checkLoadingComplete();
            updateDashboard();
        }

        // ==============================
        // UI制御
        // ==============================
        
        function clearConsoleOutput() {
            document.getElementById('console-output').innerHTML = '';
            addConsoleLog('🧹 コンソール表示をクリアしました', 'info');
        }

        function updateStatusPanel(message) {
            document.getElementById('system-status').textContent = message;
        }

        // ==============================
        // 初期化
        // ==============================
        
        document.addEventListener('DOMContentLoaded', function() {
            addConsoleLog('📋 Phase 3 テスト環境初期化完了', 'success');
            updateStatusPanel('Phase 3 CPU無限ループ対策システム - 準備完了');
            
            // 初期ダッシュボード更新
            setTimeout(updateDashboard, 1000);
            
            // 定期的なダッシュボード更新
            setInterval(updateDashboard, 5000); // 5秒ごと
        });

        // ブラウザコンソールのログをキャッチして画面に表示
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addConsoleLog(args.join(' '), 'info');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addConsoleLog(args.join(' '), 'warn');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addConsoleLog(args.join(' '), 'error');
        };
    </script>
</body>
</html>