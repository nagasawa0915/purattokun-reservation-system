# Spine WebGL座標系問題 - トラブルシューティング

## 📋 問題分類
**分類**: Spine技術問題 - 座標系変換エラー  
**発生場所**: デスクトップアプリ Spine編集システム  
**影響範囲**: マウス操作とキャラクター移動の連動性  

## 🚨 問題の症状

### 具体的な症状
- **Y軸動作が逆転**: マウス上移動時にキャラクターが下移動
- **操作感の異常**: マウスとキャラクターの動きが完全に逆
- **編集作業の困難**: 直感的でない動作により編集効率が大幅低下

### 症状確認方法
1. デスクトップアプリでSpine編集システムを起動
2. キャラクターをドラッグ操作で移動
3. マウス移動方向とキャラクター移動方向を比較
4. Y軸（上下）方向の動作が逆転していることを確認

## 🔍 根本原因

### 技術的原因
**Spine WebGL座標系とCanvas DOM座標系の違い**:
- **Spine WebGL座標系**: Y軸上向き、原点左下
- **Canvas DOM座標系**: Y軸下向き、原点左上

### 問題が発生する理由
1. マウスイベントはCanvas DOM座標系で取得される
2. Spine WebGLは独自の座標系を使用
3. 座標変換処理でY軸反転が正しく実装されていない
4. 結果として動作が逆転する

## ⚡ 有効な解決策・回避策

### ✅ **解決策1: Y軸反転変換の正確な実装**（解決済み - 2025-08-14）

**修正対象ファイル**: `src/renderer/spine-preview-layer.js`

#### **修正箇所1**: `clientToCanvasCoordinates`関数
**場所**: 547-555行  
**修正内容**:
```javascript
// 修正前（問題のあるコード）
const canvasY = clientY - rect.top;

// 修正後（正しい座標変換）
const canvasY = this.canvas.height - (clientY - rect.top);
```

#### **修正箇所2**: `updateOverlayPosition`関数
**場所**: 927-946行  
**修正内容**:
```javascript
// 修正前（問題のあるコード）
const y = character.skeleton.y;

// 修正後（正しい座標変換）
const y = this.canvas.height - character.skeleton.y;
```

#### **技術的詳細**
- `this.canvas.height - (clientY - rect.top)`: マウス座標をSpine座標系に変換
- `this.canvas.height - character.skeleton.y`: Spine座標系をDOM座標系に変換
- 両変換により座標系の整合性を確保

#### **実装結果**
- ✅ **Y軸動作正常化**: マウス上移動→キャラクター上移動
- ✅ **直感的操作**: 期待通りの動作を実現
- ✅ **編集効率向上**: 自然な操作感を獲得

**ユーザー確認済み評価**:
- 「上下の逆に動く問題が解決しました！」
- 「マウスを動かした時の動きは正しくなりました」
- 「今回のアプローチは正しかった」

**ステータス**: <!-- 🔒 確定済み解決策 - 変更禁止 --> **完全解決済み**

### ⚠️ **注意事項**
- **位置オフセット問題**: Y軸動作は解決済みだが、斜め上ズレが残存
- **段階的解決**: 座標系問題は複数の要因が重なる場合があり、段階的対応が有効

## 🔄 未解決の関連問題

### ⚠️ **現在調査中**: 位置オフセット問題
**症状**: キャラクターが期待位置から斜め上にズレる  
**状況**: Y軸動作は正常、位置補正が次の修正対象  
**関連**: 座標変換の基準点や原点設定に起因する可能性

## 📊 問題解決実績

| 問題要素 | 解決状況 | 解決日 | 解決策 |
|---------|---------|-------|-------|
| Y軸動作逆転 | ✅ 完全解決 | 2025-08-14 | 座標変換ロジック修正 |
| 位置オフセット | ⚠️ 調査中 | - | 基準点調整予定 |

## 🔧 診断・テスト方法

### 問題確認手順
1. **デスクトップアプリ起動**
   ```bash
   npm start
   ```

2. **Spine編集システム起動**
   - フォルダ選択 → HTMLファイル選択 → プレビュー表示

3. **座標動作テスト**
   - キャラクターをドラッグ移動
   - Y軸（上下）方向の動作確認
   - マウスとキャラクターの動き一致を確認

### コンソール診断コマンド
```javascript
// 座標変換確認
console.log('Canvas height:', canvas.height);
console.log('Mouse Y:', clientY - rect.top);
console.log('Spine Y:', canvas.height - (clientY - rect.top));
```

## 💡 予防策・ベストプラクティス

### 座標系変換の基本原則
1. **座標系の明確な理解**: Spine WebGL vs Canvas DOM
2. **変換処理の一貫性**: 全ての座標操作で統一した変換ロジック
3. **段階的テスト**: 座標変換ごとの動作確認
4. **ユーザーテスト**: 実際の操作感での最終確認

### 類似問題の予防
- **新キャラクター追加時**: 座標変換ロジックの再確認
- **Canvas操作機能追加時**: 座標系変換の整合性確認
- **Spine WebGLバージョン更新時**: 座標系仕様の変更確認

## 📚 関連情報

### 技術仕様
- **Spine WebGL**: 左下原点、Y軸上向き座標系
- **Canvas DOM**: 左上原点、Y軸下向き座標系
- **座標変換公式**: `spineY = canvasHeight - domY`

### 学習リソース
- [Spine WebGL座標系公式ドキュメント]
- [Canvas座標変換の基本原理]
- [デスクトップアプリ座標ハンドリング]

---

**📝 最終更新**: 2025-08-14  
**記録者**: Claude Code  
**ステータス**: Y軸動作問題完全解決、位置オフセット調査継続中