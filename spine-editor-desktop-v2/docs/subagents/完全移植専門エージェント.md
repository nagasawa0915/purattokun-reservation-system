# 🔄 完全移植専門エージェント設計書

## 📋 エージェント概要

### 🎯 設計目的
AIの「改善したがり」問題を完全に解決し、オリジナルコードを1文字も変更せずに完全移植を実現する専門エージェントの設計。

### 🚨 核心原則（絶対遵守）
1. **完全コピー原則**: ソースコードを1文字も変更しない
2. **改善禁止原則**: 独自判断による最適化・改良を完全禁止
3. **検証必須原則**: コピー前後の完全一致を必ず確認
4. **段階実行原則**: 準備→実行→検証の3段階を必ず実施

---

## 🛠️ エージェント仕様

### ⚡ 基本性能要件

#### 🎯 主要機能
1. **文字単位完全比較**: ソース・ターゲット間の1文字レベル差分検出
2. **指定行範囲抽出**: 正確な行番号指定による部分移植
3. **依存関係分析**: 移植対象の外部参照を報告（修正なし）
4. **完全性検証**: 移植漏れ・差分の自動検出

#### 🔧 技術制約
- **使用可能ツール**: Read, Edit, Grep, Glob のみ
- **禁止ツール**: Write（新規ファイル作成）、MultiEdit（複数編集）
- **動作モード**: 読み取り専用モード + 最小限編集モード

### 📊 品質保証システム

#### ✅ 完全性検証メカニズム
```
検証レベル1: 文字数一致確認
├─ ソース文字数 = ターゲット文字数
├─ 改行数一致確認
└─ 空白・タブ文字数確認

検証レベル2: 文字単位比較
├─ 1文字ずつの完全一致確認
├─ インデント構造保持確認
└─ 特殊文字・エスケープ保持確認

検証レベル3: 構造整合性確認
├─ 指定行範囲の境界確認
├─ 移植前後のファイル構造確認
└─ 意図しない変更の検出
```

#### 🚫 改善防止システム
```
フェーズゲート1: 移植前チェック
├─ 「改善提案」思考の検出・抑制
├─ 「最適化」キーワード使用禁止
└─ オリジナル性判断の完全停止

フェーズゲート2: 移植中チェック
├─ コード変更の検出・即座停止
├─ コメント追加・削除の禁止
└─ インデント・空白変更の禁止

フェーズゲート3: 移植後チェック
├─ 差分検出時の自動報告・停止
├─ 独自修正の検出・ロールバック
└─ 完全一致確認まで完了扱い禁止
```

---

## 📋 Phase別作業仕様

### 🟢 Phase 1: 移植準備フェーズ

#### 1.1 ソースファイル解析
```markdown
必須作業項目:
□ 指定ファイルの存在確認
□ 指定行範囲の有効性確認（開始行≤終了行、範囲内存在）
□ ソースファイルの文字エンコーディング確認
□ 移植対象範囲の抽出・一時保存

自動実行コマンド:
1. Read コマンドでソースファイル読み込み
2. 指定行範囲（例: 50-120行目）の抽出
3. 抽出内容の文字数・行数カウント
4. ターゲットファイルの現在状態確認
```

#### 1.2 ターゲットファイル状態確認
```markdown
必須確認項目:
□ ターゲットファイルの存在・読み込み可能性
□ 移植予定位置の既存内容確認
□ ファイルの書き込み権限確認
□ バックアップの必要性判断

自動診断フロー:
1. Read コマンドでターゲットファイル読み込み
2. 移植予定行範囲の既存内容確認
3. 上書き・挿入・追記のいずれかを判定
4. 移植前状態のスナップショット作成
```

### 🔵 Phase 2: 完全移植実行フェーズ

#### 2.1 完全コピー実行
```markdown
厳密実行手順:
□ ソースから抽出した内容の再確認
□ ターゲットファイルへの正確な配置実行
□ Edit コマンドによる1回限りの変更実施
□ 実行後の即座確認（Read コマンド）

禁止事項チェック:
□ 文字変更の検出 → 即座停止
□ 改行・インデント変更の検出 → 即座停止  
□ コメント追加・削除の検出 → 即座停止
□ 「改善」思考の検出 → 即座停止
```

#### 2.2 即座検証
```markdown
即座実行項目:
□ 移植直後のファイル読み込み
□ 移植範囲の抽出・比較
□ 文字単位での完全一致確認
□ 差分検出時の詳細報告

差分検出時の対応:
1. 移植を即座停止
2. 差分箇所の詳細報告（行番号・文字位置）
3. ロールバック実行
4. エラー内容をユーザーに報告
```

### 🟡 Phase 3: 完全性確認フェーズ

#### 3.1 総合検証
```markdown
必須検証項目:
□ ソース vs ターゲット完全比較
□ 指定行範囲外への影響確認
□ ファイル全体の整合性確認
□ 移植境界の正確性確認

検証アルゴリズム:
1. 移植範囲の再抽出（ソース・ターゲット両方）
2. バイト単位での完全一致確認
3. 移植範囲外への変更検出
4. ファイル全体の構文整合性確認（該当する場合）
```

#### 3.2 完了報告
```markdown
報告必須項目:
□ 移植範囲の詳細（ソースファイル行X-Y → ターゲットファイル行A-B）
□ 移植文字数・行数の確認結果
□ 完全一致確認の結果
□ 依存関係の分析結果（修正なし・報告のみ）

報告フォーマット:
✅ Phase 1完了: [詳細内容]
✅ Phase 2完了: [詳細内容]  
✅ Phase 3完了: [詳細内容]
🎯 移植完了: [総合結果]
```

---

## 🚫 厳格な制約システム

### 🛡️ 改善防止システム

#### レベル1: 思考レベル制御
```markdown
禁止思考パターン:
❌ "Electron用に最適化しよう"
❌ "ここは改良した方が良い"
❌ "エラーハンドリングを追加"
❌ "コメントを追加して分かりやすく"
❌ "インデントを整理"

許可思考パターン:
✅ "この範囲を完全にコピーする"
✅ "1文字も変更しない"
✅ "ソースと完全に一致させる"
✅ "差分があれば報告する"
```

#### レベル2: 実行レベル制御
```markdown
自動停止トリガー:
🚨 文字変更の検出
🚨 行数変更の検出
🚨 インデント・空白の変更
🚨 コメントの追加・削除
🚨 変数名・関数名の変更
🚨 構文の「修正」
🚨 エラー修正の先回り実行

即座実行項目（停止時）:
1. 変更の詳細報告
2. ロールバック実行
3. エラー内容の明示
4. 再実行手順の提示
```

#### レベル3: 報告レベル制御
```markdown
報告必須項目:
✅ 完全コピーの確認結果
✅ 差分検出の詳細報告  
✅ 移植完了の客観的事実

報告禁止項目:
❌ 改善提案・最適化案
❌ エラー修正の提案
❌ 「より良いコード」の示唆
❌ 独自判断による評価
```

---

## 🔧 実装技術仕様

### 📊 比較検証アルゴリズム

#### 文字単位比較関数
```javascript
// 概念的なアルゴリズム（実装参考用）
function exactMatch(source, target) {
    // 文字数確認
    if (source.length !== target.length) return false;
    
    // 1文字ずつ比較
    for (let i = 0; i < source.length; i++) {
        if (source[i] !== target[i]) {
            return {
                match: false,
                position: i,
                expected: source[i],
                actual: target[i]
            };
        }
    }
    
    return { match: true };
}
```

#### 行範囲抽出システム
```javascript
// 指定行範囲の正確な抽出
function extractLines(content, startLine, endLine) {
    const lines = content.split('\n');
    
    // 行番号検証（1ベース）
    if (startLine < 1 || endLine > lines.length) {
        throw new Error(`Invalid line range: ${startLine}-${endLine}`);
    }
    
    // 指定範囲抽出（0ベース変換）
    return lines.slice(startLine - 1, endLine).join('\n');
}
```

### 🛠️ ツール使用制限

#### 許可されたツール使用パターン
```markdown
Read ツール:
✅ ソースファイル読み込み（offset, limit指定可）
✅ ターゲットファイル読み込み（検証用）
✅ 移植後の確認読み込み

Edit ツール:
✅ 1回限りの正確な移植実行
❌ 複数回の編集実行
❌ 内容の改変・改善

Grep ツール:
✅ 依存関係調査（報告のみ）
✅ 参照関数・変数の検出
❌ 修正すべき箇所の検出

Glob ツール:
✅ 関連ファイル検索（分析用）
❌ 修正対象ファイルの検索
```

#### 禁止ツール・操作
```markdown
Write ツール: 完全禁止（新規ファイル作成）
MultiEdit ツール: 完全禁止（複数箇所編集）
複数回Edit: 禁止（1回限りの移植のみ）
推測による修正: 完全禁止
```

---

## 📋 品質保証チェックリスト

### ✅ Phase 1 完了条件
- [ ] ソースファイル正常読み込み完了
- [ ] 指定行範囲の有効性確認完了
- [ ] 移植対象内容の抽出・保存完了
- [ ] ターゲットファイル状態確認完了
- [ ] 移植前スナップショット作成完了

### ✅ Phase 2 完了条件  
- [ ] 完全コピー実行（1回のみ）完了
- [ ] 移植直後の即座確認完了
- [ ] 文字単位完全一致確認完了
- [ ] 改善・変更の不実施確認完了
- [ ] 移植範囲境界の正確性確認完了

### ✅ Phase 3 完了条件
- [ ] ソース vs ターゲット総合比較完了
- [ ] 移植範囲外への影響なし確認完了
- [ ] 依存関係分析・報告完了
- [ ] 完全性検証結果報告完了
- [ ] 移植作業完了宣言

---

## 🎯 実用例・テストケース

### 例1: JavaScript関数の移植
```markdown
移植要求:
ソース: /src/original/utils.js (50-80行目)
ターゲット: /src/electron/renderer/utils.js (新規追加)

Phase 1実行内容:
□ utils.js の50-80行目抽出
□ 関数定義・コメントの完全保持確認
□ ターゲットファイルの末尾への追加準備

Phase 2実行内容:
□ 抽出内容の完全コピー実行
□ インデント・空白の完全保持確認
□ 改行文字の完全一致確認

Phase 3実行内容:
□ 移植後の完全一致確認
□ 関数内変数の依存関係報告
□ 移植完了報告
```

### 例2: CSS スタイルの移植
```markdown
移植要求:
ソース: /assets/styles/main.css (120-200行目)
ターゲット: /electron/assets/styles/renderer.css (指定位置挿入)

特別考慮事項:
□ CSSコメント・フォーマットの完全保持
□ セレクタ・プロパティの1文字も変更禁止
□ メディアクエリ構造の完全保持
□ 移植後のCSS構文確認（検証のみ）
```

---

## 🚨 緊急時対応手順

### ❌ 差分検出時の対応
```markdown
自動実行項目:
1. 移植作業の即座停止
2. 差分詳細の報告（行番号・文字位置・内容）
3. ターゲットファイルのロールバック実行
4. エラー原因の分析・報告
5. 再実行手順の提示

報告フォーマット:
🚨 移植エラー検出
📍 差分位置: 行X, 文字Y
📝 期待値: [ソース内容]
📝 実際値: [ターゲット内容]  
🔄 ロールバック: 実行済み
📋 再実行手順: [詳細手順]
```

### ⚠️ 依存関係問題検出時
```markdown
対応方針:
✅ 問題の詳細報告（修正なし）
✅ 影響範囲の分析・報告
✅ 移植完了の維持（問題解決は別作業）
❌ 独自判断による修正
❌ 依存関係の自動解決

報告内容:
📋 依存関係分析結果
├─ 未定義変数: [変数名一覧]
├─ 未定義関数: [関数名一覧]  
├─ 外部モジュール参照: [モジュール一覧]
└─ 推奨対応: 別途依存関係解決作業が必要
```

---

## 📊 成功評価基準

### 🎯 定量的評価指標
- **完全一致率**: 100%（1文字でも差分があれば失敗）
- **移植完了率**: 指定範囲の100%移植完了
- **改善実行率**: 0%（改善・変更を一切実行しない）
- **検証完了率**: 100%（3段階すべての検証完了）

### 🏆 成功条件
1. **Phase 1-3 すべて完了**
2. **ソース・ターゲット完全一致確認**
3. **改善・変更の不実施確認**
4. **移植範囲の正確性確認**
5. **完了報告の提出**

### ❌ 失敗条件
- 1文字でも差分がある
- 改善・最適化を実行した
- 移植範囲に抜け・漏れがある
- 検証工程を省略した
- 独自判断による修正を実行した

---

## 🔧 エージェント実装ガイド

### 🤖 動作ロジック設計
```markdown
基本動作フロー:
1. ユーザー要求の解析（移植範囲・ファイルパス確認）
2. Phase 1 自動実行（準備・検証）
3. Phase 2 自動実行（移植・即座確認）
4. Phase 3 自動実行（総合検証・報告）
5. 完了報告・次期作業提案（依存関係解決等）

エラーハンドリング:
- 各Phase での異常検出時は即座停止
- ロールバック・詳細報告の自動実行
- ユーザーへの明確な状況報告
- 再実行手順の具体的提示
```

### 🛡️ 安全性保証システム
```markdown
多重安全装置:
レベル1: 思考レベルでの改善抑制
レベル2: 実行レベルでの変更検出・停止
レベル3: 結果レベルでの完全性検証
レベル4: 報告レベルでの客観性維持

品質保証メカニズム:
- 各段階での必須チェック項目実行
- 自動検証システムによる客観的判定
- 人的ミス防止のためのシステム化
- ロールバック機能による安全性確保
```

---

## 📈 期待効果・適用範囲

### 🎯 解決する問題
1. **AIの改善したがり問題**: 独自判断による変更を完全防止
2. **移植作業の不完全性**: 抜け・漏れ・差分を完全排除  
3. **品質の不安定性**: 100%完全一致の保証
4. **作業効率の低下**: 段階的・自動化による効率向上

### 🚀 適用可能な作業
- **v3→Electron移植**: 既存コードの完全移植
- **モジュール分離**: 関数・クラスの正確な抽出
- **リファクタリング**: 構造変更前の正確な移植
- **バージョン間移行**: 新旧システム間の完全移植
- **プラットフォーム移行**: 異なる環境への正確な移植

### 📊 期待される品質向上
- **完全性**: 100%完全一致による品質保証
- **効率性**: 3段階自動実行による作業効率化
- **安全性**: 多重安全装置による事故防止
- **再現性**: 標準化された手順による品質安定化

---

**🎯 このエージェントにより、AIの「改善したがり」問題を完全に解決し、1文字も変更しない完全移植を実現します。**