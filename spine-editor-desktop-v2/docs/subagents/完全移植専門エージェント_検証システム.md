# 🔍 完全移植専門エージェント - 完全性検証システム設計

## 🎯 検証システムの目的
移植作業の100%完全一致を保証し、AIによる「改善したがり」「勝手な修正」を技術的に完全に防止するための自動検証システム。

---

## 🏗️ 検証システム・アーキテクチャ

### 🔧 4層検証モデル
```
検証レイヤー1: 文字レベル完全一致検証
├─ バイト単位比較
├─ 改行コード検証  
├─ 文字エンコーディング検証
└─ 制御文字・特殊文字検証

検証レイヤー2: 構造レベル整合性検証  
├─ 行数・文字数一致検証
├─ インデント構造保持検証
├─ 空白・タブ文字配置検証
└─ 移植境界正確性検証

検証レイヤー3: 意味レベル保持検証
├─ コメント完全保持検証
├─ 文字列リテラル保持検証  
├─ 識別子・キーワード保持検証
└─ 演算子・記号保持検証

検証レイヤー4: 統合レベル品質検証
├─ ファイル全体整合性検証
├─ 移植範囲外への影響検証
├─ 構文エラー有無確認
└─ 最終品質判定
```

---

## 🔍 レイヤー1: 文字レベル完全一致検証

### 🎯 バイト単位比較アルゴリズム

#### 実装仕様
```javascript
// 概念的なアルゴリズム設計
function byteExactMatch(source, target) {
    // ステップ1: 基本長さチェック
    if (source.length !== target.length) {
        return {
            match: false,
            error: "LENGTH_MISMATCH",
            sourceLength: source.length,
            targetLength: target.length
        };
    }
    
    // ステップ2: バイト単位比較
    for (let i = 0; i < source.length; i++) {
        if (source.charCodeAt(i) !== target.charCodeAt(i)) {
            return {
                match: false,
                error: "BYTE_MISMATCH",
                position: i,
                sourceChar: source[i],
                targetChar: target[i],
                sourceCode: source.charCodeAt(i),
                targetCode: target.charCodeAt(i)
            };
        }
    }
    
    return { match: true, verified: "BYTE_EXACT" };
}
```

#### 検証実行手順
```markdown
1. **ソース文字列抽出**:
   - Read ツールで指定行範囲抽出
   - 改行コード・エンコーディング記録
   - バイナリレベルでの内容保存

2. **ターゲット文字列抽出**:  
   - 移植後の該当範囲抽出
   - 同一範囲・同一エンコーディングで抽出
   - バイナリレベルでの内容保存

3. **バイト単位比較実行**:
   - 文字数完全一致確認
   - 1バイトずつの完全一致確認  
   - 差分検出時の詳細位置記録

4. **結果判定・報告**:
   - 100%一致 → 次レイヤー進行
   - 差分検出 → 即座停止・詳細報告
```

### 🔤 改行コード・エンコーディング検証

#### 改行コード統一性検証
```markdown
検証項目:
□ LF（\n）vs CRLF（\r\n）の一致確認
□ 改行位置の完全一致確認
□ 文末改行の有無一致確認
□ 混合改行コードの検出

実行方法:
1. ソース・ターゲット両方の改行コード分析
2. 改行位置マッピング作成
3. 改行コード種別の完全一致確認
4. 差分検出時の詳細報告
```

#### 文字エンコーディング検証
```markdown
検証項目:
□ UTF-8, UTF-16, Shift_JIS等の一致確認
□ BOM（Byte Order Mark）の一致確認  
□ 全角・半角文字の完全保持確認
□ 特殊文字・絵文字の完全保持確認

検証手順:
1. ファイルヘッダーのエンコーディング確認
2. マルチバイト文字の正確な処理確認
3. 文字化け・変換ミスの検出
4. エンコーディング差分の詳細報告
```

---

## 📐 レイヤー2: 構造レベル整合性検証

### 📊 行・文字数一致検証

#### 詳細カウント検証
```javascript
// 構造検証アルゴリズム  
function structureVerification(source, target) {
    const sourceAnalysis = analyzeStructure(source);
    const targetAnalysis = analyzeStructure(target);
    
    return {
        lineCount: sourceAnalysis.lines === targetAnalysis.lines,
        charCount: sourceAnalysis.chars === targetAnalysis.chars,
        spaceCount: sourceAnalysis.spaces === targetAnalysis.spaces,
        tabCount: sourceAnalysis.tabs === targetAnalysis.tabs,
        analysis: {
            source: sourceAnalysis,
            target: targetAnalysis
        }
    };
}

function analyzeStructure(content) {
    return {
        lines: content.split('\n').length,
        chars: content.length,
        spaces: (content.match(/ /g) || []).length,
        tabs: (content.match(/\t/g) || []).length,
        whitespacePattern: content.replace(/\S/g, '*')
    };
}
```

#### 実行検証手順
```markdown
1. **ソース構造分析**:
   □ 総行数カウント
   □ 総文字数カウント
   □ スペース・タブ文字数カウント
   □ インデント階層分析

2. **ターゲット構造分析**:
   □ 移植後の総行数カウント  
   □ 移植後の総文字数カウント
   □ スペース・タブ文字数カウント
   □ インデント階層分析

3. **構造一致検証**:
   □ 行数完全一致確認（[X]行 = [X]行）
   □ 文字数完全一致確認（[Y]文字 = [Y]文字）
   □ 空白文字数完全一致確認
   □ インデント構造完全一致確認

4. **差分検出・報告**:
   □ 不一致項目の詳細特定
   □ 差分発生位置の特定
   □ 修正必要箇所の報告
```

### 🔲 インデント・空白配置検証

#### 空白文字パターン検証
```markdown
検証アルゴリズム:
1. **空白文字マッピング作成**:
   - 各行の先頭空白文字を記録
   - スペース・タブの種別・数量記録
   - インデント階層レベル記録

2. **パターン一致検証**:
   - 行単位での空白パターン比較
   - インデント階層の完全一致確認
   - 混在タイプ（スペース+タブ）の一致確認

3. **差分詳細分析**:
   - 不一致行の特定
   - 期待値 vs 実際値の詳細報告
   - インデント修正提案（実行なし・報告のみ）
```

#### 実行手順
```markdown
□ ソースファイルの各行インデント分析
□ ターゲットファイルの各行インデント分析  
□ 行単位でのインデントパターン比較
□ 差分検出時の詳細位置・内容記録
□ インデント構造の視覚的比較表示
```

---

## 🧩 レイヤー3: 意味レベル保持検証

### 💬 コメント完全保持検証

#### コメント分析・比較
```javascript
// コメント保持検証アルゴリズム
function commentPreservationCheck(source, target) {
    const sourceComments = extractComments(source);
    const targetComments = extractComments(target);
    
    return {
        singleLineComments: compareComments(
            sourceComments.singleLine, 
            targetComments.singleLine
        ),
        multiLineComments: compareComments(
            sourceComments.multiLine, 
            targetComments.multiLine
        ),
        inlineComments: compareComments(
            sourceComments.inline,
            targetComments.inline
        )
    };
}

function extractComments(content) {
    return {
        singleLine: content.match(/\/\/.*$/gm) || [],
        multiLine: content.match(/\/\*[\s\S]*?\*\//g) || [],  
        inline: content.match(/\s+\/\/.*/g) || []
    };
}
```

#### 検証項目
```markdown
□ 単行コメント（//）の完全保持
□ 複数行コメント（/* */）の完全保持  
□ インラインコメントの完全保持
□ コメント内テキストの1文字も変更なし確認
□ コメント位置・インデントの完全保持
□ TODO、FIXME等の特殊コメントの保持
```

### 🔤 文字列リテラル・識別子検証

#### 文字列リテラル完全保持検証
```markdown
検証対象:
□ シングルクォート文字列（'...'）
□ ダブルクォート文字列（"..."）  
□ テンプレート文字列（`...`）
□ エスケープシーケンス（\n, \t, \\等）
□ 改行を含む複数行文字列
□ Unicode文字・絵文字を含む文字列

検証方法:
1. 正規表現による文字列リテラル抽出
2. エスケープ処理を含む完全一致確認
3. 文字列境界（クォート）の完全保持確認
4. 特殊文字・制御文字の完全保持確認
```

#### 識別子・キーワード検証
```markdown
検証対象:
□ 変数名・関数名の完全保持
□ クラス名・メソッド名の完全保持
□ 予約語・キーワードの完全保持
□ プロパティ名・フィールド名の完全保持
□ 大文字・小文字の完全一致

検証方法:
1. トークン解析による識別子抽出
2. 識別子一覧の完全一致確認
3. 命名規則（camelCase等）の保持確認
4. 意図しない名前変更の検出・報告
```

---

## 🌐 レイヤー4: 統合レベル品質検証

### 🗂️ ファイル全体整合性検証

#### ファイル構造保持検証
```markdown
検証項目:
□ 移植範囲前の内容変更なし確認
□ 移植範囲後の内容変更なし確認
□ ファイル全体のサイズ変化確認
□ 移植境界の正確性確認
□ ファイル末尾・先頭の保持確認

実行手順:
1. 移植前のファイル全体スナップショット
2. 移植後のファイル全体スナップショット  
3. 差分分析（移植範囲 vs 移植範囲外）
4. 意図しない変更の検出・報告
5. ファイル整合性の最終判定
```

#### 構文エラー検証（該当言語）
```markdown
対応言語別検証:
□ JavaScript: 構文解析・エラー検証
□ CSS: CSSパーサーによる検証
□ HTML: HTMLバリデーション  
□ JSON: JSON形式検証
□ その他: 基本的な括弧対応確認

検証手順:
1. 移植前の構文エラーベースライン確認
2. 移植後の構文エラー有無確認
3. 移植による新規エラー発生の検出
4. エラー内容の詳細報告（修正なし）
```

### 🎯 最終品質判定

#### 総合判定基準
```markdown
✅ 完全成功条件（すべて満たす必要）:
□ レイヤー1: 文字レベル100%完全一致
□ レイヤー2: 構造レベル100%完全一致  
□ レイヤー3: 意味レベル100%完全保持
□ レイヤー4: 統合レベル整合性確認
□ 移植範囲外への影響なし
□ 新規エラーの発生なし

⚠️ 条件付き成功（要確認）:
□ 構文エラーが存在するが移植前から存在
□ 依存関係不足があるが移植範囲外の問題
□ 警告レベルの問題があるが機能に影響なし

❌ 失敗条件（1つでも該当）:
□ 1文字でも差分がある
□ 構造が変化している
□ コメント・文字列が変更されている  
□ 移植範囲外に影響がある
□ 新規構文エラーが発生している
```

#### 判定結果報告フォーマット
```markdown
# 🔍 完全性検証結果報告

## 📊 4層検証結果
### レイヤー1: 文字レベル検証 ✅/❌
- バイト単位一致: ✅ [詳細]
- 改行コード保持: ✅ [詳細]  
- エンコーディング保持: ✅ [詳細]

### レイヤー2: 構造レベル検証 ✅/❌  
- 行数一致: ✅ [X行 = X行]
- 文字数一致: ✅ [Y文字 = Y文字]
- インデント保持: ✅ [詳細]

### レイヤー3: 意味レベル検証 ✅/❌
- コメント保持: ✅ [詳細]
- 文字列保持: ✅ [詳細]
- 識別子保持: ✅ [詳細]

### レイヤー4: 統合レベル検証 ✅/❌
- ファイル整合性: ✅ [詳細]  
- 構文エラー: ✅ [詳細]
- 影響範囲: ✅ [詳細]

## 🎯 最終判定
**総合結果**: ✅ **完全成功** / ❌ **失敗** / ⚠️ **条件付き成功**

**品質スコア**: [100%/xx%]
**推奨対応**: [なし/要確認/要修正]
```

---

## 🚨 自動停止・ロールバック システム

### ⚡ 自動停止トリガー

#### 即座停止条件
```markdown
🚨 レベル1（即座停止）:
□ 文字レベルで1文字でも差分検出
□ 構造レベルで行数・文字数不一致  
□ 移植範囲外への意図しない変更検出
□ 致命的な構文エラー発生

⚠️ レベル2（警告・要確認）:
□ インデント・空白の軽微な差分
□ コメント・文字列の軽微な差分
□ 依存関係の不足（移植範囲外）  
□ 警告レベルの構文問題

📋 レベル3（報告・継続）:
□ 構文エラー（移植前から存在）
□ 依存関係分析結果
□ パフォーマンス・品質に関する情報
```

#### 自動停止実行フロー
```markdown
停止トリガー発生時の自動実行:
1. 検証作業の即座中断
2. エラー詳細の自動記録・分析
3. ロールバック必要性の自動判定
4. ロールバック実行（必要時）
5. エラー内容の詳細報告
6. 再実行手順の自動生成・提示
```

### 🔄 ロールバック システム

#### ロールバック実行条件
```markdown
自動ロールバック実行条件:
□ レイヤー1検証で差分検出
□ 移植範囲外への変更検出
□ 致命的構文エラー発生
□ ファイル破損・読み込み不可状態

手動ロールバック実行判断:
□ レイヤー2-3で重大な差分検出
□ ユーザーからのロールバック要求
□ 検証続行不可能な状態
```

#### ロールバック実行手順
```markdown
1. **バックアップからの復元**:
   - 移植前スナップショットの確認
   - ターゲットファイルの完全復元
   - 復元後の整合性確認

2. **ロールバック確認**:
   - 復元後ファイルの読み込み確認
   - 移植前状態との完全一致確認  
   - ファイル整合性・構文エラー確認

3. **エラー報告・対応提示**:
   - ロールバック完了報告
   - エラー原因の詳細分析
   - 修正版移植手順の提示
   - 再実行時の注意事項明示
```

---

## 🔧 実装技術仕様

### 🛠️ Claude Code での実装方法

#### 使用ツール・制限事項
```markdown
許可ツール:
✅ Read: ファイル内容読み込み・比較用データ取得
✅ Edit: 移植実行（1回限り）
✅ Grep: 依存関係分析・パターン検索
✅ Glob: 関連ファイル検索・分析

禁止ツール・操作:
❌ Write: 新規ファイル作成禁止
❌ MultiEdit: 複数箇所同時編集禁止
❌ 複数回Edit: 1回限りの移植のみ許可
❌ 推測による修正: 完全禁止
```

#### 検証実行アルゴリズム
```markdown
検証実行フロー:
1. Read でソース・ターゲット両方読み込み
2. 指定範囲抽出・文字列として保存
3. 4層検証アルゴリズムの順次実行
4. 各層結果の詳細記録・蓄積
5. 最終判定・総合報告生成
6. エラー時の自動停止・ロールバック実行
```

### 📊 パフォーマンス・スケーラビリティ

#### 大容量ファイル対応
```markdown
効率化手法:
□ 移植範囲のみの部分読み込み（Read offset/limit使用）  
□ 段階的検証（エラー検出時の早期停止）
□ メモリ効率的な文字列比較アルゴリズム
□ 必要最小限の情報保存・記録

制限事項:
□ 超大容量ファイル（100MB+）での性能低下可能性
□ 複雑な文字エンコーディング混在時の処理制限
□ 特殊文字・バイナリデータ混在時の検証制限
```

---

## 📋 検証システム品質保証

### ✅ システム自体の検証方法

#### 検証システム・テスト項目
```markdown
□ 完全一致ケースでの100%成功確認
□ 1文字差分ケースでの確実な検出確認  
□ 改行・空白差分ケースでの検出確認
□ コメント変更ケースでの検出確認
□ 移植範囲外変更ケースでの検出確認
□ ロールバック機能の正常動作確認
```

#### 精度・信頼性評価
```markdown
評価基準:
□ 偽陽性（差分なしを差分ありと誤判定）: 0%
□ 偽陰性（差分ありを差分なしと誤判定）: 0%
□ 検出精度: 100%（1文字レベルの差分検出）
□ 処理時間: 合理的範囲内（大容量対応）
□ エラー処理: 確実なロールバック・復旧
```

---

**🎯 この完全性検証システムにより、AIによる移植作業での「改善したがり」問題を技術的に完全に防止し、100%完全一致の移植を保証します。**