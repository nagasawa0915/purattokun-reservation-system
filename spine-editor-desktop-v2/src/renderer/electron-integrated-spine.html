<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ Electronç‰ˆ6ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ±åˆã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            background: #1a1a1a;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 40px);
            gap: 10px;
        }
        
        .left-panel {
            width: 300px;
            background: #2d2d2d;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
        }
        
        .right-panel {
            flex: 1;
            background: #333;
            border-radius: 8px;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #4CAF50;
            border-radius: 8px;
        }
        
        .character-list {
            margin-bottom: 20px;
        }
        
        .character-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #404040;
            border-radius: 5px;
            cursor: grab;
            transition: background 0.2s;
        }
        
        .character-item:hover {
            background: #4CAF50;
        }
        
        .character-item:active {
            cursor: grabbing;
        }
        
        .character-icon {
            width: 30px;
            height: 30px;
            background: #666;
            border-radius: 50%;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        #spine-canvas {
            flex: 1;
            border: 2px solid #4CAF50;
            border-radius: 5px;
            background: #111;
            margin: 10px;
        }
        
        .controls {
            padding: 10px;
            background: #2d2d2d;
            border-radius: 5px;
            margin: 10px;
        }
        
        .controls button {
            padding: 8px 16px;
            margin: 3px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .controls button:hover {
            background: #45a049;
        }
        
        .status {
            padding: 8px;
            background: #1a1a1a;
            margin: 5px 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
        }
        
        .module-info {
            background: #2d2d2d;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .drop-zone {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border: 2px dashed #666;
            border-radius: 8px;
            text-align: center;
            color: #888;
            pointer-events: none;
            transition: all 0.3s;
        }
        
        .drop-zone.drag-over {
            border-color: #4CAF50;
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš€ Electronç‰ˆ6ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ±åˆã‚·ã‚¹ãƒ†ãƒ </h1>
        <p><strong>ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªv2.0 - å‹•ä½œç¢ºèªæ¸ˆã¿ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°çµ±åˆ</strong></p>
    </div>

    <div class="main-container">
        <!-- å·¦ãƒ‘ãƒãƒ«: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç† -->
        <div class="left-panel">
            <h3>ğŸ­ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§</h3>
            <div class="character-list">
                <div class="character-item" draggable="true" data-character="nezumi">
                    <div class="character-icon">ğŸ­</div>
                    <div>
                        <div><strong>nezumi</strong></div>
                        <div style="font-size: 11px; color: #aaa;">ãƒ‰ãƒ©ãƒƒã‚°ã§é…ç½®</div>
                    </div>
                </div>
                
                <div class="character-item" draggable="true" data-character="purattokun">
                    <div class="character-icon">ğŸ±</div>
                    <div>
                        <div><strong>purattokun</strong></div>
                        <div style="font-size: 11px; color: #aaa;">ãƒ‰ãƒ©ãƒƒã‚°ã§é…ç½®</div>
                    </div>
                </div>
            </div>

            <div class="module-info">
                <h4>ğŸ“Š ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ</h4>
                <div style="font-size: 11px;">
                    <div>âœ… 1. spine-webgl-working.js</div>
                    <div>âœ… 2. Canvasç®¡ç†</div>
                    <div>âœ… 3. SpineActorManager</div>
                    <div>âœ… 4. å‹•ä½œç¢ºèªæ¸ˆã¿ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°</div>
                    <div>âœ… 5. ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                    <div>âœ… 6. Electronçµ±åˆ</div>
                </div>
                <div style="margin-top: 8px; color: #4CAF50;">
                    <strong>å‰Šæ¸›åŠ¹æœ: 21 â†’ 6ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (85%å‰Šæ¸›)</strong>
                </div>
            </div>
            
            <div class="module-info" style="margin-top: 15px;">
                <h4>ğŸ“ Phase 11å®Œäº†æ©Ÿèƒ½</h4>
                <div style="font-size: 11px;">
                    <div>âœ… HTMLãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†</div>
                    <div>âœ… Spineã‚¢ã‚»ãƒƒãƒˆç®¡ç†</div>
                    <div>âœ… è‡ªå‹•ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ã‚­ãƒ£ãƒ³</div>
                    <div>âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è‡ªå‹•æ¤œå‡º</div>
                    <div>âœ… å±¥æ­´ãƒ»è¨­å®šä¿å­˜</div>
                </div>
            </div>
            
            <div class="module-info" style="margin-top: 15px;">
                <h4>âš¡ Electronæ©Ÿèƒ½</h4>
                <div style="font-size: 11px;">
                    <div>âœ… ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°</div>
                    <div>âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼çµ±åˆ</div>
                    <div>âœ… ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</div>
                    <div>âœ… ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥</div>
                    <div>âœ… ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹</div>
                </div>
            </div>
        </div>

        <!-- å³ãƒ‘ãƒãƒ«: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <div class="right-panel">
            <canvas id="spine-canvas" width="800" height="600"></canvas>
            
            <div class="controls">
                <button onclick="clearAllCharacters()">ğŸ§¹ å…¨ã‚¯ãƒªã‚¢</button>
                <button onclick="showActorInfo()">ğŸ“Š ã‚¢ã‚¯ã‚¿ãƒ¼æƒ…å ±</button>
                <button onclick="testLoadNezumi()">ğŸ­ nezumiç›´æ¥èª­ã¿è¾¼ã¿</button>
                <button onclick="testLoadPurattokun()">ğŸ± purattokunç›´æ¥èª­ã¿è¾¼ã¿</button>
                <button onclick="openProjectFolder()">ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€</button>
                <button onclick="openSpineFolder()">ğŸ­ Spineãƒ•ã‚©ãƒ«ãƒ€é¸æŠ</button>
                <button onclick="exportProject()">ğŸ’¾ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‡ºåŠ›</button>
            </div>
            
            <div id="status" class="status">
                ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...
            </div>
            
            <div class="drop-zone" id="drop-zone">
                ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—
            </div>
        </div>
    </div>

    <!-- å‹•ä½œç¢ºèªæ¸ˆã¿Spine WebGLãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="assets/spine/spine-webgl-working.js"></script>

    <script>
        // ğŸš€ Phase 10-B: Electronç‰ˆ6ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ±åˆã‚·ã‚¹ãƒ†ãƒ 
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let canvas, gl, renderer;
        let electronSpineActorManager = null;
        let activeCharacters = new Map(); // character ID -> character data
        let nextCharacterId = 1;
        
        // åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ Electronç‰ˆ6ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
            updateStatus('Electronç’°å¢ƒç¢ºèªä¸­...');
            
            try {
                // Electronç’°å¢ƒç¢ºèª
                if (!window.electronAPI) {
                    throw new Error('Electronç’°å¢ƒãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
                }
                console.log('âœ… Electron APIç¢ºèªå®Œäº†');
                
                // WebGLåˆæœŸåŒ–ï¼ˆå‹•ä½œç¢ºèªæ¸ˆã¿è¨­å®šï¼‰
                await initializeWebGL();
                
                // Spineãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å¾…ã¡
                await waitForSpine();
                
                // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼åˆæœŸåŒ–ï¼ˆå‹•ä½œç¢ºèªæ¸ˆã¿ï¼‰
                renderer = new spine.SceneRenderer(canvas, gl);
                console.log('âœ… SceneRendereråˆæœŸåŒ–å®Œäº†');
                
                // ElectronSpineActorManageråˆæœŸåŒ–
                initElectronSpineActorManager();
                
                // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
                setupDragAndDrop();
                
                // Electronãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­å®š
                setupElectronHandlers();
                
                // Phase 11-C: ä¿å­˜ã•ã‚ŒãŸè¨­å®šã®è‡ªå‹•å¾©å…ƒ
                await restoreSavedSettings();
                
                console.log('âœ… Electronç‰ˆ6ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
                updateStatus('âœ… åˆæœŸåŒ–å®Œäº† - ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é…ç½®å¯èƒ½');
                
                // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³éè¡¨ç¤º
                document.getElementById('drop-zone').style.display = 'none';
                
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                updateStatus(`âŒ åˆæœŸåŒ–å¤±æ•—: ${error.message}`);
            }
        });
        
        // WebGLåˆæœŸåŒ–ï¼ˆå‹•ä½œç¢ºèªæ¸ˆã¿è¨­å®šã‚’å®Œå…¨è¤‡è£½ï¼‰
        async function initializeWebGL() {
            updateStatus('WebGLåˆæœŸåŒ–ä¸­...');
            
            canvas = document.getElementById('spine-canvas');
            
            // ğŸ¯ å‹•ä½œç‰ˆã¨å®Œå…¨åŒä¸€ã®WebGLè¨­å®š
            gl = canvas.getContext('webgl', { alpha: true, premultipliedAlpha: false });
            
            if (!gl) {
                throw new Error('WebGLæœªå¯¾å¿œ');
            }
            
            console.log('âœ… WebGLåˆæœŸåŒ–å®Œäº†:', gl.getParameter(gl.VERSION));
            updateStatus('WebGLåˆæœŸåŒ–å®Œäº†');
        }
        
        // Spineèª­ã¿è¾¼ã¿å¾…ã¡
        async function waitForSpine() {
            return new Promise((resolve) => {
                const check = () => {
                    if (typeof spine !== 'undefined' && spine.AssetManager) {
                        console.log('âœ… Spine WebGL ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å®Œäº†');
                        resolve();
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }
        
        // ElectronSpineActorManageråˆæœŸåŒ–ï¼ˆ6ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ±åˆ + Electronæ©Ÿèƒ½ï¼‰
        function initElectronSpineActorManager() {
            electronSpineActorManager = {
                actors: [],
                actorsById: new Map(),
                nextId: 1,
                
                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ 
                async attachCharacter(characterName, position = { x: 0, y: 0 }) {
                    const actorId = this.nextId++;
                    console.log(`ğŸ­ ElectronSpineActorManager: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ é–‹å§‹ ${characterName} (ID: ${actorId})`);
                    
                    try {
                        // å‹•ä½œç¢ºèªæ¸ˆã¿ã®èª­ã¿è¾¼ã¿å‡¦ç†
                        const characterData = await loadCharacterData(characterName);
                        
                        const actor = {
                            id: actorId,
                            name: characterName,
                            skeleton: characterData.skeleton,
                            animationState: characterData.animationState,
                            position: position
                        };
                        
                        this.actors.push(actor);
                        this.actorsById.set(actorId, actor);
                        activeCharacters.set(actorId, actor);
                        
                        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹/æ›´æ–°
                        if (this.actors.length === 1) {
                            startMultiCharacterRender();
                        }
                        
                        console.log(`âœ… ElectronSpineActorManager: ${characterName} è¿½åŠ å®Œäº† (ID: ${actorId})`);
                        updateStatus(`âœ… ${characterName} è¿½åŠ å®Œäº† (ã‚¢ã‚¯ã‚¿ãƒ¼æ•°: ${this.actors.length})`);
                        
                        // Electroné€šçŸ¥
                        this.showDesktopNotification(`${characterName}ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
                        
                        return actorId;
                        
                    } catch (error) {
                        console.error(`âŒ ElectronSpineActorManager: ${characterName} è¿½åŠ å¤±æ•—:`, error);
                        updateStatus(`âŒ ${characterName} è¿½åŠ å¤±æ•—: ${error.message}`);
                        return null;
                    }
                },
                
                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤
                removeCharacter(actorId) {
                    const actor = this.actorsById.get(actorId);
                    if (actor) {
                        const index = this.actors.findIndex(a => a.id === actorId);
                        if (index !== -1) {
                            this.actors.splice(index, 1);
                        }
                        this.actorsById.delete(actorId);
                        activeCharacters.delete(actorId);
                        
                        console.log(`âœ… ElectronSpineActorManager: ${actor.name} å‰Šé™¤å®Œäº† (ID: ${actorId})`);
                        updateStatus(`âœ… ${actor.name} å‰Šé™¤å®Œäº† (ã‚¢ã‚¯ã‚¿ãƒ¼æ•°: ${this.actors.length})`);
                    }
                },
                
                // å…¨ã‚¯ãƒªã‚¢
                clearAll() {
                    this.actors = [];
                    this.actorsById.clear();
                    activeCharacters.clear();
                    console.log('âœ… ElectronSpineActorManager: å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¯ãƒªã‚¢å®Œäº†');
                    updateStatus('âœ… å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¯ãƒªã‚¢å®Œäº†');
                },
                
                // Electroné€šçŸ¥æ©Ÿèƒ½
                showDesktopNotification(message) {
                    if (window.electronAPI) {
                        // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥ï¼ˆå°†æ¥å®Ÿè£…äºˆå®šï¼‰
                        console.log(`ğŸ”” é€šçŸ¥: ${message}`);
                    }
                }
            };
            
            console.log('âœ… ElectronSpineActorManageråˆæœŸåŒ–å®Œäº†');
        }
        
        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆå‹•ä½œç¢ºèªæ¸ˆã¿å®Ÿè£…ï¼‰
        async function loadCharacterData(characterName) {
            const basePath = `assets/spine/characters/${characterName}/`;
            const assetManager = new spine.AssetManager(gl, basePath);
            
            assetManager.loadTextureAtlas(`${characterName}.atlas`);
            assetManager.loadJson(`${characterName}.json`);
            
            // èª­ã¿è¾¼ã¿å®Œäº†å¾…ã¡
            await waitForAssets(assetManager);
            
            // å‹•ä½œç¢ºèªæ¸ˆã¿ã®ã‚¢ã‚»ãƒƒãƒˆå–å¾—
            const atlas = assetManager.get(`${characterName}.atlas`);
            const atlasLoader = new spine.AtlasAttachmentLoader(atlas);
            const skeletonJson = new spine.SkeletonJson(atlasLoader);
            const skeletonData = skeletonJson.readSkeletonData(
                assetManager.get(`${characterName}.json`)
            );
            
            // å‹•ä½œç¢ºèªæ¸ˆã¿ã®åº§æ¨™è¨­å®š
            const skeleton = new spine.Skeleton(skeletonData);
            skeleton.x = 0;
            skeleton.y = 0;
            skeleton.scaleX = skeleton.scaleY = 1.0;
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
            const animationStateData = new spine.AnimationStateData(skeletonData);
            const animationState = new spine.AnimationState(animationStateData);
            
            if (skeletonData.animations.length > 0) {
                animationState.setAnimation(0, skeletonData.animations[0].name, true);
            }
            
            return { skeleton, animationState };
        }
        
        // ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å®Œäº†å¾…ã¡
        async function waitForAssets(assetManager) {
            return new Promise((resolve, reject) => {
                let count = 0;
                const check = () => {
                    if (assetManager.isLoadingComplete()) {
                        resolve();
                    } else if (count++ > 100) {
                        reject(new Error('èª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }
        
        // ãƒãƒ«ãƒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆå‹•ä½œç¢ºèªæ¸ˆã¿ãƒ™ãƒ¼ã‚¹ï¼‰
        function startMultiCharacterRender() {
            let lastTime = Date.now() / 1000;
            
            function render() {
                const now = Date.now() / 1000;
                const delta = now - lastTime;
                lastTime = now;
                
                // å‹•ä½œç¢ºèªæ¸ˆã¿ã®ã‚¯ãƒªã‚¢å‡¦ç†
                gl.clearColor(0, 0, 0, 0);
                gl.clear(gl.COLOR_BUFFER_BIT);
                gl.viewport(0, 0, canvas.width, canvas.height);
                
                // ã‚«ãƒ¡ãƒ©è¨­å®š
                renderer.camera.setViewport(canvas.width, canvas.height);
                
                // æç”»é–‹å§‹
                renderer.begin();
                
                // å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æç”»
                electronSpineActorManager.actors.forEach(actor => {
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
                    actor.animationState.update(delta);
                    actor.animationState.apply(actor.skeleton);
                    actor.skeleton.updateWorldTransform();
                    
                    // æç”»ï¼ˆå‹•ä½œç¢ºèªæ¸ˆã¿è¨­å®šï¼‰
                    renderer.drawSkeleton(actor.skeleton, true);
                });
                
                // æç”»çµ‚äº†
                renderer.end();
                
                requestAnimationFrame(render);
            }
            
            console.log('ğŸ¬ Electronç‰ˆãƒãƒ«ãƒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹');
            render();
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
        function setupDragAndDrop() {
            const canvas = document.getElementById('spine-canvas');
            const dropZone = document.getElementById('drop-zone');
            
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ‰ãƒ©ãƒƒã‚°è¨­å®š
            document.querySelectorAll('.character-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    const characterName = item.dataset.character;
                    e.dataTransfer.setData('text/plain', characterName);
                    console.log(`ğŸ”„ ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹: ${characterName}`);
                });
            });
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
            canvas.addEventListener('dragenter', (e) => {
                e.preventDefault();
                dropZone.style.display = 'block';
                dropZone.classList.add('drag-over');
            });
            
            canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            canvas.addEventListener('dragleave', (e) => {
                e.preventDefault();
                if (!canvas.contains(e.relatedTarget)) {
                    dropZone.classList.remove('drag-over');
                    setTimeout(() => dropZone.style.display = 'none', 200);
                }
            });
            
            canvas.addEventListener('drop', async (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                dropZone.style.display = 'none';
                
                const characterName = e.dataTransfer.getData('text/plain');
                if (characterName) {
                    console.log(`ğŸ“¥ ãƒ‰ãƒ­ãƒƒãƒ—å—ä¿¡: ${characterName}`);
                    await electronSpineActorManager.attachCharacter(characterName);
                }
            });
            
            console.log('âœ… ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®šå®Œäº†');
        }
        
        // Electronãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­å®š
        function setupElectronHandlers() {
            if (!window.electronAPI) return;
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡
            window.electronAPI.onMenuAction((event, data) => {
                console.log('ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å—ä¿¡:', event.sender);
            });
            
            console.log('âœ… Electronãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­å®šå®Œäº†');
        }
        
        // Phase 11-C: ä¿å­˜ã•ã‚ŒãŸè¨­å®šã®è‡ªå‹•å¾©å…ƒ
        async function restoreSavedSettings() {
            try {
                // ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹å¾©å…ƒ
                const savedProjectPath = localStorage.getItem('spine-editor-project-path');
                const savedSpinePath = localStorage.getItem('spine-editor-spine-path');
                
                console.log('ğŸ”„ ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’å¾©å…ƒä¸­:');
                console.log('  - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹:', savedProjectPath);
                console.log('  - Spineãƒ‘ã‚¹:', savedSpinePath);
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€è‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆãƒ‘ã‚¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
                if (savedProjectPath && window.electronAPI) {
                    try {
                        const exists = await window.electronAPI.fs.pathExists(savedProjectPath);
                        if (exists) {
                            console.log('âœ… ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹ãŒæœ‰åŠ¹ - è‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ');
                            await scanProjectFolder(savedProjectPath);
                        } else {
                            console.warn('âš ï¸ ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹ãŒç„¡åŠ¹:', savedProjectPath);
                            localStorage.removeItem('spine-editor-project-path');
                        }
                    } catch (error) {
                        console.warn('âš ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error.message);
                    }
                }
                
                // Spineãƒ•ã‚©ãƒ«ãƒ€è‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆãƒ‘ã‚¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
                if (savedSpinePath && window.electronAPI) {
                    try {
                        const exists = await window.electronAPI.fs.pathExists(savedSpinePath);
                        if (exists) {
                            console.log('âœ… ä¿å­˜ã•ã‚ŒãŸSpineãƒ‘ã‚¹ãŒæœ‰åŠ¹ - è‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ');
                            await scanSpineFolder(savedSpinePath);
                        } else {
                            console.warn('âš ï¸ ä¿å­˜ã•ã‚ŒãŸSpineãƒ‘ã‚¹ãŒç„¡åŠ¹:', savedSpinePath);
                            localStorage.removeItem('spine-editor-spine-path');
                        }
                    } catch (error) {
                        console.warn('âš ï¸ Spineãƒ‘ã‚¹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error.message);
                    }
                }
                
                // ä½•ã‚‰ã‹ã®å¾©å…ƒãŒæˆåŠŸã—ãŸå ´åˆã®é€šçŸ¥
                if (savedProjectPath || savedSpinePath) {
                    updateStatus('ğŸ”„ å‰å›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‚’å¾©å…ƒã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.error('âŒ è¨­å®šå¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
                updateStatus(`âŒ è¨­å®šå¾©å…ƒå¤±æ•—: ${error.message}`);
            }
        }
        
        // UIé–¢æ•°
        window.clearAllCharacters = () => {
            if (electronSpineActorManager) {
                electronSpineActorManager.clearAll();
            }
        };
        
        window.showActorInfo = () => {
            if (electronSpineActorManager) {
                console.log('ğŸ“Š ç¾åœ¨ã®ã‚¢ã‚¯ã‚¿ãƒ¼æƒ…å ±:', electronSpineActorManager.actors);
                updateStatus(`ğŸ“Š ã‚¢ã‚¯ã‚¿ãƒ¼æ•°: ${electronSpineActorManager.actors.length}`);
            }
        };
        
        window.testLoadNezumi = async () => {
            if (electronSpineActorManager) {
                await electronSpineActorManager.attachCharacter('nezumi');
            }
        };
        
        window.testLoadPurattokun = async () => {
            if (electronSpineActorManager) {
                await electronSpineActorManager.attachCharacter('purattokun');
            }
        };
        
        // Electronå°‚ç”¨æ©Ÿèƒ½
        window.openSpineFolder = async () => {
            if (!window.electronAPI) {
                updateStatus('âŒ Electronç’°å¢ƒãŒå¿…è¦ã§ã™');
                return;
            }
            
            try {
                const result = await window.electronAPI.fs.selectFolder({
                    title: 'Spineãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ',
                    buttonLabel: 'ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ'
                });
                
                if (!result.canceled && result.filePaths.length > 0) {
                    const folderPath = result.filePaths[0];
                    console.log('ğŸ“ Spineãƒ•ã‚©ãƒ«ãƒ€é¸æŠ:', folderPath);
                    updateStatus(`ğŸ“ Spineãƒ•ã‚©ãƒ«ãƒ€é¸æŠ: ${folderPath}`);
                    
                    // Phase 11-B: Spineãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ã‚­ãƒ£ãƒ³
                    await scanSpineFolder(folderPath);
                }
            } catch (error) {
                console.error('âŒ Spineãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚¨ãƒ©ãƒ¼:', error);
                updateStatus(`âŒ Spineãƒ•ã‚©ãƒ«ãƒ€é¸æŠå¤±æ•—: ${error.message}`);
            }
        };
        
        // Phase 11-A: HTMLãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ãæ©Ÿèƒ½
        window.openProjectFolder = async () => {
            if (!window.electronAPI) {
                updateStatus('âŒ Electronç’°å¢ƒãŒå¿…è¦ã§ã™');
                return;
            }
            
            try {
                const result = await window.electronAPI.fs.selectFolder({
                    title: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ',
                    buttonLabel: 'ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ'
                });
                
                if (!result.canceled && result.filePaths.length > 0) {
                    const folderPath = result.filePaths[0];
                    console.log('ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€é¸æŠ:', folderPath);
                    updateStatus(`ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€é¸æŠ: ${folderPath}`);
                    
                    // HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ã‚­ãƒ£ãƒ³
                    await scanProjectFolder(folderPath);
                    
                    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹ä¿å­˜
                    localStorage.setItem('spine-editor-project-path', folderPath);
                }
            } catch (error) {
                console.error('âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚¨ãƒ©ãƒ¼:', error);
                updateStatus(`âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€é¸æŠå¤±æ•—: ${error.message}`);
            }
        };
        
        window.exportProject = async () => {
            if (!window.electronAPI) {
                updateStatus('âŒ Electronç’°å¢ƒãŒå¿…è¦ã§ã™');
                return;
            }
            
            try {
                const result = await window.electronAPI.saveFileDialog({
                    title: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜',
                    defaultPath: 'spine-project.json',
                    filters: [
                        { name: 'JSON Files', extensions: ['json'] }
                    ]
                });
                
                if (!result.canceled && result.filePath) {
                    const projectData = {
                        version: '2.0',
                        characters: electronSpineActorManager.actors.map(actor => ({
                            id: actor.id,
                            name: actor.name,
                            position: actor.position
                        })),
                        timestamp: new Date().toISOString()
                    };
                    
                    await window.electronAPI.fs.writeFile(result.filePath, JSON.stringify(projectData, null, 2));
                    console.log('ğŸ’¾ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜å®Œäº†:', result.filePath);
                    updateStatus('ğŸ’¾ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜å®Œäº†');
                }
            } catch (error) {
                console.error('âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                updateStatus(`âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜å¤±æ•—: ${error.message}`);
            }
        };
        
        // Phase 11-A: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½
        async function scanProjectFolder(folderPath) {
            try {
                updateStatus('ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ä¸­...');
                
                // Electronãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ çµŒç”±ã§ã‚¹ã‚­ãƒ£ãƒ³
                const scanResult = await window.electronAPI.fs.scanDirectory(folderPath, ['.html']);
                
                if (scanResult.success) {
                    const htmlFiles = scanResult.files.html || [];
                    console.log(`âœ… HTMLãƒ•ã‚¡ã‚¤ãƒ« ${htmlFiles.length}å€‹ç™ºè¦‹:`, htmlFiles);
                    
                    updateProjectFilesList(htmlFiles);
                    updateStatus(`âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¹ã‚­ãƒ£ãƒ³å®Œäº†: HTMLãƒ•ã‚¡ã‚¤ãƒ«${htmlFiles.length}å€‹ç™ºè¦‹`);
                } else {
                    console.error('âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼:', scanResult.error);
                    updateStatus(`âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—: ${scanResult.error}`);
                }
            } catch (error) {
                console.error('âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                updateStatus(`âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // Phase 11-B: Spineãƒ•ã‚©ãƒ«ãƒ€ã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½
        async function scanSpineFolder(folderPath) {
            try {
                updateStatus('ğŸ­ Spineãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ä¸­...');
                
                // Electronãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ çµŒç”±ã§ã‚¹ã‚­ãƒ£ãƒ³
                const scanResult = await window.electronAPI.fs.scanDirectory(folderPath, ['.json', '.atlas', '.png']);
                
                if (scanResult.success) {
                    const files = scanResult.files;
                    const jsonFiles = files.json || [];
                    const atlasFiles = files.atlas || [];
                    const pngFiles = files.png || [];
                    
                    console.log(`âœ… Spineãƒ•ã‚¡ã‚¤ãƒ«ç™ºè¦‹: JSON ${jsonFiles.length}å€‹, Atlas ${atlasFiles.length}å€‹, PNG ${pngFiles.length}å€‹`);
                    
                    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è‡ªå‹•æ¤œå‡º
                    const detectedCharacters = detectSpineCharacters(jsonFiles, atlasFiles);
                    updateSpineCharactersList(detectedCharacters);
                    
                    updateStatus(`âœ… Spineã‚¹ã‚­ãƒ£ãƒ³å®Œäº†: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼${detectedCharacters.length}å€‹ç™ºè¦‹`);
                    
                    // Spineãƒ‘ã‚¹ä¿å­˜
                    localStorage.setItem('spine-editor-spine-path', folderPath);
                } else {
                    console.error('âŒ Spineã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼:', scanResult.error);
                    updateStatus(`âŒ Spineã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—: ${scanResult.error}`);
                }
            } catch (error) {
                console.error('âŒ Spineã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                updateStatus(`âŒ Spineã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è‡ªå‹•æ¤œå‡º
        function detectSpineCharacters(jsonFiles, atlasFiles) {
            const characters = [];
            const basenames = new Set();
            
            // JSON ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã§æ¤œå‡º
            jsonFiles.forEach(jsonPath => {
                const basename = jsonPath.replace(/\.[^/.]+$/, '').split(/[/\\]/).pop();
                if (!basenames.has(basename)) {
                    const atlasPath = atlasFiles.find(atlas => atlas.includes(basename + '.atlas'));
                    if (atlasPath) {
                        characters.push({
                            name: basename,
                            jsonPath: jsonPath,
                            atlasPath: atlasPath,
                            folder: jsonPath.substring(0, jsonPath.lastIndexOf('/'))
                        });
                        basenames.add(basename);
                    }
                }
            });
            
            return characters;
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§æ›´æ–°
        function updateProjectFilesList(htmlFiles) {
            const characterList = document.querySelector('.character-list');
            
            // æ—¢å­˜ã®é …ç›®ã‚’ã‚¯ãƒªã‚¢ï¼ˆçµ„ã¿è¾¼ã¿ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯ä¿æŒï¼‰
            const existingItems = characterList.querySelectorAll('.character-item[data-type="project"]');
            existingItems.forEach(item => item.remove());
            
            // HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
            htmlFiles.forEach(htmlPath => {
                const fileName = htmlPath.split(/[/\\]/).pop();
                const characterItem = document.createElement('div');
                characterItem.className = 'character-item';
                characterItem.setAttribute('data-type', 'project');
                characterItem.setAttribute('data-path', htmlPath);
                
                characterItem.innerHTML = `
                    <div class="character-icon">ğŸ“„</div>
                    <div>
                        <div><strong>${fileName}</strong></div>
                        <div style="font-size: 11px; color: #aaa;">HTMLãƒ•ã‚¡ã‚¤ãƒ«</div>
                    </div>
                `;
                
                // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                characterItem.addEventListener('click', () => {
                    console.log('ğŸ“„ HTMLãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ:', htmlPath);
                    // å°†æ¥çš„ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚’å®Ÿè£…
                });
                
                characterList.appendChild(characterItem);
            });
        }
        
        // Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§æ›´æ–°
        function updateSpineCharactersList(characters) {
            const characterList = document.querySelector('.character-list');
            
            // æ—¢å­˜ã®Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é …ç›®ã‚’ã‚¯ãƒªã‚¢ï¼ˆçµ„ã¿è¾¼ã¿ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯ä¿æŒï¼‰
            const existingItems = characterList.querySelectorAll('.character-item[data-type="spine"]');
            existingItems.forEach(item => item.remove());
            
            // æ¤œå‡ºã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¿½åŠ 
            characters.forEach(character => {
                const characterItem = document.createElement('div');
                characterItem.className = 'character-item';
                characterItem.setAttribute('draggable', 'true');
                characterItem.setAttribute('data-character', character.name);
                characterItem.setAttribute('data-type', 'spine');
                characterItem.setAttribute('data-folder', character.folder);
                
                // ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠ
                const icon = character.name.includes('nezumi') ? 'ğŸ­' : 
                           character.name.includes('puratto') ? 'ğŸ±' : 'ğŸ­';
                
                characterItem.innerHTML = `
                    <div class="character-icon">${icon}</div>
                    <div>
                        <div><strong>${character.name}</strong></div>
                        <div style="font-size: 11px; color: #aaa;">ãƒ‰ãƒ©ãƒƒã‚°ã§é…ç½®</div>
                    </div>
                `;
                
                // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
                characterItem.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', character.name);
                    console.log(`ğŸ”„ ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹: ${character.name}`);
                });
                
                characterList.appendChild(characterItem);
            });
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log('ğŸ“Š Status:', message);
        }
        
        console.log('ğŸš€ Electronç‰ˆ6ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†');
    </script>
</body>
</html>