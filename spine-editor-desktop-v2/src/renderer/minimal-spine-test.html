<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ğŸš€ æœ€å°Spineãƒ†ã‚¹ãƒˆ - 3ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        #spine-canvas {
            border: 2px solid #333;
            background: transparent;
            display: block;
            margin: 20px auto;
        }
        
        .controls {
            text-align: center;
            margin: 20px;
        }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #007acc;
            color: white;
        }
        
        button:hover {
            background: #005a9e;
        }
        
        .status {
            text-align: center;
            margin: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .comparison {
            margin: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ æœ€å°Spineãƒ†ã‚¹ãƒˆï¼ˆ3ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿ï¼‰</h1>
    
    <div class="comparison">
        <h3>ğŸ“Š ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å‰Šæ¸›åŠ¹æœ</h3>
        <p><strong>å¾“æ¥ã‚·ã‚¹ãƒ†ãƒ :</strong> 21ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç©ã¿é‡ãªã‚Š</p>
        <p><strong>æœ€å°ã‚·ã‚¹ãƒ†ãƒ :</strong> 3ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿</p>
        <ul>
            <li>âœ… spine-webgl.js - WebGLãƒ©ã‚¤ãƒ–ãƒ©ãƒª</li>
            <li>âœ… HTML5 Canvas - åŸºæœ¬Canvas</li>  
            <li>âœ… minimal-render.js - æœ€å°æç”»ãƒ­ã‚¸ãƒƒã‚¯</li>
        </ul>
    </div>

    <canvas id="spine-canvas" width="800" height="600"></canvas>
    
    <div class="controls">
        <button onclick="loadNezumi()">ğŸ­ nezumièª­ã¿è¾¼ã¿</button>
        <button onclick="loadPurattokun()">ğŸ± purattokunèª­ã¿è¾¼ã¿</button>
        <button onclick="clearCanvas()">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
        <button onclick="toggleBackground()">ğŸ¨ èƒŒæ™¯åˆ‡ã‚Šæ›¿ãˆ</button>
        <button onclick="diagnosticBlackEdge()" style="background: #dc3545;">ğŸ” é»’ç¸è¨ºæ–­</button>
        <button onclick="testBlackEdgeFix()" style="background: #fd7e14;">ğŸ”¬ é»’ç¸ä¿®æ­£å®Ÿé¨“</button>
    </div>
    
    <div id="status" class="status">
        ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...
    </div>

    <!-- ğŸš€ Phase 4: å‹•ä½œç¢ºèªæ¸ˆã¿Spine WebGLãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«åˆ‡ã‚Šæ›¿ãˆ -->
    <script src="assets/spine/spine-webgl-working.js"></script>
    
    <!-- ğŸš€ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«3: æœ€å°æç”»ãƒ­ã‚¸ãƒƒã‚¯ -->
    <script>
        // ğŸš€ æœ€å°å®Ÿè£…é–‹å§‹
        console.log('ğŸš€ æœ€å°Spineã‚·ã‚¹ãƒ†ãƒ é–‹å§‹ï¼ˆ3ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿ï¼‰');
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆæœ€å°é™ï¼‰
        let canvas, gl, spineRenderer = {};
        let currentCharacter = null;
        let animationId = null;
        let backgroundDark = false;
        
        // ğŸš€ åˆæœŸåŒ–
        async function initMinimalSpineSystem() {
            updateStatus('WebGLåˆæœŸåŒ–ä¸­...');
            
            // Canvaså–å¾—ï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«2: HTML5 Canvasï¼‰
            canvas = document.getElementById('spine-canvas');
            
            // ğŸš€ Phase 7: å‹•ä½œç‰ˆã¨å®Œå…¨åŒä¸€WebGLè¨­å®š
            const contextOptions = {
                alpha: true,
                premultipliedAlpha: false // å‹•ä½œç‰ˆã¨åŒã˜è¨­å®š
            };
            
            // ğŸš€ Phase 7: å‹•ä½œç‰ˆã¨å®Œå…¨åŒä¸€ï¼ˆwebglã®ã¿ä½¿ç”¨ï¼‰
            gl = canvas.getContext('webgl', contextOptions);
            
            if (!gl) {
                throw new Error('WebGL not supported');
            }
            
            console.log('âœ… WebGLåˆæœŸåŒ–å®Œäº†:', gl.getParameter(gl.VERSION));
            
            // ğŸš€ Phase 7: å‹•ä½œç‰ˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°è¨­å®šã¯æœ€å°é™ã®ã¿
            
            // Spine WebGLå¾…æ©Ÿ
            await waitForSpine();
            
            updateStatus('âœ… æœ€å°Spineã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
            console.log('âœ… æœ€å°ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº† - å•é¡Œãƒ†ã‚¹ãƒˆå¯èƒ½');
        }
        
        // Spineèª­ã¿è¾¼ã¿å¾…æ©Ÿï¼ˆæœ€å°ç‰ˆï¼‰
        async function waitForSpine() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                const check = () => {
                    if (typeof spine !== 'undefined' && spine.AssetManager) {
                        console.log('âœ… Spine WebGLèª­ã¿è¾¼ã¿å®Œäº†ï¼ˆæœ€å°ç‰ˆï¼‰');
                        resolve();
                    } else if (attempts++ >= maxAttempts) {
                        reject(new Error('Spineèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }
        
        // ğŸš€ æœ€å°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿
        async function loadCharacter(characterName) {
            try {
                updateStatus(`${characterName}èª­ã¿è¾¼ã¿ä¸­...`);
                
                // æ—¢å­˜ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¯ãƒªã‚¢
                if (currentCharacter) {
                    clearCanvas();
                }
                
                // ã‚¢ã‚»ãƒƒãƒˆãƒ‘ã‚¹ï¼ˆæœ€å°æ§‹æˆï¼‰
                const basePath = `assets/spine/characters/${characterName}/`;
                const assetManager = new spine.AssetManager(gl, basePath);
                
                // åŸºæœ¬ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿
                assetManager.loadTextureAtlas(`${characterName}.atlas`);
                assetManager.loadJson(`${characterName}.json`);
                
                // èª­ã¿è¾¼ã¿å®Œäº†å¾…æ©Ÿ
                await waitForAssets(assetManager);
                
                // ğŸš€ Phase 7: å‹•ä½œç‰ˆã¨åŒä¸€ã®ã‚¢ã‚»ãƒƒãƒˆå–å¾—æ–¹æ³•
                const atlas = assetManager.get(`${characterName}.atlas`);
                const skeletonData = assetManager.get(`${characterName}.json`);
                
                const atlasLoader = new spine.AtlasAttachmentLoader(atlas);
                const skeletonJson = new spine.SkeletonJson(atlasLoader);
                const skeleton = new spine.Skeleton(skeletonJson.readSkeletonData(skeletonData));
                
                // ğŸš€ ã‚·ãƒ³ãƒ—ãƒ«åº§æ¨™ï¼ˆä¸­å¤®é…ç½®ï¼‰
                skeleton.x = 0;
                skeleton.y = 0;
                skeleton.scaleX = skeleton.scaleY = 1.0;
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
                const animationStateData = new spine.AnimationStateData(skeleton.data);
                const animationState = new spine.AnimationState(animationStateData);
                
                if (skeleton.data.animations.length > 0) {
                    animationState.setAnimation(0, skeleton.data.animations[0].name, true);
                }
                
                skeleton.updateWorldTransform();
                
                // ğŸš€ Phase 4: PMAå¯¾å¿œSceneRendereråˆæœŸåŒ–ï¼ˆã‚¢ã‚»ãƒƒãƒˆ=PMAã€WebGL=Straightè¨­å®šï¼‰
                spineRenderer.instance = new spine.SceneRenderer(canvas, gl);
                
                // ğŸš€ Phase 6: æœ€å°æ§‹æˆã§å®‰å®šæ€§ç¢ºä¿
                console.log('âœ… Phase 6: åŸºæœ¬è¨­å®šã§åˆæœŸåŒ–å®Œäº†ï¼ˆå®‰å®šæ€§æœ€å„ªå…ˆï¼‰');
                
                currentCharacter = {
                    skeleton,
                    animationState,
                    name: characterName
                };
                
                // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹
                startRendering();
                
                updateStatus(`âœ… ${characterName}èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆæœ€å°ç‰ˆï¼‰`);
                console.log(`âœ… ${characterName}èª­ã¿è¾¼ã¿å®Œäº† - å•é¡Œæ¤œè¨¼é–‹å§‹`);
                
            } catch (error) {
                console.error(`âŒ ${characterName}èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:`, error);
                updateStatus(`âŒ ${characterName}èª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}`);
            }
        }
        
        // ğŸš€ Phase 4: å¼·åŒ–ã•ã‚ŒãŸã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å¾…æ©Ÿï¼ˆå®Œå…¨å¾…æ©Ÿï¼‰
        function waitForAssets(assetManager) {
            return new Promise((resolve, reject) => {
                let attemptCount = 0;
                const maxAttempts = 100; // 10ç§’å¾…æ©Ÿ
                
                const check = () => {
                    attemptCount++;
                    console.log(`ğŸ“¦ ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿ç¢ºèª ${attemptCount}/${maxAttempts}`);
                    
                    if (assetManager.isLoadingComplete()) {
                        // ğŸš€ Phase 4: è¿½åŠ å®‰å…¨å¾…æ©Ÿï¼ˆãƒ†ã‚¯ã‚¹ãƒãƒ£å®Œå…¨æº–å‚™ä¿è¨¼ï¼‰
                        setTimeout(() => {
                            console.log('âœ… ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å®Œäº† + å®‰å…¨å¾…æ©Ÿå®Œäº†');
                            resolve();
                        }, 500); // 500msè¿½åŠ å¾…æ©Ÿ
                    } else if (attemptCount >= maxAttempts) {
                        reject(new Error('ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }
        
        // ğŸš€ Phase 4: ãƒ•ãƒ¬ãƒ¼ãƒ å®‰å®šåŒ–ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆ1ãƒ•ãƒ¬ãƒ¼ãƒ è¡¨ç¤ºå•é¡Œå¯¾ç­–ï¼‰
        function startRendering() {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            
            let lastTime = Date.now() / 1000;
            let frameCount = 0;
            let isFirstFrame = true;
            
            const render = () => {
                if (!currentCharacter) return;
                
                const now = Date.now() / 1000;
                const delta = now - lastTime;
                lastTime = now;
                frameCount++;
                
                try {
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
                    currentCharacter.animationState.update(delta);
                    currentCharacter.animationState.apply(currentCharacter.skeleton);
                    currentCharacter.skeleton.updateWorldTransform();
                    
                    // ğŸš€ Phase 7: å‹•ä½œç‰ˆã¨å®Œå…¨åŒä¸€ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ‰‹é †
                    gl.clearColor(0, 0, 0, 0);
                    gl.clear(gl.COLOR_BUFFER_BIT);
                    gl.viewport(0, 0, canvas.width, canvas.height);
                    
                    // ã‚«ãƒ¡ãƒ©è¨­å®š
                    spineRenderer.instance.camera.setViewport(canvas.width, canvas.height);
                    
                    // æç”»
                    spineRenderer.instance.begin();
                    spineRenderer.instance.drawSkeleton(currentCharacter.skeleton, true);
                    spineRenderer.instance.end();
                    
                } catch (error) {
                    console.error('âŒ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
                }
                
                animationId = requestAnimationFrame(render);
            };
            
            console.log('ğŸ¬ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—é–‹å§‹ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ å®‰å®šåŒ–ç‰ˆï¼‰');
            animationId = requestAnimationFrame(render);
        }
        
        // ğŸš€ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«é–¢æ•°é…ç½®ï¼ˆHTMLã‹ã‚‰å‘¼ã³å‡ºã—å¯èƒ½ï¼‰
        window.loadNezumi = function() {
            loadCharacter('nezumi');
        };
        
        window.loadPurattokun = function() {
            loadCharacter('purattokun');
        };
        
        window.clearCanvas = function() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            currentCharacter = null;
            if (gl) {
                gl.clear(gl.COLOR_BUFFER_BIT);
            }
            updateStatus('ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªã‚¢å®Œäº†');
        };
        
        window.toggleBackground = function() {
            backgroundDark = !backgroundDark;
            document.body.style.background = backgroundDark ? '#222' : '#f0f0f0';
            updateStatus(`èƒŒæ™¯: ${backgroundDark ? 'é»’' : 'ç™½'}`);
        };
        
        // ğŸ” Phase 5: é»’ç¸å•é¡Œè¨ºæ–­ç”¨é–¢æ•°è¿½åŠ 
        window.diagnosticBlackEdge = function() {
            console.log('ğŸ” Phase 5: é»’ç¸å•é¡Œè¨ºæ–­é–‹å§‹');
            
            if (!currentCharacter) {
                console.warn('âš ï¸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            // ãƒ†ã‚¯ã‚¹ãƒãƒ£æƒ…å ±ç¢ºèª
            const skeleton = currentCharacter.skeleton;
            if (skeleton && skeleton.slots) {
                console.log('ğŸ“Š ã‚¹ãƒ­ãƒƒãƒˆãƒ»ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆæƒ…å ±:');
                skeleton.slots.forEach((slot, index) => {
                    const attachment = slot.getAttachment();
                    if (attachment && attachment.texture) {
                        console.log(`  Slot ${index} (${slot.data.name}):`);
                        console.log(`    - ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚µã‚¤ã‚º: ${attachment.texture.image.width}x${attachment.texture.image.height}`);
                        console.log(`    - UVs:`, attachment.uvs);
                        console.log(`    - åº§æ¨™:`, attachment.vertices);
                        
                        // WebGLãƒ†ã‚¯ã‚¹ãƒãƒ£çŠ¶æ…‹ç¢ºèª
                        const texture = attachment.texture;
                        if (texture._texture) {
                            console.log(`    - WebGLãƒ†ã‚¯ã‚¹ãƒãƒ£ID: ${texture._texture}`);
                        }
                    }
                });
            }
            
            // WebGLè¨­å®šå†ç¢ºèª
            console.log('ğŸ” ç¾åœ¨ã®WebGLè¨­å®š:');
            console.log('  - BLEND enabled:', gl.isEnabled(gl.BLEND));
            console.log('  - Blend func:', gl.getParameter(gl.BLEND_SRC_RGB), gl.getParameter(gl.BLEND_DST_RGB));
            console.log('  - UNPACK_PREMULTIPLY_ALPHA:', gl.getParameter(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL));
            console.log('  - Context attributes:', gl.getContextAttributes());
            
            updateStatus('ğŸ” é»’ç¸è¨ºæ–­å®Œäº† - ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‚ç…§');
        };
        
        // ğŸ” Phase 5: å®Ÿé¨“çš„é»’ç¸ä¿®æ­£ãƒ†ã‚¹ãƒˆ
        window.testBlackEdgeFix = function() {
            console.log('ğŸ”¬ Phase 5: å®Ÿé¨“çš„é»’ç¸ä¿®æ­£é–‹å§‹');
            
            if (!currentCharacter || !gl) return;
            
            // å®Ÿé¨“1: ãƒ–ãƒ¬ãƒ³ãƒ‰ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ãƒ†ã‚¹ãƒˆ
            console.log('ğŸ”¬ å®Ÿé¨“1: ãƒ–ãƒ¬ãƒ³ãƒ‰ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´');
            gl.blendFunc(gl.ONE, gl.ONE_MINUS_SRC_ALPHA); // PMAç”¨ã«æˆ»ã™
            
            setTimeout(() => {
                console.log('ğŸ”¬ å®Ÿé¨“2: Straight Alphaã«æˆ»ã™');
                gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
                
                setTimeout(() => {
                    console.log('ğŸ”¬ å®Ÿé¨“3: ONE_MINUS_DST_ALPHAãƒ†ã‚¹ãƒˆ');
                    gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_DST_ALPHA);
                    
                    setTimeout(() => {
                        console.log('ğŸ”¬ å®Ÿé¨“å®Œäº†: å…ƒã«æˆ»ã—ã¾ã™');
                        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
                        updateStatus('ğŸ”¬ é»’ç¸ä¿®æ­£å®Ÿé¨“å®Œäº†');
                    }, 2000);
                }, 2000);
            }, 2000);
            
            updateStatus('ğŸ”¬ é»’ç¸ä¿®æ­£å®Ÿé¨“å®Ÿè¡Œä¸­...');
        };
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log('ğŸ“Š Status:', message);
        }
        
        // ğŸš€ ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹
        window.addEventListener('DOMContentLoaded', () => {
            initMinimalSpineSystem().catch(error => {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                updateStatus(`âŒ åˆæœŸåŒ–å¤±æ•—: ${error.message}`);
            });
        });
        
        console.log('ğŸš€ æœ€å°Spineãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†');
    </script>
</body>
</html>