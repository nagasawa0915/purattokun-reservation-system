<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoPinSelector デバッグテスト</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .controls {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .controls button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .controls button:hover {
            background: #0056b3;
        }
        
        .test-elements {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }
        
        .test-element {
            background: white;
            border: 2px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            min-width: 100px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .test-element:hover {
            border-color: #007acc;
            background: #f0f8ff;
        }
        
        .small-element {
            width: 30px;   /* 最小サイズ10pxより大きい（選択可能） */
            height: 25px;
            background: #ff6b6b;
            min-width: unset;  /* 親の min-width を上書き */
            min-height: unset; /* 親の min-height を上書き */
        }
        
        .medium-element {
            width: 120px;  /* 中サイズ要素 */
            height: 80px;
            background: #4ecdc4;
        }
        
        .large-element {
            width: 200px;
            height: 100px;
            background: #45b7d1;
        }
        
        .status {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #28a745;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        
        .debug-info {
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>🧪 AutoPinSelector デバッグテスト</h1>
    <p>修正されたAutoPinSelectorの動作確認用テストページ</p>
    <div class="controls">
        <p><strong>📝 仕様書確認済み選択対象:</strong></p>
        <ul style="margin: 5px 0; padding-left: 20px;">
            <li>見出し（H1-H6）: 「見出しH2の右肩」</li>
            <li>段落（P）: 「段落末尾追従」</li>
            <li>テキスト（SPAN）: 「基準要素（span等）」</li>
            <li>画像・DIV: 「基準要素（img/div等）」</li>
        </ul>
    </div>
    
    <div class="controls">
        <h3>🎯 テスト制御</h3>
        <button onclick="testElementSelection()">📍 要素選択テスト</button>
        <button onclick="testSmallElementValidation()">🔍 最小サイズ検証テスト</button>
        <button onclick="testDialogButtons()">🖱️ ダイアログボタンテスト</button>
        <button onclick="showElementSizes()">📏 要素サイズ表示</button>
        <button onclick="clearStatus()">🗑️ ステータス削除</button>
    </div>
    
    <div id="status-area"></div>
    
    <h3>📦 テスト用要素（minElementSize: 10pxに変更済み）</h3>
    <div class="test-elements">
        <div class="test-element small-element" id="small-test" title="小さい要素（30x25px）">
            小さい要素
        </div>
        <div class="test-element medium-element" id="medium-test" title="中サイズ要素（120x80px）">
            中サイズ要素
        </div>
        <div class="test-element large-element" id="large-test" title="大きな要素（200x100px）">
            大きな要素
        </div>
        <h2 id="heading-test" title="見出し要素（仕様書で明記）">
            📝 見出しH2要素テスト
        </h2>
        <p id="paragraph-test" title="段落要素（仕様書で明記）">
            この段落要素をクリックしてテスト。仕様書では「段落末尾追従」と明記されています。
        </p>
        <span id="span-test" title="テキスト要素（仕様書で明記）">
            🏷️ spanテキスト要素
        </span>
        <div class="test-element" id="text-element" title="divテキスト要素">
            <p>divテキスト要素をクリックしてテスト</p>
        </div>
        <div id="tiny-element" title="極小装飾要素（3x3px - 除外対象）" style="width: 3px; height: 3px; background: #ffd700; margin: 10px; display: inline-block;">
        </div>
        <div id="micro-element" title="極小装飾要素（5x5px - 除外対象）" style="width: 5px; height: 5px; background: #ff69b4; margin: 10px; display: inline-block;">
        </div>
    </div>
    
    <div id="debug-info" class="debug-info" style="display: none;">
        <h4>🔍 Debug Information</h4>
        <div id="debug-content">デバッグ情報がここに表示されます</div>
    </div>
    
    <script type="module">
        import { AutoPinSelector } from './micromodules/autopin/AutoPinSelector.js';
        
        let autoSelector = null;
        let testInProgress = false;
        
        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            autoSelector = new AutoPinSelector();
            updateStatus('✅ AutoPinSelector初期化完了');
            console.log('🚀 AutoPinSelector debug test initialized');
        });
        
        /**
         * 要素選択テスト
         */
        window.testElementSelection = async function() {
            if (!autoSelector || testInProgress) {
                updateStatus('❌ テスト実行できません（初期化未完了またはテスト実行中）', true);
                return;
            }
            
            testInProgress = true;
            
            try {
                updateStatus('🎯 要素選択テストを開始します。テスト用要素をクリックしてください。');
                
                const contract = await autoSelector.selectElement({
                    logicalSize: { w: 300, h: 200 },
                    fit: 'contain',
                    scaleMode: 'container'
                });
                
                updateStatus('✅ 要素選択テスト成功！');
                updateStatus(`📋 Contract生成: ${JSON.stringify(contract, null, 2)}`);
                console.log('✅ Test Success - Contract:', contract);
                
            } catch (error) {
                if (error.message === 'Selection cancelled') {
                    updateStatus('⚠️ テストをキャンセルしました');
                } else {
                    updateStatus(`❌ テスト失敗: ${error.message}`, true);
                    console.error('❌ Test Failed:', error);
                }
            } finally {
                testInProgress = false;
            }
        };
        
        /**
         * 最小サイズ検証テスト
         */
        window.testSmallElementValidation = function() {
            updateStatus('🔍 最小サイズ検証テストを実行中...');
            
            const elements = [
                { id: 'small-test', expectedValid: true },   // 30x25px > 10px なので選択可能
                { id: 'medium-test', expectedValid: true },  // 120x80px
                { id: 'large-test', expectedValid: true },  // 200x100px
                { id: 'heading-test', expectedValid: true }, // 見出し要素（仕様書で明記）
                { id: 'paragraph-test', expectedValid: true }, // 段落要素（仕様書で明記）
                { id: 'span-test', expectedValid: true },     // span要素（仕様書で明記）
                { id: 'tiny-element', expectedValid: false }, // 3x3px < 10px なので除外
                { id: 'micro-element', expectedValid: false } // 5x5px < 10px なので除外
            ];
            
            elements.forEach(({ id, expectedValid }) => {
                const element = document.getElementById(id);
                const rect = element.getBoundingClientRect();
                const isValid = autoSelector._isValidElement(element);
                
                const status = isValid === expectedValid ? '✅' : '❌';
                updateStatus(`${status} ${id}: ${rect.width}x${rect.height}px - Valid: ${isValid} (Expected: ${expectedValid})`);
            });
            
            updateStatus('🔍 最小サイズ検証テスト完了');
        };
        
        /**
         * ダイアログボタンテスト
         */
        window.testDialogButtons = async function() {
            updateStatus('🖱️ ダイアログボタンテストを開始...');
            
            // 手動でダイアログ表示をテスト
            const testElement = document.getElementById('large-test');
            
            autoSelector._createAnchorSelectorDialog(
                testElement,
                (align, anchorKind) => {
                    updateStatus(`✅ Confirm clicked! Align: ${align}, AnchorKind: ${anchorKind}`);
                    console.log('✅ Confirm callback executed:', { align, anchorKind });
                },
                (error) => {
                    updateStatus('❌ Cancel clicked or error occurred');
                    console.log('❌ Cancel callback executed:', error);
                }
            );
            
            updateStatus('🖱️ ダイアログが表示されました。ConfirmまたはCancelボタンをクリックしてください。');
        };
        
        /**
         * 要素サイズ表示
         */
        window.showElementSizes = function() {
            updateStatus('📏 要素サイズを表示中...');
            
            const elements = document.querySelectorAll('.test-element');
            elements.forEach(element => {
                const rect = element.getBoundingClientRect();
                const id = element.id || element.className;
                updateStatus(`📏 ${id}: ${rect.width.toFixed(1)}x${rect.height.toFixed(1)}px`);
            });
            
            updateStatus('📏 要素サイズ表示完了');
        };
        
        /**
         * ステータス更新
         */
        function updateStatus(message, isError = false) {
            const statusArea = document.getElementById('status-area');
            const statusDiv = document.createElement('div');
            statusDiv.className = isError ? 'status error' : 'status';
            statusDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            statusArea.appendChild(statusDiv);
            
            // 自動スクロール
            statusDiv.scrollIntoView({ behavior: 'smooth' });
            
            // 古いメッセージの削除（15個まで保持）
            while (statusArea.children.length > 15) {
                statusArea.removeChild(statusArea.firstChild);
            }
        }
        
        /**
         * ステータス削除
         */
        window.clearStatus = function() {
            const statusArea = document.getElementById('status-area');
            statusArea.innerHTML = '';
            updateStatus('🗑️ ステータスを削除しました');
        };
        
        // グローバル関数エクスポート
        window.autoSelector = autoSelector;
    </script>
</body>
</html>