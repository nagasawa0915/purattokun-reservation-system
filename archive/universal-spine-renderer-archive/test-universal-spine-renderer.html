<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniversalSpineRenderer 統合テスト</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            margin: 10px 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .test-area {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .canvas-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        #spine-canvas {
            width: 100%;
            height: 500px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group h3 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
            color: #fff;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn.success {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }
        
        .btn.warning {
            background: linear-gradient(45deg, #ff9800, #e68900);
        }
        
        .btn.danger {
            background: linear-gradient(45deg, #f44336, #da190b);
        }
        
        .status-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-value {
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .log-area {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-info {
            color: #4CAF50;
        }
        
        .log-warning {
            color: #ff9800;
        }
        
        .log-error {
            color: #f44336;
        }
        
        .log-debug {
            color: #9C27B0;
        }
        
        @media (max-width: 768px) {
            .test-area {
                grid-template-columns: 1fr;
            }
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .success-message {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .error-message {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 UniversalSpineRenderer</h1>
            <p>PureSpineLoader統合型汎用モジュール - 統合テスト</p>
            <p>任意のSpineプロジェクトで利用可能な完全統合レンダリングシステム</p>
            <div style="background: rgba(255, 0, 0, 0.1); padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 14px;">
                ⚠️ <strong>重要</strong>: HTTPサーバー必須 - <code>python server.py</code> または <code>python -m http.server 8000</code> で起動してください
            </div>
        </div>
        
        <div class="test-area">
            <div class="canvas-container">
                <canvas id="spine-canvas"></canvas>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>読み込み中...</p>
                </div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <h3>🎬 基本制御</h3>
                    <button class="btn" onclick="initializeRenderer()">初期化</button>
                    <button class="btn" onclick="startRendering()">レンダリング開始</button>
                    <button class="btn warning" onclick="stopRendering()">レンダリング停止</button>
                    <button class="btn danger" onclick="disposeRenderer()">リソース解放</button>
                </div>
                
                <div class="control-group">
                    <h3>📦 キャラクター読み込み</h3>
                    <button class="btn success" onclick="loadPurattokun()">ぷらっとくん読み込み</button>
                    <button class="btn success" onclick="loadNezumi()">ねずみ読み込み</button>
                    <button class="btn" onclick="loadAllCharacters()">全キャラクター読み込み</button>
                </div>
                
                <div class="control-group">
                    <h3>🎭 アニメーション制御</h3>
                    <button class="btn" onclick="playAnimation('purattokun', 'taiki')">待機アニメーション</button>
                    <button class="btn" onclick="playAnimation('purattokun', 'syutugen')">出現アニメーション</button>
                    <button class="btn" onclick="toggleVisibility('purattokun')">表示切替</button>
                </div>
                
                <div class="control-group">
                    <h3>🔧 テスト機能</h3>
                    <button class="btn" onclick="runDiagnostics()">診断実行</button>
                    <button class="btn" onclick="stressTest()">ストレステスト</button>
                    <button class="btn" onclick="clearLogs()">ログクリア</button>
                </div>
            </div>
        </div>
        
        <div class="status-area">
            <h3>📊 ステータス</h3>
            <div class="status-item">
                <span>初期化状態</span>
                <span class="status-value" id="status-initialized">未初期化</span>
            </div>
            <div class="status-item">
                <span>レンダリング状態</span>
                <span class="status-value" id="status-rendering">停止中</span>
            </div>
            <div class="status-item">
                <span>読み込み済みキャラクター</span>
                <span class="status-value" id="status-characters">0</span>
            </div>
            <div class="status-item">
                <span>フレーム数</span>
                <span class="status-value" id="status-frames">0</span>
            </div>
            <div class="status-item">
                <span>WebGL対応</span>
                <span class="status-value" id="status-webgl">確認中</span>
            </div>
            <div class="status-item">
                <span>エラー数</span>
                <span class="status-value" id="status-errors">0</span>
            </div>
        </div>
        
        <div class="log-area" id="log-area">
            <div class="log-entry log-info">🚀 UniversalSpineRenderer統合テスト開始</div>
        </div>
    </div>

    <!-- Spine WebGL Runtime -->
    <script src="assets/js/libs/spine-webgl.js"></script>
    
    <!-- UniversalSpineRenderer -->
    <script src="micromodules/spine-renderer/UniversalSpineRenderer.js"></script>
    
    <script>
        // グローバル変数
        let renderer = null;
        let statusUpdateInterval = null;
        
        // ログ関数
        function addLog(message, type = 'info') {
            const logArea = document.getElementById('log-area');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // ステータス更新
        function updateStatus() {
            if (!renderer) return;
            
            const status = renderer.getStatus();
            
            document.getElementById('status-initialized').textContent = 
                status.initialized ? '✅ 初期化済み' : '❌ 未初期化';
            document.getElementById('status-rendering').textContent = 
                status.rendering ? '🎬 動作中' : '⏸️ 停止中';
            document.getElementById('status-characters').textContent = status.charactersLoaded;
            document.getElementById('status-frames').textContent = status.frameCount;
            document.getElementById('status-webgl').textContent = 
                status.webglSupported ? '✅ 対応' : '❌ 非対応';
            document.getElementById('status-errors').textContent = status.errors;
        }
        
        // レンダラー初期化
        async function initializeRenderer() {
            try {
                addLog('🔧 UniversalSpineRenderer初期化開始');
                showLoading(true);
                
                // Spine WebGLライブラリの確認を先に実行
                if (!window.spine) {
                    addLog('❌ Spine WebGLライブラリが読み込まれていません', 'error');
                    addLog('🔍 利用可能なSpine関連変数:', 'debug');
                    const spineVars = Object.keys(window).filter(key => 
                        key.toLowerCase().includes('spine')
                    );
                    addLog(`  - ${spineVars.join(', ') || '見つかりません'}`, 'debug');
                    return;
                }
                
                addLog('✅ Spine WebGLライブラリ確認済み', 'info');
                addLog(`📋 利用可能なSpineクラス数: ${Object.keys(window.spine).length}`, 'debug');
                
                const canvas = document.getElementById('spine-canvas');
                if (!canvas) {
                    addLog('❌ Canvas要素が見つかりません', 'error');
                    return;
                }
                
                addLog('📱 Canvas要素確認済み', 'debug');
                
                renderer = new UniversalSpineRenderer({
                    canvas: canvas,
                    config: {
                        debugMode: true,
                        errorRecovery: true,
                        autoResize: true
                    }
                });
                
                // イベントハンドラー設定
                renderer.on('initialized', () => {
                    addLog('✅ 初期化完了', 'info');
                });
                
                renderer.on('error', (error) => {
                    addLog(`❌ エラー: ${error.message}`, 'error');
                });
                
                renderer.on('characterLoaded', (character) => {
                    addLog(`📦 キャラクター読み込み完了: ${character.name}`, 'info');
                });
                
                renderer.on('webglcontextlost', () => {
                    addLog('⚠️ WebGL Context Lost', 'warning');
                });
                
                renderer.on('webglcontextrestored', () => {
                    addLog('🔄 WebGL Context Restored', 'info');
                });
                
                const success = await renderer.initialize();
                
                if (success) {
                    addLog('✅ UniversalSpineRenderer初期化成功', 'info');
                    
                    // ステータス更新開始
                    statusUpdateInterval = setInterval(updateStatus, 500);
                } else {
                    addLog('❌ UniversalSpineRenderer初期化失敗', 'error');
                }
                
            } catch (error) {
                addLog(`❌ 初期化エラー: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // レンダリング開始
        function startRendering() {
            if (!renderer) {
                addLog('❌ レンダラーが初期化されていません', 'error');
                return;
            }
            
            addLog('🎬 レンダリング開始');
            renderer.startRenderLoop();
        }
        
        // レンダリング停止
        function stopRendering() {
            if (!renderer) {
                addLog('❌ レンダラーが初期化されていません', 'error');
                return;
            }
            
            addLog('⏸️ レンダリング停止');
            renderer.stopRenderLoop();
        }
        
        // ぷらっとくん読み込み
        async function loadPurattokun() {
            if (!renderer) {
                addLog('❌ レンダラーが初期化されていません', 'error');
                return;
            }
            
            try {
                addLog('📦 ぷらっとくん読み込み開始');
                showLoading(true);
                
                const character = await renderer.loadCharacter({
                    name: 'purattokun',
                    atlasPath: 'assets/spine/characters/purattokun/purattokun.atlas',
                    jsonPath: 'assets/spine/characters/purattokun/purattokun.json',
                    position: { x: 300, y: 400 },
                    scale: 0.6,
                    defaultAnimation: 'taiki'
                });
                
                addLog('✅ ぷらっとくん読み込み完了', 'info');
                
            } catch (error) {
                addLog(`❌ ぷらっとくん読み込み失敗: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // ねずみ読み込み
        async function loadNezumi() {
            if (!renderer) {
                addLog('❌ レンダラーが初期化されていません', 'error');
                return;
            }
            
            try {
                addLog('📦 ねずみ読み込み開始');
                showLoading(true);
                
                const character = await renderer.loadCharacter({
                    name: 'nezumi',
                    atlasPath: 'assets/spine/characters/nezumi/nezumi.atlas',
                    jsonPath: 'assets/spine/characters/nezumi/nezumi.json',
                    position: { x: 500, y: 350 },
                    scale: 0.8,
                    defaultAnimation: 'idle'
                });
                
                addLog('✅ ねずみ読み込み完了', 'info');
                
            } catch (error) {
                addLog(`❌ ねずみ読み込み失敗: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // 全キャラクター読み込み
        async function loadAllCharacters() {
            addLog('📦 全キャラクター読み込み開始');
            
            await loadPurattokun();
            await new Promise(resolve => setTimeout(resolve, 500));
            await loadNezumi();
            
            addLog('✅ 全キャラクター読み込み完了', 'info');
        }
        
        // アニメーション再生
        function playAnimation(characterName, animationName) {
            if (!renderer) {
                addLog('❌ レンダラーが初期化されていません', 'error');
                return;
            }
            
            const character = renderer.getCharacter(characterName);
            if (!character) {
                addLog(`❌ キャラクター '${characterName}' が見つかりません`, 'error');
                return;
            }
            
            character.setAnimation(animationName);
            addLog(`🎭 アニメーション再生: ${characterName} - ${animationName}`);
        }
        
        // 表示切替
        function toggleVisibility(characterName) {
            if (!renderer) {
                addLog('❌ レンダラーが初期化されていません', 'error');
                return;
            }
            
            const character = renderer.getCharacter(characterName);
            if (!character) {
                addLog(`❌ キャラクター '${characterName}' が見つかりません`, 'error');
                return;
            }
            
            if (character.isVisible) {
                character.hide();
                addLog(`👁️ キャラクター非表示: ${characterName}`);
            } else {
                character.show();
                addLog(`👁️ キャラクター表示: ${characterName}`);
            }
        }
        
        // 診断実行
        function runDiagnostics() {
            if (!renderer) {
                addLog('❌ レンダラーが初期化されていません', 'error');
                return;
            }
            
            const status = renderer.getStatus();
            addLog('🔍 診断結果:', 'debug');
            addLog(`  - 初期化: ${status.initialized}`, 'debug');
            addLog(`  - レンダリング: ${status.rendering}`, 'debug');
            addLog(`  - キャラクター数: ${status.charactersLoaded}`, 'debug');
            addLog(`  - フレーム数: ${status.frameCount}`, 'debug');
            addLog(`  - WebGL対応: ${status.webglSupported}`, 'debug');
            addLog(`  - エラー数: ${status.errors}`, 'debug');
        }
        
        // ストレステスト
        async function stressTest() {
            addLog('⚡ ストレステスト開始');
            
            // 初期化テスト
            await initializeRenderer();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // キャラクター読み込みテスト
            await loadAllCharacters();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // レンダリングテスト
            startRendering();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // アニメーション切替テスト
            for (let i = 0; i < 5; i++) {
                playAnimation('purattokun', 'syutugen');
                await new Promise(resolve => setTimeout(resolve, 1000));
                playAnimation('purattokun', 'taiki');
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            addLog('✅ ストレステスト完了', 'info');
        }
        
        // リソース解放
        function disposeRenderer() {
            if (!renderer) {
                addLog('❌ レンダラーが初期化されていません', 'error');
                return;
            }
            
            addLog('🧹 リソース解放開始');
            
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
                statusUpdateInterval = null;
            }
            
            renderer.dispose();
            renderer = null;
            
            addLog('✅ リソース解放完了', 'info');
        }
        
        // ローディング表示
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // ログクリア
        function clearLogs() {
            document.getElementById('log-area').innerHTML = 
                '<div class="log-entry log-info">🚀 ログクリア</div>';
        }
        
        // ページ読み込み時の初期化
        window.addEventListener('load', () => {
            addLog('📱 ページ読み込み完了');
            addLog('🔍 Spine WebGLライブラリ確認中...');
            
            // 詳細確認
            console.log('🔍 ライブラリ確認詳細:');
            console.log('  - window.spine:', window.spine);
            console.log('  - spine keys:', window.spine ? Object.keys(window.spine) : 'none');
            console.log('  - UniversalSpineRenderer:', typeof window.UniversalSpineRenderer);
            
            if (typeof window.spine !== 'undefined') {
                addLog('✅ Spine WebGLライブラリ読み込み成功', 'info');
                addLog(`📋 Spine classes: ${Object.keys(window.spine).length}個`, 'debug');
            } else {
                addLog('❌ Spine WebGLライブラリ読み込み失敗', 'error');
                addLog('🔍 現在のURL: ' + window.location.href, 'debug');
                addLog('🔍 推奨URL: http://localhost:8000/test-universal-spine-renderer.html', 'debug');
                
                // 代替確認
                const spineKeys = Object.keys(window).filter(key => 
                    key.includes('spine') || key.includes('Spine')
                );
                if (spineKeys.length > 0) {
                    addLog(`🔍 Spine関連変数発見: ${spineKeys.join(', ')}`, 'debug');
                } else {
                    addLog('❌ Spine関連変数が見つかりません', 'error');
                    addLog('💡 解決方法: python server.py を実行してHTTPサーバーを起動', 'warning');
                }
            }
            
            if (typeof window.UniversalSpineRenderer !== 'undefined') {
                addLog('✅ UniversalSpineRendererモジュール読み込み成功', 'info');
                
                // ライブラリが正常に読み込まれている場合、自動初期化を提案
                if (typeof window.spine !== 'undefined') {
                    addLog('🚀 準備完了: 初期化ボタンを押してください', 'info');
                }
            } else {
                addLog('❌ UniversalSpineRendererモジュール読み込み失敗', 'error');
            }
        });
        
        // ページアンロード時のクリーンアップ
        window.addEventListener('beforeunload', () => {
            if (renderer) {
                renderer.dispose();
            }
        });
    </script>
</body>
</html>