<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElementObserver Phase 3Bçµ±åˆãƒ†ã‚¹ãƒˆ - æœ¬ç•ªSpineçµ±åˆã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            margin: 0;
            touch-action: none;
            color: white;
        }
        .test-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            max-width: 1400px;
            margin: 0 auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .test-area {
            position: relative;
            width: 1000px;
            height: 600px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.3);
            margin: 20px auto;
            border-radius: 15px;
            touch-action: none;
            overflow: hidden;
        }
        .layout-anchor {
            position: absolute;
            background: rgba(255, 107, 107, 0.4);
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            transform: translate(-50%, -50%);
            touch-action: none;
            transition: all 0.2s ease;
        }
        .interactive {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transform: translate(var(--tx, 0), var(--ty, 0)) scale(var(--scale, 1)) rotate(var(--rotation, 0deg));
            touch-action: none;
        }
        .canvas-element {
            border: 2px solid #4ecdc4;
            border-radius: 8px;
            background: rgba(78, 205, 196, 0.2);
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .control-group {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .control-group h3 {
            margin: 0 0 10px 0;
            color: #feca57;
            font-size: 16px;
        }
        button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 15px;
            margin: 3px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button.primary {
            background: rgba(78, 205, 196, 0.3);
            border-color: #4ecdc4;
        }
        button.secondary {
            background: rgba(255, 107, 107, 0.3);
            border-color: #ff6b6b;
        }
        .coordinate-display {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .coord-system {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 11px;
        }
        .coord-system h4 {
            margin: 0 0 5px 0;
            color: #feca57;
            font-size: 12px;
        }
        .coord-value {
            color: #4ecdc4;
            font-family: monospace;
        }
        .log {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .success { color: #26de81; }
        .error { color: #fc5c65; }
        .warning { color: #fed330; }
        .info { color: #45aaf2; }
        .debug { color: #a55eea; }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            margin: 0 5px;
            font-weight: bold;
        }
        .status.active {
            background: rgba(38, 222, 129, 0.3);
            color: #26de81;
            border: 1px solid #26de81;
        }
        .status.inactive {
            background: rgba(252, 92, 101, 0.3);
            color: #fc5c65;
            border: 1px solid #fc5c65;
        }
        .instructions {
            background: rgba(69, 170, 242, 0.2);
            border: 1px solid #45aaf2;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .instructions h3 {
            margin-top: 0;
            color: #45aaf2;
        }
        .phase-indicator {
            background: linear-gradient(45deg, #667eea, #764ba2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .phase-indicator h1 {
            margin: 0;
            font-size: 24px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .spine-canvas {
            position: absolute;
            cursor: pointer;
            border: 2px solid rgba(255, 215, 0, 0.5);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="phase-indicator">
            <h1>ğŸš€ ElementObserver Phase 3Bçµ±åˆãƒ†ã‚¹ãƒˆ</h1>
            <p>æœ¬ç•ªSpineçµ±åˆã‚·ã‚¹ãƒ†ãƒ  - nezumiã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿å®Œå…¨å¯¾å¿œ</p>
        </div>
        
        <div class="instructions">
            <h3>ğŸ“ Phase 3Bçµ±åˆãƒ†ã‚¹ãƒˆé …ç›®</h3>
            <ol>
                <li><strong>æœ¬ç•ªSpineã‚·ã‚¹ãƒ†ãƒ çµ±åˆ</strong> - spine-character-manager.jsæ­£å¼çµ±åˆ</li>
                <li><strong>nezumiã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿</strong> - æœ¬ç•ªãƒ•ãƒ­ãƒ¼ã§ã®Spineãƒ‡ãƒ¼ã‚¿ç¢ºå®Ÿèª­ã¿è¾¼ã¿</li>
                <li><strong>SpineCharacterManageråˆæœŸåŒ–</strong> - æ­£ã—ã„åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼å®Ÿè£…</li>
                <li><strong>ElementObserverçµ±åˆ</strong> - Phase 2æ©Ÿèƒ½ã¨æœ¬ç•ªã‚·ã‚¹ãƒ†ãƒ ã®å®Œå…¨çµ±åˆ</li>
                <li><strong>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é…ç½®åˆ¶å¾¡</strong> - çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã§ã®æ­£ç¢ºãªä½ç½®ãƒ»ã‚¹ã‚±ãƒ¼ãƒ«åˆ¶å¾¡</li>
            </ol>
            <p><strong>ğŸ¯ æœŸå¾…çµæœ</strong>ï¼šnezumiã®Spineã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒç¢ºå®Ÿã«èª­ã¿è¾¼ã¾ã‚Œã€ElementObserver Phase 2æ©Ÿèƒ½ã¨ã®å®Œå…¨çµ±åˆå‹•ä½œ</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <h3>ğŸš€ Spineçµ±åˆåˆæœŸåŒ–</h3>
                <button class="primary" onclick="initializeSpineIntegration()">Spineçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–</button>
                <button onclick="loadNezumiCharacter()">nezumiã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿</button>
                <button onclick="showSpineSystemStatus()">Spineã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª</button>
            </div>
            
            <div class="control-group">
                <h3>ğŸ¯ ElementObserverçµ±åˆ</h3>
                <button onclick="initializeElementObserver()">ElementObserver Phase 2åˆæœŸåŒ–</button>
                <button onclick="integrateSystems()">ã‚·ã‚¹ãƒ†ãƒ çµ±åˆå®Ÿè¡Œ</button>
                <button onclick="testIntegratedPositioning()">çµ±åˆä½ç½®åˆ¶å¾¡ãƒ†ã‚¹ãƒˆ</button>
            </div>
            
            <div class="control-group">
                <h3>ğŸ® ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¶å¾¡</h3>
                <button onclick="testCharacterMovement()">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç§»å‹•ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testAnimationSequence()">ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testBoundsDetection()">å¢ƒç•Œæ¤œå‡ºãƒ†ã‚¹ãƒˆ</button>
            </div>
            
            <div class="control-group">
                <h3>ğŸ“Š è¨ºæ–­ãƒ»ãƒ‡ãƒãƒƒã‚°</h3>
                <button onclick="showDetailedStatus()">è©³ç´°çŠ¶æ…‹è¡¨ç¤º</button>
                <button onclick="debugSpineLoading()">Spineèª­ã¿è¾¼ã¿è¨ºæ–­</button>
                <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            </div>
        </div>
        
        <div>
            Phase 3BçŠ¶æ…‹: 
            <span id="spine-integration-status" class="status inactive">Spine Integration Inactive</span>
            <span id="character-loading-status" class="status inactive">Character Loading Inactive</span>
            <span id="element-observer-status" class="status inactive">ElementObserver Inactive</span>
            <span id="system-integration-status" class="status inactive">System Integration Inactive</span>
        </div>
        
        <!-- åº§æ¨™ç³»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º -->
        <div class="coordinate-display" id="coordinate-display">
            <div class="coord-system">
                <h4>ğŸ“ DOMåº§æ¨™ç³»</h4>
                <div class="coord-value" id="dom-coords">æœªåˆæœŸåŒ–</div>
            </div>
            <div class="coord-system">
                <h4>ğŸ¯ Transformåº§æ¨™ç³»</h4>
                <div class="coord-value" id="transform-coords">æœªåˆæœŸåŒ–</div>
            </div>
            <div class="coord-system">
                <h4>ğŸŒ WebGLåº§æ¨™ç³»</h4>
                <div class="coord-value" id="webgl-coords">æœªåˆæœŸåŒ–</div>
            </div>
            <div class="coord-system">
                <h4>ğŸ® Skeletonåº§æ¨™ç³»</h4>
                <div class="coord-value" id="skeleton-coords">æœªåˆæœŸåŒ–</div>
            </div>
            <div class="coord-system">
                <h4>ğŸ“± Canvasåº§æ¨™ç³»</h4>
                <div class="coord-value" id="canvas-coords">æœªåˆæœŸåŒ–</div>
            </div>
        </div>
        
        <!-- ğŸ¯ ãƒ¡ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆã‚¨ãƒªã‚¢ -->
        <div class="test-area" id="test-area">
            <!-- nezumiã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼Canvas -->
            <canvas id="nezumi-canvas" class="spine-canvas" width="300" height="200" 
                    style="left: 50%; top: 50%; transform: translate(-50%, -50%); width: 150px; height: 100px; display: none;"
                    data-character-name="nezumi"></canvas>
            
            <!-- ElementObserverãƒ†ã‚¹ãƒˆè¦ç´  -->
            <div id="test-layout-anchor" class="layout-anchor" 
                 style="left: 30%; top: 30%; width: 100px; height: 80px;">
                <div class="interactive">Test Element</div>
            </div>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <!-- ğŸš€ Spine WebGL Runtime -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.24/dist/iife/spine-webgl.js"></script>
    
    <!-- ğŸ¯ æœ¬ç•ªSpineçµ±åˆã‚·ã‚¹ãƒ†ãƒ  -->
    <script src="assets/spine/spine-integration-v2.js"></script>
    <script src="assets/spine/spine-character-manager.js"></script>
    
    <!-- ğŸš€ ElementObserver Phase 2 ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç¾¤ -->
    <script src="micromodules/element-observer/ElementObserverCore.js"></script>
    <script src="micromodules/element-observer/ElementObserver.js"></script>
    <script src="micromodules/element-observer/ElementObserverTransform.js"></script>
    <script src="micromodules/element-observer/ElementObserverWebGL.js"></script>
    <script src="micromodules/element-observer/ElementObserverResponsive.js"></script>
    <script src="micromodules/element-observer/ElementObserverAdvanced.js"></script>
    
    <!-- âœ¨ Phase 3Bçµ±åˆãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ  -->
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let spineCharacterManager = null;
        let elementObserverAdvanced = null;
        let nezumiCharacter = null;
        let systemsIntegrated = false;
        
        const logElement = document.getElementById('log');
        const statusElements = {
            spineIntegration: document.getElementById('spine-integration-status'),
            characterLoading: document.getElementById('character-loading-status'),
            elementObserver: document.getElementById('element-observer-status'),
            systemIntegration: document.getElementById('system-integration-status')
        };
        
        // ãƒ­ã‚°é–¢æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            const logLine = `[${timestamp}] ${message}\n`;
            
            const span = document.createElement('span');
            span.className = className;
            span.textContent = logLine;
            logElement.appendChild(span);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            logElement.innerHTML = '';
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(elementName, isActive) {
            const element = statusElements[elementName];
            if (element) {
                const statusText = elementName.charAt(0).toUpperCase() + elementName.slice(1).replace(/([A-Z])/g, ' $1');
                element.textContent = isActive ? statusText + ' Active' : statusText + ' Inactive';
                element.className = `status ${isActive ? 'active' : 'inactive'}`;
            }
        }
        
        // ğŸš€ Spineçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        async function initializeSpineIntegration() {
            log('=== Spineçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹ ===', 'success');
            
            try {
                // SpineCharacterManagerã®åˆæœŸåŒ–
                spineCharacterManager = new SpineCharacterManager();
                
                const initialized = await spineCharacterManager.init();
                if (!initialized) {
                    throw new Error('SpineCharacterManageråˆæœŸåŒ–å¤±æ•—');
                }
                
                updateStatus('spineIntegration', true);
                
                log('âœ… SpineCharacterManageråˆæœŸåŒ–å®Œäº†', 'success');
                log('ğŸ¯ Spine WebGL Runtimeæº–å‚™å®Œäº†', 'success');
                
                // Spineãƒ©ãƒ³ã‚¿ã‚¤ãƒ æƒ…å ±ç¢ºèª
                if (typeof spine !== 'undefined') {
                    log('ğŸ“‹ Spine Runtimeç¢ºèª:', 'info');
                    log(`  - spine object: ${typeof spine}`, 'info');
                    log(`  - spine.webgl: ${typeof spine.webgl}`, 'info');
                    if (spine.webgl) {
                        log(`  - WebGL classes available: ${Object.keys(spine.webgl).length}`, 'info');
                    }
                }
                
            } catch (error) {
                log(`âŒ Spineçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStatus('spineIntegration', false);
            }
        }
        
        // nezumiã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿
        async function loadNezumiCharacter() {
            if (!spineCharacterManager) {
                log('âš ï¸ å…ˆã«Spineçµ±åˆã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            
            log('=== nezumiã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿é–‹å§‹ ===', 'success');
            
            try {
                const canvas = document.getElementById('nezumi-canvas');
                const basePath = 'assets/spine/characters/nezumi/';
                const testArea = document.getElementById('test-area');
                
                log(`ğŸ“ èª­ã¿è¾¼ã¿ãƒ‘ã‚¹: ${basePath}`, 'info');
                log(`ğŸ® Canvasè¦ç´ : ${canvas.id}`, 'info');
                
                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿å®Ÿè¡Œ
                nezumiCharacter = await spineCharacterManager.loadCharacter('nezumi', basePath, testArea);
                
                if (nezumiCharacter) {
                    updateStatus('characterLoading', true);
                    
                    // Canvasã‚’è¡¨ç¤º
                    canvas.style.display = 'block';
                    
                    log('âœ… nezumiã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿æˆåŠŸ', 'success');
                    log(`ğŸ“Š ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ—: ${nezumiCharacter.type}`, 'info');
                    
                    if (nezumiCharacter.type === 'spine') {
                        log('ğŸ­ SpineWebGLèª­ã¿è¾¼ã¿æˆåŠŸ', 'success');
                        log(`ğŸ® Canvas: ${nezumiCharacter.canvas.id}`, 'info');
                        log(`ğŸ¦´ Skeleton: ${nezumiCharacter.skeleton ? 'ã‚ã‚Š' : 'ãªã—'}`, 'info');
                        log(`ğŸ¬ AnimationState: ${nezumiCharacter.animationState ? 'ã‚ã‚Š' : 'ãªã—'}`, 'info');
                    } else {
                        log('ğŸ“¦ ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼ˆSpineèª­ã¿è¾¼ã¿ä¸­ï¼‰', 'warning');
                    }
                    
                } else {
                    throw new Error('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿å¤±æ•—');
                }
                
            } catch (error) {
                log(`âŒ nezumiã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStatus('characterLoading', false);
            }
        }
        
        // ElementObserver Phase 2åˆæœŸåŒ–
        async function initializeElementObserver() {
            log('=== ElementObserver Phase 2åˆæœŸåŒ–é–‹å§‹ ===', 'success');
            
            try {
                // ãƒ†ã‚¹ãƒˆè¦ç´ å–å¾—
                const testElement = document.getElementById('test-layout-anchor');
                const canvas = document.getElementById('nezumi-canvas');
                
                if (!testElement) {
                    throw new Error('ãƒ†ã‚¹ãƒˆè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                // ElementObserverAdvancedä½œæˆ
                elementObserverAdvanced = new ElementObserverAdvanced();
                
                // ç–‘ä¼¼Skeletonã¨Rendererï¼ˆnezumiã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒä½¿ç”¨å¯èƒ½ãªå ´åˆã¯å®Ÿéš›ã®ã‚‚ã®ã‚’ä½¿ç”¨ï¼‰
                let skeleton, renderer;
                
                if (nezumiCharacter && nezumiCharacter.type === 'spine') {
                    skeleton = nezumiCharacter.skeleton;
                    renderer = nezumiCharacter.renderer;
                    log('ğŸ¦´ å®Ÿéš›ã®Spine Skeleton/Rendererã‚’ä½¿ç”¨', 'info');
                } else {
                    // ç–‘ä¼¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
                    skeleton = {
                        x: canvas.width / 2,
                        y: canvas.height / 2,
                        scaleX: 1,
                        scaleY: 1,
                        updateWorldTransform: () => {},
                        getBounds: () => ({ x: 0, y: 0, width: 100, height: 80 })
                    };
                    renderer = {
                        camera: {
                            position: { x: canvas.width / 2, y: canvas.height / 2 },
                            zoom: 1.0,
                            setViewport: (w, h) => {}
                        },
                        canvas: canvas
                    };
                    log('ğŸ“¦ ç–‘ä¼¼Skeleton/Rendererã‚’ä½¿ç”¨', 'info');
                }
                
                // Phase 2é«˜åº¦åˆæœŸåŒ–
                const initialized = await elementObserverAdvanced.initializeAdvanced(
                    testElement,
                    canvas,
                    skeleton,
                    renderer,
                    {
                        cssWidth: '15%',
                        cssHeight: '10%',
                        bufferWidth: 300,
                        bufferHeight: 200,
                        quality: 'high'
                    }
                );
                
                if (initialized) {
                    updateStatus('elementObserver', true);
                    
                    log('âœ… ElementObserver Phase 2åˆæœŸåŒ–å®Œäº†', 'success');
                    log('ğŸ¯ 5åº§æ¨™ç³»çµ±åˆã‚·ã‚¹ãƒ†ãƒ é–‹å§‹', 'success');
                    
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åº§æ¨™è¡¨ç¤ºé–‹å§‹
                    startCoordinateDisplay();
                    
                } else {
                    throw new Error('ElementObserveråˆæœŸåŒ–å¤±æ•—');
                }
                
            } catch (error) {
                log(`âŒ ElementObserveråˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStatus('elementObserver', false);
            }
        }
        
        // ã‚·ã‚¹ãƒ†ãƒ çµ±åˆå®Ÿè¡Œ
        async function integrateSystems() {
            if (!spineCharacterManager || !elementObserverAdvanced) {
                log('âš ï¸ å…ˆã«Spineçµ±åˆã‚·ã‚¹ãƒ†ãƒ ã¨ElementObserverã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            
            log('=== ã‚·ã‚¹ãƒ†ãƒ çµ±åˆå®Ÿè¡Œé–‹å§‹ ===', 'success');
            
            try {
                // Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã®çµ±åˆ
                if (nezumiCharacter && nezumiCharacter.type === 'spine') {
                    // å®Ÿéš›ã®Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨çµ±åˆ
                    elementObserverAdvanced.updateWebGLComponents(
                        nezumiCharacter.skeleton,
                        nezumiCharacter.renderer
                    );
                    
                    log('ğŸ”— Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã®çµ±åˆå®Œäº†', 'success');
                }
                
                // çµ±åˆå¤‰åŒ–ç›£è¦–é–‹å§‹
                elementObserverAdvanced.onIntegrationChange((event) => {
                    log(`ğŸ”„ çµ±åˆå¤‰åŒ–æ¤œå‡º: ${event.type}`, 'debug');
                    updateCoordinateDisplay();
                });
                
                systemsIntegrated = true;
                updateStatus('systemIntegration', true);
                
                log('âœ… ã‚·ã‚¹ãƒ†ãƒ çµ±åˆå®Œäº†', 'success');
                log('ğŸ¯ ElementObserver + Spineçµ±åˆã‚·ã‚¹ãƒ†ãƒ é€£å‹•é–‹å§‹', 'success');
                
            } catch (error) {
                log(`âŒ ã‚·ã‚¹ãƒ†ãƒ çµ±åˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStatus('systemIntegration', false);
            }
        }
        
        // çµ±åˆä½ç½®åˆ¶å¾¡ãƒ†ã‚¹ãƒˆ
        function testIntegratedPositioning() {
            if (!systemsIntegrated) {
                log('âš ï¸ å…ˆã«ã‚·ã‚¹ãƒ†ãƒ çµ±åˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            
            log('=== çµ±åˆä½ç½®åˆ¶å¾¡ãƒ†ã‚¹ãƒˆé–‹å§‹ ===', 'success');
            
            const testPositions = [
                { x: 25, y: 35, unit: '%', name: 'å·¦ä¸Š' },
                { x: 75, y: 35, unit: '%', name: 'å³ä¸Š' },
                { x: 75, y: 75, unit: '%', name: 'å³ä¸‹' },
                { x: 25, y: 75, unit: '%', name: 'å·¦ä¸‹' },
                { x: 50, y: 50, unit: '%', name: 'ä¸­å¤®' }
            ];
            
            let index = 0;
            const moveNext = () => {
                if (index >= testPositions.length) {
                    log('âœ… çµ±åˆä½ç½®åˆ¶å¾¡ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                    return;
                }
                
                const pos = testPositions[index];
                log(`ğŸ¯ çµ±åˆä½ç½®è¨­å®š: ${pos.name} (${pos.x}${pos.unit}, ${pos.y}${pos.unit})`, 'info');
                
                const success = elementObserverAdvanced.setUnifiedPosition(pos.x, pos.y, pos.unit);
                if (success) {
                    log(`âœ… ${pos.name}ç§»å‹•å®Œäº†`, 'success');
                } else {
                    log(`âŒ ${pos.name}ç§»å‹•å¤±æ•—`, 'error');
                }
                
                index++;
                setTimeout(moveNext, 1500);
            };
            
            moveNext();
        }
        
        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç§»å‹•ãƒ†ã‚¹ãƒˆ
        function testCharacterMovement() {
            if (!nezumiCharacter) {
                log('âš ï¸ å…ˆã«nezumiã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'warning');
                return;
            }
            
            log('=== ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç§»å‹•ãƒ†ã‚¹ãƒˆé–‹å§‹ ===', 'success');
            
            const canvas = document.getElementById('nezumi-canvas');
            const positions = [
                { left: '30%', top: '30%' },
                { left: '70%', top: '30%' },
                { left: '70%', top: '70%' },
                { left: '30%', top: '70%' },
                { left: '50%', top: '50%' }
            ];
            
            let index = 0;
            const moveNext = () => {
                if (index >= positions.length) {
                    log('âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç§»å‹•ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                    return;
                }
                
                const pos = positions[index];
                canvas.style.left = pos.left;
                canvas.style.top = pos.top;
                
                log(`ğŸ® ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç§»å‹•: ${pos.left}, ${pos.top}`, 'info');
                
                index++;
                setTimeout(moveNext, 1000);
            };
            
            moveNext();
        }
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
        function testAnimationSequence() {
            if (!nezumiCharacter || nezumiCharacter.type !== 'spine') {
                log('âš ï¸ Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
                return;
            }
            
            log('=== ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹ ===', 'success');
            
            try {
                const { skeleton, animationState } = nezumiCharacter;
                
                if (skeleton.data.animations.length > 0) {
                    const animName = skeleton.data.animations[0].name;
                    animationState.setAnimation(0, animName, true);
                    log(`ğŸ­ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹: ${animName}`, 'success');
                } else {
                    log('âš ï¸ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                }
                
            } catch (error) {
                log(`âŒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // å¢ƒç•Œæ¤œå‡ºãƒ†ã‚¹ãƒˆ
        function testBoundsDetection() {
            log('=== å¢ƒç•Œæ¤œå‡ºãƒ†ã‚¹ãƒˆé–‹å§‹ ===', 'success');
            
            if (!nezumiCharacter) {
                log('âš ï¸ nezumiã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
                return;
            }
            
            const canvas = document.getElementById('nezumi-canvas');
            const rect = canvas.getBoundingClientRect();
            
            log('ğŸ“ Canvaså¢ƒç•Œæƒ…å ±:', 'info');
            log(`  ä½ç½®: (${rect.left.toFixed(1)}, ${rect.top.toFixed(1)})`, 'info');
            log(`  ã‚µã‚¤ã‚º: ${rect.width.toFixed(1)} x ${rect.height.toFixed(1)}`, 'info');
            
            // ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­å®šãƒ†ã‚¹ãƒˆ
            if (nezumiCharacter.canvas) {
                log('ğŸ–±ï¸ ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆ: Canvasã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„', 'info');
                
                nezumiCharacter.canvas.onclick = (event) => {
                    const clickX = event.clientX - rect.left;
                    const clickY = event.clientY - rect.top;
                    log(`ğŸ¯ Canvaså†…ã‚¯ãƒªãƒƒã‚¯: (${clickX.toFixed(1)}, ${clickY.toFixed(1)})`, 'success');
                };
            }
            
            log('âœ… å¢ƒç•Œæ¤œå‡ºãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†', 'success');
        }
        
        // Spineèª­ã¿è¾¼ã¿è¨ºæ–­
        function debugSpineLoading() {
            log('=== Spineèª­ã¿è¾¼ã¿è¨ºæ–­é–‹å§‹ ===', 'debug');
            
            // Spineãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç¢ºèª
            log('ğŸ“‹ Spine Runtimeè¨ºæ–­:', 'debug');
            log(`  spine: ${typeof spine}`, 'debug');
            if (typeof spine !== 'undefined') {
                log(`  spine.webgl: ${typeof spine.webgl}`, 'debug');
                log(`  spine keys: [${Object.keys(spine).join(', ')}]`, 'debug');
                if (spine.webgl) {
                    log(`  webgl keys: [${Object.keys(spine.webgl).join(', ')}]`, 'debug');
                }
            }
            
            // SpineCharacterManagerçŠ¶æ…‹
            log('ğŸ”§ SpineCharacterManagerè¨ºæ–­:', 'debug');
            if (spineCharacterManager) {
                log(`  initialized: ${spineCharacterManager.initialized}`, 'debug');
                log(`  characters: ${spineCharacterManager.characters.size}`, 'debug');
                
                spineCharacterManager.characters.forEach((char, name) => {
                    log(`    ${name}: ${char.type}`, 'debug');
                });
            } else {
                log('  SpineCharacterManageræœªåˆæœŸåŒ–', 'debug');
            }
            
            // nezumiã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°
            if (nezumiCharacter) {
                log('ğŸ­ nezumiã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°:', 'debug');
                log(`  type: ${nezumiCharacter.type}`, 'debug');
                log(`  canvas: ${nezumiCharacter.canvas?.id || 'ãªã—'}`, 'debug');
                log(`  skeleton: ${nezumiCharacter.skeleton ? 'ã‚ã‚Š' : 'ãªã—'}`, 'debug');
                log(`  animationState: ${nezumiCharacter.animationState ? 'ã‚ã‚Š' : 'ãªã—'}`, 'debug');
                
                if (nezumiCharacter.skeleton?.data) {
                    log(`  animations: [${nezumiCharacter.skeleton.data.animations.map(a => a.name).join(', ')}]`, 'debug');
                }
            }
            
            log('âœ… Spineèª­ã¿è¾¼ã¿è¨ºæ–­å®Œäº†', 'debug');
        }
        
        // è©³ç´°çŠ¶æ…‹è¡¨ç¤º
        function showDetailedStatus() {
            log('=== Phase 3Bè©³ç´°çŠ¶æ…‹ ===', 'info');
            
            log('ğŸš€ Spineçµ±åˆã‚·ã‚¹ãƒ†ãƒ :', 'info');
            log(`  SpineCharacterManager: ${spineCharacterManager ? 'åˆæœŸåŒ–æ¸ˆã¿' : 'æœªåˆæœŸåŒ–'}`, 'info');
            log(`  nezumiã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼: ${nezumiCharacter ? nezumiCharacter.type : 'æœªèª­ã¿è¾¼ã¿'}`, 'info');
            
            log('âš™ï¸ ElementObserver Phase 2:', 'info');
            log(`  åˆæœŸåŒ–çŠ¶æ…‹: ${elementObserverAdvanced ? 'åˆæœŸåŒ–æ¸ˆã¿' : 'æœªåˆæœŸåŒ–'}`, 'info');
            
            if (elementObserverAdvanced?.integrationState) {
                const state = elementObserverAdvanced.integrationState;
                log(`  çµ±åˆçŠ¶æ…‹: ${state.initialized}`, 'info');
                log(`  ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: [${state.activeModules?.join(', ') || 'ãªã—'}]`, 'info');
            }
            
            log('ğŸ”— ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ:', 'info');
            log(`  çµ±åˆå®Œäº†: ${systemsIntegrated}`, 'info');
            
            log('ğŸ“Š CanvasçŠ¶æ…‹:', 'info');
            const canvas = document.getElementById('nezumi-canvas');
            log(`  è¡¨ç¤º: ${canvas.style.display}`, 'info');
            log(`  ä½ç½®: ${canvas.style.left}, ${canvas.style.top}`, 'info');
            log(`  ã‚µã‚¤ã‚º: ${canvas.style.width}, ${canvas.style.height}`, 'info');
        }
        
        // Spineã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
        function showSpineSystemStatus() {
            if (!spineCharacterManager) {
                log('âš ï¸ SpineCharacterManageræœªåˆæœŸåŒ–', 'warning');
                return;
            }
            
            log('=== Spineã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª ===', 'info');
            log(`åˆæœŸåŒ–æ¸ˆã¿: ${spineCharacterManager.initialized}`, 'info');
            log(`èª­ã¿è¾¼ã¿æ¸ˆã¿ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ•°: ${spineCharacterManager.characters.size}`, 'info');
            
            spineCharacterManager.characters.forEach((character, name) => {
                log(`  ${name}: ${character.type}`, 'info');
                if (character.type === 'spine' && character.skeleton) {
                    const animations = character.skeleton.data.animations || [];
                    log(`    ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: [${animations.map(a => a.name).join(', ')}]`, 'info');
                }
            });
        }
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åº§æ¨™è¡¨ç¤º
        let coordinateUpdateInterval = null;
        
        function startCoordinateDisplay() {
            if (coordinateUpdateInterval) {
                clearInterval(coordinateUpdateInterval);
            }
            
            coordinateUpdateInterval = setInterval(() => {
                updateCoordinateDisplay();
            }, 100); // 10fpsæ›´æ–°
            
            log('ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åº§æ¨™è¡¨ç¤ºé–‹å§‹', 'info');
        }
        
        function updateCoordinateDisplay() {
            if (!elementObserverAdvanced || !elementObserverAdvanced.integrationState?.initialized) {
                return;
            }
            
            try {
                const coords = elementObserverAdvanced.coordinateSystems;
                
                document.getElementById('dom-coords').textContent = 
                    `${coords.dom.x}${coords.dom.unit}, ${coords.dom.y}${coords.dom.unit}`;
                    
                document.getElementById('transform-coords').textContent = 
                    `tx: ${coords.transform.tx.toFixed(1)}px\nty: ${coords.transform.ty.toFixed(1)}px\nscale: ${coords.transform.scale}`;
                    
                document.getElementById('webgl-coords').textContent = 
                    `${coords.webgl.x.toFixed(1)}, ${coords.webgl.y.toFixed(1)}\ncamera: ${coords.webgl.camera.x.toFixed(1)}, ${coords.webgl.camera.y.toFixed(1)}`;
                    
                document.getElementById('skeleton-coords').textContent = 
                    `${coords.skeleton.x.toFixed(1)}, ${coords.skeleton.y.toFixed(1)}\nscale: ${coords.skeleton.scaleX}, ${coords.skeleton.scaleY}`;
                    
                document.getElementById('canvas-coords').textContent = 
                    `${coords.canvas.displayWidth}x${coords.canvas.displayHeight}\n${coords.canvas.bufferWidth}x${coords.canvas.bufferHeight}`;
            } catch (error) {
                // åº§æ¨™è¡¨ç¤ºã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®ã¿ï¼‰
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
        window.addEventListener('load', () => {
            log('ğŸŒ ElementObserver Phase 3Bçµ±åˆãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            log('');
            log('ğŸš€ Phase 3Bçµ±åˆãƒ†ã‚¹ãƒˆç›®æ¨™:');
            log('  1. æœ¬ç•ªSpineçµ±åˆã‚·ã‚¹ãƒ†ãƒ ã®æ­£å¼çµ±åˆ');
            log('  2. nezumiã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç¢ºå®Ÿãªèª­ã¿è¾¼ã¿');
            log('  3. ElementObserver Phase 2æ©Ÿèƒ½ã¨ã®å®Œå…¨çµ±åˆ');
            log('  4. çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã§ã®æ­£ç¢ºãªä½ç½®ãƒ»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡');
            log('');
            log('â–¶ï¸ ã€ŒSpineçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã€â†’ã€Œnezumiã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿ã€â†’ã€Œã‚·ã‚¹ãƒ†ãƒ çµ±åˆå®Ÿè¡Œã€ã®é †ã§ãƒ†ã‚¹ãƒˆé–‹å§‹');
        });
        
        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (coordinateUpdateInterval) {
                clearInterval(coordinateUpdateInterval);
            }
            if (spineCharacterManager) {
                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                spineCharacterManager.characters.forEach((character) => {
                    if (character.canvas && character.canvas.parentNode) {
                        character.canvas.remove();
                    }
                });
            }
            if (elementObserverAdvanced) {
                elementObserverAdvanced.cleanup();
            }
        });
    </script>
</body>
</html>