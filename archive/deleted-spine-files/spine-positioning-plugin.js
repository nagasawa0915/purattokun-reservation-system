/**
 * Spine Positioning Plugin
 * Êó¢Â≠ò„ÅÆ„Éö„Éº„Ç∏„Å´Spine„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÈÖçÁΩÆÊ©üËÉΩ„ÇíËøΩÂä†„Åô„Çã„Éó„É©„Ç∞„Ç§„É≥
 * 
 * ‰ΩøÁî®ÊñπÊ≥ï:
 * 1. „Åì„ÅÆ„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÇÄ
 * 2. SpinePositioningPlugin.init() „ÇíÂëº„Å≥Âá∫„Åô
 * 3. Ëá™ÂãïÁöÑ„Å´Spine„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÊ§úÂá∫„Åó„Å¶ÈÖçÁΩÆ„Ç∑„Çπ„ÉÜ„É†„ÇíÈÅ©Áî®
 */

class SpinePositioningPlugin {
    constructor() {
        this.initialized = false;
        this.characters = new Map(); // „Ç≠„É£„É©„ÇØ„Çø„ÉºÁÆ°ÁêÜ
        this.ui = null; // UIË¶ÅÁ¥†
        this.settings = {
            enableUI: true,           // UIË°®Á§∫
            enableDragDrop: true,     // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó
            enablePresets: true,      // „Éó„É™„Çª„ÉÉ„ÉàÊ©üËÉΩ
            autoDetect: true,         // Ëá™ÂãïÊ§úÂá∫
            savePosition: true,       // ‰ΩçÁΩÆ‰øùÂ≠ò
            storageKey: 'spine-positioning-data'
        };
        
        // „Éá„Éï„Ç©„É´„Éà„Éó„É™„Çª„ÉÉ„Éà
        this.presets = {
            center: { x: 50, y: 50, scale: 1.0, name: '‰∏≠Â§Æ' },
            road: { x: 25, y: 65, scale: 0.8, name: 'ÈÅìË∑ØÂÅ¥' },
            shop: { x: 18, y: 49, scale: 0.55, name: '„ÅäÂ∫óÂâç' },
            right: { x: 75, y: 60, scale: 0.7, name: 'Âè≥ÂØÑ„Çä' }
        };
    }

    /**
     * „Éó„É©„Ç∞„Ç§„É≥„ÇíÂàùÊúüÂåñ
     * @param {Object} options - Ë®≠ÂÆö„Ç™„Éó„Ç∑„Éß„É≥
     */
    init(options = {}) {
        if (this.initialized) return;

        // Ë®≠ÂÆö„Çí„Éû„Éº„Ç∏
        Object.assign(this.settings, options);

        console.log('üéÆ Spine Positioning Plugin ÂàùÊúüÂåñ‰∏≠...');

        // DOMË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÂæÖ„Å§
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.setup());
        } else {
            this.setup();
        }

        this.initialized = true;
    }

    /**
     * „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂÆüË°å
     */
    setup() {
        try {
            // Êó¢Â≠ò„ÅÆSpine„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÊ§úÂá∫
            this.detectSpineCharacters();

            // UI„Çí‰ΩúÊàê
            if (this.settings.enableUI) {
                this.createUI();
            }

            // ‰øùÂ≠òÊ∏à„Åø‰ΩçÁΩÆ„ÇíÂæ©ÂÖÉ
            if (this.settings.savePosition) {
                this.restorePositions();
            }

            console.log('‚úÖ Spine Positioning Plugin ÂàùÊúüÂåñÂÆå‰∫Ü');
            console.log(`Ê§úÂá∫„Åï„Çå„Åü„Ç≠„É£„É©„ÇØ„Çø„Éº: ${this.characters.size}ÂÄã`);

        } catch (error) {
            console.error('‚ùå Spine Positioning Plugin ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
        }
    }

    /**
     * Spine„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíËá™ÂãïÊ§úÂá∫
     */
    detectSpineCharacters() {
        // CanvasË¶ÅÁ¥†„ÇíÊ§úÁ¥¢ÔºàSpineÁî®Ôºâ
        const canvases = document.querySelectorAll('canvas[id*="purattokun"], canvas[data-spine-character]');
        
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁîªÂÉè„ÇíÊ§úÁ¥¢
        const fallbacks = document.querySelectorAll('img[id*="purattokun"], img[alt*="„Å∑„Çâ„Å£„Å®„Åè„Çì"], img[data-spine-fallback]');

        // Ê§úÂá∫„Åï„Çå„Åü„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÁôªÈå≤
        canvases.forEach((canvas, index) => {
            const id = canvas.id || `spine-character-${index}`;
            this.registerCharacter(id, canvas, 'canvas');
        });

        fallbacks.forEach((img, index) => {
            const id = img.id || `spine-fallback-${index}`;
            if (!this.characters.has(id)) {
                this.registerCharacter(id, img, 'image');
            }
        });

        console.log(`üîç „Ç≠„É£„É©„ÇØ„Çø„ÉºÊ§úÂá∫ÂÆå‰∫Ü: ${this.characters.size}ÂÄã`);
    }

    /**
     * „Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÁôªÈå≤
     * @param {string} id - „Ç≠„É£„É©„ÇØ„Çø„ÉºID
     * @param {HTMLElement} element - DOMË¶ÅÁ¥†
     * @param {string} type - „Çø„Ç§„ÉóÔºàcanvas/imageÔºâ
     */
    registerCharacter(id, element, type) {
        const character = {
            id: id,
            element: element,
            type: type,
            position: { x: 50, y: 50, scale: 1.0 },
            isDragging: false
        };

        this.characters.set(id, character);

        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÇíÊúâÂäπÂåñ
        if (this.settings.enableDragDrop) {
            this.enableDragAndDrop(character);
        }

        // ‰ΩçÁΩÆ„Çπ„Çø„Ç§„É´„ÇíÁ¢∫‰øù
        this.ensurePositionStyles(element);

        console.log(`üìç „Ç≠„É£„É©„ÇØ„Çø„ÉºÁôªÈå≤: ${id} (${type})`);
    }

    /**
     * ‰ΩçÁΩÆ„Çπ„Çø„Ç§„É´„ÇíÁ¢∫‰øù
     * @param {HTMLElement} element - DOMË¶ÅÁ¥†
     */
    ensurePositionStyles(element) {
        const style = element.style;
        if (!style.position || style.position === 'static') {
            style.position = 'absolute';
        }
        if (!style.cursor) {
            style.cursor = 'pointer';
        }
    }

    /**
     * UI„Çí‰ΩúÊàê
     */
    createUI() {
        // Êó¢Â≠ò„ÅÆUI„ÇíÂâäÈô§
        const existingUI = document.getElementById('spine-positioning-ui');
        if (existingUI) {
            existingUI.remove();
        }

        // UI„Ç≥„É≥„ÉÜ„Éä„Çí‰ΩúÊàê
        this.ui = document.createElement('div');
        this.ui.id = 'spine-positioning-ui';
        this.ui.innerHTML = this.getUIHTML();
        
        // „Çπ„Çø„Ç§„É´„ÇíËøΩÂä†
        this.addUIStyles();
        
        // UI„ÇíÊåøÂÖ•
        document.body.appendChild(this.ui);

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
        this.bindUIEvents();

        console.log('üé® UI‰ΩúÊàêÂÆå‰∫Ü');
    }

    /**
     * UI HTML„ÇíÁîüÊàê
     */
    getUIHTML() {
        const characterOptions = Array.from(this.characters.keys())
            .map(id => `<option value="${id}">${id}</option>`)
            .join('');

        const presetButtons = Object.entries(this.presets)
            .map(([key, preset]) => 
                `<button class="preset-btn" onclick="SpinePositioning.applyPreset('${key}')">${preset.name}</button>`
            ).join('');

        return `
            <div class="sp-header">
                <h3>üéÆ Spine Positioning</h3>
                <button class="sp-toggle" onclick="SpinePositioning.toggleUI()">√ó</button>
            </div>
            
            <div class="sp-content">
                <div class="sp-character-select">
                    <label>„Ç≠„É£„É©„ÇØ„Çø„Éº:</label>
                    <select id="sp-character-select" onchange="SpinePositioning.selectCharacter(this.value)">
                        ${characterOptions}
                    </select>
                </div>

                <div class="sp-controls">
                    <div class="sp-control-group">
                        <label>‰ΩçÁΩÆ X:</label>
                        <input type="range" id="sp-pos-x" min="0" max="100" value="50" 
                               oninput="SpinePositioning.updatePosition()">
                        <span id="sp-pos-x-value">50%</span>
                    </div>

                    <div class="sp-control-group">
                        <label>‰ΩçÁΩÆ Y:</label>
                        <input type="range" id="sp-pos-y" min="0" max="100" value="50" 
                               oninput="SpinePositioning.updatePosition()">
                        <span id="sp-pos-y-value">50%</span>
                    </div>

                    <div class="sp-control-group">
                        <label>„Çµ„Ç§„Ç∫:</label>
                        <input type="range" id="sp-scale" min="0.1" max="2.0" step="0.1" value="1.0" 
                               oninput="SpinePositioning.updatePosition()">
                        <span id="sp-scale-value">1.0x</span>
                    </div>
                </div>

                <div class="sp-presets">
                    ${presetButtons}
                </div>

                <div class="sp-actions">
                    <button onclick="SpinePositioning.savePosition()">‰øùÂ≠ò</button>
                    <button onclick="SpinePositioning.resetPosition()">„É™„Çª„ÉÉ„Éà</button>
                </div>
            </div>
        `;
    }

    /**
     * UI„Çπ„Çø„Ç§„É´„ÇíËøΩÂä†
     */
    addUIStyles() {
        const existingStyles = document.getElementById('spine-positioning-styles');
        if (existingStyles) return;

        const styles = document.createElement('style');
        styles.id = 'spine-positioning-styles';
        styles.textContent = `
            #spine-positioning-ui {
                position: fixed;
                top: 20px;
                right: 20px;
                width: 280px;
                background: rgba(255, 255, 255, 0.95);
                border-radius: 10px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.2);
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                font-size: 14px;
                backdrop-filter: blur(10px);
            }

            .sp-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 10px 10px 0 0;
                margin: 0;
            }

            .sp-header h3 {
                margin: 0;
                font-size: 16px;
            }

            .sp-toggle {
                background: none;
                border: none;
                color: white;
                font-size: 18px;
                cursor: pointer;
                padding: 0;
                width: 20px;
                height: 20px;
            }

            .sp-content {
                padding: 20px;
            }

            .sp-character-select {
                margin-bottom: 15px;
            }

            .sp-character-select label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
                color: #333;
            }

            .sp-character-select select {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 5px;
                background: white;
            }

            .sp-control-group {
                margin-bottom: 15px;
            }

            .sp-control-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
                color: #333;
            }

            .sp-control-group input[type="range"] {
                width: calc(100% - 60px);
                margin-right: 10px;
            }

            .sp-control-group span {
                display: inline-block;
                width: 50px;
                text-align: right;
                color: #666;
                font-weight: bold;
            }

            .sp-presets {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-bottom: 15px;
            }

            .preset-btn, .sp-actions button {
                padding: 8px 12px;
                background: #ff6b6b;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 12px;
                transition: background 0.3s ease;
            }

            .preset-btn:hover, .sp-actions button:hover {
                background: #ff5252;
            }

            .sp-actions {
                display: flex;
                gap: 10px;
            }

            .sp-actions button {
                flex: 1;
            }

            /* „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„Çπ„Çø„Ç§„É´ */
            .sp-dragging {
                border: 2px dashed #ff6b6b !important;
                z-index: 9999 !important;
            }

            /* ÈùûË°®Á§∫Áä∂ÊÖã */
            #spine-positioning-ui.hidden {
                transform: translateX(100%);
                transition: transform 0.3s ease;
            }
        `;

        document.head.appendChild(styles);
    }

    /**
     * UI„Ç§„Éô„É≥„Éà„ÇíË®≠ÂÆö
     */
    bindUIEvents() {
        // ÊúÄÂàù„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÈÅ∏Êäû
        const firstCharacter = this.characters.keys().next().value;
        if (firstCharacter) {
            this.selectCharacter(firstCharacter);
        }
    }

    /**
     * „Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÈÅ∏Êäû
     * @param {string} characterId - „Ç≠„É£„É©„ÇØ„Çø„ÉºID
     */
    selectCharacter(characterId) {
        const character = this.characters.get(characterId);
        if (!character) return;

        this.currentCharacter = character;

        // UI„ÇíÁèæÂú®„ÅÆ‰ΩçÁΩÆ„Å´Âêà„Çè„Åõ„Å¶Êõ¥Êñ∞
        this.updateUIFromCharacter(character);

        console.log(`üéØ „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû: ${characterId}`);
    }

    /**
     * „Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆ‰ΩçÁΩÆ„Åã„ÇâUI„ÇíÊõ¥Êñ∞
     * @param {Object} character - „Ç≠„É£„É©„ÇØ„Çø„Éº„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
     */
    updateUIFromCharacter(character) {
        const { position } = character;
        
        document.getElementById('sp-pos-x').value = position.x;
        document.getElementById('sp-pos-y').value = position.y;
        document.getElementById('sp-scale').value = position.scale;
        
        document.getElementById('sp-pos-x-value').textContent = `${Math.round(position.x)}%`;
        document.getElementById('sp-pos-y-value').textContent = `${Math.round(position.y)}%`;
        document.getElementById('sp-scale-value').textContent = `${position.scale}x`;
    }

    /**
     * ‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
     */
    updatePosition() {
        if (!this.currentCharacter) return;

        const x = document.getElementById('sp-pos-x').value;
        const y = document.getElementById('sp-pos-y').value;
        const scale = document.getElementById('sp-scale').value;

        // Ë°®Á§∫ÂÄ§„ÇíÊõ¥Êñ∞
        document.getElementById('sp-pos-x-value').textContent = `${Math.round(x)}%`;
        document.getElementById('sp-pos-y-value').textContent = `${Math.round(y)}%`;
        document.getElementById('sp-scale-value').textContent = `${scale}x`;

        // „Ç≠„É£„É©„ÇØ„Çø„Éº„Å´ÈÅ©Áî®
        this.applyPositionToCharacter(this.currentCharacter, x, y, scale);
    }

    /**
     * „Ç≠„É£„É©„ÇØ„Çø„Éº„Å´‰ΩçÁΩÆ„ÇíÈÅ©Áî®
     * @param {Object} character - „Ç≠„É£„É©„ÇØ„Çø„Éº„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
     * @param {number} x - X‰ΩçÁΩÆÔºà%Ôºâ
     * @param {number} y - Y‰ΩçÁΩÆÔºà%Ôºâ
     * @param {number} scale - „Çπ„Ç±„Éº„É´
     */
    applyPositionToCharacter(character, x, y, scale) {
        const { element } = character;
        const size = 200 * scale; // „Éô„Éº„Çπ„Çµ„Ç§„Ç∫

        // ‰ΩçÁΩÆ„Çí‰øùÂ≠ò
        character.position = { x: parseFloat(x), y: parseFloat(y), scale: parseFloat(scale) };

        // „Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
        element.style.left = x + '%';
        element.style.top = y + '%';
        element.style.transform = 'translate(-50%, -50%)';
        element.style.width = size + 'px';
        element.style.height = size + 'px';
    }

    /**
     * „Éó„É™„Çª„ÉÉ„Éà„ÇíÈÅ©Áî®
     * @param {string} presetKey - „Éó„É™„Çª„ÉÉ„Éà„Ç≠„Éº
     */
    applyPreset(presetKey) {
        if (!this.currentCharacter) return;

        const preset = this.presets[presetKey];
        if (!preset) return;

        // UI„ÇíÊõ¥Êñ∞
        document.getElementById('sp-pos-x').value = preset.x;
        document.getElementById('sp-pos-y').value = preset.y;
        document.getElementById('sp-scale').value = preset.scale;

        // ‰ΩçÁΩÆ„ÇíÈÅ©Áî®
        this.updatePosition();

        console.log(`üìç „Éó„É™„Çª„ÉÉ„ÉàÈÅ©Áî®: ${preset.name}`, preset);
    }

    /**
     * „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÇíÊúâÂäπÂåñ
     * @param {Object} character - „Ç≠„É£„É©„ÇØ„Çø„Éº„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
     */
    enableDragAndDrop(character) {
        const { element } = character;

        let dragOffset = { x: 0, y: 0 };

        const startDrag = (e) => {
            e.preventDefault();
            character.isDragging = true;
            element.classList.add('sp-dragging');

            const rect = element.getBoundingClientRect();
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;

            dragOffset.x = clientX - (rect.left + rect.width / 2);
            dragOffset.y = clientY - (rect.top + rect.height / 2);

            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchmove', drag);
            document.addEventListener('touchend', stopDrag);
        };

        const drag = (e) => {
            if (!character.isDragging) return;
            e.preventDefault();

            const container = document.documentElement;
            const containerRect = container.getBoundingClientRect();
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;

            const newX = ((clientX - dragOffset.x - containerRect.left) / containerRect.width) * 100;
            const newY = ((clientY - dragOffset.y - containerRect.top) / containerRect.height) * 100;

            // ÁØÑÂõ≤Âà∂Èôê
            const clampedX = Math.max(0, Math.min(100, newX));
            const clampedY = Math.max(0, Math.min(100, newY));

            // ‰ΩçÁΩÆ„ÇíÈÅ©Áî®
            this.applyPositionToCharacter(character, clampedX, clampedY, character.position.scale);

            // UI„ÇíÊõ¥Êñ∞ÔºàÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÂ†¥ÂêàÔºâ
            if (this.currentCharacter === character) {
                this.updateUIFromCharacter(character);
            }
        };

        const stopDrag = () => {
            if (!character.isDragging) return;

            character.isDragging = false;
            element.classList.remove('sp-dragging');

            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchmove', drag);
            document.removeEventListener('touchend', stopDrag);

            // ‰ΩçÁΩÆ„Çí‰øùÂ≠ò
            if (this.settings.savePosition) {
                this.savePosition();
            }
        };

        element.addEventListener('mousedown', startDrag);
        element.addEventListener('touchstart', startDrag);
    }

    /**
     * ‰ΩçÁΩÆ„Çí‰øùÂ≠ò
     */
    savePosition() {
        if (!this.settings.savePosition) return;

        const data = {};
        this.characters.forEach((character, id) => {
            data[id] = character.position;
        });

        localStorage.setItem(this.settings.storageKey, JSON.stringify(data));
        console.log('üíæ ‰ΩçÁΩÆ‰øùÂ≠òÂÆå‰∫Ü');
    }

    /**
     * ‰ΩçÁΩÆ„ÇíÂæ©ÂÖÉ
     */
    restorePositions() {
        if (!this.settings.savePosition) return;

        try {
            const data = localStorage.getItem(this.settings.storageKey);
            if (!data) return;

            const positions = JSON.parse(data);
            
            this.characters.forEach((character, id) => {
                if (positions[id]) {
                    const { x, y, scale } = positions[id];
                    this.applyPositionToCharacter(character, x, y, scale);
                }
            });

            console.log('üì• ‰ΩçÁΩÆÂæ©ÂÖÉÂÆå‰∫Ü');
        } catch (error) {
            console.error('‰ΩçÁΩÆÂæ©ÂÖÉ„Ç®„É©„Éº:', error);
        }
    }

    /**
     * ‰ΩçÁΩÆ„Çí„É™„Çª„ÉÉ„Éà
     */
    resetPosition() {
        this.applyPreset('center');
    }

    /**
     * UI„ÅÆË°®Á§∫/ÈùûË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
     */
    toggleUI() {
        if (this.ui) {
            this.ui.classList.toggle('hidden');
        }
    }

    /**
     * „Éó„É©„Ç∞„Ç§„É≥„ÇíÁ†¥Ê£Ñ
     */
    destroy() {
        if (this.ui) {
            this.ui.remove();
        }

        const styles = document.getElementById('spine-positioning-styles');
        if (styles) {
            styles.remove();
        }

        this.characters.clear();
        this.initialized = false;

        console.log('üóëÔ∏è Spine Positioning Plugin Á†¥Ê£ÑÂÆå‰∫Ü');
    }
}

// „Ç∞„É≠„Éº„Éê„É´„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰ΩúÊàê
window.SpinePositioning = new SpinePositioningPlugin();

// Ëá™ÂãïÂàùÊúüÂåñÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
if (document.currentScript && document.currentScript.hasAttribute('data-auto-init')) {
    window.SpinePositioning.init();
}

// „Ç®„ÇØ„Çπ„Éù„Éº„ÉàÔºàES6„É¢„Ç∏„É•„Éº„É´ÂØæÂøúÔºâ
if (typeof module !== 'undefined' && module.exports) {
    module.exports = SpinePositioningPlugin;
}