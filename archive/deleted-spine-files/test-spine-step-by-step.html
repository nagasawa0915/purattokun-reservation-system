<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spineæ®µéšçš„æ¤œè¨¼å®Ÿé¨“</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        .experiment-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .step {
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .step-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        /* Step 1: åŸºæœ¬æ§‹é€  */
        .step1-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            overflow: hidden;
        }
        
        .step1-bg {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .step1-character {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            object-fit: contain;
            border: 2px solid blue;
        }
        
        /* Step 2: CSSè¿½åŠ  */
        .step2-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            overflow: hidden;
        }
        
        .step2-bg {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .step2-character {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            object-fit: contain;
            z-index: 10;
            pointer-events: auto;
            cursor: move;
            border: 2px dashed rgba(255, 107, 107, 0.3);
        }
        
        /* Step 3: Canvas + Spine */
        .step3-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            overflow: hidden;
        }
        
        .step3-bg {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .step3-canvas {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            z-index: 10;
            border: 2px solid green;
        }
        
        .step3-fallback {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            object-fit: contain;
            z-index: 10;
            display: none;
            border: 2px solid red;
        }
        
        /* ãƒ‡ãƒãƒƒã‚°ç”¨ */
        .debug-info {
            margin: 10px 0;
            padding: 10px;
            background: #e8f4fd;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .control-buttons {
            margin: 15px 0;
        }
        
        .btn {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #007cba;
            color: white;
            cursor: pointer;
        }
        
        .btn:hover {
            background: #005a8a;
        }
    </style>
</head>
<body>
    <div class="experiment-container">
        <h1>ğŸ§ª Spineè¡¨ç¤ºå•é¡Œ æ®µéšçš„æ¤œè¨¼å®Ÿé¨“</h1>
        <p>å„ã‚¹ãƒ†ãƒƒãƒ—ã§è¦ç´ ã‚’è¿½åŠ ã—ã€ã©ã®æ™‚ç‚¹ã§ã·ã‚‰ã£ã¨ãã‚“ãŒè¦‹ãˆãªããªã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
        
        <!-- Step 1: æœ€å°é™ -->
        <div class="step">
            <div class="step-title">ğŸ“ Step 1: æœ€å°é™ï¼ˆèƒŒæ™¯ + é™çš„ç”»åƒï¼‰</div>
            <div class="step1-container">
                <img src="assets/images/ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼TOP.png" alt="èƒŒæ™¯" class="step1-bg">
                <img src="assets/images/purattokunn.png" alt="ã·ã‚‰ã£ã¨ãã‚“" class="step1-character">
            </div>
            <div class="debug-info" id="step1-info">Step 1 è¨ºæ–­çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
        
        <!-- Step 2: CSSã‚¯ãƒ©ã‚¹è¿½åŠ  -->
        <div class="step">
            <div class="step-title">ğŸ“ Step 2: CSSã‚¯ãƒ©ã‚¹è¿½åŠ ï¼ˆdraggable-characterç›¸å½“ï¼‰</div>
            <div class="step2-container">
                <img src="assets/images/ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼TOP.png" alt="èƒŒæ™¯" class="step2-bg">
                <img src="assets/images/purattokunn.png" alt="ã·ã‚‰ã£ã¨ãã‚“" class="step2-character">
            </div>
            <div class="debug-info" id="step2-info">Step 2 è¨ºæ–­çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
        
        <!-- Step 3: Canvas + Spine ã‚·ã‚¹ãƒ†ãƒ  -->
        <div class="step">
            <div class="step-title">ğŸ“ Step 3: Canvas + Spine ã‚·ã‚¹ãƒ†ãƒ </div>
            <div class="step3-container">
                <img src="assets/images/ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼TOP.png" alt="èƒŒæ™¯" class="step3-bg">
                <canvas id="step3-canvas" class="step3-canvas"></canvas>
                <img src="assets/images/purattokunn.png" alt="ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯" 
                     id="step3-fallback" class="step3-fallback">
            </div>
            <div class="control-buttons">
                <button class="btn" onclick="initSpineStep3()">SpineåˆæœŸåŒ–</button>
                <button class="btn" onclick="showFallbackStep3()">ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º</button>
                <button class="btn" onclick="showCanvasStep3()">Canvasè¡¨ç¤º</button>
                <button class="btn" onclick="debugCanvas()">Canvasè©³ç´°è¨ºæ–­</button>
                <button class="btn" onclick="testCanvasDraw()">Canvasæç”»ãƒ†ã‚¹ãƒˆ</button>
            </div>
            <div class="debug-info" id="step3-info">Step 3 è¨ºæ–­çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
        
        <!-- Step 4: å®Œå…¨ãªè¦–è¦šçš„ãƒ‡ãƒ¢æ§‹é€  -->
        <div class="step">
            <div class="step-title">ğŸ“ Step 4: å®Œå…¨ãªè¦–è¦šçš„ãƒ‡ãƒ¢æ§‹é€ å†ç¾</div>
            <div id="step4-container">
                <!-- ã“ã“ã«è¦–è¦šçš„ãƒ‡ãƒ¢ã®å®Œå…¨ãªæ§‹é€ ã‚’æ®µéšçš„ã«è¿½åŠ  -->
            </div>
            <div class="control-buttons">
                <button class="btn" onclick="addVisualDemoStructure()">è¦–è¦šçš„ãƒ‡ãƒ¢æ§‹é€ ã‚’è¿½åŠ </button>
                <button class="btn" onclick="addPositioningMode()">ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰è¿½åŠ </button>
            </div>
            <div class="debug-info" id="step4-info">Step 4 è¨ºæ–­çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
        
        <!-- è¨ºæ–­ãƒ„ãƒ¼ãƒ« -->
        <div class="step">
            <div class="step-title">ğŸ”§ è¨ºæ–­ãƒ„ãƒ¼ãƒ«</div>
            <div class="control-buttons">
                <button class="btn" onclick="runDiagnostics()">å…¨ã‚¹ãƒ†ãƒƒãƒ—è¨ºæ–­å®Ÿè¡Œ</button>
                <button class="btn" onclick="clearResults()">çµæœã‚¯ãƒªã‚¢</button>
            </div>
        </div>
    </div>

    <!-- Spine WebGL Runtime -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.*/dist/iife/spine-webgl.js"></script>
    
    <script>
        // SpineåˆæœŸåŒ–
        async function initSpineStep3() {
            try {
                console.log('ğŸ¬ Step 3 SpineåˆæœŸåŒ–é–‹å§‹...');
                
                const canvas = document.getElementById('step3-canvas');
                const fallback = document.getElementById('step3-fallback');
                
                if (!canvas) {
                    throw new Error('Canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯éè¡¨ç¤ºã€Canvasè¡¨ç¤º
                fallback.style.display = 'none';
                canvas.style.display = 'block';
                
                // WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
                const gl = canvas.getContext('webgl', { alpha: true });
                if (!gl) {
                    throw new Error('WebGLãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // Canvasã‚µã‚¤ã‚ºè¨­å®š
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                
                // ã‚¢ã‚»ãƒƒãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
                const basePath = 'assets/spine/characters/purattokun/';
                const assetManager = new spine.AssetManager(gl, basePath);
                assetManager.loadTextureAtlas('purattokun.atlas');
                assetManager.loadJson('purattokun.json');
                
                // ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å¾…ã¡
                await new Promise((resolve, reject) => {
                    let checkCount = 0;
                    const maxChecks = 100;
                    
                    const checkAssets = () => {
                        checkCount++;
                        if (assetManager.isLoadingComplete()) {
                            resolve();
                        } else if (checkCount > maxChecks) {
                            reject(new Error('ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
                        } else {
                            setTimeout(checkAssets, 100);
                        }
                    };
                    checkAssets();
                });
                
                // Spineè¨­å®š
                const atlas = assetManager.get('purattokun.atlas');
                const atlasLoader = new spine.AtlasAttachmentLoader(atlas);
                const skeletonJson = new spine.SkeletonJson(atlasLoader);
                const skeletonData = skeletonJson.readSkeletonData(assetManager.get('purattokun.json'));
                
                const skeleton = new spine.Skeleton(skeletonData);
                skeleton.x = canvas.width / 2;
                skeleton.y = canvas.height / 2;
                skeleton.scaleX = skeleton.scaleY = 1.0;  // ğŸ”§ ã‚¹ã‚±ãƒ¼ãƒ«ã‚’å¤§ããå¤‰æ›´
                
                const animationStateData = new spine.AnimationStateData(skeleton.data);
                const animationState = new spine.AnimationState(animationStateData);
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
                if (skeleton.data.findAnimation('taiki')) {
                    animationState.setAnimation(0, 'taiki', true);
                } else if (skeleton.data.animations.length > 0) {
                    animationState.setAnimation(0, skeleton.data.animations[0].name, true);
                }
                
                // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼
                const renderer = new spine.SceneRenderer(canvas, gl);
                let lastTime = Date.now() / 1000;
                
                function render() {
                    const now = Date.now() / 1000;
                    const delta = now - lastTime;
                    lastTime = now;
                    
                    animationState.update(delta);
                    animationState.apply(skeleton);
                    skeleton.updateWorldTransform();
                    
                    gl.clearColor(0, 0, 0, 0);
                    gl.clear(gl.COLOR_BUFFER_BIT);
                    gl.viewport(0, 0, canvas.width, canvas.height);
                    
                    renderer.begin();
                    renderer.drawSkeleton(skeleton, true);
                    renderer.end();
                    
                    requestAnimationFrame(render);
                }
                
                render();
                updateStepInfo('step3-info', 'âœ… SpineåˆæœŸåŒ–æˆåŠŸ');
                
            } catch (error) {
                console.error('SpineåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                updateStepInfo('step3-info', 'âŒ SpineåˆæœŸåŒ–å¤±æ•—: ' + error.message);
                showFallbackStep3();
            }
        }
        
        function showFallbackStep3() {
            const canvas = document.getElementById('step3-canvas');
            const fallback = document.getElementById('step3-fallback');
            
            canvas.style.display = 'none';
            fallback.style.display = 'block';
            updateStepInfo('step3-info', 'âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒè¡¨ç¤ºä¸­');
        }
        
        function showCanvasStep3() {
            const canvas = document.getElementById('step3-canvas');
            const fallback = document.getElementById('step3-fallback');
            
            fallback.style.display = 'none';
            canvas.style.display = 'block';
            updateStepInfo('step3-info', 'âœ… Canvasè¡¨ç¤ºä¸­');
        }
        
        function addVisualDemoStructure() {
            const container = document.getElementById('step4-container');
            container.innerHTML = `
                <div class="visual-demo" style="position: relative; max-width: 800px; margin: 0 auto; overflow: hidden;">
                    <div class="background-container" style="position: relative; width: 100%; overflow: hidden;">
                        <img src="assets/images/ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼TOP.png" alt="ãƒ‡ãƒ¢èƒŒæ™¯ç”»åƒ" class="background-image" style="width: 100%; height: auto; display: block;">
                        
                        <img src="assets/images/kumo1.png" alt="é›²1" class="animated-element cloud1" style="position: absolute; opacity: 0.7; pointer-events: none; z-index: 5; left: -5%; top: 10%; width: 8%;">
                        <img src="assets/images/kumo2.png" alt="é›²2" class="animated-element cloud2" style="position: absolute; opacity: 0.7; pointer-events: none; z-index: 5; left: -5%; top: 15%; width: 8%;">
                        
                        <canvas id="step4-canvas" class="positioned-element draggable-character" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; z-index: 10; border: 2px solid green;"></canvas>
                        
                        <img src="assets/images/purattokunn.png" alt="ã·ã‚‰ã£ã¨ãã‚“" id="step4-fallback" class="positioned-element draggable-character" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; z-index: 10; object-fit: contain; display: none; border: 2px solid red;">
                    </div>
                </div>
            `;
            updateStepInfo('step4-info', 'âœ… è¦–è¦šçš„ãƒ‡ãƒ¢æ§‹é€ ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        }
        
        function addPositioningMode() {
            // ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã®CSSãƒ»JavaScriptè¿½åŠ 
            updateStepInfo('step4-info', 'âœ… ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆå®Ÿè£…äºˆå®šï¼‰');
        }
        
        function runDiagnostics() {
            // Step 1 è¨ºæ–­
            const step1Char = document.querySelector('.step1-character');
            if (step1Char) {
                const rect1 = step1Char.getBoundingClientRect();
                updateStepInfo('step1-info', `âœ… è¡¨ç¤º: ${rect1.width}x${rect1.height} at (${Math.round(rect1.left)}, ${Math.round(rect1.top)})`);
            }
            
            // Step 2 è¨ºæ–­
            const step2Char = document.querySelector('.step2-character');
            if (step2Char) {
                const rect2 = step2Char.getBoundingClientRect();
                updateStepInfo('step2-info', `âœ… è¡¨ç¤º: ${rect2.width}x${rect2.height} at (${Math.round(rect2.left)}, ${Math.round(rect2.top)})`);
            }
            
            // Step 3 è¨ºæ–­
            const step3Canvas = document.getElementById('step3-canvas');
            const step3Fallback = document.getElementById('step3-fallback');
            if (step3Canvas || step3Fallback) {
                const visibleElement = step3Canvas.style.display !== 'none' ? step3Canvas : step3Fallback;
                const rect3 = visibleElement.getBoundingClientRect();
                updateStepInfo('step3-info', `âœ… è¡¨ç¤ºä¸­: ${visibleElement.tagName} ${rect3.width}x${rect3.height} at (${Math.round(rect3.left)}, ${Math.round(rect3.top)})`);
            }
        }
        
        function updateStepInfo(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            }
        }
        
        function debugCanvas() {
            const canvas = document.getElementById('step3-canvas');
            if (!canvas) {
                updateStepInfo('step3-info', 'âŒ Canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            const gl = canvas.getContext('webgl');
            
            updateStepInfo('step3-info', `
                ğŸ“Š Canvasè©³ç´°è¨ºæ–­:<br>
                â€¢ å†…éƒ¨ã‚µã‚¤ã‚º: ${canvas.width} x ${canvas.height}<br>
                â€¢ è¡¨ç¤ºã‚µã‚¤ã‚º: ${rect.width} x ${rect.height}<br>
                â€¢ WebGL: ${gl ? 'âœ…å¯¾å¿œ' : 'âŒæœªå¯¾å¿œ'}<br>
                â€¢ ä½ç½®: (${Math.round(rect.left)}, ${Math.round(rect.top)})<br>
                â€¢ è¡¨ç¤ºçŠ¶æ…‹: ${canvas.style.display || 'block'}
            `);
        }
        
        function testCanvasDraw() {
            const canvas = document.getElementById('step3-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            if (ctx) {
                // Canvas 2Dæç”»ãƒ†ã‚¹ãƒˆ
                ctx.fillStyle = 'red';
                ctx.fillRect(10, 10, 60, 60);
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.fillText('TEST', 25, 45);
                updateStepInfo('step3-info', 'âœ… Canvas 2Dæç”»ãƒ†ã‚¹ãƒˆå®Œäº†ï¼ˆèµ¤ã„å››è§’ãŒè¦‹ãˆã¾ã™ã‹ï¼Ÿï¼‰');
            } else {
                updateStepInfo('step3-info', 'âŒ Canvas 2Dæç”»ã«å¤±æ•—');
            }
        }
        
        function clearResults() {
            ['step1-info', 'step2-info', 'step3-info', 'step4-info'].forEach(id => {
                updateStepInfo(id, 'è¨ºæ–­çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™');
            });
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸè¨ºæ–­
        window.addEventListener('load', () => {
            setTimeout(runDiagnostics, 1000);
        });
    </script>
</body>
</html>