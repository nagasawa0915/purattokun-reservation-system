<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spine診断ページ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .diagnosis-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        .canvas-container {
            border: 2px dashed #ff6b6b;
            background: white;
            display: inline-block;
            margin: 10px;
            width: 400px;
            height: 400px;
        }
        #spine-canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        .fallback-image {
            border: 2px solid #00ff00;
            max-width: 200px;
            max-height: 200px;
        }
        .status {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>🔍 Spineキャラクター診断システム</h1>
    
    <div class="diagnosis-panel">
        <h2>📊 診断結果</h2>
        <div id="diagnosis-results"></div>
        
        <h3>🔍 index.htmlとの比較診断</h3>
        <button onclick="compareWithIndex()">index.htmlと比較実行</button>
        <div id="comparison-results" style="margin-top: 10px;"></div>
    </div>

    <div class="diagnosis-panel">
        <h2>🎯 Spineキャラクター表示テスト</h2>
        <div class="canvas-container">
            <canvas id="spine-canvas" width="120" height="120"></canvas>
        </div>
        
        <h3>📸 フォールバック画像</h3>
        <img src="assets/images/purattokunn.png" 
             class="fallback-image"
             alt="ぷらっとくん" 
             id="fallback-test">
    </div>

    <div class="diagnosis-panel">
        <h2>🎯 キャラクター位置調整（テスト用）</h2>
        <div>
            <label>X座標: <input type="range" id="x-slider" min="-200" max="200" value="50" step="10"></label>
            <span id="x-value">50</span>
        </div>
        <div>
            <label>Y座標: <input type="range" id="y-slider" min="-300" max="100" value="-100" step="10"></label>
            <span id="y-value">-100</span>
        </div>
        <div>
            <label>スケール: <input type="range" id="scale-slider" min="0.1" max="2.0" value="0.55" step="0.05"></label>
            <span id="scale-value">0.55</span>
        </div>
        <button onclick="applyPosition()">位置を適用</button>
        <button onclick="resetPosition()">リセット</button>
    </div>

    <div class="diagnosis-panel">
        <h2>📝 診断ログ</h2>
        <div id="log-output" class="log"></div>
    </div>

    <script>
        const log = document.getElementById('log-output');
        const results = document.getElementById('diagnosis-results');
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            log.textContent += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            results.appendChild(div);
        }

        // 診断開始
        addLog('🚀 Spine診断開始');
        
        // 1. ファイル存在確認
        addLog('📁 ファイル存在確認開始');
        
        // フォールバック画像の確認
        const fallbackImg = document.getElementById('fallback-test');
        fallbackImg.onload = () => {
            addLog('✅ フォールバック画像読み込み成功');
            addResult('フォールバック画像: 正常', 'success');
        };
        fallbackImg.onerror = () => {
            addLog('❌ フォールバック画像読み込み失敗');
            addResult('フォールバック画像: エラー', 'error');
        };

        // 2. Spine WebGLライブラリ確認
        addLog('📚 Spine WebGLライブラリ確認');
        
        const script = document.createElement('script');
        script.src = 'assets/js/libs/spine-webgl.js';
        script.onload = () => {
            addLog('✅ spine-webgl.js読み込み成功');
            addResult('Spine WebGLライブラリ: 正常', 'success');
            
            // Spineオブジェクト確認
            if (typeof spine !== 'undefined') {
                addLog('✅ spineオブジェクト利用可能');
                addResult('Spineオブジェクト: 利用可能', 'success');
                
                // 詳細診断（index.htmlと同様）
                addLog('🔍 詳細診断:');
                addLog(`  - spine定義: ${typeof spine}`);
                addLog(`  - AssetManager存在: ${!!spine?.AssetManager}`);
                addLog(`  - Shader存在: ${!!spine?.Shader}`);
                addLog(`  - SceneRenderer存在: ${!!spine?.SceneRenderer}`);
                addLog(`  - webgl名前空間存在: ${!!spine?.webgl}`);
                if (spine?.webgl) {
                    addLog(`  - webgl.SceneRenderer存在: ${!!spine?.webgl?.SceneRenderer}`);
                    addLog(`  - webgl.AssetManager存在: ${!!spine?.webgl?.AssetManager}`);
                }
                
                initializeSpine();
            } else {
                addLog('❌ spineオブジェクト未定義');
                addResult('Spineオブジェクト: 未定義', 'error');
            }
        };
        script.onerror = () => {
            addLog('❌ spine-webgl.js読み込み失敗');
            addResult('Spine WebGLライブラリ: エラー', 'error');
        };
        document.head.appendChild(script);

        function initializeSpine() {
            try {
                addLog('🎯 Spine初期化開始');
                
                const canvas = document.getElementById('spine-canvas');
                const context = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                
                if (!context) {
                    addLog('❌ WebGLコンテキスト取得失敗');
                    addResult('WebGLコンテキスト: 利用不可', 'error');
                    return;
                }
                
                addLog('✅ WebGLコンテキスト取得成功');
                addResult('WebGLコンテキスト: 利用可能', 'success');
                
                // Canvas内部解像度設定（index.htmlと同様）
                canvas.width = 120;
                canvas.height = 120;
                addLog(`📏 Canvas内部解像度設定: ${canvas.width}x${canvas.height}`);
                
                // Spine WebGL初期化
                const gl = context;
                
                // Shader初期化（index.htmlと同様）
                const shader = spine.Shader.newTwoColoredTextured(gl);
                addLog('✅ Shader作成成功');
                
                const renderer = new spine.SceneRenderer(canvas, gl);
                
                // アセット読み込み（index.htmlと同様）
                const basePath = 'assets/spine/characters/purattokun/';
                addLog(`📥 アセット読み込み開始: ${basePath}`);
                const assetManager = new spine.AssetManager(gl, basePath);
                
                addLog('✅ SceneRenderer & AssetManager作成成功');
                
                addLog('📥 Atlas読み込み開始: purattokun.atlas');
                assetManager.loadTextureAtlas('purattokun.atlas');
                
                addLog('📥 JSON読み込み開始: purattokun.json');
                assetManager.loadJson('purattokun.json');
                
                let loadCheckCount = 0;
                const maxLoadChecks = 50;
                
                const checkLoaded = () => {
                    loadCheckCount++;
                    addLog(`📊 読み込み確認: ${loadCheckCount}/${maxLoadChecks}`);
                    
                    if (assetManager.isLoadingComplete()) {
                        addLog('✅ 全アセット読み込み完了');
                        addResult('Spineアセット読み込み: 完了', 'success');
                        setupSpineCharacter(renderer, assetManager);
                    } else if (loadCheckCount >= maxLoadChecks) {
                        addLog('❌ アセット読み込みタイムアウト');
                        addResult('Spineアセット読み込み: タイムアウト', 'error');
                        
                        // エラー詳細を確認
                        const errors = assetManager.getErrors();
                        if (errors && errors.length > 0) {
                            errors.forEach(error => {
                                addLog(`❌ アセットエラー: ${error}`);
                            });
                        } else {
                            addLog('⚠️ エラー詳細なし - ファイルパス確認が必要');
                            addLog(`📁 使用中のベースパス: ${basePath}`);
                            addLog('📋 読み込み対象ファイル: purattokun.atlas, purattokun.json');
                        }
                    } else {
                        setTimeout(checkLoaded, 100);
                    }
                };
                checkLoaded();
                
            } catch (error) {
                addLog(`❌ Spine初期化エラー: ${error.message}`);
                addResult(`Spine初期化: エラー (${error.message})`, 'error');
            }
        }
        
        function setupSpineCharacter(renderer, assetManager) {
            try {
                addLog('🎭 キャラクター設定開始');
                
                // Atlas取得（index.htmlと同様）
                const atlas = assetManager.get('purattokun.atlas');
                const atlasLoader = new spine.AtlasAttachmentLoader(atlas);
                
                // SkeletonData読み込み（index.htmlと同様）
                const skeletonJson = new spine.SkeletonJson(atlasLoader);
                const skeletonData = skeletonJson.readSkeletonData(assetManager.get('purattokun.json'));
                
                // Skeleton作成（index.htmlと同様の設定）
                const skeleton = new spine.Skeleton(skeletonData);
                skeleton.x = 50; // index.htmlと同じ値
                skeleton.y = -100; // index.htmlと同じ値（地面基準配置）
                skeleton.scaleX = skeleton.scaleY = 0.55; // CLAUDE.mdの推奨値
                
                // グローバル変数に設定（位置調整用）
                currentSkeleton = skeleton;
                
                // AnimationState（index.htmlと同様）
                const animationStateData = new spine.AnimationStateData(skeleton.data);
                const animationState = new spine.AnimationState(animationStateData);
                
                addLog('✅ Skeleton & AnimationState作成成功');
                addLog(`📍 キャラクター位置設定: x=${skeleton.x}, y=${skeleton.y}, scale=${skeleton.scaleX}`);
                
                // アニメーション設定（index.htmlのシーケンスを参考）
                if (skeleton.data.findAnimation('syutugen') && skeleton.data.findAnimation('taiki')) {
                    animationState.setAnimation(0, 'syutugen', false);
                    addLog('🎬 アニメーション設定: syutugen → taiki シーケンス');
                    
                    // syutugen完了後にtaikiに遷移するリスナー
                    const listener = {
                        complete: (entry) => {
                            if (entry.animation.name === 'syutugen') {
                                animationState.setAnimation(0, 'taiki', true);
                                addLog('🔄 syutugen完了、taikiに遷移');
                            }
                        }
                    };
                    animationState.addListener(listener);
                } else if (skeleton.data.animations.length > 0) {
                    const animName = skeleton.data.animations[0].name;
                    animationState.setAnimation(0, animName, true);
                    addLog(`🎬 アニメーション設定: ${animName} (fallback)`);
                }
                
                addResult('Spineキャラクター設定: 完了', 'success');
                
                // レンダリング開始
                startRendering(renderer, skeleton, animationState);
                
            } catch (error) {
                addLog(`❌ キャラクター設定エラー: ${error.message}`);
                addResult(`キャラクター設定: エラー (${error.message})`, 'error');
            }
        }
        
        function startRendering(renderer, skeleton, animationState) {
            addLog('🎬 レンダリング開始');
            
            const canvas = document.getElementById('spine-canvas');
            const gl = canvas.getContext('webgl', { alpha: true });
            let lastTime = Date.now() / 1000;
            
            function render() {
                const now = Date.now() / 1000;
                const delta = now - lastTime;
                lastTime = now;
                
                // アニメーション更新
                animationState.update(delta);
                animationState.apply(skeleton);
                skeleton.updateWorldTransform();
                
                // レンダリング（index.htmlと同様）
                gl.clearColor(0, 0, 0, 0);
                gl.clear(gl.COLOR_BUFFER_BIT);
                gl.viewport(0, 0, 120, 120); // 固定サイズでビューポート設定
                
                renderer.begin();
                renderer.drawSkeleton(skeleton, true);
                renderer.end();
                
                requestAnimationFrame(render);
            }
            
            render();
            addLog('✅ レンダリングループ開始');
            addResult('Spineレンダリング: 開始', 'success');
            
            // クリック機能も追加（診断・テスト用）
            canvas.addEventListener('click', function() {
                addLog('🖱️ ぷらっとくんクリック - やられアニメーション再生');
                
                if (skeleton.data.findAnimation('yarare') && skeleton.data.findAnimation('taiki')) {
                    animationState.setAnimation(0, 'yarare', false);
                    
                    const clickListener = {
                        complete: (entry) => {
                            if (entry.animation.name === 'yarare') {
                                animationState.setAnimation(0, 'taiki', true);
                                animationState.removeListener(clickListener);
                                addLog('🔄 yarare完了、taikiに戻りました');
                            }
                        }
                    };
                    animationState.addListener(clickListener);
                } else {
                    addLog('⚠️ yarareアニメーションが見つかりません');
                }
            });
        }
        
        // 初期診断ログ
        addLog('🔍 環境確認');
        addLog(`UserAgent: ${navigator.userAgent}`);
        addLog(`画面サイズ: ${window.innerWidth}x${window.innerHeight}`);
        addLog(`WebGL対応: ${window.WebGLRenderingContext ? 'あり' : 'なし'}`);
        
        // グローバル変数（位置調整用）
        let currentSkeleton = null;
        
        // 位置調整機能
        function setupPositionControls() {
            const xSlider = document.getElementById('x-slider');
            const ySlider = document.getElementById('y-slider');
            const scaleSlider = document.getElementById('scale-slider');
            const xValue = document.getElementById('x-value');
            const yValue = document.getElementById('y-value');
            const scaleValue = document.getElementById('scale-value');
            
            xSlider.addEventListener('input', () => {
                xValue.textContent = xSlider.value;
            });
            
            ySlider.addEventListener('input', () => {
                yValue.textContent = ySlider.value;
            });
            
            scaleSlider.addEventListener('input', () => {
                scaleValue.textContent = scaleSlider.value;
            });
        }
        
        function applyPosition() {
            if (!currentSkeleton) {
                addLog('⚠️ Skeletonが設定されていません');
                return;
            }
            
            const x = parseFloat(document.getElementById('x-slider').value);
            const y = parseFloat(document.getElementById('y-slider').value);
            const scale = parseFloat(document.getElementById('scale-slider').value);
            
            currentSkeleton.x = x;
            currentSkeleton.y = y;
            currentSkeleton.scaleX = currentSkeleton.scaleY = scale;
            
            addLog(`🎯 位置調整: x=${x}, y=${y}, scale=${scale}`);
        }
        
        function resetPosition() {
            const xSlider = document.getElementById('x-slider');
            const ySlider = document.getElementById('y-slider');
            const scaleSlider = document.getElementById('scale-slider');
            
            xSlider.value = 50;
            ySlider.value = -100;
            scaleSlider.value = 0.55;
            
            document.getElementById('x-value').textContent = '50';
            document.getElementById('y-value').textContent = '-100';
            document.getElementById('scale-value').textContent = '0.55';
            
            applyPosition();
        }
        
        // 初期化
        setupPositionControls();
        
        // index.htmlとの比較診断
        function compareWithIndex() {
            const comparisonDiv = document.getElementById('comparison-results');
            comparisonDiv.innerHTML = '<div class="status warning">比較診断実行中...</div>';
            
            // 新しいウィンドウでindex.htmlを開く
            const indexWindow = window.open('index.html', 'indexTest', 'width=800,height=600');
            
            if (indexWindow) {
                addLog('🔍 index.htmlを新ウィンドウで開きました');
                comparisonDiv.innerHTML += '<div class="status success">index.htmlが新ウィンドウで開かれました。F12コンソールで以下を比較してください：</div>';
                comparisonDiv.innerHTML += '<ul>';
                comparisonDiv.innerHTML += '<li>🎯 「✅ Spineキャラクター動作中」メッセージの有無</li>';
                comparisonDiv.innerHTML += '<li>📏 Canvas内部解像度（120x120）</li>';
                comparisonDiv.innerHTML += '<li>📍 Skeleton位置（x=50, y=-100, scale=0.55）</li>';
                comparisonDiv.innerHTML += '<li>🎬 アニメーション再生状況</li>';
                comparisonDiv.innerHTML += '<li>❌ エラーメッセージの有無</li>';
                comparisonDiv.innerHTML += '</ul>';
                comparisonDiv.innerHTML += '<div class="status info">診断ページ: 修正済み設定 | index.html: 本番環境設定</div>';
            } else {
                comparisonDiv.innerHTML = '<div class="status error">ポップアップブロックされました。手動でindex.htmlを開いて比較してください。</div>';
            }
        }
        
    </script>
</body>
</html>