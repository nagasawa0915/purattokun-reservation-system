<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ± Purattokun + StableSpineRenderer + BoundingBox ãƒ†ã‚¹ãƒˆ</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #2e86ab 0%, #a23b72 100%);
        color: white;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      .subtitle {
        font-size: 1.2em;
        opacity: 0.9;
        margin-top: 10px;
      }

      /* ğŸ¯ è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯¾å¿œã‚¹ã‚¿ã‚¤ãƒ« */
      .characters-container {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin: 0 auto;
        max-width: 800px;
      }

      .character-container {
        position: relative;
        width: 300px;
        height: 300px;
        /* ğŸ¯ è¦–è¦šçš„è£…é£¾ã‚’å‰Šé™¤ - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã¿ã‚’éš›ç«‹ãŸã›ã‚‹ */
        background: transparent;
        overflow: visible; /* BBãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«visibleã«å¤‰æ›´ */
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        transition: all 0.3s ease;
      }

      .character-container:hover {
        border-color: rgba(255, 215, 0, 0.5);
        box-shadow: 0 4px 16px rgba(255, 215, 0, 0.2);
      }

      .character-container canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        /* ğŸ¯ CanvasèƒŒæ™¯ã‚‚é€æ˜ã« */
        background: transparent;
        /* ğŸ¯ æ­ªã¿é˜²æ­¢: ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒ */
        object-fit: contain;
        image-rendering: pixelated;
      }

      .character-label {
        position: absolute;
        bottom: -30px;
        left: 50%;
        transform: translateX(-50%);
        color: #ffd700;
        font-size: 14px;
        font-weight: 600;
        text-align: center;
        white-space: nowrap;
      }

      /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
      @media (max-width: 768px) {
        .characters-container {
          flex-direction: column;
          align-items: center;
          gap: 20px;
        }
        
        .character-container {
          width: 250px;
          height: 250px;
        }
      }

      .controls {
        position: fixed;
        top: 20px;
        right: 20px;
        bottom: 20px;
        width: 280px;
        background: rgba(0, 0, 0, 0.8);
        padding: 20px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        overflow-y: auto;
        overflow-x: hidden;
      }

      .control-group {
        margin-bottom: 15px;
      }

      .control-group h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #ffd700;
      }

      .btn {
        display: block;
        width: 100%;
        padding: 8px 12px;
        margin: 5px 0;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
      }

      .btn:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .btn.success {
        background: rgba(76, 175, 80, 0.8);
      }

      .btn.danger {
        background: rgba(244, 67, 54, 0.8);
      }

      .btn.primary {
        background: rgba(33, 150, 243, 0.8);
      }

      .log {
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 350px;
        max-height: 250px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        font-family: "Courier New", monospace;
        font-size: 11px;
        padding: 10px;
        border-radius: 5px;
        overflow-y: auto;
        border: 1px solid rgba(255, 255, 255, 0.2);
        z-index: 1000;
      }

      .status {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        padding: 15px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .status-item {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
        font-size: 13px;
      }

      .status-label {
        color: #ccc;
      }

      .status-value {
        color: #ffd700;
        font-weight: bold;
      }

      .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        z-index: 1000;
      }

      .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid #ffd700;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºç”¨ã®z-indexã‚’ç¢ºä¿ */
      .bounding-box-overlay {
        z-index: 999 !important;
      }

      /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
      .controls::-webkit-scrollbar {
        width: 8px;
      }

      .controls::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
      }

      .controls::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }

      .controls::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ± Purattokun + StableSpineRenderer + BoundingBox</h1>
        <div class="subtitle">
          æœ€æ–°å®‰å®šç‰ˆ - é»’æ å•é¡Œå®Œå…¨è§£æ±º + BBçµ±åˆãƒ†ã‚¹ãƒˆ + è‡ªå‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ¤œå‡º
        </div>
      </div>

      <!-- ğŸ¯ è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯¾å¿œã‚³ãƒ³ãƒ†ãƒŠ -->
      <div class="characters-container">
        <!-- ã·ã‚‰ã£ã¨ãã‚“ -->
        <div class="character-container" id="purattokun-container">
          <canvas id="purattokun-canvas" width="300" height="300"></canvas>
          <div class="character-label">ğŸ± ã·ã‚‰ã£ã¨ãã‚“</div>
        </div>
        
        <!-- ã­ãšã¿ã¡ã‚ƒã‚“ -->
        <div class="character-container" id="nezumi-container">
          <canvas id="nezumi-canvas" width="300" height="300"></canvas>
          <div class="character-label">ğŸ­ ã­ãšã¿ã¡ã‚ƒã‚“</div>
        </div>
      </div>
    </div>

    <div class="status" id="status-panel">
      <h3 style="margin: 0 0 10px 0; color: #ffd700">ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
      <div class="status-item">
        <span class="status-label">StableSpineRenderer:</span>
        <span class="status-value" id="renderer-status">åˆæœŸåŒ–ä¸­</span>
      </div>
      <div class="status-item">
        <span class="status-label">Purattokunèª­ã¿è¾¼ã¿:</span>
        <span class="status-value" id="nezumi-status">å¾…æ©Ÿä¸­</span>
      </div>
      <div class="status-item">
        <span class="status-label">ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹:</span>
        <span class="status-value" id="bbox-status">å¾…æ©Ÿä¸­</span>
      </div>
      <div class="status-item">
        <span class="status-label">çµ±åˆçŠ¶æ…‹:</span>
        <span class="status-value" id="integration-status">æº–å‚™ä¸­</span>
      </div>
    </div>

    <div class="controls">
      <div class="control-group">
        <h3>â­ è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¶å¾¡</h3>
        <button class="btn primary" id="init-renderer">ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼åˆæœŸåŒ–</button>
        <button class="btn" id="load-purattokun">ğŸ± Purattokunèª­ã¿è¾¼ã¿</button>
        <button class="btn" id="load-nezumi">ğŸ­ Nezumièª­ã¿è¾¼ã¿</button>
        <button class="btn" id="load-all-characters">ğŸŒŸ å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿</button>
      </div>

      <!-- ğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å€‹åˆ¥åˆ¶å¾¡ -->
      <div class="control-group">
        <h3>ğŸ® ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¶å¾¡</h3>
        <div id="character-controls">
          <p style="color: #ccc; font-size: 12px;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã™ã‚‹ã¨åˆ¶å¾¡ãƒ‘ãƒãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>
      </div>

      <div class="control-group">
        <h3>ğŸ“¦ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹</h3>
        <button class="btn" id="create-bbox">BBä½œæˆ</button>
        <button class="btn" id="toggle-bbox">BBè¡¨ç¤ºåˆ‡æ›¿</button>
        <button class="btn" id="test-resize">ãƒªã‚µã‚¤ã‚ºãƒ†ã‚¹ãƒˆ</button>
        <button class="btn danger" id="cleanup-bbox">BBã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—</button>
      </div>

      <div class="control-group">
        <h3>ğŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆ</h3>
        <button class="btn success" id="full-test">å®Œå…¨çµ±åˆãƒ†ã‚¹ãƒˆ</button>
        <button class="btn" id="performance-test">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn danger" id="reset-all">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <!-- ğŸ”§ ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ï¼ˆiframeã‹ã‚‰ç§»å‹•ï¼‰ -->
      <div class="control-group">
        <h3>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½</h3>
        <button class="btn" id="debug-info-btn">ğŸ’¡ ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º</button>
        <button class="btn" id="clear-log-btn">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        <button class="btn" id="console-debug">ğŸ–¥ï¸ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°</button>
      </div>

      <!-- ğŸ¯ CanvasResizeController ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ±åˆ -->
      <div class="control-group canvas-resize-module">
        <h3>ğŸ›ï¸ Canvasåˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰</h3>
        <p style="font-size: 0.8em; color: #ccc; margin: 5px 0 10px 0">
          iframeçµ±åˆã«ã‚ˆã‚‹å®Œå…¨åˆ†é›¢UIãƒ»ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªå¯¾å¿œ
        </p>
        
        <!-- CanvasResizeController UI iframe -->
        <iframe 
          src="./micromodules/canvas-resize/ui.html" 
          id="canvas-resize-iframe"
          width="100%" 
          height="500"
          frameborder="0"
          style="
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.5);
            overflow: hidden;
          ">
        </iframe>
      </div>
    </div>

    <div class="log" id="log-panel">
      <div style="color: #ffd700; margin-bottom: 10px">ğŸ“ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</div>
    </div>

    <div class="loading" id="loading-screen">
      <div class="spinner"></div>
      <div>StableSpineRenderer + BB ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <!-- Spine WebGL -->
    <script src="assets/js/libs/spine-webgl.js"></script>

    <!-- StableSpineRenderer -->
    <script src="micromodules/spine-renderer/StableSpineRenderer.js"></script>

    <!-- ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    <script src="micromodules/bounding-box/PureBoundingBoxCore.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxBounds.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxUI.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxEvents.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBox.js"></script>
    
    <!-- ğŸ¯ Phase 1: LogSystem ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    <script src="micromodules/spine-integration/LogSystem.js"></script>

    <script>
      /**
       * ğŸ¯ å¤šã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ + StableSpineRenderer + BoundingBox çµ±åˆã‚·ã‚¹ãƒ†ãƒ 
       *
       * ç‰¹å¾´:
       * - è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯¾å¿œï¼ˆpurattokun + nezumiï¼‰
       * - StableSpineRendererã«ã‚ˆã‚‹ç¢ºå®ŸãªSpineè¡¨ç¤ºï¼ˆé»’æ å•é¡Œè§£æ±ºæ¸ˆã¿ï¼‰
       * - PureBoundingBoxã«ã‚ˆã‚‹é«˜åº¦ãªãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ç·¨é›†
       * - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠãƒ»åˆ¶å¾¡çµ±åˆã‚·ã‚¹ãƒ†ãƒ 
       */
      class MultiCharacterStableSpineBBIntegration {
        constructor() {
          // ğŸ¯ è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç†
          this.characters = {
            purattokun: {
              canvas: document.getElementById("purattokun-canvas"),
              renderer: null,
              boundingBox: null,
              loaded: false
            },
            nezumi: {
              canvas: document.getElementById("nezumi-canvas"), 
              renderer: null,
              boundingBox: null,
              loaded: false
            }
          };

          // ç¾åœ¨é¸æŠä¸­ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
          this.selectedCharacter = null;

          // çŠ¶æ…‹ç®¡ç†
          this.rendererInitialized = false;
          this.integrationComplete = false;

          // ğŸ¯ SpineSettingsPersistence ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ±åˆ
          this.settingsPersistence = new SpineSettingsPersistence({
            debug: true, // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°æœ‰åŠ¹
            version: '1.0'
          });

          // ğŸ¯ LogSystem ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ±åˆ
          this.logSystem = new SpineLogSystem({
            logLevel: 'info',
            maxLogs: 1000,
            showTimestamp: true,
            enableConsole: true,
            enableHtml: true,
            prefix: '[StableSpineBB]'
          });

          this.init();

          // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®Canvasè§£åƒåº¦èª¿æ•´
          window.addEventListener('resize', () => {
            setTimeout(() => {
              this.handleWindowResize();
            }, 100);
          });
        }

        async init() {
          this.log("ğŸš€ StableSpine + BBçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹");

          try {
            // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¢ºèª
            await this.checkDependencies();

            // ğŸ¯ è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”¨UIã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            this.setupMultiCharacterEventListeners();

            // ğŸ¨ Canvasæ“ä½œãƒœã‚¿ãƒ³ã®æ‹¡å¼µï¼ˆã‚ªãƒ¬ãƒ³ã‚¸BBè¡¨ç¤ºæ©Ÿèƒ½ï¼‰
            this.enhanceCanvasButtons();

            // èª­ã¿è¾¼ã¿ç”»é¢ã‚’éè¡¨ç¤º
            this.hideLoading();
            
            this.log("âœ… åˆæœŸåŒ–å®Œäº† - ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼åˆæœŸåŒ–ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„");
            this.updateStatus("integration-status", "åˆæœŸåŒ–å®Œäº†");
          } catch (error) {
            this.log(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            this.updateStatus("integration-status", "åˆæœŸåŒ–å¤±æ•—");
            this.hideLoading(); // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚èª­ã¿è¾¼ã¿ç”»é¢ã‚’éè¡¨ç¤º
          }
        }

        async checkDependencies() {
          this.log("ğŸ” ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¾å­˜é–¢ä¿‚ç¢ºèªä¸­...");

          // SpineLogSystemç¢ºèª
          if (typeof window.SpineLogSystem === "undefined") {
            throw new Error("SpineLogSystemãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }

          // Spine WebGLç¢ºèª
          if (typeof window.spine === "undefined") {
            throw new Error("Spine WebGLãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }

          // StableSpineRendererç¢ºèª
          if (typeof window.StableSpineRenderer === "undefined") {
            throw new Error("StableSpineRendererãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }

          // PureBoundingBoxç¢ºèª
          if (typeof window.PureBoundingBox === "undefined") {
            throw new Error("PureBoundingBoxãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }

          this.log("âœ… å…¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¢ºèªå®Œäº†");
        }

        // ğŸ¯ è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”¨UIã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        setupMultiCharacterEventListeners() {
          // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼åˆæœŸåŒ–
          const initRendererBtn = document.getElementById("init-renderer");
          if (initRendererBtn) {
            initRendererBtn.onclick = () => this.initRenderer();
          }

          // å€‹åˆ¥ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿
          const loadPurattokuBtn = document.getElementById("load-purattokun");
          if (loadPurattokuBtn) {
            loadPurattokuBtn.onclick = () => this.loadPurattokun();
          }

          const loadNezumiBtn = document.getElementById("load-nezumi");
          if (loadNezumiBtn) {
            loadNezumiBtn.onclick = () => this.loadNezumi();
          }

          // å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿
          const loadAllBtn = document.getElementById("load-all-characters");
          if (loadAllBtn) {
            loadAllBtn.onclick = () => this.loadAllCharacters();
          }

          // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠè¨­å®š
          this.setupCharacterSelection('purattokun');
          this.setupCharacterSelection('nezumi');

          this.log("âœ… è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†");
        }

        async initRenderer() {
          this.log("â­ è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”¨ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼åˆæœŸåŒ–ä¸­...");
          this.updateStatus("renderer-status", "åˆæœŸåŒ–ä¸­");

          try {
            this.rendererInitialized = true;
            this.updateStatus("renderer-status", "åˆæœŸåŒ–å®Œäº†");
            this.log("âœ… è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†");
            this.log("ğŸ“ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„");
          } catch (error) {
            this.log(`âŒ ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            this.updateStatus("renderer-status", "åˆæœŸåŒ–å¤±æ•—");
          }
        }

        // ğŸ¯ å€‹åˆ¥ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿ãƒ¡ã‚½ãƒƒãƒ‰
        async loadCharacter(characterId) {
          if (!this.rendererInitialized) {
            this.log("âš ï¸ å…ˆã«ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„");
            return;
          }

          const character = this.characters[characterId];
          if (!character) {
            this.log(`âŒ æœªçŸ¥ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼: ${characterId}`);
            return;
          }

          this.log(`ğŸ¯ ${characterId} èª­ã¿è¾¼ã¿é–‹å§‹...`);

          try {
            // StableSpineRendererä½œæˆï¼ˆ1:1ã®ç†æƒ³æ¯”ç‡ã§è¨­å®šï¼‰
            character.renderer = new StableSpineRenderer({
              canvas: character.canvas,
              character: characterId,
              basePath: "/assets/spine/characters/",
              debug: true,
              position: {
                x: 100,
                y: -100,
                scaleX: 1.0,  // 1:1ã®ç†æƒ³æ¯”ç‡
                scaleY: 1.0   // 1:1ã®ç†æƒ³æ¯”ç‡
              },
              logCallback: (message, level) =>
                this.log(`[${characterId}] ${message}`),
            });

            // åˆæœŸåŒ–å®Ÿè¡Œ
            await character.renderer.initialize();
            character.loaded = true;

            // Canvasè§£åƒåº¦ã‚’æ­£ã—ãè¨­å®šï¼ˆæ­ªã¿é˜²æ­¢ï¼‰
            this.fixCanvasAspectRatio(character.canvas);

            this.log(`âœ… ${characterId} èª­ã¿è¾¼ã¿å®Œäº†`);
            
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
            this.setupCharacterSelection(characterId);
            
            // åˆå›é¸æŠï¼ˆæœ€åˆã«èª­ã¿è¾¼ã¾ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼‰
            if (!this.selectedCharacter) {
              this.selectCharacter(characterId);
            }

            // CanvasResizeControllerã«SpineRendereråˆæœŸåŒ–å®Œäº†ã‚’é€šçŸ¥
            if (window.canvasResizeHandler) {
              this.log(`ğŸ“¡ ${characterId} åˆæœŸåŒ–å®Œäº†ã‚’CanvasResizeControllerã«é€šçŸ¥é–‹å§‹`);
              window.canvasResizeHandler.sendToIframe('spineRendererReady', {
                characterId: characterId
              });
              this.log(`ğŸ“¡ ${characterId} åˆæœŸåŒ–å®Œäº†ã‚’CanvasResizeControllerã«é€šçŸ¥å®Œäº†`);
            } else {
              this.log('âš ï¸ CanvasResizeHandlerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - iframeé€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—');
            }

            // ğŸ¯ ç›´æ¥å¾©å…ƒã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼šãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸å´ã§Spineè¨­å®šã‚’å¾©å…ƒ
            this.restoreSpineSettingsDirectly(characterId);

          } catch (error) {
            this.log(`âŒ ${characterId} èª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}`);
          }
        }

        // Purattokunèª­ã¿è¾¼ã¿
        async loadPurattokun() {
          return this.loadCharacter('purattokun');
        }

        // å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿
        async loadAllCharacters() {
          this.log("ğŸŒŸ å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿é–‹å§‹...");
          await this.loadPurattokun();
          await new Promise(resolve => setTimeout(resolve, 500)); // 0.5ç§’å¾…æ©Ÿ
          await this.loadNezumi();
          this.log("ğŸŒŸ å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­ã¿è¾¼ã¿å®Œäº†");
        }

        // Nezumièª­ã¿è¾¼ã¿ï¼ˆæ–°ã—ã„å€‹åˆ¥èª­ã¿è¾¼ã¿ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ï¼‰
        async loadNezumi() {
          return this.loadCharacter('nezumi');
        }

        // ğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠã‚·ã‚¹ãƒ†ãƒ 
        setupCharacterSelection(characterId) {
          const container = document.getElementById(`${characterId}-container`);
          if (!container) return;

          container.style.cursor = 'pointer';
          container.addEventListener('click', () => {
            this.selectCharacter(characterId);
          });
        }

        selectCharacter(characterId) {
          // æ—¢å­˜é¸æŠã‚’è§£é™¤
          if (this.selectedCharacter) {
            this.deselectCharacter(this.selectedCharacter);
          }

          this.selectedCharacter = characterId;
          
          // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
          const container = document.getElementById(`${characterId}-container`);
          container.style.borderColor = '#ff6b35';
          container.style.boxShadow = '0 4px 20px rgba(255, 107, 53, 0.4)';
          
          // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¶å¾¡ãƒ‘ãƒãƒ«æ›´æ–°
          this.updateCharacterControlPanel(characterId);
          
          // BBã‚’è¡¨ç¤º
          this.showCharacterBB(characterId);
          
          // CanvasResizeControllerã«é¸æŠã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é€šçŸ¥
          this.notifyCanvasResizeController(characterId);
          
          this.log(`ğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ: ${characterId}`);
        }

        deselectCharacter(characterId) {
          const container = document.getElementById(`${characterId}-container`);
          container.style.borderColor = 'rgba(255, 255, 255, 0.2)';
          container.style.boxShadow = '';
          
          // BBã‚’éè¡¨ç¤º
          this.hideCharacterBB(characterId);
        }

        updateCharacterControlPanel(characterId) {
          const controlsDiv = document.getElementById('character-controls');
          if (!controlsDiv) return;

          controlsDiv.innerHTML = `
            <div style="color: #ffd700; font-weight: bold; margin-bottom: 10px;">
              ğŸ¯ é¸æŠä¸­: ${characterId === 'purattokun' ? 'ğŸ± ã·ã‚‰ã£ã¨ãã‚“' : 'ğŸ­ ã­ãšã¿ã¡ã‚ƒã‚“'}
            </div>
            <button class="btn" onclick="window.multiCharacterSystem.playCharacterAnimation('${characterId}', 'taiki')">å¾…æ©Ÿã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</button>
            <button class="btn" onclick="window.multiCharacterSystem.playCharacterAnimation('${characterId}', 'kettei')">ã‚„ã‚‰ã‚Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</button>
            <button class="btn" onclick="window.multiCharacterSystem.toggleCharacterBB('${characterId}')">BBè¡¨ç¤ºåˆ‡æ›¿</button>
          `;
        }

        // ğŸ¯ BBç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
        async showCharacterBB(characterId) {
          const character = this.characters[characterId];
          if (!character || !character.loaded) return;

          try {
            // æ—¢å­˜BBãŒã‚ã‚Œã°å‰Šé™¤
            if (character.boundingBox) {
              character.boundingBox.cleanup();
            }

            // æ–°ã—ã„BBä½œæˆ
            character.boundingBox = new PureBoundingBox({
              targetElement: character.canvas,
              nodeId: `${characterId}-spine-bb-canvas`,
            });

            // BBå®Ÿè¡Œï¼ˆè¡¨ç¤ºï¼‰
            const result = await character.boundingBox.execute({ visible: true });
            
            if (result.success) {
              this.log(`âœ… ${characterId} BBä½œæˆå®Œäº†`);
            } else {
              this.log(`âŒ ${characterId} BBä½œæˆå¤±æ•—: ${result.error}`);
            }
          } catch (error) {
            this.log(`âŒ ${characterId} BBä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        hideCharacterBB(characterId) {
          const character = this.characters[characterId];
          if (character && character.boundingBox) {
            character.boundingBox.hide();
          }
        }

        toggleCharacterBB(characterId) {
          const character = this.characters[characterId];
          if (!character || !character.boundingBox) return;

          // BBçŠ¶æ…‹ç¢ºèªã—ã¦åˆ‡ã‚Šæ›¿ãˆ
          const state = character.boundingBox.getState();
          if (state.uiState.visible) {
            character.boundingBox.hide();
            this.log(`ğŸ” ${characterId} BBéè¡¨ç¤º`);
          } else {
            character.boundingBox.show();
            this.log(`ğŸ” ${characterId} BBè¡¨ç¤º`);
          }
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å€‹åˆ¥ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ
        playCharacterAnimation(characterId, animationName) {
          const character = this.characters[characterId];
          if (!character || !character.loaded) {
            this.log(`âš ï¸ ${characterId}ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“`);
            return;
          }

          try {
            character.renderer.playAnimation(animationName);
            this.log(`ğŸ¬ ${characterId}: ${animationName} ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ`);
          } catch (error) {
            this.log(`âŒ ${characterId} ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        playAnimation(animationName) {
          if (!this.nezumiLoaded) {
            this.log("âš ï¸ å…ˆã«Nezumiã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„");
            return;
          }

          try {
            this.spineRenderer.playAnimation(animationName);
            this.log(`ğŸ­ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ: ${animationName}`);
          } catch (error) {
            this.log(`âŒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        async createBoundingBox() {
          if (!this.nezumiLoaded) {
            this.log("âš ï¸ å…ˆã«Nezumiã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„");
            return;
          }

          this.log("ğŸ“¦ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½œæˆä¸­...");
          this.updateStatus("bbox-status", "ä½œæˆä¸­");

          try {
            // PureBoundingBoxä½œæˆ
            this.boundingBox = new window.PureBoundingBox({
              targetElement: this.canvas,
              nodeId: "purattokun-spine-bb-canvas",
            });

            // ğŸ¯ BBã¨Canvasçµ±åˆå‹•ä½œã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
            this.setupBBCanvasIntegration();

            // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹å®Ÿè¡Œ
            const result = await this.boundingBox.execute({
              visible: true,
              interactive: true,
              showHandles: true,
            });

            if (result.success) {
              this.bboxCreated = true;
              this.updateStatus("bbox-status", "ä½œæˆå®Œäº†");
              this.log("âœ… ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½œæˆå®Œäº†");
              this.log("ğŸ”— BB+Canvasçµ±åˆå‹•ä½œæ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–");
              this.log(
                `ğŸ“Š Bounds: x=${result.bounds.x}, y=${result.bounds.y}, w=${result.bounds.width}, h=${result.bounds.height}`
              );
            } else {
              this.log(`âŒ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½œæˆå¤±æ•—: ${result.error}`);
              this.updateStatus("bbox-status", "ä½œæˆå¤±æ•—");
            }
          } catch (error) {
            this.log(`âŒ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            this.updateStatus("bbox-status", "ã‚¨ãƒ©ãƒ¼");
          }
        }

        toggleBoundingBox() {
          if (!this.boundingBox) {
            this.log("âš ï¸ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“");
            return;
          }

          try {
            const state = this.boundingBox.getState();
            if (state.bounds && state.bounds.visible) {
              this.boundingBox.hide();
              this.log("ğŸ‘» ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹éè¡¨ç¤º");
            } else {
              this.boundingBox.show();
              this.log("ğŸ‘ï¸ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤º");
            }
          } catch (error) {
            this.log(`âŒ è¡¨ç¤ºåˆ‡æ›¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        testResize() {
          if (!this.boundingBox) {
            this.log("âš ï¸ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“");
            return;
          }

          this.log("ğŸ”§ ãƒªã‚µã‚¤ã‚ºãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...");

          try {
            // ãƒ†ã‚¹ãƒˆç”¨ã®ãƒªã‚µã‚¤ã‚ºå®Ÿè¡Œ
            const currentBounds = this.boundingBox.getBounds();
            const newWidth = currentBounds.width * 1.2;
            const newHeight = currentBounds.height * 1.2;

            this.boundingBox.resize(newWidth, newHeight);
            this.log(
              `âœ… ãƒªã‚µã‚¤ã‚ºãƒ†ã‚¹ãƒˆå®Œäº†: ${newWidth.toFixed(
                0
              )} x ${newHeight.toFixed(0)}`
            );
          } catch (error) {
            this.log(`âŒ ãƒªã‚µã‚¤ã‚ºãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        cleanupBoundingBox() {
          if (!this.boundingBox) {
            this.log("âš ï¸ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“");
            return;
          }

          try {
            this.boundingBox.cleanup();
            this.boundingBox = null;
            this.bboxCreated = false;
            this.updateStatus("bbox-status", "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†");
            this.log("ğŸ§¹ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†");
          } catch (error) {
            this.log(`âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        async fullIntegrationTest() {
          this.log("ğŸ§ª å®Œå…¨çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹");
          this.updateStatus("integration-status", "çµ±åˆãƒ†ã‚¹ãƒˆä¸­");

          try {
            // 1. ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼åˆæœŸåŒ–ç¢ºèª
            if (!this.rendererInitialized) {
              await this.initRenderer();
              await new Promise((resolve) => setTimeout(resolve, 1000));
            }

            // 2. Nezumièª­ã¿è¾¼ã¿ç¢ºèª
            if (!this.nezumiLoaded) {
              await this.loadNezumi();
              await new Promise((resolve) => setTimeout(resolve, 2000));
            }

            // 3. ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½œæˆç¢ºèª
            if (!this.bboxCreated) {
              await this.createBoundingBox();
              await new Promise((resolve) => setTimeout(resolve, 1000));
            }

            // 4. å‹•ä½œãƒ†ã‚¹ãƒˆ
            if (
              this.rendererInitialized &&
              this.nezumiLoaded &&
              this.bboxCreated
            ) {
              this.log("ğŸ¯ å‹•ä½œãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...");

              // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ
              this.playAnimation("yarare");
              await new Promise((resolve) => setTimeout(resolve, 2000));
              this.playAnimation("taiki");

              // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºãƒ†ã‚¹ãƒˆ
              this.toggleBoundingBox();
              await new Promise((resolve) => setTimeout(resolve, 1000));
              this.testResize();
              await new Promise((resolve) => setTimeout(resolve, 1000));
              this.toggleBoundingBox();

              this.integrationComplete = true;
              this.updateStatus("integration-status", "çµ±åˆãƒ†ã‚¹ãƒˆæˆåŠŸ");
              this.log("ğŸ‰ å®Œå…¨çµ±åˆãƒ†ã‚¹ãƒˆæˆåŠŸï¼å…¨æ©Ÿèƒ½æ­£å¸¸å‹•ä½œç¢ºèª");
            } else {
              this.log("âŒ çµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•— - ä¸€éƒ¨æ©Ÿèƒ½ãŒå‹•ä½œã—ã¦ã„ã¾ã›ã‚“");
              this.updateStatus("integration-status", "çµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•—");
            }
          } catch (error) {
            this.log(`âŒ çµ±åˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            this.updateStatus("integration-status", "ã‚¨ãƒ©ãƒ¼");
          }
        }

        async performanceTest() {
          this.log("âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹");

          const startTime = Date.now();

          try {
            // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
            if (this.spineRenderer) {
              const renderStart = Date.now();
              for (let i = 0; i < 10; i++) {
                this.playAnimation(i % 2 === 0 ? "taiki" : "yarare");
                await new Promise((resolve) => setTimeout(resolve, 100));
              }
              const renderTime = Date.now() - renderStart;
              this.log(
                `ğŸ“Š ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: ${renderTime}ms (10å›åˆ‡ã‚Šæ›¿ãˆ)`
              );
            }

            // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
            if (this.boundingBox) {
              const bboxStart = Date.now();
              for (let i = 0; i < 5; i++) {
                this.toggleBoundingBox();
                await new Promise((resolve) => setTimeout(resolve, 50));
              }
              const bboxTime = Date.now() - bboxStart;
              this.log(`ğŸ“Š BBãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: ${bboxTime}ms (5å›åˆ‡ã‚Šæ›¿ãˆ)`);
            }

            const totalTime = Date.now() - startTime;
            this.log(`âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Œäº†: ç·æ™‚é–“ ${totalTime}ms`);
          } catch (error) {
            this.log(`âŒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        resetAll() {
          this.log("ğŸ”„ å…¨ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œä¸­...");

          try {
            // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            if (this.boundingBox) {
              this.cleanupBoundingBox();
            }

            // ã‚¹ãƒ‘ã‚¤ãƒ³ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚¹ãƒˆãƒƒãƒ—
            if (this.spineRenderer) {
              this.spineRenderer.stop();
              this.spineRenderer = null;
            }

            // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            this.rendererInitialized = false;
            this.nezumiLoaded = false;
            this.bboxCreated = false;
            this.integrationComplete = false;

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            this.updateStatus("renderer-status", "ãƒªã‚»ãƒƒãƒˆå®Œäº†");
            this.updateStatus("nezumi-status", "å¾…æ©Ÿä¸­");
            this.updateStatus("bbox-status", "å¾…æ©Ÿä¸­");
            this.updateStatus("integration-status", "ãƒªã‚»ãƒƒãƒˆå®Œäº†");

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªã‚¢
            const ctx = this.canvas.getContext("2d");
            if (ctx) {
              ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }

            this.log("âœ… å…¨ãƒªã‚»ãƒƒãƒˆå®Œäº†");
          } catch (error) {
            this.log(`âŒ ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // ğŸ¯ Phase 1: ãƒ­ã‚°æ©Ÿèƒ½ã¯LogSystem.jsã«ç§»è¡Œæ¸ˆã¿
        
        /**
         * LogSystemçµŒç”±ã®ãƒ­ã‚°å‡ºåŠ› - æ—¢å­˜äº’æ›æ€§100%ä¿æŒ
         */
        log(message) {
          this.logSystem.log(message);
        }

        // ç°¡å˜ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãƒ¡ã‚½ãƒƒãƒ‰
        updateStatus(statusId, message) {
          const statusElement = document.getElementById(statusId);
          if (statusElement) {
            statusElement.textContent = message;
          }
        }

        // èª­ã¿è¾¼ã¿ç”»é¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        hideLoading() {
          const loadingScreen = document.getElementById("loading-screen");
          if (loadingScreen) {
            loadingScreen.style.display = "none";
          }
        }

        // CanvasResizeControllerã«é¸æŠã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¤‰æ›´ã‚’é€šçŸ¥
        notifyCanvasResizeController(characterId) {
          const character = this.characters[characterId];
          if (!character || !character.loaded || !character.renderer) {
            this.log(`âš ï¸ ${characterId} ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„ãŸã‚ã€CanvasResizeControlleré€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—`);
            return;
          }

          try {
            // é¸æŠã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®Canvasæƒ…å ±ã‚’å–å¾—
            const canvas = character.canvas;
            const renderer = character.renderer;
            
            // ğŸ¯ Canvasæƒ…å ±ã‚’UIå´ãŒç†è§£ã§ãã‚‹å½¢å¼ã§æº–å‚™ï¼ˆsimple-pin-test.htmlã¨çµ±ä¸€ï¼‰
            const canvasData = {
              // Canvasè§£åƒåº¦æƒ…å ±
              canvasWidth: canvas.width,
              canvasHeight: canvas.height,
              
              // Canvasè¡¨ç¤ºã‚µã‚¤ã‚ºæƒ…å ±
              displayWidth: parseInt(canvas.style.width) || canvas.width,
              displayHeight: parseInt(canvas.style.height) || canvas.height,
              
              // Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šæƒ…å ±
              scaleX: renderer.skeleton?.scaleX || 1.0,
              scaleY: renderer.skeleton?.scaleY || 1.0,
              x: renderer.skeleton?.x || 0,
              y: renderer.skeleton?.y || 0,
              
              // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±
              characterId: characterId,
              canvasId: canvas.id,
              
              // å–å¾—æ™‚åˆ»
              timestamp: Date.now()
            };

            this.log(`ğŸ“‹ ${characterId}ã®Canvasæƒ…å ±:`, 'info');
            this.log(`  è§£åƒåº¦: ${canvasData.canvasWidth}Ã—${canvasData.canvasHeight}px`);
            this.log(`  è¡¨ç¤ºã‚µã‚¤ã‚º: ${canvasData.displayWidth}Ã—${canvasData.displayHeight}px`);
            this.log(`  ã‚¹ã‚±ãƒ¼ãƒ«: X:${canvasData.scaleX}, Y:${canvasData.scaleY}`);
            this.log(`  ä½ç½®: X:${canvasData.x}, Y:${canvasData.y}`);

            // UIå´ãŒå—ä¿¡ã§ãã‚‹'updateCanvasData'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§é€ä¿¡
            if (window.canvasResizeHandler) {
              window.canvasResizeHandler.sendToIframe('updateCanvasData', canvasData);
              this.log(`ğŸ›ï¸ ${characterId}ã®Canvasæƒ…å ±ã‚’UIã«é€ä¿¡å®Œäº†`);
            } else {
              this.log('âš ï¸ CanvasResizeIframeHandlerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
            
          } catch (error) {
            this.log(`âŒ CanvasResizeControlleré€šçŸ¥ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // BBãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡ï¼ˆCanvasResizeControllerçµŒç”±ï¼‰
        sendBBFeedback(type) {
          if (window.canvasResizeHandler) {
            window.canvasResizeHandler.sendBBFeedback(type);
          }
        }

        // ğŸ¯ SpineSettingsPersistenceçµ±åˆç‰ˆï¼šãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸å´ã§Spineè¨­å®šã‚’å¾©å…ƒï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¥ï¼‰
        restoreSpineSettingsDirectly(characterId) {
          try {
            // SpineSettingsPersistenceã‹ã‚‰è¨­å®šã‚’å¾©å…ƒ
            const settings = this.settingsPersistence.restore(characterId);
            
            if (settings) {
              this.log(`ğŸ”„ ${characterId}ã®ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’ç›´æ¥å¾©å…ƒ: ${JSON.stringify(settings)}`);
              
              const character = this.characters[characterId];
              if (character && character.loaded && character.renderer && character.renderer.skeleton) {
                
                // ã‚¹ã‚±ãƒ¼ãƒ«ã®å¾©å…ƒ
                if (settings.scaleX !== undefined && settings.scaleY !== undefined) {
                  character.renderer.setTransform(null, null, settings.scaleX, settings.scaleY);
                  this.log(`ğŸ“ ${characterId} ã‚¹ã‚±ãƒ¼ãƒ«ç›´æ¥å¾©å…ƒ: X=${settings.scaleX}, Y=${settings.scaleY}`);
                }
                
                // ä½ç½®ã®å¾©å…ƒ
                if (settings.positionX !== undefined && settings.positionY !== undefined) {
                  character.renderer.setTransform(settings.positionX, settings.positionY, null, null);
                  this.log(`ğŸ“ ${characterId} ä½ç½®ç›´æ¥å¾©å…ƒ: X=${settings.positionX}, Y=${settings.positionY}`);
                }
                
                // Canvasè§£åƒåº¦ã®å¾©å…ƒ
                if (settings.canvasSize !== undefined && settings.canvasSize !== null) {
                  character.canvas.width = settings.canvasSize;
                  character.canvas.height = settings.canvasSize;
                  
                  // WebGLãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆæ›´æ–°
                  const gl = character.canvas.getContext('webgl');
                  if (gl) {
                    gl.viewport(0, 0, settings.canvasSize, settings.canvasSize);
                  }
                  this.log(`ğŸ“ ${characterId} Canvasè§£åƒåº¦ç›´æ¥å¾©å…ƒ: ${settings.canvasSize}x${settings.canvasSize}`);
                }
                
                this.log(`âœ… ${characterId} è¨­å®šç›´æ¥å¾©å…ƒå®Œäº†`);
                
              } else {
                this.log(`âš ï¸ ${characterId} Rendereræº–å‚™æœªå®Œäº† - å¾©å…ƒã‚¹ã‚­ãƒƒãƒ—`);
              }
            } else {
              this.log(`ğŸ“ ${characterId} ä¿å­˜ã•ã‚ŒãŸè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆSpineSettingsPersistenceã‹ã‚‰ï¼‰`);
            }
          } catch (error) {
            this.log(`âŒ ${characterId} ç›´æ¥å¾©å…ƒã‚¨ãƒ©ãƒ¼: ${error.message}`);
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæ—¢å­˜ã®localStorageæ–¹å¼ã§è©¦è¡Œ
            this.log(`ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæ—¢å­˜æ–¹å¼ã§å¾©å…ƒè©¦è¡Œ`);
            this.restoreSpineSettingsDirectlyLegacy(characterId);
          }
        }
        
        // ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼šæ—¢å­˜ã®localStorageæ–¹å¼ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
        restoreSpineSettingsDirectlyLegacy(characterId) {
          try {
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›ºæœ‰ã®ã‚­ãƒ¼ã‚’ç”Ÿæˆï¼ˆæ—¢å­˜å½¢å¼ï¼‰
            const pageId = window.location.pathname || 'default';
            const spineKey = `spineSettings-${pageId}-${characterId}`;
            
            const spineData = localStorage.getItem(spineKey);
            if (spineData) {
              const settings = JSON.parse(spineData);
              this.log(`ğŸ”„ ${characterId}ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾©å…ƒ: ${JSON.stringify(settings)}`);
              
              const character = this.characters[characterId];
              if (character && character.loaded && character.renderer && character.renderer.skeleton) {
                
                // ã‚¹ã‚±ãƒ¼ãƒ«ã®å¾©å…ƒ
                if (settings.scaleX !== undefined && settings.scaleY !== undefined) {
                  character.renderer.setTransform(null, null, settings.scaleX, settings.scaleY);
                  this.log(`ğŸ“ ${characterId} ã‚¹ã‚±ãƒ¼ãƒ«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾©å…ƒ: X=${settings.scaleX}, Y=${settings.scaleY}`);
                }
                
                // ä½ç½®ã®å¾©å…ƒ
                if (settings.positionX !== undefined && settings.positionY !== undefined) {
                  character.renderer.setTransform(settings.positionX, settings.positionY, null, null);
                  this.log(`ğŸ“ ${characterId} ä½ç½®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾©å…ƒ: X=${settings.positionX}, Y=${settings.positionY}`);
                }
                
                // Canvasè§£åƒåº¦ã®å¾©å…ƒ
                if (settings.canvasSize !== undefined) {
                  character.canvas.width = settings.canvasSize;
                  character.canvas.height = settings.canvasSize;
                  
                  // WebGLãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆæ›´æ–°
                  const gl = character.canvas.getContext('webgl');
                  if (gl) {
                    gl.viewport(0, 0, settings.canvasSize, settings.canvasSize);
                  }
                  this.log(`ğŸ“ ${characterId} Canvasè§£åƒåº¦ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾©å…ƒ: ${settings.canvasSize}x${settings.canvasSize}`);
                }
                
                this.log(`âœ… ${characterId} ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®šå¾©å…ƒå®Œäº†`);
                
              } else {
                this.log(`âš ï¸ ${characterId} Rendereræº–å‚™æœªå®Œäº† - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾©å…ƒã‚¹ã‚­ãƒƒãƒ—`);
              }
            } else {
              this.log(`ğŸ“ ${characterId} ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¿å­˜è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
            }
          } catch (error) {
            this.log(`âŒ ${characterId} ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾©å…ƒã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // Canvasè§£åƒåº¦ã¨ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿®æ­£ï¼ˆæ­ªã¿é˜²æ­¢ï¼‰
        fixCanvasAspectRatio(canvas) {
          try {
            // è¦ªã‚³ãƒ³ãƒ†ãƒŠã®ã‚µã‚¤ã‚ºã‚’å–å¾—
            const container = canvas.parentElement;
            const containerRect = container.getBoundingClientRect();
            const containerSize = Math.min(containerRect.width, containerRect.height);
            
            // Canvasè§£åƒåº¦ã‚’è¦ªã‚³ãƒ³ãƒ†ãƒŠã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦æ­£æ–¹å½¢ã«è¨­å®š
            canvas.width = containerSize;
            canvas.height = containerSize;
            
            // WebGLãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã‚‚æ›´æ–°
            const gl = canvas.getContext('webgl');
            if (gl) {
              gl.viewport(0, 0, containerSize, containerSize);
            }
            
            this.log(`ğŸ¯ Canvasè§£åƒåº¦ä¿®æ­£: ${containerSize}x${containerSize} (æ­ªã¿é˜²æ­¢)`);
          } catch (error) {
            this.log(`âŒ Canvasè§£åƒåº¦ä¿®æ­£ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®å‡¦ç†
        handleWindowResize() {
          Object.keys(this.characters).forEach(characterId => {
            const character = this.characters[characterId];
            if (character && character.loaded && character.canvas) {
              this.fixCanvasAspectRatio(character.canvas);
            }
          });
        }
        
        // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãä½ç½®ä¿å­˜ï¼ˆ500msé…å»¶ï¼‰
        debouncedSavePosition(positionX, positionY) {
          // å‰å›ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
          if (this.positionSaveTimer) {
            clearTimeout(this.positionSaveTimer);
          }
          
          // æ–°ã—ã„ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®š
          this.positionSaveTimer = setTimeout(() => {
            const integration = window.nezumiIntegration;
            if (integration && integration.selectedCharacter) {
              // CanvasResizeIframeHandlerã‹ã‚‰SpinePositioningã®savePositionSettingsã‚’å‘¼ã³å‡ºã—
              if (window.spinePositioning && window.spinePositioning.savePositionSettings) {
                window.spinePositioning.savePositionSettings(integration.selectedCharacter, positionX, positionY);
              } else {
                this.log('âš ï¸ SpinePositioning.savePositionSettingsãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              }
            }
          }, 500);
        }

        /**
         * LogSystemé«˜åº¦æ©Ÿèƒ½ã¸ã®ä¾¿åˆ©ãªã‚¢ã‚¯ã‚»ã‚µãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
         */
        warn(message) { this.logSystem.warn(message); }
        error(message) { this.logSystem.error(message); }
        success(message) { this.logSystem.success(message); }
        debug(message) { this.logSystem.debug(message); }

        /**
         * ãƒ­ã‚°ç®¡ç†ãƒ¡ã‚½ãƒƒãƒ‰
         */
        clearLog() { this.logSystem.clearLog(); }
        exportLogs() { return this.logSystem.exportLogsAsText(); }
        exportLogsJson() { return this.logSystem.exportLogsAsJson(); }
        getLogStats() { return this.logSystem.getStats(); }
        searchLogs(query) { return this.logSystem.searchLogs(query); }
        setLogLevel(level) { this.logSystem.setLogLevel(level); }
        showLogConfig() { this.logSystem.showConfig(); }

        // ğŸ¯ Phase 1: updateStatus(), hideLoading() ã¯UIController.jsã«ç§»è¡Œæ¸ˆã¿

        // ğŸ“ Canvas è§£åƒåº¦ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ï¼ˆæ­£æ–¹å½¢ï¼‰
        resizeCanvas() {
          try {
            const sizeInput = document.getElementById("canvas-size");
            const newSize = parseInt(sizeInput.value);

            if (!newSize || newSize < 100 || newSize > 1200) {
              this.log("âŒ ç„¡åŠ¹ãªã‚µã‚¤ã‚ºã§ã™ï¼ˆ100-1200pxï¼‰");
              return;
            }

            this.log(
              `ğŸ”„ Canvasè§£åƒåº¦ãƒªã‚µã‚¤ã‚ºé–‹å§‹: ${this.canvas.width}x${this.canvas.height} â†’ ${newSize}x${newSize}`
            );

            // Canvaså±æ€§ã‚’æ­£æ–¹å½¢ã«å¤‰æ›´
            this.canvas.width = newSize;
            this.canvas.height = newSize;

            // è¡¨ç¤ºã‚‚æ›´æ–°
            document.getElementById("canvas-size-display").textContent = `${newSize}x${newSize}`;

            this.log(
              `âœ… Canvasè§£åƒåº¦ãƒªã‚µã‚¤ã‚ºå®Œäº†: ${this.canvas.width}x${this.canvas.height}`
            );

            // WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã¯å†åˆæœŸåŒ–ãŒå¿…è¦
            if (this.spineRenderer && this.nezumiLoaded) {
              this.log("ğŸ”„ WebGLå†åˆæœŸåŒ–ãŒæ¨å¥¨ã•ã‚Œã¾ã™");

              // WebGLãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã‚‚æ›´æ–°
              const gl = this.canvas.getContext("webgl");
              if (gl) {
                gl.viewport(0, 0, newSize, newSize);
                this.log("âœ… WebGL ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆæ›´æ–°å®Œäº†");
              }
            }
          } catch (error) {
            this.log(`âŒ Canvasè§£åƒåº¦ãƒªã‚µã‚¤ã‚ºã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        resetCanvasSize() {
          try {
            const sizeInput = document.getElementById("canvas-size");

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µã‚¤ã‚ºã«æˆ»ã™
            sizeInput.value = 800;
            
            // è¡¨ç¤ºæ›´æ–°
            document.getElementById("canvas-size-display").textContent = "800x800";

            // ãƒªã‚µã‚¤ã‚ºå®Ÿè¡Œ
            this.resizeCanvas();

            this.log("âœ… Canvasè§£åƒåº¦ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ(800x800)ã«æˆ»ã—ã¾ã—ãŸ");
          } catch (error) {
            this.log(`âŒ Canvasè§£åƒåº¦ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // ğŸ¯ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  Canvas ã‚µã‚¤ã‚ºè¡¨ç¤ºæ›´æ–°
        updateCanvasSizeDisplay() {
          const sizeInput = document.getElementById("canvas-size");
          const displaySpan = document.getElementById("canvas-size-display");
          if (sizeInput && displaySpan) {
            const size = sizeInput.value;
            displaySpan.textContent = `${size}x${size}`;
          }
        }

        // ğŸ¯ è‡ªå‹•ã‚µã‚¤ã‚ºç®—å‡ºæ©Ÿèƒ½
        calculateOptimalCanvasSize() {
          try {
            if (!this.spineRenderer || !this.spineRenderer.skeleton) {
              this.log("âŒ Spine skeleton ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
              return null;
            }

            this.log("ğŸ” ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¢ƒç•Œæ¤œå‡ºé–‹å§‹...");

            // Spineã‚¹ã‚±ãƒ«ãƒˆãƒ³ã®å¢ƒç•Œå–å¾—
            const skeleton = this.spineRenderer.skeleton;

            // å¢ƒç•Œæƒ…å ±ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°
            const offset = new spine.Vector2();
            const size = new spine.Vector2();
            const temp = [];

            // Spineå…¬å¼API: getBounds
            skeleton.getBounds(offset, size, temp);

            // å¢ƒç•Œæƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
            this.log(`ğŸ“ æ¤œå‡ºã•ã‚ŒãŸå¢ƒç•Œ:`);
            this.log(
              `   ã‚ªãƒ•ã‚»ãƒƒãƒˆ: (${offset.x.toFixed(2)}, ${offset.y.toFixed(2)})`
            );
            this.log(`   ã‚µã‚¤ã‚º: ${size.x.toFixed(2)} x ${size.y.toFixed(2)}`);

            // æœ€é©Canvasã‚µã‚¤ã‚ºè¨ˆç®—ï¼ˆä½™ç™½20pxï¼‰
            const padding = 40; // ä½™ç™½
            const optimalWidth = Math.ceil(size.x) + padding;
            const optimalHeight = Math.ceil(size.y) + padding;

            const result = {
              detected: {
                offset: { x: offset.x, y: offset.y },
                size: { width: size.x, height: size.y },
              },
              optimal: {
                width: optimalWidth,
                height: optimalHeight,
              },
              reduction: {
                fromWidth: this.canvas.width,
                fromHeight: this.canvas.height,
                reductionRatio:
                  ((this.canvas.width * this.canvas.height -
                    optimalWidth * optimalHeight) /
                    (this.canvas.width * this.canvas.height)) *
                  100,
              },
            };

            this.log(`ğŸ¯ æœ€é©ã‚µã‚¤ã‚º: ${optimalWidth} x ${optimalHeight}`);
            this.log(
              `ğŸ“Š ã‚µã‚¤ã‚ºå‰Šæ¸›: ${result.reduction.reductionRatio.toFixed(1)}%`
            );

            return result;
          } catch (error) {
            this.log(`âŒ å¢ƒç•Œæ¤œå‡ºã‚¨ãƒ©ãƒ¼: ${error.message}`);
            console.error("å¢ƒç•Œæ¤œå‡ºã‚¨ãƒ©ãƒ¼:", error);
            return null;
          }
        }

        // ğŸ¯ è‡ªå‹•ã‚µã‚¤ã‚ºé©ç”¨æ©Ÿèƒ½ï¼ˆä¿®æ­£ç‰ˆï¼šCSSã‚µã‚¤ã‚ºå¤‰æ›´ï¼‰
        async applyOptimalCanvasSize() {
          try {
            const optimalSizeInfo = this.calculateOptimalCanvasSize();

            if (!optimalSizeInfo) {
              this.log("âŒ æœ€é©ã‚µã‚¤ã‚ºã®è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ");
              return;
            }

            const { width, height } = optimalSizeInfo.optimal;

            this.log("ğŸ”„ CSSè¡¨ç¤ºã‚µã‚¤ã‚ºã‚’å¤‰æ›´ä¸­...");

            // ğŸ†• é‡è¦: CSSè¡¨ç¤ºã‚µã‚¤ã‚ºã‚’å¤‰æ›´ï¼ˆã“ã‚ŒãŒå®Ÿéš›ã®è¦‹ãŸç›®ã‚’å¤‰ãˆã‚‹ï¼‰
            const container = document.querySelector(".canvas-container");
            container.style.width = width + "px";
            container.style.height = height + "px";

            this.log(`ğŸ“ ã‚³ãƒ³ãƒ†ãƒŠã‚µã‚¤ã‚ºå¤‰æ›´: ${width}x${height}`);

            // Canvaså†…éƒ¨è§£åƒåº¦ã‚‚åˆã‚ã›ã¦å¤‰æ›´
            this.canvas.width = width;
            this.canvas.height = height;

            // WebGLãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆæ›´æ–°
            if (this.spineRenderer && this.spineRenderer.gl) {
              this.spineRenderer.gl.viewport(0, 0, width, height);
              this.log("ğŸ”§ WebGLãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆæ›´æ–°å®Œäº†");
            }

            // UIå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚æ›´æ–°
            document.getElementById("canvas-width").value = width;
            document.getElementById("canvas-height").value = height;

            // ğŸ†• BBã‚µã‚¤ã‚ºã‚‚è‡ªå‹•æ›´æ–°
            if (this.boundingBox) {
              this.log("ğŸ“¦ BBå†ä½œæˆä¸­...");
              await this.cleanupBoundingBox();
              await new Promise((resolve) => setTimeout(resolve, 100));
              await this.createBoundingBox();
              this.log("âœ… æ–°ã—ã„ã‚µã‚¤ã‚ºã§BBä½œæˆå®Œäº†");
            }

            this.log(`âœ… æœ€é©è¡¨ç¤ºã‚µã‚¤ã‚ºé©ç”¨å®Œäº†: ${width}x${height}`);
            this.log(
              `ğŸ“ˆ è¡¨ç¤ºã‚µã‚¤ã‚ºå‰Šæ¸›åŠ¹æœ: ${optimalSizeInfo.reduction.reductionRatio.toFixed(
                1
              )}%`
            );
            this.log(`ğŸ¯ ç„¡é§„ãªç©ºç™½ã‚’é™¤å»ã—ã¾ã—ãŸ`);

            return optimalSizeInfo;
          } catch (error) {
            this.log(`âŒ æœ€é©ã‚µã‚¤ã‚ºé©ç”¨ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // ğŸ†• CSSè¡¨ç¤ºã‚µã‚¤ã‚ºå¤‰æ›´æ©Ÿèƒ½ï¼ˆä¿®æ­£ç‰ˆï¼šã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚µã‚¤ã‚ºä¿æŒï¼‰
        changeCanvasDisplaySize(width, height) {
          try {
            this.log(`ğŸ”„ Canvasè¡¨ç¤ºã‚µã‚¤ã‚ºå¤‰æ›´: ${width}x${height}`);

            // ã‚³ãƒ³ãƒ†ãƒŠã‚µã‚¤ã‚ºå¤‰æ›´
            const container = document.querySelector(".canvas-container");
            container.style.width = width + "px";
            container.style.height = height + "px";

            // ğŸ¯ é‡è¦: Canvaså†…éƒ¨è§£åƒåº¦ã¯é«˜è§£åƒåº¦ã§ç¶­æŒ
            const scale = Math.max(width / 800, height / 600, 0.5); // æœ€ä½0.5å€ã¾ã§
            const internalWidth = Math.max(width, 800 * scale);
            const internalHeight = Math.max(height, 600 * scale);

            this.log(
              `ğŸ“ å†…éƒ¨è§£åƒåº¦: ${internalWidth}x${internalHeight} (scale: ${scale.toFixed(
                2
              )})`
            );

            // Canvaså†…éƒ¨è§£åƒåº¦è¨­å®š
            this.canvas.width = internalWidth;
            this.canvas.height = internalHeight;

            // ğŸ¯ Canvas CSS ã‚µã‚¤ã‚ºã‚’æ˜ç¤ºçš„ã«è¨­å®šï¼ˆ100%ã§ã¯ãªãï¼‰
            this.canvas.style.width = width + "px";
            this.canvas.style.height = height + "px";

            // WebGLãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆæ›´æ–°
            if (this.spineRenderer && this.spineRenderer.gl) {
              this.spineRenderer.gl.viewport(
                0,
                0,
                internalWidth,
                internalHeight
              );
              this.log("ğŸ”§ WebGLãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆæ›´æ–°å®Œäº†");
            }

            // Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ä½ç½®èª¿æ•´ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
            if (this.spineRenderer && this.spineRenderer.skeleton) {
              // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä¸­å¤®ã«é…ç½®
              const centerX = internalWidth / 2;
              const centerY = internalHeight / 2;

              // æ—¢å­˜ã®transformå€¤ã‚’ä¿æŒã—ã¦ä½ç½®èª¿æ•´
              this.spineRenderer.skeleton.x = centerX;
              this.spineRenderer.skeleton.y = centerY;

              this.log(`ğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®èª¿æ•´: (${centerX}, ${centerY})`);
            }

            this.log(
              `âœ… è¡¨ç¤ºã‚µã‚¤ã‚ºå¤‰æ›´å®Œäº†: è¡¨ç¤º${width}x${height}, å†…éƒ¨${internalWidth}x${internalHeight}`
            );
          } catch (error) {
            this.log(`âŒ è¡¨ç¤ºã‚µã‚¤ã‚ºå¤‰æ›´ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // ğŸ†• ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚µã‚¤ã‚ºä¿æŒãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
        testCanvasSizeWithCharacterPreservation(displayWidth, displayHeight) {
          try {
            this.log(
              `ğŸ§ª ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚µã‚¤ã‚ºä¿æŒãƒ†ã‚¹ãƒˆ: ${displayWidth}x${displayHeight}`
            );

            // ç¾åœ¨ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ã‚’ä¿å­˜
            let characterScale = 1;
            let characterX = 400; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¸­å¤®
            let characterY = 300;

            if (this.spineRenderer && this.spineRenderer.skeleton) {
              characterScale = this.spineRenderer.skeleton.scaleX;
              characterX = this.spineRenderer.skeleton.x;
              characterY = this.spineRenderer.skeleton.y;
              this.log(
                `ğŸ“‹ ç¾åœ¨ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±: scale=${characterScale}, pos=(${characterX}, ${characterY})`
              );
            }

            // Canvasè¡¨ç¤ºã‚µã‚¤ã‚ºå¤‰æ›´
            this.changeCanvasDisplaySize(displayWidth, displayHeight);

            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã‚’å…ƒã«æˆ»ã™
            if (this.spineRenderer && this.spineRenderer.skeleton) {
              this.spineRenderer.skeleton.scaleX = characterScale;
              this.spineRenderer.skeleton.scaleY = characterScale;
              this.log(`ğŸ”„ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å¾©å…ƒ: ${characterScale}`);
            }
          } catch (error) {
            this.log(`âŒ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚µã‚¤ã‚ºä¿æŒãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // ğŸ¯ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ï¼ˆæ¯”ç‡ä¿æŒãƒ­ãƒƒã‚¯æ©Ÿèƒ½ä»˜ã + ã‚ªãƒ¬ãƒ³ã‚¸BBè¡¨ç¤ºï¼‰
        updateScaleRealtime(axis) {
          if (!this.spineRenderer || !this.spineRenderer.skeleton) {
            this.log('âš ï¸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
            return;
          }

          const scaleXInput = document.getElementById('character-scale-x');
          const scaleYInput = document.getElementById('character-scale-y');
          const scaleLock = document.getElementById('scale-lock');
          
          // ğŸ”’ æ¯”ç‡ä¿æŒãƒ­ãƒƒã‚¯æ©Ÿèƒ½
          if (scaleLock.checked) {
            // åˆå›ãƒ­ãƒƒã‚¯æ™‚ã¾ãŸã¯æ¯”ç‡ãŒæœªè¨˜éŒ²ã®å ´åˆã€ç¾åœ¨ã®æ¯”ç‡ã‚’è¨˜éŒ²
            if (!this.scaleRatio) {
              this.scaleRatio = parseFloat(scaleYInput.value) / parseFloat(scaleXInput.value);
              this.log(`ğŸ”’ æ¯”ç‡ãƒ­ãƒƒã‚¯é–‹å§‹: Y/X = ${this.scaleRatio.toFixed(3)}`);
            }
            
            if (axis === 'x') {
              // Xã‚’å¤‰æ›´ã—ãŸå ´åˆã€Yã‚’æ¯”ç‡ã«å¾“ã£ã¦è‡ªå‹•èª¿æ•´
              const newX = parseFloat(scaleXInput.value);
              const newY = newX * this.scaleRatio;
              scaleYInput.value = newY.toFixed(2);
              this.log(`ğŸ”„ æ¯”ç‡ä¿æŒ: X=${newX} â†’ Y=${newY.toFixed(2)} (æ¯”ç‡${this.scaleRatio.toFixed(3)})`);
            } else if (axis === 'y') {
              // Yã‚’å¤‰æ›´ã—ãŸå ´åˆã€Xã‚’æ¯”ç‡ã«å¾“ã£ã¦è‡ªå‹•èª¿æ•´
              const newY = parseFloat(scaleYInput.value);
              const newX = newY / this.scaleRatio;
              scaleXInput.value = newX.toFixed(2);
              this.log(`ğŸ”„ æ¯”ç‡ä¿æŒ: Y=${newY} â†’ X=${newX.toFixed(2)} (æ¯”ç‡${this.scaleRatio.toFixed(3)})`);
            }
          } else {
            // ãƒ­ãƒƒã‚¯è§£é™¤æ™‚ã¯æ¯”ç‡ã‚’ã‚¯ãƒªã‚¢
            this.scaleRatio = null;
          }

          const scaleXValue = parseFloat(scaleXInput.value);
          const scaleYValue = parseFloat(scaleYInput.value);
          
          try {
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é©ç”¨
            this.spineRenderer.setTransform(null, null, scaleXValue, scaleYValue);
            
            // è¡¨ç¤ºå€¤æ›´æ–°
            document.getElementById('scale-x-value').textContent = scaleXValue;
            document.getElementById('scale-y-value').textContent = scaleYValue;

            // ğŸ¨ ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ä¸­ã¯ã‚ªãƒ¬ãƒ³ã‚¸BBã‚’è¡¨ç¤ºï¼ˆè¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
            this.showCharacterAdjustmentBB();
            
          } catch (error) {
            this.log(`âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ã‚±ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        applyCharacterScale() {
          // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯¾å¿œã«ã‚ˆã‚Šã€ã“ã®é–¢æ•°ã¯åŸºæœ¬çš„ã«ä¸è¦
          // ãŸã ã—äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã™
          this.updateScaleRealtime();
        }

        resetCharacterScale() {
          document.getElementById('character-scale-x').value = '1.35';
          document.getElementById('character-scale-y').value = '1.0';
          document.getElementById('scale-x-value').textContent = '1.35';
          document.getElementById('scale-y-value').textContent = '1.0';
          this.applyCharacterScale();
          this.log('ğŸ”„ ã‚¹ã‚±ãƒ¼ãƒ«ã‚’ç†æƒ³çš„ãªæ¯”ç‡ã«æˆ»ã—ã¾ã—ãŸï¼ˆX=1.35, Y=1.0ï¼‰');
        }

        // ğŸ¯ è‡ªç„¶ãªæ¯”ç‡æ¤œå‡ºæ©Ÿèƒ½
        detectNaturalRatio() {
          if (!this.spineRenderer || !this.spineRenderer.skeleton) {
            this.log('âš ï¸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
            return;
          }

          // ã‚ˆãä½¿ã‚ã‚Œã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ¯”ç‡ã‚’è©¦ã™
          const commonRatios = [
            { x: 1.0, y: 1.3, name: 'ç¸¦é•·' },
            { x: 1.3, y: 1.0, name: 'æ¨ªé•·' },
            { x: 1.0, y: 1.2, name: 'å°‘ã—ç¸¦é•·' },
            { x: 1.2, y: 1.0, name: 'å°‘ã—æ¨ªé•·' },
            { x: 1.0, y: 1.0, name: 'æ­£æ–¹å½¢' }
          ];

          this.log('ğŸ” è‡ªç„¶ãªæ¯”ç‡ã‚’æ¤œå‡ºä¸­...');
          
          // æœ€åˆã®æ¯”ç‡ï¼ˆç¸¦é•·ï¼‰ã‚’è©¦ã™
          const ratio = commonRatios[0];
          document.getElementById('character-scale-x').value = ratio.x;
          document.getElementById('character-scale-y').value = ratio.y;
          document.getElementById('scale-x-value').textContent = ratio.x;
          document.getElementById('scale-y-value').textContent = ratio.y;
          
          this.applyCharacterScale();
          this.log(`ğŸ’¡ è©¦è¡Œ: ${ratio.name} (X=${ratio.x}, Y=${ratio.y}) - è‡ªç„¶ã«è¦‹ãˆã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„`);
          this.log('ğŸ¯ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§å¾®èª¿æ•´ã—ã¦æœ€é©ãªæ¯”ç‡ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„');
        }

        // ğŸ¯ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä½ç½®èª¿æ•´
        updatePositionRealtime(axis) {
          if (!this.spineRenderer || !this.spineRenderer.skeleton) {
            return; // ãƒ­ã‚°ãªã—ã§é™ã‹ã«çµ‚äº†ï¼ˆé »ç¹ã«å‘¼ã°ã‚Œã‚‹ãŸã‚ï¼‰
          }

          const xValue = parseInt(document.getElementById('character-x').value);
          const yValue = parseInt(document.getElementById('character-y').value);
          
          try {
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é©ç”¨
            this.spineRenderer.setTransform(xValue, yValue, null, null);
            
            // è¡¨ç¤ºå€¤æ›´æ–°
            document.getElementById('x-value').textContent = xValue;
            document.getElementById('y-value').textContent = yValue;

            // ğŸ¨ ä½ç½®èª¿æ•´ä¸­ã¯ã‚ªãƒ¬ãƒ³ã‚¸BBã‚’è¡¨ç¤ºï¼ˆè¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
            this.showCharacterAdjustmentBB();
            
            // ğŸ’¾ ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ã§ä½ç½®ä¿å­˜ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
            if (window.canvasResizeHandler) {
              window.canvasResizeHandler.debouncedSavePosition(xValue, yValue);
            }
            
          } catch (error) {
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªã®ã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯æ§ãˆã‚ã«
            console.warn('ä½ç½®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error.message);
          }
        }

        applyCharacterPosition() {
          // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯¾å¿œã«ã‚ˆã‚Šã€ã“ã®é–¢æ•°ã¯åŸºæœ¬çš„ã«ä¸è¦
          // ãŸã ã—äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã™
          this.updatePositionRealtime();
          
          // BBãŒä½œæˆã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å†ä½œæˆ
          if (this.boundingBox) {
            const xValue = parseInt(document.getElementById('character-x').value);
            const yValue = parseInt(document.getElementById('character-y').value);
            this.log(`âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®ç¢ºå®š: (${xValue}, ${yValue})`);
            
            this.log('ğŸ“¦ ä½ç½®å¤‰æ›´ã«ã‚ˆã‚ŠBBå†ä½œæˆä¸­...');
            setTimeout(async () => {
              await this.cleanupBoundingBox();
              await new Promise(resolve => setTimeout(resolve, 100));
              await this.createBoundingBox();
            }, 100);
          }
        }

        centerCharacter() {
          const canvasWidth = this.canvas ? this.canvas.width : 800;
          const canvasHeight = this.canvas ? this.canvas.height : 600;
          
          const centerX = canvasWidth / 2;
          const centerY = canvasHeight / 2;
          
          // UIã‚’æ›´æ–°
          document.getElementById('character-x').value = centerX;
          document.getElementById('character-y').value = centerY;
          document.getElementById('x-value').textContent = centerX;
          document.getElementById('y-value').textContent = centerY;
          
          // é©ç”¨
          this.applyCharacterPosition();
          this.log(`ğŸ“ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä¸­å¤®ã«é…ç½®: (${centerX}, ${centerY})`);
        }

        resetCharacterPosition() {
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã«æˆ»ã™
          document.getElementById('character-x').value = '100';
          document.getElementById('character-y').value = '-100';
          document.getElementById('x-value').textContent = '100';
          document.getElementById('y-value').textContent = '-100';
          
          this.applyCharacterPosition();
          this.log('ğŸ”„ ä½ç½®ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ');
        }

        // ğŸ¯ ç¾åœ¨ã®ä½ç½®ã‚’å–å¾—ã—ã¦UIã«åæ˜ ï¼ˆèª­ã¿è¾¼ã¿å¾Œã®åŒæœŸç”¨ï¼‰
        syncPositionUI() {
          if (this.spineRenderer && this.spineRenderer.skeleton) {
            const x = Math.round(this.spineRenderer.skeleton.x);
            const y = Math.round(this.spineRenderer.skeleton.y);
            const scaleX = this.spineRenderer.skeleton.scaleX;
            const scaleY = this.spineRenderer.skeleton.scaleY;
            
            // ğŸ¯ ç¾åœ¨ã®ã‚¹ã‚±ãƒ¼ãƒ«æ¯”ç‡ã‚’è©³ç´°ãƒ­ã‚°å‡ºåŠ›
            this.log(`ğŸ” ç¾åœ¨ã®ã‚¹ã‚±ãƒ¼ãƒ«è©³ç´°: scaleX=${scaleX}, scaleY=${scaleY}, æ¯”ç‡=${(scaleY/scaleX).toFixed(3)}`);
            
            // ã‚¹ã‚±ãƒ¼ãƒ«ãŒç•°ãªã‚‹å ´åˆã®å‡¦ç†ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèªï¼‰
            let scale = scaleX;
            // if (Math.abs(scaleX - scaleY) > 0.01) {
            //   this.spineRenderer.skeleton.scaleY = scaleX;
            //   this.log(`ğŸ”„ ã‚¹ã‚±ãƒ¼ãƒ«çµ±ä¸€: scaleY ${scaleY} â†’ ${scaleX} (ç­‰å€ç¶­æŒ)`);
            //   scale = scaleX;
            // }
            
            // UIåŒæœŸ
            document.getElementById('character-x').value = x;
            document.getElementById('character-y').value = y;
            document.getElementById('x-value').textContent = x;
            document.getElementById('y-value').textContent = y;
            document.getElementById('character-scale-x').value = scaleX;
            document.getElementById('character-scale-y').value = scaleY;
            document.getElementById('scale-x-value').textContent = scaleX;
            document.getElementById('scale-y-value').textContent = scaleY;
            
            this.log(`ğŸ”„ UIåŒæœŸå®Œäº†: ä½ç½®(${x}, ${y}), ç¾åœ¨ã‚¹ã‚±ãƒ¼ãƒ«${scale}`);
            
            // ğŸ¯ æ¨å¥¨ã‚¹ã‚±ãƒ¼ãƒ«æ¯”ç‡ã‚’ææ¡ˆ
            if (Math.abs(scaleX - scaleY) > 0.01) {
              const ratio = scaleY / scaleX;
              this.log(`ğŸ’¡ ã“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è‡ªç„¶ãªç¸¦æ¨ªæ¯”: Yè»¸ ${ratio.toFixed(2)}å€ ãŒã‚ªãƒªã‚¸ãƒŠãƒ«è¨­è¨ˆã‹ã‚‚ã—ã‚Œã¾ã›ã‚“`);
            }
          }
        }

        // ğŸ”— BBã¨Canvasçµ±åˆå‹•ä½œã‚·ã‚¹ãƒ†ãƒ 
        setupBBCanvasIntegration() {
          this.log("ğŸ”— BB+Canvasçµ±åˆå‹•ä½œã‚·ã‚¹ãƒ†ãƒ è¨­å®šä¸­...");
          
          // BBã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦çµ±åˆå‹•ä½œã‚’è¿½åŠ 
          const originalBounds = this.boundingBox.bounds;
          const originalEvents = this.boundingBox.events;
          
          // ğŸ¯ ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
          if (originalEvents && originalEvents.onPointerDown) {
            const originalPointerDown = originalEvents.onPointerDown.bind(originalEvents);
            originalEvents.onPointerDown = (event) => {
              this.log("ğŸ–±ï¸ BB+Canvasçµ±åˆãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹");
              this.bbDragStart = {
                canvasX: this.canvas.offsetLeft,
                canvasY: this.canvas.offsetTop,
                characterX: this.spineRenderer?.skeleton?.x || 0,
                characterY: this.spineRenderer?.skeleton?.y || 0,
              };
              return originalPointerDown(event);
            };
          }
          
          // ğŸ¯ ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•æ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
          if (originalEvents && originalEvents.onPointerMove) {
            const originalPointerMove = originalEvents.onPointerMove.bind(originalEvents);
            originalEvents.onPointerMove = (event) => {
              const result = originalPointerMove(event);
              
              // BBãŒç§»å‹•ã—ãŸå ´åˆã€Canvas+ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚‚ä¸€ç·’ã«ç§»å‹•
              if (originalEvents.isDragging && this.bbDragStart) {
                this.syncCanvasWithBB();
              }
              
              return result;
            };
          }
          
          // ğŸ¯ ãƒªã‚µã‚¤ã‚ºæ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆãƒãƒ³ãƒ‰ãƒ«æ“ä½œï¼‰
          if (originalBounds && originalBounds.resize) {
            const originalResize = originalBounds.resize.bind(originalBounds);
            originalBounds.resize = (newWidth, newHeight) => {
              this.log(`ğŸ”„ BB+Canvasçµ±åˆãƒªã‚µã‚¤ã‚º: ${newWidth}x${newHeight}`);
              
              // å…ƒã®ãƒªã‚µã‚¤ã‚ºå®Ÿè¡Œ
              const result = originalResize(newWidth, newHeight);
              
              // Canvasè¡¨ç¤ºã‚µã‚¤ã‚ºã‚‚é€£å‹•ã—ã¦å¤‰æ›´
              this.syncCanvasSizeWithBB(newWidth, newHeight);
              
              return result;
            };
          }
          
          this.log("âœ… BB+Canvasçµ±åˆå‹•ä½œã‚·ã‚¹ãƒ†ãƒ è¨­å®šå®Œäº†");
        }

        // ğŸ”— BBã®ç§»å‹•ã«Canvasã‚’åŒæœŸ
        syncCanvasWithBB() {
          if (!this.boundingBox || !this.spineRenderer) return;
          
          try {
            // BBã®ç¾åœ¨ä½ç½®ã‚’å–å¾—
            const bbBounds = this.boundingBox.getBounds();
            
            if (this.bbDragStart && bbBounds) {
              // ç§»å‹•é‡ã‚’è¨ˆç®—
              const deltaX = bbBounds.x - (this.bbDragStart.canvasX || 0);
              const deltaY = bbBounds.y - (this.bbDragStart.canvasY || 0);
              
              // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ä½ç½®ã‚‚åŒæœŸã—ã¦ç§»å‹•
              if (this.spineRenderer.skeleton) {
                const newCharacterX = this.bbDragStart.characterX + deltaX;
                const newCharacterY = this.bbDragStart.characterY + deltaY;
                
                this.spineRenderer.setTransform(newCharacterX, newCharacterY, null, null);
                this.syncPositionUI();
                
                this.log(`ğŸ”„ çµ±åˆç§»å‹•: BB(${bbBounds.x}, ${bbBounds.y}) â†’ ã‚­ãƒ£ãƒ©(${newCharacterX}, ${newCharacterY})`);
              }
            }
          } catch (error) {
            this.log(`âš ï¸ CanvasåŒæœŸã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // ğŸ”— BBã®ã‚µã‚¤ã‚ºå¤‰æ›´ã«Canvasã‚µã‚¤ã‚ºã‚’åŒæœŸ
        syncCanvasSizeWithBB(newWidth, newHeight) {
          try {
            this.log(`ğŸ”„ Canvasè¡¨ç¤ºã‚µã‚¤ã‚ºåŒæœŸ: ${newWidth}x${newHeight}`);
            
            // Canvasè¡¨ç¤ºã‚µã‚¤ã‚ºã‚’å¤‰æ›´ï¼ˆé«˜è§£åƒåº¦ä¿æŒï¼‰
            this.changeCanvasDisplaySize(newWidth, newHeight);
            
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã‚‚é€£å‹•èª¿æ•´ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            if (this.spineRenderer && this.spineRenderer.skeleton) {
              // BBã‚µã‚¤ã‚ºã®å¤‰åŒ–æ¯”ç‡ã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã‚’èª¿æ•´
              const scaleRatio = Math.min(newWidth / 300, newHeight / 300); // åŸºæº–ã‚µã‚¤ã‚º300pxã¨ä»®å®š
              const newScale = Math.max(0.5, Math.min(2.0, scaleRatio)); // 0.5-2.0å€ã«åˆ¶é™
              
              this.spineRenderer.setTransform(null, null, newScale, newScale);
              this.syncPositionUI();
              
              this.log(`ğŸ”„ çµ±åˆã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´: ${newScale.toFixed(2)}å€`);
            }
          } catch (error) {
            this.log(`âš ï¸ Canvas ã‚µã‚¤ã‚ºåŒæœŸã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // ğŸ¨ Canvasã®BBã‚’ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã§è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½
        async showCanvasResizeMode() {
          this.log("ğŸ¨ Canvasãƒªã‚µã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰BBè¡¨ç¤ºé–‹å§‹");
          
          // æ—¢å­˜ã®Canvasãƒªã‚µã‚¤ã‚ºBBãŒã‚ã‚Œã°å‰Šé™¤
          await this.hideCanvasResizeMode();
          
          try {
            // Canvasç”¨ã®ã‚ªãƒ¬ãƒ³ã‚¸è‰²BBã‚’ä½œæˆ
            this.canvasResizeBB = new window.PureBoundingBox({
              targetElement: this.canvas,
              nodeId: "canvas-resize-bb-orange",
            });

            // BBå®Ÿè¡Œï¼ˆã‚ªãƒ¬ãƒ³ã‚¸è‰²ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼‰
            const result = await this.canvasResizeBB.execute({
              visible: true,
              interactive: false, // Canvasæ“ä½œãƒ¢ãƒ¼ãƒ‰ãªã®ã§ç·¨é›†ä¸å¯
              showHandles: false, // ãƒãƒ³ãƒ‰ãƒ«éè¡¨ç¤º
            });

            if (result.success) {
              // BBã®è‰²ã‚’ã‚ªãƒ¬ãƒ³ã‚¸ã«å¤‰æ›´
              this.customizeCanvasBBColor();
              
              this.canvasResizeMode = true;
              this.log("âœ… Canvasã‚ªãƒ¬ãƒ³ã‚¸BBè¡¨ç¤ºå®Œäº†");
              
              // Canvasæƒ…å ±ã‚’ãƒ­ã‚°ã«è¡¨ç¤º
              const displaySize = `${document.querySelector('.canvas-container').offsetWidth}x${document.querySelector('.canvas-container').offsetHeight}`;
              const resolution = `${this.canvas.width}x${this.canvas.height}`;
              this.log(`ğŸ“Š Canvasæƒ…å ±: è¡¨ç¤º${displaySize} | è§£åƒåº¦${resolution}`);
              
            } else {
              this.log(`âŒ Canvasã‚ªãƒ¬ãƒ³ã‚¸BBä½œæˆå¤±æ•—: ${result.error}`);
            }
            
          } catch (error) {
            this.log(`âŒ Canvasã‚ªãƒ¬ãƒ³ã‚¸BBè¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        async hideCanvasResizeMode() {
          try {
            if (this.canvasResizeBB) {
              this.canvasResizeBB.cleanup();
              this.canvasResizeBB = null;
            }
            
            this.canvasResizeMode = false;
            this.log("ğŸ‘» Canvasã‚ªãƒ¬ãƒ³ã‚¸BBéè¡¨ç¤ºå®Œäº†");
            
          } catch (error) {
            this.log(`âŒ Canvasã‚ªãƒ¬ãƒ³ã‚¸BBéè¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // BBã‚’ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆå¼·åŒ–ç‰ˆï¼‰
        customizeCanvasBBColor() {
          try {
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰DOMãŒæ§‹ç¯‰ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤
            setTimeout(() => {
              // è¤‡æ•°ã®æ–¹æ³•ã§BBè¦ç´ ã‚’æ¢ã™
              let bbContainer = document.querySelector('[data-node-id="canvas-resize-bb-orange"]');
              
              if (!bbContainer) {
                // åˆ¥ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã§è©¦ã™
                bbContainer = document.querySelector('[id*="canvas-resize-bb"]');
              }
              
              if (!bbContainer) {
                // PureBoundingBoxã®ä¸€èˆ¬çš„ãªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã§è©¦ã™
                const allBBs = document.querySelectorAll('[class*="bounding"], [class*="bb-"], [data-node-id]');
                bbContainer = Array.from(allBBs).find(el => 
                  el.getAttribute('data-node-id') === 'canvas-resize-bb-orange' ||
                  (el.id && el.id.includes('canvas-resize-bb'))
                );
              }
              
              if (bbContainer) {
                this.log(`ğŸ¯ Canvas BBè¦ç´ ç™ºè¦‹: ${bbContainer.tagName}.${bbContainer.className}`);
                
                // ğŸ¨ å¼·åˆ¶çš„ã«ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã‚’é©ç”¨ï¼ˆCanvasæ“ä½œç”¨ï¼‰
                bbContainer.style.cssText += `
                  border: 3px solid #FF6B35 !important;
                  background-color: rgba(255, 107, 53, 0.1) !important;
                  box-shadow: 0 0 15px rgba(255, 107, 53, 0.4) !important;
                `;
                
                // ğŸš« ãƒãƒ³ãƒ‰ãƒ«ã‚’å®Œå…¨ã«å‰Šé™¤
                const handles = bbContainer.querySelectorAll('[class*="handle"], [class*="resize"], [style*="cursor"], .handle, .resize-handle');
                handles.forEach(handle => {
                  handle.style.display = 'none !important';
                  handle.remove(); // å®Œå…¨ã«å‰Šé™¤
                });
                
                // å­è¦ç´ ã‚‚å…¨ã¦ã‚ªãƒ¬ãƒ³ã‚¸ã«å¼·åˆ¶å¤‰æ›´ã¨ãƒãƒ³ãƒ‰ãƒ«å‰Šé™¤
                const allChildren = bbContainer.querySelectorAll('*');
                allChildren.forEach(child => {
                  // ãƒãƒ³ãƒ‰ãƒ«é–¢é€£ã‚¯ãƒ©ã‚¹åãƒ»ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
                  const isHandle = child.className && (
                    child.className.includes('handle') || 
                    child.className.includes('resize') ||
                    child.className.includes('corner') ||
                    child.className.includes('edge')
                  );
                  
                  const hasHandleCursor = child.style.cursor && (
                    child.style.cursor.includes('resize') ||
                    child.style.cursor === 'pointer' ||
                    child.style.cursor === 'move'
                  );
                  
                  if (isHandle || hasHandleCursor) {
                    child.style.display = 'none !important';
                    child.remove();
                    return;
                  }
                  
                  // ãã®ä»–ã®è¦ç´ ã¯ã‚ªãƒ¬ãƒ³ã‚¸ã«å¼·åˆ¶å¤‰æ›´
                  if (child.style.borderColor || child.style.border || child.tagName === 'DIV') {
                    child.style.borderColor = '#FF6B35 !important';
                  }
                  if (child.style.backgroundColor || child.tagName === 'DIV') {
                    child.style.backgroundColor = 'rgba(255, 107, 53, 0.1) !important';
                  }
                });
                
                // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–ï¼ˆç·¨é›†ã§ããªã„ã‚ˆã†ã«ï¼‰
                bbContainer.style.pointerEvents = 'none !important';
                
                this.log("âœ… Canvas BBã‚ªãƒ¬ãƒ³ã‚¸è‰²ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼†ãƒãƒ³ãƒ‰ãƒ«å®Œå…¨å‰Šé™¤å®Œäº†");
              } else {
                this.log("âš ï¸ Canvas BBè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šç¾åœ¨ã®DOMçŠ¶æ³ã‚’ãƒ­ã‚°å‡ºåŠ›
                const allElements = document.querySelectorAll('[data-node-id], [class*="bound"], [id*="bb"]');
                this.log(`ğŸ” BBé–¢é€£è¦ç´ æ•°: ${allElements.length}`);
                allElements.forEach(el => {
                  this.log(`  - ${el.tagName}.${el.className} [${el.getAttribute('data-node-id') || el.id}]`);
                });
              }
            }, 100); // 100mså¾…æ©Ÿã§DOMæ§‹ç¯‰ã‚’ç¢ºå®Ÿã«ã™ã‚‹
            
          } catch (error) {
            this.log(`âŒ Canvas BBè‰²å¤‰æ›´ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // ğŸ¨ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¿æ•´æ™‚ã®ã‚ªãƒ¬ãƒ³ã‚¸BBè¡¨ç¤ºæ©Ÿèƒ½
        async showCharacterAdjustmentBB() {
          // æ—¢ã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¿æ•´BBãŒè¡¨ç¤ºä¸­ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆé »ç¹ãªå‘¼ã³å‡ºã—å¯¾ç­–ï¼‰
          if (this.characterAdjustmentBBActive) {
            return;
          }

          try {
            // Canvasè¦ç´ ã‚’å¯¾è±¡ã«ã—ãŸã‚ªãƒ¬ãƒ³ã‚¸BBï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®ã®è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
            this.characterAdjustmentBB = new window.PureBoundingBox({
              targetElement: this.canvas,
              nodeId: "character-adjustment-bb-orange",
            });

            // BBå®Ÿè¡Œï¼ˆã‚ªãƒ¬ãƒ³ã‚¸è‰²ãƒ»ãƒãƒ³ãƒ‰ãƒ«ãªã—ãƒ»éã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ï¼‰
            const result = await this.characterAdjustmentBB.execute({
              visible: true,
              interactive: false, // ç·¨é›†ä¸å¯
              showHandles: false, // ãƒãƒ³ãƒ‰ãƒ«éè¡¨ç¤º
            });

            if (result.success) {
              this.characterAdjustmentBBActive = true;

              // BBã®è‰²ã‚’ã‚ªãƒ¬ãƒ³ã‚¸ã«å¤‰æ›´ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¿æ•´ç”¨ï¼‰
              setTimeout(() => {
                this.customizeCharacterAdjustmentBBColor();
              }, 50);

              // 2ç§’å¾Œã«è‡ªå‹•éè¡¨ç¤ºï¼ˆæ“ä½œã®é‚ªé­”ã«ãªã‚‰ãªã„ã‚ˆã†ã«ï¼‰
              clearTimeout(this.characterAdjustmentTimeout);
              this.characterAdjustmentTimeout = setTimeout(async () => {
                await this.hideCharacterAdjustmentBB();
              }, 2000);

              this.log("âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¿æ•´ç”¨ã‚ªãƒ¬ãƒ³ã‚¸BBè¡¨ç¤º");
            } else {
              this.log(`âŒ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¿æ•´BBä½œæˆå¤±æ•—: ${result.error}`);
            }

          } catch (error) {
            this.log(`âŒ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¿æ•´BBè¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        async hideCharacterAdjustmentBB() {
          try {
            if (this.characterAdjustmentBB) {
              this.characterAdjustmentBB.cleanup();
              this.characterAdjustmentBB = null;
            }
            
            this.characterAdjustmentBBActive = false;
            clearTimeout(this.characterAdjustmentTimeout);
            
          } catch (error) {
            this.log(`âŒ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¿æ•´BBéè¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¿æ•´ç”¨BBã‚’ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
        customizeCharacterAdjustmentBBColor() {
          try {
            // è¤‡æ•°ã®æ–¹æ³•ã§BBè¦ç´ ã‚’æ¢ã™
            let bbContainer = document.querySelector('[data-node-id="character-adjustment-bb-orange"]');
            
            if (!bbContainer) {
              // åˆ¥ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã§è©¦ã™
              bbContainer = document.querySelector('[id*="character-adjustment-bb"]');
            }
            
            if (!bbContainer) {
              // PureBoundingBoxã®ä¸€èˆ¬çš„ãªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã§è©¦ã™
              const allBBs = document.querySelectorAll('[class*="bounding"], [class*="bb-"], [data-node-id]');
              bbContainer = Array.from(allBBs).find(el => 
                el.getAttribute('data-node-id') === 'character-adjustment-bb-orange' ||
                (el.id && el.id.includes('character-adjustment-bb'))
              );
            }
            
            if (bbContainer) {
              this.log(`ğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¿æ•´BBè¦ç´ ç™ºè¦‹: ${bbContainer.tagName}.${bbContainer.className}`);
              
              // ğŸ¨ å¼·åˆ¶çš„ã«ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã‚’é©ç”¨ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¿æ•´ç”¨ï¼‰
              bbContainer.style.cssText += `
                border: 2px solid #FF6B35 !important;
                background-color: rgba(255, 107, 53, 0.15) !important;
                box-shadow: 0 0 10px rgba(255, 107, 53, 0.3) !important;
              `;
              
              // ğŸš« ãƒãƒ³ãƒ‰ãƒ«ã‚’å®Œå…¨ã«å‰Šé™¤
              const handles = bbContainer.querySelectorAll('[class*="handle"], [class*="resize"], [style*="cursor"]');
              handles.forEach(handle => {
                handle.style.display = 'none';
                handle.remove();
              });
              
              // å­è¦ç´ ã®ãƒãƒ³ãƒ‰ãƒ«ãƒ»ãƒªã‚µã‚¤ã‚¶ãƒ¼ã‚‚å‰Šé™¤
              const allChildren = bbContainer.querySelectorAll('*');
              allChildren.forEach(child => {
                if (child.className && (
                  child.className.includes('handle') || 
                  child.className.includes('resize') ||
                  child.style.cursor === 'pointer' ||
                  child.style.cursor === 'move'
                )) {
                  child.remove();
                  return;
                }
                
                // ãã®ä»–ã®è¦ç´ ã¯è–„ã„ã‚ªãƒ¬ãƒ³ã‚¸ã«
                if (child.style.borderColor || child.style.border) {
                  child.style.borderColor = '#FF6B35';
                }
              });
              
              // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–ï¼ˆç·¨é›†ã§ããªã„ã‚ˆã†ã«ï¼‰
              bbContainer.style.pointerEvents = 'none';
              
              this.log("âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¿æ•´BBã‚ªãƒ¬ãƒ³ã‚¸è‰²ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå®Œäº†");
            } else {
              this.log("âš ï¸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¿æ•´BBè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            }
            
          } catch (error) {
            this.log(`âŒ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¿æ•´BBè‰²å¤‰æ›´ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // Canvasæ“ä½œé–¢é€£ãƒœã‚¿ãƒ³ã«ãƒªã‚µã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºæ©Ÿèƒ½ã‚’çµ±åˆ
        enhanceCanvasButtons() {
          const canvasButtons = [
            'resize-canvas',
            'reset-canvas', 
            'detect-bounds',
            'apply-optimal',
            'test-medium'
          ];
          
          canvasButtons.forEach(buttonId => {
            const button = document.getElementById(buttonId);
            if (button) {
              // æ—¢å­˜ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿æŒ
              const originalOnClick = button.onclick;
              
              button.onclick = async () => {
                // Canvasã‚ªãƒ¬ãƒ³ã‚¸BBè¡¨ç¤º
                await this.showCanvasResizeMode();
                
                // å…ƒã®æ©Ÿèƒ½å®Ÿè¡Œ
                if (originalOnClick) {
                  originalOnClick.call(this);
                }
                
                // 3ç§’å¾Œã«è‡ªå‹•éè¡¨ç¤ºï¼ˆæ“ä½œã®é‚ªé­”ã«ãªã‚‰ãªã„ã‚ˆã†ã«ï¼‰
                setTimeout(async () => {
                  await this.hideCanvasResizeMode();
                }, 3000);
              };
            }
          });
          
          this.log("ğŸ”§ Canvasæ“ä½œãƒœã‚¿ãƒ³ã«ã‚ªãƒ¬ãƒ³ã‚¸BBè¡¨ç¤ºæ©Ÿèƒ½ã‚’çµ±åˆ");
        }
      }

      // ğŸ¯ ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°å®šç¾©ï¼ˆHTML inlineã‹ã‚‰å‘¼ã³å‡ºã—ç”¨ï¼‰
      window.updateScaleRealtime = function(axis) {
        if (window.nezumiIntegration) {
          window.nezumiIntegration.updateScaleRealtime(axis);
        }
      };

      window.updatePositionRealtime = function(axis) {
        if (window.nezumiIntegration) {
          window.nezumiIntegration.updatePositionRealtime(axis);
        }
      };

      // ğŸ›ï¸ CanvasResizeController iframe é€šä¿¡ã‚·ã‚¹ãƒ†ãƒ 
      class CanvasResizeIframeHandler {
        constructor() {
          this.iframe = null;
          this.iframeLoaded = false;
          this.messageQueue = []; // å¾…æ©Ÿä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚­ãƒ¥ãƒ¼
          this.positionSaveTimer = null; // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ç”¨ã‚¿ã‚¤ãƒãƒ¼
          this.setupIframeCommunication();
        }

        setupIframeCommunication() {
          // iframeèª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…æ©Ÿ
          window.addEventListener('load', () => {
            this.iframe = document.getElementById('canvas-resize-iframe');
            if (this.iframe) {
              this.iframe.onload = () => {
                this.iframeLoaded = true;
                this.log('ğŸ›ï¸ CanvasResizeController iframe èª­ã¿è¾¼ã¿å®Œäº†');
                this.log(`ğŸ“‹ å¾…æ©Ÿä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†é–‹å§‹ - ã‚­ãƒ¥ãƒ¼ã‚µã‚¤ã‚º: ${this.messageQueue.length}`);
                this.processQueuedMessages();
              };
              
              // ğŸ”§ å³åº§ã«iframeèª­ã¿è¾¼ã¿çŠ¶æ…‹ã‚’ç¢ºèªï¼ˆæ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ã®å ´åˆã¸ã®å¯¾å¿œï¼‰
              if (this.iframe.contentDocument && this.iframe.contentDocument.readyState === 'complete') {
                this.log('ğŸ›ï¸ iframeæ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ - å³åº§ã«åˆæœŸåŒ–');
                this.iframeLoaded = true;
                this.processQueuedMessages();
              } else {
                // ğŸ”§ å®šæœŸçš„ã«èª­ã¿è¾¼ã¿çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                let checkCount = 0;
                const checkIframeReady = () => {
                  checkCount++;
                  try {
                    if (this.iframe.contentDocument && this.iframe.contentDocument.readyState === 'complete') {
                      this.log(`ğŸ›ï¸ iframeèª­ã¿è¾¼ã¿æ¤œå‡ºï¼ˆ${checkCount}å›ç›®ãƒã‚§ãƒƒã‚¯ï¼‰`);
                      this.iframeLoaded = true;
                      this.processQueuedMessages();
                      return;
                    }
                  } catch (error) {
                    // CORSç­‰ã§contentDocumentã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„å ´åˆã‚‚ã‚ã‚‹
                  }
                  
                  if (checkCount < 20) { // æœ€å¤§10ç§’é–“ãƒã‚§ãƒƒã‚¯ï¼ˆ500msé–“éš”ï¼‰
                    setTimeout(checkIframeReady, 500);
                  } else {
                    this.log('âš ï¸ iframeèª­ã¿è¾¼ã¿ç¢ºèªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - å¼·åˆ¶å‡¦ç†å®Ÿè¡Œ');
                    this.iframeLoaded = true;
                    this.processQueuedMessages();
                  }
                };
                setTimeout(checkIframeReady, 500);
              }
            }
          });

          // postMessageå—ä¿¡ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
          window.addEventListener('message', (event) => {
            this.handleIframeMessage(event);
          });
        }

        handleIframeMessage(event) {
          // iframe ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œè¨¼
          if (!this.iframe || event.source !== this.iframe.contentWindow) {
            return;
          }

          const { type, data } = event.data;
          
          if (!window.nezumiIntegration) {
            console.warn('âš ï¸ NezumiIntegration not ready');
            return;
          }

          this.log(`ğŸ“¨ iframe ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡: ${type}`);

          switch (type) {
            // Canvasè§£åƒåº¦åˆ¶å¾¡
            case 'canvasResize':
              this.handleCanvasResize(data);
              break;
            case 'canvasReset':
              this.handleCanvasReset();
              break;

            // ã‚¹ã‚±ãƒ¼ãƒ«åˆ¶å¾¡
            case 'scaleChanged':
              this.handleScaleChange(data);
              break;
            case 'scaleReset':
              this.handleScaleReset(data);
              break;
            // naturalRatioDetectæ©Ÿèƒ½ã¯å‰Šé™¤æ¸ˆã¿

            // ä½ç½®åˆ¶å¾¡
            case 'positionChanged':
              this.handlePositionChange(data);
              break;
            // positionResetæ©Ÿèƒ½ã¯å‰Šé™¤æ¸ˆã¿ï¼ˆcenterCharacterã¨é‡è¤‡ã®ãŸã‚ï¼‰
            case 'centerCharacter':
              this.handleCenterCharacter(data);
              break;

            // å‰Šé™¤æ¸ˆã¿æ©Ÿèƒ½: detectBounds, applyOptimal, testMedium, debugInfo, clearLog

            // UIçŠ¶æ…‹ç®¡ç†
            case 'uiReady':
              this.handleUIReady(data);
              break;
            case 'uiLog':
              this.handleUILog(data);
              break;

            default:
              this.log(`â“ æœªçŸ¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—: ${type}`);
              break;
          }
        }

        // Canvasè§£åƒåº¦åˆ¶å¾¡ï¼ˆè¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯¾å¿œ + SpineSettingsPersistenceçµ±åˆï¼‰
        handleCanvasResize(data) {
          const integration = window.nezumiIntegration;
          if (!integration || !integration.selectedCharacter) {
            this.log('âš ï¸ é¸æŠã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
          }

          const character = integration.characters[integration.selectedCharacter];
          if (character && character.loaded && character.renderer) {
            // é¸æŠã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®Canvasè§£åƒåº¦å¤‰æ›´ã‚’å®Ÿè¡Œ
            character.canvas.width = data.size;
            character.canvas.height = data.size;
            
            // WebGLãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆæ›´æ–°
            const gl = character.canvas.getContext('webgl');
            if (gl) {
              gl.viewport(0, 0, data.size, data.size);
            }
            
            // ğŸ’¾ SpineSettingsPersistenceã§è¨­å®šä¿å­˜
            this.saveCanvasSettings(integration.selectedCharacter, data.size);
            
            this.log(`âœ… ${integration.selectedCharacter} Canvasè§£åƒåº¦å¤‰æ›´å®Œäº†: ${data.size}x${data.size}`);
          } else {
            this.log('âš ï¸ é¸æŠã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
          }
        }

        handleCanvasReset() {
          this.handleCanvasResize({ size: 800 });
          this.log('ğŸ”„ Canvasè§£åƒåº¦ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆ');
        }

        // ã‚¹ã‚±ãƒ¼ãƒ«åˆ¶å¾¡ï¼ˆè¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯¾å¿œ + SpineSettingsPersistenceçµ±åˆï¼‰
        handleScaleChange(data) {
          const integration = window.nezumiIntegration;
          if (!integration || !integration.selectedCharacter) {
            this.log('âš ï¸ é¸æŠã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
          }

          const character = integration.characters[integration.selectedCharacter];
          if (character && character.loaded && character.renderer && character.renderer.skeleton) {
            character.renderer.setTransform(null, null, data.scaleX, data.scaleY);
            
            // BBãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ä¿¡
            integration.sendBBFeedback('scale');
            
            // ğŸ’¾ SpineSettingsPersistenceã§ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®šä¿å­˜
            this.saveScaleSettings(integration.selectedCharacter, data.scaleX, data.scaleY);
            
            this.log(`ğŸ“ ${integration.selectedCharacter} ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´: X=${data.scaleX}, Y=${data.scaleY}`);
          } else {
            this.log('âš ï¸ é¸æŠã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
          }
        }

        handleScaleReset(data) {
          this.handleScaleChange(data);
          this.log('ğŸ”„ ã‚¹ã‚±ãƒ¼ãƒ«ã‚’ç†æƒ³æ¯”ç‡ã«ãƒªã‚»ãƒƒãƒˆ');
        }

        // handleNaturalRatioæ©Ÿèƒ½ã¯å‰Šé™¤æ¸ˆã¿
        
        // ğŸ¯ SpineSettingsPersistenceçµ±åˆä¿å­˜ãƒ¡ã‚½ãƒƒãƒ‰
        
        // Canvasè§£åƒåº¦è¨­å®šã‚’ä¿å­˜
        saveCanvasSettings(characterId, canvasSize) {
          try {
            const integration = window.nezumiIntegration;
            if (!integration || !integration.settingsPersistence) {
              this.log('âŒ SpineSettingsPersistenceãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
              return;
            }
            
            // ç¾åœ¨ã®è¨­å®šã‚’å–å¾—
            const existingSettings = integration.settingsPersistence.restore(characterId) || {};
            
            // Canvasè§£åƒåº¦ã‚’æ›´æ–°
            const updatedSettings = {
              ...existingSettings,
              canvasSize: canvasSize
            };
            
            // ä¿å­˜å®Ÿè¡Œ
            const success = integration.settingsPersistence.save(characterId, updatedSettings);
            if (success) {
              this.log(`ğŸ’¾ ${characterId} Canvasè¨­å®šä¿å­˜æˆåŠŸ: ${canvasSize}x${canvasSize}`);
            } else {
              this.log(`âŒ ${characterId} Canvasè¨­å®šä¿å­˜å¤±æ•—`);
            }
          } catch (error) {
            this.log(`âŒ Canvasè¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }
        
        // ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®šã‚’ä¿å­˜
        saveScaleSettings(characterId, scaleX, scaleY) {
          try {
            const integration = window.nezumiIntegration;
            if (!integration || !integration.settingsPersistence) {
              this.log('âŒ SpineSettingsPersistenceãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
              return;
            }
            
            // ç¾åœ¨ã®è¨­å®šã‚’å–å¾—
            const existingSettings = integration.settingsPersistence.restore(characterId) || {};
            
            // ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®šã‚’æ›´æ–°
            const updatedSettings = {
              ...existingSettings,
              scaleX: scaleX,
              scaleY: scaleY
            };
            
            // ä¿å­˜å®Ÿè¡Œ
            const success = integration.settingsPersistence.save(characterId, updatedSettings);
            if (success) {
              this.log(`ğŸ’¾ ${characterId} ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®šä¿å­˜æˆåŠŸ: X=${scaleX}, Y=${scaleY}`);
            } else {
              this.log(`âŒ ${characterId} ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®šä¿å­˜å¤±æ•—`);
            }
          } catch (error) {
            this.log(`âŒ ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // ä½ç½®è¨­å®šã‚’ä¿å­˜
        savePositionSettings(characterId, positionX, positionY) {
          try {
            const integration = window.nezumiIntegration;
            if (!integration || !integration.settingsPersistence) {
              this.log('âŒ SpineSettingsPersistenceãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
              return;
            }
            
            // ç¾åœ¨ã®è¨­å®šã‚’å–å¾—
            const existingSettings = integration.settingsPersistence.restore(characterId) || {};
            
            // ä½ç½®è¨­å®šã‚’æ›´æ–°
            const updatedSettings = {
              ...existingSettings,
              positionX: positionX,
              positionY: positionY
            };
            
            // ä¿å­˜å®Ÿè¡Œ
            const success = integration.settingsPersistence.save(characterId, updatedSettings);
            if (success) {
              this.log(`ğŸ’¾ ${characterId} ä½ç½®è¨­å®šä¿å­˜æˆåŠŸ: X=${positionX}, Y=${positionY}`);
            } else {
              this.log(`âŒ ${characterId} ä½ç½®è¨­å®šä¿å­˜å¤±æ•—`);
            }
          } catch (error) {
            this.log(`âŒ ä½ç½®è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // ä½ç½®åˆ¶å¾¡ï¼ˆè¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯¾å¿œï¼‰
        handlePositionChange(data) {
          const integration = window.nezumiIntegration;
          if (!integration || !integration.selectedCharacter) {
            this.log('âš ï¸ é¸æŠã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
          }

          const character = integration.characters[integration.selectedCharacter];
          if (character && character.loaded && character.renderer && character.renderer.skeleton) {
            character.renderer.setTransform(data.x, data.y, null, null);
            
            // BBãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ä¿¡
            integration.sendBBFeedback('position');
            
            // ğŸ’¾ SpineSettingsPersistenceã§ä½ç½®è¨­å®šä¿å­˜
            this.savePositionSettings(integration.selectedCharacter, data.x, data.y);
            
            this.log(`ğŸ“ ${integration.selectedCharacter} ä½ç½®å¤‰æ›´: X=${data.x}, Y=${data.y}`);
          } else {
            this.log('âš ï¸ é¸æŠã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
          }
        }

        // handlePositionResetæ©Ÿèƒ½ã¯å‰Šé™¤æ¸ˆã¿ï¼ˆcenterCharacterã¨é‡è¤‡ã®ãŸã‚ï¼‰

        handleCenterCharacter(data) {
          this.handlePositionChange(data);
          this.log('ğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä¸­å¤®ã«é…ç½®');
        }

        // å‰Šé™¤æ¸ˆã¿æ©Ÿèƒ½ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        // handleDetectBounds, handleApplyOptimal, handleTestMedium ã¯å‰Šé™¤
        
        // ğŸ”§ ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã‚’ãƒ¡ã‚¤ãƒ³HTMLã«ç§»å‹•
        handleDebugInfo() {
          const integration = window.nezumiIntegration;
          console.log('ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:');
          console.log('Canvas:', integration.canvas);
          console.log('SpineRenderer:', integration.spineRenderer);
          console.log('Skeleton:', integration.spineRenderer?.skeleton);
          if (integration.spineRenderer?.skeleton) {
            const skeleton = integration.spineRenderer.skeleton;
            console.log(`ä½ç½®: x=${skeleton.x}, y=${skeleton.y}`);
            console.log(`ã‚¹ã‚±ãƒ¼ãƒ«: scaleX=${skeleton.scaleX}, scaleY=${skeleton.scaleY}`);
          }
          this.log('ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›');
        }

        handleClearLog() {
          const logPanel = document.getElementById('log-panel');
          if (logPanel) {
            logPanel.innerHTML = '<div style="color: #ffd700; margin-bottom: 10px">ğŸ“ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</div>';
          }
          console.clear();
          this.log('ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†');
        }

        // UIç®¡ç†
        handleUIReady(data) {
          this.log('âœ… iframe UI åˆæœŸåŒ–å®Œäº†');
          
          // åˆæœŸçŠ¶æ…‹ã‚’ iframe ã«é€ä¿¡
          this.syncUIState();
        }

        handleUILog(data) {
          // iframe ã‹ã‚‰ã®ãƒ­ã‚°ã‚’çµ±åˆ
          this.log(`[iframe] ${data.message}`);
        }

        // iframe ã«çŠ¶æ…‹ã‚’åŒæœŸ
        syncUIState() {
          if (!this.iframeLoaded || !this.iframe) return;

          const integration = window.nezumiIntegration;
          if (!integration) return;

          const state = {
            canvasSize: integration.canvas ? Math.min(integration.canvas.width, integration.canvas.height) : 800,
            scaleX: integration.spineRenderer?.skeleton?.scaleX || 1.35,
            scaleY: integration.spineRenderer?.skeleton?.scaleY || 1.0,
            positionX: integration.spineRenderer?.skeleton?.x || 0,
            positionY: integration.spineRenderer?.skeleton?.y || 0
          };

          this.sendToIframe('updateUIState', state);
        }

        // iframe ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        sendToIframe(type, data) {
          this.log(`ğŸ“¤ iframeé€ä¿¡è©¦è¡Œ: ${type} - iframeLoaded: ${this.iframeLoaded}`);
          if (this.iframeLoaded && this.iframe) {
            this.iframe.contentWindow.postMessage({
              type: type,
              data: data,
              timestamp: Date.now(),
              source: 'MainPage'
            }, '*');
            this.log(`ğŸ“¤ iframeé€ä¿¡å®Œäº†: ${type}`);
          } else {
            // iframeæœªæº–å‚™ã®å ´åˆã€ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
            this.messageQueue.push({ type: type, data: data });
            this.log(`ğŸ”„ iframeé€ä¿¡ã‚­ãƒ¥ãƒ¼è¿½åŠ : ${type} - ç¾åœ¨ã®ã‚­ãƒ¥ãƒ¼ã‚µã‚¤ã‚º: ${this.messageQueue.length}`);
          }
        }

        processQueuedMessages() {
          this.log(`ğŸš€ ã‚­ãƒ¥ãƒ¼ã«å…¥ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†é–‹å§‹ - ã‚­ãƒ¥ãƒ¼ã‚µã‚¤ã‚º: ${this.messageQueue.length}`);
          while (this.messageQueue.length > 0) {
            const message = this.messageQueue.shift();
            this.log(`ğŸ“¤ ã‚­ãƒ¥ãƒ¼ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡: ${message.type}`);
            this.sendToIframe(message.type, message.data);
          }
          this.log('âœ… ã‚­ãƒ¥ãƒ¼ã«å…¥ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†å®Œäº†');
        }

        // BBãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡
        sendBBFeedback(type) {
          this.sendToIframe('showBBFeedback', { type: type });
        }

        log(message) {
          if (window.nezumiIntegration && window.nezumiIntegration.log) {
            window.nezumiIntegration.log(message);
          } else {
            console.log(`[CanvasResizeHandler] ${message}`);
          }
        }
      }

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’åˆæœŸåŒ–
      window.canvasResizeHandler = new CanvasResizeIframeHandler();

      // ğŸš€ ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•
      window.addEventListener("load", async () => {
        // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å¾…æ©Ÿ
        await new Promise((resolve) => setTimeout(resolve, 500));

        console.log(
          "ğŸ¯ Nezumi + StableSpineRenderer + BoundingBox çµ±åˆã‚·ã‚¹ãƒ†ãƒ èµ·å‹•"
        );

        // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        window.multiCharacterSystem = new MultiCharacterStableSpineBBIntegration();
        
        // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã«å¾“æ¥åã‚‚è¨­å®š
        window.nezumiIntegration = window.multiCharacterSystem;

        // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        window.debugNezumiSystem = () => {
          if (window.nezumiIntegration) {
            window.nezumiIntegration.showDebugInfo();
          }
        };

        // ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®š
        const debugInfoBtn = document.getElementById('debug-info-btn');
        const clearLogBtn = document.getElementById('clear-log-btn');
        const consoleDebugBtn = document.getElementById('console-debug');

        if (debugInfoBtn) {
          debugInfoBtn.onclick = () => {
            if (window.canvasResizeHandler) {
              window.canvasResizeHandler.handleDebugInfo();
            }
          };
        }

        if (clearLogBtn) {
          clearLogBtn.onclick = () => {
            if (window.canvasResizeHandler) {
              window.canvasResizeHandler.handleClearLog();
            }
          };
        }

        if (consoleDebugBtn) {
          consoleDebugBtn.onclick = () => {
            console.log('ğŸ–¥ï¸ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹:');
            console.log('- nezumiIntegration:', window.nezumiIntegration);
            console.log('- canvasResizeHandler:', window.canvasResizeHandler);
            if (window.nezumiIntegration) {
              const integration = window.nezumiIntegration;
              console.log('- canvas:', integration.canvas);
              console.log('- spineRenderer:', integration.spineRenderer);
              console.log('- boundingBox:', integration.boundingBox);
              if (integration.spineRenderer?.skeleton) {
                console.log('- skeleton position:', {
                  x: integration.spineRenderer.skeleton.x,
                  y: integration.spineRenderer.skeleton.y
                });
                console.log('- skeleton scale:', {
                  x: integration.spineRenderer.skeleton.scaleX,
                  y: integration.spineRenderer.skeleton.scaleY
                });
              }
            }
            if (window.canvasResizeHandler) {
              window.canvasResizeHandler.log('ğŸ–¥ï¸ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°å‡ºåŠ›å®Œäº†');
            }
          };
        }
      });
    </script>
    
    <!-- ğŸ¯ SpineSettingsPersistence ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ±åˆ -->
    <script src="micromodules/spine-settings-persistence/SpineSettingsPersistence.js"></script>
    
  </body>
</html>
