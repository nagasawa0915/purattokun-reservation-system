<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ± Purattokun + StableSpineRenderer + BoundingBox ãƒ†ã‚¹ãƒˆ</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #2e86ab 0%, #a23b72 100%);
        color: white;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      .subtitle {
        font-size: 1.2em;
        opacity: 0.9;
        margin-top: 10px;
      }

      .canvas-container {
        position: relative;
        width: 300px;
        height: 300px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        overflow: hidden;
      }

      #spine-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }

      .controls {
        position: fixed;
        top: 20px;
        right: 20px;
        bottom: 20px;
        width: 280px;
        background: rgba(0, 0, 0, 0.8);
        padding: 20px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        overflow-y: auto;
        overflow-x: hidden;
      }

      .control-group {
        margin-bottom: 15px;
      }

      .control-group h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #ffd700;
      }

      .btn {
        display: block;
        width: 100%;
        padding: 8px 12px;
        margin: 5px 0;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
      }

      .btn:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .btn.success {
        background: rgba(76, 175, 80, 0.8);
      }

      .btn.danger {
        background: rgba(244, 67, 54, 0.8);
      }

      .btn.primary {
        background: rgba(33, 150, 243, 0.8);
      }

      .log {
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 350px;
        max-height: 250px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        font-family: "Courier New", monospace;
        font-size: 11px;
        padding: 10px;
        border-radius: 5px;
        overflow-y: auto;
        border: 1px solid rgba(255, 255, 255, 0.2);
        z-index: 1000;
      }

      .status {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        padding: 15px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .status-item {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
        font-size: 13px;
      }

      .status-label {
        color: #ccc;
      }

      .status-value {
        color: #ffd700;
        font-weight: bold;
      }

      .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        z-index: 1000;
      }

      .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid #ffd700;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºç”¨ã®z-indexã‚’ç¢ºä¿ */
      .bounding-box-overlay {
        z-index: 999 !important;
      }

      /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
      .controls::-webkit-scrollbar {
        width: 8px;
      }

      .controls::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
      }

      .controls::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }

      .controls::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ± Purattokun + StableSpineRenderer + BoundingBox</h1>
        <div class="subtitle">
          æœ€æ–°å®‰å®šç‰ˆ - é»’æ å•é¡Œå®Œå…¨è§£æ±º + BBçµ±åˆãƒ†ã‚¹ãƒˆ + è‡ªå‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ¤œå‡º
        </div>
      </div>

      <div class="canvas-container">
        <canvas id="spine-canvas" width="800" height="600"></canvas>
      </div>
    </div>

    <div class="status" id="status-panel">
      <h3 style="margin: 0 0 10px 0; color: #ffd700">ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
      <div class="status-item">
        <span class="status-label">StableSpineRenderer:</span>
        <span class="status-value" id="renderer-status">åˆæœŸåŒ–ä¸­</span>
      </div>
      <div class="status-item">
        <span class="status-label">Purattokunèª­ã¿è¾¼ã¿:</span>
        <span class="status-value" id="nezumi-status">å¾…æ©Ÿä¸­</span>
      </div>
      <div class="status-item">
        <span class="status-label">ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹:</span>
        <span class="status-value" id="bbox-status">å¾…æ©Ÿä¸­</span>
      </div>
      <div class="status-item">
        <span class="status-label">çµ±åˆçŠ¶æ…‹:</span>
        <span class="status-value" id="integration-status">æº–å‚™ä¸­</span>
      </div>
    </div>

    <div class="controls">
      <div class="control-group">
        <h3>â­ StableSpineRenderer</h3>
        <button class="btn primary" id="init-renderer">ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼åˆæœŸåŒ–</button>
        <button class="btn" id="load-nezumi">Purattokunèª­ã¿è¾¼ã¿</button>
        <button class="btn" id="play-search">å¾…æ©Ÿã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</button>
        <button class="btn" id="play-kettei">ã‚„ã‚‰ã‚Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</button>
      </div>

      <div class="control-group">
        <h3>ğŸ“¦ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹</h3>
        <button class="btn" id="create-bbox">BBä½œæˆ</button>
        <button class="btn" id="toggle-bbox">BBè¡¨ç¤ºåˆ‡æ›¿</button>
        <button class="btn" id="test-resize">ãƒªã‚µã‚¤ã‚ºãƒ†ã‚¹ãƒˆ</button>
        <button class="btn danger" id="cleanup-bbox">BBã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—</button>
      </div>

      <div class="control-group">
        <h3>ğŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆ</h3>
        <button class="btn success" id="full-test">å®Œå…¨çµ±åˆãƒ†ã‚¹ãƒˆ</button>
        <button class="btn" id="performance-test">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn danger" id="reset-all">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <div class="control-group">
        <h3>ğŸ“ Canvas ã‚µã‚¤ã‚ºå¤‰æ›´</h3>
        <label
          >å¹…:
          <input
            type="number"
            id="canvas-width"
            value="800"
            min="100"
            max="1200"
            style="width: 80px; margin: 5px"
        /></label>
        <label
          >é«˜ã•:
          <input
            type="number"
            id="canvas-height"
            value="600"
            min="100"
            max="900"
            style="width: 80px; margin: 5px"
        /></label>
        <button class="btn primary" id="resize-canvas">Canvas ãƒªã‚µã‚¤ã‚º</button>
        <button class="btn" id="reset-canvas">å…ƒã®ã‚µã‚¤ã‚ºã«æˆ»ã™</button>
      </div>

      <div class="control-group">
        <h3>ğŸ¯ è‡ªå‹•æœ€é©åŒ–</h3>
        <button class="btn success" id="detect-bounds">å¢ƒç•Œæ¤œå‡ºãƒ†ã‚¹ãƒˆ</button>
        <button class="btn primary" id="apply-optimal">æœ€é©ã‚µã‚¤ã‚ºé©ç”¨</button>
        <p style="font-size: 0.8em; color: #ccc; margin: 5px 0">
          ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å®Ÿéš›ã®ã‚µã‚¤ã‚ºã‚’è‡ªå‹•æ¤œå‡ºã—ã¦Canvasã‚’æœ€é©åŒ–
        </p>
      </div>

      <div class="control-group">
        <h3>ğŸ§ª æ‰‹å‹•ãƒ†ã‚¹ãƒˆ</h3>
        <button class="btn" id="test-small">å°ã‚µã‚¤ã‚ºãƒ†ã‚¹ãƒˆ (300x200)</button>
        <button class="btn" id="test-medium">ä¸­ã‚µã‚¤ã‚ºãƒ†ã‚¹ãƒˆ (500x400)</button>
        <button class="btn" id="test-large">å…ƒã‚µã‚¤ã‚º (800x600)</button>
        <p style="font-size: 0.8em; color: #ccc; margin: 5px 0">
          æ‰‹å‹•ã§CSSè¡¨ç¤ºã‚µã‚¤ã‚ºã‚’ãƒ†ã‚¹ãƒˆ
        </p>
      </div>

      <div class="control-group">
        <h3>ğŸ”§ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚µã‚¤ã‚ºä¿æŒãƒ†ã‚¹ãƒˆ</h3>
        <button class="btn success" id="test-preserve-small">
          ä¿æŒå° (300x200)
        </button>
        <button class="btn success" id="test-preserve-medium">
          ä¿æŒä¸­ (500x400)
        </button>
        <button class="btn" id="test-preserve-large">ä¿æŒå¤§ (800x600)</button>
        <p style="font-size: 0.8em; color: #ccc; margin: 5px 0">
          ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚µã‚¤ã‚ºã‚’ä¿æŒã—ã¦Canvasè¡¨ç¤ºã‚µã‚¤ã‚ºå¤‰æ›´
        </p>
      </div>

      <div class="control-group">
        <h3>ğŸ“ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´</h3>
        <label style="color: white; font-size: 12px; display: block; margin: 5px 0;">
          æ¨ªã‚¹ã‚±ãƒ¼ãƒ«(X): 
          <input type="range" id="character-scale-x" min="0.3" max="2.0" step="0.05" value="1.35" 
                 style="width: 120px; margin: 0 5px;">
          <span id="scale-x-value">1.35</span>
        </label>
        <label style="color: white; font-size: 12px; display: block; margin: 5px 0;">
          ç¸¦ã‚¹ã‚±ãƒ¼ãƒ«(Y): 
          <input type="range" id="character-scale-y" min="0.3" max="2.0" step="0.05" value="1.0" 
                 style="width: 120px; margin: 0 5px;">
          <span id="scale-y-value">1.0</span>
        </label>
        <button class="btn success" id="apply-scale">ã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨</button>
        <button class="btn" id="reset-scale">ç†æƒ³çš„ãªæ¯”ç‡ã«æˆ»ã™</button>
        <button class="btn" id="auto-ratio">è‡ªç„¶ãªæ¯”ç‡æ¤œå‡º</button>
      </div>

      <div class="control-group">
        <h3>ğŸ“ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®èª¿æ•´</h3>
        <label style="color: white; font-size: 12px; display: block; margin: 5px 0;">
          Xä½ç½®: 
          <input type="range" id="character-x" min="0" max="800" step="10" value="100" 
                 style="width: 120px; margin: 0 5px;">
          <span id="x-value">100</span>
        </label>
        <label style="color: white; font-size: 12px; display: block; margin: 5px 0;">
          Yä½ç½®: 
          <input type="range" id="character-y" min="-200" max="600" step="10" value="-100" 
                 style="width: 120px; margin: 0 5px;">
          <span id="y-value">-100</span>
        </label>
        <button class="btn success" id="apply-position">ä½ç½®é©ç”¨</button>
        <button class="btn" id="center-character">ä¸­å¤®ã«é…ç½®</button>
        <button class="btn" id="reset-position">ä½ç½®ãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <div class="control-group">
        <h3>ğŸ”§ ãƒ‡ãƒãƒƒã‚°</h3>
        <button class="btn" id="debug-info">ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±è¡¨ç¤º</button>
        <button class="btn" id="clear-log">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <div class="log" id="log-panel">
      <div style="color: #ffd700; margin-bottom: 10px">ğŸ“ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</div>
    </div>

    <div class="loading" id="loading-screen">
      <div class="spinner"></div>
      <div>StableSpineRenderer + BB ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <!-- Spine WebGL -->
    <script src="assets/js/libs/spine-webgl.js"></script>

    <!-- StableSpineRenderer -->
    <script src="micromodules/spine-renderer/StableSpineRenderer.js"></script>

    <!-- ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    <script src="micromodules/bounding-box/PureBoundingBoxCore.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxBounds.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxUI.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxEvents.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBox.js"></script>
    
    <!-- ğŸ¯ Phase 1: UIController + LogSystem ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    <script src="micromodules/spine-integration/LogSystem.js"></script>
    <script src="micromodules/spine-integration/UIController.js"></script>

    <script>
      /**
       * ğŸ¯ Nezumi + StableSpineRenderer + BoundingBox çµ±åˆã‚·ã‚¹ãƒ†ãƒ 
       *
       * ç‰¹å¾´:
       * - StableSpineRendererã«ã‚ˆã‚‹ç¢ºå®ŸãªSpineè¡¨ç¤ºï¼ˆé»’æ å•é¡Œè§£æ±ºæ¸ˆã¿ï¼‰
       * - PureBoundingBoxã«ã‚ˆã‚‹é«˜åº¦ãªãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ç·¨é›†
       * - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµ±åˆãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
       */
      class NezumiStableSpineBBIntegration {
        constructor() {
          this.canvas = document.getElementById("spine-canvas");

          // StableSpineRenderer
          this.spineRenderer = null;

          // PureBoundingBox
          this.boundingBox = null;

          // çŠ¶æ…‹ç®¡ç†
          this.rendererInitialized = false;
          this.nezumiLoaded = false;
          this.bboxCreated = false;
          this.integrationComplete = false;

          // ğŸ¯ Phase 1: UIController + LogSystem ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ±åˆ
          this.logSystem = new SpineLogSystem({
            logLevel: 'info',
            maxLogs: 1000,
            showTimestamp: true,
            enableConsole: true,
            enableHtml: true,
            prefix: '[StableSpineBB]'
          });
          this.uiController = null;

          this.init();
        }

        async init() {
          this.log("ğŸš€ StableSpine + BBçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹");

          try {
            // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¢ºèª
            await this.checkDependencies();

            // ğŸ¯ Phase 1: UIController ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–
            this.uiController = new SpineUIController(this, this.logSystem);  // logSystem = this.logSystem
            this.uiController.initUI();

            this.uiController.hideLoading();
            this.log("âœ… åˆæœŸåŒ–å®Œäº† - ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼åˆæœŸåŒ–ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„");
            this.uiController.updateStatus("integration-status", "åˆæœŸåŒ–å®Œäº†");
          } catch (error) {
            this.log(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            this.uiController?.hideLoading();
            this.uiController?.updateStatus("integration-status", "åˆæœŸåŒ–å¤±æ•—");
          }
        }

        async checkDependencies() {
          this.log("ğŸ” ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¾å­˜é–¢ä¿‚ç¢ºèªä¸­...");

          // Spine WebGLç¢ºèª
          if (typeof window.spine === "undefined") {
            throw new Error("Spine WebGLãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }

          // StableSpineRendererç¢ºèª
          if (typeof window.StableSpineRenderer === "undefined") {
            throw new Error("StableSpineRendererãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }

          // PureBoundingBoxç¢ºèª
          if (typeof window.PureBoundingBox === "undefined") {
            throw new Error("PureBoundingBoxãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }

          this.log("âœ… å…¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¢ºèªå®Œäº†");
        }

        // ğŸ¯ Phase 1: initUI()ãƒ¡ã‚½ãƒƒãƒ‰ã¯UIController.jsã«ç§»è¡Œæ¸ˆã¿

        async initRenderer() {
          this.log("â­ StableSpineRendereråˆæœŸåŒ–ä¸­...");
          this.uiController.updateStatus("renderer-status", "åˆæœŸåŒ–ä¸­");

          try {
            // StableSpineRendererä½œæˆï¼ˆcanvasã‚‚åŒæ™‚ã«æŒ‡å®šï¼‰
            this.spineRenderer = new StableSpineRenderer({
              canvas: this.canvas,
              character: "purattokun",
              basePath: "/assets/spine/characters/",
              // defaultAnimation: è‡ªå‹•æ¤œå‡ºã•ã‚Œã‚‹ï¼ï¼ˆpurattokuã‚“ã®å ´åˆã¯'taiki'ãŒé¸æŠã•ã‚Œã‚‹ï¼‰
              debug: true,
              logCallback: (message, level) =>
                this.log(`[Renderer] ${message}`),
            });

            // åˆæœŸåŒ–å®Ÿè¡Œ
            await this.spineRenderer.initialize();

            this.rendererInitialized = true;
            this.uiController.updateStatus("renderer-status", "åˆæœŸåŒ–å®Œäº†");
            this.log("âœ… StableSpineRendereråˆæœŸåŒ–å®Œäº†");
            this.log("ğŸ“ Nezumièª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„");
          } catch (error) {
            this.log(`âŒ StableSpineRendereråˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            this.uiController.updateStatus("renderer-status", "åˆæœŸåŒ–å¤±æ•—");
          }
        }

        async loadNezumi() {
          if (!this.rendererInitialized) {
            this.log("âš ï¸ å…ˆã«ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„");
            return;
          }

          this.log("ğŸ± purattokunèª­ã¿è¾¼ã¿é–‹å§‹...");
          this.uiController.updateStatus("nezumi-status", "èª­ã¿è¾¼ã¿ä¸­");

          try {
            // StableSpineRendererã¯ initialize() ã§å…¨ã¦å®Œäº†
            // æ—¢ã«èª­ã¿è¾¼ã¿ãƒ»æç”»ãƒ»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å…¨ã¦é–‹å§‹æ¸ˆã¿

            // åˆæœŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè‡ªå‹•æ¤œå‡ºã•ã‚ŒãŸã‚‚ã®ãŒãã®ã¾ã¾ä½¿ç”¨ã•ã‚Œã‚‹ï¼‰
            // è¿½åŠ ã®playAnimationã¯ä¸è¦ï¼ˆinitialize()ã§è‡ªå‹•é–‹å§‹ï¼‰

            this.nezumiLoaded = true;
            this.uiController.updateStatus("nezumi-status", "èª­ã¿è¾¼ã¿å®Œäº†");
            this.log(
              "âœ… purattokunèª­ã¿è¾¼ã¿å®Œäº† - è‡ªå‹•æ¤œå‡ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿä¸­"
            );

            // ç¾åœ¨ã®ä½ç½®ãƒ»ã‚¹ã‚±ãƒ¼ãƒ«ã‚’UIã«åŒæœŸ
            setTimeout(() => {
              this.syncPositionUI();
            }, 100);
          } catch (error) {
            this.log(`âŒ Nezumièª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            this.uiController.updateStatus("nezumi-status", "èª­ã¿è¾¼ã¿å¤±æ•—");
          }
        }

        playAnimation(animationName) {
          if (!this.nezumiLoaded) {
            this.log("âš ï¸ å…ˆã«Nezumiã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„");
            return;
          }

          try {
            this.spineRenderer.playAnimation(animationName);
            this.log(`ğŸ­ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ: ${animationName}`);
          } catch (error) {
            this.log(`âŒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        async createBoundingBox() {
          if (!this.nezumiLoaded) {
            this.log("âš ï¸ å…ˆã«Nezumiã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„");
            return;
          }

          this.log("ğŸ“¦ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½œæˆä¸­...");
          this.uiController.updateStatus("bbox-status", "ä½œæˆä¸­");

          try {
            // PureBoundingBoxä½œæˆ
            this.boundingBox = new window.PureBoundingBox({
              targetElement: this.canvas,
              nodeId: "purattokun-spine-bb-canvas",
            });

            // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹å®Ÿè¡Œ
            const result = await this.boundingBox.execute({
              visible: true,
              interactive: true,
              showHandles: true,
            });

            if (result.success) {
              this.bboxCreated = true;
              this.uiController.updateStatus("bbox-status", "ä½œæˆå®Œäº†");
              this.log("âœ… ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½œæˆå®Œäº†");
              this.log(
                `ğŸ“Š Bounds: x=${result.bounds.x}, y=${result.bounds.y}, w=${result.bounds.width}, h=${result.bounds.height}`
              );
            } else {
              this.log(`âŒ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½œæˆå¤±æ•—: ${result.error}`);
              this.uiController.updateStatus("bbox-status", "ä½œæˆå¤±æ•—");
            }
          } catch (error) {
            this.log(`âŒ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            this.uiController.updateStatus("bbox-status", "ã‚¨ãƒ©ãƒ¼");
          }
        }

        toggleBoundingBox() {
          if (!this.boundingBox) {
            this.log("âš ï¸ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“");
            return;
          }

          try {
            const state = this.boundingBox.getState();
            if (state.bounds && state.bounds.visible) {
              this.boundingBox.hide();
              this.log("ğŸ‘» ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹éè¡¨ç¤º");
            } else {
              this.boundingBox.show();
              this.log("ğŸ‘ï¸ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤º");
            }
          } catch (error) {
            this.log(`âŒ è¡¨ç¤ºåˆ‡æ›¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        testResize() {
          if (!this.boundingBox) {
            this.log("âš ï¸ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“");
            return;
          }

          this.log("ğŸ”§ ãƒªã‚µã‚¤ã‚ºãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...");

          try {
            // ãƒ†ã‚¹ãƒˆç”¨ã®ãƒªã‚µã‚¤ã‚ºå®Ÿè¡Œ
            const currentBounds = this.boundingBox.getBounds();
            const newWidth = currentBounds.width * 1.2;
            const newHeight = currentBounds.height * 1.2;

            this.boundingBox.resize(newWidth, newHeight);
            this.log(
              `âœ… ãƒªã‚µã‚¤ã‚ºãƒ†ã‚¹ãƒˆå®Œäº†: ${newWidth.toFixed(
                0
              )} x ${newHeight.toFixed(0)}`
            );
          } catch (error) {
            this.log(`âŒ ãƒªã‚µã‚¤ã‚ºãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        cleanupBoundingBox() {
          if (!this.boundingBox) {
            this.log("âš ï¸ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“");
            return;
          }

          try {
            this.boundingBox.cleanup();
            this.boundingBox = null;
            this.bboxCreated = false;
            this.uiController.updateStatus("bbox-status", "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†");
            this.log("ğŸ§¹ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†");
          } catch (error) {
            this.log(`âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        async fullIntegrationTest() {
          this.log("ğŸ§ª å®Œå…¨çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹");
          this.uiController.updateStatus("integration-status", "çµ±åˆãƒ†ã‚¹ãƒˆä¸­");

          try {
            // 1. ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼åˆæœŸåŒ–ç¢ºèª
            if (!this.rendererInitialized) {
              await this.initRenderer();
              await new Promise((resolve) => setTimeout(resolve, 1000));
            }

            // 2. Nezumièª­ã¿è¾¼ã¿ç¢ºèª
            if (!this.nezumiLoaded) {
              await this.loadNezumi();
              await new Promise((resolve) => setTimeout(resolve, 2000));
            }

            // 3. ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½œæˆç¢ºèª
            if (!this.bboxCreated) {
              await this.createBoundingBox();
              await new Promise((resolve) => setTimeout(resolve, 1000));
            }

            // 4. å‹•ä½œãƒ†ã‚¹ãƒˆ
            if (
              this.rendererInitialized &&
              this.nezumiLoaded &&
              this.bboxCreated
            ) {
              this.log("ğŸ¯ å‹•ä½œãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...");

              // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ
              this.playAnimation("yarare");
              await new Promise((resolve) => setTimeout(resolve, 2000));
              this.playAnimation("taiki");

              // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºãƒ†ã‚¹ãƒˆ
              this.toggleBoundingBox();
              await new Promise((resolve) => setTimeout(resolve, 1000));
              this.testResize();
              await new Promise((resolve) => setTimeout(resolve, 1000));
              this.toggleBoundingBox();

              this.integrationComplete = true;
              this.uiController.updateStatus("integration-status", "çµ±åˆãƒ†ã‚¹ãƒˆæˆåŠŸ");
              this.log("ğŸ‰ å®Œå…¨çµ±åˆãƒ†ã‚¹ãƒˆæˆåŠŸï¼å…¨æ©Ÿèƒ½æ­£å¸¸å‹•ä½œç¢ºèª");
            } else {
              this.log("âŒ çµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•— - ä¸€éƒ¨æ©Ÿèƒ½ãŒå‹•ä½œã—ã¦ã„ã¾ã›ã‚“");
              this.uiController.updateStatus("integration-status", "çµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•—");
            }
          } catch (error) {
            this.log(`âŒ çµ±åˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            this.uiController.updateStatus("integration-status", "ã‚¨ãƒ©ãƒ¼");
          }
        }

        async performanceTest() {
          this.log("âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹");

          const startTime = Date.now();

          try {
            // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
            if (this.spineRenderer) {
              const renderStart = Date.now();
              for (let i = 0; i < 10; i++) {
                this.playAnimation(i % 2 === 0 ? "taiki" : "yarare");
                await new Promise((resolve) => setTimeout(resolve, 100));
              }
              const renderTime = Date.now() - renderStart;
              this.log(
                `ğŸ“Š ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: ${renderTime}ms (10å›åˆ‡ã‚Šæ›¿ãˆ)`
              );
            }

            // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
            if (this.boundingBox) {
              const bboxStart = Date.now();
              for (let i = 0; i < 5; i++) {
                this.toggleBoundingBox();
                await new Promise((resolve) => setTimeout(resolve, 50));
              }
              const bboxTime = Date.now() - bboxStart;
              this.log(`ğŸ“Š BBãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: ${bboxTime}ms (5å›åˆ‡ã‚Šæ›¿ãˆ)`);
            }

            const totalTime = Date.now() - startTime;
            this.log(`âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Œäº†: ç·æ™‚é–“ ${totalTime}ms`);
          } catch (error) {
            this.log(`âŒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        resetAll() {
          this.log("ğŸ”„ å…¨ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œä¸­...");

          try {
            // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            if (this.boundingBox) {
              this.cleanupBoundingBox();
            }

            // ã‚¹ãƒ‘ã‚¤ãƒ³ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚¹ãƒˆãƒƒãƒ—
            if (this.spineRenderer) {
              this.spineRenderer.stop();
              this.spineRenderer = null;
            }

            // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            this.rendererInitialized = false;
            this.nezumiLoaded = false;
            this.bboxCreated = false;
            this.integrationComplete = false;

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            this.uiController.updateStatus("renderer-status", "ãƒªã‚»ãƒƒãƒˆå®Œäº†");
            this.uiController.updateStatus("nezumi-status", "å¾…æ©Ÿä¸­");
            this.uiController.updateStatus("bbox-status", "å¾…æ©Ÿä¸­");
            this.uiController.updateStatus("integration-status", "ãƒªã‚»ãƒƒãƒˆå®Œäº†");

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªã‚¢
            const ctx = this.canvas.getContext("2d");
            if (ctx) {
              ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }

            this.log("âœ… å…¨ãƒªã‚»ãƒƒãƒˆå®Œäº†");
          } catch (error) {
            this.log(`âŒ ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // ğŸ¯ Phase 1: ãƒ­ã‚°æ©Ÿèƒ½ã¯LogSystem.jsã«ç§»è¡Œæ¸ˆã¿
        
        /**
         * LogSystemçµŒç”±ã®ãƒ­ã‚°å‡ºåŠ› - æ—¢å­˜äº’æ›æ€§100%ä¿æŒ
         */
        log(message) {
          this.logSystem.log(message);
        }

        /**
         * LogSystemé«˜åº¦æ©Ÿèƒ½ã¸ã®ä¾¿åˆ©ãªã‚¢ã‚¯ã‚»ã‚µãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
         */
        warn(message) { this.logSystem.warn(message); }
        error(message) { this.logSystem.error(message); }
        success(message) { this.logSystem.success(message); }
        debug(message) { this.logSystem.debug(message); }

        /**
         * ãƒ­ã‚°ç®¡ç†ãƒ¡ã‚½ãƒƒãƒ‰
         */
        clearLog() { this.logSystem.clearLog(); }
        exportLogs() { return this.logSystem.exportLogsAsText(); }
        exportLogsJson() { return this.logSystem.exportLogsAsJson(); }
        getLogStats() { return this.logSystem.getStats(); }
        searchLogs(query) { return this.logSystem.searchLogs(query); }
        setLogLevel(level) { this.logSystem.setLogLevel(level); }
        showLogConfig() { this.logSystem.showConfig(); }

        // ğŸ¯ Phase 1: updateStatus(), hideLoading() ã¯UIController.jsã«ç§»è¡Œæ¸ˆã¿

        // ğŸ“ Canvas ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½
        resizeCanvas() {
          try {
            const widthInput = document.getElementById("canvas-width");
            const heightInput = document.getElementById("canvas-height");
            const newWidth = parseInt(widthInput.value);
            const newHeight = parseInt(heightInput.value);

            if (!newWidth || !newHeight || newWidth < 100 || newHeight < 100) {
              this.log("âŒ ç„¡åŠ¹ãªã‚µã‚¤ã‚ºã§ã™ï¼ˆæœ€å°100pxï¼‰");
              return;
            }

            this.log(
              `ğŸ”„ Canvas ãƒªã‚µã‚¤ã‚ºé–‹å§‹: ${this.canvas.width}x${this.canvas.height} â†’ ${newWidth}x${newHeight}`
            );

            // Canvaså±æ€§ã‚’å¤‰æ›´
            this.canvas.width = newWidth;
            this.canvas.height = newHeight;

            this.log(
              `âœ… Canvas ãƒªã‚µã‚¤ã‚ºå®Œäº†: ${this.canvas.width}x${this.canvas.height}`
            );

            // WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã¯å†åˆæœŸåŒ–ãŒå¿…è¦
            if (this.spineRenderer && this.nezumiLoaded) {
              this.log("ğŸ”„ WebGLå†åˆæœŸåŒ–ãŒæ¨å¥¨ã•ã‚Œã¾ã™");

              // WebGLãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã‚‚æ›´æ–°
              const gl = this.canvas.getContext("webgl");
              if (gl) {
                gl.viewport(0, 0, newWidth, newHeight);
                this.log("âœ… WebGL ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆæ›´æ–°å®Œäº†");
              }
            }
          } catch (error) {
            this.log(`âŒ Canvas ãƒªã‚µã‚¤ã‚ºã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        resetCanvasSize() {
          try {
            const widthInput = document.getElementById("canvas-width");
            const heightInput = document.getElementById("canvas-height");

            // å…ƒã®ã‚µã‚¤ã‚ºã«æˆ»ã™
            widthInput.value = 800;
            heightInput.value = 600;

            // ãƒªã‚µã‚¤ã‚ºå®Ÿè¡Œ
            this.resizeCanvas();

            this.log("âœ… Canvas ã‚µã‚¤ã‚ºã‚’å…ƒã«æˆ»ã—ã¾ã—ãŸ");
          } catch (error) {
            this.log(`âŒ Canvas ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // ğŸ¯ è‡ªå‹•ã‚µã‚¤ã‚ºç®—å‡ºæ©Ÿèƒ½
        calculateOptimalCanvasSize() {
          try {
            if (!this.spineRenderer || !this.spineRenderer.skeleton) {
              this.log("âŒ Spine skeleton ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
              return null;
            }

            this.log("ğŸ” ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¢ƒç•Œæ¤œå‡ºé–‹å§‹...");

            // Spineã‚¹ã‚±ãƒ«ãƒˆãƒ³ã®å¢ƒç•Œå–å¾—
            const skeleton = this.spineRenderer.skeleton;

            // å¢ƒç•Œæƒ…å ±ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°
            const offset = new spine.Vector2();
            const size = new spine.Vector2();
            const temp = [];

            // Spineå…¬å¼API: getBounds
            skeleton.getBounds(offset, size, temp);

            // å¢ƒç•Œæƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
            this.log(`ğŸ“ æ¤œå‡ºã•ã‚ŒãŸå¢ƒç•Œ:`);
            this.log(
              `   ã‚ªãƒ•ã‚»ãƒƒãƒˆ: (${offset.x.toFixed(2)}, ${offset.y.toFixed(2)})`
            );
            this.log(`   ã‚µã‚¤ã‚º: ${size.x.toFixed(2)} x ${size.y.toFixed(2)}`);

            // æœ€é©Canvasã‚µã‚¤ã‚ºè¨ˆç®—ï¼ˆä½™ç™½20pxï¼‰
            const padding = 40; // ä½™ç™½
            const optimalWidth = Math.ceil(size.x) + padding;
            const optimalHeight = Math.ceil(size.y) + padding;

            const result = {
              detected: {
                offset: { x: offset.x, y: offset.y },
                size: { width: size.x, height: size.y },
              },
              optimal: {
                width: optimalWidth,
                height: optimalHeight,
              },
              reduction: {
                fromWidth: this.canvas.width,
                fromHeight: this.canvas.height,
                reductionRatio:
                  ((this.canvas.width * this.canvas.height -
                    optimalWidth * optimalHeight) /
                    (this.canvas.width * this.canvas.height)) *
                  100,
              },
            };

            this.log(`ğŸ¯ æœ€é©ã‚µã‚¤ã‚º: ${optimalWidth} x ${optimalHeight}`);
            this.log(
              `ğŸ“Š ã‚µã‚¤ã‚ºå‰Šæ¸›: ${result.reduction.reductionRatio.toFixed(1)}%`
            );

            return result;
          } catch (error) {
            this.log(`âŒ å¢ƒç•Œæ¤œå‡ºã‚¨ãƒ©ãƒ¼: ${error.message}`);
            console.error("å¢ƒç•Œæ¤œå‡ºã‚¨ãƒ©ãƒ¼:", error);
            return null;
          }
        }

        // ğŸ¯ è‡ªå‹•ã‚µã‚¤ã‚ºé©ç”¨æ©Ÿèƒ½ï¼ˆä¿®æ­£ç‰ˆï¼šCSSã‚µã‚¤ã‚ºå¤‰æ›´ï¼‰
        async applyOptimalCanvasSize() {
          try {
            const optimalSizeInfo = this.calculateOptimalCanvasSize();

            if (!optimalSizeInfo) {
              this.log("âŒ æœ€é©ã‚µã‚¤ã‚ºã®è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ");
              return;
            }

            const { width, height } = optimalSizeInfo.optimal;

            this.log("ğŸ”„ CSSè¡¨ç¤ºã‚µã‚¤ã‚ºã‚’å¤‰æ›´ä¸­...");

            // ğŸ†• é‡è¦: CSSè¡¨ç¤ºã‚µã‚¤ã‚ºã‚’å¤‰æ›´ï¼ˆã“ã‚ŒãŒå®Ÿéš›ã®è¦‹ãŸç›®ã‚’å¤‰ãˆã‚‹ï¼‰
            const container = document.querySelector(".canvas-container");
            container.style.width = width + "px";
            container.style.height = height + "px";

            this.log(`ğŸ“ ã‚³ãƒ³ãƒ†ãƒŠã‚µã‚¤ã‚ºå¤‰æ›´: ${width}x${height}`);

            // Canvaså†…éƒ¨è§£åƒåº¦ã‚‚åˆã‚ã›ã¦å¤‰æ›´
            this.canvas.width = width;
            this.canvas.height = height;

            // WebGLãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆæ›´æ–°
            if (this.spineRenderer && this.spineRenderer.gl) {
              this.spineRenderer.gl.viewport(0, 0, width, height);
              this.log("ğŸ”§ WebGLãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆæ›´æ–°å®Œäº†");
            }

            // UIå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚æ›´æ–°
            document.getElementById("canvas-width").value = width;
            document.getElementById("canvas-height").value = height;

            // ğŸ†• BBã‚µã‚¤ã‚ºã‚‚è‡ªå‹•æ›´æ–°
            if (this.boundingBox) {
              this.log("ğŸ“¦ BBå†ä½œæˆä¸­...");
              await this.cleanupBoundingBox();
              await new Promise((resolve) => setTimeout(resolve, 100));
              await this.createBoundingBox();
              this.log("âœ… æ–°ã—ã„ã‚µã‚¤ã‚ºã§BBä½œæˆå®Œäº†");
            }

            this.log(`âœ… æœ€é©è¡¨ç¤ºã‚µã‚¤ã‚ºé©ç”¨å®Œäº†: ${width}x${height}`);
            this.log(
              `ğŸ“ˆ è¡¨ç¤ºã‚µã‚¤ã‚ºå‰Šæ¸›åŠ¹æœ: ${optimalSizeInfo.reduction.reductionRatio.toFixed(
                1
              )}%`
            );
            this.log(`ğŸ¯ ç„¡é§„ãªç©ºç™½ã‚’é™¤å»ã—ã¾ã—ãŸ`);

            return optimalSizeInfo;
          } catch (error) {
            this.log(`âŒ æœ€é©ã‚µã‚¤ã‚ºé©ç”¨ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // ğŸ†• CSSè¡¨ç¤ºã‚µã‚¤ã‚ºå¤‰æ›´æ©Ÿèƒ½ï¼ˆä¿®æ­£ç‰ˆï¼šã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚µã‚¤ã‚ºä¿æŒï¼‰
        changeCanvasDisplaySize(width, height) {
          try {
            this.log(`ğŸ”„ Canvasè¡¨ç¤ºã‚µã‚¤ã‚ºå¤‰æ›´: ${width}x${height}`);

            // ã‚³ãƒ³ãƒ†ãƒŠã‚µã‚¤ã‚ºå¤‰æ›´
            const container = document.querySelector(".canvas-container");
            container.style.width = width + "px";
            container.style.height = height + "px";

            // ğŸ¯ é‡è¦: Canvaså†…éƒ¨è§£åƒåº¦ã¯é«˜è§£åƒåº¦ã§ç¶­æŒ
            const scale = Math.max(width / 800, height / 600, 0.5); // æœ€ä½0.5å€ã¾ã§
            const internalWidth = Math.max(width, 800 * scale);
            const internalHeight = Math.max(height, 600 * scale);

            this.log(
              `ğŸ“ å†…éƒ¨è§£åƒåº¦: ${internalWidth}x${internalHeight} (scale: ${scale.toFixed(
                2
              )})`
            );

            // Canvaså†…éƒ¨è§£åƒåº¦è¨­å®š
            this.canvas.width = internalWidth;
            this.canvas.height = internalHeight;

            // ğŸ¯ Canvas CSS ã‚µã‚¤ã‚ºã‚’æ˜ç¤ºçš„ã«è¨­å®šï¼ˆ100%ã§ã¯ãªãï¼‰
            this.canvas.style.width = width + "px";
            this.canvas.style.height = height + "px";

            // WebGLãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆæ›´æ–°
            if (this.spineRenderer && this.spineRenderer.gl) {
              this.spineRenderer.gl.viewport(
                0,
                0,
                internalWidth,
                internalHeight
              );
              this.log("ğŸ”§ WebGLãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆæ›´æ–°å®Œäº†");
            }

            // Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ä½ç½®èª¿æ•´ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
            if (this.spineRenderer && this.spineRenderer.skeleton) {
              // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä¸­å¤®ã«é…ç½®
              const centerX = internalWidth / 2;
              const centerY = internalHeight / 2;

              // æ—¢å­˜ã®transformå€¤ã‚’ä¿æŒã—ã¦ä½ç½®èª¿æ•´
              this.spineRenderer.skeleton.x = centerX;
              this.spineRenderer.skeleton.y = centerY;

              this.log(`ğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®èª¿æ•´: (${centerX}, ${centerY})`);
            }

            this.log(
              `âœ… è¡¨ç¤ºã‚µã‚¤ã‚ºå¤‰æ›´å®Œäº†: è¡¨ç¤º${width}x${height}, å†…éƒ¨${internalWidth}x${internalHeight}`
            );
          } catch (error) {
            this.log(`âŒ è¡¨ç¤ºã‚µã‚¤ã‚ºå¤‰æ›´ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // ğŸ†• ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚µã‚¤ã‚ºä¿æŒãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
        testCanvasSizeWithCharacterPreservation(displayWidth, displayHeight) {
          try {
            this.log(
              `ğŸ§ª ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚µã‚¤ã‚ºä¿æŒãƒ†ã‚¹ãƒˆ: ${displayWidth}x${displayHeight}`
            );

            // ç¾åœ¨ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ã‚’ä¿å­˜
            let characterScale = 1;
            let characterX = 400; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¸­å¤®
            let characterY = 300;

            if (this.spineRenderer && this.spineRenderer.skeleton) {
              characterScale = this.spineRenderer.skeleton.scaleX;
              characterX = this.spineRenderer.skeleton.x;
              characterY = this.spineRenderer.skeleton.y;
              this.log(
                `ğŸ“‹ ç¾åœ¨ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±: scale=${characterScale}, pos=(${characterX}, ${characterY})`
              );
            }

            // Canvasè¡¨ç¤ºã‚µã‚¤ã‚ºå¤‰æ›´
            this.changeCanvasDisplaySize(displayWidth, displayHeight);

            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã‚’å…ƒã«æˆ»ã™
            if (this.spineRenderer && this.spineRenderer.skeleton) {
              this.spineRenderer.skeleton.scaleX = characterScale;
              this.spineRenderer.skeleton.scaleY = characterScale;
              this.log(`ğŸ”„ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å¾©å…ƒ: ${characterScale}`);
            }
          } catch (error) {
            this.log(`âŒ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚µã‚¤ã‚ºä¿æŒãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        // ğŸ¯ Phase 1: updateScaleDisplay() ã¯UIController.jsã«ç§»è¡Œæ¸ˆã¿

        applyCharacterScale() {
          if (!this.spineRenderer || !this.spineRenderer.skeleton) {
            this.log('âš ï¸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
            return;
          }

          const scaleXValue = parseFloat(document.getElementById('character-scale-x').value);
          const scaleYValue = parseFloat(document.getElementById('character-scale-y').value);
          
          try {
            // ğŸ¯ Xãƒ»Yåˆ¥ã€…ã®ã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨
            this.spineRenderer.setTransform(null, null, scaleXValue, scaleYValue);
            
            this.log(`âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨: X=${scaleXValue}, Y=${scaleYValue} (æ¯”ç‡ ${(scaleYValue/scaleXValue).toFixed(2)})`);
            
            // BBãŒä½œæˆã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å†ä½œæˆ
            if (this.boundingBox) {
              this.log('ğŸ“¦ ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´ã«ã‚ˆã‚ŠBBå†ä½œæˆä¸­...');
              setTimeout(async () => {
                await this.cleanupBoundingBox();
                await new Promise(resolve => setTimeout(resolve, 100));
                await this.createBoundingBox();
              }, 100);
            }
          } catch (error) {
            this.log(`âŒ ã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        resetCharacterScale() {
          document.getElementById('character-scale-x').value = '1.35';
          document.getElementById('character-scale-y').value = '1.0';
          document.getElementById('scale-x-value').textContent = '1.35';
          document.getElementById('scale-y-value').textContent = '1.0';
          this.applyCharacterScale();
          this.log('ğŸ”„ ã‚¹ã‚±ãƒ¼ãƒ«ã‚’ç†æƒ³çš„ãªæ¯”ç‡ã«æˆ»ã—ã¾ã—ãŸï¼ˆX=1.35, Y=1.0ï¼‰');
        }

        // ğŸ¯ è‡ªç„¶ãªæ¯”ç‡æ¤œå‡ºæ©Ÿèƒ½
        detectNaturalRatio() {
          if (!this.spineRenderer || !this.spineRenderer.skeleton) {
            this.log('âš ï¸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
            return;
          }

          // ã‚ˆãä½¿ã‚ã‚Œã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ¯”ç‡ã‚’è©¦ã™
          const commonRatios = [
            { x: 1.0, y: 1.3, name: 'ç¸¦é•·' },
            { x: 1.3, y: 1.0, name: 'æ¨ªé•·' },
            { x: 1.0, y: 1.2, name: 'å°‘ã—ç¸¦é•·' },
            { x: 1.2, y: 1.0, name: 'å°‘ã—æ¨ªé•·' },
            { x: 1.0, y: 1.0, name: 'æ­£æ–¹å½¢' }
          ];

          this.log('ğŸ” è‡ªç„¶ãªæ¯”ç‡ã‚’æ¤œå‡ºä¸­...');
          
          // æœ€åˆã®æ¯”ç‡ï¼ˆç¸¦é•·ï¼‰ã‚’è©¦ã™
          const ratio = commonRatios[0];
          document.getElementById('character-scale-x').value = ratio.x;
          document.getElementById('character-scale-y').value = ratio.y;
          document.getElementById('scale-x-value').textContent = ratio.x;
          document.getElementById('scale-y-value').textContent = ratio.y;
          
          this.applyCharacterScale();
          this.log(`ğŸ’¡ è©¦è¡Œ: ${ratio.name} (X=${ratio.x}, Y=${ratio.y}) - è‡ªç„¶ã«è¦‹ãˆã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„`);
          this.log('ğŸ¯ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§å¾®èª¿æ•´ã—ã¦æœ€é©ãªæ¯”ç‡ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„');
        }

        // ğŸ¯ Phase 1: updatePositionDisplay() ã¯UIController.jsã«ç§»è¡Œæ¸ˆã¿

        applyCharacterPosition() {
          if (!this.spineRenderer || !this.spineRenderer.skeleton) {
            this.log('âš ï¸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
            return;
          }

          const xValue = parseInt(document.getElementById('character-x').value);
          const yValue = parseInt(document.getElementById('character-y').value);
          
          try {
            this.spineRenderer.setTransform(xValue, yValue, null, null);
            this.log(`âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®é©ç”¨: (${xValue}, ${yValue})`);
            
            // BBãŒä½œæˆã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å†ä½œæˆ
            if (this.boundingBox) {
              this.log('ğŸ“¦ ä½ç½®å¤‰æ›´ã«ã‚ˆã‚ŠBBå†ä½œæˆä¸­...');
              setTimeout(async () => {
                await this.cleanupBoundingBox();
                await new Promise(resolve => setTimeout(resolve, 100));
                await this.createBoundingBox();
              }, 100);
            }
          } catch (error) {
            this.log(`âŒ ä½ç½®é©ç”¨ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        centerCharacter() {
          const canvasWidth = this.canvas ? this.canvas.width : 800;
          const canvasHeight = this.canvas ? this.canvas.height : 600;
          
          const centerX = canvasWidth / 2;
          const centerY = canvasHeight / 2;
          
          // UIã‚’æ›´æ–°
          document.getElementById('character-x').value = centerX;
          document.getElementById('character-y').value = centerY;
          document.getElementById('x-value').textContent = centerX;
          document.getElementById('y-value').textContent = centerY;
          
          // é©ç”¨
          this.applyCharacterPosition();
          this.log(`ğŸ“ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä¸­å¤®ã«é…ç½®: (${centerX}, ${centerY})`);
        }

        resetCharacterPosition() {
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã«æˆ»ã™
          document.getElementById('character-x').value = '100';
          document.getElementById('character-y').value = '-100';
          document.getElementById('x-value').textContent = '100';
          document.getElementById('y-value').textContent = '-100';
          
          this.applyCharacterPosition();
          this.log('ğŸ”„ ä½ç½®ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ');
        }

        // ğŸ¯ ç¾åœ¨ã®ä½ç½®ã‚’å–å¾—ã—ã¦UIã«åæ˜ ï¼ˆèª­ã¿è¾¼ã¿å¾Œã®åŒæœŸç”¨ï¼‰
        syncPositionUI() {
          if (this.spineRenderer && this.spineRenderer.skeleton) {
            const x = Math.round(this.spineRenderer.skeleton.x);
            const y = Math.round(this.spineRenderer.skeleton.y);
            const scaleX = this.spineRenderer.skeleton.scaleX;
            const scaleY = this.spineRenderer.skeleton.scaleY;
            
            // ğŸ¯ ç¾åœ¨ã®ã‚¹ã‚±ãƒ¼ãƒ«æ¯”ç‡ã‚’è©³ç´°ãƒ­ã‚°å‡ºåŠ›
            this.log(`ğŸ” ç¾åœ¨ã®ã‚¹ã‚±ãƒ¼ãƒ«è©³ç´°: scaleX=${scaleX}, scaleY=${scaleY}, æ¯”ç‡=${(scaleY/scaleX).toFixed(3)}`);
            
            // ã‚¹ã‚±ãƒ¼ãƒ«ãŒç•°ãªã‚‹å ´åˆã®å‡¦ç†ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèªï¼‰
            let scale = scaleX;
            // if (Math.abs(scaleX - scaleY) > 0.01) {
            //   this.spineRenderer.skeleton.scaleY = scaleX;
            //   this.log(`ğŸ”„ ã‚¹ã‚±ãƒ¼ãƒ«çµ±ä¸€: scaleY ${scaleY} â†’ ${scaleX} (ç­‰å€ç¶­æŒ)`);
            //   scale = scaleX;
            // }
            
            // UIåŒæœŸ
            document.getElementById('character-x').value = x;
            document.getElementById('character-y').value = y;
            document.getElementById('x-value').textContent = x;
            document.getElementById('y-value').textContent = y;
            document.getElementById('character-scale-x').value = scaleX;
            document.getElementById('character-scale-y').value = scaleY;
            document.getElementById('scale-x-value').textContent = scaleX;
            document.getElementById('scale-y-value').textContent = scaleY;
            
            this.log(`ğŸ”„ UIåŒæœŸå®Œäº†: ä½ç½®(${x}, ${y}), ç¾åœ¨ã‚¹ã‚±ãƒ¼ãƒ«${scale}`);
            
            // ğŸ¯ æ¨å¥¨ã‚¹ã‚±ãƒ¼ãƒ«æ¯”ç‡ã‚’ææ¡ˆ
            if (Math.abs(scaleX - scaleY) > 0.01) {
              const ratio = scaleY / scaleX;
              this.log(`ğŸ’¡ ã“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è‡ªç„¶ãªç¸¦æ¨ªæ¯”: Yè»¸ ${ratio.toFixed(2)}å€ ãŒã‚ªãƒªã‚¸ãƒŠãƒ«è¨­è¨ˆã‹ã‚‚ã—ã‚Œã¾ã›ã‚“`);
            }
          }
        }
      }

      // ğŸš€ ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•
      window.addEventListener("load", async () => {
        // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å¾…æ©Ÿ
        await new Promise((resolve) => setTimeout(resolve, 500));

        console.log(
          "ğŸ¯ Nezumi + StableSpineRenderer + BoundingBox çµ±åˆã‚·ã‚¹ãƒ†ãƒ èµ·å‹•"
        );

        // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        window.nezumiIntegration = new NezumiStableSpineBBIntegration();

        // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        window.debugNezumiSystem = () => {
          if (window.nezumiIntegration) {
            window.nezumiIntegration.showDebugInfo();
          }
        };
      });
    </script>
  </body>
</html>
