<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»•æ§˜æ›¸æº–æ‹  Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ - ã·ã‚‰ã£ã¨ãã‚“</title>
    <style>
        /* åŸºæœ¬ãƒªã‚»ãƒƒãƒˆ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #f0f0f0;
            font-family: Arial, sans-serif;
        }

        /* ğŸ”‘ é‡è¦ï¼šã‚·ãƒ¼ãƒ³ã‚³ãƒ³ãƒ†ãƒŠï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–åŸºæº–ï¼‰ */
        .scene-container {
            position: relative;           /* å­è¦ç´ ã®çµ¶å¯¾ä½ç½®åŸºæº– */
            width: 100%;                 /* ç”»é¢å¹…ã«åˆã‚ã›ã‚‹ */
            max-width: 1200px;           /* æœ€å¤§å¹…åˆ¶é™ */
            margin: 0 auto;              /* ä¸­å¤®å¯„ã› */
            background: white;           
            border-radius: 10px;         
            overflow: hidden;            /* ã¯ã¿å‡ºã—é˜²æ­¢ */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* ğŸ¯ é‡è¦ï¼šèƒŒæ™¯ç”»åƒï¼ˆåŸºæº–ã¨ãªã‚‹è¦ç´ ï¼‰ */
        .background-image {
            width: 100%;                 /* ã‚³ãƒ³ãƒ†ãƒŠå¹…ã«åˆã‚ã›ã‚‹ */
            height: auto;                /* ç¸¦æ¨ªæ¯”ç¶­æŒ */
            display: block;              /* inlineè¦ç´ ã®éš™é–“é™¤å» */
        }

        /* ğŸ® é‡è¦ï¼šSpineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”¨Canvasï¼ˆã·ã‚‰ã£ã¨ãã‚“ï¼‰ */
        #purattokun-canvas {
            position: absolute;          /* èƒŒæ™¯ç”»åƒä¸Šã«é‡ã­ã‚‹ */
            left: 35%;                   /* èƒŒæ™¯ç”»åƒåŸºæº–ã®ä½ç½®ï¼ˆèª¿æ•´å¯èƒ½ï¼‰ */
            top: 75%;                    /* èƒŒæ™¯ç”»åƒåŸºæº–ã®ä½ç½®ï¼ˆèª¿æ•´å¯èƒ½ï¼‰ */
            transform: translate(-50%, -50%); /* ä¸­å¤®å¯„ã› */
            width: 25%;                  /* ğŸ”‘ èƒŒæ™¯ç”»åƒã¨åŒã˜æ¯”ä¾‹æ‹¡ç¸® */
            aspect-ratio: 3/2;           /* ğŸ”‘ ç¸¦æ¨ªæ¯”å›ºå®šï¼ˆæ½°ã‚Œé˜²æ­¢ï¼‰ */
            z-index: 10;                 /* å‰é¢è¡¨ç¤º */
            display: none;               /* åˆæœŸã¯éè¡¨ç¤ºï¼ˆJSèª­ã¿è¾¼ã¿å¾Œã«è¡¨ç¤ºï¼‰ */
            cursor: pointer;             /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½è¡¨ç¤º */
            data-character-name: "purattokun"; /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è­˜åˆ¥ç”¨ */
        }

        /* ğŸ® é‡è¦ï¼šSpineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”¨Canvasï¼ˆã­ãšã¿ï¼‰ */
        #nezumi-canvas {
            position: absolute;
            left: 60%;
            top: 45%;
            transform: translate(-50%, -50%);
            width: 20%;
            aspect-ratio: 3/2;
            z-index: 11;
            display: none;
            cursor: pointer;
            data-character-name: "nezumi";
        }

        /* ğŸ’« ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒï¼ˆã·ã‚‰ã£ã¨ãã‚“ï¼‰ */
        #purattokun-fallback {
            position: absolute;          /* Canvasä½ç½®ã¨åŒæœŸ */
            left: 35%;                   /* Canvasã¨åŒã˜ä½ç½® */
            top: 75%;                    /* Canvasã¨åŒã˜ä½ç½® */
            transform: translate(-50%, -50%);
            width: 10%;                  /* ğŸ”‘ èƒŒæ™¯ç”»åƒã¨åŒã˜æ¯”ä¾‹æ‹¡ç¸® */
            aspect-ratio: 1/1;           /* æ­£æ–¹å½¢ç¶­æŒ */
            object-fit: contain;         /* ç”»åƒæ¯”ç‡ç¶­æŒ */
            z-index: 10;
            display: block;              /* åˆæœŸè¡¨ç¤ºï¼ˆSpineæˆåŠŸæ™‚ã«éè¡¨ç¤ºåŒ–ï¼‰ */
            cursor: pointer;
            data-character-name: "purattokun";
        }

        /* ğŸ’« ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒï¼ˆã­ãšã¿ï¼‰ */
        #nezumi-fallback {
            position: absolute;
            left: 60%;
            top: 45%;
            transform: translate(-50%, -50%);
            width: 8%;
            aspect-ratio: 1/1;
            object-fit: contain;
            z-index: 11;
            display: block;
            cursor: pointer;
            data-character-name: "nezumi";
        }
    </style>
</head>
<body>
    <div class="scene-container">
        <!-- èƒŒæ™¯ç”»åƒï¼ˆåŸºæº–ã¨ãªã‚‹è¦ç´ ï¼‰ -->
        <img src="assets/images/ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼TOP.png" alt="èƒŒæ™¯" class="background-image">
        
        <!-- Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆã·ã‚‰ã£ã¨ãã‚“ï¼‰ -->
        <canvas id="purattokun-canvas" width="300" height="200" data-spine-character="true" data-character-name="purattokun"></canvas>
        
        <!-- Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆã­ãšã¿ï¼‰ -->
        <canvas id="nezumi-canvas" width="300" height="200" data-spine-character="true" data-character-name="nezumi" style="
            position: absolute;
            left: 60%;
            top: 45%;
            transform: translate(-50%, -50%);
            width: 20%;
            aspect-ratio: 3/2;
            z-index: 11;
            display: none;
            cursor: pointer;
        "></canvas>
        
        <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒï¼ˆã·ã‚‰ã£ã¨ãã‚“ï¼‰ -->
        <img src="assets/images/purattokunn.png" alt="ã·ã‚‰ã£ã¨ãã‚“" id="purattokun-fallback" data-spine-character="true" data-character-name="purattokun">
        
        <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒï¼ˆã­ãšã¿ï¼‰ -->
        <img src="assets/images/nezumi.png" alt="ã­ãšã¿" id="nezumi-fallback" data-spine-character="true" data-character-name="nezumi" style="
            position: absolute;
            left: 60%;
            top: 45%;
            transform: translate(-50%, -50%);
            width: 8%;
            aspect-ratio: 1/1;
            object-fit: contain;
            z-index: 11;
            display: block;
            cursor: pointer;
        ">
    </div>

    <!-- Spine WebGL Runtime -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.24/dist/iife/spine-webgl.js"></script>
    
    <!-- SkeletonBoundså¢ƒç•Œãƒœãƒƒã‚¯ã‚¹ã‚·ã‚¹ãƒ†ãƒ  -->
    <!-- PureBoundingBox v5.0ã¨ã®ç«¶åˆã‚’é¿ã‘ã‚‹ãŸã‚ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ– -->
    <!-- <script src="assets/spine/spine-skeleton-bounds.js"></script> -->
    <!-- <script src="spine-bounds-integration.js"></script> -->
    
    <script>
        // ğŸ¯ URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ‰èµ·å‹•ï¼ˆ1è¡Œè¿½åŠ æ©Ÿèƒ½ï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const editMode = urlParams.get('edit') === 'true';

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã®å‹•çš„ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        if (editMode) {
            console.log('ğŸ¯ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰èµ·å‹•');
            
            // ç·¨é›†ã‚·ã‚¹ãƒ†ãƒ ç”¨CSSå‹•çš„èª­ã¿è¾¼ã¿
            const editCSS = document.createElement('link');
            editCSS.rel = 'stylesheet';
            editCSS.href = 'spine-positioning-system-explanation.css';
            document.head.appendChild(editCSS);
            
            // ğŸ¯ åˆ†å‰²ã•ã‚ŒãŸç·¨é›†ã‚·ã‚¹ãƒ†ãƒ ç”¨JSå‹•çš„èª­ã¿è¾¼ã¿
            const moduleFiles = [
                'spine-package-export.js',  // â† PackageExportSystemã‚’æœ€åˆã«èª­ã¿è¾¼ã¿
                'spine-ui-manager.js',
                'spine-multi-character-manager.js',
                // ğŸ¯ PureBoundingBox v5.0 ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ±åˆ
                'micromodules/experimental/bounding-box/PureBoundingBoxCore.js',
                'micromodules/experimental/bounding-box/PureBoundingBoxBounds.js',
                'micromodules/experimental/bounding-box/PureBoundingBoxUI.js',
                'micromodules/experimental/bounding-box/PureBoundingBoxEvents.js',
                'micromodules/experimental/bounding-box/PureBoundingBox.js',
                // 'spine-bounding-box-module.js', // â† æ—§ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’ç„¡åŠ¹åŒ–
                'spine-state-manager.js',
                'spine-layer-editor.js',
                'spine-debug-tools.js',
                'spine-positioning-main.js'
            ];
            
            let loadedModules = 0;
            const totalModules = moduleFiles.length;
            
            const loadModule = (src, index) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    loadedModules++;
                    console.log(`âœ… ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿å®Œäº†: ${src} (${loadedModules}/${totalModules})`);
                    
                    // å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿å®Œäº†æ™‚
                    if (loadedModules === totalModules) {
                        console.log('ğŸ¯ å…¨ç·¨é›†ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆæ–°ä¸­å¤®åˆ¶å¾¡çµ±åˆç‰ˆï¼‰');
                        console.log('ğŸ” ã‚·ã‚¹ãƒ†ãƒ ç¢ºèª:', {
                            // æ–°ã‚·ã‚¹ãƒ†ãƒ 
                            SpineEditController: typeof SpineEditController,
                            SpineEditIntegration: typeof SpineEditIntegration,
                            spineEditController: !!window.spineEditController,
                            spineEditIntegration: !!window.spineEditIntegration,
                            // çµ±åˆAPI
                            spineEditUnified: !!window.spineEditUnified,
                            // æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ 
                            initializeSpineEditSystem: typeof initializeSpineEditSystem,
                            createEditStartUI: typeof createEditStartUI,
                            SpineEditingSystem: typeof SpineEditingSystem
                        });
                        
                        // çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–å¾…æ©Ÿï¼ˆè‡ªå‹•åˆæœŸåŒ–ã•ã‚Œã‚‹ï¼‰
                        console.log('ğŸš€ v2.0ä¸­å¤®åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ çµ±åˆç‰ˆ æº–å‚™å®Œäº†');
                        console.log('ğŸ”— çµ±åˆå®Œäº†å¾Œã¯ window.spineEditUnified ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½');
                        
                        // PureBoundingBox v5.0èª­ã¿è¾¼ã¿ç¢ºèª
                        setTimeout(() => {
                            console.log('ğŸ¯ PureBoundingBox v5.0ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿çŠ¶æ³:');
                            console.log('  - PureBoundingBoxCore:', typeof window.PureBoundingBoxCore);
                            console.log('  - PureBoundingBoxBounds:', typeof window.PureBoundingBoxBounds);
                            console.log('  - PureBoundingBoxUI:', typeof window.PureBoundingBoxUI);
                            console.log('  - PureBoundingBoxEvents:', typeof window.PureBoundingBoxEvents);
                            console.log('  - PureBoundingBox:', typeof window.PureBoundingBox);
                            if (typeof window.PureBoundingBox !== 'undefined') {
                                console.log('âœ… PureBoundingBox v5.0 ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ±åˆå®Œäº†');
                            } else {
                                console.warn('âŒ PureBoundingBox v5.0 èª­ã¿è¾¼ã¿å¤±æ•— - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ ä½¿ç”¨');
                            }
                        }, 100);
                    }
                };
                script.onerror = () => {
                    console.warn(`âš ï¸ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—: ${src} - ç¶™ç¶šã—ã¾ã™`);
                    loadedModules++;
                };
                document.head.appendChild(script);
            };
            
            // é †æ¬¡èª­ã¿è¾¼ã¿
            moduleFiles.forEach((file, index) => {
                setTimeout(() => loadModule(file, index), index * 50); // 50msé–“éš”ã§é †æ¬¡èª­ã¿è¾¼ã¿
            });
        }

        // ğŸ¯ ãƒ¡ã‚¤ãƒ³ï¼šè¤‡æ•°Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ 
        const spineCharacters = {};
        
        // SkeletonBoundsçµ±åˆã‚·ã‚¹ãƒ†ãƒ ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let indexBoundsManager = null;
        
        /**
         * SkeletonBoundsã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
         */
        async function initializeBounds() {
            try {
                console.log('ğŸ”— SkeletonBoundsçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...');
                
                // IndexSkeletonBoundsManagerã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                if (typeof IndexSkeletonBoundsManager !== 'undefined') {
                    indexBoundsManager = new IndexSkeletonBoundsManager();
                    const initialized = await indexBoundsManager.initialize();
                    
                    if (initialized) {
                        console.log('âœ… SkeletonBoundsçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
                        return true;
                    } else {
                        console.warn('âš ï¸ SkeletonBoundsçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å¤±æ•—');
                        return false;
                    }
                } else {
                    console.warn('âš ï¸ IndexSkeletonBoundsManager ã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return false;
                }
            } catch (error) {
                console.error('âŒ SkeletonBoundsçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }
        
        /**
         * ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¥SkeletonBoundsçµ±åˆå‡¦ç†
         */
        function integrateBoundsForCharacter(characterId, characterData) {
            if (!indexBoundsManager) {
                console.warn(`âš ï¸ ${characterId}: SkeletonBoundsçµ±åˆã‚·ã‚¹ãƒ†ãƒ ãŒæœªåˆæœŸåŒ–`);
                return false;
            }
            
            try {
                return indexBoundsManager.integrateCharacter(characterId, characterData);
            } catch (error) {
                console.error(`âŒ ${characterId}: SkeletonBoundsçµ±åˆã‚¨ãƒ©ãƒ¼:`, error);
                return false;
            }
        }
        
        async function initSpineCharacters() {
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š
            const characterConfigs = [
                {
                    id: 'purattokun',
                    canvasId: 'purattokun-canvas',
                    fallbackId: 'purattokun-fallback',
                    basePath: './assets/spine/characters/purattokun/',
                    atlasFile: 'purattokun.atlas',
                    jsonFile: 'purattokun.json',
                    scale: 0.55,
                    positionY: -100,
                    clickConfig: {
                        centerX: 0.5, centerY: 0.6,
                        radiusX: 0.15, radiusY: 0.2,
                        showDebugArea: false
                    }
                },
                {
                    id: 'nezumi',
                    canvasId: 'nezumi-canvas',
                    fallbackId: 'nezumi-fallback',
                    basePath: './assets/spine/characters/nezumi/',
                    atlasFile: 'nezumi.atlas',
                    jsonFile: 'nezumi.json',
                    scale: 0.45,
                    positionY: -80,
                    clickConfig: {
                        centerX: 0.5, centerY: 0.6,
                        radiusX: 0.2, radiusY: 0.25,
                        showDebugArea: false
                    }
                }
            ];

            // Spine WebGLã®èª­ã¿è¾¼ã¿å¾…ã¡
            await waitForSpine();
            
            // SkeletonBoundsã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
            console.log('ğŸ”— SkeletonBoundsåˆæœŸåŒ–é–‹å§‹...');
            const boundsInitialized = await initializeBounds();
            console.log('ğŸ”— SkeletonBoundsåˆæœŸåŒ–çµæœ:', boundsInitialized);
            
            // å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä¸¦åˆ—åˆæœŸåŒ–
            const initPromises = characterConfigs.map(config => initSingleCharacter(config));
            await Promise.allSettled(initPromises);
            
            console.log('âœ… å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸåŒ–å®Œäº†');
            console.log('ğŸ¯ åˆ©ç”¨å¯èƒ½ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:', Object.keys(spineCharacters));
            console.log('ğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ•°:', Object.keys(spineCharacters).length);
            
            // SkeletonBoundsã¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’çµ±åˆ
            if (boundsInitialized) {
                console.log('ğŸ”— SkeletonBoundsçµ±åˆé–‹å§‹...');
                console.log('ğŸ”— çµ±åˆå¯¾è±¡ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:', Object.keys(spineCharacters));
                
                for (const characterId of Object.keys(spineCharacters)) {
                    const character = spineCharacters[characterId];
                    console.log(`ğŸ”— ${characterId} çµ±åˆå‡¦ç†é–‹å§‹:`, {
                        hasCanvas: !!character.canvas,
                        hasSkeleton: !!character.skeleton,
                        hasAnimationState: !!character.animationState
                    });
                    
                    // çµ±åˆç”¨ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ä½œæˆ
                    const characterData = {
                        canvas: character.canvas,
                        spine: {
                            skeleton: character.skeleton,
                            animationState: character.animationState
                        }
                    };
                    
                    console.log(`ğŸ”— ${characterId} integrateBoundsForCharacter å‘¼ã³å‡ºã—...`);
                    const integrated = integrateBoundsForCharacter(characterId, characterData);
                    console.log(`ğŸ”— ${characterId} çµ±åˆçµæœ:`, integrated);
                    
                    if (integrated) {
                        console.log(`âœ… ${characterId}: SkeletonBoundsçµ±åˆå®Œäº†`);
                    } else {
                        console.warn(`âš ï¸ ${characterId}: SkeletonBoundsçµ±åˆå¤±æ•—`);
                    }
                }
                
                console.log('ğŸ¯ SkeletonBoundsçµ±åˆå®Œäº† - å¢ƒç•Œãƒœãƒƒã‚¯ã‚¹æ©Ÿèƒ½æœ‰åŠ¹');
                console.log('ğŸ› ï¸ åˆ©ç”¨å¯èƒ½ãªãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½:');
                console.log('  - toggleBoundsDebug() : ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºON/OFF');
                console.log('  - showBoundsInfo(ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å) : å¢ƒç•Œãƒœãƒƒã‚¯ã‚¹æƒ…å ±è¡¨ç¤º');
                console.log('  - updateAllBounds() : å¢ƒç•Œãƒœãƒƒã‚¯ã‚¹æ›´æ–°');
            } else {
                console.warn('âš ï¸ SkeletonBoundsåˆæœŸåŒ–å¤±æ•— - çµ±åˆã‚¹ã‚­ãƒƒãƒ—');
            }
            
            // æ‰‹å‹•çµ±åˆãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¿½åŠ 
            window.manualIntegrationTest = function() {
                console.log('ğŸ”— æ‰‹å‹•çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹...');
                console.log('ğŸ¯ boundsManagerå­˜åœ¨:', !!window.boundsManager);
                console.log('ğŸ¯ spineSkeletonBoundså­˜åœ¨:', !!window.spineSkeletonBounds);
                console.log('ğŸ¯ spineCharacters:', Object.keys(spineCharacters));
                
                if (!window.boundsManager || !window.spineSkeletonBounds) {
                    console.error('âŒ boundsManagerã¾ãŸã¯spineSkeletonBoundsãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return false;
                }
                
                let successCount = 0;
                for (const characterId of Object.keys(spineCharacters)) {
                    const character = spineCharacters[characterId];
                    const characterData = {
                        canvas: character.canvas,
                        spine: {
                            skeleton: character.skeleton,
                            animationState: character.animationState
                        }
                    };
                    
                    console.log(`ğŸ”— æ‰‹å‹•çµ±åˆ: ${characterId}`);
                    const integrated = integrateBoundsForCharacter(characterId, characterData);
                    if (integrated) {
                        console.log(`âœ… æ‰‹å‹•çµ±åˆæˆåŠŸ: ${characterId}`);
                        successCount++;
                    } else {
                        console.warn(`âš ï¸ æ‰‹å‹•çµ±åˆå¤±æ•—: ${characterId}`);
                    }
                }
                
                console.log(`ğŸ¯ æ‰‹å‹•çµ±åˆçµæœ: ${successCount}/${Object.keys(spineCharacters).length}`);
                console.log('ğŸ¯ çµ±åˆå¾Œã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ•°:', Object.keys(window.boundsManager.characters || {}).length);
                return successCount > 0;
            };
            
            console.log('ğŸ› ï¸ æ‰‹å‹•çµ±åˆãƒ†ã‚¹ãƒˆæ©Ÿèƒ½è¿½åŠ å®Œäº†: window.manualIntegrationTest()');
            
            // UIãƒ‘ãƒãƒ«ã¯å‰Šé™¤æ¸ˆã¿ - ã‚·ãƒ³ãƒ—ãƒ«ãª2ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç’°å¢ƒ
        }

        async function initSingleCharacter(config) {
            try {
                console.log(`ğŸ¬ ${config.id}ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸåŒ–é–‹å§‹`);
                
                const canvas = document.getElementById(config.canvasId);
                const fallback = document.getElementById(config.fallbackId);
                
                if (!canvas || !fallback) {
                    throw new Error(`è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${config.canvasId} ã¾ãŸã¯ ${config.fallbackId}`);
                }

                const gl = canvas.getContext("webgl", { alpha: true });
                if (!gl) {
                    throw new Error("WebGLæœªå¯¾å¿œ");
                }

                // ã‚¢ã‚»ãƒƒãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
                const assetManager = new spine.AssetManager(gl, config.basePath);
                assetManager.loadTextureAtlas(config.atlasFile);
                assetManager.loadJson(config.jsonFile);

                await waitForAssets(assetManager);

                // Spineã‚¹ã‚±ãƒ«ãƒˆãƒ³æ§‹ç¯‰
                const atlas = assetManager.get(config.atlasFile);
                const atlasLoader = new spine.AtlasAttachmentLoader(atlas);
                const skeletonJson = new spine.SkeletonJson(atlasLoader);
                const skeletonData = skeletonJson.readSkeletonData(
                    assetManager.get(config.jsonFile)
                );

                const skeleton = new spine.Skeleton(skeletonData);
                
                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®è¨­å®š
                skeleton.x = 0;
                skeleton.y = config.positionY;
                skeleton.scaleX = skeleton.scaleY = config.scale;

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
                const animationStateData = new spine.AnimationStateData(skeleton.data);
                const animationState = new spine.AnimationState(animationStateData);

                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
                startDefaultAnimation(animationState, skeleton, config.id);

                // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼
                const renderer = new spine.SceneRenderer(canvas, gl);

                // æç”»ãƒ«ãƒ¼ãƒ—
                let lastTime = Date.now() / 1000;
                function render() {
                    const now = Date.now() / 1000;
                    const delta = now - lastTime;
                    lastTime = now;

                    animationState.update(delta);
                    animationState.apply(skeleton);
                    skeleton.updateWorldTransform();

                    gl.clearColor(0, 0, 0, 0);
                    gl.clear(gl.COLOR_BUFFER_BIT);
                    gl.viewport(0, 0, canvas.width, canvas.height);

                    renderer.begin();
                    renderer.drawSkeleton(skeleton, true);
                    renderer.end();

                    requestAnimationFrame(render);
                }
                render();

                // ã‚¯ãƒªãƒƒã‚¯ç¯„å›²è¨­å®š
                setupClickHandler(canvas, skeleton, animationState, config);

                // æˆåŠŸæ™‚ï¼šCanvasè¡¨ç¤ºã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯éè¡¨ç¤º
                canvas.style.display = "block";
                fallback.style.display = "none";

                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ã‚’ä¿å­˜
                spineCharacters[config.id] = {
                    canvas, fallback, skeleton, animationState, renderer, config,
                    animations: skeleton.data.animations.map(anim => anim.name)
                };

                console.log(`âœ… ${config.id}åˆæœŸåŒ–å®Œäº†`);
                console.log(`ğŸ“‹ ${config.id}åˆ©ç”¨å¯èƒ½ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³:`, spineCharacters[config.id].animations);

            } catch (error) {
                console.error(`âŒ ${config.id}åˆæœŸåŒ–å¤±æ•—:`, error);
            }
        }

        function startDefaultAnimation(animationState, skeleton, characterId) {
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
            let defaultAnimation = null;
            
            if (characterId === 'purattokun') {
                // ã·ã‚‰ã£ã¨ãã‚“: ç™»å ´â†’å¾…æ©Ÿã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹
                if (skeleton.data.findAnimation("syutugen") && skeleton.data.findAnimation("taiki")) {
                    console.log(`ğŸ¬ ${characterId}: syutugenï¼ˆç™»å ´ï¼‰â†’taikiï¼ˆå¾…æ©Ÿï¼‰ã‚·ãƒ¼ã‚±ãƒ³ã‚¹é–‹å§‹`);
                    animationState.setAnimation(0, "syutugen", false);
                    animationState.addAnimation(0, "taiki", true, 0);
                    return;
                } else if (skeleton.data.findAnimation("taiki")) {
                    defaultAnimation = "taiki";
                }
            } else if (characterId === 'nezumi') {
                // ã­ãšã¿: searchã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
                if (skeleton.data.findAnimation("search")) {
                    defaultAnimation = "search";
                } else if (skeleton.data.findAnimation("kettei")) {
                    defaultAnimation = "kettei";
                }
            }
            
            if (defaultAnimation) {
                console.log(`ğŸ¬ ${characterId}: ${defaultAnimation}ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹`);
                animationState.setAnimation(0, defaultAnimation, true);
            } else {
                console.log(`âš ï¸ ${characterId}: åˆ©ç”¨å¯èƒ½ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
            }
        }

        function setupClickHandler(canvas, skeleton, animationState, config) {
            const clickConfig = config.clickConfig;
            
            // ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒªã‚¢è¡¨ç¤º
            if (clickConfig.showDebugArea) {
                const debugArea = document.createElement('div');
                debugArea.style.cssText = `
                    position: absolute;
                    left: ${(clickConfig.centerX - clickConfig.radiusX) * 100}%;
                    top: ${(clickConfig.centerY - clickConfig.radiusY) * 100}%;
                    width: ${clickConfig.radiusX * 2 * 100}%;
                    height: ${clickConfig.radiusY * 2 * 100}%;
                    border: 2px dashed ${config.id === 'purattokun' ? 'red' : 'blue'};
                    background: rgba(${config.id === 'purattokun' ? '255, 0, 0' : '0, 0, 255'}, 0.1);
                    pointer-events: none;
                    z-index: 1000;
                `;
                canvas.parentElement.appendChild(debugArea);
            }

            const originalClickHandler = (event) => {
                const rect = canvas.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const clickY = event.clientY - rect.top;
                
                const normalizedX = clickX / rect.width;
                const normalizedY = clickY / rect.height;
                
                console.log(`ğŸ” ${config.id}ã‚¯ãƒªãƒƒã‚¯åº§æ¨™: (${normalizedX.toFixed(3)}, ${normalizedY.toFixed(3)})`);
                
                const deltaX = Math.abs(normalizedX - clickConfig.centerX);
                const deltaY = Math.abs(normalizedY - clickConfig.centerY);
                
                const inRangeX = deltaX <= clickConfig.radiusX;
                const inRangeY = deltaY <= clickConfig.radiusY;
                
                if (inRangeX && inRangeY) {
                    console.log(`ğŸ¯ ${config.id}ç¯„å›²å†…ãƒ’ãƒƒãƒˆ: Î”X=${deltaX.toFixed(3)}, Î”Y=${deltaY.toFixed(3)}`);
                    
                    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¥ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ
                    let clickAnimation = null;
                    
                    if (config.id === 'purattokun') {
                        // ã·ã‚‰ã£ã¨ãã‚“: yarareã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                        if (skeleton.data.findAnimation("yarare")) {
                            clickAnimation = "yarare";
                        } else if (skeleton.data.findAnimation("syutugen")) {
                            clickAnimation = "syutugen";
                        }
                    } else if (config.id === 'nezumi') {
                        // ã­ãšã¿: ketteiã¾ãŸã¯searchã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                        if (skeleton.data.findAnimation("kettei")) {
                            clickAnimation = "kettei";
                        } else if (skeleton.data.findAnimation("search")) {
                            clickAnimation = "search";
                        }
                    }
                    
                    if (clickAnimation) {
                        console.log(`ğŸ¯ ${config.id}: ${clickAnimation}ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹`);
                        animationState.setAnimation(0, clickAnimation, false);
                        
                        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã®å¾©å¸°è¨­å®š
                        const returnAnimation = skeleton.data.findAnimation("taiki") ? "taiki" : 
                                               (config.id === 'nezumi' && skeleton.data.findAnimation("search")) ? "search" : null;
                        
                        if (returnAnimation && clickAnimation !== returnAnimation) {
                            animationState.addAnimation(0, returnAnimation, true, 0);
                        }
                    } else {
                        console.log(`âš ï¸ ${config.id}: åˆ©ç”¨å¯èƒ½ãªã‚¯ãƒªãƒƒã‚¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                    }
                } else {
                    console.log(`ğŸ” ${config.id}ç¯„å›²å¤–: Î”X=${deltaX.toFixed(3)} (ä¸Šé™${clickConfig.radiusX}), Î”Y=${deltaY.toFixed(3)} (ä¸Šé™${clickConfig.radiusY})`);
                }
            };
            
            // ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’canvasè¦ç´ ã«ä¿å­˜ï¼ˆspine-bounds-integration.jsã§ä½¿ç”¨ï¼‰
            canvas.originalClickHandler = originalClickHandler;
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
            canvas.addEventListener("click", originalClickHandler);
        }

        // Spine WebGLã®èª­ã¿è¾¼ã¿å¾…ã¡
        async function waitForSpine() {
            return new Promise((resolve, reject) => {
                let checkCount = 0;
                const maxChecks = 50;

                const checkSpine = () => {
                    checkCount++;
                    if (typeof spine !== "undefined") {
                        console.log("âœ… Spine WebGLèª­ã¿è¾¼ã¿å®Œäº†");
                        resolve();
                    } else if (checkCount >= maxChecks) {
                        reject(new Error("Spine WebGLèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ"));
                    } else {
                        setTimeout(checkSpine, 100);
                    }
                };

                checkSpine();
            });
        }

        // ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å¾…ã¡
        async function waitForAssets(assetManager) {
            return new Promise((resolve, reject) => {
                let checkCount = 0;
                const maxChecks = 50;

                const checkAssets = () => {
                    checkCount++;
                    if (assetManager.isLoadingComplete()) {
                        console.log("âœ… ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å®Œäº†");
                        resolve();
                    } else if (checkCount >= maxChecks) {
                        reject(new Error("ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ"));
                    } else {
                        setTimeout(checkAssets, 100);
                    }
                };

                checkAssets();
            });
        }






        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”¨ãƒ‡ãƒãƒƒã‚°é–¢æ•°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
        window.spineDebug = {
            characters: spineCharacters,
            playAnimation: (characterId, animationName) => {
                const character = spineCharacters[characterId];
                if (character && character.skeleton.data.findAnimation(animationName)) {
                    character.animationState.setAnimation(0, animationName, animationName === 'taiki');
                    console.log(`ğŸ¬ ${characterId}: ${animationName} ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ`);
                } else {
                    console.warn(`âš ï¸ ${characterId}: ${animationName} ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                }
            },
            listAnimations: (characterId) => {
                const character = spineCharacters[characterId];
                if (character) {
                    console.log(`ğŸ“‹ ${characterId}åˆ©ç”¨å¯èƒ½ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³:`, character.animations);
                }
            }
        };

        // åˆæœŸåŒ–å®Ÿè¡Œ
        window.addEventListener("load", () => {
            setTimeout(initSpineCharacters, 500);
        });
    </script>
</body>
</html>