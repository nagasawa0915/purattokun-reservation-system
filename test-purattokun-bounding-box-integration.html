<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🐱 Purattokun + バウンディングボックス統合テスト</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-top: 10px;
        }
        
        .canvas-container {
            position: relative;
            width: 800px;
            height: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }
        
        #spine-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            min-width: 200px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #ffd700;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 8px 12px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .btn.success {
            background: rgba(76, 175, 80, 0.8);
        }
        
        .btn.danger {
            background: rgba(244, 67, 54, 0.8);
        }
        
        .log {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 5px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .status-label {
            color: #ccc;
        }
        
        .status-value {
            color: #ffd700;
            font-weight: bold;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffd700;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🐱 Purattokun + バウンディングボックス統合テスト</h1>
            <div class="subtitle">PureSpineLoader + PureBoundingBox マイクロモジュール統合システム（ぷらっとくん版）</div>
        </div>
        
        <div class="canvas-container">
            <canvas id="spine-canvas" width="300" height="200"></canvas>
        </div>
    </div>
    
    <div class="status" id="status-panel">
        <h3 style="margin: 0 0 10px 0; color: #ffd700;">📊 システム状態</h3>
        <div class="status-item">
            <span class="status-label">Purattokun読み込み:</span>
            <span class="status-value" id="purattokun-status">待機中</span>
        </div>
        <div class="status-item">
            <span class="status-label">バウンディングボックス:</span>
            <span class="status-value" id="bbox-status">待機中</span>
        </div>
        <div class="status-item">
            <span class="status-label">統合状態:</span>
            <span class="status-value" id="integration-status">準備中</span>
        </div>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <h3>🐱 Purattokun制御</h3>
            <button class="btn" id="load-purattokun">Purattokun読み込み</button>
            <button class="btn" id="play-animation">アニメーション再生</button>
        </div>
        
        <div class="control-group">
            <h3>📦 バウンディングボックス</h3>
            <button class="btn" id="create-bbox">バウンディングボックス作成</button>
            <button class="btn" id="toggle-bbox">表示切替</button>
            <button class="btn danger" id="cleanup-bbox">クリーンアップ</button>
        </div>
        
        <div class="control-group">
            <h3>🔧 統合制御</h3>
            <button class="btn success" id="full-integration">完全統合テスト</button>
            <button class="btn" id="reset-all">全リセット</button>
        </div>
    </div>
    
    <div class="log" id="log-panel">
        <div style="color: #ffd700; margin-bottom: 10px;">📝 システムログ</div>
    </div>
    
    <div class="loading" id="loading-screen">
        <div class="spinner"></div>
        <div>マイクロモジュール読み込み中...</div>
    </div>

    <!-- Spine WebGL（v4.1.24 CDN版 - index.html準拠） -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.24/dist/iife/spine-webgl.js"></script>
    
    <!-- マイクロモジュール（マニュアル準拠） -->
    <script src="micromodules/spine-loader/PureSpineLoader.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxCore.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxBounds.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxUI.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxEvents.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBox.js"></script>

    <script>
        // 🎯 安全なSpine初期化システム（v3.0マニュアル準拠）
        class SafeSpineInitializer {
            static async waitForSpine(maxWait = 10000) {
                const startTime = Date.now();
                
                while (Date.now() - startTime < maxWait) {
                    if (typeof spine !== 'undefined' && 
                        spine.Shader && 
                        spine.AssetManager) {
                        return true;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                throw new Error('Spine WebGL読み込みタイムアウト');
            }
            
            static async initialize() {
                try {
                    console.log('🔄 Spine WebGL読み込み待機中...');
                    await this.waitForSpine();
                    console.log('✅ Spine WebGL読み込み完了');
                    
                    // システム初期化実行
                    return new PurattokunBoundingBoxIntegration();
                    
                } catch (error) {
                    console.error('❌ Spine初期化失敗:', error);
                    this.showLoadingError(error.message);
                    return null;
                }
            }
            
            static showLoadingError(message) {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.innerHTML = `
                        <div style="text-align: center;">
                            <h3 style="color: #ff4444;">🚨 Spine WebGL読み込みエラー</h3>
                            <p>${message}</p>
                            <p>📝 対処方法:</p>
                            <ul style="text-align: left; display: inline-block;">
                                <li>ページを再読み込み</li>
                                <li>ブラウザキャッシュをクリア</li>
                                <li>ネットワーク接続確認</li>
                            </ul>
                            <button onclick="location.reload()" 
                                    style="background:#ffd700;color:#000;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;margin-top:15px;">
                                🔄 再読み込み
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // 🎯 Purattokun統合システムクラス（nezumi成功パターン準拠）
        class PurattokunBoundingBoxIntegration {
            constructor() {
                this.canvas = document.getElementById('spine-canvas');
                this.gl = null;
                this.shader = null;
                this.batcher = null;
                this.assetManager = null;
                this.skeleton = null;
                this.animationState = null;
                
                // マイクロモジュール
                this.spineLoader = null;
                this.boundingBox = null;
                
                // 状態管理
                this.purattokunLoaded = false;
                this.bboxCreated = false;
                this.integrationComplete = false;
                
                this.init();
            }
            
            async init() {
                this.log('🚀 統合システム初期化開始');
                
                try {
                    // WebGL初期化
                    await this.initWebGL();
                    
                    // マイクロモジュール初期化
                    await this.initMicromodules();
                    
                    // UI初期化
                    this.initUI();
                    
                    this.hideLoading();
                    this.log('✅ 初期化完了');
                    this.updateStatus('integration-status', '初期化完了');
                    
                } catch (error) {
                    this.log(`❌ 初期化エラー: ${error.message}`);
                    this.hideLoading();
                }
            }
            
            async initWebGL() {
                this.log('🎮 WebGL初期化中...');
                
                // 🎯 アルファ/透明度処理の詳細設定
                this.gl = this.canvas.getContext('webgl', { 
                    alpha: true, 
                    premultipliedAlpha: true,  // プリマルチプライアルファを有効化（index.html準拠）
                    antialias: true,           // アンチエイリアシング有効化
                    depth: false,              // デプステスト無効化
                    stencil: false             // ステンシルテスト無効化
                });
                if (!this.gl) {
                    throw new Error('WebGL未対応');
                }
                
                // 🎯 WebGLアルファ・ブレンド詳細設定
                this.gl.enable(this.gl.BLEND);
                
                // プリマルチプライアルファに適したブレンド設定
                this.gl.blendFuncSeparate(
                    this.gl.ONE, this.gl.ONE_MINUS_SRC_ALPHA,     // RGB用ブレンド
                    this.gl.ONE, this.gl.ONE_MINUS_SRC_ALPHA      // Alpha用ブレンド
                );
                
                // アルファテスト設定（透明度カットオフ）
                this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE);
                
                // 元の動作していた方式に戻す（シェーダー+バッチャー）
                this.shader = spine.Shader.newTwoColoredTextured(this.gl);
                this.batcher = new spine.PolygonBatcher(this.gl);
                
                // AssetManager初期化（index.html準拠 - basePathあり）
                this.assetManager = new spine.AssetManager(this.gl, '/assets/spine/characters/purattokun/');
                
                // 🎯 テクスチャフィルタリング設定の詳細調整
                this.setupTextureFiltering();
                
                this.log('✅ WebGL初期化完了（プリマルチプライアルファ対応+テクスチャフィルタリング）');
            }
            
            // 🎯 テクスチャフィルタリング詳細設定
            setupTextureFiltering() {
                this.log('🖼️ テクスチャフィルタリング設定中...');
                
                // WebGLコンテキストでテクスチャ設定をオーバーライド
                const originalBindTexture = this.gl.bindTexture.bind(this.gl);
                const originalTexParameteri = this.gl.texParameteri.bind(this.gl);
                
                this.gl.bindTexture = (target, texture) => {
                    const result = originalBindTexture(target, texture);
                    
                    if (target === this.gl.TEXTURE_2D && texture) {
                        // 🎯 テクスチャフィルタリング: NEAREST (ピクセルパーフェクト)
                        this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MIN_FILTER, this.gl.NEAREST);
                        this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MAG_FILTER, this.gl.NEAREST);
                        
                        // 🎯 テクスチャ境界処理: CLAMP_TO_EDGE (境界をクランプ)
                        this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_S, this.gl.CLAMP_TO_EDGE);
                        this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_T, this.gl.CLAMP_TO_EDGE);
                        
                        this.log('🎯 テクスチャパラメータ設定: NEAREST + CLAMP_TO_EDGE');
                    }
                    
                    return result;
                };
                
                this.log('✅ テクスチャフィルタリング設定完了');
            }
            
            async initMicromodules() {
                this.log('📦 マイクロモジュール初期化中...');
                
                // PureSpineLoader初期化（v3.0マニュアル準拠）
                if (typeof window.PureSpineLoader !== 'undefined') {
                    this.spineLoader = new window.PureSpineLoader({
                        basePath: '/assets/spine/characters/purattokun/',
                        atlasPath: '/assets/spine/characters/purattokun/purattokun.atlas',
                        jsonPath: '/assets/spine/characters/purattokun/purattokun.json',
                        scale: 1.0
                    });
                    this.log('✅ PureSpineLoader 初期化完了');
                } else {
                    this.log('⚠️ PureSpineLoader が見つかりません');
                }
                
                this.log('✅ マイクロモジュール初期化完了');
            }
            
            initUI() {
                this.log('🎨 UI初期化中...');
                
                // イベントリスナー設定
                document.getElementById('load-purattokun').addEventListener('click', () => this.loadPurattokun());
                document.getElementById('play-animation').addEventListener('click', () => this.playAnimation());
                document.getElementById('create-bbox').addEventListener('click', () => this.createBoundingBox());
                document.getElementById('toggle-bbox').addEventListener('click', () => this.toggleBoundingBox());
                document.getElementById('cleanup-bbox').addEventListener('click', () => this.cleanupBoundingBox());
                document.getElementById('full-integration').addEventListener('click', () => this.fullIntegrationTest());
                document.getElementById('reset-all').addEventListener('click', () => this.resetAll());
                
                this.log('✅ UI初期化完了');
            }
            
            async loadPurattokun() {
                this.log('🐱 Purattokun読み込み開始...');
                this.updateStatus('purattokun-status', '読み込み中');
                
                try {
                    // PureSpineLoaderによる検証的読み込み（v3.0マニュアル準拠）
                    if (this.spineLoader) {
                        const loaderResult = await this.spineLoader.execute();
                        this.log('📦 PureSpineLoader検証完了');
                    }
                    
                    // 直接AssetManagerによる実際の読み込み（index.html準拠 - 相対パス）
                    this.assetManager.loadText('purattokun.json');
                    this.assetManager.loadTextureAtlas('purattokun.atlas');
                    
                    // 読み込み完了を待機
                    const checkLoaded = () => {
                        if (this.assetManager.isLoadingComplete()) {
                            this.log('📚 アセット読み込み完了');
                            this.setupPurattokun();
                        } else {
                            setTimeout(checkLoaded, 100);
                        }
                    };
                    checkLoaded();
                    
                } catch (error) {
                    this.log(`❌ Purattokun読み込みエラー: ${error.message}`);
                    this.updateStatus('purattokun-status', '読み込み失敗');
                }
            }
            
            setupPurattokun() {
                try {
                    this.log('🎯 Purattokun Skeleton設定中...');
                    
                    // AtlasとSkeletonData読み込み（index.html準拠 - 相対パス）
                    const atlas = this.assetManager.get('purattokun.atlas');
                    const atlasLoader = new spine.AtlasAttachmentLoader(atlas);
                    const skeletonJson = new spine.SkeletonJson(atlasLoader);
                    const skeletonData = skeletonJson.readSkeletonData(this.assetManager.get('purattokun.json'));
                    
                    // Skeleton作成
                    this.skeleton = new spine.Skeleton(skeletonData);
                    
                    // 🎯 座標・スケール設定（元の位置に戻す）
                    this.skeleton.x = this.canvas.width / 2;
                    this.skeleton.y = this.canvas.height / 2;
                    this.skeleton.scaleX = this.skeleton.scaleY = 0.5;
                    
                    // AnimationState作成
                    const stateData = new spine.AnimationStateData(skeletonData);
                    this.animationState = new spine.AnimationState(stateData);
                    
                    // デフォルトアニメーション設定
                    if (skeletonData.animations && skeletonData.animations.length > 0) {
                        this.animationState.setAnimation(0, skeletonData.animations[0].name, true);
                    }
                    
                    // レンダラーは描画時に作成（元の方式）
                    
                    this.purattokunLoaded = true;
                    this.updateStatus('purattokun-status', '読み込み完了');
                    this.log('✅ Purattokun設定完了');
                    
                    // 描画開始
                    this.startRenderLoop();
                    
                } catch (error) {
                    this.log(`❌ Purattokun設定エラー: ${error.message}`);
                    this.updateStatus('purattokun-status', '設定失敗');
                }
            }
            
            startRenderLoop() {
                this.log('🎬 描画ループ開始');
                
                // index.html準拠のシンプル描画ループ
                let lastTime = Date.now() / 1000;
                
                const render = () => {
                    if (!this.purattokunLoaded) return;
                    
                    const now = Date.now() / 1000;
                    const deltaTime = now - lastTime;
                    lastTime = now;
                    
                    this.animationState.update(deltaTime);
                    this.animationState.apply(this.skeleton);
                    this.skeleton.updateWorldTransform();
                    
                    // 元の複雑な描画方式（動作確認済み）+ ブレンド設定
                    this.gl.clearColor(0, 0, 0, 0);
                    this.gl.clear(this.gl.COLOR_BUFFER_BIT);
                    
                    // WebGLブレンド設定（口パクの黒枠対策）
                    this.gl.enable(this.gl.BLEND);
                    this.gl.blendFunc(this.gl.SRC_ALPHA, this.gl.ONE_MINUS_SRC_ALPHA);
                    
                    // 描画設定
                    this.shader.bind();
                    this.shader.setUniformi(spine.Shader.SAMPLER, 0);
                    this.shader.setUniform4x4f(spine.Shader.MVP_MATRIX, 
                        this.createProjectionMatrix().values);
                    
                    // Skeleton描画
                    this.batcher.begin(this.shader);
                    const renderer = new spine.SkeletonRenderer(this.gl);
                    renderer.draw(this.batcher, this.skeleton);
                    this.batcher.end();
                    
                    this.shader.unbind();
                    
                    requestAnimationFrame(render);
                };
                
                requestAnimationFrame(render);
            }
            
            createProjectionMatrix() {
                const matrix = new spine.Matrix4();
                matrix.ortho2d(0, 0, this.canvas.width, this.canvas.height);
                return matrix;
            }
            
            async createBoundingBox() {
                this.log('📦 バウンディングボックス作成中...');
                this.updateStatus('bbox-status', '作成中');
                
                try {
                    if (!this.purattokunLoaded) {
                        this.log('⚠️ 先にPurattokunを読み込んでください');
                        return;
                    }
                    
                    // PureBoundingBox作成
                    this.boundingBox = new window.PureBoundingBox({
                        targetElement: this.canvas,
                        nodeId: 'purattokun-spine-canvas'
                    });
                    
                    // バウンディングボックス実行
                    const result = await this.boundingBox.execute({ visible: true });
                    
                    if (result.success) {
                        this.bboxCreated = true;
                        this.updateStatus('bbox-status', '作成完了');
                        this.log('✅ バウンディングボックス作成完了');
                        this.log(`📊 Bounds: ${JSON.stringify(result.bounds)}`);
                    } else {
                        this.log(`❌ バウンディングボックス作成失敗: ${result.error}`);
                        this.updateStatus('bbox-status', '作成失敗');
                    }
                    
                } catch (error) {
                    this.log(`❌ バウンディングボックスエラー: ${error.message}`);
                    this.updateStatus('bbox-status', 'エラー');
                }
            }
            
            toggleBoundingBox() {
                if (!this.boundingBox) {
                    this.log('⚠️ バウンディングボックスが作成されていません');
                    return;
                }
                
                const state = this.boundingBox.getState();
                if (state.bounds.visible) {
                    this.boundingBox.hide();
                    this.log('👻 バウンディングボックス非表示');
                } else {
                    this.boundingBox.show();
                    this.log('👁️ バウンディングボックス表示');
                }
            }
            
            cleanupBoundingBox() {
                if (!this.boundingBox) {
                    this.log('⚠️ バウンディングボックスが作成されていません');
                    return;
                }
                
                this.boundingBox.cleanup();
                this.boundingBox = null;
                this.bboxCreated = false;
                this.updateStatus('bbox-status', 'クリーンアップ完了');
                this.log('🧹 バウンディングボックスクリーンアップ完了');
            }
            
            playAnimation() {
                if (!this.purattokunLoaded || !this.skeleton) {
                    this.log('⚠️ Purattokunが読み込まれていません');
                    return;
                }
                
                const animations = this.skeleton.data.animations;
                if (animations && animations.length > 0) {
                    const randomAnim = animations[Math.floor(Math.random() * animations.length)];
                    this.animationState.setAnimation(0, randomAnim.name, false);
                    this.log(`🎭 アニメーション再生: ${randomAnim.name}`);
                } else {
                    this.log('⚠️ アニメーションが見つかりません');
                }
            }
            
            async fullIntegrationTest() {
                this.log('🚀 完全統合テスト開始');
                this.updateStatus('integration-status', 'テスト中');
                
                try {
                    // 1. Purattokun読み込み
                    if (!this.purattokunLoaded) {
                        await this.loadPurattokun();
                        await new Promise(resolve => setTimeout(resolve, 2000)); // 読み込み待機
                    }
                    
                    // 2. バウンディングボックス作成
                    if (!this.bboxCreated) {
                        await this.createBoundingBox();
                        await new Promise(resolve => setTimeout(resolve, 1000)); // 作成待機
                    }
                    
                    // 3. 統合確認
                    if (this.purattokunLoaded && this.bboxCreated) {
                        this.integrationComplete = true;
                        this.updateStatus('integration-status', '統合完了');
                        this.log('🎉 完全統合テスト成功！');
                        
                        // テストアニメーション
                        this.playAnimation();
                        
                        // バウンディングボックス表示確認
                        setTimeout(() => {
                            this.toggleBoundingBox();
                            this.log('📦 統合動作確認完了');
                        }, 1000);
                        
                    } else {
                        this.log('❌ 統合テスト失敗');
                        this.updateStatus('integration-status', 'テスト失敗');
                    }
                    
                } catch (error) {
                    this.log(`❌ 統合テストエラー: ${error.message}`);
                    this.updateStatus('integration-status', 'エラー');
                }
            }
            
            resetAll() {
                this.log('🔄 全リセット実行中...');
                
                // バウンディングボックスクリーンアップ
                if (this.boundingBox) {
                    this.cleanupBoundingBox();
                }
                
                // アニメーション停止
                if (this.animationState) {
                    this.animationState.clearTracks();
                }
                
                // 状態リセット
                this.purattokunLoaded = false;
                this.bboxCreated = false;
                this.integrationComplete = false;
                
                // ステータス更新
                this.updateStatus('purattokun-status', '待機中');
                this.updateStatus('bbox-status', '待機中');
                this.updateStatus('integration-status', 'リセット完了');
                
                this.log('✅ 全リセット完了');
            }
            
            log(message) {
                const logPanel = document.getElementById('log-panel');
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.style.marginBottom = '5px';
                logEntry.innerHTML = `<span style="color: #666">[${timestamp}]</span> ${message}`;
                logPanel.appendChild(logEntry);
                
                // スクロール調整
                logPanel.scrollTop = logPanel.scrollHeight;
                
                // コンソールにも出力
                console.log(`[PurattokunBoundingBox] ${message}`);
            }
            
            updateStatus(elementId, status) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = status;
                }
            }
            
            hideLoading() {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
            }
        }
        
        // 🚀 システム起動（v3.0マニュアル準拠・安全な初期化）
        window.addEventListener('load', async () => {
            console.log('🎯 Purattokun + BoundingBox 統合システム起動');
            
            // 少し遅延して確実にライブラリ読み込み完了を待つ
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Spine WebGL詳細診断（v3.0マニュアル準拠）
            function diagnoseSpineWebGL() {
                console.log('🔍 spine詳細構造:', typeof spine, Object.keys(spine || {}));
                if (spine) {
                    console.log('🔍 spine.webgl:', typeof spine.webgl);
                    if (spine.webgl) {
                        console.log('🔍 spine.webgl keys:', Object.keys(spine.webgl));
                    }
                }
                console.log('🔍 Spine WebGL診断開始');
                
                const checks = [
                    {
                        name: 'Spine Global Object',
                        test: () => typeof spine !== 'undefined',
                        fix: 'spine-webgl.jsファイルを確認'
                    },
                    {
                        name: 'Shader Class（直接アクセス）',
                        test: () => spine && spine.Shader,
                        fix: 'Shaderクラス確認'
                    },
                    {
                        name: 'AssetManager Class（直接アクセス）',
                        test: () => spine && spine.AssetManager,
                        fix: 'AssetManagerクラス確認'
                    },
                    {
                        name: 'PolygonBatcher Class',
                        test: () => spine && spine.PolygonBatcher,
                        fix: 'PolygonBatcherクラス確認'
                    }
                ];
                
                let allPassed = true;
                
                checks.forEach(check => {
                    const passed = check.test();
                    console.log(`${passed ? '✅' : '❌'} ${check.name}: ${passed ? 'OK' : check.fix}`);
                    if (!passed) allPassed = false;
                });
                
                if (allPassed) {
                    console.log('🎉 Spine WebGL診断完了 - 正常');
                } else {
                    console.log('🚨 Spine WebGL診断完了 - 問題あり');
                }
                
                return allPassed;
            }
            
            // 診断実行
            diagnoseSpineWebGL();
            
            // 安全な初期化実行
            window.integration = await SafeSpineInitializer.initialize();
        });
        
        // デバッグ用グローバル関数
        window.debugIntegration = () => {
            if (window.integration) {
                console.log('📊 統合システム状態:', {
                    purattokunLoaded: window.integration.purattokunLoaded,
                    bboxCreated: window.integration.bboxCreated,
                    integrationComplete: window.integration.integrationComplete,
                    skeleton: window.integration.skeleton,
                    boundingBox: window.integration.boundingBox
                });
            }
        };
    </script>
</body>
</html>