<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ± Purattokun + ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹çµ±åˆãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-top: 10px;
        }
        
        .canvas-container {
            position: relative;
            width: 800px;
            height: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }
        
        #spine-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            min-width: 200px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #ffd700;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 8px 12px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .btn.success {
            background: rgba(76, 175, 80, 0.8);
        }
        
        .btn.danger {
            background: rgba(244, 67, 54, 0.8);
        }
        
        .log {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 5px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .status-label {
            color: #ccc;
        }
        
        .status-value {
            color: #ffd700;
            font-weight: bold;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffd700;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ± Purattokun + ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹çµ±åˆãƒ†ã‚¹ãƒˆ</h1>
            <div class="subtitle">PureSpineLoader + PureBoundingBox ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ±åˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆã·ã‚‰ã£ã¨ãã‚“ç‰ˆï¼‰</div>
        </div>
        
        <div class="canvas-container">
            <canvas id="spine-canvas" width="300" height="200"></canvas>
        </div>
    </div>
    
    <div class="status" id="status-panel">
        <h3 style="margin: 0 0 10px 0; color: #ffd700;">ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
        <div class="status-item">
            <span class="status-label">Purattokunèª­ã¿è¾¼ã¿:</span>
            <span class="status-value" id="purattokun-status">å¾…æ©Ÿä¸­</span>
        </div>
        <div class="status-item">
            <span class="status-label">ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹:</span>
            <span class="status-value" id="bbox-status">å¾…æ©Ÿä¸­</span>
        </div>
        <div class="status-item">
            <span class="status-label">çµ±åˆçŠ¶æ…‹:</span>
            <span class="status-value" id="integration-status">æº–å‚™ä¸­</span>
        </div>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <h3>ğŸ± Purattokunåˆ¶å¾¡</h3>
            <button class="btn" id="load-purattokun">Purattokunèª­ã¿è¾¼ã¿</button>
            <button class="btn" id="play-animation">ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ</button>
        </div>
        
        <div class="control-group">
            <h3>ğŸ“¦ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹</h3>
            <button class="btn" id="create-bbox">ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½œæˆ</button>
            <button class="btn" id="toggle-bbox">è¡¨ç¤ºåˆ‡æ›¿</button>
            <button class="btn danger" id="cleanup-bbox">ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—</button>
        </div>
        
        <div class="control-group">
            <h3>ğŸ”§ çµ±åˆåˆ¶å¾¡</h3>
            <button class="btn success" id="full-integration">å®Œå…¨çµ±åˆãƒ†ã‚¹ãƒˆ</button>
            <button class="btn" id="reset-all">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>
    
    <div class="log" id="log-panel">
        <div style="color: #ffd700; margin-bottom: 10px;">ğŸ“ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</div>
    </div>
    
    <div class="loading" id="loading-screen">
        <div class="spinner"></div>
        <div>ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <!-- Spine WebGLï¼ˆv4.1.24 CDNç‰ˆ - index.htmlæº–æ‹ ï¼‰ -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.24/dist/iife/spine-webgl.js"></script>
    
    <!-- ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆãƒãƒ‹ãƒ¥ã‚¢ãƒ«æº–æ‹ ï¼‰ -->
    <script src="micromodules/spine-loader/PureSpineLoader.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxCore.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxBounds.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxUI.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxEvents.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBox.js"></script>

    <script>
        // ğŸ¯ å®‰å…¨ãªSpineåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ ï¼ˆv3.0ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æº–æ‹ ï¼‰
        class SafeSpineInitializer {
            static async waitForSpine(maxWait = 10000) {
                const startTime = Date.now();
                
                while (Date.now() - startTime < maxWait) {
                    if (typeof spine !== 'undefined' && 
                        spine.Shader && 
                        spine.AssetManager) {
                        return true;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                throw new Error('Spine WebGLèª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
            }
            
            static async initialize() {
                try {
                    console.log('ğŸ”„ Spine WebGLèª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­...');
                    await this.waitForSpine();
                    console.log('âœ… Spine WebGLèª­ã¿è¾¼ã¿å®Œäº†');
                    
                    // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Ÿè¡Œ
                    return new PurattokunBoundingBoxIntegration();
                    
                } catch (error) {
                    console.error('âŒ SpineåˆæœŸåŒ–å¤±æ•—:', error);
                    this.showLoadingError(error.message);
                    return null;
                }
            }
            
            static showLoadingError(message) {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.innerHTML = `
                        <div style="text-align: center;">
                            <h3 style="color: #ff4444;">ğŸš¨ Spine WebGLèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</h3>
                            <p>${message}</p>
                            <p>ğŸ“ å¯¾å‡¦æ–¹æ³•:</p>
                            <ul style="text-align: left; display: inline-block;">
                                <li>ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿</li>
                                <li>ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢</li>
                                <li>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šç¢ºèª</li>
                            </ul>
                            <button onclick="location.reload()" 
                                    style="background:#ffd700;color:#000;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;margin-top:15px;">
                                ğŸ”„ å†èª­ã¿è¾¼ã¿
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // ğŸ¯ Purattokunçµ±åˆã‚·ã‚¹ãƒ†ãƒ ã‚¯ãƒ©ã‚¹ï¼ˆnezumiæˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³æº–æ‹ ï¼‰
        class PurattokunBoundingBoxIntegration {
            constructor() {
                this.canvas = document.getElementById('spine-canvas');
                this.gl = null;
                this.shader = null;
                this.batcher = null;
                this.assetManager = null;
                this.skeleton = null;
                this.animationState = null;
                
                // ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
                this.spineLoader = null;
                this.boundingBox = null;
                
                // çŠ¶æ…‹ç®¡ç†
                this.purattokunLoaded = false;
                this.bboxCreated = false;
                this.integrationComplete = false;
                
                this.init();
            }
            
            async init() {
                this.log('ğŸš€ çµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
                
                try {
                    // WebGLåˆæœŸåŒ–
                    await this.initWebGL();
                    
                    // ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–
                    await this.initMicromodules();
                    
                    // UIåˆæœŸåŒ–
                    this.initUI();
                    
                    this.hideLoading();
                    this.log('âœ… åˆæœŸåŒ–å®Œäº†');
                    this.updateStatus('integration-status', 'åˆæœŸåŒ–å®Œäº†');
                    
                } catch (error) {
                    this.log(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    this.hideLoading();
                }
            }
            
            async initWebGL() {
                this.log('ğŸ® WebGLåˆæœŸåŒ–ä¸­...');
                
                // ğŸ¯ ã‚¢ãƒ«ãƒ•ã‚¡/é€æ˜åº¦å‡¦ç†ã®è©³ç´°è¨­å®š
                this.gl = this.canvas.getContext('webgl', { 
                    alpha: true, 
                    premultipliedAlpha: true,  // ãƒ—ãƒªãƒãƒ«ãƒãƒ—ãƒ©ã‚¤ã‚¢ãƒ«ãƒ•ã‚¡ã‚’æœ‰åŠ¹åŒ–ï¼ˆindex.htmlæº–æ‹ ï¼‰
                    antialias: true,           // ã‚¢ãƒ³ãƒã‚¨ã‚¤ãƒªã‚¢ã‚·ãƒ³ã‚°æœ‰åŠ¹åŒ–
                    depth: false,              // ãƒ‡ãƒ—ã‚¹ãƒ†ã‚¹ãƒˆç„¡åŠ¹åŒ–
                    stencil: false             // ã‚¹ãƒ†ãƒ³ã‚·ãƒ«ãƒ†ã‚¹ãƒˆç„¡åŠ¹åŒ–
                });
                if (!this.gl) {
                    throw new Error('WebGLæœªå¯¾å¿œ');
                }
                
                // ğŸ¯ WebGLã‚¢ãƒ«ãƒ•ã‚¡ãƒ»ãƒ–ãƒ¬ãƒ³ãƒ‰è©³ç´°è¨­å®š
                this.gl.enable(this.gl.BLEND);
                
                // ãƒ—ãƒªãƒãƒ«ãƒãƒ—ãƒ©ã‚¤ã‚¢ãƒ«ãƒ•ã‚¡ã«é©ã—ãŸãƒ–ãƒ¬ãƒ³ãƒ‰è¨­å®š
                this.gl.blendFuncSeparate(
                    this.gl.ONE, this.gl.ONE_MINUS_SRC_ALPHA,     // RGBç”¨ãƒ–ãƒ¬ãƒ³ãƒ‰
                    this.gl.ONE, this.gl.ONE_MINUS_SRC_ALPHA      // Alphaç”¨ãƒ–ãƒ¬ãƒ³ãƒ‰
                );
                
                // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ†ã‚¹ãƒˆè¨­å®šï¼ˆé€æ˜åº¦ã‚«ãƒƒãƒˆã‚ªãƒ•ï¼‰
                this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE);
                
                // å…ƒã®å‹•ä½œã—ã¦ã„ãŸæ–¹å¼ã«æˆ»ã™ï¼ˆã‚·ã‚§ãƒ¼ãƒ€ãƒ¼+ãƒãƒƒãƒãƒ£ãƒ¼ï¼‰
                this.shader = spine.Shader.newTwoColoredTextured(this.gl);
                this.batcher = new spine.PolygonBatcher(this.gl);
                
                // AssetManageråˆæœŸåŒ–ï¼ˆindex.htmlæº–æ‹  - basePathã‚ã‚Šï¼‰
                this.assetManager = new spine.AssetManager(this.gl, '/assets/spine/characters/purattokun/');
                
                // ğŸ¯ ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°è¨­å®šã®è©³ç´°èª¿æ•´
                this.setupTextureFiltering();
                
                this.log('âœ… WebGLåˆæœŸåŒ–å®Œäº†ï¼ˆãƒ—ãƒªãƒãƒ«ãƒãƒ—ãƒ©ã‚¤ã‚¢ãƒ«ãƒ•ã‚¡å¯¾å¿œ+ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰');
            }
            
            // ğŸ¯ ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°è©³ç´°è¨­å®š
            setupTextureFiltering() {
                this.log('ğŸ–¼ï¸ ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°è¨­å®šä¸­...');
                
                // WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ãƒ†ã‚¯ã‚¹ãƒãƒ£è¨­å®šã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
                const originalBindTexture = this.gl.bindTexture.bind(this.gl);
                const originalTexParameteri = this.gl.texParameteri.bind(this.gl);
                
                this.gl.bindTexture = (target, texture) => {
                    const result = originalBindTexture(target, texture);
                    
                    if (target === this.gl.TEXTURE_2D && texture) {
                        // ğŸ¯ ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°: NEAREST (ãƒ”ã‚¯ã‚»ãƒ«ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆ)
                        this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MIN_FILTER, this.gl.NEAREST);
                        this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MAG_FILTER, this.gl.NEAREST);
                        
                        // ğŸ¯ ãƒ†ã‚¯ã‚¹ãƒãƒ£å¢ƒç•Œå‡¦ç†: CLAMP_TO_EDGE (å¢ƒç•Œã‚’ã‚¯ãƒ©ãƒ³ãƒ—)
                        this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_S, this.gl.CLAMP_TO_EDGE);
                        this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_T, this.gl.CLAMP_TO_EDGE);
                        
                        this.log('ğŸ¯ ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š: NEAREST + CLAMP_TO_EDGE');
                    }
                    
                    return result;
                };
                
                this.log('âœ… ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°è¨­å®šå®Œäº†');
            }
            
            async initMicromodules() {
                this.log('ğŸ“¦ ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–ä¸­...');
                
                // PureSpineLoaderåˆæœŸåŒ–ï¼ˆv3.0ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æº–æ‹ ï¼‰
                if (typeof window.PureSpineLoader !== 'undefined') {
                    this.spineLoader = new window.PureSpineLoader({
                        basePath: '/assets/spine/characters/purattokun/',
                        atlasPath: '/assets/spine/characters/purattokun/purattokun.atlas',
                        jsonPath: '/assets/spine/characters/purattokun/purattokun.json',
                        scale: 1.0
                    });
                    this.log('âœ… PureSpineLoader åˆæœŸåŒ–å®Œäº†');
                } else {
                    this.log('âš ï¸ PureSpineLoader ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                this.log('âœ… ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–å®Œäº†');
            }
            
            initUI() {
                this.log('ğŸ¨ UIåˆæœŸåŒ–ä¸­...');
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                document.getElementById('load-purattokun').addEventListener('click', () => this.loadPurattokun());
                document.getElementById('play-animation').addEventListener('click', () => this.playAnimation());
                document.getElementById('create-bbox').addEventListener('click', () => this.createBoundingBox());
                document.getElementById('toggle-bbox').addEventListener('click', () => this.toggleBoundingBox());
                document.getElementById('cleanup-bbox').addEventListener('click', () => this.cleanupBoundingBox());
                document.getElementById('full-integration').addEventListener('click', () => this.fullIntegrationTest());
                document.getElementById('reset-all').addEventListener('click', () => this.resetAll());
                
                this.log('âœ… UIåˆæœŸåŒ–å®Œäº†');
            }
            
            async loadPurattokun() {
                this.log('ğŸ± Purattokunèª­ã¿è¾¼ã¿é–‹å§‹...');
                this.updateStatus('purattokun-status', 'èª­ã¿è¾¼ã¿ä¸­');
                
                try {
                    // PureSpineLoaderã«ã‚ˆã‚‹æ¤œè¨¼çš„èª­ã¿è¾¼ã¿ï¼ˆv3.0ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æº–æ‹ ï¼‰
                    if (this.spineLoader) {
                        const loaderResult = await this.spineLoader.execute();
                        this.log('ğŸ“¦ PureSpineLoaderæ¤œè¨¼å®Œäº†');
                    }
                    
                    // ç›´æ¥AssetManagerã«ã‚ˆã‚‹å®Ÿéš›ã®èª­ã¿è¾¼ã¿ï¼ˆindex.htmlæº–æ‹  - ç›¸å¯¾ãƒ‘ã‚¹ï¼‰
                    this.assetManager.loadText('purattokun.json');
                    this.assetManager.loadTextureAtlas('purattokun.atlas');
                    
                    // èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…æ©Ÿ
                    const checkLoaded = () => {
                        if (this.assetManager.isLoadingComplete()) {
                            this.log('ğŸ“š ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
                            this.setupPurattokun();
                        } else {
                            setTimeout(checkLoaded, 100);
                        }
                    };
                    checkLoaded();
                    
                } catch (error) {
                    this.log(`âŒ Purattokunèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    this.updateStatus('purattokun-status', 'èª­ã¿è¾¼ã¿å¤±æ•—');
                }
            }
            
            setupPurattokun() {
                try {
                    this.log('ğŸ¯ Purattokun Skeletonè¨­å®šä¸­...');
                    
                    // Atlasã¨SkeletonDataèª­ã¿è¾¼ã¿ï¼ˆindex.htmlæº–æ‹  - ç›¸å¯¾ãƒ‘ã‚¹ï¼‰
                    const atlas = this.assetManager.get('purattokun.atlas');
                    const atlasLoader = new spine.AtlasAttachmentLoader(atlas);
                    const skeletonJson = new spine.SkeletonJson(atlasLoader);
                    const skeletonData = skeletonJson.readSkeletonData(this.assetManager.get('purattokun.json'));
                    
                    // Skeletonä½œæˆ
                    this.skeleton = new spine.Skeleton(skeletonData);
                    
                    // ğŸ¯ åº§æ¨™ãƒ»ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®šï¼ˆå…ƒã®ä½ç½®ã«æˆ»ã™ï¼‰
                    this.skeleton.x = this.canvas.width / 2;
                    this.skeleton.y = this.canvas.height / 2;
                    this.skeleton.scaleX = this.skeleton.scaleY = 0.5;
                    
                    // AnimationStateä½œæˆ
                    const stateData = new spine.AnimationStateData(skeletonData);
                    this.animationState = new spine.AnimationState(stateData);
                    
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
                    if (skeletonData.animations && skeletonData.animations.length > 0) {
                        this.animationState.setAnimation(0, skeletonData.animations[0].name, true);
                    }
                    
                    // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã¯æç”»æ™‚ã«ä½œæˆï¼ˆå…ƒã®æ–¹å¼ï¼‰
                    
                    this.purattokunLoaded = true;
                    this.updateStatus('purattokun-status', 'èª­ã¿è¾¼ã¿å®Œäº†');
                    this.log('âœ… Purattokunè¨­å®šå®Œäº†');
                    
                    // æç”»é–‹å§‹
                    this.startRenderLoop();
                    
                } catch (error) {
                    this.log(`âŒ Purattokunè¨­å®šã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    this.updateStatus('purattokun-status', 'è¨­å®šå¤±æ•—');
                }
            }
            
            startRenderLoop() {
                this.log('ğŸ¬ æç”»ãƒ«ãƒ¼ãƒ—é–‹å§‹');
                
                // index.htmlæº–æ‹ ã®ã‚·ãƒ³ãƒ—ãƒ«æç”»ãƒ«ãƒ¼ãƒ—
                let lastTime = Date.now() / 1000;
                
                const render = () => {
                    if (!this.purattokunLoaded) return;
                    
                    const now = Date.now() / 1000;
                    const deltaTime = now - lastTime;
                    lastTime = now;
                    
                    this.animationState.update(deltaTime);
                    this.animationState.apply(this.skeleton);
                    this.skeleton.updateWorldTransform();
                    
                    // å…ƒã®è¤‡é›‘ãªæç”»æ–¹å¼ï¼ˆå‹•ä½œç¢ºèªæ¸ˆã¿ï¼‰+ ãƒ–ãƒ¬ãƒ³ãƒ‰è¨­å®š
                    this.gl.clearColor(0, 0, 0, 0);
                    this.gl.clear(this.gl.COLOR_BUFFER_BIT);
                    
                    // WebGLãƒ–ãƒ¬ãƒ³ãƒ‰è¨­å®šï¼ˆå£ãƒ‘ã‚¯ã®é»’æ å¯¾ç­–ï¼‰
                    this.gl.enable(this.gl.BLEND);
                    this.gl.blendFunc(this.gl.SRC_ALPHA, this.gl.ONE_MINUS_SRC_ALPHA);
                    
                    // æç”»è¨­å®š
                    this.shader.bind();
                    this.shader.setUniformi(spine.Shader.SAMPLER, 0);
                    this.shader.setUniform4x4f(spine.Shader.MVP_MATRIX, 
                        this.createProjectionMatrix().values);
                    
                    // Skeletonæç”»
                    this.batcher.begin(this.shader);
                    const renderer = new spine.SkeletonRenderer(this.gl);
                    renderer.draw(this.batcher, this.skeleton);
                    this.batcher.end();
                    
                    this.shader.unbind();
                    
                    requestAnimationFrame(render);
                };
                
                requestAnimationFrame(render);
            }
            
            createProjectionMatrix() {
                const matrix = new spine.Matrix4();
                matrix.ortho2d(0, 0, this.canvas.width, this.canvas.height);
                return matrix;
            }
            
            async createBoundingBox() {
                this.log('ğŸ“¦ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½œæˆä¸­...');
                this.updateStatus('bbox-status', 'ä½œæˆä¸­');
                
                try {
                    if (!this.purattokunLoaded) {
                        this.log('âš ï¸ å…ˆã«Purattokunã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
                        return;
                    }
                    
                    // PureBoundingBoxä½œæˆ
                    this.boundingBox = new window.PureBoundingBox({
                        targetElement: this.canvas,
                        nodeId: 'purattokun-spine-canvas'
                    });
                    
                    // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹å®Ÿè¡Œ
                    const result = await this.boundingBox.execute({ visible: true });
                    
                    if (result.success) {
                        this.bboxCreated = true;
                        this.updateStatus('bbox-status', 'ä½œæˆå®Œäº†');
                        this.log('âœ… ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½œæˆå®Œäº†');
                        this.log(`ğŸ“Š Bounds: ${JSON.stringify(result.bounds)}`);
                    } else {
                        this.log(`âŒ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½œæˆå¤±æ•—: ${result.error}`);
                        this.updateStatus('bbox-status', 'ä½œæˆå¤±æ•—');
                    }
                    
                } catch (error) {
                    this.log(`âŒ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    this.updateStatus('bbox-status', 'ã‚¨ãƒ©ãƒ¼');
                }
            }
            
            toggleBoundingBox() {
                if (!this.boundingBox) {
                    this.log('âš ï¸ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                const state = this.boundingBox.getState();
                if (state.bounds.visible) {
                    this.boundingBox.hide();
                    this.log('ğŸ‘» ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹éè¡¨ç¤º');
                } else {
                    this.boundingBox.show();
                    this.log('ğŸ‘ï¸ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤º');
                }
            }
            
            cleanupBoundingBox() {
                if (!this.boundingBox) {
                    this.log('âš ï¸ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                this.boundingBox.cleanup();
                this.boundingBox = null;
                this.bboxCreated = false;
                this.updateStatus('bbox-status', 'ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
                this.log('ğŸ§¹ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
            }
            
            playAnimation() {
                if (!this.purattokunLoaded || !this.skeleton) {
                    this.log('âš ï¸ PurattokunãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                const animations = this.skeleton.data.animations;
                if (animations && animations.length > 0) {
                    const randomAnim = animations[Math.floor(Math.random() * animations.length)];
                    this.animationState.setAnimation(0, randomAnim.name, false);
                    this.log(`ğŸ­ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ: ${randomAnim.name}`);
                } else {
                    this.log('âš ï¸ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            }
            
            async fullIntegrationTest() {
                this.log('ğŸš€ å®Œå…¨çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹');
                this.updateStatus('integration-status', 'ãƒ†ã‚¹ãƒˆä¸­');
                
                try {
                    // 1. Purattokunèª­ã¿è¾¼ã¿
                    if (!this.purattokunLoaded) {
                        await this.loadPurattokun();
                        await new Promise(resolve => setTimeout(resolve, 2000)); // èª­ã¿è¾¼ã¿å¾…æ©Ÿ
                    }
                    
                    // 2. ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½œæˆ
                    if (!this.bboxCreated) {
                        await this.createBoundingBox();
                        await new Promise(resolve => setTimeout(resolve, 1000)); // ä½œæˆå¾…æ©Ÿ
                    }
                    
                    // 3. çµ±åˆç¢ºèª
                    if (this.purattokunLoaded && this.bboxCreated) {
                        this.integrationComplete = true;
                        this.updateStatus('integration-status', 'çµ±åˆå®Œäº†');
                        this.log('ğŸ‰ å®Œå…¨çµ±åˆãƒ†ã‚¹ãƒˆæˆåŠŸï¼');
                        
                        // ãƒ†ã‚¹ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                        this.playAnimation();
                        
                        // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºç¢ºèª
                        setTimeout(() => {
                            this.toggleBoundingBox();
                            this.log('ğŸ“¦ çµ±åˆå‹•ä½œç¢ºèªå®Œäº†');
                        }, 1000);
                        
                    } else {
                        this.log('âŒ çµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•—');
                        this.updateStatus('integration-status', 'ãƒ†ã‚¹ãƒˆå¤±æ•—');
                    }
                    
                } catch (error) {
                    this.log(`âŒ çµ±åˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    this.updateStatus('integration-status', 'ã‚¨ãƒ©ãƒ¼');
                }
            }
            
            resetAll() {
                this.log('ğŸ”„ å…¨ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œä¸­...');
                
                // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                if (this.boundingBox) {
                    this.cleanupBoundingBox();
                }
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢
                if (this.animationState) {
                    this.animationState.clearTracks();
                }
                
                // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
                this.purattokunLoaded = false;
                this.bboxCreated = false;
                this.integrationComplete = false;
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                this.updateStatus('purattokun-status', 'å¾…æ©Ÿä¸­');
                this.updateStatus('bbox-status', 'å¾…æ©Ÿä¸­');
                this.updateStatus('integration-status', 'ãƒªã‚»ãƒƒãƒˆå®Œäº†');
                
                this.log('âœ… å…¨ãƒªã‚»ãƒƒãƒˆå®Œäº†');
            }
            
            log(message) {
                const logPanel = document.getElementById('log-panel');
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.style.marginBottom = '5px';
                logEntry.innerHTML = `<span style="color: #666">[${timestamp}]</span> ${message}`;
                logPanel.appendChild(logEntry);
                
                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«èª¿æ•´
                logPanel.scrollTop = logPanel.scrollHeight;
                
                // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
                console.log(`[PurattokunBoundingBox] ${message}`);
            }
            
            updateStatus(elementId, status) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = status;
                }
            }
            
            hideLoading() {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
            }
        }
        
        // ğŸš€ ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ï¼ˆv3.0ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æº–æ‹ ãƒ»å®‰å…¨ãªåˆæœŸåŒ–ï¼‰
        window.addEventListener('load', async () => {
            console.log('ğŸ¯ Purattokun + BoundingBox çµ±åˆã‚·ã‚¹ãƒ†ãƒ èµ·å‹•');
            
            // å°‘ã—é…å»¶ã—ã¦ç¢ºå®Ÿã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Spine WebGLè©³ç´°è¨ºæ–­ï¼ˆv3.0ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æº–æ‹ ï¼‰
            function diagnoseSpineWebGL() {
                console.log('ğŸ” spineè©³ç´°æ§‹é€ :', typeof spine, Object.keys(spine || {}));
                if (spine) {
                    console.log('ğŸ” spine.webgl:', typeof spine.webgl);
                    if (spine.webgl) {
                        console.log('ğŸ” spine.webgl keys:', Object.keys(spine.webgl));
                    }
                }
                console.log('ğŸ” Spine WebGLè¨ºæ–­é–‹å§‹');
                
                const checks = [
                    {
                        name: 'Spine Global Object',
                        test: () => typeof spine !== 'undefined',
                        fix: 'spine-webgl.jsãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª'
                    },
                    {
                        name: 'Shader Classï¼ˆç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ï¼‰',
                        test: () => spine && spine.Shader,
                        fix: 'Shaderã‚¯ãƒ©ã‚¹ç¢ºèª'
                    },
                    {
                        name: 'AssetManager Classï¼ˆç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ï¼‰',
                        test: () => spine && spine.AssetManager,
                        fix: 'AssetManagerã‚¯ãƒ©ã‚¹ç¢ºèª'
                    },
                    {
                        name: 'PolygonBatcher Class',
                        test: () => spine && spine.PolygonBatcher,
                        fix: 'PolygonBatcherã‚¯ãƒ©ã‚¹ç¢ºèª'
                    }
                ];
                
                let allPassed = true;
                
                checks.forEach(check => {
                    const passed = check.test();
                    console.log(`${passed ? 'âœ…' : 'âŒ'} ${check.name}: ${passed ? 'OK' : check.fix}`);
                    if (!passed) allPassed = false;
                });
                
                if (allPassed) {
                    console.log('ğŸ‰ Spine WebGLè¨ºæ–­å®Œäº† - æ­£å¸¸');
                } else {
                    console.log('ğŸš¨ Spine WebGLè¨ºæ–­å®Œäº† - å•é¡Œã‚ã‚Š');
                }
                
                return allPassed;
            }
            
            // è¨ºæ–­å®Ÿè¡Œ
            diagnoseSpineWebGL();
            
            // å®‰å…¨ãªåˆæœŸåŒ–å®Ÿè¡Œ
            window.integration = await SafeSpineInitializer.initialize();
        });
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        window.debugIntegration = () => {
            if (window.integration) {
                console.log('ğŸ“Š çµ±åˆã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹:', {
                    purattokunLoaded: window.integration.purattokunLoaded,
                    bboxCreated: window.integration.bboxCreated,
                    integrationComplete: window.integration.integrationComplete,
                    skeleton: window.integration.skeleton,
                    boundingBox: window.integration.boundingBox
                });
            }
        };
    </script>
</body>
</html>