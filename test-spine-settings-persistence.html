<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpineSettingsPersistence テスト</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-section h2 {
            color: #333;
            border-bottom: 2px solid #007acc;
            padding-bottom: 10px;
        }
        
        .control-group {
            margin: 15px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .control-group input {
            width: 100px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin-right: 10px;
        }
        
        .btn-group {
            margin: 20px 0;
        }
        
        .btn {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007acc;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #005999;
        }
        
        .btn.secondary {
            background: #6c757d;
        }
        
        .btn.danger {
            background: #dc3545;
        }
        
        .btn.success {
            background: #28a745;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .status.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .status.info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        
        .log-container {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .character-selector {
            margin: 10px 0;
        }
        
        .character-selector select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>🎯 SpineSettingsPersistence マイクロモジュール テスト</h1>
    
    <!-- 基本機能テスト -->
    <div class="test-section">
        <h2>📋 基本機能テスト</h2>
        
        <div class="character-selector">
            <label>テスト対象キャラクター:</label>
            <select id="characterSelect">
                <option value="nezumi">nezumi (ネズミ)</option>
                <option value="purattokun">purattokun (ぷらっとくん)</option>
                <option value="testCharacter">testCharacter (テスト用)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>X軸スケール:</label>
            <input type="number" id="scaleX" value="1.0" step="0.1" min="0.1" max="5.0">
            
            <label>Y軸スケール:</label>
            <input type="number" id="scaleY" value="1.0" step="0.1" min="0.1" max="5.0">
            
            <label>X座標:</label>
            <input type="number" id="positionX" value="0" step="10">
            
            <label>Y座標:</label>
            <input type="number" id="positionY" value="0" step="10">
            
            <label>Canvasサイズ:</label>
            <input type="number" id="canvasSize" value="800" step="50" min="100" max="1200">
        </div>
        
        <div class="btn-group">
            <button class="btn" onclick="testSave()">💾 設定保存</button>
            <button class="btn secondary" onclick="testRestore()">📂 設定復元</button>
            <button class="btn danger" onclick="testClear()">🗑️ 設定削除</button>
            <button class="btn" onclick="testExists()">🔍 存在確認</button>
        </div>
        
        <div id="basicTestStatus" class="status info">
            テスト結果がここに表示されます
        </div>
    </div>
    
    <!-- 高度機能テスト -->
    <div class="test-section">
        <h2>🚀 高度機能テスト</h2>
        
        <div class="btn-group">
            <button class="btn" onclick="testGetAllSettings()">📋 全設定取得</button>
            <button class="btn secondary" onclick="testValidation()">✅ バリデーションテスト</button>
            <button class="btn" onclick="testCapacityCheck()">💾 容量チェック</button>
            <button class="btn success" onclick="persistence.debug()">🔧 デバッグ情報</button>
        </div>
        
        <div id="advancedTestStatus" class="status info">
            高度機能テスト結果がここに表示されます
        </div>
    </div>
    
    <!-- ログ表示 -->
    <div class="test-section">
        <h2>📋 実行ログ</h2>
        <button class="btn secondary" onclick="clearLog()">🧹 ログクリア</button>
        <div id="logContainer" class="log-container">
            SpineSettingsPersistence テスト開始...\n
        </div>
    </div>

    <script src="./micromodules/spine-settings-persistence/SpineSettingsPersistence.js"></script>
    <script>
        // SpineSettingsPersistence インスタンス作成（デバッグモード有効）
        const persistence = new SpineSettingsPersistence({
            debug: true,
            version: '1.0'
        });
        
        // ログ表示関数
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // ステータス表示関数
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }
        
        // 選択されたキャラクターID取得
        function getSelectedCharacter() {
            return document.getElementById('characterSelect').value;
        }
        
        // 入力値から設定オブジェクト作成
        function getSettingsFromInputs() {
            return {
                scaleX: parseFloat(document.getElementById('scaleX').value),
                scaleY: parseFloat(document.getElementById('scaleY').value),
                positionX: parseFloat(document.getElementById('positionX').value),
                positionY: parseFloat(document.getElementById('positionY').value),
                canvasSize: parseInt(document.getElementById('canvasSize').value)
            };
        }
        
        // 設定を入力フィールドに反映
        function applySettingsToInputs(settings) {
            if (settings) {
                document.getElementById('scaleX').value = settings.scaleX || 1.0;
                document.getElementById('scaleY').value = settings.scaleY || 1.0;
                document.getElementById('positionX').value = settings.positionX || 0;
                document.getElementById('positionY').value = settings.positionY || 0;
                document.getElementById('canvasSize').value = settings.canvasSize || 800;
            }
        }
        
        // 💾 設定保存テスト
        function testSave() {
            const characterId = getSelectedCharacter();
            const settings = getSettingsFromInputs();
            
            addLog(`💾 保存テスト開始: ${characterId}`);
            addLog(`設定内容: ${JSON.stringify(settings)}`);
            
            const result = persistence.save(characterId, settings);
            
            if (result) {
                addLog('✅ 保存成功', 'success');
                showStatus('basicTestStatus', `✅ ${characterId}の設定を保存しました`, 'success');
            } else {
                addLog('❌ 保存失敗', 'error');
                showStatus('basicTestStatus', `❌ ${characterId}の設定保存に失敗しました`, 'error');
            }
        }
        
        // 📂 設定復元テスト
        function testRestore() {
            const characterId = getSelectedCharacter();
            
            addLog(`📂 復元テスト開始: ${characterId}`);
            
            const settings = persistence.restore(characterId);
            
            if (settings) {
                addLog(`✅ 復元成功: ${JSON.stringify(settings)}`, 'success');
                applySettingsToInputs(settings);
                showStatus('basicTestStatus', `✅ ${characterId}の設定を復元しました`, 'success');
            } else {
                addLog('ℹ️ 復元データなし');
                showStatus('basicTestStatus', `ℹ️ ${characterId}の保存データはありません`, 'info');
            }
        }
        
        // 🗑️ 設定削除テスト
        function testClear() {
            const characterId = getSelectedCharacter();
            
            addLog(`🗑️ 削除テスト開始: ${characterId}`);
            
            const result = persistence.clear(characterId);
            
            if (result) {
                addLog('✅ 削除成功', 'success');
                showStatus('basicTestStatus', `✅ ${characterId}の設定を削除しました`, 'success');
            } else {
                addLog('❌ 削除失敗', 'error');
                showStatus('basicTestStatus', `❌ ${characterId}の設定削除に失敗しました`, 'error');
            }
        }
        
        // 🔍 存在確認テスト
        function testExists() {
            const characterId = getSelectedCharacter();
            
            addLog(`🔍 存在確認テスト開始: ${characterId}`);
            
            const exists = persistence.exists(characterId);
            
            addLog(`結果: ${exists ? '存在する' : '存在しない'}`);
            showStatus('basicTestStatus', 
                `${characterId}の設定は${exists ? '存在します' : '存在しません'}`, 
                exists ? 'success' : 'info'
            );
        }
        
        // 📋 全設定取得テスト
        function testGetAllSettings() {
            addLog('📋 全設定取得テスト開始');
            
            const allSettings = persistence.getAllForCurrentPage();
            const count = Object.keys(allSettings).length;
            
            addLog(`取得結果: ${count}キャラクター`);
            addLog(`詳細: ${JSON.stringify(allSettings, null, 2)}`);
            
            showStatus('advancedTestStatus', 
                `現在ページに${count}キャラクターの設定があります`, 
                count > 0 ? 'success' : 'info'
            );
        }
        
        // ✅ バリデーションテスト
        function testValidation() {
            addLog('✅ バリデーションテスト開始');
            
            // 無効なデータでテスト
            const invalidData = [
                { name: '数値範囲外', data: { scaleX: 10.0, scaleY: 1.0 } },
                { name: '必須フィールド不足', data: { scaleX: 1.0 } },
                { name: '型不正', data: { scaleX: 'invalid', scaleY: 1.0 } },
                { name: 'null', data: null }
            ];
            
            let passCount = 0;
            
            invalidData.forEach(test => {
                const isValid = persistence.validateSettings(test.data);
                const expected = false; // 全て無効データなので false が期待値
                
                if (isValid === expected) {
                    addLog(`✅ ${test.name}: 期待通り (${isValid})`);
                    passCount++;
                } else {
                    addLog(`❌ ${test.name}: 期待と異なる (${isValid})`, 'error');
                }
            });
            
            // 有効なデータでもテスト
            const validData = { scaleX: 1.5, scaleY: 1.2, positionX: 100, positionY: 50 };
            const isValidForValid = persistence.validateSettings(validData);
            
            if (isValidForValid === true) {
                addLog('✅ 有効データ: 期待通り (true)');
                passCount++;
            } else {
                addLog('❌ 有効データ: 期待と異なる (false)', 'error');
            }
            
            const totalTests = invalidData.length + 1;
            showStatus('advancedTestStatus', 
                `バリデーションテスト: ${passCount}/${totalTests} 成功`, 
                passCount === totalTests ? 'success' : 'error'
            );
        }
        
        // 💾 容量チェックテスト
        function testCapacityCheck() {
            addLog('💾 容量チェックテスト開始');
            
            const hasCapacity = persistence.checkStorageCapacity();
            
            addLog(`容量チェック結果: ${hasCapacity ? '余裕あり' : '容量不足'}`);
            showStatus('advancedTestStatus', 
                `localStorage容量: ${hasCapacity ? '使用可能' : '不足'}`, 
                hasCapacity ? 'success' : 'error'
            );
        }
        
        // 🧹 ログクリア
        function clearLog() {
            document.getElementById('logContainer').textContent = 'ログをクリアしました...\n';
        }
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            addLog('🎯 SpineSettingsPersistence テストページ読み込み完了');
            addLog('使用方法: 上記のボタンを使って各機能をテストしてください');
        });
    </script>
</body>
</html>