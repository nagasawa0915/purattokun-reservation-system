<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpineSettingsPersistence Phase 3.3 çµ±åˆãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .test-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ffd700;
        }

        .btn {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #51cf66, #40c057);
            color: white;
        }

        .result-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-pass { background-color: #51cf66; }
        .status-fail { background-color: #ff6b6b; }
        .status-pending { background-color: #ffd700; }

        .performance-meter {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .meter-bar {
            background: rgba(255, 255, 255, 0.2);
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .meter-fill {
            background: linear-gradient(90deg, #51cf66, #ffd700, #ff6b6b);
            height: 100%;
            transition: width 0.5s ease;
        }

        .test-controls {
            text-align: center;
            margin: 30px 0;
        }

        .character-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .character-btn {
            padding: 10px 20px;
            border: 2px solid #ffd700;
            background: rgba(255, 215, 0, 0.1);
            color: #ffd700;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .character-btn.active {
            background: #ffd700;
            color: #333;
        }

        .character-btn:hover {
            background: rgba(255, 215, 0, 0.3);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .testing {
            animation: pulse 1.5s infinite;
        }

        .error-message {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success-message {
            background: rgba(81, 207, 102, 0.2);
            border: 1px solid #51cf66;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª SpineSettingsPersistence Phase 3.3 çµ±åˆãƒ†ã‚¹ãƒˆ</h1>
        
        <!-- å…¨ä½“åˆ¶å¾¡ãƒ‘ãƒãƒ« -->
        <div class="test-section">
            <h2>ğŸ® ãƒ†ã‚¹ãƒˆåˆ¶å¾¡ãƒ‘ãƒãƒ«</h2>
            <div class="test-controls">
                <button class="btn btn-success" onclick="runAllTests()">ğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                <button class="btn" onclick="resetTestEnvironment()">ğŸ”„ ç’°å¢ƒãƒªã‚»ãƒƒãƒˆ</button>
                <button class="btn btn-danger" onclick="clearAllStorage()">ğŸ—‘ï¸ localStorageå…¨å‰Šé™¤</button>
                <button class="btn" onclick="generateTestReport()">ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
            </div>
        </div>

        <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠãƒ‘ãƒãƒ« -->
        <div class="test-section">
            <h2>ğŸ­ ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</h2>
            <div class="character-selector">
                <div class="character-btn active" onclick="selectCharacter('nezumi')" id="char-nezumi">
                    ğŸ­ nezumi
                </div>
                <div class="character-btn" onclick="selectCharacter('purattokun')" id="char-purattokun">
                    ğŸ± purattokun
                </div>
                <div class="character-btn" onclick="selectCharacter('test-character')" id="char-test">
                    ğŸ§ª test-character
                </div>
            </div>
            <p>ç¾åœ¨é¸æŠä¸­: <span id="current-character">nezumi</span></p>
        </div>

        <!-- è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2>ğŸ‘¥ è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆ</h2>
            <div class="test-grid">
                <div class="test-item">
                    <h3>MC001: å€‹åˆ¥è¨­å®šä¿å­˜ãƒ†ã‚¹ãƒˆ</h3>
                    <p>è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¨­å®šãŒåˆ†é›¢ã—ã¦ä¿å­˜ã•ã‚Œã‚‹ã‹ãƒ†ã‚¹ãƒˆ</p>
                    <button class="btn" onclick="testMultiCharacterSeparation()">â–¶ï¸ å®Ÿè¡Œ</button>
                    <div id="result-mc001" class="result-panel" style="display:none;"></div>
                </div>
                
                <div class="test-item">
                    <h3>MC002: ç•°ãªã‚‹ã‚¹ã‚±ãƒ¼ãƒ«å€¤ãƒ†ã‚¹ãƒˆ</h3>
                    <p>å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§ç•°ãªã‚‹ã‚¹ã‚±ãƒ¼ãƒ«å€¤ãŒæ­£ç¢ºã«ä¿å­˜ãƒ»å¾©å…ƒã•ã‚Œã‚‹ã‹ãƒ†ã‚¹ãƒˆ</p>
                    <button class="btn" onclick="testDifferentScaleValues()">â–¶ï¸ å®Ÿè¡Œ</button>
                    <div id="result-mc002" class="result-panel" style="display:none;"></div>
                </div>
                
                <div class="test-item">
                    <h3>MC003: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ</h3>
                    <p>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ™‚ã®è¨­å®šåˆ†é›¢ç¢ºèª</p>
                    <button class="btn" onclick="testCharacterSwitching()">â–¶ï¸ å®Ÿè¡Œ</button>
                    <div id="result-mc003" class="result-panel" style="display:none;"></div>
                </div>
                
                <div class="test-item">
                    <h3>MC004: ä¸€æ‹¬å¾©å…ƒãƒ†ã‚¹ãƒˆ</h3>
                    <p>å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã®ä¸€æ‹¬å–å¾—ãƒ»å¾©å…ƒãƒ†ã‚¹ãƒˆ</p>
                    <button class="btn" onclick="testBulkRestore()">â–¶ï¸ å®Ÿè¡Œ</button>
                    <div id="result-mc004" class="result-panel" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2>ğŸ›¡ï¸ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</h2>
            <div class="test-grid">
                <div class="test-item">
                    <h3>EH001: localStorageå®¹é‡ä¸è¶³ãƒ†ã‚¹ãƒˆ</h3>
                    <p>å®¹é‡ä¸è¶³æ™‚ã®å®‰å…¨ãªå‡¦ç†ç¢ºèª</p>
                    <button class="btn" onclick="testStorageCapacityLimit()">â–¶ï¸ å®Ÿè¡Œ</button>
                    <div id="result-eh001" class="result-panel" style="display:none;"></div>
                </div>
                
                <div class="test-item">
                    <h3>EH002: ãƒ‡ãƒ¼ã‚¿ç ´æãƒ†ã‚¹ãƒˆ</h3>
                    <p>ä¸æ­£ãƒ‡ãƒ¼ã‚¿æ¤œå‡ºãƒ»å›å¾©æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</p>
                    <button class="btn" onclick="testDataCorruption()">â–¶ï¸ å®Ÿè¡Œ</button>
                    <div id="result-eh002" class="result-panel" style="display:none;"></div>
                </div>
                
                <div class="test-item">
                    <h3>EH003: ä¸æ­£å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆ</h3>
                    <p>ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã®å‹•ä½œç¢ºèª</p>
                    <button class="btn" onclick="testInvalidInput()">â–¶ï¸ å®Ÿè¡Œ</button>
                    <div id="result-eh003" class="result-panel" style="display:none;"></div>
                </div>
                
                <div class="test-item">
                    <h3>EH004: ç¯„å›²å¤–å€¤ãƒ†ã‚¹ãƒˆ</h3>
                    <p>ã‚¹ã‚±ãƒ¼ãƒ«å€¤ç¯„å›²å¤–å…¥åŠ›ã®å‡¦ç†ç¢ºèª</p>
                    <button class="btn" onclick="testOutOfRangeValues()">â–¶ï¸ å®Ÿè¡Œ</button>
                    <div id="result-eh004" class="result-panel" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»å“è³ªãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2>âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»å“è³ªãƒ†ã‚¹ãƒˆ</h2>
            <div class="test-grid">
                <div class="test-item">
                    <h3>PF001: å¿œç­”æ™‚é–“ãƒ†ã‚¹ãƒˆï¼ˆ100msåŸºæº–ï¼‰</h3>
                    <p>save/restoreæ“ä½œã®å¿œç­”æ™‚é–“æ¸¬å®š</p>
                    <button class="btn" onclick="testResponseTime()">â–¶ï¸ å®Ÿè¡Œ</button>
                    <div class="performance-meter">
                        <div class="meter-bar">
                            <div class="meter-fill" id="response-time-meter" style="width: 0%;"></div>
                        </div>
                        <div id="response-time-text">å¿œç­”æ™‚é–“: æœªæ¸¬å®š</div>
                    </div>
                    <div id="result-pf001" class="result-panel" style="display:none;"></div>
                </div>
                
                <div class="test-item">
                    <h3>PF002: å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ†ã‚¹ãƒˆ</h3>
                    <p>å¤šæ•°ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã§ã®ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£</p>
                    <button class="btn" onclick="testLargeDataSet()">â–¶ï¸ å®Ÿè¡Œ</button>
                    <div id="result-pf002" class="result-panel" style="display:none;"></div>
                </div>
                
                <div class="test-item">
                    <h3>PF003: é€£ç¶šæ“ä½œãƒ†ã‚¹ãƒˆ</h3>
                    <p>1000å›é€£ç¶šä¿å­˜ãƒ»å¾©å…ƒã®å®‰å®šæ€§ç¢ºèª</p>
                    <button class="btn" onclick="testContinuousOperations()">â–¶ï¸ å®Ÿè¡Œ</button>
                    <div class="performance-meter">
                        <div class="meter-bar">
                            <div class="meter-fill" id="continuous-test-meter" style="width: 0%;"></div>
                        </div>
                        <div id="continuous-test-text">é€²è¡ŒçŠ¶æ³: 0/1000</div>
                    </div>
                    <div id="result-pf003" class="result-panel" style="display:none;"></div>
                </div>
                
                <div class="test-item">
                    <h3>PF004: ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ</h3>
                    <p>é•·æ™‚é–“å‹•ä½œã§ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç›£è¦–</p>
                    <button class="btn" onclick="testMemoryLeak()">â–¶ï¸ å®Ÿè¡Œ</button>
                    <div id="result-pf004" class="result-panel" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- å®Ÿç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2>ğŸ¯ å®Ÿç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ</h2>
            <div class="test-grid">
                <div class="test-item">
                    <h3>WF001: åˆ¶ä½œè€…ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ</h3>
                    <p>å®Ÿéš›ã®åˆ¶ä½œãƒ•ãƒ­ãƒ¼ã§ã®å‹•ä½œç¢ºèª</p>
                    <button class="btn" onclick="testProductionWorkflow()">â–¶ï¸ å®Ÿè¡Œ</button>
                    <div id="result-wf001" class="result-panel" style="display:none;"></div>
                </div>
                
                <div class="test-item">
                    <h3>WF002: ãƒ–ãƒ©ã‚¦ã‚¶å†èµ·å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h3>
                    <p>ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰å¾Œã®è¨­å®šå¾©å…ƒç¢ºèª</p>
                    <button class="btn" onclick="testBrowserRestart()">â–¶ï¸ å®Ÿè¡Œ</button>
                    <div id="result-wf002" class="result-panel" style="display:none;"></div>
                </div>
                
                <div class="test-item">
                    <h3>WF003: ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h3>
                    <p>è¨­å®šã‚¯ãƒªã‚¢ãƒ»å¾©æ—§æ©Ÿèƒ½ã®ç¢ºèª</p>
                    <button class="btn" onclick="testEmergencyReset()">â–¶ï¸ å®Ÿè¡Œ</button>
                    <div id="result-wf003" class="result-panel" style="display:none;"></div>
                </div>
                
                <div class="test-item">
                    <h3>WF004: ãƒ‡ãƒãƒƒã‚°æ”¯æ´æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h3>
                    <p>debug()æ©Ÿèƒ½ã®å‹•ä½œç¢ºèª</p>
                    <button class="btn" onclick="testDebugFeatures()">â–¶ï¸ å®Ÿè¡Œ</button>
                    <div id="result-wf004" class="result-panel" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- ç·åˆãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤º -->
        <div class="test-section">
            <h2>ğŸ“Š ç·åˆãƒ†ã‚¹ãƒˆçµæœ</h2>
            <div id="overall-results" class="result-panel">
                ãƒ†ã‚¹ãƒˆæœªå®Ÿè¡Œ - ä¸Šè¨˜ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„
            </div>
            
            <div class="test-controls">
                <button class="btn btn-success" onclick="generateDetailedReport()">ğŸ“‹ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
                <button class="btn" onclick="exportTestResults()">ğŸ’¾ çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            </div>
        </div>
    </div>

    <!-- SpineSettingsPersistenceèª­ã¿è¾¼ã¿ -->
    <script src="micromodules/spine-settings-persistence/SpineSettingsPersistence.js"></script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ†ã‚¹ãƒˆçŠ¶æ…‹
        let testResults = {};
        let currentCharacter = 'nezumi';
        let persistence = null;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeTest();
        });

        function initializeTest() {
            console.log('ğŸ§ª Phase 3.3çµ±åˆãƒ†ã‚¹ãƒˆåˆæœŸåŒ–é–‹å§‹');
            
            // SpineSettingsPersistenceåˆæœŸåŒ–ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹ï¼‰
            persistence = new SpineSettingsPersistence({
                debug: true,
                version: '1.0'
            });
            
            console.log('âœ… SpineSettingsPersistenceåˆæœŸåŒ–å®Œäº†');
            updateOverallResults();
        }

        function selectCharacter(characterId) {
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠUIæ›´æ–°
            document.querySelectorAll('.character-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`char-${characterId}`).classList.add('active');
            
            currentCharacter = characterId;
            document.getElementById('current-character').textContent = characterId;
            
            console.log(`ğŸ­ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ: ${characterId}`);
        }

        // ===== è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆ =====

        function testMultiCharacterSeparation() {
            const resultDiv = document.getElementById('result-mc001');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="testing">ğŸ”„ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';
            
            setTimeout(() => {
                try {
                    const results = [];
                    const testCharacters = ['mc001-nezumi', 'mc001-purattokun', 'mc001-test-character'];
                    
                    // ãƒ†ã‚¹ãƒˆé–‹å§‹å‰ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.includes('spineSettings') && key.includes('test-spine-settings-persistence-phase3-3')) {
                            testCharacters.forEach(char => {
                                if (key.includes(char)) {
                                    keysToRemove.push(key);
                                }
                            });
                        }
                    }
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    
                    // å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ç•°ãªã‚‹è¨­å®šã‚’ä¿å­˜
                    testCharacters.forEach((char, index) => {
                        const settings = {
                            scaleX: 1.0 + (index * 0.2),
                            scaleY: 1.0 + (index * 0.2),
                            positionX: index * 100,
                            positionY: index * 50
                        };
                        
                        const saved = persistence.save(char, settings);
                        results.push(`${char}: ä¿å­˜${saved ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
                    });
                    
                    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸å°‚ç”¨ã‚­ãƒ¼ã®ã¿ç¢ºèª
                    const pageSpecificKeys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.includes('spineSettings-test-spine-settings-persistence-phase3-3')) {
                            testCharacters.forEach(char => {
                                if (key.includes(char)) {
                                    pageSpecificKeys.push(key);
                                }
                            });
                        }
                    }
                    
                    const passed = pageSpecificKeys.length === testCharacters.length;
                    const status = passed ? 'âœ… PASS' : 'âŒ FAIL';
                    
                    resultDiv.innerHTML = `
                        <div class="${passed ? 'success-message' : 'error-message'}">
                            ${status}: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ†é›¢ä¿å­˜ãƒ†ã‚¹ãƒˆ
                        </div>
                        <div>ä¿å­˜çµæœ: ${results.join(', ')}</div>
                        <div>æœŸå¾…ã‚­ãƒ¼æ•°: ${testCharacters.length}, å®Ÿéš›ã®ã‚­ãƒ¼æ•°: ${pageSpecificKeys.length}</div>
                        <div>ç”Ÿæˆã•ã‚ŒãŸã‚­ãƒ¼:</div>
                        <ul>${pageSpecificKeys.map(key => `<li>${key}</li>`).join('')}</ul>
                    `;
                    
                    testResults['MC001'] = passed;
                    updateOverallResults();
                    
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error-message">âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    testResults['MC001'] = false;
                }
            }, 1000);
        }

        function testDifferentScaleValues() {
            const resultDiv = document.getElementById('result-mc002');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="testing">ğŸ”„ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';
            
            setTimeout(() => {
                try {
                    const testData = [
                        { char: 'nezumi', scaleX: 1.5, scaleY: 1.2 },
                        { char: 'purattokun', scaleX: 0.8, scaleY: 0.9 },
                        { char: 'test-character', scaleX: 2.0, scaleY: 1.8 }
                    ];
                    
                    // ä¿å­˜
                    testData.forEach(data => {
                        persistence.save(data.char, {
                            scaleX: data.scaleX,
                            scaleY: data.scaleY
                        });
                    });
                    
                    // å¾©å…ƒãƒ»ç¢ºèª
                    const results = [];
                    let allPassed = true;
                    
                    testData.forEach(expected => {
                        const restored = persistence.restore(expected.char);
                        const scaleXMatch = Math.abs(restored.scaleX - expected.scaleX) < 0.001;
                        const scaleYMatch = Math.abs(restored.scaleY - expected.scaleY) < 0.001;
                        const passed = scaleXMatch && scaleYMatch;
                        
                        if (!passed) allPassed = false;
                        
                        results.push({
                            char: expected.char,
                            expected: expected,
                            restored: restored,
                            passed: passed
                        });
                    });
                    
                    const status = allPassed ? 'âœ… PASS' : 'âŒ FAIL';
                    
                    const resultHTML = results.map(r => `
                        <div>
                            <strong>${r.char}</strong>: ${r.passed ? 'âœ…' : 'âŒ'}
                            <br>æœŸå¾…å€¤: scaleX=${r.expected.scaleX}, scaleY=${r.expected.scaleY}
                            <br>å¾©å…ƒå€¤: scaleX=${r.restored.scaleX}, scaleY=${r.restored.scaleY}
                        </div>
                    `).join('<hr>');
                    
                    resultDiv.innerHTML = `
                        <div class="${allPassed ? 'success-message' : 'error-message'}">
                            ${status}: ç•°ãªã‚‹ã‚¹ã‚±ãƒ¼ãƒ«å€¤ãƒ†ã‚¹ãƒˆ
                        </div>
                        ${resultHTML}
                    `;
                    
                    testResults['MC002'] = allPassed;
                    updateOverallResults();
                    
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error-message">âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    testResults['MC002'] = false;
                }
            }, 1000);
        }

        function testCharacterSwitching() {
            const resultDiv = document.getElementById('result-mc003');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="testing">ğŸ”„ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';
            
            setTimeout(() => {
                try {
                    // åˆæœŸè¨­å®š
                    const initialSettings = {
                        nezumi: { scaleX: 1.0, scaleY: 1.0 },
                        purattokun: { scaleX: 1.5, scaleY: 1.3 }
                    };
                    
                    // åˆæœŸä¿å­˜
                    persistence.save('nezumi', initialSettings.nezumi);
                    persistence.save('purattokun', initialSettings.purattokun);
                    
                    // nezumiã‚’å¤‰æ›´
                    const newNezumiSettings = { scaleX: 2.0, scaleY: 2.2 };
                    persistence.save('nezumi', newNezumiSettings);
                    
                    // purattokunè¨­å®šãŒå½±éŸ¿ã‚’å—ã‘ã¦ã„ãªã„ã‹ç¢ºèª
                    const purattokuRestoredafter = persistence.restore('purattokun');
                    const purattokuUnchanged = 
                        Math.abs(purattokuRestoredafter.scaleX - initialSettings.purattokun.scaleX) < 0.001 &&
                        Math.abs(purattokuRestoredafter.scaleY - initialSettings.purattokun.scaleY) < 0.001;
                    
                    // nezumiã®å¤‰æ›´ãŒæ­£ã—ãä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                    const nezumiRestored = persistence.restore('nezumi');
                    const nezumiCorrect =
                        Math.abs(nezumiRestored.scaleX - newNezumiSettings.scaleX) < 0.001 &&
                        Math.abs(nezumiRestored.scaleY - newNezumiSettings.scaleY) < 0.001;
                    
                    const allPassed = purattokuUnchanged && nezumiCorrect;
                    const status = allPassed ? 'âœ… PASS' : 'âŒ FAIL';
                    
                    resultDiv.innerHTML = `
                        <div class="${allPassed ? 'success-message' : 'error-message'}">
                            ${status}: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆå¹²æ¸‰ãƒ†ã‚¹ãƒˆ
                        </div>
                        <div>nezumiå¤‰æ›´å¾Œã®è¨­å®š: scaleX=${nezumiRestored.scaleX}, scaleY=${nezumiRestored.scaleY} ${nezumiCorrect ? 'âœ…' : 'âŒ'}</div>
                        <div>purattokunè¨­å®šç¶­æŒ: scaleX=${purattokuRestoredafter.scaleX}, scaleY=${purattokuRestoredafter.scaleY} ${purattokuUnchanged ? 'âœ…' : 'âŒ'}</div>
                        <div>å¹²æ¸‰ãªã—: ${purattokuUnchanged && nezumiCorrect ? 'ç¢ºèª' : 'å•é¡Œã‚ã‚Š'}</div>
                    `;
                    
                    testResults['MC003'] = allPassed;
                    updateOverallResults();
                    
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error-message">âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    testResults['MC003'] = false;
                }
            }, 1000);
        }

        function testBulkRestore() {
            const resultDiv = document.getElementById('result-mc004');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="testing">ğŸ”„ ä¸€æ‹¬å¾©å…ƒãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';
            
            setTimeout(() => {
                try {
                    // ãƒ†ã‚¹ãƒˆé–‹å§‹å‰ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                    const allKeys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.includes('spineSettings-test-spine-settings-persistence-phase3-3')) {
                            allKeys.push(key);
                        }
                    }
                    allKeys.forEach(key => localStorage.removeItem(key));
                    
                    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ãƒ»ä¿å­˜
                    const testCharacters = {
                        'mc004-nezumi': { scaleX: 1.2, scaleY: 1.1 },
                        'mc004-purattokun': { scaleX: 0.9, scaleY: 1.3 },
                        'mc004-test-char-1': { scaleX: 1.5, scaleY: 1.4 },
                        'mc004-test-char-2': { scaleX: 0.7, scaleY: 0.8 }
                    };
                    
                    Object.entries(testCharacters).forEach(([char, settings]) => {
                        persistence.save(char, settings);
                    });
                    
                    // ä¸€æ‹¬å–å¾—
                    const allSettings = persistence.getAllForCurrentPage();
                    
                    // æ¤œè¨¼
                    const expectedCount = Object.keys(testCharacters).length;
                    const actualCount = Object.keys(allSettings).length;
                    
                    const results = [];
                    let allMatched = true;
                    
                    Object.entries(testCharacters).forEach(([char, expected]) => {
                        const actual = allSettings[char];
                        if (!actual) {
                            results.push(`${char}: âŒ å–å¾—å¤±æ•—`);
                            allMatched = false;
                        } else {
                            const scaleXMatch = Math.abs(actual.scaleX - expected.scaleX) < 0.001;
                            const scaleYMatch = Math.abs(actual.scaleY - expected.scaleY) < 0.001;
                            const match = scaleXMatch && scaleYMatch;
                            
                            results.push(`${char}: ${match ? 'âœ…' : 'âŒ'} scaleX=${actual.scaleX}, scaleY=${actual.scaleY}`);
                            
                            if (!match) allMatched = false;
                        }
                    });
                    
                    const countMatched = actualCount === expectedCount;
                    const allPassed = allMatched && countMatched;
                    const status = allPassed ? 'âœ… PASS' : 'âŒ FAIL';
                    
                    resultDiv.innerHTML = `
                        <div class="${allPassed ? 'success-message' : 'error-message'}">
                            ${status}: ä¸€æ‹¬å¾©å…ƒãƒ†ã‚¹ãƒˆ
                        </div>
                        <div>æœŸå¾…ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ•°: ${expectedCount}, å–å¾—æ•°: ${actualCount} ${countMatched ? 'âœ…' : 'âŒ'}</div>
                        <div>å€‹åˆ¥è¨­å®šç¢ºèª:</div>
                        <ul>${results.map(r => `<li>${r}</li>`).join('')}</ul>
                    `;
                    
                    testResults['MC004'] = allPassed;
                    updateOverallResults();
                    
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error-message">âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    testResults['MC004'] = false;
                }
            }, 1500);
        }

        // ===== ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ =====

        function testStorageCapacityLimit() {
            const resultDiv = document.getElementById('result-eh001');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="testing">ğŸ”„ å®¹é‡åˆ¶é™ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';
            
            setTimeout(() => {
                try {
                    // å…ƒã®setItemã‚’ä¿å­˜
                    const originalSetItem = localStorage.setItem;
                    let simulatedError = false;
                    
                    // setItemã‚’ãƒ¢ãƒƒã‚¯ï¼ˆå®¹é‡ä¸è¶³ã‚¨ãƒ©ãƒ¼ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
                    localStorage.setItem = function(key, value) {
                        if (key.includes('spineSettings') && !simulatedError) {
                            simulatedError = true;
                            throw new Error('QuotaExceededError');
                        }
                        return originalSetItem.call(this, key, value);
                    };
                    
                    // ä¿å­˜ã‚’è©¦è¡Œ
                    const result = persistence.save('test-capacity', {
                        scaleX: 1.0,
                        scaleY: 1.0
                    });
                    
                    // setItemã‚’å¾©å…ƒ
                    localStorage.setItem = originalSetItem;
                    
                    // çµæœæ¤œè¨¼
                    const expectedFailure = !result; // ä¿å­˜å¤±æ•—ã‚’æœŸå¾…
                    const status = expectedFailure ? 'âœ… PASS' : 'âŒ FAIL';
                    
                    resultDiv.innerHTML = `
                        <div class="${expectedFailure ? 'success-message' : 'error-message'}">
                            ${status}: localStorageå®¹é‡åˆ¶é™ãƒ†ã‚¹ãƒˆ
                        </div>
                        <div>ä¿å­˜çµæœ: ${result ? 'æˆåŠŸ' : 'å¤±æ•—'} ${expectedFailure ? '(æœŸå¾…é€šã‚Š)' : '(äºˆæœŸã—ãªã„çµæœ)'}</div>
                        <div>ã‚¨ãƒ©ãƒ¼ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: ${simulatedError ? 'å®Ÿè¡Œ' : 'å®Ÿè¡Œå¤±æ•—'}</div>
                        <div>å®‰å…¨ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ${!result ? 'ç¢ºèª' : 'ç¢ºèªã§ããš'}</div>
                    `;
                    
                    testResults['EH001'] = expectedFailure;
                    updateOverallResults();
                    
                } catch (error) {
                    // setItemã‚’ç¢ºå®Ÿã«å¾©å…ƒ
                    const originalSetItem = Storage.prototype.setItem;
                    localStorage.setItem = originalSetItem;
                    
                    resultDiv.innerHTML = `<div class="error-message">âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    testResults['EH001'] = false;
                }
            }, 1000);
        }

        function testDataCorruption() {
            const resultDiv = document.getElementById('result-eh002');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="testing">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ç ´æãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';
            
            setTimeout(() => {
                try {
                    const testChar = 'corrupted-test';
                    
                    // æ­£å¸¸ãƒ‡ãƒ¼ã‚¿ã‚’å…ˆã«ä¿å­˜
                    const validSettings = { scaleX: 1.0, scaleY: 1.0 };
                    persistence.save(testChar, validSettings);
                    
                    // localStorageå†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥ç ´æã•ã›ã‚‹
                    const key = `spineSettings-test-spine-settings-persistence-phase3-3-${testChar}`;
                    localStorage.setItem(key, '{invalid-json-data}');
                    
                    // å¾©å…ƒã‚’è©¦è¡Œ
                    const restored = persistence.restore(testChar);
                    
                    // çµæœæ¤œè¨¼
                    const handledGracefully = restored === null; // nullè¿”å´ã‚’æœŸå¾…
                    const status = handledGracefully ? 'âœ… PASS' : 'âŒ FAIL';
                    
                    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    localStorage.removeItem(key);
                    
                    resultDiv.innerHTML = `
                        <div class="${handledGracefully ? 'success-message' : 'error-message'}">
                            ${status}: ãƒ‡ãƒ¼ã‚¿ç ´æå‡¦ç†ãƒ†ã‚¹ãƒˆ
                        </div>
                        <div>ç ´æãƒ‡ãƒ¼ã‚¿å¾©å…ƒçµæœ: ${restored === null ? 'null (é©åˆ‡)' : `äºˆæœŸã—ãªã„ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(restored)}`}</div>
                        <div>ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: ${handledGracefully ? 'ç¢ºèª' : 'å•é¡Œã‚ã‚Š'}</div>
                    `;
                    
                    testResults['EH002'] = handledGracefully;
                    updateOverallResults();
                    
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error-message">âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    testResults['EH002'] = false;
                }
            }, 1000);
        }

        function testInvalidInput() {
            const resultDiv = document.getElementById('result-eh003');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="testing">ğŸ”„ ä¸æ­£å…¥åŠ›ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';
            
            setTimeout(() => {
                try {
                    const invalidInputs = [
                        { desc: 'nullè¨­å®š', data: null },
                        { desc: 'undefinedè¨­å®š', data: undefined },
                        { desc: 'ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ', data: {} },
                        { desc: 'æ–‡å­—åˆ—å‹ã‚¹ã‚±ãƒ¼ãƒ«', data: { scaleX: "1.0", scaleY: "1.0" } },
                        { desc: 'å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¬ æ', data: { scaleX: 1.0 } },
                        { desc: 'ç„¡åŠ¹ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID', characterId: null },
                        { desc: 'ç©ºæ–‡å­—ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID', characterId: '' }
                    ];
                    
                    const results = [];
                    let allRejected = true;
                    
                    invalidInputs.forEach(test => {
                        try {
                            const characterId = test.characterId !== undefined ? test.characterId : 'test-invalid';
                            const result = persistence.save(characterId, test.data);
                            
                            const rejected = result === false;
                            if (!rejected) allRejected = false;
                            
                            results.push({
                                desc: test.desc,
                                rejected: rejected,
                                result: result
                            });
                            
                        } catch (error) {
                            // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã‚‚é©åˆ‡ãªå‡¦ç†
                            results.push({
                                desc: test.desc,
                                rejected: true,
                                result: `ä¾‹å¤–: ${error.message}`
                            });
                        }
                    });
                    
                    const status = allRejected ? 'âœ… PASS' : 'âŒ FAIL';
                    
                    const resultHTML = results.map(r => `
                        <div>${r.desc}: ${r.rejected ? 'âœ… æ‹’å¦' : 'âŒ å—ç†'} (${r.result})</div>
                    `).join('');
                    
                    resultDiv.innerHTML = `
                        <div class="${allRejected ? 'success-message' : 'error-message'}">
                            ${status}: ä¸æ­£å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
                        </div>
                        <div>å…¨ã¦ã®ä¸æ­£å…¥åŠ›ãŒé©åˆ‡ã«æ‹’å¦: ${allRejected ? 'ç¢ºèª' : 'å•é¡Œã‚ã‚Š'}</div>
                        ${resultHTML}
                    `;
                    
                    testResults['EH003'] = allRejected;
                    updateOverallResults();
                    
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error-message">âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    testResults['EH003'] = false;
                }
            }, 1500);
        }

        function testOutOfRangeValues() {
            const resultDiv = document.getElementById('result-eh004');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="testing">ğŸ”„ ç¯„å›²å¤–å€¤ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';
            
            setTimeout(() => {
                try {
                    const outOfRangeTests = [
                        { desc: 'scaleXæœ€å°å€¤æœªæº€', data: { scaleX: 0.05, scaleY: 1.0 } },
                        { desc: 'scaleXæœ€å¤§å€¤è¶…é', data: { scaleX: 6.0, scaleY: 1.0 } },
                        { desc: 'scaleYæœ€å°å€¤æœªæº€', data: { scaleX: 1.0, scaleY: 0.05 } },
                        { desc: 'scaleYæœ€å¤§å€¤è¶…é', data: { scaleX: 1.0, scaleY: 6.0 } },
                        { desc: 'è² ã®å€¤', data: { scaleX: -1.0, scaleY: 1.0 } },
                        { desc: 'ã‚¼ãƒ­å€¤', data: { scaleX: 0, scaleY: 1.0 } }
                    ];
                    
                    const results = [];
                    let allRejected = true;
                    
                    outOfRangeTests.forEach((test, index) => {
                        const result = persistence.save(`test-range-${index}`, test.data);
                        const rejected = result === false;
                        
                        if (!rejected) allRejected = false;
                        
                        results.push({
                            desc: test.desc,
                            values: `scaleX=${test.data.scaleX}, scaleY=${test.data.scaleY}`,
                            rejected: rejected
                        });
                    });
                    
                    const status = allRejected ? 'âœ… PASS' : 'âŒ FAIL';
                    
                    const resultHTML = results.map(r => `
                        <div>${r.desc} (${r.values}): ${r.rejected ? 'âœ… æ‹’å¦' : 'âŒ å—ç†'}</div>
                    `).join('');
                    
                    resultDiv.innerHTML = `
                        <div class="${allRejected ? 'success-message' : 'error-message'}">
                            ${status}: ç¯„å›²å¤–å€¤ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
                        </div>
                        <div>ç¯„å›²: scaleX/Y 0.1-5.0</div>
                        <div>å…¨ã¦ã®ç¯„å›²å¤–å€¤ãŒæ‹’å¦: ${allRejected ? 'ç¢ºèª' : 'å•é¡Œã‚ã‚Š'}</div>
                        ${resultHTML}
                    `;
                    
                    testResults['EH004'] = allRejected;
                    updateOverallResults();
                    
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error-message">âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    testResults['EH004'] = false;
                }
            }, 1000);
        }

        // ===== ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ =====

        function testResponseTime() {
            const resultDiv = document.getElementById('result-pf001');
            const meterDiv = document.getElementById('response-time-meter');
            const textDiv = document.getElementById('response-time-text');
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="testing">ğŸ”„ å¿œç­”æ™‚é–“æ¸¬å®šä¸­...</div>';
            
            setTimeout(() => {
                try {
                    const testData = { scaleX: 1.5, scaleY: 1.3 };
                    const iterations = 100;
                    const times = [];
                    
                    // è¤‡æ•°å›æ¸¬å®š
                    for (let i = 0; i < iterations; i++) {
                        // ä¿å­˜æ™‚é–“æ¸¬å®š
                        const saveStart = performance.now();
                        persistence.save(`perf-test-${i}`, testData);
                        const saveEnd = performance.now();
                        
                        // å¾©å…ƒæ™‚é–“æ¸¬å®š
                        const restoreStart = performance.now();
                        persistence.restore(`perf-test-${i}`);
                        const restoreEnd = performance.now();
                        
                        times.push({
                            save: saveEnd - saveStart,
                            restore: restoreEnd - restoreStart
                        });
                    }
                    
                    // çµ±è¨ˆè¨ˆç®—
                    const saveTimes = times.map(t => t.save);
                    const restoreTimes = times.map(t => t.restore);
                    
                    const avgSave = saveTimes.reduce((a, b) => a + b, 0) / saveTimes.length;
                    const avgRestore = restoreTimes.reduce((a, b) => a + b, 0) / restoreTimes.length;
                    const maxSave = Math.max(...saveTimes);
                    const maxRestore = Math.max(...restoreTimes);
                    
                    // åŸºæº–ãƒã‚§ãƒƒã‚¯ï¼ˆ100msä»¥å†…ï¼‰
                    const saveWithinLimit = avgSave < 100 && maxSave < 100;
                    const restoreWithinLimit = avgRestore < 100 && maxRestore < 100;
                    const allWithinLimit = saveWithinLimit && restoreWithinLimit;
                    
                    // ãƒ¡ãƒ¼ã‚¿ãƒ¼æ›´æ–°
                    const avgTime = Math.max(avgSave, avgRestore);
                    const meterPercent = Math.min((avgTime / 100) * 100, 100);
                    meterDiv.style.width = `${meterPercent}%`;
                    textDiv.textContent = `å¿œç­”æ™‚é–“: ${avgTime.toFixed(2)}ms (åŸºæº–: 100ms)`;
                    
                    const status = allWithinLimit ? 'âœ… PASS' : 'âŒ FAIL';
                    
                    resultDiv.innerHTML = `
                        <div class="${allWithinLimit ? 'success-message' : 'error-message'}">
                            ${status}: å¿œç­”æ™‚é–“ãƒ†ã‚¹ãƒˆ (${iterations}å›æ¸¬å®š)
                        </div>
                        <div>å¹³å‡ä¿å­˜æ™‚é–“: ${avgSave.toFixed(2)}ms ${saveWithinLimit ? 'âœ…' : 'âŒ'}</div>
                        <div>æœ€å¤§ä¿å­˜æ™‚é–“: ${maxSave.toFixed(2)}ms</div>
                        <div>å¹³å‡å¾©å…ƒæ™‚é–“: ${avgRestore.toFixed(2)}ms ${restoreWithinLimit ? 'âœ…' : 'âŒ'}</div>
                        <div>æœ€å¤§å¾©å…ƒæ™‚é–“: ${maxRestore.toFixed(2)}ms</div>
                        <div>è¦ä»¶åŸºæº–(100ms): ${allWithinLimit ? 'ã‚¯ãƒªã‚¢' : 'æœªé”'}</div>
                    `;
                    
                    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    for (let i = 0; i < iterations; i++) {
                        persistence.clear(`perf-test-${i}`);
                    }
                    
                    testResults['PF001'] = allWithinLimit;
                    updateOverallResults();
                    
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error-message">âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    testResults['PF001'] = false;
                }
            }, 1000);
        }

        function testLargeDataSet() {
            const resultDiv = document.getElementById('result-pf002');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="testing">ğŸ”„ å¤§é‡ãƒ‡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';
            
            setTimeout(() => {
                try {
                    const characterCount = 50;
                    const startTime = performance.now();
                    
                    // å¤§é‡ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’ä¿å­˜
                    for (let i = 0; i < characterCount; i++) {
                        const settings = {
                            scaleX: 1.0 + (i * 0.01),
                            scaleY: 1.0 + (i * 0.02),
                            positionX: i * 10,
                            positionY: i * 5
                        };
                        
                        persistence.save(`large-test-${i}`, settings);
                    }
                    
                    const saveEndTime = performance.now();
                    
                    // å…¨ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
                    const allSettings = persistence.getAllForCurrentPage();
                    const restoreEndTime = performance.now();
                    
                    // æ¤œè¨¼
                    const largeTestKeys = Object.keys(allSettings).filter(key => key.startsWith('large-test-'));
                    const retrievedCount = largeTestKeys.length;
                    
                    const saveTime = saveEndTime - startTime;
                    const restoreTime = restoreEndTime - saveEndTime;
                    const totalTime = restoreEndTime - startTime;
                    
                    // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŸºæº–ï¼ˆå…¨ä½“ã§1ç§’ä»¥å†…ï¼‰
                    const performanceOK = totalTime < 1000;
                    const dataIntegrityOK = retrievedCount === characterCount;
                    
                    const allPassed = performanceOK && dataIntegrityOK;
                    const status = allPassed ? 'âœ… PASS' : 'âŒ FAIL';
                    
                    resultDiv.innerHTML = `
                        <div class="${allPassed ? 'success-message' : 'error-message'}">
                            ${status}: å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ†ã‚¹ãƒˆ
                        </div>
                        <div>ãƒ†ã‚¹ãƒˆå¯¾è±¡: ${characterCount}ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</div>
                        <div>ä¿å­˜æ™‚é–“: ${saveTime.toFixed(2)}ms</div>
                        <div>å¾©å…ƒæ™‚é–“: ${restoreTime.toFixed(2)}ms</div>
                        <div>åˆè¨ˆæ™‚é–“: ${totalTime.toFixed(2)}ms ${performanceOK ? 'âœ…' : 'âŒ'} (åŸºæº–: 1000ms)</div>
                        <div>ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§: ${retrievedCount}/${characterCount} ${dataIntegrityOK ? 'âœ…' : 'âŒ'}</div>
                    `;
                    
                    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    for (let i = 0; i < characterCount; i++) {
                        persistence.clear(`large-test-${i}`);
                    }
                    
                    testResults['PF002'] = allPassed;
                    updateOverallResults();
                    
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error-message">âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    testResults['PF002'] = false;
                }
            }, 1500);
        }

        function testContinuousOperations() {
            const resultDiv = document.getElementById('result-pf003');
            const meterDiv = document.getElementById('continuous-test-meter');
            const textDiv = document.getElementById('continuous-test-text');
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="testing">ğŸ”„ é€£ç¶šæ“ä½œãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­... (æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™)</div>';
            
            const iterations = 1000;
            let successCount = 0;
            let current = 0;
            
            const runBatch = () => {
                const batchSize = 10;
                const endIndex = Math.min(current + batchSize, iterations);
                
                for (let i = current; i < endIndex; i++) {
                    try {
                        const settings = {
                            scaleX: 1.0 + (i * 0.001),
                            scaleY: 1.0 + (i * 0.0005)
                        };
                        
                        // ä¿å­˜ãƒ»å¾©å…ƒã‚µã‚¤ã‚¯ãƒ«
                        const saved = persistence.save(`continuous-${i}`, settings);
                        const restored = persistence.restore(`continuous-${i}`);
                        persistence.clear(`continuous-${i}`);
                        
                        if (saved && restored && 
                            Math.abs(restored.scaleX - settings.scaleX) < 0.0001 &&
                            Math.abs(restored.scaleY - settings.scaleY) < 0.0001) {
                            successCount++;
                        }
                        
                    } catch (error) {
                        console.error(`é€£ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ ${i}:`, error);
                    }
                }
                
                current = endIndex;
                
                // é€²è¡ŒçŠ¶æ³æ›´æ–°
                const progress = (current / iterations) * 100;
                meterDiv.style.width = `${progress}%`;
                textDiv.textContent = `é€²è¡ŒçŠ¶æ³: ${current}/${iterations} (æˆåŠŸ: ${successCount})`;
                
                // ç¶™ç¶šã¾ãŸã¯å®Œäº†
                if (current < iterations) {
                    setTimeout(runBatch, 10); // 10msé–“éš”ã§å®Ÿè¡Œ
                } else {
                    // ãƒ†ã‚¹ãƒˆå®Œäº†
                    const successRate = (successCount / iterations) * 100;
                    const passed = successRate >= 99; // 99%ä»¥ä¸ŠæˆåŠŸç‡
                    const status = passed ? 'âœ… PASS' : 'âŒ FAIL';
                    
                    resultDiv.innerHTML = `
                        <div class="${passed ? 'success-message' : 'error-message'}">
                            ${status}: é€£ç¶šæ“ä½œå®‰å®šæ€§ãƒ†ã‚¹ãƒˆ
                        </div>
                        <div>ç·å®Ÿè¡Œå›æ•°: ${iterations}</div>
                        <div>æˆåŠŸå›æ•°: ${successCount}</div>
                        <div>æˆåŠŸç‡: ${successRate.toFixed(2)}% ${passed ? 'âœ…' : 'âŒ'} (åŸºæº–: 99%)</div>
                        <div>å¤±æ•—å›æ•°: ${iterations - successCount}</div>
                    `;
                    
                    testResults['PF003'] = passed;
                    updateOverallResults();
                }
            };
            
            setTimeout(runBatch, 1000);
        }

        function testMemoryLeak() {
            const resultDiv = document.getElementById('result-pf004');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="testing">ğŸ”„ ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­... (30ç§’)</div>';
            
            if (!performance.memory) {
                resultDiv.innerHTML = `<div class="error-message">âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯performance.memoryã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“</div>`;
                testResults['PF004'] = false;
                return;
            }
            
            const initialMemory = performance.memory.usedJSHeapSize;
            const memorySnapshots = [];
            let testInterval;
            
            const takeMemoruSnapshot = () => {
                // å¤§é‡ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
                for (let i = 0; i < 100; i++) {
                    const settings = {
                        scaleX: Math.random() * 2,
                        scaleY: Math.random() * 2
                    };
                    
                    persistence.save(`memory-test-${i}`, settings);
                    persistence.restore(`memory-test-${i}`);
                    persistence.clear(`memory-test-${i}`);
                }
                
                // ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ¨å¥¨ï¼ˆå¯èƒ½ã§ã‚ã‚Œã°ï¼‰
                if (window.gc) {
                    window.gc();
                }
                
                memorySnapshots.push({
                    time: Date.now(),
                    memory: performance.memory.usedJSHeapSize
                });
            };
            
            testInterval = setInterval(takeMemoruSnapshot, 1000);
            
            setTimeout(() => {
                clearInterval(testInterval);
                
                const finalMemory = performance.memory.usedJSHeapSize;
                const memoryIncrease = finalMemory - initialMemory;
                const increasePercent = (memoryIncrease / initialMemory) * 100;
                
                // ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯åˆ¤å®šï¼ˆ10%å¢—åŠ ä»¥å†…ãªã‚‰æ­£å¸¸ï¼‰
                const memoryOK = increasePercent <= 10;
                const status = memoryOK ? 'âœ… PASS' : 'âŒ FAIL';
                
                const snapshots = memorySnapshots.map((snap, index) => 
                    `${index * 1000}ms: ${(snap.memory / 1024 / 1024).toFixed(2)}MB`
                ).join('<br>');
                
                resultDiv.innerHTML = `
                    <div class="${memoryOK ? 'success-message' : 'error-message'}">
                        ${status}: ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ (30ç§’)
                    </div>
                    <div>åˆæœŸãƒ¡ãƒ¢ãƒª: ${(initialMemory / 1024 / 1024).toFixed(2)}MB</div>
                    <div>æœ€çµ‚ãƒ¡ãƒ¢ãƒª: ${(finalMemory / 1024 / 1024).toFixed(2)}MB</div>
                    <div>å¢—åŠ é‡: ${(memoryIncrease / 1024 / 1024).toFixed(2)}MB (${increasePercent.toFixed(2)}%)</div>
                    <div>åŸºæº–(10%ä»¥ä¸‹): ${memoryOK ? 'ã‚¯ãƒªã‚¢' : 'è¶…é'}</div>
                    <details>
                        <summary>ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡å±¥æ­´</summary>
                        <div style="font-size: 12px;">${snapshots}</div>
                    </details>
                `;
                
                testResults['PF004'] = memoryOK;
                updateOverallResults();
                
            }, 30000);
        }

        // ===== å®Ÿç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ =====

        function testProductionWorkflow() {
            const resultDiv = document.getElementById('result-wf001');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="testing">ğŸ”„ åˆ¶ä½œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';
            
            setTimeout(() => {
                try {
                    const workflow = [];
                    let allStepsSucceeded = true;
                    
                    // ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹ï¼ˆè¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šï¼‰
                    const characters = {
                        nezumi: { scaleX: 1.2, scaleY: 1.1 },
                        purattokun: { scaleX: 0.9, scaleY: 1.0 }
                    };
                    
                    Object.entries(characters).forEach(([char, settings]) => {
                        const saved = persistence.save(char, settings);
                        workflow.push(`${char}åˆæœŸè¨­å®š: ${saved ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
                        if (!saved) allStepsSucceeded = false;
                    });
                    
                    // ã‚¹ãƒ†ãƒƒãƒ—2: è¨­å®šèª¿æ•´ï¼ˆåˆ¶ä½œä¸­ã®å¾®èª¿æ•´ï¼‰
                    const adjustedSettings = {
                        nezumi: { scaleX: 1.3, scaleY: 1.2 },
                        purattokun: { scaleX: 0.85, scaleY: 0.95 }
                    };
                    
                    Object.entries(adjustedSettings).forEach(([char, settings]) => {
                        const saved = persistence.save(char, settings);
                        workflow.push(`${char}èª¿æ•´: ${saved ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
                        if (!saved) allStepsSucceeded = false;
                    });
                    
                    // ã‚¹ãƒ†ãƒƒãƒ—3: åˆ¶ä½œç¢ºèªï¼ˆè¨­å®šå¾©å…ƒï¼‰
                    Object.entries(adjustedSettings).forEach(([char, expected]) => {
                        const restored = persistence.restore(char);
                        if (restored) {
                            const matches = 
                                Math.abs(restored.scaleX - expected.scaleX) < 0.001 &&
                                Math.abs(restored.scaleY - expected.scaleY) < 0.001;
                            workflow.push(`${char}ç¢ºèª: ${matches ? 'æ­£ç¢º' : 'ã‚ºãƒ¬æ¤œå‡º'}`);
                            if (!matches) allStepsSucceeded = false;
                        } else {
                            workflow.push(`${char}ç¢ºèª: å¾©å…ƒå¤±æ•—`);
                            allStepsSucceeded = false;
                        }
                    });
                    
                    // ã‚¹ãƒ†ãƒƒãƒ—4: è¨­å®šç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ï¼‰
                    const debugInfo = persistence.getAllForCurrentPage();
                    const debugSuccess = Object.keys(debugInfo).length >= 2;
                    workflow.push(`è¨­å®šä¸€è¦§ç¢ºèª: ${debugSuccess ? 'æˆåŠŸ' : 'å¤±æ•—'} (${Object.keys(debugInfo).length}é …ç›®)`);
                    if (!debugSuccess) allStepsSucceeded = false;
                    
                    const status = allStepsSucceeded ? 'âœ… PASS' : 'âŒ FAIL';
                    const workflowHTML = workflow.map(step => `<li>${step}</li>`).join('');
                    
                    resultDiv.innerHTML = `
                        <div class="${allStepsSucceeded ? 'success-message' : 'error-message'}">
                            ${status}: åˆ¶ä½œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ
                        </div>
                        <div>ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ‰‹é †:</div>
                        <ol>${workflowHTML}</ol>
                        <div>å…¨å·¥ç¨‹æˆåŠŸ: ${allStepsSucceeded ? 'ç¢ºèª' : 'å•é¡Œã‚ã‚Š'}</div>
                    `;
                    
                    testResults['WF001'] = allStepsSucceeded;
                    updateOverallResults();
                    
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error-message">âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    testResults['WF001'] = false;
                }
            }, 1500);
        }

        function testBrowserRestart() {
            const resultDiv = document.getElementById('result-wf002');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="testing">ğŸ”„ ãƒ–ãƒ©ã‚¦ã‚¶å†èµ·å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œä¸­...</div>';
            
            setTimeout(() => {
                try {
                    // ã‚¹ãƒ†ãƒƒãƒ—1: è¨­å®šä¿å­˜
                    const testSettings = {
                        nezumi: { scaleX: 1.7, scaleY: 1.6 },
                        purattokun: { scaleX: 0.6, scaleY: 0.7 }
                    };
                    
                    Object.entries(testSettings).forEach(([char, settings]) => {
                        persistence.save(char, settings);
                    });
                    
                    // ã‚¹ãƒ†ãƒƒãƒ—2: æ–°ã—ã„SpineSettingsPersistenceã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆï¼ˆå†èµ·å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                    const newPersistence = new SpineSettingsPersistence({
                        debug: false, // æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³
                        version: '1.0'
                    });
                    
                    // ã‚¹ãƒ†ãƒƒãƒ—3: è¨­å®šå¾©å…ƒç¢ºèª
                    const results = [];
                    let allRestored = true;
                    
                    Object.entries(testSettings).forEach(([char, expected]) => {
                        const restored = newPersistence.restore(char);
                        
                        if (restored) {
                            const scaleXMatch = Math.abs(restored.scaleX - expected.scaleX) < 0.001;
                            const scaleYMatch = Math.abs(restored.scaleY - expected.scaleY) < 0.001;
                            const matches = scaleXMatch && scaleYMatch;
                            
                            results.push({
                                char: char,
                                success: matches,
                                expected: expected,
                                restored: restored
                            });
                            
                            if (!matches) allRestored = false;
                        } else {
                            results.push({
                                char: char,
                                success: false,
                                expected: expected,
                                restored: null
                            });
                            allRestored = false;
                        }
                    });
                    
                    const status = allRestored ? 'âœ… PASS' : 'âŒ FAIL';
                    const resultHTML = results.map(r => `
                        <div>
                            <strong>${r.char}</strong>: ${r.success ? 'âœ…' : 'âŒ'}
                            <br>æœŸå¾…: scaleX=${r.expected.scaleX}, scaleY=${r.expected.scaleY}
                            <br>å¾©å…ƒ: ${r.restored ? `scaleX=${r.restored.scaleX}, scaleY=${r.restored.scaleY}` : 'null'}
                        </div>
                    `).join('<hr>');
                    
                    resultDiv.innerHTML = `
                        <div class="${allRestored ? 'success-message' : 'error-message'}">
                            ${status}: ãƒ–ãƒ©ã‚¦ã‚¶å†èµ·å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                        </div>
                        <div>æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ: æˆåŠŸ</div>
                        <div>æ°¸ç¶šæ€§ç¢ºèª: ${allRestored ? 'ç¢ºèª' : 'å•é¡Œã‚ã‚Š'}</div>
                        ${resultHTML}
                    `;
                    
                    testResults['WF002'] = allRestored;
                    updateOverallResults();
                    
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error-message">âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    testResults['WF002'] = false;
                }
            }, 1000);
        }

        function testEmergencyReset() {
            const resultDiv = document.getElementById('result-wf003');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="testing">ğŸ”„ ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';
            
            setTimeout(() => {
                try {
                    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™
                    const testChars = ['reset-test-1', 'reset-test-2', 'reset-test-3'];
                    testChars.forEach(char => {
                        persistence.save(char, { scaleX: 1.5, scaleY: 1.3 });
                    });
                    
                    // ä¿å­˜ç¢ºèª
                    const beforeReset = testChars.map(char => persistence.exists(char));
                    const allSavedBefore = beforeReset.every(exists => exists);
                    
                    // å€‹åˆ¥å‰Šé™¤ãƒ†ã‚¹ãƒˆ
                    const cleared1 = persistence.clear('reset-test-1');
                    const exists1After = persistence.exists('reset-test-1');
                    const exists2Still = persistence.exists('reset-test-2');
                    
                    // è¤‡æ•°å‰Šé™¤ãƒ†ã‚¹ãƒˆ
                    const cleared2 = persistence.clear('reset-test-2');
                    const cleared3 = persistence.clear('reset-test-3');
                    
                    // æœ€çµ‚çŠ¶æ…‹ç¢ºèª
                    const finalExists = testChars.map(char => persistence.exists(char));
                    const allClearedAfter = finalExists.every(exists => !exists);
                    
                    // å­˜åœ¨ã—ãªã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚¯ãƒªã‚¢ï¼ˆã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«å‡¦ç†ç¢ºèªï¼‰
                    const clearedNonExistent = persistence.clear('non-existent-char');
                    
                    const results = [];
                    results.push(`ä¿å­˜å‰ç¢ºèª: ${allSavedBefore ? 'å…¨ã¦ä¿å­˜æ¸ˆã¿' : 'ä¸€éƒ¨å¤±æ•—'}`);
                    results.push(`å€‹åˆ¥å‰Šé™¤: ${cleared1 ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
                    results.push(`å‰Šé™¤å¾Œå­˜åœ¨ç¢ºèª: reset-test-1=${!exists1After ? 'ãªã—' : 'ã‚ã‚Š'}, reset-test-2=${exists2Still ? 'ã‚ã‚Š' : 'ãªã—'}`);
                    results.push(`è¤‡æ•°å‰Šé™¤: ${cleared2 && cleared3 ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
                    results.push(`æœ€çµ‚ç¢ºèª: ${allClearedAfter ? 'å…¨å‰Šé™¤å®Œäº†' : 'å‰Šé™¤ä¸å®Œå…¨'}`);
                    results.push(`å­˜åœ¨ã—ãªã„é …ç›®å‰Šé™¤: ${clearedNonExistent ? 'ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«å‡¦ç†' : 'ã‚¨ãƒ©ãƒ¼'}`);
                    
                    const allTestsPassed = 
                        allSavedBefore && cleared1 && !exists1After && exists2Still &&
                        cleared2 && cleared3 && allClearedAfter && clearedNonExistent;
                    
                    const status = allTestsPassed ? 'âœ… PASS' : 'âŒ FAIL';
                    
                    resultDiv.innerHTML = `
                        <div class="${allTestsPassed ? 'success-message' : 'error-message'}">
                            ${status}: ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
                        </div>
                        <div>ãƒ†ã‚¹ãƒˆçµæœ:</div>
                        <ul>${results.map(r => `<li>${r}</li>`).join('')}</ul>
                        <div>å‰Šé™¤æ©Ÿèƒ½: ${allTestsPassed ? 'æ­£å¸¸å‹•ä½œ' : 'å•é¡Œã‚ã‚Š'}</div>
                    `;
                    
                    testResults['WF003'] = allTestsPassed;
                    updateOverallResults();
                    
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error-message">âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    testResults['WF003'] = false;
                }
            }, 1000);
        }

        function testDebugFeatures() {
            const resultDiv = document.getElementById('result-wf004');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="testing">ğŸ”„ ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';
            
            setTimeout(() => {
                try {
                    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™
                    const debugTestData = {
                        'debug-char-1': { scaleX: 1.1, scaleY: 1.2 },
                        'debug-char-2': { scaleX: 0.9, scaleY: 0.8 }
                    };
                    
                    Object.entries(debugTestData).forEach(([char, settings]) => {
                        persistence.save(char, settings);
                    });
                    
                    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
                    const originalConsoleLog = console.log;
                    const capturedLogs = [];
                    
                    console.log = (...args) => {
                        capturedLogs.push(args.join(' '));
                        originalConsoleLog.apply(console, args);
                    };
                    
                    // debugæ©Ÿèƒ½å®Ÿè¡Œ
                    persistence.debug();
                    
                    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’å¾©å…ƒ
                    console.log = originalConsoleLog;
                    
                    // getAllForCurrentPageæ©Ÿèƒ½ç¢ºèª
                    const allSettings = persistence.getAllForCurrentPage();
                    const debugKeys = Object.keys(allSettings).filter(key => key.startsWith('debug-char-'));
                    
                    // ãƒ­ã‚°è§£æ
                    const hasVersionInfo = capturedLogs.some(log => log.includes('Version:'));
                    const hasPageIdInfo = capturedLogs.some(log => log.includes('Page ID:'));
                    const hasSettingsInfo = capturedLogs.some(log => log.includes('Current Page Settings:'));
                    const hasUsageInfo = capturedLogs.some(log => log.includes('localStorage Usage:'));
                    
                    const debugInfoComplete = hasVersionInfo && hasPageIdInfo && hasSettingsInfo;
                    const dataRetrievalCorrect = debugKeys.length === 2;
                    
                    // ãƒ‡ãƒ¼ã‚¿å†…å®¹ç¢ºèª
                    let dataIntegrityOK = true;
                    Object.entries(debugTestData).forEach(([char, expected]) => {
                        const actual = allSettings[char];
                        if (!actual || 
                            Math.abs(actual.scaleX - expected.scaleX) > 0.001 ||
                            Math.abs(actual.scaleY - expected.scaleY) > 0.001) {
                            dataIntegrityOK = false;
                        }
                    });
                    
                    const allPassed = debugInfoComplete && dataRetrievalCorrect && dataIntegrityOK;
                    const status = allPassed ? 'âœ… PASS' : 'âŒ FAIL';
                    
                    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    Object.keys(debugTestData).forEach(char => {
                        persistence.clear(char);
                    });
                    
                    resultDiv.innerHTML = `
                        <div class="${allPassed ? 'success-message' : 'error-message'}">
                            ${status}: ãƒ‡ãƒãƒƒã‚°æ”¯æ´æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
                        </div>
                        <div>ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±å‡ºåŠ›: ${hasVersionInfo ? 'âœ…' : 'âŒ'}</div>
                        <div>ãƒšãƒ¼ã‚¸IDæƒ…å ±å‡ºåŠ›: ${hasPageIdInfo ? 'âœ…' : 'âŒ'}</div>
                        <div>è¨­å®šæƒ…å ±å‡ºåŠ›: ${hasSettingsInfo ? 'âœ…' : 'âŒ'}</div>
                        <div>ä½¿ç”¨é‡æƒ…å ±å‡ºåŠ›: ${hasUsageInfo ? 'âœ…' : 'âš ï¸'} (ãƒ–ãƒ©ã‚¦ã‚¶ä¾å­˜)</div>
                        <div>ãƒ‡ãƒ¼ã‚¿å–å¾—: ${debugKeys.length}/2ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ ${dataRetrievalCorrect ? 'âœ…' : 'âŒ'}</div>
                        <div>ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§: ${dataIntegrityOK ? 'âœ…' : 'âŒ'}</div>
                        <details>
                            <summary>ã‚­ãƒ£ãƒ—ãƒãƒ£ã•ã‚ŒãŸãƒ­ã‚° (${capturedLogs.length}é …ç›®)</summary>
                            <div style="font-size: 12px; max-height: 150px; overflow-y: auto;">
                                ${capturedLogs.map(log => `<div>${log}</div>`).join('')}
                            </div>
                        </details>
                    `;
                    
                    testResults['WF004'] = allPassed;
                    updateOverallResults();
                    
                } catch (error) {
                    resultDiv.innerHTML = `<div class="error-message">âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                    testResults['WF004'] = false;
                }
            }, 1000);
        }

        // ===== åˆ¶å¾¡ãƒ»çµæœæ©Ÿèƒ½ =====

        function runAllTests() {
            console.log('ğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹');
            
            // é€²è¡Œç®¡ç†
            let testsCompleted = 0;
            const totalTests = 16;
            
            const testFunctions = [
                // è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆ
                { func: testMultiCharacterSeparation, delay: 0 },
                { func: testDifferentScaleValues, delay: 2000 },
                { func: testCharacterSwitching, delay: 4000 },
                { func: testBulkRestore, delay: 6000 },
                
                // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
                { func: testStorageCapacityLimit, delay: 8000 },
                { func: testDataCorruption, delay: 10000 },
                { func: testInvalidInput, delay: 12000 },
                { func: testOutOfRangeValues, delay: 14000 },
                
                // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
                { func: testResponseTime, delay: 16000 },
                { func: testLargeDataSet, delay: 18000 },
                { func: testContinuousOperations, delay: 20000 }, // é•·æ™‚é–“ãƒ†ã‚¹ãƒˆ
                { func: testMemoryLeak, delay: 60000 }, // 30ç§’ãƒ†ã‚¹ãƒˆ + å¾…æ©Ÿ
                
                // å®Ÿç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ  
                { func: testProductionWorkflow, delay: 95000 },
                { func: testBrowserRestart, delay: 97000 },
                { func: testEmergencyReset, delay: 99000 },
                { func: testDebugFeatures, delay: 101000 }
            ];
            
            document.getElementById('overall-results').innerHTML = `
                <div class="testing">
                    ğŸš€ å…¨è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­... 
                    <br>äºˆæƒ³æ™‚é–“: ç´„2åˆ†
                    <br>ç¾åœ¨å®Ÿè¡Œä¸­: è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆ
                </div>
            `;
            
            testFunctions.forEach(({ func, delay }, index) => {
                setTimeout(() => {
                    console.log(`ğŸ“‹ ãƒ†ã‚¹ãƒˆ ${index + 1}/${totalTests} å®Ÿè¡Œä¸­`);
                    func();
                }, delay);
            });
            
            // å…¨ãƒ†ã‚¹ãƒˆå®Œäº†ãƒã‚§ãƒƒã‚¯
            setTimeout(() => {
                generateDetailedReport();
                console.log('âœ… å…¨ãƒ†ã‚¹ãƒˆå®Œäº†');
            }, 105000);
        }

        function resetTestEnvironment() {
            console.log('ğŸ”„ ãƒ†ã‚¹ãƒˆç’°å¢ƒãƒªã‚»ãƒƒãƒˆ');
            
            // localStorageå†…ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes('spineSettings')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
            });
            
            // ãƒ†ã‚¹ãƒˆçµæœãƒªã‚»ãƒƒãƒˆ
            testResults = {};
            
            // UI ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.result-panel').forEach(panel => {
                panel.style.display = 'none';
                panel.innerHTML = '';
            });
            
            document.querySelectorAll('.meter-fill').forEach(meter => {
                meter.style.width = '0%';
            });
            
            document.getElementById('response-time-text').textContent = 'å¿œç­”æ™‚é–“: æœªæ¸¬å®š';
            document.getElementById('continuous-test-text').textContent = 'é€²è¡ŒçŠ¶æ³: 0/1000';
            
            updateOverallResults();
            
            alert('ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
        }

        function clearAllStorage() {
            if (confirm('localStorageã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                localStorage.clear();
                console.log('ğŸ—‘ï¸ localStorageå…¨å‰Šé™¤å®Œäº†');
                updateOverallResults();
                alert('localStorageå…¨å‰Šé™¤å®Œäº†');
            }
        }

        function updateOverallResults() {
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(result => result === true).length;
            const failedTests = Object.values(testResults).filter(result => result === false).length;
            
            if (totalTests === 0) {
                document.getElementById('overall-results').innerHTML = `
                    <div>ãƒ†ã‚¹ãƒˆæœªå®Ÿè¡Œ - ä¸Šè¨˜ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
                `;
                return;
            }
            
            const passRate = (passedTests / totalTests) * 100;
            
            // ãƒ†ã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒªåˆ¥é›†è¨ˆ
            const categoryResults = {
                'MC': { name: 'è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼çµ±åˆ', tests: [], passed: 0, total: 0 },
                'EH': { name: 'ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°', tests: [], passed: 0, total: 0 },
                'PF': { name: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹', tests: [], passed: 0, total: 0 },
                'WF': { name: 'å®Ÿç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼', tests: [], passed: 0, total: 0 }
            };
            
            Object.entries(testResults).forEach(([testId, result]) => {
                const category = testId.substring(0, 2);
                if (categoryResults[category]) {
                    categoryResults[category].tests.push({ id: testId, result: result });
                    categoryResults[category].total++;
                    if (result) categoryResults[category].passed++;
                }
            });
            
            const categoryHTML = Object.entries(categoryResults).map(([catId, cat]) => {
                if (cat.total === 0) return '';
                
                const catPassRate = (cat.passed / cat.total) * 100;
                const catStatus = catPassRate === 100 ? 'âœ…' : catPassRate >= 80 ? 'âš ï¸' : 'âŒ';
                
                return `
                    <div>
                        ${catStatus} <strong>${cat.name}</strong>: ${cat.passed}/${cat.total} (${catPassRate.toFixed(1)}%)
                        <div style="margin-left: 20px; font-size: 14px;">
                            ${cat.tests.map(t => `${t.result ? 'âœ…' : 'âŒ'} ${t.id}`).join(', ')}
                        </div>
                    </div>
                `;
            }).join('');
            
            const overallStatus = passRate === 100 ? 'âœ… å…¨ãƒ†ã‚¹ãƒˆPASS' : 
                                  passRate >= 80 ? 'âš ï¸ éƒ¨åˆ†çš„æˆåŠŸ' : 'âŒ å¤šæ•°å¤±æ•—';
            
            document.getElementById('overall-results').innerHTML = `
                <div class="${passRate === 100 ? 'success-message' : passRate >= 80 ? '' : 'error-message'}">
                    <h3>${overallStatus}</h3>
                    <div>ç·åˆæˆç¸¾: ${passedTests}/${totalTests} (${passRate.toFixed(1)}%)</div>
                </div>
                
                <h4>ğŸ“Š ã‚«ãƒ†ã‚´ãƒªåˆ¥çµæœ</h4>
                ${categoryHTML}
                
                <h4>ğŸ¯ å¿…é ˆåŸºæº–ãƒã‚§ãƒƒã‚¯</h4>
                <div>
                    ${categoryResults.MC.total > 0 ? 
                      `<div>${categoryResults.MC.passed === categoryResults.MC.total ? 'âœ…' : 'âŒ'} è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ†é›¢: ${categoryResults.MC.passed}/${categoryResults.MC.total}</div>` : ''}
                    ${categoryResults.EH.total > 0 ? 
                      `<div>${categoryResults.EH.passed === categoryResults.EH.total ? 'âœ…' : 'âŒ'} ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: ${categoryResults.EH.passed}/${categoryResults.EH.total}</div>` : ''}
                    ${categoryResults.PF.total > 0 ? 
                      `<div>${categoryResults.PF.passed === categoryResults.PF.total ? 'âœ…' : 'âŒ'} ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: ${categoryResults.PF.passed}/${categoryResults.PF.total}</div>` : ''}
                    ${categoryResults.WF.total > 0 ? 
                      `<div>${categoryResults.WF.passed === categoryResults.WF.total ? 'âœ…' : 'âŒ'} å®Ÿç”¨æ€§: ${categoryResults.WF.passed}/${categoryResults.WF.total}</div>` : ''}
                </div>
                
                <div style="margin-top: 15px; padding: 10px; border-top: 1px solid rgba(255,255,255,0.3);">
                    <strong>Phase 4ç§»è¡Œåˆ¤å®š:</strong> ${passRate === 100 ? 'âœ… æ¡ä»¶ã‚¯ãƒªã‚¢' : 'âŒ æ”¹å–„å¿…è¦'}
                </div>
            `;
        }

        function generateDetailedReport() {
            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    total: Object.keys(testResults).length,
                    passed: Object.values(testResults).filter(r => r).length,
                    failed: Object.values(testResults).filter(r => !r).length
                },
                results: testResults,
                environment: {
                    userAgent: navigator.userAgent,
                    localStorage: typeof Storage !== 'undefined',
                    performanceMemory: !!performance.memory
                }
            };
            
            console.log('ğŸ“Š è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ', report);
            
            // ãƒ¬ãƒãƒ¼ãƒˆã‚’JSONå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã«ã™ã‚‹
            const reportJson = JSON.stringify(report, null, 2);
            const blob = new Blob([reportJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `spine-settings-persistence-phase3-3-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
        }

        function exportTestResults() {
            const results = {
                testResults: testResults,
                timestamp: new Date().toISOString(),
                settings: persistence.getAllForCurrentPage()
            };
            
            const csv = [
                'TestID,Result,Category,Description',
                ...Object.entries(testResults).map(([id, result]) => {
                    const category = id.substring(0, 2);
                    const categoryNames = {
                        'MC': 'Multiple Character',
                        'EH': 'Error Handling', 
                        'PF': 'Performance',
                        'WF': 'Workflow'
                    };
                    return `${id},${result ? 'PASS' : 'FAIL'},${categoryNames[category] || 'Unknown'},Test ${id}`;
                })
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-results-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('ãƒ†ã‚¹ãƒˆçµæœã‚’CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        }

        function generateTestReport() {
            if (Object.keys(testResults).length === 0) {
                alert('ã¾ãšãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
                return;
            }
            
            generateDetailedReport();
        }
    </script>
</body>
</html>