<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新しいパネル入れ替えシステム テスト</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e1e1e;
            color: white;
            height: 100vh;
            display: grid;
            grid-template-areas: 
                "header header header"
                "outliner preview properties"
                "timeline timeline timeline";
            grid-template-columns: var(--outliner-width, 300px) 1fr var(--properties-width, 300px);
            grid-template-rows: 60px 1fr var(--timeline-height, 200px);
            gap: 1px;
        }
        
        /* ヘッダー */
        .top-bar {
            grid-area: header;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .test-btn {
            background: #007acc;
            border: 1px solid #0099ff;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .test-btn:hover {
            background: #0099ff;
            transform: translateY(-1px);
        }
        
        .test-status {
            background: #00ff88;
            color: black;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* パネル共通スタイル */
        .panel {
            background: #2d2d2d;
            border: 1px solid #404040;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .panel:hover {
            border-color: #555555;
        }
        
        .panel-header {
            height: 32px;
            background: #3a3a3a;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            cursor: move;
            user-select: none;
            transition: all 0.2s ease;
        }
        
        .panel-header:hover {
            background: #4a4a4a;
        }
        
        .panel-header.dragging {
            background: #007acc;
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(0, 122, 204, 0.4);
            z-index: 1000;
            position: relative;
        }
        
        .panel-title {
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .panel-content {
            flex: 1;
            padding: 15px;
            overflow: auto;
            position: relative;
        }
        
        /* 各パネル配置 */
        .panel-outliner { grid-area: outliner; }
        .panel-preview { 
            grid-area: preview;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
        }
        .panel-properties { grid-area: properties; }
        .panel-timeline { grid-area: timeline; }
        
        /* プレビューエリア特別スタイル */
        .preview-area {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            text-align: center;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        
        .preview-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 25% 25%, rgba(0, 122, 204, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(0, 255, 136, 0.1) 0%, transparent 50%);
            z-index: 1;
        }
        
        .preview-content {
            z-index: 2;
            position: relative;
        }
        
        /* ドロップエリア説明 */
        .drop-areas-guide {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 4px;
            font-size: 10px;
            max-width: 200px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 100;
        }
        
        .panel-content:hover .drop-areas-guide {
            opacity: 1;
        }
        
        /* デバッグパネル */
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 8px;
            font-size: 11px;
            max-width: 350px;
            opacity: 0.9;
            transition: opacity 0.3s ease;
            border: 1px solid #333;
            z-index: 2000;
        }
        
        .debug-panel:hover {
            opacity: 1;
        }
        
        .debug-panel h4 {
            color: #00ff88;
            margin-bottom: 10px;
            font-size: 13px;
        }
        
        .debug-info {
            margin: 4px 0;
            color: #cccccc;
            display: flex;
            justify-content: space-between;
        }
        
        .debug-info .label {
            color: #999;
        }
        
        .debug-info .value {
            color: #00ff88;
            font-weight: 500;
        }
        
        /* ドロップエリアの説明 */
        .drop-area-legend {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #333;
        }
        
        .drop-area-legend h5 {
            color: #ffdd00;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .legend-item {
            margin: 3px 0;
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .legend-color.top { background: rgba(0, 255, 136, 0.6); }
        .legend-color.right { background: rgba(0, 122, 204, 0.6); }
        .legend-color.bottom { background: rgba(255, 187, 0, 0.6); }
        .legend-color.left { background: rgba(255, 107, 107, 0.6); }
        .legend-color.center { background: rgba(138, 43, 226, 0.6); }
        
        /* 操作ガイド */
        .operation-guide {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            padding: 12px;
            border-radius: 8px;
            font-size: 11px;
            max-width: 300px;
            border: 1px solid #333;
        }
        
        .operation-guide h4 {
            color: #007acc;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .operation-step {
            margin: 4px 0;
            color: #ccc;
        }
        
        .step-number {
            color: #00ff88;
            font-weight: bold;
        }
        
        /* 仕様書準拠の説明 */
        .spec-compliance {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #333;
            font-size: 10px;
            color: #777;
        }
        
        .spec-compliance .highlight {
            color: #00ff88;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- ヘッダー -->
    <div class="top-bar">
        <div>
            <span style="font-weight: bold; color: #00ff88;">🎯 新しいパネル入れ替えシステム</span>
            <span style="margin-left: 15px; color: #666; font-size: 11px;">仕様書準拠版</span>
        </div>
        
        <div class="test-controls">
            <button class="test-btn" onclick="resetLayout()">📐 レイアウトリセット</button>
            <button class="test-btn" onclick="showSpecification()">📋 仕様書確認</button>
            <button class="test-btn" onclick="toggleLayoutManager()">🎛️ LayoutManager切替</button>
            <div class="test-status" id="system-status">新システム準備中</div>
        </div>
    </div>

    <!-- アウトライナーパネル -->
    <div class="panel panel-outliner" data-panel="outliner">
        <div class="panel-header">
            <span class="panel-title">📁 アウトライナー</span>
            <div style="font-size: 10px; color: #666;">ドラッグ可能</div>
        </div>
        <div class="panel-content">
            <div class="drop-areas-guide">
                <strong style="color: #00ff88;">📍 ドロップエリア:</strong><br>
                <span style="color: #00ff88;">上辺</span> - 上に配置<br>
                <span style="color: #007acc;">右辺</span> - 右に配置<br>
                <span style="color: #ffbb00;">下辺</span> - 下に配置<br>
                <span style="color: #ff6b6b;">左辺</span> - 左に配置<br>
                <span style="color: #8a2be2;">中央</span> - 入れ替え
            </div>
            
            <div style="color: #999; font-size: 13px;">
                <p style="margin-bottom: 15px;">📂 プロジェクト構造</p>
                <div style="margin: 15px 0; padding: 10px; background: rgba(0, 122, 204, 0.1); border-radius: 4px;">
                    <strong style="color: #007acc;">🎯 テスト手順:</strong>
                    <div style="margin-top: 8px; font-size: 11px; line-height: 1.4;">
                        1. このヘッダーをドラッグ<br>
                        2. プレビューパネル上に移動<br>
                        3. <span class="highlight">4つのドロップエリア</span>を確認<br>
                        4. 隣接チェック動作を確認
                    </div>
                </div>
                <ul style="list-style: none; margin-left: 10px;">
                    <li style="margin: 5px 0;"><span style="color: #00ff88;">🟢</span> NewPanelSwapController.js</li>
                    <li style="margin: 5px 0;"><span style="color: #007acc;">🔵</span> 4つのドロップエリア判定</li>
                    <li style="margin: 5px 0;"><span style="color: #ffdd00;">🟡</span> 空白ゼロ原則実装</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- プレビューパネル -->
    <div class="panel panel-preview" data-panel="preview">
        <div class="panel-header">
            <span class="panel-title">🎬 プレビュー</span>
            <div style="font-size: 10px; color: #666;">ドロップターゲット</div>
        </div>
        <div class="panel-content">
            <div class="drop-areas-guide">
                <strong style="color: #ffdd00;">⚠️ 隣接チェック:</strong><br>
                <span style="color: #ff6b6b;">左辺無効</span> - アウトライナーと隣接<br>
                <span style="color: #999;">右辺無効</span> - プロパティと隣接<br>
                <span style="color: #00ff88;">上下辺・中央</span> - 有効
            </div>
            
            <div class="preview-area">
                <div class="preview-content">
                    <div style="font-size: 48px; margin-bottom: 15px;">🎯</div>
                    <p style="margin-bottom: 8px;">新しいパネル入れ替えシステム</p>
                    <p style="font-size: 10px; color: #555;">4つのドロップエリア対応</p>
                    <div style="margin-top: 20px; padding: 15px; background: rgba(0, 255, 136, 0.1); border-radius: 8px;">
                        <strong style="color: #00ff88;">✨ 仕様書準拠機能:</strong>
                        <ul style="text-align: left; margin-top: 10px; font-size: 11px;">
                            <li>🎯 4つのドロップエリア（上下左右+中央）</li>
                            <li>🚫 隣接チェック（隣り合う辺は無効化）</li>
                            <li>📐 空白ゼロ原則（自動拡張）</li>
                            <li>🎨 直感的配置（ドロップ位置＝配置位置）</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- プロパティパネル -->
    <div class="panel panel-properties" data-panel="properties">
        <div class="panel-header">
            <span class="panel-title">⚙️ プロパティ</span>
            <div style="font-size: 10px; color: #666;">設定パネル</div>
        </div>
        <div class="panel-content">
            <div class="drop-areas-guide">
                <strong style="color: #ffdd00;">⚠️ 隣接チェック:</strong><br>
                <span style="color: #999;">左辺無効</span> - プレビューと隣接<br>
                <span style="color: #00ff88;">右辺・上下辺・中央</span> - 有効
            </div>
            
            <div style="font-size: 12px;">
                <div style="margin-bottom: 15px; padding: 10px; background: rgba(138, 43, 226, 0.1); border-radius: 4px;">
                    <strong style="color: #8a2be2;">📋 仕様確認:</strong>
                    <ul style="margin-top: 8px; font-size: 11px; line-height: 1.4;">
                        <li>• <strong>面エリア</strong>: 60%×60%の中央エリア</li>
                        <li>• <strong>辺エリア</strong>: 各辺20%の範囲</li>
                        <li>• <strong>隣接無効</strong>: 既に隣り合う辺は無効</li>
                        <li>• <strong>自動拡張</strong>: 空白エリアは自動で埋める</li>
                    </ul>
                </div>
                
                <div style="padding: 10px; background: rgba(255, 187, 0, 0.1); border-radius: 4px;">
                    <strong style="color: #ffbb00;">🧪 テスト例:</strong>
                    <ul style="margin-top: 8px; font-size: 11px; line-height: 1.4;">
                        <li>• アウトライナー → プレビュー上辺</li>
                        <li>• 結果: 左側が上下2分割</li>
                        <li>• プロパティ: 縦長のまま</li>
                        <li>• タイムライン: 横長のまま</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- タイムラインパネル -->
    <div class="panel panel-timeline" data-panel="timeline">
        <div class="panel-header">
            <span class="panel-title">⏰ タイムライン</span>
            <div style="font-size: 10px; color: #666;">横長パネル</div>
        </div>
        <div class="panel-content">
            <div class="drop-areas-guide">
                <strong style="color: #00ff88;">✅ 全エリア有効:</strong><br>
                上下左右の辺・中央エリア<br>
                <span style="color: #666;">（他パネルと隣接なし）</span>
            </div>
            
            <div style="text-align: center; color: #666;">
                <div style="font-size: 32px; margin-bottom: 10px;">⏯️</div>
                <p>アニメーション制御エリア</p>
                <p style="font-size: 10px; margin-top: 5px;">横長レイアウト・全ドロップエリア有効</p>
                
                <div style="margin-top: 15px; padding: 10px; background: rgba(255, 107, 107, 0.1); border-radius: 4px;">
                    <strong style="color: #ff6b6b;">🎯 重要な仕様:</strong>
                    <div style="font-size: 11px; margin-top: 5px; line-height: 1.4;">
                        タイムラインは基本的に横長を維持。<br>
                        他パネルとの分割時も横幅は画面全体をカバー。
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- デバッグパネル -->
    <div class="debug-panel">
        <h4>🔍 新システム監視</h4>
        <div class="debug-info">
            <span class="label">システム状態:</span>
            <span class="value" id="system-state">初期化中</span>
        </div>
        <div class="debug-info">
            <span class="label">ドラッグ状態:</span>
            <span class="value" id="drag-state">待機中</span>
        </div>
        <div class="debug-info">
            <span class="label">現在のドロップエリア:</span>
            <span class="value" id="current-drop-area">なし</span>
        </div>
        <div class="debug-info">
            <span class="label">ハイライト数:</span>
            <span class="value" id="highlight-count">5</span>
        </div>
        
        <div class="drop-area-legend">
            <h5>🎨 ドロップエリア色分け</h5>
            <div class="legend-item">
                <div class="legend-color top"></div>
                <span>上辺 - 上に配置</span>
            </div>
            <div class="legend-item">
                <div class="legend-color right"></div>
                <span>右辺 - 右に配置</span>
            </div>
            <div class="legend-item">
                <div class="legend-color bottom"></div>
                <span>下辺 - 下に配置</span>
            </div>
            <div class="legend-item">
                <div class="legend-color left"></div>
                <span>左辺 - 左に配置</span>
            </div>
            <div class="legend-item">
                <div class="legend-color center"></div>
                <span>中央 - 入れ替え</span>
            </div>
        </div>
    </div>
    
    <!-- 操作ガイド -->
    <div class="operation-guide">
        <h4>📖 操作ガイド（仕様書準拠）</h4>
        <div class="operation-step"><span class="step-number">1.</span> パネルヘッダーをドラッグ開始</div>
        <div class="operation-step"><span class="step-number">2.</span> 他のパネル上に移動</div>
        <div class="operation-step"><span class="step-number">3.</span> 5つのドロップエリアが色分け表示</div>
        <div class="operation-step"><span class="step-number">4.</span> 隣接エリアは自動的に無効化</div>
        <div class="operation-step"><span class="step-number">5.</span> ESCキーでドラッグキャンセル</div>
        
        <div class="spec-compliance">
            <strong class="highlight">🎯 仕様書準拠ポイント:</strong><br>
            • 空白ゼロ原則 - 空いた空間は隣接パネルが拡張<br>
            • 隣接チェック - 既に隣り合う辺は無効化<br>
            • 直感的配置 - ドロップした位置にそのまま配置
        </div>
    </div>

    <!-- 新しいパネル入れ替えシステム読み込み -->
    <script type="module">
        import { NewPanelSwapController } from './micromodules/ui/NewPanelSwapController.js';
        
        // 簡易パネルマネージャー
        class TestPanelManager {
            getAllPanels() {
                return ['outliner', 'preview', 'properties', 'timeline'];
            }
            
            findPanel(panelId) {
                const element = document.querySelector(`.panel[data-panel="${panelId}"]`);
                return element ? { element, id: panelId } : null;
            }
        }
        
        // システム初期化
        let newPanelSwapController = null;
        let panelManager = null;
        
        async function initializeNewSystem() {
            console.log('🎯 新しいパネル入れ替えシステム初期化開始');
            
            try {
                // インスタンス作成
                panelManager = new TestPanelManager();
                newPanelSwapController = new NewPanelSwapController(panelManager);
                
                // 初期化
                const result = await newPanelSwapController.initialize();
                
                // グローバル設定
                window.newPanelSwapSystem = {
                    controller: newPanelSwapController,
                    panelManager: panelManager
                };
                
                // デバッグ監視開始
                startDebugMonitoring();
                
                console.log(`✅ 新システム初期化完了: ${result}個のパネル`);
                updateSystemStatus('準備完了', 'ready');
                
            } catch (error) {
                console.error('❌ 新システム初期化エラー:', error);
                updateSystemStatus('エラー', 'error');
            }
        }
        
        // デバッグ監視
        function startDebugMonitoring() {
            setInterval(() => {
                if (newPanelSwapController) {
                    const debugInfo = newPanelSwapController.getDebugInfo();
                    updateDebugDisplay(debugInfo);
                }
            }, 100);
        }
        
        // デバッグ表示更新
        function updateDebugDisplay(debugInfo) {
            document.getElementById('system-state').textContent = debugInfo.state;
            document.getElementById('drag-state').textContent = 
                debugInfo.isDragging ? `ドラッグ中: ${debugInfo.draggedPanel}` : '待機中';
            document.getElementById('current-drop-area').textContent = 
                debugInfo.currentDropArea || 'なし';
            document.getElementById('highlight-count').textContent = 
                debugInfo.highlightCount.toString();
        }
        
        // システム状態更新
        function updateSystemStatus(status, state) {
            const statusElement = document.getElementById('system-status');
            statusElement.textContent = status;
            
            if (state === 'ready') {
                statusElement.style.background = '#00ff88';
                statusElement.style.color = 'black';
            } else if (state === 'error') {
                statusElement.style.background = '#ff6b6b';
                statusElement.style.color = 'white';
            }
        }
        
        // テスト機能
        window.resetLayout = function() {
            // レイアウトをデフォルトに戻す
            document.body.style.setProperty('grid-template-areas', 
                '"header header header" "outliner preview properties" "timeline timeline timeline"', 'important');
            document.body.style.setProperty('grid-template-columns', 
                'var(--outliner-width, 300px) 1fr var(--properties-width, 300px)', 'important');
            document.body.style.setProperty('grid-template-rows', 
                '60px 1fr var(--timeline-height, 200px)', 'important');
            
            // 各パネルのgrid-areaをリセット
            document.querySelector('.panel-outliner').style.gridArea = 'outliner';
            document.querySelector('.panel-preview').style.gridArea = 'preview';
            document.querySelector('.panel-properties').style.gridArea = 'properties';
            document.querySelector('.panel-timeline').style.gridArea = 'timeline';
            
            console.log('📐 レイアウトリセット完了');
        };
        
        window.showSpecification = function() {
            alert('📋 パネル入れ替えシステム仕様書\n\n' +
                '🎯 基本原則:\n' +
                '• 空白ゼロ原則 - 空白エリアは作らない\n' +
                '• 4つのドロップエリア - 上下左右の辺+中央面\n' +
                '• 隣接チェック - 隣り合う辺は無効化\n\n' +
                '🔄 動作パターン:\n' +
                '• 面エリア: 単純入れ替え\n' +
                '• 辺エリア: 指定された位置に配置\n' +
                '• 自動拡張: 空いた空間は隣接パネルが埋める\n\n' +
                '詳細: docs/PANEL_SWAP_SPECIFICATION.md');
        };
        
        // 🚨 LayoutManager制御機能
        window.toggleLayoutManager = function() {
            const current = localStorage.getItem('spine-editor-enable-layout-manager') !== 'false';
            const newState = !current;
            
            localStorage.setItem('spine-editor-enable-layout-manager', newState ? 'true' : 'false');
            
            console.log(`🎛️ LayoutManager: ${current ? '有効' : '無効'} → ${newState ? '有効' : '無効'}`);
            
            alert(`🎛️ LayoutManager設定変更\n\n` +
                `現在: ${current ? '有効' : '無効'}\n` +
                `変更後: ${newState ? '有効' : '無効'}\n\n` +
                `⚠️ この変更を適用するにはページをリロード（F5）してください。\n\n` +
                `🚨 パネル入れ替えテスト時は「無効」に設定することを推奨します。`);
        };
        
        // デバッグ用エクスポート
        window.getNewSystemDebugInfo = function() {
            return newPanelSwapController?.getDebugInfo();
        };
        
        // 初期化実行
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🧪 新しいパネル入れ替えシステムテスト開始');
            initializeNewSystem();
        });
    </script>
</body>
</html>