<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ ã‚·ãƒ³ãƒ—ãƒ«Fileâ†’Spineè¡¨ç¤ºãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .step {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }

        .step h2 {
            color: #2d3748;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .file-selector {
            margin-bottom: 15px;
        }

        .file-selector input[type="file"] {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            width: 100%;
        }

        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #3182ce;
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .success-btn {
            background: #48bb78;
        }

        .success-btn:hover {
            background: #38a169;
        }

        .canvas-container {
            text-align: center;
            margin: 20px 0;
        }

        .spine-canvas {
            border: 3px dashed #e2e8f0;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.05);
            transition: border-color 0.3s;
            /* ğŸ¯ ç”»é¢ã„ã£ã±ã„ã‚µã‚¤ã‚º */
            width: 90vw !important;
            height: 60vh !important;
            max-width: 1200px;
            max-height: 800px;
        }

        .spine-canvas.active {
            border-color: #48bb78;
            border-style: solid;
        }

        .status {
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status.info {
            background: #ebf8ff;
            color: #2c5282;
            border: 1px solid #bee3f8;
        }

        .status.success {
            background: #f0fff4;
            color: #276749;
            border: 1px solid #9ae6b4;
        }

        .status.error {
            background: #fed7d7;
            color: #c53030;
            border: 1px solid #feb2b2;
        }

        .log-container {
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .progress-step {
            flex: 1;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            position: relative;
        }

        .progress-step.completed {
            background: #48bb78;
        }

        .progress-step.active {
            background: #4299e1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ ã‚·ãƒ³ãƒ—ãƒ«Fileâ†’Spineè¡¨ç¤ºãƒ†ã‚¹ãƒˆ</h1>
        <p style="text-align: center; color: #718096; margin-bottom: 30px;">
            ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç›´æ¥èª­ã¿è¾¼ã‚“ã§è¡¨ç¤ºã™ã‚‹ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã§ã™
        </p>

        <!-- Step 1: ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
        <div class="step">
            <h2>ğŸ“ Step 1: Spineãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</h2>
            <div class="file-selector">
                <label>ğŸ“„ .atlas ãƒ•ã‚¡ã‚¤ãƒ«:</label>
                <input type="file" id="atlasFile" accept=".atlas" />
            </div>
            <div class="file-selector">
                <label>ğŸ“‹ .json ãƒ•ã‚¡ã‚¤ãƒ«:</label>
                <input type="file" id="jsonFile" accept=".json" />
            </div>
            <div class="file-selector">
                <label>ğŸ–¼ï¸ .png ãƒ•ã‚¡ã‚¤ãƒ«:</label>
                <input type="file" id="textureFile" accept=".png,.jpg,.jpeg" />
            </div>
            <button class="btn" id="loadBtn" onclick="startSpineLoad()" disabled>
                ğŸš€ Spineèª­ã¿è¾¼ã¿é–‹å§‹
            </button>
            <button class="btn success-btn" onclick="loadDefaultSpine()" style="margin-left: 10px;">
                âš¡ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèª­ã¿è¾¼ã¿ï¼ˆnezumiï¼‰
            </button>
            <div id="step1-status"></div>
        </div>

        <!-- Step 2: å¤‰æ›ãƒ»è¡¨ç¤º -->
        <div class="step">
            <h2>ğŸ¯ Step 2: è¡¨ç¤ºçµæœ</h2>
            <div class="progress">
                <div class="progress-step" id="progress-convert"></div>
                <div class="progress-step" id="progress-init"></div>
                <div class="progress-step" id="progress-render"></div>
            </div>
            <div class="canvas-container">
                <canvas id="spineCanvas" class="spine-canvas" width="1200" height="800"></canvas>
                
                <!-- ğŸ›ï¸ CanvasResizeController UIçµ±åˆ -->
                <div class="canvas-controls" style="margin-top: 20px; border: 2px solid #e2e8f0; border-radius: 8px; background: #f8fafc;">
                    <h4 style="margin: 10px; color: #4a5568;">ğŸ›ï¸ Canvasåˆ¶å¾¡</h4>
                    <iframe 
                        src="./micromodules/canvas-resize/ui.html" 
                        id="canvas-resize-iframe"
                        width="100%" 
                        height="400"
                        frameborder="0"
                        style="border-radius: 6px;">
                    </iframe>
                </div>
            </div>
            <button class="btn success-btn" id="testBtn" onclick="testAnimation()" disabled>
                ğŸ­ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
            </button>
            <button class="btn" onclick="toggleSkeletonBounds()" style="background: #e53e3e; margin-left: 10px;">
                ğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¢ƒç•Œè¡¨ç¤º/éè¡¨ç¤º
            </button>
            <button class="btn" onclick="moveToCenter()" style="background: #38a169; margin-left: 10px;">
                ğŸ“ ä¸­å¤®ã«ç§»å‹•
            </button>
            <button class="btn" onclick="makeLarger()" style="background: #3182ce; margin-left: 10px;">
                ğŸ” å¤§ããã™ã‚‹
            </button>
            <button class="btn" onclick="testPositions()" style="background: #805ad5; margin-left: 10px;">
                ğŸ§ª ä½ç½®ãƒ†ã‚¹ãƒˆ
            </button>
            <button class="btn" onclick="fixRendering()" style="background: #d53f8c; margin-left: 10px;">
                ğŸ”§ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¿®æ­£
            </button>
            <button class="btn" onclick="testDirectHTTP()" style="background: #f56500; margin-left: 10px;">
                ğŸŒ ç›´æ¥HTTPèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
            </button>
            <button class="btn" onclick="testDirectFileSpineRenderer()" style="background: #16a085; margin-left: 10px;">
                ğŸ¯ Direct File Renderer (localhost:8000ãƒ‘ã‚¿ãƒ¼ãƒ³)
            </button>
            <button class="btn" onclick="testBasicSpineWebGL()" style="background: #2d3748; margin-left: 10px;">
                âš¡ åŸºæœ¬Spine WebGLãƒ†ã‚¹ãƒˆ
            </button>
            <div id="step2-status"></div>
        </div>

        <!-- ãƒ­ã‚°è¡¨ç¤º -->
        <div class="step">
            <h2>ğŸ“‹ å®Ÿè¡Œãƒ­ã‚°</h2>
            <button class="btn" onclick="clearLogs()" style="background: #718096;">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>

    <!-- å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.24/dist/iife/spine-webgl.js"></script>
    <script src="micromodules/bridge/BlobUrlManager.js"></script>
    <script src="micromodules/bridge/PathGenerator.js"></script>
    <script src="micromodules/bridge/FileToHttpBridge.js"></script>
    <script src="micromodules/spine-renderer/StableSpineRenderer.js"></script>
    <!-- localhost:8000æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ -->
    <script src="micromodules/spine-renderer/DirectSpineLoader.js"></script>
    <script src="micromodules/spine-renderer/DirectFileSpineRenderer.js"></script>
    
    <!-- ğŸ¯ PureBoundingBoxçµ±åˆ -->
    <script src="micromodules/bounding-box/PureBoundingBoxCore.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxUI.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxEvents.js"></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let selectedFiles = {};
        let bridge = null;
        let spineRenderer = null;
        let conversionResult = null;
        let boundingBox = null;

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã®ç›£è¦–
        document.getElementById('atlasFile').addEventListener('change', (e) => updateFileSelection('atlas', e.target.files[0]));
        document.getElementById('jsonFile').addEventListener('change', (e) => updateFileSelection('json', e.target.files[0]));
        document.getElementById('textureFile').addEventListener('change', (e) => updateFileSelection('texture', e.target.files[0]));

        function updateFileSelection(type, file) {
            if (file) {
                selectedFiles[type] = {
                    name: file.name,
                    getFile: async () => file
                };
                log(`âœ… ${type}ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ: ${file.name}`, 'success');
            } else {
                delete selectedFiles[type];
            }

            // å…¨ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
            const hasAllFiles = ['atlas', 'json', 'texture'].every(type => selectedFiles[type]);
            document.getElementById('loadBtn').disabled = !hasAllFiles;

            if (hasAllFiles) {
                setStatus('step1', 'âœ… å…¨ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå®Œäº† - èª­ã¿è¾¼ã¿æº–å‚™OK', 'success');
            } else {
                setStatus('step1', `ğŸ“ ${Object.keys(selectedFiles).length}/3 ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ¸ˆã¿`, 'info');
            }
        }

        async function startSpineLoad() {
            try {
                log('ğŸš€ Spineèª­ã¿è¾¼ã¿å‡¦ç†é–‹å§‹', 'info');
                setStatus('step2', 'â³ å‡¦ç†ä¸­...', 'info');
                
                // ProgressåˆæœŸåŒ–
                document.getElementById('progress-convert').className = 'progress-step';
                document.getElementById('progress-init').className = 'progress-step';
                document.getElementById('progress-render').className = 'progress-step';

                // Step 1: FileToHttpBridgeåˆæœŸåŒ–
                log('ğŸ“¦ FileToHttpBridgeåˆæœŸåŒ–ä¸­...', 'info');
                bridge = new FileToHttpBridge({ debug: true });
                
                // Step 2: ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›
                log('ğŸ”„ ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›å®Ÿè¡Œä¸­...', 'info');
                document.getElementById('progress-convert').className = 'progress-step active';
                
                const characterName = selectedFiles.atlas.name.replace('.atlas', '');
                conversionResult = await bridge.convertCharacterFiles(characterName, selectedFiles);
                
                document.getElementById('progress-convert').className = 'progress-step completed';
                log(`âœ… FileToHttpBridgeå¤‰æ›å®Œäº†: ${characterName}`, 'success');
                log(`  ğŸ”— basePath: ${conversionResult.basePath}`, 'info');
                log(`  ğŸ“ blobUrls: atlas, json, texture æº–å‚™å®Œäº†`, 'info');

                // Step 3: StableSpineRendereråˆæœŸåŒ–
                log('ğŸ¯ StableSpineRendereråˆæœŸåŒ–ä¸­...', 'info');
                document.getElementById('progress-init').className = 'progress-step active';

                // Canvasæº–å‚™
                const canvas = document.getElementById('spineCanvas');
                canvas.className = 'spine-canvas active';

                // ğŸ”¥ ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æº–æ‹ : ã‚·ãƒ³ãƒ—ãƒ«ãªåŸºæœ¬å®Ÿè£…ã«å¤‰æ›´
                spineRenderer = new StableSpineRenderer({
                    canvas: '#spineCanvas',
                    character: characterName,
                    basePath: conversionResult.basePath,
                    blobUrls: conversionResult.blobUrls,
                    position: {
                        x: 0,
                        y: -100,
                        scaleX: 0.55,
                        scaleY: 0.55
                    },
                    defaultAnimation: characterName === 'nezumi' ? 'search' : 'taiki',
                    debug: true
                });
                await spineRenderer.initialize();
                
                document.getElementById('progress-init').className = 'progress-step completed';
                log('âœ… StableSpineRendereråˆæœŸåŒ–å®Œäº†', 'success');

                // Step 4: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
                log('ğŸ­ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ä¸­...', 'info');
                document.getElementById('progress-render').className = 'progress-step active';

                // ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æº–æ‹ ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
                const animationName = characterName === 'nezumi' ? 'search' : 'taiki';
                const animationResult = spineRenderer.playAnimation(animationName);
                if (animationResult) {
                    document.getElementById('progress-render').className = 'progress-step completed';
                    log('ğŸ‰ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹æˆåŠŸï¼', 'success');
                    setStatus('step2', 'ğŸ‰ Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤ºæˆåŠŸï¼', 'success');
                    document.getElementById('testBtn').disabled = false;

                    // ğŸ” è©³ç´°åº§æ¨™ãƒ»çŠ¶æ…‹è¡¨ç¤º
                    console.log("ğŸ” ã€åº§æ¨™ãƒ»çŠ¶æ…‹è©³ç´°ç¢ºèªã€‘");
                    if (spineRenderer.skeleton) {
                        console.log(`ğŸ“ Skeletonåº§æ¨™: x=${spineRenderer.skeleton.x}, y=${spineRenderer.skeleton.y}`);
                        console.log(`ğŸ“ Skeletonã‚¹ã‚±ãƒ¼ãƒ«: scaleX=${spineRenderer.skeleton.scaleX}, scaleY=${spineRenderer.skeleton.scaleY}`);
                        console.log(`ğŸ¯ Skeletonä½ç½®è¨ˆç®—: å®Ÿéš›ã®è¡¨ç¤ºä½ç½® = (${spineRenderer.skeleton.x}, ${spineRenderer.skeleton.y})`);
                        
                        // Skeletonå¢ƒç•Œãƒœãƒƒã‚¯ã‚¹è¨ˆç®—
                        spineRenderer.skeleton.updateWorldTransform();
                        const bounds = new window.spine.SkeletonBounds();
                        bounds.update(spineRenderer.skeleton, true);
                        console.log(`ğŸ“¦ Skeletonå¢ƒç•Œ: minX=${bounds.minX}, maxX=${bounds.maxX}, minY=${bounds.minY}, maxY=${bounds.maxY}`);
                        console.log(`ğŸ“¦ Skeletonä¸­å¿ƒ: centerX=${(bounds.minX + bounds.maxX) / 2}, centerY=${(bounds.minY + bounds.maxY) / 2}`);
                    }
                    
                    if (spineRenderer.canvas) {
                        console.log(`ğŸ“ Canvaså®Ÿã‚µã‚¤ã‚º: ${spineRenderer.canvas.width}Ã—${spineRenderer.canvas.height}`);
                        console.log(`ğŸ“ CanvasCSS: ${spineRenderer.canvas.style.width} Ã— ${spineRenderer.canvas.style.height}`);
                        const rect = spineRenderer.canvas.getBoundingClientRect();
                        console.log(`ğŸ“ Canvasè¡¨ç¤ºã‚µã‚¤ã‚º: ${rect.width}Ã—${rect.height}`);
                    }

                    console.log(`ğŸ¬ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹: ${spineRenderer.isAnimationRunning ? 'å®Ÿè¡Œä¸­' : 'åœæ­¢ä¸­'}`);
                    
                    if (spineRenderer.animationState && spineRenderer.animationState.tracks) {
                        console.log(`ğŸ­ ç¾åœ¨ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: ${spineRenderer.animationState.tracks.length}å€‹ã®ãƒˆãƒ©ãƒƒã‚¯`);
                        for (let i = 0; i < spineRenderer.animationState.tracks.length; i++) {
                            const track = spineRenderer.animationState.tracks[i];
                            if (track && track.animation) {
                                console.log(`  ãƒˆãƒ©ãƒƒã‚¯${i}: ${track.animation.name} (æ™‚é–“: ${track.trackTime.toFixed(2)}s)`);
                            }
                        }
                    }

                    log("ğŸ” åº§æ¨™ãƒ»çŠ¶æ…‹è©³ç´°ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã—ã¦ãã ã•ã„", "info");

                    // ğŸ”§ WebGLé€æ˜å•é¡Œä¿®æ­£
                    if (spineRenderer.gl) {
                        const gl = spineRenderer.gl;
                        console.log("ğŸ” WebGLçŠ¶æ…‹è¨ºæ–­:");
                        console.log(`  Viewport: ${gl.getParameter(gl.VIEWPORT)}`);
                        console.log(`  Clear Color: ${gl.getParameter(gl.COLOR_CLEAR_VALUE)}`);
                        console.log(`  Depth Test: ${gl.getParameter(gl.DEPTH_TEST)}`);
                        console.log(`  Blend: ${gl.getParameter(gl.BLEND)}`);
                        
                        // ğŸš¨ é€æ˜å•é¡Œä¿®æ­£: èƒŒæ™¯ã‚’ä¸é€æ˜ã«ã—ã¦ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å¯è¦–åŒ–
                        log("ğŸ”§ WebGLé€æ˜å•é¡Œä¿®æ­£ä¸­...", "info");
                        gl.clearColor(0.2, 0.3, 0.5, 1.0); // é’ã„ä¸é€æ˜èƒŒæ™¯
                        gl.clear(gl.COLOR_BUFFER_BIT);
                        log("ğŸŸ¦ WebGLèƒŒæ™¯ã‚’é’è‰²ã«å¤‰æ›´ - ä»Šåº¦ã¯ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒè¦‹ãˆã‚‹ã¯ãšã§ã™ï¼", "success");
                        
                        // ã•ã‚‰ã«ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ã€æ‰‹å‹•ã§å†æç”»è¦æ±‚
                        setTimeout(() => {
                            if (spineRenderer.skeleton && spineRenderer.animationState && spineRenderer.renderer) {
                                try {
                                    spineRenderer.skeleton.updateWorldTransform();
                                    spineRenderer.renderer.begin();
                                    spineRenderer.renderer.drawSkeleton(spineRenderer.skeleton, true);
                                    spineRenderer.renderer.end();
                                    log("ğŸ¨ æ‰‹å‹•å†æç”»å®Ÿè¡Œå®Œäº†", "success");
                                } catch (error) {
                                    log(`âŒ æ‰‹å‹•å†æç”»ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
                                }
                            }
                        }, 500);
                        
                        // ğŸ›ï¸ CanvasResizeControlleråˆæœŸåŒ–é€šä¿¡
                        setTimeout(() => {
                            const iframe = document.getElementById('canvas-resize-iframe');
                            if (iframe && iframe.contentWindow) {
                                iframe.contentWindow.postMessage({
                                    type: 'initCanvasState',
                                    data: {
                                        canvasWidth: spineRenderer.canvas.width,
                                        canvasHeight: spineRenderer.canvas.height,
                                        characterX: spineRenderer.skeleton.x,
                                        characterY: spineRenderer.skeleton.y,
                                        characterScaleX: spineRenderer.skeleton.scaleX,
                                        characterScaleY: spineRenderer.skeleton.scaleY
                                    }
                                }, '*');
                                log("ğŸ›ï¸ CanvasResizeControlleråˆæœŸåŒ–å®Œäº†", "success");
                            }
                        }, 1500);
                        
                        // ğŸ¯ PureBoundingBoxçµ±åˆ - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯è¦–åŒ–
                        setTimeout(() => {
                            initializeBoundingBox();
                        }, 2000);
                    }
                } else {
                    log('âŒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹å¤±æ•—', 'error');
                    setStatus('step2', 'âŒ è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }

            } catch (error) {
                log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('Spineèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                setStatus('step2', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        function testAnimation() {
            if (!spineRenderer) {
                log('âš ï¸ SpineRendererãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
                return;
            }

            try {
                // åˆ©ç”¨å¯èƒ½ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’å–å¾—
                const skeleton = spineRenderer.skeleton;
                if (skeleton && skeleton.data && skeleton.data.animations) {
                    const animations = skeleton.data.animations.map(anim => anim.name);
                    log(`ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: ${animations.join(', ')}`, 'info');
                    
                    if (animations.length > 0) {
                        const randomAnim = animations[Math.floor(Math.random() * animations.length)];
                        spineRenderer.playAnimation(randomAnim);
                        log(`ğŸ­ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ: ${randomAnim}`, 'success');
                    }
                }
            } catch (error) {
                log(`âŒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        function setStatus(elementId, message, type) {
            const element = document.getElementById(elementId + '-status');
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const color = {
                'info': '#81d4fa',
                'success': '#a5d6a7', 
                'warning': '#ffcc02',
                'error': '#ef5350'
            }[type] || '#e2e8f0';

            container.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            container.scrollTop = container.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
        }

        // âš¡ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèª­ã¿è¾¼ã¿æ©Ÿèƒ½ï¼ˆnezumiï¼‰
        async function loadDefaultSpine() {
            try {
                log('âš¡ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆSpineèª­ã¿è¾¼ã¿é–‹å§‹ï¼ˆnezumiï¼‰', 'info');
                setStatus('step1', 'â³ nezumiãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ä¸­...', 'info');

                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
                const basePath = '../assets/spine/characters/nezumi/';
                const fileNames = {
                    atlas: 'nezumi.atlas',
                    json: 'nezumi.json',
                    texture: 'nezumi.png'
                };

                // HTTPã§ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—
                const fileHandles = {};
                for (const [type, fileName] of Object.entries(fileNames)) {
                    try {
                        const response = await fetch(basePath + fileName);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${fileName}`);
                        }
                        const arrayBuffer = await response.arrayBuffer();
                        const blob = new Blob([arrayBuffer]);
                        
                        fileHandles[type] = {
                            name: fileName,
                            getFile: async () => new File([blob], fileName, { 
                                type: type === 'texture' ? 'image/png' : 'text/plain' 
                            })
                        };
                        
                        log(`âœ… ${fileName} å–å¾—å®Œäº† (${(arrayBuffer.byteLength / 1024).toFixed(1)} KB)`, 'success');
                    } catch (error) {
                        log(`âŒ ${fileName} å–å¾—å¤±æ•—: ${error.message}`, 'error');
                        throw error;
                    }
                }

                setStatus('step1', 'âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å–å¾—å®Œäº†', 'success');
                
                // selectedFilesã«è¨­å®š
                selectedFiles = fileHandles;
                
                // è‡ªå‹•çš„ã«Spineèª­ã¿è¾¼ã¿é–‹å§‹
                await startSpineLoad();
                
            } catch (error) {
                log(`âŒ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                setStatus('step1', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ğŸ›ï¸ CanvasResizeController postMessageé€šä¿¡
        window.addEventListener('message', (event) => {
            const { type, data } = event.data;
            
            switch (type) {
                case 'canvasResize':
                    if (spineRenderer && spineRenderer.canvas) {
                        const canvas = spineRenderer.canvas;
                        canvas.width = data.width;
                        canvas.height = data.height;
                        
                        // WebGL viewportæ›´æ–°
                        if (spineRenderer.gl) {
                            spineRenderer.gl.viewport(0, 0, data.width, data.height);
                        }
                        
                        log(`ğŸ›ï¸ Canvasè§£åƒåº¦å¤‰æ›´: ${data.width}Ã—${data.height}`, 'info');
                    }
                    break;
                    
                case 'characterMove':
                    if (spineRenderer && spineRenderer.skeleton) {
                        spineRenderer.skeleton.x = data.x;
                        spineRenderer.skeleton.y = data.y;
                        log(`ğŸ›ï¸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®å¤‰æ›´: (${data.x}, ${data.y})`, 'info');
                    }
                    break;
                    
                case 'characterScale':
                    if (spineRenderer && spineRenderer.skeleton) {
                        spineRenderer.skeleton.scaleX = data.scaleX;
                        spineRenderer.skeleton.scaleY = data.scaleY;
                        log(`ğŸ›ï¸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´: ${data.scaleX}Ã—${data.scaleY}`, 'info');
                    }
                    break;
                    
                default:
                    console.log('ğŸ›ï¸ CanvasResizeController:', type, data);
                    break;
            }
        });

        // ğŸ¯ PureBoundingBoxåˆæœŸåŒ–é–¢æ•°
        function initializeBoundingBox() {
            try {
                if (!spineRenderer || !spineRenderer.canvas) {
                    log("âš ï¸ SpineRendererã¾ãŸã¯CanvasãŒæœªåˆæœŸåŒ–", "warning");
                    return;
                }

                log("ğŸ¯ PureBoundingBoxåˆæœŸåŒ–ä¸­...", "info");

                // Canvasè¦ç´ ã‚’ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹å¯¾è±¡ã¨ã—ã¦è¨­å®š
                const canvas = spineRenderer.canvas;
                
                // PureBoundingBoxCoreåˆæœŸåŒ–
                const core = new PureBoundingBoxCore({
                    targetElement: canvas,
                    nodeId: 'spine-character-bb',
                    minWidth: 50,
                    minHeight: 50
                });

                // PureBoundingBoxUIåˆæœŸåŒ–
                const ui = new PureBoundingBoxUI(core);
                
                // PureBoundingBoxEventsåˆæœŸåŒ–
                const events = new PureBoundingBoxEvents(core, ui);

                // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤ºï¼ˆCanvasä¸Šã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰
                const bb = ui.createBoundingBoxUI();
                document.body.appendChild(bb);
                
                // Canvasã®ä½ç½®ãƒ»ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦BBã‚’é…ç½®
                const rect = canvas.getBoundingClientRect();
                core.bounds = {
                    x: rect.left + window.scrollX,
                    y: rect.top + window.scrollY,
                    width: rect.width,
                    height: rect.height
                };

                // BBã®ä½ç½®ã‚’æ›´æ–°
                ui.syncPosition();
                ui.show(); // ç¢ºå®Ÿã«è¡¨ç¤º

                boundingBox = { core, ui, events };
                
                log("âœ… PureBoundingBoxåˆæœŸåŒ–å®Œäº† - é’ã„æ ã§Canvasç¯„å›²ã‚’å¯è¦–åŒ–", "success");
                log("ğŸ” é’ã„æ å†…ã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒæç”»ã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™", "info");

                // Canvasç¯„å›²ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
                canvas.style.border = "3px solid #ff6b6b";
                canvas.style.boxShadow = "0 0 20px rgba(255, 107, 107, 0.5)";
                
                // ã‚¹ã‚±ãƒ«ãƒˆãƒ³å¢ƒç•Œã‚‚å¯è¦–åŒ–
                if (spineRenderer.skeleton) {
                    showSkeletonBounds(spineRenderer.skeleton);
                }

            } catch (error) {
                log(`âŒ PureBoundingBoxåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
                console.error("PureBoundingBoxåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
            }
        }

        // ã‚¹ã‚±ãƒ«ãƒˆãƒ³å¢ƒç•Œå¯è¦–åŒ–é–¢æ•°
        function showSkeletonBounds(skeleton) {
            try {
                skeleton.updateWorldTransform();
                const bounds = new window.spine.SkeletonBounds();
                bounds.update(skeleton, true);
                
                // Canvasåº§æ¨™ç³»ã§ã®å¢ƒç•Œã‚’è¨ˆç®—
                const canvas = spineRenderer.canvas;
                const rect = canvas.getBoundingClientRect();
                
                // ã‚¹ã‚±ãƒ«ãƒˆãƒ³å¢ƒç•Œã‚’ç”»é¢åº§æ¨™ã«å¤‰æ›
                const boundingDiv = document.createElement('div');
                boundingDiv.id = 'skeleton-bounds-indicator';
                boundingDiv.style.cssText = `
                    position: fixed;
                    border: 2px dashed #ff6b6b;
                    background: rgba(255, 107, 107, 0.1);
                    pointer-events: none;
                    z-index: 10001;
                    left: ${rect.left + (bounds.minX + canvas.width/2)}px;
                    top: ${rect.top + (canvas.height/2 - bounds.maxY)}px;
                    width: ${bounds.maxX - bounds.minX}px;
                    height: ${bounds.maxY - bounds.minY}px;
                `;
                
                // æ—¢å­˜ã®å¢ƒç•Œè¡¨ç¤ºã‚’å‰Šé™¤
                const existing = document.getElementById('skeleton-bounds-indicator');
                if (existing) existing.remove();
                
                document.body.appendChild(boundingDiv);
                
                log(`ğŸ” ã‚¹ã‚±ãƒ«ãƒˆãƒ³å¢ƒç•Œå¯è¦–åŒ–: (${bounds.minX.toFixed(1)}, ${bounds.minY.toFixed(1)}) â†’ (${bounds.maxX.toFixed(1)}, ${bounds.maxY.toFixed(1)})`, "info");
                log("ğŸ¯ èµ¤ã„ç‚¹ç·šæ  = ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å®Ÿéš›ã®å¢ƒç•Œ", "success");

            } catch (error) {
                log(`âŒ ã‚¹ã‚±ãƒ«ãƒˆãƒ³å¢ƒç•Œå¯è¦–åŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
            }
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¢ƒç•Œè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleSkeletonBounds() {
            const existing = document.getElementById('skeleton-bounds-indicator');
            if (existing) {
                existing.remove();
                log("ğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¢ƒç•Œéè¡¨ç¤º", "info");
            } else {
                // åŸºæœ¬WebGLãƒ†ã‚¹ãƒˆç”¨ã¨StableSpineRendererç”¨ã®ä¸¡æ–¹ã«å¯¾å¿œ
                const targetSkeleton = window.basicSpineComponents?.skeleton || (spineRenderer && spineRenderer.skeleton);
                if (targetSkeleton) {
                    showSkeletonBounds(targetSkeleton);
                    log("ğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¢ƒç•Œè¡¨ç¤º", "success");
                } else {
                    log("âš ï¸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“", "warning");
                }
            }
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä¸­å¤®ã«ç§»å‹•
        function moveToCenter() {
            // åŸºæœ¬WebGLãƒ†ã‚¹ãƒˆç”¨ã¨StableSpineRendererç”¨ã®ä¸¡æ–¹ã«å¯¾å¿œ
            const targetSkeleton = window.basicSpineComponents?.skeleton || (spineRenderer && spineRenderer.skeleton);
            
            if (targetSkeleton) {
                targetSkeleton.x = 600; // Canvasä¸­å¤®
                targetSkeleton.y = spineRenderer ? -400 : 400; // StableSpineRendererç”¨ã¯è² ã®å€¤ã€åŸºæœ¬WebGLç”¨ã¯æ­£ã®å€¤
                log(`ğŸ“ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä¸­å¤®ã«ç§»å‹•: (600, ${spineRenderer ? -400 : 400})`, "success");
                
                // å¢ƒç•Œè¡¨ç¤ºã‚’æ›´æ–°
                const existing = document.getElementById('skeleton-bounds-indicator');
                if (existing) {
                    showSkeletonBounds(spineRenderer.skeleton);
                }
            } else {
                log("âš ï¸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“", "warning");
            }
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å¤§ããã™ã‚‹
        function makeLarger() {
            if (spineRenderer && spineRenderer.skeleton) {
                const currentScale = spineRenderer.skeleton.scaleX;
                const newScale = currentScale * 1.5;
                spineRenderer.skeleton.scaleX = newScale;
                spineRenderer.skeleton.scaleY = newScale;
                log(`ğŸ” ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚µã‚¤ã‚ºå¤‰æ›´: ${currentScale.toFixed(2)} â†’ ${newScale.toFixed(2)}`, "success");
                
                // å¢ƒç•Œè¡¨ç¤ºã‚’æ›´æ–°
                const existing = document.getElementById('skeleton-bounds-indicator');
                if (existing) {
                    showSkeletonBounds(spineRenderer.skeleton);
                }
            } else {
                log("âš ï¸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“", "warning");
            }
        }

        // ä½ç½®ãƒ†ã‚¹ãƒˆï¼ˆæ§˜ã€…ãªåº§æ¨™ã‚’è©¦ã™ï¼‰
        let testIndex = 0;
        function testPositions() {
            if (!spineRenderer || !spineRenderer.skeleton) {
                log("âš ï¸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“", "warning");
                return;
            }

            const testPositions = [
                {x: 600, y: 0, desc: "ä¸­å¤®ä¸‹"},
                {x: 600, y: -200, desc: "ä¸­å¤®ã‚„ã‚„ä¸Š"},
                {x: 600, y: -400, desc: "ä¸­å¤®"},
                {x: 600, y: -600, desc: "ä¸­å¤®ã‚„ã‚„ä¸‹"},
                {x: 600, y: -800, desc: "ä¸­å¤®ä¸Š"},
                {x: 300, y: -400, desc: "å·¦ä¸­å¤®"},
                {x: 900, y: -400, desc: "å³ä¸­å¤®"},
                {x: 0, y: 0, desc: "åŸç‚¹(0,0)"}
            ];

            const pos = testPositions[testIndex % testPositions.length];
            spineRenderer.skeleton.x = pos.x;
            spineRenderer.skeleton.y = pos.y;
            
            log(`ğŸ§ª ä½ç½®ãƒ†ã‚¹ãƒˆ ${testIndex + 1}: (${pos.x}, ${pos.y}) - ${pos.desc}`, "info");
            testIndex++;

            // å¢ƒç•Œè¡¨ç¤ºã‚’æ›´æ–°
            const existing = document.getElementById('skeleton-bounds-indicator');
            if (existing) {
                showSkeletonBounds(spineRenderer.skeleton);
            }
        }

        // WebGLãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¿®æ­£
        function fixRendering() {
            if (!spineRenderer) {
                log("âš ï¸ SpineRendererãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“", "warning");
                return;
            }

            try {
                log("ğŸ”§ WebGLãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¿®æ­£é–‹å§‹...", "info");

                // 1. WebGLè¨­å®šç¢ºèªãƒ»ä¿®æ­£
                if (spineRenderer.gl) {
                    const gl = spineRenderer.gl;
                    
                    // é€æ˜åº¦è¨­å®šã‚’ç¢ºèªãƒ»ä¿®æ­£
                    log(`ğŸ” ç¾åœ¨ã®WebGLè¨­å®šç¢ºèª:`, "info");
                    const clearColor = gl.getParameter(gl.COLOR_CLEAR_VALUE);
                    log(`  Clear Color: [${clearColor[0].toFixed(2)}, ${clearColor[1].toFixed(2)}, ${clearColor[2].toFixed(2)}, ${clearColor[3].toFixed(2)}]`, "info");
                    log(`  Viewport: ${gl.getParameter(gl.VIEWPORT)}`, "info");
                    log(`  Blend: ${gl.getParameter(gl.BLEND) ? 'ON' : 'OFF'}`, "info");
                    log(`  Depth Test: ${gl.getParameter(gl.DEPTH_TEST) ? 'ON' : 'OFF'}`, "info");

                    // å¼·åˆ¶çš„ã«ä¸é€æ˜èƒŒæ™¯ã«è¨­å®š
                    gl.clearColor(0.1, 0.1, 0.1, 1.0); // æ¿ƒã„ã‚°ãƒ¬ãƒ¼ä¸é€æ˜èƒŒæ™¯
                    gl.clear(gl.COLOR_BUFFER_BIT);
                    log("ğŸ¨ WebGLèƒŒæ™¯ã‚’æ¿ƒã„ã‚°ãƒ¬ãƒ¼ã«å¼·åˆ¶å¤‰æ›´", "success");

                    // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ–ãƒ¬ãƒ³ãƒ‡ã‚£ãƒ³ã‚°è¨­å®šç¢ºèªãƒ»ä¿®æ­£
                    gl.enable(gl.BLEND);
                    gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
                    log("ğŸ”§ ã‚¢ãƒ«ãƒ•ã‚¡ãƒ–ãƒ¬ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å¼·åˆ¶æœ‰åŠ¹åŒ–", "success");
                }

                // 2. Skeletonå¼·åˆ¶å†æç”»
                if (spineRenderer.skeleton && spineRenderer.animationState && spineRenderer.renderer) {
                    log("ğŸ­ Skeletonå¼·åˆ¶å†æç”»å®Ÿè¡Œ...", "info");
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹æ›´æ–°
                    spineRenderer.animationState.update(0.016); // 16ms delta
                    spineRenderer.animationState.apply(spineRenderer.skeleton);
                    spineRenderer.skeleton.updateWorldTransform();
                    
                    // å¼·åˆ¶æç”»
                    const gl = spineRenderer.gl;
                    gl.clear(gl.COLOR_BUFFER_BIT);
                    
                    spineRenderer.renderer.begin();
                    spineRenderer.renderer.drawSkeleton(spineRenderer.skeleton, true); // premultipliedAlpha: true
                    spineRenderer.renderer.end();
                    
                    log("âœ… Skeletonå¼·åˆ¶å†æç”»å®Œäº†", "success");

                    // Skeletonæƒ…å ±è©³ç´°å‡ºåŠ›
                    const bounds = new window.spine.SkeletonBounds();
                    bounds.update(spineRenderer.skeleton, true);
                    log(`ğŸ“¦ Skeletonè©³ç´°: ä½ç½®(${spineRenderer.skeleton.x}, ${spineRenderer.skeleton.y}), ã‚¹ã‚±ãƒ¼ãƒ«(${spineRenderer.skeleton.scaleX}, ${spineRenderer.skeleton.scaleY})`, "info");
                    log(`ğŸ“¦ å¢ƒç•Œ: (${bounds.minX.toFixed(1)}, ${bounds.minY.toFixed(1)}) â†’ (${bounds.maxX.toFixed(1)}, ${bounds.maxY.toFixed(1)})`, "info");
                    log(`ğŸ“¦ ã‚µã‚¤ã‚º: ${(bounds.maxX - bounds.minX).toFixed(1)} Ã— ${(bounds.maxY - bounds.minY).toFixed(1)}`, "info");

                    // ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆæƒ…å ±ç¢ºèª
                    if (spineRenderer.skeleton.slots) {
                        let visibleSlots = 0;
                        let totalSlots = spineRenderer.skeleton.slots.length;
                        
                        for (let slot of spineRenderer.skeleton.slots) {
                            if (slot.attachment) {
                                visibleSlots++;
                            }
                        }
                        log(`ğŸ“Š ã‚¹ãƒ­ãƒƒãƒˆæƒ…å ±: ${visibleSlots}/${totalSlots} å€‹ã®ã‚¹ãƒ­ãƒƒãƒˆã«ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆãŒè¨­å®šæ¸ˆã¿`, "info");
                    }
                }

                // 3. Canvaså¼·èª¿è¡¨ç¤º
                if (spineRenderer.canvas) {
                    spineRenderer.canvas.style.border = "5px solid #ff0000";
                    spineRenderer.canvas.style.boxShadow = "0 0 30px rgba(255, 0, 0, 0.8)";
                    log("ğŸ”¥ Canvaså¢ƒç•Œã‚’èµ¤è‰²ã§å¼·èª¿è¡¨ç¤º", "success");
                }

                log("ğŸ‰ WebGLãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¿®æ­£å®Œäº† - ä»Šåº¦ã¯ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒè¦‹ãˆã‚‹ã¯ãšã§ã™ï¼", "success");

            } catch (error) {
                log(`âŒ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¿®æ­£ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
                console.error("ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¿®æ­£ã‚¨ãƒ©ãƒ¼:", error);
            }
        }

        // ğŸ¯ Direct File Spine Renderer ãƒ†ã‚¹ãƒˆï¼ˆlocalhost:8000ã¨åŒã˜æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
        async function testDirectFileSpineRenderer() {
            try {
                setStatus('step2', 'â³ Direct File Spine Renderer ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'info');
                log('ğŸ¯ Direct File Spine Renderer ãƒ†ã‚¹ãƒˆé–‹å§‹ï¼ˆlocalhost:8000æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰', 'info');

                // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                if (!selectedFiles.atlas || !selectedFiles.json || !selectedFiles.texture) {
                    throw new Error('å…ˆã«Spineãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                }

                // Canvasæº–å‚™
                const canvas = document.getElementById('spineCanvas');
                canvas.width = 800;
                canvas.height = 600;
                canvas.className = 'spine-canvas active';

                log('ğŸ“¦ DirectSpineLoaderç›´æ¥å®Ÿè¡Œä¸­...', 'info');

                // DirectSpineLoaderã‚’ç›´æ¥ä½¿ç”¨ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å›é¿ï¼‰
                log('ğŸ“¦ selectedFilesæ§‹é€ ç¢ºèª:', 'info');
                log(`  atlas: ${selectedFiles.atlas ? 'OK' : 'NG'}`, 'info');
                log(`  json: ${selectedFiles.json ? 'OK' : 'NG'}`, 'info');
                log(`  texture: ${selectedFiles.texture ? 'OK' : 'NG'}`, 'info');

                // WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
                const gl = canvas.getContext('webgl2') || canvas.getContext('webgl');
                if (!gl) {
                    throw new Error('WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—');
                }

                // ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—
                const atlasFile = await selectedFiles.atlas.getFile();
                const jsonFile = await selectedFiles.json.getFile();
                const textureFile = await selectedFiles.texture.getFile();

                log('ğŸ“¦ DirectSpineLoaderã§ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿é–‹å§‹...', 'info');
                
                // DirectSpineLoaderã‚’ç›´æ¥ä½¿ç”¨
                if (typeof DirectSpineLoader === 'undefined') {
                    throw new Error('DirectSpineLoaderãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                log('ğŸ“¦ DirectSpineLoaderã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆä¸­...', 'info');
                const loader = new DirectSpineLoader();
                const files = { atlasFile, jsonFile, textureFile };
                
                log('ğŸ“¦ loadSpineAssetså‘¼ã³å‡ºã—é–‹å§‹...', 'info');
                const assets = await loader.loadSpineAssets(files, gl);
                
                log('ğŸ“¦ loadSpineAssetså‘¼ã³å‡ºã—å®Œäº†', 'success');

                log('âœ… DirectSpineLoaderèª­ã¿è¾¼ã¿å®Œäº†', 'success');
                
                // ğŸ¯ StableSpineRendererã‚’å›é¿ã—ã¦ç›´æ¥Spine WebGL APIã‚’ä½¿ç”¨
                log('ğŸ¯ åŸºæœ¬Spine WebGL APIç›´æ¥å®Ÿè¡Œï¼ˆStableSpineRendererå›é¿ï¼‰', 'info');
                
                // AtlasAttachmentLoaderã‚’ä½œæˆï¼ˆDirectSpineLoaderã®æˆåŠŸã—ãŸatlasã‚’ä½¿ç”¨ï¼‰
                const atlasAttachmentLoader = new spine.AtlasAttachmentLoader(assets.atlas);
                
                // SkeletonJsonã‚’åˆæœŸåŒ–
                const skeletonJson = new spine.SkeletonJson(atlasAttachmentLoader);
                
                // SkeletonDataä½œæˆï¼ˆDirectSpineLoaderã®æˆåŠŸã—ãŸatlasã‚’ä½¿ç”¨ï¼‰
                log('ğŸ¦´ SkeletonDataä½œæˆä¸­...', 'info');
                const skeletonData = skeletonJson.readSkeletonData(assets.skeletonJsonData);
                log('âœ… SkeletonDataä½œæˆå®Œäº†', 'success');
                
                // Skeletonä½œæˆ
                const skeleton = new spine.Skeleton(skeletonData);
                skeleton.setToSetupPose();
                skeleton.updateWorldTransform();
                
                // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¨ˆç®—
                const bbox = { offset: { x: 0, y: 0 }, size: { x: 0, y: 0 } };
                skeleton.getBounds(bbox);
                log(`ğŸ“ Bounding Box: ${bbox.size.x.toFixed(1)}x${bbox.size.y.toFixed(1)}`, 'info');
                
                // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ä½œæˆ
                const skeletonRenderer = new spine.SkeletonRenderer(gl);
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
                const animationStateData = new spine.AnimationStateData(skeletonData);
                const animationState = new spine.AnimationState(animationStateData);
                
                // æœ€åˆã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
                if (skeletonData.animations.length > 0) {
                    const firstAnimation = skeletonData.animations[0];
                    animationState.setAnimation(0, firstAnimation.name, true);
                    log(`ğŸ¬ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š: ${firstAnimation.name}`, 'success');
                }
                
                // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—
                let lastTime = 0;
                function render(time) {
                    const deltaTime = (time - lastTime) / 1000.0;
                    lastTime = time;
                    
                    // èƒŒæ™¯ã‚¯ãƒªã‚¢
                    gl.clearColor(0.2, 0.2, 0.3, 1.0);
                    gl.clear(gl.COLOR_BUFFER_BIT);
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
                    animationState.update(deltaTime);
                    animationState.apply(skeleton);
                    skeleton.updateWorldTransform();
                    
                    // ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—ï¼ˆç”»é¢ã«åã¾ã‚‹ã‚ˆã†ã«ï¼‰
                    const scale = Math.min(canvas.width / bbox.size.x, canvas.height / bbox.size.y) * 0.8;
                    
                    // ä½ç½®è¨ˆç®—ï¼ˆä¸­å¤®é…ç½®ï¼‰
                    const x = canvas.width / 2 - bbox.offset.x * scale;
                    const y = canvas.height / 2 - bbox.offset.y * scale;
                    
                    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                    skeletonRenderer.draw(skeleton, x, y, scale);
                    
                    requestAnimationFrame(render);
                }
                
                requestAnimationFrame(render);

                log('âœ… StableSpineRendereråˆæœŸåŒ–å®Œäº†', 'success');

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’å–å¾—
                const animations = assets.skeletonJsonData.animations.map(anim => anim.name);
                log(`ğŸ¬ åˆ©ç”¨å¯èƒ½ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: ${animations.join(', ')}`, 'info');

                // æœ€åˆã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†ç”Ÿ
                if (animations.length > 0) {
                    const result = stableRenderer.playAnimation(animations[0]);
                    log(`â–¶ï¸ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿé–‹å§‹: ${animations[0]}`, result ? 'success' : 'error');
                }

                // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                log(`ğŸ“Š ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼æƒ…å ±: Skeleton=${!!stableRenderer.skeleton}, Atlas=${!!assets.atlas}`, 'info');

                setStatus('step2', 'âœ… Direct File Spine Renderer ãƒ†ã‚¹ãƒˆå®Œäº† - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤ºä¸­', 'success');

            } catch (error) {
                log(`âŒ Direct File Spine Renderer ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('DirectFileSpineRenderer test full error:', error);
                setStatus('step2', `âŒ Direct File Spine Renderer ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ç›´æ¥HTTPèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆï¼ˆFileToHttpBridgeä½¿ç”¨ãªã—ï¼‰
        async function testDirectHTTP() {
            try {
                log("ğŸŒ ç›´æ¥HTTPèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆé–‹å§‹ï¼ˆFileToHttpBridgeä¸ä½¿ç”¨ï¼‰", "info");
                
                // CanvasåˆæœŸåŒ–
                const canvas = document.getElementById('spineCanvas');
                canvas.className = 'spine-canvas active';
                
                // ğŸ”¥ StableSpineRendererä¿®æ­£: characterãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¿…é ˆå¯¾å¿œ
                spineRenderer = new StableSpineRenderer({
                    canvas: '#spineCanvas',
                    character: 'nezumi',
                    basePath: '../assets/spine/characters/',
                    position: {
                        x: 600,  // Canvasä¸­å¤®
                        y: 400,  // Canvasä¸­å¤®
                        scaleX: 1.0,
                        scaleY: 1.0
                    },
                    defaultAnimation: 'search',
                    debug: true
                });
                
                log("ğŸ¯ StableSpineRendereråˆæœŸåŒ–ä¸­...", "info");
                log(`ğŸ” è¨­å®šç¢ºèª: basePath='${spineRenderer.config?.basePath || 'undefined'}', character='${spineRenderer.config?.character || 'undefined'}'`, "info");
                
                try {
                    await spineRenderer.initialize();
                    log("âœ… åˆæœŸåŒ–å®Œäº†", "success");
                } catch (error) {
                    // ãƒ‘ã‚¹é‡è¤‡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®è¨ºæ–­
                    log(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}`, "error");
                    if (error.message.includes('404') && error.message.includes('nezumi/nezumi')) {
                        log("ğŸ”§ ãƒ‘ã‚¹é‡è¤‡å•é¡Œæ¤œå‡º - ä¿®æ­£å®Ÿè¡Œä¸­...", "info");
                        
                        // ãƒ‘ã‚¹é‡è¤‡ã‚’ä¿®æ­£ã—ã¦å†è©¦è¡Œ
                        spineRenderer = new StableSpineRenderer({
                            canvas: '#spineCanvas',
                            atlasFile: '../assets/spine/characters/nezumi/nezumi.atlas',
                            skeletonFile: '../assets/spine/characters/nezumi/nezumi.json',
                            position: {
                                x: 600,
                                y: 400,
                                scaleX: 1.0,
                                scaleY: 1.0
                            },
                            debug: true
                        });
                        
                        log("ğŸ”„ ä¿®æ­£ç‰ˆã§å†åˆæœŸåŒ–ä¸­...", "info");
                        await spineRenderer.initialize();
                        log("âœ… ä¿®æ­£ç‰ˆåˆæœŸåŒ–å®Œäº†", "success");
                    } else {
                        throw error;
                    }
                }
                
                log("ğŸ­ searchã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ä¸­...", "info");
                const result = spineRenderer.playAnimation('search');
                
                if (result) {
                    log("ğŸ‰ ç›´æ¥HTTPèª­ã¿è¾¼ã¿æˆåŠŸï¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™", "success");
                    setStatus('step2', 'ğŸ‰ ç›´æ¥HTTPèª­ã¿è¾¼ã¿æˆåŠŸï¼', 'success');
                    
                    // è©³ç´°åº§æ¨™å‡ºåŠ›
                    if (spineRenderer.skeleton) {
                        log(`ğŸ“ Skeletonä½ç½®: x=${spineRenderer.skeleton.x}, y=${spineRenderer.skeleton.y}`, "info");
                        log(`ğŸ“ Skeletonã‚¹ã‚±ãƒ¼ãƒ«: scaleX=${spineRenderer.skeleton.scaleX}, scaleY=${spineRenderer.skeleton.scaleY}`, "info");
                        
                        // ğŸ¯ å¢ƒç•Œè¡¨ç¤ºè¿½åŠ ï¼ˆåŸºæœ¬WebGLãƒ†ã‚¹ãƒˆã¨åŒã˜æ©Ÿèƒ½ï¼‰
                        setTimeout(() => {
                            showSkeletonBounds(spineRenderer.skeleton);
                            log("ğŸ¯ Skeletonå¢ƒç•Œè¡¨ç¤ºã‚’è¿½åŠ ã—ã¾ã—ãŸ", "success");
                        }, 1000);
                        
                        // Canvaså¢ƒç•Œã‚‚ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                        if (spineRenderer.canvas) {
                            spineRenderer.canvas.style.border = "5px solid #00ff00"; // ç·‘è‰²ã®æ ç·š
                            spineRenderer.canvas.style.boxShadow = "0 0 30px rgba(0, 255, 0, 0.8)";
                            log("ğŸŸ¢ Canvaså¢ƒç•Œã‚’ç·‘è‰²ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º", "success");
                        }
                        
                        // WebGLèƒŒæ™¯ã‚’è‰²ä»˜ãã«ã—ã¦ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç¢ºèª
                        if (spineRenderer.gl) {
                            const gl = spineRenderer.gl;
                            gl.clearColor(0.1, 0.3, 0.1, 1.0); // æ¿ƒã„ç·‘è‰²èƒŒæ™¯
                            gl.clear(gl.COLOR_BUFFER_BIT);
                            log("ğŸŸ¢ WebGLèƒŒæ™¯ã‚’æ¿ƒã„ç·‘è‰²ã«è¨­å®šã—ã¦ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç¢ºèª", "success");
                        }
                    }
                } else {
                    log("âŒ ç›´æ¥HTTPèª­ã¿è¾¼ã¿å¤±æ•—", "error");
                    setStatus('step2', 'âŒ ç›´æ¥HTTPèª­ã¿è¾¼ã¿å¤±æ•—', 'error');
                }
                
            } catch (error) {
                log(`âŒ ç›´æ¥HTTPãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
                console.error("ç›´æ¥HTTPãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:", error);
                setStatus('step2', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // åŸºæœ¬Spine WebGL APIãƒ†ã‚¹ãƒˆï¼ˆæœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ï¼‰
        async function testBasicSpineWebGL() {
            try {
                log("âš¡ åŸºæœ¬Spine WebGL APIãƒ†ã‚¹ãƒˆé–‹å§‹", "info");
                
                // Canvaså–å¾—ãƒ»æº–å‚™
                const canvas = document.getElementById('spineCanvas');
                canvas.style.border = "3px solid #00ff00";
                canvas.style.background = "#333333"; // æ¿ƒã„ã‚°ãƒ¬ãƒ¼èƒŒæ™¯
                
                // WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
                const gl = canvas.getContext("webgl2") || canvas.getContext("webgl");
                if (!gl) {
                    throw new Error("WebGL context not available");
                }
                
                log("âœ… WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—å®Œäº†", "success");
                log(`ğŸ“ Canvasã‚µã‚¤ã‚º: ${canvas.width}Ã—${canvas.height}`, "info");
                
                // Spine WebGLåˆæœŸåŒ–
                const { spine } = window;
                if (!spine) {
                    throw new Error("Spine WebGL library not loaded");
                }
                
                log("âœ… Spine WebGLãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¢ºèªå®Œäº†", "success");
                
                // AssetManagerä½œæˆ
                const assetManager = new spine.AssetManager(gl);
                assetManager.loadTexture("../assets/spine/characters/nezumi/nezumi.png");
                assetManager.loadTextureAtlas("../assets/spine/characters/nezumi/nezumi.atlas");
                assetManager.loadJson("../assets/spine/characters/nezumi/nezumi.json");
                
                log("ğŸ“¦ ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿é–‹å§‹...", "info");
                
                // ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å¾…æ©Ÿ
                let loadAttempts = 0;
                const waitForAssets = () => {
                    return new Promise((resolve, reject) => {
                        const checkLoading = () => {
                            loadAttempts++;
                            log(`ğŸ”„ èª­ã¿è¾¼ã¿ç¢ºèª ${loadAttempts}/50...`, "info");
                            
                            if (assetManager.isLoadingComplete()) {
                                log("âœ… å…¨ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å®Œäº†", "success");
                                resolve();
                            } else if (assetManager.hasErrors()) {
                                const errors = assetManager.getErrors();
                                log(`âŒ ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${Object.keys(errors)}`, "error");
                                reject(new Error("Asset loading failed"));
                            } else if (loadAttempts < 50) {
                                setTimeout(checkLoading, 100);
                            } else {
                                reject(new Error("Asset loading timeout"));
                            }
                        };
                        checkLoading();
                    });
                };
                
                await waitForAssets();
                
                // SkeletonDataä½œæˆ
                const atlas = assetManager.require("../assets/spine/characters/nezumi/nezumi.atlas");
                const skeletonJson = assetManager.require("../assets/spine/characters/nezumi/nezumi.json");
                
                const atlasLoader = new spine.AtlasAttachmentLoader(atlas);
                const skeletonJsonParser = new spine.SkeletonJson(atlasLoader);
                const skeletonData = skeletonJsonParser.readSkeletonData(skeletonJson);
                
                log("âœ… SkeletonDataä½œæˆå®Œäº†", "success");
                
                // Skeletonãƒ»AnimationStateä½œæˆ
                const skeleton = new spine.Skeleton(skeletonData);
                
                // Skeletonå®Œå…¨åˆæœŸåŒ–
                skeleton.setToSetupPose();
                skeleton.updateWorldTransform();
                
                // ã‚¹ã‚­ãƒ³è¨­å®šï¼ˆåˆ©ç”¨å¯èƒ½ãªã‚¹ã‚­ãƒ³ã‚’ç¢ºèªï¼‰
                const availableSkins = skeletonData.skins.map(skin => skin.name);
                log(`ğŸ¨ åˆ©ç”¨å¯èƒ½ã‚¹ã‚­ãƒ³: ${availableSkins.join(', ')}`, "info");
                
                if (availableSkins.length > 0) {
                    skeleton.setSkinByName(availableSkins[0]);
                    log(`âœ… ã‚¹ã‚­ãƒ³è¨­å®š: ${availableSkins[0]}`, "success");
                } else {
                    log("âš ï¸ ã‚¹ã‚­ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç¶šè¡Œ", "warning");
                }
                
                const stateData = new spine.AnimationStateData(skeletonData);
                const state = new spine.AnimationState(stateData);
                
                // åˆ©ç”¨å¯èƒ½ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª
                const availableAnimations = skeletonData.animations.map(anim => anim.name);
                log(`ğŸ­ åˆ©ç”¨å¯èƒ½ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: ${availableAnimations.join(', ')}`, "info");
                
                log("âœ… Skeletonãƒ»AnimationStateä½œæˆå®Œäº†", "success");
                
                // ä½ç½®ãƒ»ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®š
                skeleton.x = 600; // Canvasä¸­å¤®
                skeleton.y = 400; // Canvasä¸­å¤®ï¼ˆä¸Šä¸‹åè»¢è€ƒæ…®ï¼‰
                skeleton.scaleX = skeleton.scaleY = 0.5; // é©åº¦ãªã‚µã‚¤ã‚º
                
                log(`ğŸ“ Skeletoné…ç½®: (${skeleton.x}, ${skeleton.y}), ã‚¹ã‚±ãƒ¼ãƒ«: ${skeleton.scaleX}`, "info");
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šï¼ˆå®‰å…¨ãªç¢ºèªä»˜ãï¼‰
                if (availableAnimations.includes("search")) {
                    state.setAnimation(0, "search", true);
                    log("ğŸ­ searchã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šå®Œäº†", "success");
                } else if (availableAnimations.length > 0) {
                    const firstAnimation = availableAnimations[0];
                    state.setAnimation(0, firstAnimation, true);
                    log(`ğŸ­ ${firstAnimation}ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šå®Œäº†ï¼ˆsearchãªã—ã®ãŸã‚ä»£æ›¿ï¼‰`, "success");
                } else {
                    log("âš ï¸ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - é™çš„è¡¨ç¤º", "warning");
                }
                
                // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ä½œæˆ
                const renderer = new spine.SceneRenderer(canvas, gl);
                const skeletonRenderer = renderer.skeletonRenderer;
                const debugRenderer = renderer.debugRenderer;
                
                log("âœ… ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ä½œæˆå®Œäº†", "success");
                
                // ğŸ”§ å®‰å…¨ãªæç”»ãƒ†ã‚¹ãƒˆï¼ˆãƒ«ãƒ¼ãƒ—ãªã—ï¼‰
                log("ğŸ¨ å®‰å…¨ãªé™çš„æç”»ãƒ†ã‚¹ãƒˆé–‹å§‹...", "info");
                
                // WebGLç”»é¢ã‚¯ãƒªã‚¢
                gl.clearColor(0.2, 0.2, 0.2, 1); // æ¿ƒã„ã‚°ãƒ¬ãƒ¼èƒŒæ™¯
                gl.clear(gl.COLOR_BUFFER_BIT);
                
                try {
                    // åˆæœŸçŠ¶æ…‹ã§é™çš„æç”»ãƒ†ã‚¹ãƒˆ
                    skeleton.setToSetupPose();
                    skeleton.updateWorldTransform();
                    
                    log(`ğŸ” SkeletonçŠ¶æ…‹ç¢ºèª: drawOrder=${skeleton.drawOrder ? 'exists' : 'undefined'}`, "info");
                    log(`ğŸ” Skeleton slotsæ•°: ${skeleton.slots ? skeleton.slots.length : 'undefined'}`, "info");
                    log(`ğŸ” SkeletonData bonesæ•°: ${skeletonData.bones ? skeletonData.bones.length : 'undefined'}`, "info");
                    
                    // æç”»å¯èƒ½æ€§ã‚’ãƒ†ã‚¹ãƒˆ
                    if (!skeleton.drawOrder) {
                        log("âŒ drawOrderæœªåˆæœŸåŒ– - æ‰‹å‹•åˆæœŸåŒ–è©¦è¡Œ", "error");
                        // æ‰‹å‹•ã§drawOrderåˆæœŸåŒ–
                        if (skeleton.slots && skeleton.slots.length > 0) {
                            skeleton.drawOrder = skeleton.slots.slice();
                            log(`âœ… drawOrderæ‰‹å‹•åˆæœŸåŒ–å®Œäº†: ${skeleton.drawOrder.length}å€‹ã®ã‚¹ãƒ­ãƒƒãƒˆ`, "success");
                        } else {
                            log("âŒ slotsæƒ…å ±ã‚‚æœªåˆæœŸåŒ–", "error");
                            throw new Error("SkeletonåˆæœŸåŒ–ãŒä¸å®Œå…¨ã§ã™");
                        }
                    }
                    
                    // Canvaså…¨ä½“ã‚’èµ¤ã„çŸ©å½¢ã§å¡—ã‚Šã¤ã¶ã—ãƒ†ã‚¹ãƒˆ
                    gl.clearColor(1.0, 0.0, 0.0, 1.0); // èµ¤è‰²
                    gl.clear(gl.COLOR_BUFFER_BIT);
                    log("ğŸ”´ èµ¤ã„èƒŒæ™¯ã§Canvasæç”»ãƒ†ã‚¹ãƒˆå®Œäº†", "success");
                    
                    // 2ç§’å¾Œã«é’è‰²ã«å¤‰æ›´
                    setTimeout(() => {
                        gl.clearColor(0.0, 0.0, 1.0, 1.0); // é’è‰²
                        gl.clear(gl.COLOR_BUFFER_BIT);
                        log("ğŸ”µ é’ã„èƒŒæ™¯ã§Canvasæç”»ãƒ†ã‚¹ãƒˆå®Œäº†", "success");
                        
                        // ã•ã‚‰ã«2ç§’å¾Œã«ç·‘è‰²ã§Skeletonãƒ†ã‚¹ãƒˆ
                        setTimeout(() => {
                            gl.clearColor(0.0, 1.0, 0.0, 1.0); // ç·‘è‰²
                            gl.clear(gl.COLOR_BUFFER_BIT);
                            
                            // Skeletonæç”»ãƒ†ã‚¹ãƒˆ
                            renderer.begin();
                            try {
                                skeletonRenderer.draw(skeleton);
                                log("ğŸ‰ Skeletonæç”»æˆåŠŸï¼", "success");
                            } catch (skeletonError) {
                                log(`âŒ Skeletonæç”»å¤±æ•—: ${skeletonError.message}`, "error");
                            }
                            renderer.end();
                            
                            log("ğŸŸ¢ ç·‘ã„èƒŒæ™¯ + Skeletonæç”»ãƒ†ã‚¹ãƒˆå®Œäº†", "success");
                        }, 2000);
                    }, 2000);
                    
                } catch (error) {
                    log(`âŒ é™çš„æç”»ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
                    console.error("é™çš„æç”»ã‚¨ãƒ©ãƒ¼è©³ç´°:", error);
                }
                
                log("ğŸ‰ åŸºæœ¬Spine WebGLè¡¨ç¤ºé–‹å§‹ï¼nezumiã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™", "success");
                setStatus('step2', 'ğŸ‰ åŸºæœ¬Spine WebGLè¡¨ç¤ºæˆåŠŸï¼', 'success');
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼ˆä»–ã®ãƒœã‚¿ãƒ³ã§æ“ä½œå¯èƒ½ã«ã™ã‚‹ï¼‰
                window.basicSpineComponents = { skeleton, state, renderer };
                
            } catch (error) {
                log(`âŒ åŸºæœ¬Spine WebGLãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
                console.error("åŸºæœ¬Spine WebGLã‚¨ãƒ©ãƒ¼:", error);
                setStatus('step2', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ğŸ”¥ ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æº–æ‹ : window.addEventListener('load') ã‚’ä½¿ç”¨
        window.addEventListener('load', () => {
            log('ğŸŒŸ ã‚·ãƒ³ãƒ—ãƒ«Fileâ†’Spineè¡¨ç¤ºãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†', 'info');
            log('ğŸ“ Step 1: 3ã¤ã®Spineãƒ•ã‚¡ã‚¤ãƒ« (.atlas, .json, .png) ã‚’é¸æŠã—ã¦ãã ã•ã„', 'info');
            
            // è©³ç´°ãªèª­ã¿è¾¼ã¿çŠ¶æ³ç¢ºèª
            const modules = {
                'Spine WebGL': typeof window.spine !== 'undefined',
                'BlobUrlManager': typeof BlobUrlManager !== 'undefined',
                'PathGenerator': typeof PathGenerator !== 'undefined', 
                'FileToHttpBridge': typeof FileToHttpBridge !== 'undefined',
                'StableSpineRenderer': typeof StableSpineRenderer !== 'undefined',
                'DirectSpineLoader': typeof DirectSpineLoader !== 'undefined',
                'DirectFileSpineRenderer': typeof DirectFileSpineRenderer !== 'undefined',
                'PureBoundingBoxCore': typeof PureBoundingBoxCore !== 'undefined',
                'PureBoundingBoxUI': typeof PureBoundingBoxUI !== 'undefined',
                'PureBoundingBoxEvents': typeof PureBoundingBoxEvents !== 'undefined'
            };

            log('ğŸ“‹ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿çŠ¶æ³:', 'info');
            for (const [name, loaded] of Object.entries(modules)) {
                if (loaded) {
                    log(`âœ… ${name}: èª­ã¿è¾¼ã¿æˆåŠŸ`, 'success');
                } else {
                    log(`âŒ ${name}: èª­ã¿è¾¼ã¿å¤±æ•—`, 'error');
                }
            }

            const allLoaded = Object.values(modules).every(loaded => loaded);
            if (allLoaded) {
                log('ğŸ‰ å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿å®Œäº† - Spineãƒ†ã‚¹ãƒˆæº–å‚™OK', 'success');
            } else {
                log('âš ï¸ ä¸€éƒ¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•— - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'warning');
            }
        });
    </script>
</body>
</html>