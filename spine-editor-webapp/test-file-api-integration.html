<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File API â†’ HTTPå¤‰æ› â†’ StableSpineRenderer çµ±åˆå®Ÿé¨“</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f8ff;
        }
        
        h1 {
            color: #333;
            text-align: center;
        }
        
        .step {
            background: rgba(255, 255, 255, 0.9);
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        
        .step h3 {
            margin-top: 0;
            color: #2c5530;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #spine-canvas {
            border: 2px solid #4CAF50;
            border-radius: 8px;
            background-color: white;
            display: block;
            margin: 20px auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .status.info {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .status.success {
            background-color: #e8f5e8;
            color: #4caf50;
        }
        
        .status.error {
            background-color: #ffebee;
            color: #f44336;
        }
        
        .log-container {
            background: rgba(0, 0, 0, 0.1);
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .log-info { background: rgba(33, 150, 243, 0.1); }
        .log-success { background: rgba(76, 175, 80, 0.1); }
        .log-error { background: rgba(244, 67, 54, 0.1); }
    </style>
</head>
<body>
    <h1>ğŸ”— File API â†’ HTTPå¤‰æ› â†’ StableSpineRenderer çµ±åˆå®Ÿé¨“</h1>
    <p style="text-align: center; font-size: 18px;">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€šã‚Šã®ã‚¯ãƒªãƒ¼ãƒ³ãªå®Ÿè£…ã§å®Œå…¨çµ±åˆã‚’ç¢ºèª</p>
    
    <!-- Step 1: ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
    <div class="step">
        <h3>ğŸ“ Step 1: Spineãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</h3>
        <p>nezumiç”¨ã®3ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆatlas/json/pngï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        <button onclick="selectFiles()" id="select-btn">ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</button>
        <div id="file-status" class="status info">æº–å‚™å®Œäº† - ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’é–‹å§‹ã—ã¦ãã ã•ã„</div>
    </div>
    
    <!-- Step 2: File API â†’ HTTPå¤‰æ› -->
    <div class="step">
        <h3>ğŸ”„ Step 2: FileToHttpBridgeå¤‰æ›</h3>
        <p>File APIã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’Blob URLã«å¤‰æ›</p>
        <button onclick="convertToHttp()" disabled id="convert-btn">ğŸ”„ HTTPå¤‰æ›å®Ÿè¡Œ</button>
        <div id="convert-status" class="status info">Step 1å®Œäº†å¾Œã«åˆ©ç”¨å¯èƒ½</div>
    </div>
    
    <!-- Step 3: StableSpineRendereræç”» -->
    <div class="step">
        <h3>ğŸ¯ Step 3: StableSpineRendereræç”»</h3>
        <p>å¤‰æ›ã•ã‚ŒãŸHTTPãƒ‡ãƒ¼ã‚¿ã§nezumiã‚’è¡¨ç¤º</p>
        <button onclick="renderSpine()" disabled id="render-btn">ğŸ¬ Spineæç”»å®Ÿè¡Œ</button>
        <div id="render-status" class="status info">Step 2å®Œäº†å¾Œã«åˆ©ç”¨å¯èƒ½</div>
        
        <!-- Canvasè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <canvas id="spine-canvas" width="400" height="400"></canvas>
    </div>
    
    <!-- Step 4: å‹•ä½œç¢ºèª -->
    <div class="step">
        <h3>ğŸ§ª Step 4: å‹•ä½œç¢ºèªãƒ»ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—</h3>
        <div style="text-align: center;">
            <button onclick="playAnimation('search')" disabled id="anim-search">ğŸ” search</button>
            <button onclick="playAnimation('kettei')" disabled id="anim-kettei">âœ… kettei</button>
            <button onclick="cleanup()" disabled id="cleanup-btn" style="background: #ff6b6b;">ğŸ—‘ï¸ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—</button>
        </div>
        <div id="final-status" class="status info">Step 3å®Œäº†å¾Œã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèªå¯èƒ½</div>
    </div>
    
    <!-- å®Ÿè¡Œãƒ­ã‚° -->
    <div class="step">
        <h3>ğŸ“‹ å®Ÿè¡Œãƒ­ã‚°</h3>
        <button onclick="clearLogs()" style="background: #666;">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        <div class="log-container" id="logContainer"></div>
    </div>

    <!-- å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.24/dist/iife/spine-webgl.js"></script>
    <script src="micromodules/spine-renderer/StableSpineRenderer.js"></script>
    <script src="micromodules/bridge/BlobUrlManager.js"></script>
    <script src="micromodules/bridge/PathGenerator.js"></script>
    <script src="micromodules/bridge/FileToHttpBridge.js"></script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let selectedFiles = {};
        let bridge = null;
        let httpData = null;
        let renderer = null;

        // ãƒ­ã‚°é–¢æ•°
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é–¢æ•°
        function updateStatus(stepId, message, type = 'info') {
            const statusEl = document.getElementById(stepId);
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        // ãƒ­ã‚°ã‚¯ãƒªã‚¢
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            log('ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        }

        // Step 1: ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
        async function selectFiles() {
            try {
                log('ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠé–‹å§‹', 'info');
                updateStatus('file-status', 'â³ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠä¸­...', 'info');

                // File System Access APIä½¿ç”¨
                const fileHandles = await window.showOpenFilePicker({
                    multiple: true,
                    types: [{
                        description: 'Spine files',
                        accept: {
                            'application/json': ['.json'],
                            'text/plain': ['.atlas'],
                            'image/png': ['.png']
                        }
                    }]
                });

                log(`ğŸ¯ ${fileHandles.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸ`, 'success');
                
                // FileSystemFileHandleã‚’ç›´æ¥ä¿å­˜ï¼ˆFileToHttpBridgeç”¨ï¼‰
                selectedFiles = {};
                for (const handle of fileHandles) {
                    const file = await handle.getFile();
                    const extension = handle.name.split('.').pop().toLowerCase();
                    
                    if (extension === 'atlas') {
                        selectedFiles.atlas = handle;  // Handleã‚’ä¿å­˜
                    } else if (extension === 'json') {
                        selectedFiles.json = handle;   // Handleã‚’ä¿å­˜
                    } else if (extension === 'png') {
                        selectedFiles.texture = handle; // Handleã‚’ä¿å­˜
                    }
                    
                    log(`ğŸ“„ ${handle.name} (${file.size}ãƒã‚¤ãƒˆ)`, 'info');
                }

                // å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒæƒã£ã¦ã„ã‚‹ã‹ç¢ºèª
                const required = ['atlas', 'json', 'texture'];
                const missing = required.filter(type => !selectedFiles[type]);
                
                if (missing.length > 0) {
                    throw new Error(`å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸è¶³: ${missing.join(', ')}`);
                }

                updateStatus('file-status', 'âœ… 3ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå®Œäº† - Step 2ã¸é€²ã‚ã¾ã™', 'success');
                document.getElementById('convert-btn').disabled = false;
                
            } catch (error) {
                log(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStatus('file-status', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // Step 2: FileToHttpBridgeå¤‰æ›
        async function convertToHttp() {
            try {
                log('ğŸ”„ FileToHttpBridgeå¤‰æ›é–‹å§‹', 'info');
                updateStatus('convert-status', 'â³ HTTPå¤‰æ›ä¸­...', 'info');
                
                // FileToHttpBridgeåˆæœŸåŒ–
                bridge = new FileToHttpBridge({ debug: true });
                
                // File API â†’ HTTPå¤‰æ›å®Ÿè¡Œ
                httpData = await bridge.convertCharacterFiles('nezumi', selectedFiles);
                
                log('âœ… HTTPå¤‰æ›å®Œäº†ï¼ä»¥ä¸‹ã®Blob URLç”Ÿæˆ:', 'success');
                log(`  Atlas: ${httpData.blobUrls.atlas.substring(0, 50)}...`, 'info');
                log(`  JSON: ${httpData.blobUrls.json.substring(0, 50)}...`, 'info');
                log(`  Texture: ${httpData.blobUrls.texture.substring(0, 50)}...`, 'info');
                
                updateStatus('convert-status', 'âœ… HTTPå¤‰æ›å®Œäº† - Step 3ã¸é€²ã‚ã¾ã™', 'success');
                document.getElementById('render-btn').disabled = false;
                
            } catch (error) {
                log(`âŒ HTTPå¤‰æ›ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('Full convert error:', error);
                updateStatus('convert-status', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // Step 3: StableSpineRendereræç”»
        async function renderSpine() {
            try {
                log('ğŸ¯ StableSpineRendereræç”»é–‹å§‹', 'info');
                updateStatus('render-status', 'â³ Spineæç”»ä¸­...', 'info');
                
                // StableSpineRendereråˆæœŸåŒ–ï¼ˆãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€šã‚Šï¼‰
                renderer = StableSpineRenderer.createForCharacter('nezumi');
                
                // ğŸ”¥é‡è¦ï¼šStableSpineRendererã«Blob URLã‚’ç›´æ¥è¨­å®š
                // æ¨™æº–çš„ãªHTTPèª­ã¿è¾¼ã¿æ–¹å¼ã‚’æ‹¡å¼µã—ã¦Blob URLå¯¾å¿œ
                log('ğŸ”§ StableSpineRendererã«Blob URLè¨­å®šä¸­...', 'info');
                
                // ãƒªãƒ¢ãƒ¼ãƒˆã‚¢ã‚»ãƒƒãƒˆè¨­å®šã‚’ä¸Šæ›¸ã
                renderer.config.blobUrls = {
                    atlas: httpData.blobUrls.atlas,
                    json: httpData.blobUrls.json,
                    texture: httpData.blobUrls.texture
                };
                
                await renderer.initialize();
                
                log('âœ… StableSpineRendereråˆæœŸåŒ–å®Œäº†', 'success');
                
                // nezumiå°‚ç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è‡ªå‹•å†ç”Ÿ
                const success = renderer.playAnimation('search', true);
                if (success) {
                    log('ğŸ¬ searchã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿé–‹å§‹', 'success');
                } else {
                    log('âš ï¸ searchã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿå¤±æ•— - æ‰‹å‹•æ“ä½œã§ç¢ºèª', 'error');
                }
                
                updateStatus('render-status', 'âœ… nezumiæç”»å®Œäº† - ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèªå¯èƒ½', 'success');
                document.getElementById('anim-search').disabled = false;
                document.getElementById('anim-kettei').disabled = false;
                document.getElementById('cleanup-btn').disabled = false;
                updateStatus('final-status', 'ğŸ‰ çµ±åˆæˆåŠŸï¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã§å‹•ä½œç¢ºèª', 'success');
                
            } catch (error) {
                log(`âŒ Spineæç”»ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('Full render error:', error);
                updateStatus('render-status', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ
        function playAnimation(animName) {
            if (!renderer) {
                log('âŒ ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼æœªåˆæœŸåŒ–', 'error');
                return;
            }
            
            try {
                const success = renderer.playAnimation(animName, true);
                if (success) {
                    log(`ğŸ¬ ${animName} ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿé–‹å§‹`, 'success');
                } else {
                    log(`âŒ ${animName} ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿå¤±æ•—`, 'error');
                }
            } catch (error) {
                log(`âŒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        function cleanup() {
            try {
                log('ğŸ—‘ï¸ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹', 'info');
                
                // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼åœæ­¢
                if (renderer && renderer.dispose) {
                    renderer.dispose();
                    renderer = null;
                    log('âœ… ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼åœæ­¢å®Œäº†', 'success');
                }
                
                // Blob URLã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                if (httpData && httpData.cleanup) {
                    httpData.cleanup();
                    httpData = null;
                    log('âœ… Blob URLã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†', 'success');
                }
                
                // UIçŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('convert-btn').disabled = true;
                document.getElementById('render-btn').disabled = true;
                document.getElementById('anim-search').disabled = true;
                document.getElementById('anim-kettei').disabled = true;
                document.getElementById('cleanup-btn').disabled = true;
                
                updateStatus('file-status', 'æº–å‚™å®Œäº† - ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’é–‹å§‹ã—ã¦ãã ã•ã„', 'info');
                updateStatus('convert-status', 'Step 1å®Œäº†å¾Œã«åˆ©ç”¨å¯èƒ½', 'info');
                updateStatus('render-status', 'Step 2å®Œäº†å¾Œã«åˆ©ç”¨å¯èƒ½', 'info');
                updateStatus('final-status', 'Step 3å®Œäº†å¾Œã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèªå¯èƒ½', 'info');
                
                // Canvas ã‚¯ãƒªã‚¢
                const canvas = document.getElementById('spine-canvas');
                const ctx = canvas.getContext('2d');
                if (ctx) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
                
                log('ğŸ‰ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº† - å†å®Ÿè¡Œå¯èƒ½', 'success');
                
            } catch (error) {
                log(`âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚
        window.addEventListener('load', () => {
            log('ğŸŒŸ File APIçµ±åˆå®Ÿé¨“ãƒšãƒ¼ã‚¸æº–å‚™å®Œäº†', 'info');
            log('ğŸ“ Step 1ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’é–‹å§‹ã—ã¦ãã ã•ã„', 'info');
        });
    </script>
</body>
</html>