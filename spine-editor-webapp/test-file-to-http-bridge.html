<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileToHttpBridge Phase 1 MVP ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }

        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .primary-btn {
            background: #4CAF50;
            color: white;
        }

        .primary-btn:hover {
            background: #45a049;
        }

        .secondary-btn {
            background: #2196F3;
            color: white;
        }

        .secondary-btn:hover {
            background: #1976D2;
        }

        .danger-btn {
            background: #f44336;
            color: white;
        }

        .danger-btn:hover {
            background: #d32f2f;
        }

        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .stats-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
        }

        .stats-card h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .stats-value {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }

        .spine-canvas {
            border: 2px solid #ddd;
            border-radius: 5px;
            background: #fff;
            margin: 10px 0;
        }

        .error {
            color: #f44336;
            background: #ffebee;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            color: #4CAF50;
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .file-info {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            font-family: monospace;
        }

        .debug-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="debug-toggle">
        <label>
            <input type="checkbox" id="debugMode" checked> ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
        </label>
    </div>

    <div class="header">
        <h1>ğŸ”¥ FileToHttpBridge Phase 1çµ±åˆ ãƒ†ã‚¹ãƒˆ</h1>
        <p>HTTPã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆæ–¹å¼ + MeshAttachment.updateRegionå•é¡Œæ ¹æœ¬è§£æ±º</p>
        <p>ğŸ¯ ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèª¿æŸ»çµæœã‚’å®Œå…¨å®Ÿè£…ã—ãŸFileToHttpBridgeçµ±åˆç‰ˆ</p>
    </div>

    <!-- Phase 1: HTTPã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆæ ¸æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ -->
    <div class="test-section">
        <h3>ğŸ”¥ Phase 1: HTTPã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆæ ¸æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h3>
        <div class="controls">
            <button class="primary-btn" onclick="selectSpineFolder()">ğŸ“‚ Spineãƒ•ã‚©ãƒ«ãƒ€é¸æŠ</button>
            <button class="secondary-btn" onclick="testBlobUrlManager()" disabled>ğŸ”— BlobUrlManager ãƒ†ã‚¹ãƒˆ</button>
            <button class="secondary-btn" onclick="testPathGenerator()">ğŸ—‚ï¸ PathGenerator ãƒ†ã‚¹ãƒˆ</button>
            <button class="secondary-btn" onclick="testInterceptor()" disabled>ğŸ”„ HTTPã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆãƒ†ã‚¹ãƒˆ</button>
            <button class="danger-btn" onclick="cleanup()">ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—</button>
        </div>
        <div id="phase1-status"></div>
    </div>

    <!-- Phase 2: FileToHttpBridge Phase 1çµ±åˆå¤‰æ›ãƒ†ã‚¹ãƒˆ -->
    <div class="test-section">
        <h3>ğŸ”„ Phase 2: FileToHttpBridge Phase 1çµ±åˆå¤‰æ›ãƒ†ã‚¹ãƒˆ</h3>
        <div class="controls">
            <button class="primary-btn" onclick="testConversion()" disabled id="convertBtn">âš¡ Phase 1çµ±åˆå¤‰æ›å®Ÿè¡Œ</button>
            <button class="secondary-btn" onclick="validateConversion()" disabled id="validateBtn">âœ… HTTPã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆæ¤œè¨¼</button>
            <button class="secondary-btn" onclick="testMeshAttachmentFix()" disabled id="meshTestBtn">ğŸ”§ MeshAttachmentå•é¡Œãƒ†ã‚¹ãƒˆ</button>
        </div>
        <div id="phase2-status"></div>
        <div id="conversion-result"></div>
    </div>

    <!-- Phase 3: StableSpineRenderer Phase 1çµ±åˆãƒ†ã‚¹ãƒˆ -->
    <div class="test-section">
        <h3>ğŸ® Phase 3: StableSpineRenderer Phase 1çµ±åˆãƒ†ã‚¹ãƒˆ</h3>
        <div class="controls">
            <button class="primary-btn" onclick="testSpineIntegration()" disabled id="spineBtn">ğŸ¯ Phase 1çµ±åˆSpineãƒ†ã‚¹ãƒˆ</button>
            <button class="secondary-btn" onclick="verifyMeshAttachmentFix()" disabled id="meshVerifyBtn">ğŸ” MeshAttachmentå•é¡Œè§£æ±ºç¢ºèª</button>
        </div>
        <canvas id="spine-canvas" class="spine-canvas" width="400" height="400"></canvas>
        <div id="phase3-status"></div>
    </div>

    <!-- ğŸ” æˆåŠŸãƒ»å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³æ¯”è¼ƒè¨ºæ–­ -->
    <div class="test-section">
        <h3>ğŸ” æˆåŠŸãƒ»å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³æ¯”è¼ƒè¨ºæ–­</h3>
        <div class="controls">
            <button class="primary-btn" onclick="runStepByStepDiagnosis()">ğŸ” æ®µéšçš„è¨ºæ–­å®Ÿè¡Œ</button>
            <button class="secondary-btn" onclick="showDetailedLogs()">ğŸ“‹ è©³ç´°ãƒ­ã‚°è¡¨ç¤º</button>
            <button class="secondary-btn" onclick="diagnosticStep = 0; document.getElementById('comparison-result').innerHTML = '';">ğŸ”„ è¨ºæ–­ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div class="comparison-canvases">
            <div style="display: inline-block; margin: 10px;">
                <h4>âœ… æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ (createForCharacter)</h4>
                <canvas id="comparison-success-canvas" class="spine-canvas" width="200" height="200"></canvas>
            </div>
            <div style="display: inline-block; margin: 10px;">
                <h4>âŒ å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ (FileToHttpBridge)</h4>
                <canvas id="comparison-failure-canvas" class="spine-canvas" width="200" height="200"></canvas>
            </div>
        </div>
        <div id="comparison-result"></div>
    </div>

    <!-- çµ±è¨ˆæƒ…å ±è¡¨ç¤º -->
    <div class="test-section">
        <h3>ğŸ“Š çµ±è¨ˆæƒ…å ±ãƒ»ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
        <div class="controls">
            <button class="secondary-btn" onclick="updateStats()">ğŸ”„ çµ±è¨ˆæ›´æ–°</button>
            <button class="secondary-btn" onclick="clearLogs()">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="stats-grid" id="stats-grid"></div>
        <div class="log-container" id="log-container"></div>
    </div>

    <!-- ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ -->
    <!-- Spine WebGL CDNï¼ˆå¿…é ˆï¼‰ -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.24/dist/iife/spine-webgl.js"></script>
    
    <!-- FileToHttpBridge ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    <script src="micromodules/bridge/BlobUrlManager.js"></script>
    <script src="micromodules/bridge/PathGenerator.js"></script>
    <script src="micromodules/bridge/FileToHttpBridge.js"></script>
    
    <!-- StableSpineRenderer -->
    <script src="../micromodules/spine-renderer/StableSpineRenderer.js"></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let bridge = null;
        let selectedFiles = null;
        let conversionResult = null;
        let spineRenderer = null;
        let debugMode = true;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeBridge();
            updateStats();
            log('ğŸš€ FileToHttpBridge ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†', 'info');
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•é¸æŠï¼ˆé–‹ç™ºç”¨ï¼‰
            loadDefaultSpineFiles();
            
            // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('debugMode').addEventListener('change', function(e) {
                debugMode = e.target.checked;
                if (bridge) {
                    bridge.config.debug = debugMode;
                }
                log(`ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ${debugMode ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`, 'info');
            });
        });

        // BridgeåˆæœŸåŒ–
        function initializeBridge() {
            try {
                bridge = new FileToHttpBridge({
                    debug: debugMode,
                    tempBasePath: '/temp/spine/',
                    logCallback: (message) => log(message, 'bridge')
                });
                
                showStatus('phase1', 'âœ… FileToHttpBridgeåˆæœŸåŒ–å®Œäº†', 'success');
                log('ğŸŒ‰ FileToHttpBridgeåˆæœŸåŒ–æˆåŠŸ', 'success');
            } catch (error) {
                showStatus('phase1', `âŒ BridgeåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ BridgeåˆæœŸåŒ–å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆSpineãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆé–‹ç™ºç”¨ï¼‰
        async function loadDefaultSpineFiles() {
            try {
                log('ğŸ“‚ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆSpineãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹', 'info');
                
                const basePath = '../assets/spine/characters/nezumi/';
                const fileNames = {
                    atlas: 'nezumi.atlas',
                    json: 'nezumi.json',
                    texture: 'nezumi.png'
                };
                
                // HTTPã§ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã—ã¦Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
                const fileHandles = {};
                console.log("ğŸš¨ fileHandlesæ§‹ç¯‰é–‹å§‹ - undefined URLå•é¡Œã®åŸå› èª¿æŸ»");
                
                for (const [type, fileName] of Object.entries(fileNames)) {
                    try {
                        console.log(`ğŸ”„ ${type}ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹: ${fileName}`);
                        const response = await fetch(basePath + fileName);
                        if (!response.ok) {
                            throw new Error(`${fileName}: ${response.status} ${response.statusText}`);
                        }
                        const arrayBuffer = await response.arrayBuffer();
                        const blob = new Blob([arrayBuffer]);
                        
                        // FileSystemFileHandleé¢¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
                        fileHandles[type] = {
                            name: fileName,
                            getFile: async () => new File([blob], fileName, { 
                                type: type === 'texture' ? 'image/png' : 'text/plain' 
                            })
                        };
                        console.log(`âœ… ${type}ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ: ${fileName}`);
                    } catch (error) {
                        console.error(`âŒ ${type}ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—: ${fileName} - ${error.message}`);
                        log(`âš ï¸ ${fileName}èª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}`, 'warning');
                        // ğŸš¨ å¤±æ•—æ™‚ã®ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œãªã„ = undefinedã®åŸå› 
                    }
                }
                
                // ğŸš¨ fileHandlesæ§‹ç¯‰çµæœã®è©³ç´°ãƒã‚§ãƒƒã‚¯
                console.log("ğŸš¨ fileHandlesæ§‹ç¯‰çµæœè©³ç´°:");
                console.log(`  ğŸ“‹ atlas: ${fileHandles.atlas ? 'OK' : 'MISSING'}`);
                console.log(`  ğŸ“‹ json: ${fileHandles.json ? 'OK' : 'MISSING'}`);
                console.log(`  ğŸ“‹ texture: ${fileHandles.texture ? 'OK' : 'MISSING'}`);
                
                const missingTypes = [];
                if (!fileHandles.atlas) missingTypes.push('atlas');
                if (!fileHandles.json) missingTypes.push('json');
                if (!fileHandles.texture) missingTypes.push('texture');
                
                if (missingTypes.length > 0) {
                    console.error(`ğŸš¨ fileHandlesæ¬ ææ¤œå‡º: ${missingTypes.join(', ')} - ã“ã‚ŒãŒundefined URLå•é¡Œã®æ ¹æœ¬åŸå› ã§ã™`);
                    log(`âŒ å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«æ¬ æ: ${missingTypes.join(', ')}`, 'error');
                } else {
                    console.log("âœ… fileHandlesæ§‹ç¯‰å®Œäº† - å…¨ãƒ•ã‚¡ã‚¤ãƒ«æ­£å¸¸");
                }
                
                // å¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«ãŒã™ã¹ã¦èª­ã¿è¾¼ã‚ãŸå ´åˆã®ã¿å‡¦ç†ç¶šè¡Œ
                if (fileHandles.atlas && fileHandles.json && fileHandles.texture) {
                    selectedFiles = fileHandles;
                    
                    // UIæ›´æ–°
                    document.getElementById('convertBtn').disabled = false;
                    document.querySelectorAll('button[onclick="testBlobUrlManager()"]')[0].disabled = false;
                    document.querySelectorAll('button[onclick="testInterceptor()"]')[0].disabled = false;
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±è¡¨ç¤º
                    let fileInfo = '<div class=\"success\">âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆSpineãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†:</div>';
                    for (const [type, handle] of Object.entries(fileHandles)) {
                        fileInfo += `<div class="file-info">${type}: ${handle.name}</div>`;
                    }
                    
                    showStatus('phase1', fileInfo, 'success');
                    log(`âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆSpineãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†: nezumi`, 'success');
                } else {
                    throw new Error('å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                log(`âŒ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}`, 'error');
                log('ğŸ’¡ æ‰‹å‹•ã§ã€ŒğŸ“‚ Spineãƒ•ã‚©ãƒ«ãƒ€é¸æŠã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„', 'info');
            }
        }

        // Spineãƒ•ã‚©ãƒ«ãƒ€é¸æŠï¼ˆFile System Access APIï¼‰
        async function selectSpineFolder() {
            try {
                log('ğŸ“‚ Spineãƒ•ã‚©ãƒ«ãƒ€é¸æŠé–‹å§‹', 'info');

                if (!('showDirectoryPicker' in window)) {
                    throw new Error('File System Access APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé¸æŠ
                const dirHandle = await window.showDirectoryPicker({
                    mode: 'read',
                    startIn: 'documents'
                });

                log(`ğŸ“ é¸æŠãƒ•ã‚©ãƒ«ãƒ€: ${dirHandle.name}`, 'info');

                // å¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢
                const requiredFiles = ['atlas', 'json', 'png', 'jpg'];
                const foundFiles = {};

                for await (const [name, handle] of dirHandle.entries()) {
                    if (handle.kind === 'file') {
                        const extension = name.split('.').pop().toLowerCase();
                        
                        if (extension === 'atlas') {
                            foundFiles.atlas = handle;
                        } else if (extension === 'json') {
                            foundFiles.json = handle;
                        } else if (['png', 'jpg', 'jpeg'].includes(extension)) {
                            foundFiles.texture = handle;
                        }
                    }
                }

                // ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
                if (!foundFiles.atlas || !foundFiles.json || !foundFiles.texture) {
                    const missing = [];
                    if (!foundFiles.atlas) missing.push('atlas');
                    if (!foundFiles.json) missing.push('json');
                    if (!foundFiles.texture) missing.push('texture');
                    throw new Error(`å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${missing.join(', ')}`);
                }

                selectedFiles = foundFiles;
                
                // UIæ›´æ–°
                document.getElementById('convertBtn').disabled = false;
                document.querySelectorAll('button[onclick="testBlobUrlManager()"]')[0].disabled = false;
                document.querySelectorAll('button[onclick="testInterceptor()"]')[0].disabled = false;
                
                // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±è¡¨ç¤º
                let fileInfo = '<div class=\"success\">âœ… Spineãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå®Œäº†:</div>';
                for (const [type, handle] of Object.entries(foundFiles)) {
                    fileInfo += `<div class="file-info">${type}: ${handle.name}</div>`;
                }
                
                showStatus('phase1', fileInfo, 'success');
                log(`âœ… Spineãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå®Œäº†: ${Object.keys(foundFiles).length}ä»¶`, 'success');

            } catch (error) {
                showStatus('phase1', `âŒ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // BlobUrlManagerãƒ†ã‚¹ãƒˆ
        async function testBlobUrlManager() {
            try {
                log('ğŸ”— BlobUrlManagerå˜ä½“ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');

                const manager = new BlobUrlManager({ debug: debugMode });
                
                // ãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
                const testFile = new File(['test content'], 'test.txt', { type: 'text/plain' });
                
                // Blob URLä½œæˆãƒ†ã‚¹ãƒˆ
                const url = manager.createBlobUrl(testFile, 'text/plain');
                log(`ğŸ“ Blob URLä½œæˆãƒ†ã‚¹ãƒˆæˆåŠŸ: ${url.substring(0, 50)}...`, 'success');
                
                // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ
                const metadata = manager.getMetadata(url);
                log(`ğŸ“‹ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆæˆåŠŸ: ${JSON.stringify(metadata, null, 2)}`, 'info');
                
                // URLè§£æ”¾ãƒ†ã‚¹ãƒˆ
                const revoked = manager.revokeBlobUrl(url);
                log(`ğŸ—‘ï¸ URLè§£æ”¾ãƒ†ã‚¹ãƒˆæˆåŠŸ: ${revoked}`, 'success');
                
                showStatus('phase1', 'âœ… BlobUrlManagerå˜ä½“ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');

            } catch (error) {
                showStatus('phase1', `âŒ BlobUrlManagerãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ BlobUrlManagerãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // PathGeneratorãƒ†ã‚¹ãƒˆ
        function testPathGenerator() {
            try {
                log('ğŸ—‚ï¸ PathGeneratorå˜ä½“ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');

                // ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ç”Ÿæˆãƒ†ã‚¹ãƒˆ
                const basePath = PathGenerator.generateBasePath('nezumi');
                log(`ğŸ“ ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ç”Ÿæˆãƒ†ã‚¹ãƒˆ: ${basePath}`, 'info');

                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ç”Ÿæˆãƒ†ã‚¹ãƒˆ
                const filePath = PathGenerator.generateFilePath(basePath, 'nezumi.atlas', 'atlas');
                log(`ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ç”Ÿæˆãƒ†ã‚¹ãƒˆ: ${filePath}`, 'info');

                // ãƒ‘ã‚¹æ­£è¦åŒ–ãƒ†ã‚¹ãƒˆ
                const normalized = PathGenerator.normalizePath('//temp//spine\\nezumi\\');
                log(`ğŸ”„ ãƒ‘ã‚¹æ­£è¦åŒ–ãƒ†ã‚¹ãƒˆ: ${normalized}`, 'info');

                // å®Œå…¨ãƒ‘ã‚¹ã‚»ãƒƒãƒˆç”Ÿæˆãƒ†ã‚¹ãƒˆ
                const pathSet = PathGenerator.generateCompletePathSet('nezumi', {
                    atlas: 'nezumi.atlas',
                    json: 'nezumi.json',
                    texture: 'nezumi.png'
                });
                log(`ğŸ“¦ å®Œå…¨ãƒ‘ã‚¹ã‚»ãƒƒãƒˆç”Ÿæˆãƒ†ã‚¹ãƒˆ: ${JSON.stringify(pathSet, null, 2)}`, 'info');

                showStatus('phase1', 'âœ… PathGeneratorå˜ä½“ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');

            } catch (error) {
                showStatus('phase1', `âŒ PathGeneratorãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ PathGeneratorãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // File â†’ HTTPå¤‰æ›ãƒ†ã‚¹ãƒˆ
        async function testConversion() {
            try {
                if (!selectedFiles) {
                    throw new Error('Spineãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                log('âš¡ File â†’ HTTPå¤‰æ›ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                showStatus('phase2', 'ğŸ”„ å¤‰æ›å‡¦ç†ä¸­...', 'info');

                const characterName = 'nezumi';
                conversionResult = await bridge.convertCharacterFiles(characterName, selectedFiles);

                // å¤‰æ›çµæœè¡¨ç¤º
                let resultHtml = '<div class=\"success\">âœ… å¤‰æ›å®Œäº†:</div>';
                resultHtml += `<div class="file-info">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å: ${conversionResult.characterName}</div>`;
                resultHtml += `<div class="file-info">ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹: ${conversionResult.basePath}</div>`;
                resultHtml += `<div class="file-info">å¤‰æ›æ™‚é–“: ${conversionResult.stats.conversionTime}ms</div>`;
                resultHtml += `<div class="file-info">ç·ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${formatSize(conversionResult.stats.totalSize)}</div>`;
                
                resultHtml += '<h4>ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹:</h4>';
                for (const [type, path] of Object.entries(conversionResult.files)) {
                    resultHtml += `<div class="file-info">${type}: ${path}</div>`;
                }

                document.getElementById('conversion-result').innerHTML = resultHtml;
                showStatus('phase2', 'âœ… File â†’ HTTPå¤‰æ›å®Œäº†', 'success');

                // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—æœ‰åŠ¹åŒ–
                document.getElementById('validateBtn').disabled = false;
                document.getElementById('meshTestBtn').disabled = false;
                document.getElementById('spineBtn').disabled = false;
                document.getElementById('meshVerifyBtn').disabled = false;

                log(`âœ… File â†’ HTTPå¤‰æ›æˆåŠŸ: ${characterName}`, 'success');

            } catch (error) {
                showStatus('phase2', `âŒ å¤‰æ›ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ å¤‰æ›å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // å¤‰æ›æ¤œè¨¼
        async function validateConversion() {
            try {
                if (!conversionResult) {
                    throw new Error('å¤‰æ›çµæœãŒã‚ã‚Šã¾ã›ã‚“');
                }

                log('âœ… å¤‰æ›çµæœæ¤œè¨¼é–‹å§‹', 'info');

                // Blob URLå­˜åœ¨ç¢ºèª
                for (const [type, blobUrl] of Object.entries(conversionResult.blobUrls)) {
                    try {
                        const response = await fetch(blobUrl);
                        if (!response.ok) {
                            throw new Error(`${type} Blob URLã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—: ${response.status}`);
                        }
                        log(`âœ… ${type} Blob URLæ¤œè¨¼æˆåŠŸ: ${blobUrl.substring(0, 50)}...`, 'success');
                    } catch (error) {
                        throw new Error(`${type} Blob URLæ¤œè¨¼å¤±æ•—: ${error.message}`);
                    }
                }

                showStatus('phase2', 'âœ… å¤‰æ›çµæœæ¤œè¨¼å®Œäº† - å…¨ã¦ã®Blob URLã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½', 'success');
                log('âœ… å¤‰æ›çµæœæ¤œè¨¼å®Œäº†', 'success');

            } catch (error) {
                showStatus('phase2', `âŒ æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ æ¤œè¨¼å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // StableSpineRendererçµ±åˆãƒ†ã‚¹ãƒˆ
        async function testSpineIntegration() {
            try {
                if (!conversionResult) {
                    throw new Error('å¤‰æ›çµæœãŒã‚ã‚Šã¾ã›ã‚“');
                }

                log('ğŸ® StableSpineRendererçµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                showStatus('phase3', 'ğŸ”„ SpineåˆæœŸåŒ–ä¸­...', 'info');

                // å¤‰æ›çµæœã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±å‡ºåŠ›
                log('ğŸ“‹ å¤‰æ›çµæœæ§‹é€ ç¢ºèª:', 'debug');
                log(`  characterName: ${conversionResult.characterName}`, 'debug');
                log(`  basePath: ${conversionResult.basePath}`, 'debug');
                log(`  blobUrlså­˜åœ¨: ${conversionResult.blobUrls ? 'YES' : 'NO'}`, 'debug');
                if (conversionResult.blobUrls) {
                    log(`  atlas: ${conversionResult.blobUrls.atlas ? 'YES' : 'NO'}`, 'debug');
                    log(`  json: ${conversionResult.blobUrls.json ? 'YES' : 'NO'}`, 'debug');
                    log(`  texture: ${conversionResult.blobUrls.texture ? 'YES' : 'NO'}`, 'debug');
                }

                // ãƒ‡ãƒãƒƒã‚°: å¤‰æ›çµæœå…¨ä½“ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›
                console.log("ğŸ” conversionResultå…¨ä½“:", conversionResult);
                console.log("ğŸ” conversionResult.blobUrls:", conversionResult.blobUrls);
                
                // ğŸš¨ undefined URLå•é¡Œã‚’ç‰¹å®šã™ã‚‹ãŸã‚è©³ç´°ãƒ‡ãƒãƒƒã‚°
                if (conversionResult.blobUrls) {
                    console.log("ğŸš¨ blobUrlsè©³ç´°ãƒ‡ãƒãƒƒã‚°:");
                    console.log(`  ğŸ“‹ atlas: ${conversionResult.blobUrls.atlas || 'UNDEFINED'}`);
                    console.log(`  ğŸ“‹ json: ${conversionResult.blobUrls.json || 'UNDEFINED'}`);
                    console.log(`  ğŸ“‹ texture: ${conversionResult.blobUrls.texture || 'UNDEFINED'}`);
                    
                    // undefinedæ¤œå‡º
                    const undefinedKeys = [];
                    if (!conversionResult.blobUrls.atlas) undefinedKeys.push('atlas');
                    if (!conversionResult.blobUrls.json) undefinedKeys.push('json');
                    if (!conversionResult.blobUrls.texture) undefinedKeys.push('texture');
                    
                    if (undefinedKeys.length > 0) {
                        console.error(`ğŸš¨ undefined Blob URLæ¤œå‡º: ${undefinedKeys.join(', ')}`);
                        console.log("ğŸ” ã“ã®undefinedãŒStableSpineRendererã®fetch(undefined)ã®åŸå› ã§ã™");
                    }
                } else {
                    console.error("ğŸš¨ conversionResult.blobUrlsè‡ªä½“ãŒundefinedã§ã™");
                }

                // ğŸ”¥ ä¿®æ­£: Canvasè¦ç´ ã‚’å‹•çš„ã«å†ä½œæˆã—ã¦ç«¶åˆå›é¿
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 400;
                canvas.style.border = '2px dashed rgba(255, 0, 0, 0.3)';
                canvas.style.display = 'block';
                canvas.style.margin = '0 auto';
                
                // æ—¢å­˜ã®Canvasã¨ç½®ãæ›ãˆ
                const oldCanvas = document.getElementById('spine-canvas');
                oldCanvas.parentNode.replaceChild(canvas, oldCanvas);
                canvas.id = 'spine-canvas';
                
                console.log("ğŸ¯ æ–°ã—ã„Canvasè¦ç´ ä½œæˆå®Œäº†");
                console.log(`Canvasæƒ…å ±: ${canvas.width}x${canvas.height}`);

                // StableSpineRendereråˆæœŸåŒ–
                const spineConfig = {
                    canvas: canvas, // DOMè¦ç´ ã‚’ç›´æ¥æ¸¡ã™
                    character: conversionResult.characterName,
                    basePath: conversionResult.basePath,
                    blobUrls: conversionResult.blobUrls, // FileToHttpBridge Blob URLçµ±åˆ
                    debug: debugMode,
                    logCallback: (message) => log(`[Spine] ${message}`, 'spine')
                };
                
                console.log("ğŸ” spineConfig:", spineConfig);
                spineRenderer = new StableSpineRenderer(spineConfig);

                // åˆæœŸåŒ–å®Ÿè¡Œ
                console.log("ğŸš€ StableSpineRendereråˆæœŸåŒ–é–‹å§‹...");
                await spineRenderer.initialize();
                console.log("âœ… StableSpineRendereråˆæœŸåŒ–å®Œäº†");

                // ğŸ¯ é‡è¦: åˆæœŸåŒ–å®Œäº†å¾Œã€æ˜ç¤ºçš„ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ç¢ºèª
                if (!spineRenderer.isAnimationRunning) {
                    console.log("ğŸ¨ æ‰‹å‹•ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹...");
                    const animationResult = spineRenderer.startAnimation();
                    console.log(`âœ… startAnimation() å®Ÿè¡Œçµæœ: ${animationResult}`);
                } else {
                    console.log("â„¹ï¸ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ—¢ã«å®Ÿè¡Œä¸­ã§ã™");
                }

                showStatus('phase3', 'âœ… StableSpineRendererçµ±åˆãƒ†ã‚¹ãƒˆå®Œäº† - Spineæç”»æˆåŠŸ', 'success');
                log('ğŸ‰ StableSpineRendererçµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†', 'success');

            } catch (error) {
                showStatus('phase3', `âŒ Spineçµ±åˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ Spineçµ±åˆå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        function cleanup() {
            try {
                log('ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹', 'info');

                let cleanupCount = 0;

                if (bridge) {
                    cleanupCount = bridge.cleanup();
                }

                if (spineRenderer) {
                    // StableSpineRendereråœæ­¢
                    spineRenderer = null;
                }

                conversionResult = null;

                // UIåˆæœŸåŒ–
                document.getElementById('convertBtn').disabled = selectedFiles ? false : true;
                document.getElementById('validateBtn').disabled = true;
                document.getElementById('spineBtn').disabled = true;
                document.getElementById('conversion-result').innerHTML = '';

                // CanvasåˆæœŸåŒ–
                const canvas = document.getElementById('spine-canvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                showStatus('phase1', `âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†: ${cleanupCount}ä»¶`, 'success');
                log(`âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†: ${cleanupCount}ä»¶`, 'success');

                updateStats();

            } catch (error) {
                showStatus('phase1', `âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateStats() {
            try {
                const stats = bridge ? bridge.getStats() : null;
                const statsGrid = document.getElementById('stats-grid');

                if (!stats) {
                    statsGrid.innerHTML = '<div class="stats-card"><h4>çµ±è¨ˆæƒ…å ±</h4><div class="stats-value">åˆæœŸåŒ–å¾…ã¡</div></div>';
                    return;
                }

                statsGrid.innerHTML = `
                    <div class="stats-card">
                        <h4>ç·å¤‰æ›å›æ•°</h4>
                        <div class="stats-value">${stats.totalConversions}</div>
                    </div>
                    <div class="stats-card">
                        <h4>æˆåŠŸç‡</h4>
                        <div class="stats-value">${stats.performance.successRate}</div>
                    </div>
                    <div class="stats-card">
                        <h4>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</h4>
                        <div class="stats-value">${stats.activeCharacters.length}</div>
                    </div>
                    <div class="stats-card">
                        <h4>Blob URLæ•°</h4>
                        <div class="stats-value">${stats.memoryUsage.blobUrls}</div>
                    </div>
                    <div class="stats-card">
                        <h4>æ¨å®šãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡</h4>
                        <div class="stats-value">${formatSize(stats.memoryUsage.estimatedSize)}</div>
                    </div>
                    <div class="stats-card">
                        <h4>ç¨¼åƒæ™‚é–“</h4>
                        <div class="stats-value">${Math.round(stats.uptime / 1000)}s</div>
                    </div>
                `;

                log('ğŸ“Š çµ±è¨ˆæƒ…å ±æ›´æ–°å®Œäº†', 'info');

            } catch (error) {
                log(`âŒ çµ±è¨ˆæ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function showStatus(phase, message, type = 'info') {
            const element = document.getElementById(`${phase}-status`);
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            element.innerHTML = `<div class="${className}">${message}</div>`;
        }

        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = type === 'error' ? 'color: #ff6b6b;' : 
                            type === 'success' ? 'color: #4CAF50;' :
                            type === 'bridge' ? 'color: #2196F3;' :
                            type === 'spine' ? 'color: #ff9800;' : 'color: #00ff00;';
            
            logContainer.innerHTML += `<div style="${logClass}">[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
            log('ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†', 'info');
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            const base = 1024;
            const index = Math.floor(Math.log(bytes) / Math.log(base));
            return (bytes / Math.pow(base, index)).toFixed(1) + ' ' + units[index];
        }

        // ğŸ”¥ Phase 1çµ±åˆ: æ–°ã—ã„ãƒ†ã‚¹ãƒˆé–¢æ•°ç¾¤
        
        // HTTPã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆãƒ†ã‚¹ãƒˆ
        async function testInterceptor() {
            try {
                if (!selectedFiles) {
                    throw new Error('Spineãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                log('ğŸ”„ HTTPã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');

                // å¤‰æ›ãŒã¾ã ã®å ´åˆã¯å®Ÿè¡Œ
                if (!conversionResult) {
                    await testConversion();
                }

                // Bridge HTTPã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆç¢ºèª
                const stats = bridge.getStats();
                const mapping = bridge.pathToBlobMapping;
                
                log(`ğŸ“Š HTTPã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆçŠ¶æ³: ãƒãƒƒãƒ”ãƒ³ã‚°æ•° ${mapping.size}`, 'info');
                
                // ãƒãƒƒãƒ”ãƒ³ã‚°ã®è©³ç´°ç¢ºèª
                let mappingCount = 0;
                for (const [virtualPath, blobUrl] of mapping.entries()) {
                    log(`ğŸ—ºï¸ [${mappingCount + 1}] ${virtualPath} â†’ ${blobUrl.substring(0, 30)}...`, 'info');
                    mappingCount++;
                }

                // fetch ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆãƒ†ã‚¹ãƒˆ
                log('ğŸ§ª fetch ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ', 'info');
                const testUrls = Array.from(mapping.keys()).slice(0, 3);
                
                for (const testUrl of testUrls) {
                    try {
                        console.log(`ğŸ”„ fetchãƒ†ã‚¹ãƒˆ: ${testUrl}`);
                        const response = await fetch(testUrl);
                        if (response.ok) {
                            log(`âœ… fetchã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆæˆåŠŸ: ${testUrl}`, 'success');
                        } else {
                            log(`âŒ fetchã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆå¤±æ•—: ${testUrl} (${response.status})`, 'error');
                        }
                    } catch (error) {
                        log(`âŒ fetchãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${testUrl} - ${error.message}`, 'error');
                    }
                }

                showStatus('phase1', 'âœ… HTTPã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');

            } catch (error) {
                showStatus('phase1', `âŒ HTTPã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ HTTPã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // MeshAttachmentå•é¡Œè§£æ±ºãƒ†ã‚¹ãƒˆ
        async function testMeshAttachmentFix() {
            try {
                if (!conversionResult) {
                    throw new Error('å¤‰æ›çµæœãŒã‚ã‚Šã¾ã›ã‚“');
                }

                log('ğŸ”§ MeshAttachmentå•é¡Œè§£æ±ºãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                showStatus('phase2', 'ğŸ”„ MeshAttachmentãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'info');

                // Imageä½œæˆãƒ†ã‚¹ãƒˆï¼ˆFileToHttpBridge ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆçµŒç”±ï¼‰
                const testImageUrl = conversionResult.blobUrls.texture;
                const testImage = new Image();
                
                await new Promise((resolve, reject) => {
                    testImage.onload = () => {
                        log(`âœ… Imageèª­ã¿è¾¼ã¿æˆåŠŸ: ${testImage.width}x${testImage.height}`, 'success');
                        resolve();
                    };
                    testImage.onerror = (error) => {
                        log(`âŒ Imageèª­ã¿è¾¼ã¿å¤±æ•—`, 'error');
                        reject(error);
                    };
                    
                    console.log(`ğŸ–¼ï¸ Image.srcè¨­å®šãƒ†ã‚¹ãƒˆ: nezumi.png`);
                    testImage.src = 'nezumi.png'; // FileToHttpBridge ã§ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆã•ã‚Œã‚‹ã¯ãš
                });

                // ã•ã‚‰ã«è©³ç´°ãªãƒãƒƒãƒ”ãƒ³ã‚°ç¢ºèª
                const characterName = conversionResult.characterName;
                const texturePatterns = [
                    `${characterName}.png`,
                    `${characterName}.jpg`,
                    'nezumi.png',
                    'purattokun.png'
                ];

                for (const pattern of texturePatterns) {
                    const mapped = bridge.pathToBlobMapping.get(pattern);
                    if (mapped) {
                        log(`âœ… ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³ç¢ºèª: ${pattern} â†’ Blob URLå­˜åœ¨`, 'success');
                    } else {
                        log(`âš ï¸ ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³æœªå¯¾å¿œ: ${pattern}`, 'warning');
                    }
                }

                showStatus('phase2', 'âœ… MeshAttachmentå•é¡Œè§£æ±ºãƒ†ã‚¹ãƒˆå®Œäº†', 'success');

            } catch (error) {
                showStatus('phase2', `âŒ MeshAttachmentãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ MeshAttachmentãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // MeshAttachmentå•é¡Œè§£æ±ºç¢ºèª
        async function verifyMeshAttachmentFix() {
            try {
                if (!spineRenderer) {
                    throw new Error('StableSpineRenderer ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                log('ğŸ” MeshAttachmentå•é¡Œè§£æ±ºç¢ºèªé–‹å§‹', 'info');
                showStatus('phase3', 'ğŸ”„ MeshAttachmentè§£æ±ºç¢ºèªä¸­...', 'info');

                // SpineRenderer ã®å†…éƒ¨çŠ¶æ…‹ç¢ºèª
                const status = spineRenderer.getStatus();
                log(`ğŸ“Š SpineRendererçŠ¶æ…‹: åˆæœŸåŒ–æ¸ˆã¿=${status.initialized}, ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­=${status.isAnimationRunning}`, 'info');

                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ‘ã‚¤ãƒ³è¦ç´ ç¢ºèª
                if (window.globalSpinePageMap) {
                    log(`ğŸ—ºï¸ Global Spine Page Map: ${window.globalSpinePageMap.size}å€‹ã®ãƒšãƒ¼ã‚¸`, 'info');
                } else {
                    log('âš ï¸ Global Spine Page Map ãŒå­˜åœ¨ã—ã¾ã›ã‚“', 'warning');
                }

                // MeshAttachment ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆç¢ºèª
                if (window.spine && window.spine.MeshAttachment) {
                    const meshProto = window.spine.MeshAttachment.prototype;
                    if (meshProto.updateRegion.toString().includes('ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆ')) {
                        log('âœ… MeshAttachment.updateRegion ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆãŒæœ‰åŠ¹ã§ã™', 'success');
                    } else {
                        log('âš ï¸ MeshAttachment.updateRegion ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“', 'warning');
                    }
                }

                // æç”»ã‚¨ãƒ©ãƒ¼ç›£è¦–
                let renderErrors = 0;
                const originalConsoleError = console.error;
                console.error = function(...args) {
                    if (args.some(arg => typeof arg === 'string' && arg.includes('updateRegion'))) {
                        renderErrors++;
                    }
                    originalConsoleError.apply(console, args);
                };

                // 3ç§’é–“ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ç›£è¦–
                setTimeout(() => {
                    console.error = originalConsoleError;
                    if (renderErrors === 0) {
                        log('âœ… MeshAttachment.updateRegion ã‚¨ãƒ©ãƒ¼æ¤œå‡ºã•ã‚Œãš - å•é¡Œè§£æ±ºç¢ºèª', 'success');
                        showStatus('phase3', 'âœ… MeshAttachmentå•é¡Œè§£æ±ºç¢ºèª - ã‚¨ãƒ©ãƒ¼ãªã—', 'success');
                    } else {
                        log(`âŒ MeshAttachment.updateRegion ã‚¨ãƒ©ãƒ¼æ¤œå‡º: ${renderErrors}å›`, 'error');
                        showStatus('phase3', `âŒ MeshAttachmentå•é¡Œæœªè§£æ±º - ã‚¨ãƒ©ãƒ¼${renderErrors}å›`, 'error');
                    }
                }, 3000);

                log('â³ 3ç§’é–“ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ...', 'info');

            } catch (error) {
                showStatus('phase3', `âŒ MeshAttachmentç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ MeshAttachmentç¢ºèªå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // å®šæœŸçµ±è¨ˆæ›´æ–°
        setInterval(updateStats, 5000);

        // selectSpineFolderé–¢æ•°ã‚’å®šç¾©ï¼ˆ175è¡Œç›®ã§ä½¿ç”¨ï¼‰
        function selectSpineFolder() {
            // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãä»£ã‚ã‚Šã«ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆSpineãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            loadDefaultSpineFiles();
        }
    </script>

    <!-- ç·Šæ€¥ãƒ‡ãƒãƒƒã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="test-section">
        <h3>ğŸ”¬ ç·Šæ€¥ãƒ‡ãƒãƒƒã‚° - SpineJSå†…éƒ¨è§£æ</h3>
        <div class="controls">
            <button class="danger-btn" onclick="runEmergencyDebugTest()">âš¡ ç·Šæ€¥ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆ</button>
            <button class="secondary-btn" onclick="showDetailedLogs()">ğŸ“‹ è©³ç´°ãƒ­ã‚°è¡¨ç¤º</button>
            <button class="primary-btn" onclick="runMeshAttachmentAnalysis()">ğŸ” MeshAttachmentè©³ç´°åˆ†æ</button>
        </div>
        <div id="emergency-debug-result"></div>
    </div>

    <!-- MeshAttachmentåˆ†æãƒ„ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ -->
    <script src="../debug-mesh-attachment-analysis.js"></script>

    <script>
    // ç·Šæ€¥ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆé–¢æ•°
    async function runEmergencyDebugTest() {
        try {
            console.log("ğŸš¨ ç·Šæ€¥ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆé–‹å§‹ - getImageè©³ç´°è¿½è·¡");
            document.getElementById("emergency-debug-result").innerHTML = "<div class=\"info\">ğŸ”„ ç·Šæ€¥ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>";
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦å³åº§ã«ãƒ†ã‚¹ãƒˆ
            if (!selectedFiles) {
                await loadDefaultSpineFiles();
            }
            
            if (!conversionResult) {
                await testConversion();
            }
            
            console.log("ğŸ¯ StableSpineRendereråˆæœŸåŒ– - getImageè©³ç´°è¿½è·¡ãƒ¢ãƒ¼ãƒ‰");
            await testSpineIntegration();
            
            document.getElementById("emergency-debug-result").innerHTML = "<div class=\"success\">âœ… ç·Šæ€¥ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆå®Œäº† - F12ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèª</div>";
            
        } catch (error) {
            console.error("âŒ ç·Šæ€¥ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆå¤±æ•—:", error);
            document.getElementById("emergency-debug-result").innerHTML = `<div class="error">âŒ ç·Šæ€¥ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}</div>`;
        }
    }
    
    // è©³ç´°ãƒ­ã‚°è¡¨ç¤ºé–¢æ•°
    function showDetailedLogs() {
        const logContainer = document.getElementById("log-container");
        logContainer.style.maxHeight = "500px";
        logContainer.scrollTop = logContainer.scrollHeight;
        console.log("ğŸ“‹ ãƒ­ã‚°è¡¨ç¤ºã‚’æ‹¡å¼µã—ã¾ã—ãŸ - getImageé–¢æ•°ã®è©³ç´°ãªå‘¼ã³å‡ºã—çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
    }
    
    // ğŸ” æ®µéšçš„å®‰å…¨è¨ºæ–­ - ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥é˜²æ­¢ç‰ˆ
    let diagnosticStep = 0;
    let successRenderer = null;
    let failureRenderer = null;
    
    async function runStepByStepDiagnosis() {
        try {
            diagnosticStep++;
            console.log(`ğŸ” æ®µéš ${diagnosticStep}: å®‰å…¨è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰`);
            
            const resultDiv = document.getElementById("comparison-result");
            
            switch (diagnosticStep) {
                case 1:
                    resultDiv.innerHTML = "<div class=\"info\">Step 1: æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³æ§‹é€ åˆ†æä¸­...</div>";
                    await analyzeSucessPattern();
                    break;
                case 2:
                    resultDiv.innerHTML = "<div class=\"info\">Step 2: å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³æº–å‚™ä¸­...</div>";
                    await prepareFailurePattern();
                    break;
                case 3:
                    resultDiv.innerHTML = "<div class=\"info\">Step 3: å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³æ§‹é€ åˆ†æä¸­...</div>";
                    await analyzeFailurePattern();
                    break;
                case 4:
                    resultDiv.innerHTML = "<div class=\"info\">Step 4: è©³ç´°å·®ç•°æ¯”è¼ƒä¸­...</div>";
                    await comparePatterns();
                    break;
                case 5:
                    resultDiv.innerHTML = "<div class=\"info\">Step 5: getImage()è©³ç´°ãƒ†ã‚¹ãƒˆä¸­...</div>";
                    await testGetImageDetails();
                    break;
                default:
                    diagnosticStep = 0;
                    resultDiv.innerHTML = "<div class=\"success\">âœ… å…¨æ®µéšå®Œäº† - è¨ºæ–­ã‚’ãƒªã‚»ãƒƒãƒˆ</div>";
            }
            
        } catch (error) {
            console.error(`âŒ æ®µéš ${diagnosticStep} è¨ºæ–­å¤±æ•—:`, error);
            document.getElementById("comparison-result").innerHTML = `<div class="error">âŒ Step ${diagnosticStep} å¤±æ•—: ${error.message}</div>`;
        }
    }
    
    async function analyzeSucessPattern() {
        console.log("âœ… æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æé–‹å§‹ - ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç›£è¦–");
        
        if (!successRenderer) {
            successRenderer = new StableSpineRenderer({
                character: 'nezumi',
                canvasId: 'comparison-success-canvas'
            });
            await successRenderer.initialize();
            
            // ğŸ¯ é‡è¦: æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            console.log("ğŸ¨ æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹");
            if (successRenderer.startAnimation && typeof successRenderer.startAnimation === 'function') {
                successRenderer.startAnimation();
                console.log("âœ… æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³: startAnimation() å®Ÿè¡Œå®Œäº†");
            } else {
                console.warn("âš ï¸ æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³: startAnimation() ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            }
        }
        
        // StableSpineRendererã®atlaså‚ç…§ã‚’è¤‡æ•°ã®æ–¹æ³•ã§è©¦è¡Œ
        const atlas = successRenderer.atlas || successRenderer.textureAtlas || successRenderer.assetManager?.get('nezumi.atlas');
        const analysis = {
            pages_count: atlas ? atlas.pages?.length || 0 : 0,
            regions_count: atlas ? atlas.regions?.length || 0 : 0,
            page0_exists: atlas?.pages?.[0] ? true : false,
            page0_texture_exists: atlas?.pages?.[0]?.texture ? true : false,
            page0_getImage_exists: typeof atlas?.pages?.[0]?.texture?.getImage === 'function',
            page0_getImage_result: null
        };
        
        // å®‰å…¨ãªgetImage()ãƒ†ã‚¹ãƒˆ
        if (analysis.page0_getImage_exists) {
            try {
                analysis.page0_getImage_result = atlas?.pages?.[0]?.texture?.getImage?.();
                analysis.getImage_type = analysis.page0_getImage_result ? typeof analysis.page0_getImage_result : 'null';
            } catch (e) {
                analysis.getImage_error = e.message;
            }
        }
        
        // ğŸ” é‡è¦: pageã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«getImageãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if (atlas?.pages?.[0]) {
            analysis.page0_has_getImage_method = typeof atlas.pages[0].getImage === 'function';
            analysis.page0_direct_getImage = atlas.pages[0].getImage ? 'ãƒ¡ã‚½ãƒƒãƒ‰å­˜åœ¨' : 'ãƒ¡ã‚½ãƒƒãƒ‰ãªã—';
        }
        
        console.log("âœ… æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æçµæœ:", analysis);
        document.getElementById("comparison-result").innerHTML = `
            <div class="success">âœ… æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æå®Œäº†</div>
            <div class="info">Pages: ${analysis.pages_count}, Regions: ${analysis.regions_count}</div>
            <div class="info">getImage(): ${analysis.page0_getImage_result ? 'æ­£å¸¸' : 'null/ã‚¨ãƒ©ãƒ¼'}</div>
        `;
    }
    
    async function prepareFailurePattern() {
        console.log("âŒ å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³æº–å‚™é–‹å§‹");
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™
        if (!selectedFiles) {
            await loadDefaultSpineFiles();
        }
        if (!conversionResult) {
            await testConversion();
        }
        
        document.getElementById("comparison-result").innerHTML = "<div class=\"success\">âœ… å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³æº–å‚™å®Œäº†</div>";
        console.log("âŒ å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³æº–å‚™å®Œäº† - Blob URLsåˆ©ç”¨å¯èƒ½");
    }
    
    async function analyzeFailurePattern() {
        console.log("âŒ å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æé–‹å§‹");
        
        // ğŸš¨ ä¿®æ­£: conversionResult.blobUrls ã‚’æ­£ã—ãä½¿ç”¨
        console.log("ğŸš¨ analyzeFailurePattern - blobUrlså–å¾—:");
        console.log("  conversionResult.blobUrls:", conversionResult.blobUrls);
        
        const blobUrls = {
            atlas: conversionResult.blobUrls?.atlas,
            json: conversionResult.blobUrls?.json,
            texture: conversionResult.blobUrls?.texture
        };
        
        console.log("ğŸš¨ analyzeFailurePattern - ä¿®æ­£å¾ŒblobUrls:", blobUrls);
        
        if (!failureRenderer) {
            failureRenderer = new StableSpineRenderer({
                character: 'nezumi', // æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã¨åŒã˜ãƒ‘ã‚¹åã‚’ä½¿ç”¨
                canvasId: 'comparison-failure-canvas',
                blobUrls: blobUrls
            });
            await failureRenderer.initialize();
            
            // ğŸ¯ é‡è¦: FileToHttpBridgeãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            console.log("ğŸ¨ FileToHttpBridgeãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹");
            if (failureRenderer.startAnimation && typeof failureRenderer.startAnimation === 'function') {
                failureRenderer.startAnimation();
                console.log("âœ… FileToHttpBridgeãƒ‘ã‚¿ãƒ¼ãƒ³: startAnimation() å®Ÿè¡Œå®Œäº†");
            } else {
                console.warn("âš ï¸ FileToHttpBridgeãƒ‘ã‚¿ãƒ¼ãƒ³: startAnimation() ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            }
        }
        
        // StableSpineRendererã®atlaså‚ç…§ã‚’è¤‡æ•°ã®æ–¹æ³•ã§è©¦è¡Œ
        console.log("ğŸš¨ è¨ºæ–­: failureRendereræ§‹é€ èª¿æŸ»");
        console.log("  ğŸ“‹ failureRenderer.atlas:", failureRenderer.atlas?.constructor?.name);
        console.log("  ğŸ“‹ failureRenderer.textureAtlas:", failureRenderer.textureAtlas?.constructor?.name);
        console.log("  ğŸ“‹ assetManager.get('nezumi.atlas'):", failureRenderer.assetManager?.get('nezumi.atlas')?.constructor?.name);
        
        // assetManager.get('nezumi.atlas')ã¯Stringå‹ãªã®ã§ã€å®Ÿéš›ã®TextureAtlasã‚’æ¢ã™
        let atlas = failureRenderer.atlas || failureRenderer.textureAtlas;
        
        // å†…éƒ¨ã®TextureAtlasã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ¢ã™
        if (!atlas) {
            // StableSpineRendererã®å†…éƒ¨æ§‹é€ ã‹ã‚‰ç›´æ¥TextureAtlasã‚’å–å¾—
            const internalAtlas = failureRenderer.attachmentLoader?.atlas || failureRenderer.skeletonJson?.attachmentLoader?.atlas;
            if (internalAtlas && typeof internalAtlas.findRegion === 'function') {
                atlas = internalAtlas;
                console.log("ğŸ¯ è¨ºæ–­: å†…éƒ¨TextureAtlasç™ºè¦‹:", atlas.constructor?.name);
            }
        }
        const analysis = {
            pages_count: atlas?.pages?.length || 0,
            regions_count: atlas?.regions?.length || 0,
            page0_exists: atlas?.pages?.[0] ? true : false,
            page0_texture_exists: atlas?.pages?.[0]?.texture ? true : false,
            page0_getImage_exists: typeof atlas?.pages?.[0]?.texture?.getImage === 'function',
            page0_getImage_result: null
        };
        
        // å®‰å…¨ãªgetImage()ãƒ†ã‚¹ãƒˆ
        if (analysis.page0_getImage_exists) {
            try {
                analysis.page0_getImage_result = atlas?.pages?.[0]?.texture?.getImage?.() || atlas?.pages?.[0]?.getImage?.();
                analysis.getImage_type = analysis.page0_getImage_result ? typeof analysis.page0_getImage_result : 'null';
            } catch (e) {
                analysis.getImage_error = e.message;
            }
        }
        
        console.log("âŒ å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æçµæœ:", analysis);
        document.getElementById("comparison-result").innerHTML = `
            <div class="success">âœ… å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æå®Œäº†</div>
            <div class="info">Pages: ${analysis.pages_count}, Regions: ${analysis.regions_count}</div>
            <div class="info">getImage(): ${analysis.page0_getImage_result ? 'æ­£å¸¸' : 'null/ã‚¨ãƒ©ãƒ¼'}</div>
        `;
    }
    
    async function comparePatterns() {
        console.log("ğŸ” ãƒ‘ã‚¿ãƒ¼ãƒ³æ¯”è¼ƒé–‹å§‹");
        
        const successAtlas = successRenderer?.atlas;
        const failureAtlas = failureRenderer?.atlas;
        
        const comparison = {
            success_pages: successAtlas?.pages?.length || 0,
            failure_pages: failureAtlas?.pages?.length || 0,
            success_regions: successAtlas?.regions?.length || 0,
            failure_regions: failureAtlas?.regions?.length || 0,
            success_getImage: null,
            failure_getImage: null,
            success_texture_type: successAtlas?.pages?.[0]?.texture?.constructor?.name,
            failure_texture_type: failureAtlas?.pages?.[0]?.texture?.constructor?.name
        };
        
        // å®‰å…¨ãªgetImageæ¯”è¼ƒ
        try {
            comparison.success_getImage = successAtlas?.pages?.[0]?.texture?.getImage?.();
        } catch (e) {
            comparison.success_getImage_error = e.message;
        }
        
        try {
            comparison.failure_getImage = failureAtlas?.pages?.[0]?.texture?.getImage?.();
        } catch (e) {
            comparison.failure_getImage_error = e.message;
        }
        
        console.log("ğŸ¯ è©³ç´°æ¯”è¼ƒçµæœ:", comparison);
        document.getElementById("comparison-result").innerHTML = `
            <div class="success">âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³æ¯”è¼ƒå®Œäº†</div>
            <div class="info">ğŸ“Š Pages - æˆåŠŸ: ${comparison.success_pages}, å¤±æ•—: ${comparison.failure_pages}</div>
            <div class="info">ğŸ“Š Regions - æˆåŠŸ: ${comparison.success_regions}, å¤±æ•—: ${comparison.failure_regions}</div>
            <div class="info">ğŸ¯ getImage - æˆåŠŸ: ${comparison.success_getImage ? 'æ­£å¸¸' : 'null'}, å¤±æ•—: ${comparison.failure_getImage ? 'æ­£å¸¸' : 'null'}</div>
            <div class="info">ğŸ”§ Textureå‹ - æˆåŠŸ: ${comparison.success_texture_type}, å¤±æ•—: ${comparison.failure_texture_type}</div>
        `;
    }
    
    async function testGetImageDetails() {
        console.log("ğŸ”¬ getImage()è©³ç´°ãƒ†ã‚¹ãƒˆé–‹å§‹");
        
        const details = {
            success: {},
            failure: {}
        };
        
        // æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³è©³ç´°
        if (successRenderer?.atlas?.pages?.[0]?.texture) {
            const texture = successRenderer.atlas.pages[0].texture;
            details.success = {
                texture_exists: true,
                getImage_method: typeof texture.getImage,
                getImage_result: texture.getImage ? texture.getImage() : null,
                texture_properties: Object.getOwnPropertyNames(texture)
            };
        }
        
        // å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³è©³ç´°
        if (failureRenderer?.atlas?.pages?.[0]?.texture) {
            const texture = failureRenderer.atlas.pages[0].texture;
            details.failure = {
                texture_exists: true,
                getImage_method: typeof texture.getImage,
                getImage_result: texture.getImage ? texture.getImage() : null,
                texture_properties: Object.getOwnPropertyNames(texture)
            };
        }
        
        console.log("ğŸ”¬ getImage()è©³ç´°çµæœ:", details);
        
        // æ ¹æœ¬åŸå› ã®ç‰¹å®š
        let rootCause = "æœªç‰¹å®š";
        if (!details.failure.getImage_result && details.success.getImage_result) {
            rootCause = "å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã®texture.getImage()ãŒnullã‚’è¿”ã—ã¦ã„ã‚‹";
        } else if (details.failure.getImage_method !== details.success.getImage_method) {
            rootCause = "texture.getImage()ãƒ¡ã‚½ãƒƒãƒ‰ã®å‹ãŒç•°ãªã‚‹";
        }
        
        document.getElementById("comparison-result").innerHTML = `
            <div class="success">âœ… getImage()è©³ç´°ãƒ†ã‚¹ãƒˆå®Œäº†</div>
            <div class="info">ğŸ¯ æ ¹æœ¬åŸå› : ${rootCause}</div>
            <div class="info">ğŸ”§ æˆåŠŸtexture: ${details.success.texture_properties?.length || 0}ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£</div>
            <div class="info">ğŸ”§ å¤±æ•—texture: ${details.failure.texture_properties?.length || 0}ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£</div>
        `;
    }
    </script>
</body>
</html>