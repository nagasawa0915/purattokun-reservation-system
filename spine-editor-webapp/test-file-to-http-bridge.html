<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileToHttpBridge Phase 1 MVP ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }

        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .primary-btn {
            background: #4CAF50;
            color: white;
        }

        .primary-btn:hover {
            background: #45a049;
        }

        .secondary-btn {
            background: #2196F3;
            color: white;
        }

        .secondary-btn:hover {
            background: #1976D2;
        }

        .danger-btn {
            background: #f44336;
            color: white;
        }

        .danger-btn:hover {
            background: #d32f2f;
        }

        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .stats-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
        }

        .stats-card h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .stats-value {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }

        .spine-canvas {
            border: 2px solid #ddd;
            border-radius: 5px;
            background: #fff;
            margin: 10px 0;
        }

        .error {
            color: #f44336;
            background: #ffebee;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            color: #4CAF50;
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .file-info {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            font-family: monospace;
        }

        .debug-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="debug-toggle">
        <label>
            <input type="checkbox" id="debugMode" checked> ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
        </label>
    </div>

    <div class="header">
        <h1>ğŸŒ‰ FileToHttpBridge Phase 1 MVP ãƒ†ã‚¹ãƒˆ</h1>
        <p>File API â†’ StableSpineRendererçµ±åˆãƒ†ã‚¹ãƒˆã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸</p>
    </div>

    <!-- Phase 1: åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ -->
    <div class="test-section">
        <h3>ğŸ”§ Phase 1: åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h3>
        <div class="controls">
            <button class="primary-btn" onclick="selectSpineFolder()">ğŸ“‚ Spineãƒ•ã‚©ãƒ«ãƒ€é¸æŠ</button>
            <button class="secondary-btn" onclick="testBlobUrlManager()" disabled>ğŸ”— BlobUrlManager ãƒ†ã‚¹ãƒˆ</button>
            <button class="secondary-btn" onclick="testPathGenerator()">ğŸ—‚ï¸ PathGenerator ãƒ†ã‚¹ãƒˆ</button>
            <button class="danger-btn" onclick="cleanup()">ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—</button>
        </div>
        <div id="phase1-status"></div>
    </div>

    <!-- Phase 2: å¤‰æ›ãƒ†ã‚¹ãƒˆ -->
    <div class="test-section">
        <h3>ğŸ”„ Phase 2: File â†’ HTTPå¤‰æ›ãƒ†ã‚¹ãƒˆ</h3>
        <div class="controls">
            <button class="primary-btn" onclick="testConversion()" disabled id="convertBtn">âš¡ å¤‰æ›å®Ÿè¡Œ</button>
            <button class="secondary-btn" onclick="validateConversion()" disabled id="validateBtn">âœ… å¤‰æ›æ¤œè¨¼</button>
        </div>
        <div id="phase2-status"></div>
        <div id="conversion-result"></div>
    </div>

    <!-- Phase 3: StableSpineRendererçµ±åˆãƒ†ã‚¹ãƒˆ -->
    <div class="test-section">
        <h3>ğŸ® Phase 3: StableSpineRendererçµ±åˆãƒ†ã‚¹ãƒˆ</h3>
        <div class="controls">
            <button class="primary-btn" onclick="testSpineIntegration()" disabled id="spineBtn">ğŸ¯ Spineçµ±åˆãƒ†ã‚¹ãƒˆ</button>
        </div>
        <canvas id="spine-canvas" class="spine-canvas" width="400" height="400"></canvas>
        <div id="phase3-status"></div>
    </div>

    <!-- çµ±è¨ˆæƒ…å ±è¡¨ç¤º -->
    <div class="test-section">
        <h3>ğŸ“Š çµ±è¨ˆæƒ…å ±ãƒ»ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
        <div class="controls">
            <button class="secondary-btn" onclick="updateStats()">ğŸ”„ çµ±è¨ˆæ›´æ–°</button>
            <button class="secondary-btn" onclick="clearLogs()">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="stats-grid" id="stats-grid"></div>
        <div class="log-container" id="log-container"></div>
    </div>

    <!-- ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ -->
    <!-- Spine WebGL CDNï¼ˆå¿…é ˆï¼‰ -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.24/dist/iife/spine-webgl.js"></script>
    
    <!-- FileToHttpBridge ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    <script src="micromodules/bridge/BlobUrlManager.js"></script>
    <script src="micromodules/bridge/PathGenerator.js"></script>
    <script src="micromodules/bridge/FileToHttpBridge.js"></script>
    
    <!-- StableSpineRenderer -->
    <script src="../micromodules/spine-renderer/StableSpineRenderer.js"></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let bridge = null;
        let selectedFiles = null;
        let conversionResult = null;
        let spineRenderer = null;
        let debugMode = true;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeBridge();
            updateStats();
            log('ğŸš€ FileToHttpBridge ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†', 'info');
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•é¸æŠï¼ˆé–‹ç™ºç”¨ï¼‰
            loadDefaultSpineFiles();
            
            // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('debugMode').addEventListener('change', function(e) {
                debugMode = e.target.checked;
                if (bridge) {
                    bridge.config.debug = debugMode;
                }
                log(`ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ${debugMode ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`, 'info');
            });
        });

        // BridgeåˆæœŸåŒ–
        function initializeBridge() {
            try {
                bridge = new FileToHttpBridge({
                    debug: debugMode,
                    tempBasePath: '/temp/spine/',
                    logCallback: (message) => log(message, 'bridge')
                });
                
                showStatus('phase1', 'âœ… FileToHttpBridgeåˆæœŸåŒ–å®Œäº†', 'success');
                log('ğŸŒ‰ FileToHttpBridgeåˆæœŸåŒ–æˆåŠŸ', 'success');
            } catch (error) {
                showStatus('phase1', `âŒ BridgeåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ BridgeåˆæœŸåŒ–å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆSpineãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆé–‹ç™ºç”¨ï¼‰
        async function loadDefaultSpineFiles() {
            try {
                log('ğŸ“‚ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆSpineãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹', 'info');
                
                const basePath = '../assets/spine/characters/nezumi/';
                const fileNames = {
                    atlas: 'nezumi.atlas',
                    json: 'nezumi.json',
                    texture: 'nezumi.png'
                };
                
                // HTTPã§ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã—ã¦Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
                const fileHandles = {};
                for (const [type, fileName] of Object.entries(fileNames)) {
                    try {
                        const response = await fetch(basePath + fileName);
                        if (!response.ok) {
                            throw new Error(`${fileName}: ${response.status} ${response.statusText}`);
                        }
                        const arrayBuffer = await response.arrayBuffer();
                        const blob = new Blob([arrayBuffer]);
                        
                        // FileSystemFileHandleé¢¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
                        fileHandles[type] = {
                            name: fileName,
                            getFile: async () => new File([blob], fileName, { 
                                type: type === 'texture' ? 'image/png' : 'text/plain' 
                            })
                        };
                    } catch (error) {
                        log(`âš ï¸ ${fileName}èª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}`, 'warning');
                    }
                }
                
                // å¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«ãŒã™ã¹ã¦èª­ã¿è¾¼ã‚ãŸå ´åˆã®ã¿å‡¦ç†ç¶šè¡Œ
                if (fileHandles.atlas && fileHandles.json && fileHandles.texture) {
                    selectedFiles = fileHandles;
                    
                    // UIæ›´æ–°
                    document.getElementById('convertBtn').disabled = false;
                    document.querySelectorAll('button[onclick="testBlobUrlManager()"]')[0].disabled = false;
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±è¡¨ç¤º
                    let fileInfo = '<div class="success">âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆSpineãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†:</div>';
                    for (const [type, handle] of Object.entries(fileHandles)) {
                        fileInfo += `<div class="file-info">${type}: ${handle.name}</div>`;
                    }
                    
                    showStatus('phase1', fileInfo, 'success');
                    log(`âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆSpineãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†: nezumi`, 'success');
                } else {
                    throw new Error('å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                log(`âŒ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}`, 'error');
                log('ğŸ’¡ æ‰‹å‹•ã§ã€ŒğŸ“‚ Spineãƒ•ã‚©ãƒ«ãƒ€é¸æŠã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„', 'info');
            }
        }

        // Spineãƒ•ã‚©ãƒ«ãƒ€é¸æŠï¼ˆFile System Access APIï¼‰
        async function selectSpineFolder() {
            try {
                log('ğŸ“‚ Spineãƒ•ã‚©ãƒ«ãƒ€é¸æŠé–‹å§‹', 'info');

                if (!('showDirectoryPicker' in window)) {
                    throw new Error('File System Access APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé¸æŠ
                const dirHandle = await window.showDirectoryPicker({
                    mode: 'read',
                    startIn: 'documents'
                });

                log(`ğŸ“ é¸æŠãƒ•ã‚©ãƒ«ãƒ€: ${dirHandle.name}`, 'info');

                // å¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢
                const requiredFiles = ['atlas', 'json', 'png', 'jpg'];
                const foundFiles = {};

                for await (const [name, handle] of dirHandle.entries()) {
                    if (handle.kind === 'file') {
                        const extension = name.split('.').pop().toLowerCase();
                        
                        if (extension === 'atlas') {
                            foundFiles.atlas = handle;
                        } else if (extension === 'json') {
                            foundFiles.json = handle;
                        } else if (['png', 'jpg', 'jpeg'].includes(extension)) {
                            foundFiles.texture = handle;
                        }
                    }
                }

                // ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
                if (!foundFiles.atlas || !foundFiles.json || !foundFiles.texture) {
                    const missing = [];
                    if (!foundFiles.atlas) missing.push('atlas');
                    if (!foundFiles.json) missing.push('json');
                    if (!foundFiles.texture) missing.push('texture');
                    throw new Error(`å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${missing.join(', ')}`);
                }

                selectedFiles = foundFiles;
                
                // UIæ›´æ–°
                document.getElementById('convertBtn').disabled = false;
                document.querySelectorAll('button[onclick="testBlobUrlManager()"]')[0].disabled = false;
                
                // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±è¡¨ç¤º
                let fileInfo = '<div class="success">âœ… Spineãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå®Œäº†:</div>';
                for (const [type, handle] of Object.entries(foundFiles)) {
                    fileInfo += `<div class="file-info">${type}: ${handle.name}</div>`;
                }
                
                showStatus('phase1', fileInfo, 'success');
                log(`âœ… Spineãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå®Œäº†: ${Object.keys(foundFiles).length}ä»¶`, 'success');

            } catch (error) {
                showStatus('phase1', `âŒ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // BlobUrlManagerãƒ†ã‚¹ãƒˆ
        async function testBlobUrlManager() {
            try {
                log('ğŸ”— BlobUrlManagerå˜ä½“ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');

                const manager = new BlobUrlManager({ debug: debugMode });
                
                // ãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
                const testFile = new File(['test content'], 'test.txt', { type: 'text/plain' });
                
                // Blob URLä½œæˆãƒ†ã‚¹ãƒˆ
                const url = manager.createBlobUrl(testFile, 'text/plain');
                log(`ğŸ“ Blob URLä½œæˆãƒ†ã‚¹ãƒˆæˆåŠŸ: ${url.substring(0, 50)}...`, 'success');
                
                // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ
                const metadata = manager.getMetadata(url);
                log(`ğŸ“‹ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆæˆåŠŸ: ${JSON.stringify(metadata, null, 2)}`, 'info');
                
                // URLè§£æ”¾ãƒ†ã‚¹ãƒˆ
                const revoked = manager.revokeBlobUrl(url);
                log(`ğŸ—‘ï¸ URLè§£æ”¾ãƒ†ã‚¹ãƒˆæˆåŠŸ: ${revoked}`, 'success');
                
                showStatus('phase1', 'âœ… BlobUrlManagerå˜ä½“ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');

            } catch (error) {
                showStatus('phase1', `âŒ BlobUrlManagerãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ BlobUrlManagerãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // PathGeneratorãƒ†ã‚¹ãƒˆ
        function testPathGenerator() {
            try {
                log('ğŸ—‚ï¸ PathGeneratorå˜ä½“ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');

                // ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ç”Ÿæˆãƒ†ã‚¹ãƒˆ
                const basePath = PathGenerator.generateBasePath('nezumi');
                log(`ğŸ“ ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ç”Ÿæˆãƒ†ã‚¹ãƒˆ: ${basePath}`, 'info');

                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ç”Ÿæˆãƒ†ã‚¹ãƒˆ
                const filePath = PathGenerator.generateFilePath(basePath, 'nezumi.atlas', 'atlas');
                log(`ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ç”Ÿæˆãƒ†ã‚¹ãƒˆ: ${filePath}`, 'info');

                // ãƒ‘ã‚¹æ­£è¦åŒ–ãƒ†ã‚¹ãƒˆ
                const normalized = PathGenerator.normalizePath('//temp//spine\\nezumi\\');
                log(`ğŸ”„ ãƒ‘ã‚¹æ­£è¦åŒ–ãƒ†ã‚¹ãƒˆ: ${normalized}`, 'info');

                // å®Œå…¨ãƒ‘ã‚¹ã‚»ãƒƒãƒˆç”Ÿæˆãƒ†ã‚¹ãƒˆ
                const pathSet = PathGenerator.generateCompletePathSet('nezumi', {
                    atlas: 'nezumi.atlas',
                    json: 'nezumi.json',
                    texture: 'nezumi.png'
                });
                log(`ğŸ“¦ å®Œå…¨ãƒ‘ã‚¹ã‚»ãƒƒãƒˆç”Ÿæˆãƒ†ã‚¹ãƒˆ: ${JSON.stringify(pathSet, null, 2)}`, 'info');

                showStatus('phase1', 'âœ… PathGeneratorå˜ä½“ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');

            } catch (error) {
                showStatus('phase1', `âŒ PathGeneratorãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ PathGeneratorãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // File â†’ HTTPå¤‰æ›ãƒ†ã‚¹ãƒˆ
        async function testConversion() {
            try {
                if (!selectedFiles) {
                    throw new Error('Spineãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                log('âš¡ File â†’ HTTPå¤‰æ›ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                showStatus('phase2', 'ğŸ”„ å¤‰æ›å‡¦ç†ä¸­...', 'info');

                const characterName = 'nezumi';
                conversionResult = await bridge.convertCharacterFiles(characterName, selectedFiles);

                // å¤‰æ›çµæœè¡¨ç¤º
                let resultHtml = '<div class="success">âœ… å¤‰æ›å®Œäº†:</div>';
                resultHtml += `<div class="file-info">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å: ${conversionResult.characterName}</div>`;
                resultHtml += `<div class="file-info">ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹: ${conversionResult.basePath}</div>`;
                resultHtml += `<div class="file-info">å¤‰æ›æ™‚é–“: ${conversionResult.stats.conversionTime}ms</div>`;
                resultHtml += `<div class="file-info">ç·ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${formatSize(conversionResult.stats.totalSize)}</div>`;
                
                resultHtml += '<h4>ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹:</h4>';
                for (const [type, path] of Object.entries(conversionResult.files)) {
                    resultHtml += `<div class="file-info">${type}: ${path}</div>`;
                }

                document.getElementById('conversion-result').innerHTML = resultHtml;
                showStatus('phase2', 'âœ… File â†’ HTTPå¤‰æ›å®Œäº†', 'success');

                // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—æœ‰åŠ¹åŒ–
                document.getElementById('validateBtn').disabled = false;
                document.getElementById('spineBtn').disabled = false;

                log(`âœ… File â†’ HTTPå¤‰æ›æˆåŠŸ: ${characterName}`, 'success');

            } catch (error) {
                showStatus('phase2', `âŒ å¤‰æ›ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ å¤‰æ›å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // å¤‰æ›æ¤œè¨¼
        async function validateConversion() {
            try {
                if (!conversionResult) {
                    throw new Error('å¤‰æ›çµæœãŒã‚ã‚Šã¾ã›ã‚“');
                }

                log('âœ… å¤‰æ›çµæœæ¤œè¨¼é–‹å§‹', 'info');

                // Blob URLå­˜åœ¨ç¢ºèª
                for (const [type, blobUrl] of Object.entries(conversionResult.blobUrls)) {
                    try {
                        const response = await fetch(blobUrl);
                        if (!response.ok) {
                            throw new Error(`${type} Blob URLã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—: ${response.status}`);
                        }
                        log(`âœ… ${type} Blob URLæ¤œè¨¼æˆåŠŸ: ${blobUrl.substring(0, 50)}...`, 'success');
                    } catch (error) {
                        throw new Error(`${type} Blob URLæ¤œè¨¼å¤±æ•—: ${error.message}`);
                    }
                }

                showStatus('phase2', 'âœ… å¤‰æ›çµæœæ¤œè¨¼å®Œäº† - å…¨ã¦ã®Blob URLã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½', 'success');
                log('âœ… å¤‰æ›çµæœæ¤œè¨¼å®Œäº†', 'success');

            } catch (error) {
                showStatus('phase2', `âŒ æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ æ¤œè¨¼å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // StableSpineRendererçµ±åˆãƒ†ã‚¹ãƒˆ
        async function testSpineIntegration() {
            try {
                if (!conversionResult) {
                    throw new Error('å¤‰æ›çµæœãŒã‚ã‚Šã¾ã›ã‚“');
                }

                log('ğŸ® StableSpineRendererçµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                showStatus('phase3', 'ğŸ”„ SpineåˆæœŸåŒ–ä¸­...', 'info');

                // å¤‰æ›çµæœã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±å‡ºåŠ›
                log('ğŸ“‹ å¤‰æ›çµæœæ§‹é€ ç¢ºèª:', 'debug');
                log(`  characterName: ${conversionResult.characterName}`, 'debug');
                log(`  basePath: ${conversionResult.basePath}`, 'debug');
                log(`  blobUrlså­˜åœ¨: ${conversionResult.blobUrls ? 'YES' : 'NO'}`, 'debug');
                if (conversionResult.blobUrls) {
                    log(`  atlas: ${conversionResult.blobUrls.atlas ? 'YES' : 'NO'}`, 'debug');
                    log(`  json: ${conversionResult.blobUrls.json ? 'YES' : 'NO'}`, 'debug');
                    log(`  texture: ${conversionResult.blobUrls.texture ? 'YES' : 'NO'}`, 'debug');
                }

                // ãƒ‡ãƒãƒƒã‚°: å¤‰æ›çµæœå…¨ä½“ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›
                console.log("ğŸ” conversionResultå…¨ä½“:", conversionResult);
                console.log("ğŸ” conversionResult.blobUrls:", conversionResult.blobUrls);

                // StableSpineRendereråˆæœŸåŒ–
                const spineConfig = {
                    canvas: '#spine-canvas',
                    character: conversionResult.characterName,
                    basePath: conversionResult.basePath,
                    blobUrls: conversionResult.blobUrls, // FileToHttpBridge Blob URLçµ±åˆ
                    debug: debugMode,
                    logCallback: (message) => log(`[Spine] ${message}`, 'spine')
                };
                
                console.log("ğŸ” spineConfig:", spineConfig);
                spineRenderer = new StableSpineRenderer(spineConfig);

                // åˆæœŸåŒ–å®Ÿè¡Œ
                await spineRenderer.initialize();

                showStatus('phase3', 'âœ… StableSpineRendererçµ±åˆãƒ†ã‚¹ãƒˆå®Œäº† - Spineæç”»æˆåŠŸ', 'success');
                log('ğŸ‰ StableSpineRendererçµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†', 'success');

            } catch (error) {
                showStatus('phase3', `âŒ Spineçµ±åˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ Spineçµ±åˆå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        function cleanup() {
            try {
                log('ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹', 'info');

                let cleanupCount = 0;

                if (bridge) {
                    cleanupCount = bridge.cleanup();
                }

                if (spineRenderer) {
                    // StableSpineRendereråœæ­¢
                    spineRenderer = null;
                }

                conversionResult = null;

                // UIåˆæœŸåŒ–
                document.getElementById('convertBtn').disabled = selectedFiles ? false : true;
                document.getElementById('validateBtn').disabled = true;
                document.getElementById('spineBtn').disabled = true;
                document.getElementById('conversion-result').innerHTML = '';

                // CanvasåˆæœŸåŒ–
                const canvas = document.getElementById('spine-canvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                showStatus('phase1', `âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†: ${cleanupCount}ä»¶`, 'success');
                log(`âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†: ${cleanupCount}ä»¶`, 'success');

                updateStats();

            } catch (error) {
                showStatus('phase1', `âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateStats() {
            try {
                const stats = bridge ? bridge.getStats() : null;
                const statsGrid = document.getElementById('stats-grid');

                if (!stats) {
                    statsGrid.innerHTML = '<div class="stats-card"><h4>çµ±è¨ˆæƒ…å ±</h4><div class="stats-value">åˆæœŸåŒ–å¾…ã¡</div></div>';
                    return;
                }

                statsGrid.innerHTML = `
                    <div class="stats-card">
                        <h4>ç·å¤‰æ›å›æ•°</h4>
                        <div class="stats-value">${stats.totalConversions}</div>
                    </div>
                    <div class="stats-card">
                        <h4>æˆåŠŸç‡</h4>
                        <div class="stats-value">${stats.performance.successRate}</div>
                    </div>
                    <div class="stats-card">
                        <h4>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</h4>
                        <div class="stats-value">${stats.activeCharacters.length}</div>
                    </div>
                    <div class="stats-card">
                        <h4>Blob URLæ•°</h4>
                        <div class="stats-value">${stats.memoryUsage.blobUrls}</div>
                    </div>
                    <div class="stats-card">
                        <h4>æ¨å®šãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡</h4>
                        <div class="stats-value">${formatSize(stats.memoryUsage.estimatedSize)}</div>
                    </div>
                    <div class="stats-card">
                        <h4>ç¨¼åƒæ™‚é–“</h4>
                        <div class="stats-value">${Math.round(stats.uptime / 1000)}s</div>
                    </div>
                `;

                log('ğŸ“Š çµ±è¨ˆæƒ…å ±æ›´æ–°å®Œäº†', 'info');

            } catch (error) {
                log(`âŒ çµ±è¨ˆæ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function showStatus(phase, message, type = 'info') {
            const element = document.getElementById(`${phase}-status`);
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            element.innerHTML = `<div class="${className}">${message}</div>`;
        }

        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = type === 'error' ? 'color: #ff6b6b;' : 
                            type === 'success' ? 'color: #4CAF50;' :
                            type === 'bridge' ? 'color: #2196F3;' :
                            type === 'spine' ? 'color: #ff9800;' : 'color: #00ff00;';
            
            logContainer.innerHTML += `<div style="${logClass}">[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
            log('ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†', 'info');
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            const base = 1024;
            const index = Math.floor(Math.log(bytes) / Math.log(base));
            return (bytes / Math.pow(base, index)).toFixed(1) + ' ' + units[index];
        }

        // å®šæœŸçµ±è¨ˆæ›´æ–°
        setInterval(updateStats, 5000);
    </script>
</body>
</html>