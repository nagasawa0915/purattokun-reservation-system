/**
 * PureBoundingBoxAutoPin.js (çµ±åˆåˆ¶å¾¡ç‰ˆ)
 * 
 * ğŸ¯ è‡ªå‹•ãƒ”ãƒ³é©ç”¨ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆçµ±åˆåˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ï¼‰
 * - å¤–éƒ¨ä¾å­˜: ElementObserver Phase 1, PureBoundingBoxCore
 * - å†…éƒ¨ä¾å­˜: ConfigManager, BackgroundDetector, AnchorCalculator, PersistenceManager, PinDisplayManager
 * - è²¬å‹™: å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®çµ±åˆåˆ¶å¾¡ãƒ»ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½æä¾›
 * - è¡Œæ•°: ç´„350è¡Œï¼ˆ500è¡Œåˆ¶é™éµå®ˆï¼‰
 * - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 2.0 (ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ†å‰²ç‰ˆ)
 * - ä½œæˆæ—¥: 2025-09-05
 */

class PureBoundingBoxAutoPin {
    constructor(core, observer) {
        console.log('ğŸ” AutoPin-Constructor-1: åˆæœŸåŒ–é–‹å§‹ (v2.0 ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç‰ˆ)', {
            core_exists: !!core,
            observer_exists: !!observer,
            observer_null: observer === null,
            observer_undefined: observer === undefined
        });
        
        this.core = core;
        this.observer = observer; // ElementObserver Phase 1 instance
        
        // ğŸ¯ ãƒ”ãƒ³è¿½å¾“åˆ¶å¾¡ãƒ•ãƒ©ã‚°ï¼ˆBBç·¨é›†ä¸­ã¯ç„¡åŠ¹åŒ–ï¼‰
        this.pinSyncEnabled = true;
        
        // ===============================
        // ğŸš€ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–ï¼ˆæ–°ã‚·ã‚¹ãƒ†ãƒ ï¼‰
        // ===============================
        
        // 1. è¨­å®šç®¡ç†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
        this.configManager = new AutoPinConfigManager();
        console.log('âœ… AutoPinConfigManageråˆæœŸåŒ–å®Œäº†');
        
        // 2. èƒŒæ™¯æ¤œå‡ºãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
        this.backgroundDetector = new BackgroundDetector(this.configManager);
        console.log('âœ… BackgroundDetectoråˆæœŸåŒ–å®Œäº†');
        
        // 3. ã‚¢ãƒ³ã‚«ãƒ¼è¨ˆç®—ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
        this.anchorCalculator = new AnchorCalculator(this.configManager);
        console.log('âœ… AnchorCalculatoråˆæœŸåŒ–å®Œäº†');
        
        // 4. æ°¸ç¶šåŒ–ç®¡ç†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
        this.persistenceManager = new PersistenceManager(this.configManager);
        console.log('âœ… PersistenceManageråˆæœŸåŒ–å®Œäº†');
        
        // 5. UIè¡¨ç¤ºç®¡ç†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
        this.pinDisplayManager = new PinDisplayManager();
        console.log('âœ… PinDisplayManageråˆæœŸåŒ–å®Œäº†');
        
        // ===============================
        // ğŸ”— çµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        // ===============================
        
        this.activePins = new Map(); // nodeId -> pinConfig
        
        console.log('ğŸ” AutoPin-Constructor-2: observeræ¤œè¨¼', {
            this_observer_exists: !!this.observer,
            this_observer_null: this.observer === null,
            this_observer_undefined: this.observer === undefined,
            observer_type: typeof this.observer,
            observer_constructor: this.observer ? this.observer.constructor.name : 'null/undefined'
        });
        
        // ElementObserver Phase 1 ã®åŸºæœ¬æ©Ÿèƒ½ç¢ºèª
        if (!this.observer || typeof this.observer.observe !== 'function') {
            console.warn('âš ï¸ AutoPin-Constructor-3: ElementObserver Phase 1 åˆæœŸåŒ–æ™‚åˆ¤å®šå¤±æ•—', {
                observer_exists: !!this.observer,
                observe_type: this.observer ? typeof this.observer.observe : 'undefined',
                observe_exists: this.observer ? 'observe' in this.observer : false
            });
        } else {
            console.log('âœ… AutoPin-Constructor-4: ElementObserver Phase 1 åˆæœŸåŒ–æ™‚åˆ¤å®šæˆåŠŸ', {
                observe_type: typeof this.observer.observe,
                observer_methods: Object.getOwnPropertyNames(Object.getPrototypeOf(this.observer)).filter(name => typeof this.observer[name] === 'function')
            });
        }
        
        // ===============================
        // ğŸ’¾ æ°¸ç¶šåŒ–ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
        // ===============================
        
        this.restoreSystemData();
        
        // ===============================
        // ğŸ”„ ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¿½å¾“ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        // ===============================
        
        this.initializeResponsiveSystem();
        
        // BBç·¨é›†ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–ã®è¨­å®š
        this.setupBoundingBoxEventListeners();
        
        console.log('ğŸ¯ PureBoundingBoxAutoPin v2.0 (ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç‰ˆ) åˆæœŸåŒ–å®Œäº†');
    }
    
    // ==========================================
    // âš™ï¸ çµ±åˆè¨­å®šç®¡ç†ï¼ˆå§”è­²ï¼‰
    // ==========================================
    
    /**
     * ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’å¤‰æ›´
     * @param {string} mode - 'contain' ã¾ãŸã¯ 'cover'
     */
    setScalingMode(mode) {
        return this.configManager.setScalingMode(mode);
    }
    
    /**
     * ç¾åœ¨ã®è¨­å®šã‚’å–å¾—
     */
    getConfig() {
        return this.configManager.getConfig();
    }
    
    /**
     * è¨­å®šæ›´æ–°
     */
    updateConfig(newConfig) {
        return this.configManager.updateConfig(newConfig);
    }
    
    // ==========================================
    // ğŸ¯ ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½: ä¿å­˜æ™‚è‡ªå‹•ãƒ”ãƒ³é©ç”¨
    // ==========================================
    
    /**
     * ä¿å­˜æ™‚è‡ªå‹•ãƒ”ãƒ³é©ç”¨ï¼ˆãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ï¼‰
     */
    async applyAutoPinOnSave(saveData) {
        const startTime = performance.now();
        
        try {
            console.log('ğŸ¯ ä¿å­˜æ™‚è‡ªå‹•ãƒ”ãƒ³é©ç”¨é–‹å§‹ (v2.0)', {
                nodeId: this.core.config.nodeId,
                targetElement: this.getElementInfo(saveData.targetElement),
                bounds: saveData.bounds
            });
            
            // 1. èƒŒæ™¯è¦ç´ ã®è‡ªå‹•æ¤œå‡ºï¼ˆBackgroundDetectorã«å§”è­²ï¼‰
            const backgroundElement = this.backgroundDetector.detectBackgroundElement(saveData.targetElement);
            if (!backgroundElement) {
                throw new Error('é©åˆ‡ãªèƒŒæ™¯è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }
            
            // 2. æœ€é©ã‚¢ãƒ³ã‚«ãƒ¼ãƒã‚¤ãƒ³ãƒˆã®è¨ˆç®—ï¼ˆAnchorCalculatorã«å§”è­²ï¼‰
            const optimalAnchor = this.anchorCalculator.calculateOptimalAnchor(saveData.bounds, backgroundElement);
            console.log('ğŸ“ æœ€é©ã‚¢ãƒ³ã‚«ãƒ¼è¨ˆç®—çµæœ:', optimalAnchor);
            
            // 3. æ—¢å­˜ãƒ”ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            this.cleanupExistingPin(this.core.config.nodeId);
            
            // 4. æ–°ã—ã„ãƒ”ãƒ³ã®è¨­å®š
            console.log('ğŸš€ createAutoPinå‘¼ã³å‡ºã—é–‹å§‹:', {
                backgroundElement: backgroundElement ? this.getElementInfo(backgroundElement) : 'null',
                spineElement: saveData.targetElement ? this.getElementInfo(saveData.targetElement) : 'null',
                anchor: optimalAnchor,
                bounds: saveData.bounds
            });
            
            const pinConfig = await this.createAutoPin({
                targetElement: backgroundElement,
                spineElement: saveData.targetElement,
                anchor: optimalAnchor,
                bounds: saveData.bounds
            });
            
            console.log('ğŸ“‹ createAutoPinçµæœ:', {
                success: pinConfig?.success !== false,
                fallbackMode: pinConfig?.fallbackMode,
                hasId: !!pinConfig?.id,
                pinConfig: pinConfig
            });
            
            // 5. ãƒ”ãƒ³æƒ…å ±ã®è¨˜éŒ²
            if (pinConfig && pinConfig.id) {
                this.activePins.set(this.core.config.nodeId, pinConfig);
                console.log('âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ”ãƒ³ç™»éŒ²å®Œäº†:', this.core.config.nodeId);
                console.log('ğŸ“Š ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ”ãƒ³æ•°:', this.activePins.size);
            } else {
                console.error('âŒ ç„¡åŠ¹ãªpinConfigã®ãŸã‚ç™»éŒ²ã‚¹ã‚­ãƒƒãƒ—:', pinConfig);
            }
            
            // 6. æ°¸ç¶šåŒ–ï¼ˆPersistenceManagerã«å§”è­²ï¼‰
            this.saveSystemData();
            
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨˜éŒ²
            const processingTime = performance.now() - startTime;
            this.configManager.updatePerformanceMetrics(processingTime, true);
            
            console.log('âœ… è‡ªå‹•ãƒ”ãƒ³é©ç”¨å®Œäº†:', {
                pinConfig: pinConfig,
                processingTime: `${processingTime.toFixed(2)}ms`
            });
            
            return {
                success: true,
                pinConfig: pinConfig,
                message: `è‡ªå‹•è¿½å¾“æ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ (${optimalAnchor})`,
                processingTime
            };
            
        } catch (error) {
            const processingTime = performance.now() - startTime;
            this.configManager.updatePerformanceMetrics(processingTime, false);
            
            console.error('âŒ è‡ªå‹•ãƒ”ãƒ³é©ç”¨ã‚¨ãƒ©ãƒ¼:', error.message);
            
            return {
                success: false,
                error: error.message,
                processingTime
            };
        }
    }
    
    // ==========================================
    // ğŸ”— ElementObserver Phase 1çµ±åˆ
    // ==========================================
    
    /**
     * è‡ªå‹•ãƒ”ãƒ³ã®ä½œæˆï¼ˆPhase 1å¯¾å¿œç‰ˆï¼‰
     */
    async createAutoPin(config) {
        console.log('ğŸ”— è‡ªå‹•ãƒ”ãƒ³ä½œæˆé–‹å§‹ (Phase 1 v2.0)', {
            anchor: config.anchor,
            target: this.getElementInfo(config.targetElement),
            spine: this.getElementInfo(config.spineElement)
        });
        
        const startTime = performance.now();
        
        try {
            console.log('ğŸ” Phase 1-1: createAutoPinå®Ÿè¡Œé–‹å§‹ (v2.0)');
            
            // ElementObserverå–å¾—ãƒ»æ¤œè¨¼
            const observer = this.observer;
            
            if (!observer) {
                console.warn('ğŸš¨ Phase 1-5a: observerè‡ªä½“ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                return this.createFallbackResult('ElementObserverè‡ªä½“ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', config);
            }

            if (typeof observer.observe !== 'function') {
                console.warn('ğŸš¨ Phase 1-5b: observer.observeãŒé–¢æ•°ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                return this.createFallbackResult('observer.observeãƒ¡ã‚½ãƒƒãƒ‰ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', config);
            }
            
            console.log('âœ… Phase 1-7: ElementObserveråˆ¤å®šæˆåŠŸ - é€šå¸¸å‡¦ç†ç¶™ç¶š (v2.0)');
            
            // VIåº§æ¨™ç³»ã‚’ä½¿ç”¨ã—ãŸãƒ”ãƒ³ä½œæˆï¼ˆAnchorCalculatorã«å§”è­²ï¼‰
            const contentRect = this.backgroundDetector.calculateContentRect(config.targetElement);
            const viRatio = this.anchorCalculator.calculateViewportIndependentRatio(contentRect, contentRect);
            
            // é€šå¸¸ã®ãƒ”ãƒ³ä½œæˆå‡¦ç†ã‚’å®Ÿè¡Œ
            const anchorRatio = this.anchorCalculator.getAnchorRatio(config.anchor);
            
            const pinResult = {
                success: true,
                id: `autopin-${Date.now()}`,
                anchor: config.anchor,
                targetElement: config.targetElement,
                spineElement: config.spineElement,
                backgroundElement: config.targetElement,
                anchorRatio: anchorRatio,
                contentRect: contentRect,
                viRatio: viRatio,
                timestamp: Date.now()
            };
            
            const processingTime = performance.now() - startTime;
            console.log('âœ… Phase 1 è‡ªå‹•ãƒ”ãƒ³ä½œæˆæˆåŠŸ (v2.0):', {
                processingTime: `${processingTime.toFixed(2)}ms`,
                anchor: config.anchor
            });
            
            return pinResult;
            
        } catch (error) {
            const processingTime = performance.now() - startTime;
            console.error('âŒ Phase 1 è‡ªå‹•ãƒ”ãƒ³ä½œæˆã‚¨ãƒ©ãƒ¼ (v2.0):', error);
            
            return {
                success: false,
                error: error.message,
                processingTime,
                fallbackMode: true
            };
        }
    }
    
    /**
     * ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµæœã®ä½œæˆ
     */
    createFallbackResult(message, config) {
        return {
            success: false,
            fallbackMode: true,
            message: message,
            config: config
        };
    }
    
    // ==========================================
    // ğŸ’¾ æ°¸ç¶šåŒ–ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ
    // ==========================================
    
    /**
     * ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
     */
    saveSystemData() {
        // ğŸš¨ ä¿®æ­£: å€‹åˆ¥ä¿å­˜ã•ã‚ŒãŸãƒ”ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·
        // localStorageå†…ã®å€‹åˆ¥ãƒ”ãƒ³ãƒ‡ãƒ¼ã‚¿ï¼ˆuser-pin-*, autopin-*ï¼‰ã‚’ãƒãƒ¼ã‚¸ã—ã¦ã‹ã‚‰ä¿å­˜
        this.mergeAndSaveActivePins();
        
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ã®ä¿å­˜
        const performanceMetrics = this.configManager.getPerformanceMetrics();
        this.persistenceManager.savePerformanceMetrics(performanceMetrics);
    }
    
    /**
     * å€‹åˆ¥ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸ã—ã¦ã‹ã‚‰çµ±åˆä¿å­˜
     */
    mergeAndSaveActivePins() {
        // ç¾åœ¨ã®activePinsã¨å€‹åˆ¥ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸
        const mergedPins = new Map(this.activePins);
        
        // localStorageå†…ã®autopin-*å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªãƒ»ãƒãƒ¼ã‚¸
        const keys = Object.keys(localStorage);
        const autoPinKeys = keys.filter(key => key.startsWith('autopin-') && key !== 'autopin-active-pins' && key !== 'autopin-performance-metrics');
        
        for (const key of autoPinKeys) {
            try {
                const nodeId = key.replace('autopin-', '');
                const data = localStorage.getItem(key);
                
                if (data) {
                    const pinConfig = JSON.parse(data);
                    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆ
                    const existingPin = mergedPins.get(nodeId);
                    
                    if (!existingPin || !existingPin.timestamp || pinConfig.timestamp > existingPin.timestamp) {
                        // ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¦æ­£ã—ã„å½¢å¼ã«å¤‰æ›
                        const deserializedPin = this.persistenceManager.deserializePinConfig(pinConfig);
                        if (deserializedPin) {
                            mergedPins.set(nodeId, deserializedPin);
                            console.log(`ğŸ”„ æ–°ã—ã„ãƒ”ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸: ${nodeId}`, pinConfig);
                        }
                    }
                }
            } catch (error) {
                console.warn(`âš ï¸ ãƒ”ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸å¤±æ•— (${key}):`, error.message);
            }
        }
        
        // ãƒãƒ¼ã‚¸ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§ä¿å­˜
        console.log('ğŸ’¾ ãƒãƒ¼ã‚¸å¾Œã®çµ±åˆä¿å­˜é–‹å§‹:', mergedPins.size);
        this.persistenceManager.saveActivePins(mergedPins);
    }
    
    /**
     * ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ
     */
    restoreSystemData() {
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ”ãƒ³ã®å¾©å…ƒ
        const pinRestoreResult = this.persistenceManager.restoreActivePins();
        if (pinRestoreResult.success && pinRestoreResult.pins) {
            this.activePins = pinRestoreResult.pins;
        }
        
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ã®å¾©å…ƒ
        const metricsRestoreResult = this.persistenceManager.restorePerformanceMetrics();
        if (metricsRestoreResult.success && metricsRestoreResult.metrics) {
            // ConfigManagerã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ã‚’å¾©å…ƒã•ã‚ŒãŸå€¤ã«æ›´æ–°
            this.configManager.performanceMetrics = metricsRestoreResult.metrics;
        }
        
        console.log('ğŸ’¾ ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå®Œäº†:', {
            activePinsCount: this.activePins.size,
            performanceMetrics: this.configManager.getPerformanceMetrics()
        });
    }
    
    // ==========================================
    // ğŸ¯ UIè¡¨ç¤ºæ©Ÿèƒ½çµ±åˆ
    // ==========================================
    
    /**
     * ã‚¢ãƒ³ã‚«ãƒ¼ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º
     */
    showAnchorPoint(nodeId) {
        return this.pinDisplayManager.showAnchorPoint(nodeId);
    }
    
    /**
     * ã‚¢ãƒ³ã‚«ãƒ¼ãƒã‚¤ãƒ³ãƒˆéè¡¨ç¤º
     */
    hideAnchorPoint(nodeId) {
        return this.pinDisplayManager.hideAnchorPoint(nodeId);
    }
    
    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ”ãƒ³è¡¨ç¤º
     */
    showUserPin(nodeId) {
        return this.pinDisplayManager.showUserPin(nodeId);
    }
    
    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ”ãƒ³éè¡¨ç¤º
     */
    hideUserPin(nodeId) {
        return this.pinDisplayManager.hideUserPin(nodeId);
    }
    
    /**
     * ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«è¡¨ç¤º
     */
    showDragHandle(nodeId, onDragCallback = null) {
        return this.pinDisplayManager.showDragHandle(nodeId, onDragCallback);
    }
    
    /**
     * ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«éè¡¨ç¤º
     */
    hideDragHandle(nodeId) {
        return this.pinDisplayManager.hideDragHandle(nodeId);
    }
    
    // ==========================================
    // ğŸ§¹ ç®¡ç†æ©Ÿèƒ½
    // ==========================================
    
    /**
     * æ—¢å­˜ãƒ”ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
     */
    cleanupExistingPin(nodeId) {
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ”ãƒ³ã‹ã‚‰å‰Šé™¤
        if (this.activePins.has(nodeId)) {
            this.activePins.delete(nodeId);
            console.log('ğŸ—‘ï¸ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ”ãƒ³å‰Šé™¤:', nodeId);
        }
        
        // UIè¦ç´ ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        this.pinDisplayManager.hideAllMarkers(nodeId);
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã‚‚å‰Šé™¤
        const storageKey = `autopin-${nodeId}`;
        localStorage.removeItem(storageKey);
    }
    
    /**
     * çŠ¶æ…‹å–å¾—
     * ğŸ¯ Phase 1: åº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†çŠ¶æ…‹ã‚‚è¿½åŠ 
     */
    getState() {
        return {
            activePinsCount: this.activePins.size,
            activePins: Array.from(this.activePins.keys()),
            performanceMetrics: this.configManager.getPerformanceMetrics(),
            config: this.configManager.getConfig(),
            // ğŸ¯ Phase 1: åº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†çŠ¶æ…‹
            coordinateSystem: {
                pinSyncEnabled: this.pinSyncEnabled,
                originalSpineSettingsCount: this.originalSpineSettings ? Object.keys(this.originalSpineSettings).length : 0,
                activeCanvases: this.originalSpineSettings ? Object.keys(this.originalSpineSettings) : [],
                mode: this.pinSyncEnabled ? 'AutoPinåº§æ¨™ç³»' : 'Originalåº§æ¨™ç³»'
            },
            modules: {
                configManager: this.configManager.getDebugInfo(),
                backgroundDetector: this.backgroundDetector?.getDebugInfo?.() || 'No debug info',
                anchorCalculator: this.anchorCalculator.getDebugInfo(),
                persistenceManager: this.persistenceManager.getDebugInfo(),
                pinDisplayManager: this.pinDisplayManager.getDebugInfo()
            }
        };
    }
    
    /**
     * å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
     * ğŸ¯ Phase 1: åº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚‚è¿½åŠ 
     */
    cleanup() {
        console.log('ğŸ§¹ [Phase 1] AutoPinå®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹ (v2.0)');
        
        // ğŸ¯ Phase 1: å…¨ã¦ã®Spineã‚­ãƒ£ãƒ³ãƒã‚¹ã§ãƒ”ãƒ³è¿½å¾“ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
        if (this.originalSpineSettings) {
            for (const canvasId of Object.keys(this.originalSpineSettings)) {
                const spineCanvas = document.getElementById(canvasId);
                if (spineCanvas) {
                    this.endPinFollowingMode(spineCanvas);
                }
            }
            this.originalSpineSettings = null;
        }
        
        // å…¨ã¦ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ”ãƒ³ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        for (const [nodeId, pinConfig] of this.activePins) {
            this.cleanupExistingPin(nodeId);
        }
        
        // å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        this.pinDisplayManager.cleanup();
        this.persistenceManager.clearAllPinData();
        this.configManager.reset();
        
        // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        this.cleanupResponsiveSystem();
        
        // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
        this.activePins.clear();
        this.pinSyncEnabled = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ
        
        console.log('âœ… [Phase 1] AutoPinå®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº† (v2.0 + åº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†)');
    }
    
    // ==========================================
    // ğŸ”§ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ¡ã‚½ãƒƒãƒ‰
    // ==========================================
    
    /**
     * è¦ç´ æƒ…å ±å–å¾—
     */
    getElementInfo(element) {
        if (!element) return 'null';
        
        return {
            tagName: element.tagName,
            id: element.id || '(no id)',
            className: element.className || '(no class)',
            size: `${element.offsetWidth}Ã—${element.offsetHeight}`
        };
    }
    
    // ==========================================
    // ğŸ¯ ãƒ¬ã‚¬ã‚·ãƒ¼äº’æ›æ€§ãƒ¡ã‚½ãƒƒãƒ‰
    // ==========================================
    
    /**
     * å¾“æ¥ã®restoreActivePinäº’æ›ãƒ¡ã‚½ãƒƒãƒ‰
     */
    restoreActivePins() {
        return this.restoreSystemData();
    }
    
    /**
     * å¾“æ¥ã®saveActivePinsäº’æ›ãƒ¡ã‚½ãƒƒãƒ‰
     */
    saveActivePins() {
        return this.saveSystemData();
    }
    
    /**
     * å¾“æ¥ã®performanceMetricsäº’æ›ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
     */
    get performanceMetrics() {
        return this.configManager.getPerformanceMetrics();
    }
    
    set performanceMetrics(value) {
        console.warn('âš ï¸ performanceMetricsã®ç›´æ¥è¨­å®šã¯éæ¨å¥¨ã§ã™ã€‚configManager.updatePerformanceMetrics()ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„');
    }
    
    /**
     * å¾“æ¥ã®updatePerformanceMetricsäº’æ›ãƒ¡ã‚½ãƒƒãƒ‰
     */
    updatePerformanceMetrics(processingTime, success) {
        return this.configManager.updatePerformanceMetrics(processingTime, success);
    }
    
    // ==========================================
    // ğŸ”„ ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¿½å¾“ã‚·ã‚¹ãƒ†ãƒ 
    // ==========================================
    
    /**
     * ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¿½å¾“ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
     */
    initializeResponsiveSystem() {
        console.log('ğŸ”„ ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¿½å¾“ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
        
        // 1. ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®ãƒ”ãƒ³ä½ç½®æ›´æ–°
        this.setupWindowResizeHandler();
        
        // 2. è¦ç´ å¤‰æ›´ç›£è¦–ï¼ˆMutationObserverï¼‰
        this.setupElementObserver();
        
        console.log('âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¿½å¾“ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
    }
    
    /**
     * ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®è¨­å®š
     */
    setupWindowResizeHandler() {
        let resizeTimeout;
        
        const handleResize = () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                console.log('ğŸ”„ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ¤œå‡º â†’ ãƒ”ãƒ³ä½ç½®æ›´æ–°é–‹å§‹');
                this.updateAllPinPositions();
            }, 150); // 150msã®é…å»¶ã§ãƒªã‚µã‚¤ã‚ºå®Œäº†ã‚’å¾…ã¤
        };
        
        window.addEventListener('resize', handleResize);
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        let scrollTimeout;
        const handleScroll = () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                console.log('ğŸ”„ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ¤œå‡º â†’ ãƒ”ãƒ³ä½ç½®æ›´æ–°é–‹å§‹');
                this.updateAllPinPositions();
            }, 50); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯50msã®é…å»¶ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–æ€§é‡è¦–ï¼‰
        };
        
        window.addEventListener('scroll', handleScroll, { passive: true });
        
        // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç ´æ£„ç”¨ã®å‚ç…§ä¿æŒ
        this._resizeHandler = handleResize;
        this._scrollHandler = handleScroll;
        
        console.log('âœ… ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­å®šå®Œäº†');
    }
    
    /**
     * è¦ç´ å¤‰æ›´ç›£è¦–ã®è¨­å®š
     */
    setupElementObserver() {
        if (!window.MutationObserver) {
            console.warn('âš ï¸ MutationObserver ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
            return;
        }
        
        this.mutationObserver = new MutationObserver((mutations) => {
            let shouldUpdate = false;
            
            mutations.forEach((mutation) => {
                // ğŸš¨ ãƒ«ãƒ¼ãƒ—é˜²æ­¢: Spineã‚­ãƒ£ãƒ³ãƒã‚¹è¦ç´ ã®å¤‰æ›´ã¯ç„¡è¦–
                const target = mutation.target;
                if (target.tagName === 'CANVAS' || 
                    target.id === 'spine-canvas' || 
                    target.id?.startsWith('spine-') ||
                    target.classList?.contains('spine-canvas')) {
                    return; // Spineã‚­ãƒ£ãƒ³ãƒã‚¹é–¢é€£ã®å¤‰æ›´ã¯ç„¡è¦–
                }
                
                // å±æ€§å¤‰æ›´ã®ç›£è¦–ï¼ˆstyle, class ã®å¤‰æ›´ï¼‰
                if (mutation.type === 'attributes' && 
                   (mutation.attributeName === 'style' || mutation.attributeName === 'class')) {
                    shouldUpdate = true;
                }
            });
            
            if (shouldUpdate) {
                console.log('ğŸ”„ è¦ç´ å¤‰æ›´æ¤œå‡º â†’ ãƒ”ãƒ³ä½ç½®æ›´æ–°');
                this.updateAllPinPositions();
            }
        });
        
        // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…¨ä½“ã‚’ç›£è¦–ï¼ˆå±æ€§å¤‰æ›´ã®ã¿ï¼‰
        this.mutationObserver.observe(document.body, {
            attributes: true,
            attributeFilter: ['style', 'class'],
            subtree: true
        });
        
        console.log('âœ… è¦ç´ å¤‰æ›´ç›£è¦–è¨­å®šå®Œäº†');
    }
    
    /**
     * å…¨ã¦ã®ãƒ”ãƒ³ä½ç½®ã‚’æ›´æ–°
     */
    updateAllPinPositions() {
        try {
            console.log('ğŸ”„ å…¨ãƒ”ãƒ³ä½ç½®æ›´æ–°é–‹å§‹');
            
            // PinDisplayManagerã®ä½ç½®æ›´æ–°ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—
            if (this.pinDisplayManager && typeof this.pinDisplayManager.updateAllMarkerPositions === 'function') {
                this.pinDisplayManager.updateAllMarkerPositions();
                console.log('âœ… PinDisplayManagerä½ç½®æ›´æ–°å®Œäº†');
            } else {
                console.warn('âš ï¸ PinDisplayManager.updateAllMarkerPositions ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
            }
            
            // ğŸ¯ è¿½åŠ : ãƒ”ãƒ³ä½ç½®å¤‰æ›´ã«åˆã‚ã›ã¦Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®ã‚‚åŒæœŸæ›´æ–°
            this.syncSpineCharactersToUpdatedPins();
            
        } catch (error) {
            console.error('âŒ ãƒ”ãƒ³ä½ç½®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error.message);
        }
    }
    
    /**
     * ãƒ”ãƒ³ä½ç½®å¤‰æ›´ã«åˆã‚ã›ã¦Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®ã‚’åŒæœŸæ›´æ–°
     * ğŸ¯ Phase 1: åº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ¯ãƒƒãƒ—ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
     */
    syncSpineCharactersToUpdatedPins() {
        try {
            // ğŸš¨ BBç·¨é›†ä¸­ã¯ãƒ”ãƒ³è¿½å¾“ç„¡åŠ¹åŒ–
            if (!this.pinSyncEnabled) {
                console.log('ğŸš« BBç·¨é›†ä¸­ã®ãŸã‚Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åŒæœŸã‚¹ã‚­ãƒƒãƒ—');
                return;
            }
            
            console.log('ğŸ¯ [Phase 1] Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®åŒæœŸé–‹å§‹ï¼ˆåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ¯ãƒƒãƒ—ç‰ˆï¼‰');
            
            // ğŸš¨ ãƒ«ãƒ¼ãƒ—é˜²æ­¢: ä¸€æ™‚çš„ã«MutationObserveråœæ­¢
            if (this.mutationObserver) {
                this.mutationObserver.disconnect();
            }
            
            // çµ±åˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å…¨ãƒ”ãƒ³æƒ…å ±ã‚’å–å¾—
            const activeData = localStorage.getItem('autopin-active-pins');
            if (!activeData) {
                console.log('ğŸ“ çµ±åˆãƒ‡ãƒ¼ã‚¿ãªã— - Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åŒæœŸã‚¹ã‚­ãƒƒãƒ—');
                // MutationObserverå†é–‹
                this.reconnectMutationObserver();
                return;
            }
            
            const parsed = JSON.parse(activeData);
            const pins = parsed.pins || {};
            
            for (const [nodeId, pinData] of Object.entries(pins)) {
                // å¯¾è±¡ã®Spineã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ç‰¹å®š
                const spineCanvas = document.getElementById(pinData.spineElement || 'spine-canvas');
                if (!spineCanvas) {
                    console.warn(`âš ï¸ Spineã‚­ãƒ£ãƒ³ãƒã‚¹æœªç™ºè¦‹ (${pinData.spineElement})`);
                    continue;
                }
                
                // ğŸ¯ Phase 1: ãƒ”ãƒ³è¿½å¾“é–‹å§‹æ™‚ã®åº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ¯ãƒƒãƒ—
                this.startPinFollowingMode(spineCanvas);
                
                // èƒŒæ™¯è¦ç´ ï¼ˆãƒ”ãƒ³ã®è¦ªè¦ç´ ï¼‰ã‚’å–å¾—
                const backgroundElement = this.findBackgroundElement(pinData.backgroundElement);
                if (!backgroundElement) {
                    console.warn(`âš ï¸ èƒŒæ™¯è¦ç´ æœªç™ºè¦‹ (${nodeId})`);
                    continue;
                }
                
                // èƒŒæ™¯è¦ç´ ã‹ã‚‰ã‚¢ãƒ³ã‚«ãƒ¼ä½ç½®ã‚’è¨ˆç®—
                const rect = backgroundElement.getBoundingClientRect();
                const anchorRatios = this.getAnchorRatios(pinData.anchor);
                
                // ãƒ”ãƒ³ä½ç½®ï¼ˆçµ¶å¯¾åº§æ¨™ï¼‰
                const pinX = rect.left + (rect.width * anchorRatios.x);
                const pinY = rect.top + (rect.height * anchorRatios.y);
                
                // ğŸ¯ AutoPinå°‚ç”¨åº§æ¨™ç³»ã§ã®ã¿ä½ç½®æ›´æ–°
                this.applyPinFollowingPosition(spineCanvas, pinX, pinY);
                
                console.log(`ğŸ¯ [Phase 1] Spineãƒ”ãƒ³è¿½å¾“: ${nodeId} â†’ (${pinX.toFixed(1)}, ${pinY.toFixed(1)})`);
            }
            
            console.log('âœ… [Phase 1] Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®åŒæœŸå®Œäº†ï¼ˆåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ¯ãƒƒãƒ—ä¿è­·æ¸ˆã¿ï¼‰');
            
            // ğŸš¨ ãƒ«ãƒ¼ãƒ—é˜²æ­¢: MutationObserverå†é–‹
            setTimeout(() => {
                this.reconnectMutationObserver();
            }, 100); // 100mså¾Œã«å†é–‹ï¼ˆå®‰å…¨ãƒãƒ¼ã‚¸ãƒ³ï¼‰
            
        } catch (error) {
            console.error('âŒ [Phase 1] Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åŒæœŸã‚¨ãƒ©ãƒ¼:', error.message);
            // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚MutationObserverå†é–‹
            this.reconnectMutationObserver();
        }
    }
    
    // ==========================================
    // ğŸ¯ Phase 1: åº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ¯ãƒƒãƒ—ã‚·ã‚¹ãƒ†ãƒ 
    // ==========================================
    
    /**
     * ğŸ¯ Phase 1: ãƒ”ãƒ³è¿½å¾“ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼ˆåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ¯ãƒƒãƒ—ï¼‰
     * BBã®åº§æ¨™ç¶™æ‰¿æ–¹å¼ã‚’å‚è€ƒã«ã—ãŸå®Ÿè£…
     */
    startPinFollowingMode(spineCanvas) {
        const canvasId = spineCanvas.id || 'spine-canvas';
        
        // æ—¢ã«ãƒ”ãƒ³è¿½å¾“ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (this.originalSpineSettings && this.originalSpineSettings[canvasId]) {
            console.log(`ğŸ¯ [Phase 1] æ—¢ã«ãƒ”ãƒ³è¿½å¾“ãƒ¢ãƒ¼ãƒ‰ä¸­: ${canvasId}`);
            return;
        }
        
        console.log(`ğŸ¯ [Phase 1] ãƒ”ãƒ³è¿½å¾“ãƒ¢ãƒ¼ãƒ‰é–‹å§‹: ${canvasId}`);
        
        // ğŸ¯ Step 1: ç¾åœ¨è¨­å®šã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆBBã®getBoundingClientRectæ–¹å¼å‚è€ƒï¼‰
        const currentRect = spineCanvas.getBoundingClientRect();
        const computedStyle = window.getComputedStyle(spineCanvas);
        
        // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ã§å„Canvasåˆ¥ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ç®¡ç†
        if (!this.originalSpineSettings) {
            this.originalSpineSettings = {};
        }
        
        this.originalSpineSettings[canvasId] = {
            // ğŸ¯ åº§æ¨™ç¶™æ‰¿ç”¨ã®ç¾åœ¨ä½ç½®è¨˜éŒ²ï¼ˆBBã®ä½ç½®ç¶™æ‰¿æ–¹å¼ï¼‰
            inheritedPosition: {
                left: currentRect.left,
                top: currentRect.top,
                width: currentRect.width,
                height: currentRect.height
            },
            // CSSè¨­å®šã®å®Œå…¨ä¿è­·
            css: {
                position: spineCanvas.style.position || computedStyle.position,
                left: spineCanvas.style.left || computedStyle.left,
                top: spineCanvas.style.top || computedStyle.top,
                transform: spineCanvas.style.transform || computedStyle.transform,
                width: spineCanvas.style.width || computedStyle.width,
                height: spineCanvas.style.height || computedStyle.height,
                zIndex: spineCanvas.style.zIndex || computedStyle.zIndex
            },
            // StableSpineRendererè¨­å®šã®ä¿è­·
            renderer: this.createRendererBackup()
        };
        
        // ğŸ¯ Step 2: AutoPinå°‚ç”¨åº§æ¨™ç³»ã«åˆ‡ã‚Šæ›¿ãˆ
        this.switchToAutoPinCoordinateSystem(spineCanvas);
        
        console.log(`âœ… [Phase 1] ãƒ”ãƒ³è¿½å¾“ãƒ¢ãƒ¼ãƒ‰é–‹å§‹å®Œäº†: ${canvasId}`, {
            backup: this.originalSpineSettings[canvasId],
            currentMode: 'AutoPinå°‚ç”¨åº§æ¨™ç³»'
        });
    }
    
    /**
     * ğŸ¯ Phase 1: AutoPinå°‚ç”¨åº§æ¨™ç³»ã«åˆ‡ã‚Šæ›¿ãˆ
     */
    switchToAutoPinCoordinateSystem(spineCanvas) {
        // AutoPinå°‚ç”¨åº§æ¨™ç³»é©ç”¨ï¼ˆè¨­è¨ˆãƒ¡ãƒ¢ã®Phase 1ä»•æ§˜ã«å¾“ã†ï¼‰
        spineCanvas.style.position = 'fixed';
        spineCanvas.style.transform = 'none';  // ä»–ã‚·ã‚¹ãƒ†ãƒ å½±éŸ¿æ–­ã¡åˆ‡ã‚Š
        
        // é‡è¦: width/height/zIndexã¯å¤‰æ›´ã—ãªã„ï¼ˆç«¶åˆå›é¿ï¼‰
        console.log(`ğŸ¯ [Phase 1] AutoPinå°‚ç”¨åº§æ¨™ç³»é©ç”¨å®Œäº†: ${spineCanvas.id}`);
    }
    
    /**
     * ğŸ¯ Phase 1: AutoPinå°‚ç”¨åº§æ¨™ç³»ã§ã®ã¿ä½ç½®æ›´æ–°
     */
    applyPinFollowingPosition(spineCanvas, pinX, pinY) {
        // AutoPinå°‚ç”¨åº§æ¨™ç³»ã§ã®ã¿ä½ç½®è¨­å®š
        spineCanvas.style.left = `${pinX}px`;
        spineCanvas.style.top = `${pinY}px`;
        
        console.log(`ğŸ¯ [Phase 1] AutoPinåº§æ¨™æ›´æ–°: ${spineCanvas.id} â†’ (${pinX}, ${pinY})`);
    }
    
    /**
     * ğŸ¯ Phase 1: ãƒ”ãƒ³è¿½å¾“ãƒ¢ãƒ¼ãƒ‰çµ‚äº†ï¼ˆå®Œå…¨å¾©å…ƒï¼‰
     */
    endPinFollowingMode(spineCanvas) {
        const canvasId = spineCanvas.id || 'spine-canvas';
        
        if (!this.originalSpineSettings || !this.originalSpineSettings[canvasId]) {
            console.warn(`âš ï¸ [Phase 1] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®šãªã—: ${canvasId}`);
            return;
        }
        
        console.log(`ğŸ¯ [Phase 1] ãƒ”ãƒ³è¿½å¾“ãƒ¢ãƒ¼ãƒ‰çµ‚äº†: ${canvasId}`);
        
        const backup = this.originalSpineSettings[canvasId];
        
        // ğŸ¯ å®Œå…¨å¾©å…ƒï¼ˆBBã®Object.assignæ–¹å¼ï¼‰
        Object.assign(spineCanvas.style, backup.css);
        
        // StableSpineRendererè¨­å®šã®å¾©å…ƒ
        if (backup.renderer) {
            this.restoreRendererSettings(backup.renderer);
        }
        
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
        delete this.originalSpineSettings[canvasId];
        
        console.log(`âœ… [Phase 1] ãƒ”ãƒ³è¿½å¾“ãƒ¢ãƒ¼ãƒ‰çµ‚äº†å®Œäº†: ${canvasId}`);
    }
    
    /**
     * StableSpineRendererè¨­å®šã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
     */
    createRendererBackup() {
        if (window.spineRenderer && window.spineRenderer.skeleton) {
            return {
                scaleX: window.spineRenderer.skeleton.scaleX,
                scaleY: window.spineRenderer.skeleton.scaleY,
                x: window.spineRenderer.skeleton.x,
                y: window.spineRenderer.skeleton.y
            };
        }
        return null;
    }
    
    /**
     * StableSpineRendererè¨­å®šã®å¾©å…ƒ
     */
    restoreRendererSettings(rendererBackup) {
        if (rendererBackup && window.spineRenderer && window.spineRenderer.skeleton) {
            window.spineRenderer.skeleton.scaleX = rendererBackup.scaleX;
            window.spineRenderer.skeleton.scaleY = rendererBackup.scaleY;
            // ä½ç½®ã¯æ›´æ–°ã—ãªã„ï¼ˆãƒ”ãƒ³è¿½å¾“ã®ãŸã‚ï¼‰
            // window.spineRenderer.skeleton.x = rendererBackup.x;
            // window.spineRenderer.skeleton.y = rendererBackup.y;
            
            console.log('ğŸ›¡ï¸ [Phase 1] StableSpineRendererè¨­å®šå¾©å…ƒå®Œäº†');
        }
    }
    
    /**
     * ğŸš¨ ãƒ¬ã‚¬ã‚·ãƒ¼äº’æ›: Phase 1ç·Šæ€¥ä¿®æ­£ç”¨ã®æ—¢å­˜ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆéæ¨å¥¨ï¼‰
     */
    createSpineSettingsBackup(spineCanvas) {
        // ãƒ¬ã‚¬ã‚·ãƒ¼äº’æ›æ€§ã®ãŸã‚æ®‹ã™ãŒã€æ–°ã—ã„startPinFollowingMode()ä½¿ç”¨ã‚’æ¨å¥¨
        console.warn('âš ï¸ createSpineSettingsBackup()ã¯éæ¨å¥¨ã§ã™ã€‚startPinFollowingMode()ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„');
        
        const backup = {
            // CSSè¨­å®šã®å®Œå…¨ä¿è­·
            css: {
                width: spineCanvas.style.width,
                height: spineCanvas.style.height,
                transform: spineCanvas.style.transform,
                zIndex: spineCanvas.style.zIndex
            },
            // StableSpineRendererè¨­å®šã®ä¿è­·
            renderer: this.createRendererBackup()
        };
        
        return backup;
    }
    
    /**
     * ğŸš¨ ãƒ¬ã‚¬ã‚·ãƒ¼äº’æ›: Phase 1ç·Šæ€¥ä¿®æ­£ç”¨ã®æ—¢å­˜ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆéæ¨å¥¨ï¼‰
     */
    restoreSpineSettings(spineCanvas, backup) {
        // ãƒ¬ã‚¬ã‚·ãƒ¼äº’æ›æ€§ã®ãŸã‚æ®‹ã™ãŒã€æ–°ã—ã„endPinFollowingMode()ä½¿ç”¨ã‚’æ¨å¥¨
        console.warn('âš ï¸ restoreSpineSettings()ã¯éæ¨å¥¨ã§ã™ã€‚endPinFollowingMode()ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„');
        
        if (!backup) return;
        
        // CSSè¨­å®šã®å¾©å…ƒï¼ˆä½ç½®ä»¥å¤–ï¼‰
        const css = backup.css;
        if (css.width !== undefined && css.width !== '') {
            spineCanvas.style.width = css.width;
        }
        if (css.height !== undefined && css.height !== '') {
            spineCanvas.style.height = css.height;
        }
        if (css.transform !== undefined && css.transform !== '') {
            spineCanvas.style.transform = css.transform;
        }
        if (css.zIndex !== undefined && css.zIndex !== '') {
            spineCanvas.style.zIndex = css.zIndex;
        }
        
        // StableSpineRendererè¨­å®šã®å¾©å…ƒ
        this.restoreRendererSettings(backup.renderer);
    }
    
    /**
     * MutationObserverå†é–‹
     */
    reconnectMutationObserver() {
        if (this.mutationObserver && document.body) {
            try {
                this.mutationObserver.observe(document.body, {
                    attributes: true,
                    attributeFilter: ['style', 'class'],
                    subtree: true
                });
                console.log('ğŸ”„ MutationObserverå†é–‹');
            } catch (error) {
                console.warn('âš ï¸ MutationObserverå†é–‹å¤±æ•—:', error.message);
            }
        }
    }
    
    /**
     * èƒŒæ™¯è¦ç´ ã‚’æ¤œç´¢ãƒ»å¾©å…ƒï¼ˆPinDisplayManageräº’æ›ï¼‰
     */
    findBackgroundElement(backgroundElementInfo) {
        if (!backgroundElementInfo) return null;
        
        // IDå„ªå…ˆã§æ¤œç´¢
        if (backgroundElementInfo.id) {
            const element = document.getElementById(backgroundElementInfo.id);
            if (element) return element;
        }
        
        // ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–‡å­—åˆ—ã§æ¤œç´¢
        if (backgroundElementInfo.selector) {
            const element = document.querySelector(backgroundElementInfo.selector);
            if (element) return element;
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ’ãƒ¼ãƒ­ãƒ¼ç”»åƒè¦ç´ ã‚’æ¤œç´¢
        const heroSelectors = ['.hero-section', '.hero-image', '[class*="hero"]'];
        for (const selector of heroSelectors) {
            const element = document.querySelector(selector);
            if (element) return element;
        }
        
        return null;
    }
    
    /**
     * ã‚¢ãƒ³ã‚«ãƒ¼æ¯”ç‡å–å¾—ï¼ˆPinDisplayManageräº’æ›ï¼‰
     */
    getAnchorRatios(anchor) {
        const anchorMap = {
            'TL': { x: 0, y: 0 },     'TC': { x: 0.5, y: 0 },   'TR': { x: 1, y: 0 },
            'ML': { x: 0, y: 0.5 },   'MC': { x: 0.5, y: 0.5 }, 'MR': { x: 1, y: 0.5 },
            'BL': { x: 0, y: 1 },     'BC': { x: 0.5, y: 1 },   'BR': { x: 1, y: 1 }
        };
        return anchorMap[anchor] || { x: 0.5, y: 0.5 };
    }
    
    // ==========================================
    // ğŸ¯ ãƒ”ãƒ³è¿½å¾“åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ 
    // ==========================================
    
    /**
     * ãƒ”ãƒ³è¿½å¾“æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–ï¼ˆBBç·¨é›†ä¸­ï¼‰
     * ğŸ¯ Phase 1: ãƒ”ãƒ³è¿½å¾“ãƒ¢ãƒ¼ãƒ‰çµ‚äº†ã‚‚å®Ÿè¡Œ
     */
    disablePinSync() {
        this.pinSyncEnabled = false;
        
        // ğŸ¯ Phase 1: å…¨ã¦ã®Spineã‚­ãƒ£ãƒ³ãƒã‚¹ã§ãƒ”ãƒ³è¿½å¾“ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
        if (this.originalSpineSettings) {
            for (const canvasId of Object.keys(this.originalSpineSettings)) {
                const spineCanvas = document.getElementById(canvasId);
                if (spineCanvas) {
                    this.endPinFollowingMode(spineCanvas);
                }
            }
        }
        
        console.log('ğŸš« [Phase 1] ãƒ”ãƒ³è¿½å¾“æ©Ÿèƒ½ç„¡åŠ¹åŒ–ï¼ˆBBç·¨é›†ä¸­ãƒ»åº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼å¾©å…ƒæ¸ˆã¿ï¼‰');
    }
    
    /**
     * ãƒ”ãƒ³è¿½å¾“æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ï¼ˆBBç·¨é›†å®Œäº†æ™‚ï¼‰
     * ğŸ¯ Phase 1: ãƒ”ãƒ³è¿½å¾“ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ã‚‚å®Ÿè¡Œ
     */
    enablePinSync() {
        this.pinSyncEnabled = true;
        console.log('âœ… [Phase 1] ãƒ”ãƒ³è¿½å¾“æ©Ÿèƒ½æœ‰åŠ¹åŒ–ï¼ˆBBç·¨é›†å®Œäº†ï¼‰');
        
        // æœ‰åŠ¹åŒ–å¾Œã€å³åº§ã«ä½ç½®åŒæœŸã‚’å®Ÿè¡Œï¼ˆæ–°ã‚·ã‚¹ãƒ†ãƒ ã§ãƒ”ãƒ³è¿½å¾“ãƒ¢ãƒ¼ãƒ‰ã‚‚é–‹å§‹ï¼‰
        this.updateAllPinPositions();
    }
    
    /**
     * BBç·¨é›†ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–ã®è¨­å®š
     */
    setupBoundingBoxEventListeners() {
        // BBé¸æŠæ™‚ï¼ˆç·¨é›†é–‹å§‹ï¼‰
        document.addEventListener('boundingBoxSelected', (event) => {
            console.log('ğŸ¯ BBé¸æŠæ¤œå‡º â†’ ãƒ”ãƒ³è¿½å¾“ç„¡åŠ¹åŒ–', event.detail);
            this.disablePinSync();
        });
        
        // BBé¸æŠè§£é™¤æ™‚ï¼ˆç·¨é›†å®Œäº†ãƒ»ä¿å­˜ï¼‰
        document.addEventListener('boundingBoxDeselected', (event) => {
            console.log('ğŸ¯ BBé¸æŠè§£é™¤æ¤œå‡º â†’ ãƒ”ãƒ³è¿½å¾“æœ‰åŠ¹åŒ–', event.detail);
            this.enablePinSync();
        });
        
        console.log('âœ… BBç·¨é›†ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–è¨­å®šå®Œäº†');
    }
    
    /**
     * ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
     */
    cleanupResponsiveSystem() {
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å‰Šé™¤
        if (this._resizeHandler) {
            window.removeEventListener('resize', this._resizeHandler);
            this._resizeHandler = null;
        }
        
        if (this._scrollHandler) {
            window.removeEventListener('scroll', this._scrollHandler);
            this._scrollHandler = null;
        }
        
        // MutationObserverã‚’åœæ­¢
        if (this.mutationObserver) {
            this.mutationObserver.disconnect();
            this.mutationObserver = null;
        }
        
        console.log('âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚·ã‚¹ãƒ†ãƒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
    }
}

// ãƒ•ã‚©ãƒ«ãƒ€å†…å®Œçµ: ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
if (typeof window !== 'undefined') {
    window.PureBoundingBoxAutoPin = PureBoundingBoxAutoPin;
}