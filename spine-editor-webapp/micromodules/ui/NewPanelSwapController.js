/**
 * NewPanelSwapController.js - Êñ∞„Åó„ÅÑ„Éë„Éç„É´ÂÖ•„ÇåÊõø„Åà„Ç∑„Çπ„ÉÜ„É†
 * 
 * üéØ ‰ªïÊßòÊõ∏Ê∫ñÊã†„ÅÆÊ≠£„Åó„ÅÑ„Éë„Éç„É´ÂÖ•„ÇåÊõø„ÅàÊ©üËÉΩ
 * - 4„Å§„ÅÆ„Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢Ôºà‰∏ä‰∏ãÂ∑¶Âè≥„ÅÆËæ∫ + ‰∏≠Â§Æ„ÅÆÈù¢Ôºâ
 * - Á©∫ÁôΩ„Çº„É≠ÂéüÂâáÔºàËá™ÂãïÊã°Âºµ„Å´„Çà„ÇãÁ©∫ÈñìÂüã„ÇÅÔºâ
 * - Èö£Êé•„ÉÅ„Çß„ÉÉ„ÇØÔºàÈö£„ÇäÂêà„ÅÜ„Ç®„É™„Ç¢„ÅØÁÑ°ÂäπÔºâ
 * - Áõ¥ÊÑüÁöÑÈÖçÁΩÆÔºà„Éâ„É≠„ÉÉ„Éó„Åó„Åü‰ΩçÁΩÆ„Å´„Åù„ÅÆ„Åæ„ÅæÈÖçÁΩÆÔºâ
 */
export class NewPanelSwapController {
    constructor(panelManager, layoutManager = null) {
        console.log('üö® NewPanelSwapController 2024-09-11 14:40 ÊúÄÊñ∞Áâà„É≠„Éº„ÉâÁ¢∫Ë™ç');
        this.panelManager = panelManager;
        this.layoutManager = layoutManager;
        this.isDragging = false;
        this.draggedPanel = null;
        this.state = 'initializing';
        
        // „Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢Ë®≠ÂÆö
        this.dropAreaConfig = {
            edgeThreshold: 0.2,      // Ëæ∫„Ç®„É™„Ç¢„ÅÆÂπÖÔºà„Éë„Éç„É´„ÅÆ20%Ôºâ
            centerThreshold: 0.6,    // Èù¢„Ç®„É™„Ç¢„ÅÆÂπÖÔºà„Éë„Éç„É´„ÅÆ60%Ôºâ
            highlightOpacity: 0.8,   // „Éè„Ç§„É©„Ç§„ÉàÈÄèÊòéÂ∫¶
            animationDuration: 200,  // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÊôÇÈñì
            borderZoneWidth: 8,      // Â¢ÉÁïåÁ∑ö„Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÅÆÂπÖ
            borderTolerance: 4       // Â¢ÉÁïåÁ∑öÊ§úÂá∫„ÅÆË®±ÂÆπÁØÑÂõ≤
        };
        
        // „Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢Áä∂ÊÖã
        this.dropAreas = {
            current: null,      // ÁèæÂú®„ÅÆ„Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢
            available: [],      // Âà©Áî®ÂèØËÉΩ„Å™„Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢
            highlights: [],     // „Éè„Ç§„É©„Ç§„ÉàË¶ÅÁ¥†
            borderZones: []     // Â¢ÉÁïåÁ∑ö„Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥
        };
        
        console.log('üéØ NewPanelSwapControllerÂàùÊúüÂåñÈñãÂßã');
    }

    /**
     * üöÄ „Éë„Éç„É´ÂÖ•„ÇåÊõø„Åà„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
     */
    async initialize() {
        console.log('üîß Êñ∞„Åó„ÅÑ„Éë„Éç„É´ÂÖ•„ÇåÊõø„Åà„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ');
        
        try {
            // „Éë„Éç„É´„Å´„Éâ„É©„ÉÉ„Ç∞Ê©üËÉΩ„ÇíËøΩÂä†
            let initializedCount = 0;
            this.panelManager.getAllPanels().forEach(panelId => {
                const panel = this.panelManager.findPanel(panelId);
                if (panel) {
                    const header = panel.element.querySelector('.panel-header');
                    if (header) {
                        this.setupPanelDragEvents(header, panelId);
                        initializedCount++;
                    }
                }
            });
            
            // „Ç∞„É≠„Éº„Éê„É´„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
            this.setupGlobalEventListeners();
            
            // „Éâ„É≠„ÉÉ„Éó„Éè„Ç§„É©„Ç§„ÉàË¶ÅÁ¥†‰ΩúÊàê
            this.createDropHighlights();
            
            this.state = 'ready';
            console.log(`‚úÖ Êñ∞„Åó„ÅÑ„Éë„Éç„É´ÂÖ•„ÇåÊõø„Åà„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü: ${initializedCount}ÂÄã„ÅÆ„Éë„Éç„É´`);
            return initializedCount;
            
        } catch (error) {
            console.error('‚ùå „Éë„Éç„É´ÂÖ•„ÇåÊõø„Åà„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            this.state = 'error';
            return 0;
        }
    }

    /**
     * üñ±Ô∏è „Éë„Éç„É´„Éâ„É©„ÉÉ„Ç∞„Ç§„Éô„É≥„ÉàË®≠ÂÆö
     */
    setupPanelDragEvents(header, panelId) {
        console.log(`üîß „Éâ„É©„ÉÉ„Ç∞„Ç§„Éô„É≥„ÉàË®≠ÂÆö: ${panelId}`, header);
        header.addEventListener('mousedown', (e) => this.startPanelDrag(e, panelId));
        header.style.cursor = 'grab';
        
        // „Éõ„Éê„ÉºÂäπÊûú
        header.addEventListener('mouseenter', () => {
            if (!this.isDragging) {
                header.style.background = '#4a4a4a';
                header.style.transform = 'scale(1.02)';
            }
        });
        
        header.addEventListener('mouseleave', () => {
            if (!this.isDragging) {
                header.style.background = '';
                header.style.transform = '';
            }
        });
    }

    /**
     * üåê „Ç∞„É≠„Éº„Éê„É´„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
     */
    setupGlobalEventListeners() {
        document.addEventListener('mousemove', (e) => this.handlePanelDrag(e));
        document.addEventListener('mouseup', () => this.endPanelDrag());
        
        // ESC„Ç≠„Éº„Åß„Éâ„É©„ÉÉ„Ç∞„Ç≠„É£„É≥„Çª„É´
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.isDragging) {
                this.cancelDrag();
            }
        });
    }

    /**
     * üé® „Éâ„É≠„ÉÉ„Éó„Éè„Ç§„É©„Ç§„ÉàË¶ÅÁ¥†‰ΩúÊàê
     */
    createDropHighlights() {
        // 4„Å§„ÅÆ„Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢Áî®„Éè„Ç§„É©„Ç§„ÉàË¶ÅÁ¥†„Çí‰ΩúÊàê
        const areaTypes = ['top', 'right', 'bottom', 'left', 'center'];
        
        areaTypes.forEach(type => {
            const highlight = document.createElement('div');
            highlight.className = `panel-drop-highlight panel-drop-${type}`;
            highlight.style.cssText = this.getHighlightStyle(type);
            document.body.appendChild(highlight);
            this.dropAreas.highlights.push({ type, element: highlight });
        });
        
        // Â¢ÉÁïåÁ∑ö„Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢Áî®„Éè„Ç§„É©„Ç§„ÉàË¶ÅÁ¥†„Çí‰ΩúÊàê
        const borderTypes = ['border-top', 'border-right', 'border-bottom', 'border-left'];
        
        borderTypes.forEach(type => {
            const highlight = document.createElement('div');
            highlight.className = `panel-drop-highlight panel-drop-${type}`;
            highlight.style.cssText = this.getBorderHighlightStyle(type);
            document.body.appendChild(highlight);
            this.dropAreas.highlights.push({ type, element: highlight });
        });
        
        console.log('üé® „Éâ„É≠„ÉÉ„Éó„Éè„Ç§„É©„Ç§„ÉàË¶ÅÁ¥†‰ΩúÊàêÂÆå‰∫Ü');
    }

    /**
     * üé® Â¢ÉÁïåÁ∑ö„Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„Éè„Ç§„É©„Ç§„Éà‰ΩúÊàê
     */
    createBorderZoneHighlights() {
        const borderTypes = ['horizontal', 'vertical'];
        
        borderTypes.forEach(type => {
            const borderZone = document.createElement('div');
            borderZone.className = `panel-border-zone panel-border-${type}`;
            borderZone.style.cssText = this.getBorderZoneStyle(type);
            document.body.appendChild(borderZone);
            this.dropAreas.borderZones.push({ type, element: borderZone });
        });
        
        console.log('üé® Â¢ÉÁïåÁ∑ö„Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„Éè„Ç§„É©„Ç§„Éà‰ΩúÊàêÂÆå‰∫Ü');
    }

    /**
     * üé® Â¢ÉÁïåÁ∑ö„Çæ„Éº„É≥„Çπ„Çø„Ç§„É´ÂèñÂæó
     */
    getBorderZoneStyle(type) {
        const baseStyle = `
            position: fixed;
            pointer-events: none;
            opacity: 0;
            transition: all ${this.dropAreaConfig.animationDuration}ms ease;
            z-index: 1700;
            border-radius: 2px;
        `;
        
        const typeStyles = {
            'horizontal': `
                background: linear-gradient(90deg, 
                    rgba(0, 122, 204, 0.2) 0%, 
                    rgba(0, 122, 204, 0.6) 50%, 
                    rgba(0, 122, 204, 0.2) 100%);
                border: 1px solid #007acc;
                box-shadow: 0 0 8px rgba(0, 122, 204, 0.4);
                animation: borderPulse 1.5s ease-in-out infinite;
            `,
            'vertical': `
                background: linear-gradient(180deg, 
                    rgba(0, 122, 204, 0.2) 0%, 
                    rgba(0, 122, 204, 0.6) 50%, 
                    rgba(0, 122, 204, 0.2) 100%);
                border: 1px solid #007acc;
                box-shadow: 0 0 8px rgba(0, 122, 204, 0.4);
                animation: borderPulse 1.5s ease-in-out infinite;
            `
        };
        
        return baseStyle + typeStyles[type];
    }

    /**
     * üé® „Éè„Ç§„É©„Ç§„Éà„Çπ„Çø„Ç§„É´ÂèñÂæó
     */
    getHighlightStyle(type) {
        const baseStyle = `
            position: fixed;
            pointer-events: none;
            opacity: 0;
            transition: all ${this.dropAreaConfig.animationDuration}ms ease;
            z-index: 1600;
            border-radius: 4px;
        `;
        
        const typeStyles = {
            'top': `
                background: rgba(0, 255, 136, 0.3);
                border: 2px solid #00ff88;
                border-bottom: 3px solid #00ff88;
            `,
            'right': `
                background: rgba(0, 122, 204, 0.3);
                border: 2px solid #007acc;
                border-left: 3px solid #007acc;
            `,
            'bottom': `
                background: rgba(255, 187, 0, 0.3);
                border: 2px solid #ffbb00;
                border-top: 3px solid #ffbb00;
            `,
            'left': `
                background: rgba(255, 107, 107, 0.3);
                border: 2px solid #ff6b6b;
                border-right: 3px solid #ff6b6b;
            `,
            'center': `
                background: rgba(138, 43, 226, 0.3);
                border: 2px solid #8a2be2;
            `
        };
        
        return baseStyle + typeStyles[type];
    }

    /**
     * üé® Â¢ÉÁïåÁ∑ö„Éè„Ç§„É©„Ç§„Éà„Çπ„Çø„Ç§„É´ÂèñÂæó
     */
    getBorderHighlightStyle(type) {
        const baseStyle = `
            position: fixed;
            pointer-events: none;
            opacity: 0;
            transition: all ${this.dropAreaConfig.animationDuration}ms ease;
            z-index: 1700;
            border-radius: 4px;
        `;
        
        const borderStyles = {
            'border-top': `
                background: linear-gradient(90deg, 
                    rgba(0, 122, 204, 0.2) 0%, 
                    rgba(0, 122, 204, 0.8) 50%, 
                    rgba(0, 122, 204, 0.2) 100%);
                border: 2px solid #007acc;
                box-shadow: 0 0 12px rgba(0, 122, 204, 0.6);
                animation: borderPulse 1.5s ease-in-out infinite;
            `,
            'border-right': `
                background: linear-gradient(180deg, 
                    rgba(0, 122, 204, 0.2) 0%, 
                    rgba(0, 122, 204, 0.8) 50%, 
                    rgba(0, 122, 204, 0.2) 100%);
                border: 2px solid #007acc;
                box-shadow: 0 0 12px rgba(0, 122, 204, 0.6);
                animation: borderPulse 1.5s ease-in-out infinite;
            `,
            'border-bottom': `
                background: linear-gradient(90deg, 
                    rgba(0, 122, 204, 0.2) 0%, 
                    rgba(0, 122, 204, 0.8) 50%, 
                    rgba(0, 122, 204, 0.2) 100%);
                border: 2px solid #007acc;
                box-shadow: 0 0 12px rgba(0, 122, 204, 0.6);
                animation: borderPulse 1.5s ease-in-out infinite;
            `,
            'border-left': `
                background: linear-gradient(180deg, 
                    rgba(0, 122, 204, 0.2) 0%, 
                    rgba(0, 122, 204, 0.8) 50%, 
                    rgba(0, 122, 204, 0.2) 100%);
                border: 2px solid #007acc;
                box-shadow: 0 0 12px rgba(0, 122, 204, 0.6);
                animation: borderPulse 1.5s ease-in-out infinite;
            `
        };
        
        return baseStyle + borderStyles[type];
    }

    /**
     * üöÄ „Éë„Éç„É´„Éâ„É©„ÉÉ„Ç∞ÈñãÂßã
     */
    startPanelDrag(event, panelId) {
        console.log(`üöÄ „Éë„Éç„É´„Éâ„É©„ÉÉ„Ç∞ÈñãÂßã: ${panelId}`, event);
        event.preventDefault();
        
        this.isDragging = true;
        this.draggedPanel = panelId;
        this.state = 'dragging';
        
        const header = event.currentTarget;
        header.classList.add('dragging');
        header.style.cursor = 'grabbing';
        
        document.body.style.cursor = 'grabbing';
        document.body.style.userSelect = 'none';
        
        console.log(`üöÄ „Éë„Éç„É´„Éâ„É©„ÉÉ„Ç∞ÈñãÂßã: ${panelId}`);
    }

    /**
     * üîÑ „Éë„Éç„É´„Éâ„É©„ÉÉ„Ç∞Âá¶ÁêÜ
     */
    handlePanelDrag(event) {
        if (!this.isDragging || !this.draggedPanel) return;
        
        // „Éû„Ç¶„Çπ‰∏ã„ÅÆË¶ÅÁ¥†„ÇíÂèñÂæó
        const elementBelow = document.elementFromPoint(event.clientX, event.clientY);
        const targetPanel = elementBelow?.closest('.panel[data-panel]');
        
        if (targetPanel && targetPanel.dataset.panel !== this.draggedPanel) {
            // „Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢Âà§ÂÆö
            const dropArea = this.detectDropArea(event, targetPanel);
            this.updateDropHighlight(dropArea, targetPanel);
        } else {
            // „Éè„Ç§„É©„Ç§„ÉàÈùûË°®Á§∫
            this.hideAllHighlights();
            this.dropAreas.current = null;
        }
    }

    /**
     * üéØ Â¢ÉÁïåÁ∑ö„Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥Ê§úÂá∫
     */
    detectBorderZone(event) {
        const allPanels = this.panelManager.getAllPanels()
            .map(id => this.panelManager.findPanel(id))
            .filter(panel => panel && panel.element && panel.id !== this.draggedPanel);
            
        // Èö£Êé•„Éë„Éç„É´„Éö„Ç¢„ÇíÊ§úÂá∫
        const adjacentPairs = this.findAdjacentPanelPairs(allPanels);
        
        for (const pair of adjacentPairs) {
            const borderLine = this.calculateBorderLine(pair.panel1, pair.panel2, pair.direction);
            if (this.isMouseOnBorderLine(event, borderLine)) {
                return {
                    type: 'border',
                    direction: pair.direction,
                    panel1: pair.panel1,
                    panel2: pair.panel2,
                    borderLine: borderLine
                };
            }
        }
        
        return null;
    }

    /**
     * üîç Èö£Êé•„Éë„Éç„É´„Éö„Ç¢Ê§úÂá∫
     */
    findAdjacentPanelPairs(panels) {
        const pairs = [];
        
        for (let i = 0; i < panels.length; i++) {
            for (let j = i + 1; j < panels.length; j++) {
                const panel1 = panels[i];
                const panel2 = panels[j];
                
                const adjacency = this.calculateCurrentAdjacency(panel1.id, panel2.id);
                
                // Èö£Êé•„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅÊñπÂêë„ÇíÁâπÂÆö„Åó„Å¶„Éö„Ç¢„Å´ËøΩÂä†
                if (adjacency.right) {
                    pairs.push({ panel1, panel2, direction: 'vertical' }); // panel1„ÅÆÂè≥Ëæ∫ = panel2„ÅÆÂ∑¶Ëæ∫
                }
                if (adjacency.bottom) {
                    pairs.push({ panel1, panel2, direction: 'horizontal' }); // panel1„ÅÆ‰∏ãËæ∫ = panel2„ÅÆ‰∏äËæ∫
                }
                if (adjacency.left) {
                    pairs.push({ panel1: panel2, panel2: panel1, direction: 'vertical' }); // panel2„ÅÆÂè≥Ëæ∫ = panel1„ÅÆÂ∑¶Ëæ∫
                }
                if (adjacency.top) {
                    pairs.push({ panel1: panel2, panel2: panel1, direction: 'horizontal' }); // panel2„ÅÆ‰∏ãËæ∫ = panel1„ÅÆ‰∏äËæ∫
                }
            }
        }
        
        return pairs;
    }

    /**
     * üìè Â¢ÉÁïåÁ∑öÂ∫ßÊ®ôË®àÁÆó
     */
    calculateBorderLine(panel1, panel2, direction) {
        const rect1 = panel1.element.getBoundingClientRect();
        const rect2 = panel2.element.getBoundingClientRect();
        
        if (direction === 'vertical') {
            // Á∏¶„ÅÆÂ¢ÉÁïåÁ∑öÔºàpanel1„ÅÆÂè≥Ëæ∫„Å®panel2„ÅÆÂ∑¶Ëæ∫„ÅÆ‰∏≠Â§ÆÔºâ
            const borderX = (rect1.right + rect2.left) / 2;
            const topY = Math.max(rect1.top, rect2.top);
            const bottomY = Math.min(rect1.bottom, rect2.bottom);
            
            return {
                direction: 'vertical',
                x: borderX,
                y1: topY,
                y2: bottomY,
                width: this.dropAreaConfig.borderZoneWidth,
                height: bottomY - topY
            };
        } else {
            // Ê®™„ÅÆÂ¢ÉÁïåÁ∑öÔºàpanel1„ÅÆ‰∏ãËæ∫„Å®panel2„ÅÆ‰∏äËæ∫„ÅÆ‰∏≠Â§ÆÔºâ
            const borderY = (rect1.bottom + rect2.top) / 2;
            const leftX = Math.max(rect1.left, rect2.left);
            const rightX = Math.min(rect1.right, rect2.right);
            
            return {
                direction: 'horizontal',
                x1: leftX,
                x2: rightX,
                y: borderY,
                width: rightX - leftX,
                height: this.dropAreaConfig.borderZoneWidth
            };
        }
    }

    /**
     * üéØ „Éû„Ç¶„Çπ„ÅåÂ¢ÉÁïåÁ∑ö‰∏ä„Å´„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
     */
    isMouseOnBorderLine(event, borderLine) {
        const tolerance = this.dropAreaConfig.borderTolerance;
        
        if (borderLine.direction === 'vertical') {
            const isWithinX = Math.abs(event.clientX - borderLine.x) <= tolerance;
            const isWithinY = event.clientY >= borderLine.y1 && event.clientY <= borderLine.y2;
            return isWithinX && isWithinY;
        } else {
            const isWithinY = Math.abs(event.clientY - borderLine.y) <= tolerance;
            const isWithinX = event.clientX >= borderLine.x1 && event.clientX <= borderLine.x2;
            return isWithinY && isWithinX;
        }
    }

    /**
     * üéØ „Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢Âà§ÂÆö
     */
    detectDropArea(event, targetPanel) {
        const rect = targetPanel.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        
        const width = rect.width;
        const height = rect.height;
        
        // „Ç®„É™„Ç¢Â¢ÉÁïåÂÄ§Ë®àÁÆó
        const edgeW = width * this.dropAreaConfig.edgeThreshold;
        const edgeH = height * this.dropAreaConfig.edgeThreshold;
        const centerW = width * this.dropAreaConfig.centerThreshold;
        const centerH = height * this.dropAreaConfig.centerThreshold;
        const centerStartX = (width - centerW) / 2;
        const centerStartY = (height - centerH) / 2;
        
        // Èö£Êé•„ÉÅ„Çß„ÉÉ„ÇØ
        const isAdjacent = this.checkAdjacency(this.draggedPanel, targetPanel.dataset.panel);
        
        // Â¢ÉÁïåÁ∑öÊ§úÂá∫ÔºàÈö£Êé•„Åô„ÇãËæ∫„ÅÆÂ†¥Âêà„ÅØÁµ±Âêà„Éè„Ç§„É©„Ç§„ÉàË°®Á§∫Ôºâ
        if (x >= width - edgeW && isAdjacent.right) {
            return { type: 'right', panel: targetPanel, rect, adjacent: true, isBoundary: true };
        }
        if (x <= edgeW && isAdjacent.left) {
            return { type: 'left', panel: targetPanel, rect, adjacent: true, isBoundary: true };
        }
        if (y <= edgeH && isAdjacent.top) {
            return { type: 'top', panel: targetPanel, rect, adjacent: true, isBoundary: true };
        }
        if (y >= height - edgeH && isAdjacent.bottom) {
            return { type: 'bottom', panel: targetPanel, rect, adjacent: true, isBoundary: true };
        }
        
        // ÈÄöÂ∏∏„ÅÆ„Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢Âà§ÂÆöÔºàÈùûÈö£Êé•„ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
        if (y <= edgeH && !isAdjacent.top) {
            return { type: 'top', panel: targetPanel, rect, adjacent: false };
        }
        if (x >= width - edgeW && !isAdjacent.right) {
            return { type: 'right', panel: targetPanel, rect, adjacent: false };
        }
        if (y >= height - edgeH && !isAdjacent.bottom) {
            return { type: 'bottom', panel: targetPanel, rect, adjacent: false };
        }
        if (x <= edgeW && !isAdjacent.left) {
            return { type: 'left', panel: targetPanel, rect, adjacent: false };
        }
        if (x >= centerStartX && x <= centerStartX + centerW && 
            y >= centerStartY && y <= centerStartY + centerH) {
            return { type: 'center', panel: targetPanel, rect, adjacent: false };
        }
        
        return null;
    }

    /**
     * üîç Èö£Êé•„ÉÅ„Çß„ÉÉ„ÇØ
     */
    checkAdjacency(draggedPanelId, targetPanelId) {
        // ÁèæÂú®„ÅÆCSS Grid„É¨„Ç§„Ç¢„Ç¶„Éà„Åã„ÇâÈö£Êé•Èñ¢‰øÇ„ÇíÂãïÁöÑ„Å´Âà§ÂÆö
        return this.calculateCurrentAdjacency(draggedPanelId, targetPanelId);
    }

    /**
     * üßÆ ÁèæÂú®„ÅÆ„É¨„Ç§„Ç¢„Ç¶„Éà„Åã„ÇâÈö£Êé•Èñ¢‰øÇ„ÇíË®àÁÆó
     */
    calculateCurrentAdjacency(draggedPanelId, targetPanelId) {
        // ÂêÑ„Éë„Éç„É´„ÅÆÁèæÂú®„ÅÆ‰ΩçÁΩÆ„ÇíÂèñÂæó
        const draggedElement = this.panelManager.findPanel(draggedPanelId)?.element;
        const targetElement = this.panelManager.findPanel(targetPanelId)?.element;
        
        if (!draggedElement || !targetElement) {
            return { top: false, right: false, bottom: false, left: false };
        }
        
        const draggedRect = draggedElement.getBoundingClientRect();
        const targetRect = targetElement.getBoundingClientRect();
        
        // Èö£Êé•Âà§ÂÆö„ÅÆË®±ÂÆπË™§Â∑ÆÔºà1pxÔºâ
        const tolerance = 1;
        
        // ÂêÑÊñπÂêë„Åß„ÅÆÈö£Êé•„ÉÅ„Çß„ÉÉ„ÇØ
        const adjacency = {
            top: this.isAdjacent(draggedRect.bottom, targetRect.top, tolerance),      // „Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´„ÅÆ‰∏ãËæ∫ = „Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆ‰∏äËæ∫
            right: this.isAdjacent(draggedRect.left, targetRect.right, tolerance),   // „Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´„ÅÆÂ∑¶Ëæ∫ = „Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆÂè≥Ëæ∫
            bottom: this.isAdjacent(draggedRect.top, targetRect.bottom, tolerance),  // „Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´„ÅÆ‰∏äËæ∫ = „Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆ‰∏ãËæ∫
            left: this.isAdjacent(draggedRect.right, targetRect.left, tolerance)     // „Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´„ÅÆÂè≥Ëæ∫ = „Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆÂ∑¶Ëæ∫
        };
        
        // console.log(`üîç Èö£Êé•„ÉÅ„Çß„ÉÉ„ÇØ: ${draggedPanelId} ‚Üí ${targetPanelId}`, adjacency);
        return adjacency;
    }

    /**
     * üìè Â∫ßÊ®ô„ÅÆÈö£Êé•Âà§ÂÆö
     */
    isAdjacent(coord1, coord2, tolerance) {
        const isAdj = Math.abs(coord1 - coord2) <= tolerance;
        // console.log(`üìè Â∫ßÊ®ôÂà§ÂÆö: ${coord1.toFixed(1)} vs ${coord2.toFixed(1)} = ${isAdj ? 'Èö£Êé•' : 'ÈùûÈö£Êé•'} (Â∑Æ: ${Math.abs(coord1 - coord2).toFixed(1)}px)`);
        return isAdj;
    }

    /**
     * üé® Â¢ÉÁïåÁ∑ö„Çæ„Éº„É≥„Éè„Ç§„É©„Ç§„ÉàÊõ¥Êñ∞
     */
    updateBorderZoneHighlight(borderZone) {
        // ÂÖ®„Å¶„ÅÆ„Éè„Ç§„É©„Ç§„Éà„ÇíÈùûË°®Á§∫
        this.hideAllHighlights();
        
        if (!borderZone) {
            this.dropAreas.current = null;
            return;
        }
        
        // Â¢ÉÁïåÁ∑ö„Éè„Ç§„É©„Ç§„Éà„ÇíË°®Á§∫
        const borderHighlight = this.dropAreas.borderZones.find(
            h => h.type === borderZone.direction
        );
        
        if (borderHighlight) {
            this.showBorderZoneHighlight(borderHighlight.element, borderZone);
            this.dropAreas.current = borderZone;
        }
        
        console.log(`üéØ Â¢ÉÁïåÁ∑ö„Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥Ê§úÂá∫: ${borderZone.direction} between ${borderZone.panel1.id} and ${borderZone.panel2.id}`);
    }

    /**
     * üé® Â¢ÉÁïåÁ∑ö„Çæ„Éº„É≥„Éè„Ç§„É©„Ç§„ÉàË°®Á§∫
     */
    showBorderZoneHighlight(highlight, borderZone) {
        const borderLine = borderZone.borderLine;
        
        if (borderLine.direction === 'vertical') {
            // Á∏¶„ÅÆÂ¢ÉÁïåÁ∑ö
            highlight.style.left = `${borderLine.x - borderLine.width / 2}px`;
            highlight.style.top = `${borderLine.y1}px`;
            highlight.style.width = `${borderLine.width}px`;
            highlight.style.height = `${borderLine.height}px`;
        } else {
            // Ê®™„ÅÆÂ¢ÉÁïåÁ∑ö
            highlight.style.left = `${borderLine.x1}px`;
            highlight.style.top = `${borderLine.y - borderLine.height / 2}px`;
            highlight.style.width = `${borderLine.width}px`;
            highlight.style.height = `${borderLine.height}px`;
        }
        
        highlight.style.opacity = this.dropAreaConfig.highlightOpacity;
    }

    /**
     * üé® „Éâ„É≠„ÉÉ„Éó„Éè„Ç§„É©„Ç§„ÉàÊõ¥Êñ∞
     */
    updateDropHighlight(dropArea, targetPanel) {
        // ÂÖ®„Å¶„ÅÆ„Éè„Ç§„É©„Ç§„Éà„ÇíÈùûË°®Á§∫
        this.hideAllHighlights();
        
        if (!dropArea) {
            this.dropAreas.current = null;
            return;
        }
        
        // ÈáçË§á„Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞Ôºà‰∏ÄÊôÇÁöÑ„Å´ÁÑ°ÂäπÂåñ - Á∑äÊÄ•‰øÆÊ≠£Ôºâ
        // const filteredDropArea = this.filterDuplicateDropAreas(dropArea, targetPanel);
        // if (!filteredDropArea) {
        //     this.dropAreas.current = null;
        //     return;
        // }
        
        // ÂØæË±°„ÅÆ„Éè„Ç§„É©„Ç§„Éà„ÇíË°®Á§∫Ôºà„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÁÑ°ÂäπÂåñÔºâ
        const highlight = this.dropAreas.highlights.find(h => h.type === dropArea.type);
        if (highlight) {
            this.showHighlight(highlight.element, dropArea);
            this.dropAreas.current = dropArea;
        }
        
        console.log(`üéØ „Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢Ê§úÂá∫: ${dropArea.type} on ${dropArea.panel.dataset.panel}`);
    }

    /**
     * üîç ÈáçË§á„Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
     */
    filterDuplicateDropAreas(dropArea, targetPanel) {
        // Â¢ÉÁïåÁ∑ö„Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÅåÊó¢„Å´Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅÈÄöÂ∏∏„ÅÆ„Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢„ÇíÈö†„Åô
        if (this.dropAreas.current && this.dropAreas.current.type === 'border') {
            return null;
        }
        
        // Èö£Êé•„Åô„ÇãËæ∫„ÅÆ„Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢„ÇíÁµ±ÂêàÂá¶ÁêÜ
        const targetPanelId = targetPanel.dataset.panel;
        const adjacency = this.calculateCurrentAdjacency(this.draggedPanel, targetPanelId);
        
        // Èö£Êé•„ÉÅ„Çß„ÉÉ„ÇØÁµêÊûú„Å´Âü∫„Å•„ÅÑ„Å¶ÈáçË§á„ÇíÂõûÈÅø
        if (dropArea.type === 'right' && adjacency.right) {
            // Êó¢„Å´Èö£Êé•„Åó„Å¶„ÅÑ„ÇãÂè≥ÂÅ¥„ÅØÂ¢ÉÁïåÁ∑ö„Å®„Åó„Å¶Âá¶ÁêÜÊ∏à„Åø
            return null;
        }
        if (dropArea.type === 'left' && adjacency.left) {
            // Êó¢„Å´Èö£Êé•„Åó„Å¶„ÅÑ„ÇãÂ∑¶ÂÅ¥„ÅØÂ¢ÉÁïåÁ∑ö„Å®„Åó„Å¶Âá¶ÁêÜÊ∏à„Åø
            return null;
        }
        if (dropArea.type === 'top' && adjacency.top) {
            // Êó¢„Å´Èö£Êé•„Åó„Å¶„ÅÑ„Çã‰∏äÂÅ¥„ÅØÂ¢ÉÁïåÁ∑ö„Å®„Åó„Å¶Âá¶ÁêÜÊ∏à„Åø
            return null;
        }
        if (dropArea.type === 'bottom' && adjacency.bottom) {
            // Êó¢„Å´Èö£Êé•„Åó„Å¶„ÅÑ„Çã‰∏ãÂÅ¥„ÅØÂ¢ÉÁïåÁ∑ö„Å®„Åó„Å¶Âá¶ÁêÜÊ∏à„Åø
            return null;
        }
        
        return dropArea;
    }

    /**
     * üé® „Éè„Ç§„É©„Ç§„ÉàË°®Á§∫
     */
    showHighlight(highlight, dropArea) {
        const rect = dropArea.rect;
        const edgeThickness = dropArea.isBoundary ? 60 : 40; // Â¢ÉÁïåÁ∑ö„ÅÆÂ†¥Âêà„ÅØÂ§™„ÅèË°®Á§∫
        
        switch (dropArea.type) {
            case 'top':
                highlight.style.left = `${rect.left}px`;
                highlight.style.top = `${rect.top}px`;
                highlight.style.width = `${rect.width}px`;
                highlight.style.height = `${edgeThickness}px`;
                break;
                
            case 'right':
                highlight.style.left = `${rect.right - edgeThickness}px`;
                highlight.style.top = `${rect.top}px`;
                highlight.style.width = `${edgeThickness}px`;
                highlight.style.height = `${rect.height}px`;
                break;
                
            case 'bottom':
                highlight.style.left = `${rect.left}px`;
                highlight.style.top = `${rect.bottom - edgeThickness}px`;
                highlight.style.width = `${rect.width}px`;
                highlight.style.height = `${edgeThickness}px`;
                break;
                
            case 'left':
                highlight.style.left = `${rect.left}px`;
                highlight.style.top = `${rect.top}px`;
                highlight.style.width = `${edgeThickness}px`;
                highlight.style.height = `${rect.height}px`;
                break;
                
            case 'center':
                const centerSize = 0.6;
                const centerWidth = rect.width * centerSize;
                const centerHeight = rect.height * centerSize;
                highlight.style.left = `${rect.left + (rect.width - centerWidth) / 2}px`;
                highlight.style.top = `${rect.top + (rect.height - centerHeight) / 2}px`;
                highlight.style.width = `${centerWidth}px`;
                highlight.style.height = `${centerHeight}px`;
                break;
        }
        
        // Â¢ÉÁïåÁ∑ö„ÅÆÂ†¥Âêà„ÅØÁâπÂà•„Å™„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
        if (dropArea.isBoundary) {
            highlight.style.background = 'linear-gradient(90deg, rgba(0, 122, 204, 0.3) 0%, rgba(138, 43, 226, 0.6) 50%, rgba(0, 122, 204, 0.3) 100%)';
            highlight.style.border = '3px solid #007acc';
            highlight.style.boxShadow = '0 0 15px rgba(0, 122, 204, 0.8)';
            highlight.style.animation = 'borderPulse 1.5s ease-in-out infinite';
        }
        
        highlight.style.opacity = this.dropAreaConfig.highlightOpacity;
    }

    /**
     * üö´ ÂÖ®„Éè„Ç§„É©„Ç§„ÉàÈùûË°®Á§∫
     */
    hideAllHighlights() {
        // ÈÄöÂ∏∏„ÅÆ„Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢„Éè„Ç§„É©„Ç§„Éà„ÇíÈùûË°®Á§∫
        this.dropAreas.highlights.forEach(highlight => {
            highlight.element.style.opacity = '0';
        });
        
        // Â¢ÉÁïåÁ∑ö„Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„Éè„Ç§„É©„Ç§„Éà„ÇíÈùûË°®Á§∫
        this.dropAreas.borderZones.forEach(borderZone => {
            borderZone.element.style.opacity = '0';
        });
    }

    /**
     * ‚úÖ „Éë„Éç„É´„Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫Ü
     */
    endPanelDrag() {
        if (!this.isDragging) return;
        
        console.log('‚úÖ „Éë„Éç„É´„Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫ÜÂá¶ÁêÜÈñãÂßã');
        
        // „Éâ„É≠„ÉÉ„ÉóÂá¶ÁêÜÂÆüË°å
        const dropResult = this.executeDrop();
        
        // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        this.cleanupDragState();
        
        console.log('‚úÖ „Éë„Éç„É´„Éâ„É©„ÉÉ„Ç∞ÂÆå‰∫Ü', dropResult);
    }

    /**
     * üéØ „Éâ„É≠„ÉÉ„ÉóÂÆüË°å
     */
    executeDrop() {
        if (!this.dropAreas.current) {
            return { success: false, reason: 'No valid drop area' };
        }
        
        const dropArea = this.dropAreas.current;
        
        console.log(`üéØ „Éâ„É≠„ÉÉ„ÉóÂÆüË°å: ${this.draggedPanel} (${dropArea.type})`);
        
        try {
            // Â¢ÉÁïåÁ∑ö„Éâ„É≠„ÉÉ„Éó„ÅÆÂ†¥Âêà
            if (dropArea.type.startsWith('border-')) {
                return this.executeBorderDrop(dropArea);
            }
            
            // ÈÄöÂ∏∏„ÅÆ„Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢„ÅÆÂ†¥Âêà
            const targetPanelId = dropArea.panel.dataset.panel;
            
            switch (dropArea.type) {
                case 'center':
                    return this.executeSwap(this.draggedPanel, targetPanelId);
                    
                case 'top':
                    return this.executeVerticalSplit(this.draggedPanel, targetPanelId, 'top');
                    
                case 'bottom':
                    return this.executeVerticalSplit(this.draggedPanel, targetPanelId, 'bottom');
                    
                case 'left':
                    return this.executeHorizontalSplit(this.draggedPanel, targetPanelId, 'left');
                    
                case 'right':
                    return this.executeHorizontalSplit(this.draggedPanel, targetPanelId, 'right');
                    
                default:
                    return { success: false, reason: 'Unknown drop type' };
            }
        } catch (error) {
            console.error('‚ùå „Éâ„É≠„ÉÉ„ÉóÂÆüË°å„Ç®„É©„Éº:', error);
            return { success: false, reason: error.message };
        }
    }

    /**
     * üéØ Â¢ÉÁïåÁ∑ö„Éâ„É≠„ÉÉ„ÉóÂÆüË°å
     */
    executeBorderDrop(dropArea) {
        const targetPanelId = dropArea.panel.dataset.panel;
        console.log(`üéØ Â¢ÉÁïåÁ∑ö„Éâ„É≠„ÉÉ„ÉóÂÆüË°å: ${this.draggedPanel} ‚Üí ${targetPanelId} (${dropArea.type})`);
        
        // Â¢ÉÁïåÁ∑ö„Éâ„É≠„ÉÉ„Éó„ÅØÈö£Êé•„Éë„Éç„É´Èñì„Å∏„ÅÆÊåøÂÖ•„Å®„Åó„Å¶Âá¶ÁêÜ
        switch (dropArea.type) {
            case 'border-top':
                return this.executeVerticalSplit(this.draggedPanel, targetPanelId, 'top');
            case 'border-bottom':
                return this.executeVerticalSplit(this.draggedPanel, targetPanelId, 'bottom');
            case 'border-left':
                return this.executeHorizontalSplit(this.draggedPanel, targetPanelId, 'left');
            case 'border-right':
                return this.executeHorizontalSplit(this.draggedPanel, targetPanelId, 'right');
            default:
                return { success: false, reason: 'Unknown border drop type' };
        }
    }

    /**
     * üîÑ „Éë„Éç„É´ÂÖ•„ÇåÊõø„ÅàÂÆüË°å
     */
    executeSwap(draggedId, targetId) {
        console.log(`üîÑ „Éë„Éç„É´ÂÖ•„ÇåÊõø„Åà: ${draggedId} ‚Üî ${targetId}`);
        
        const draggedPanel = this.panelManager.findPanel(draggedId);
        const targetPanel = this.panelManager.findPanel(targetId);
        
        if (!draggedPanel || !targetPanel) {
            return { success: false, reason: 'Panel not found' };
        }
        
        // CSS Grid Area „ÇíÂÖ•„ÇåÊõø„Åà
        const draggedArea = getComputedStyle(draggedPanel.element).gridArea;
        const targetArea = getComputedStyle(targetPanel.element).gridArea;
        
        draggedPanel.element.style.gridArea = targetArea;
        targetPanel.element.style.gridArea = draggedArea;
        
        return { 
            success: true, 
            action: 'swap', 
            panels: [draggedId, targetId] 
        };
    }

    /**
     * üìê Á∏¶ÂàÜÂâ≤ÂÆüË°å
     */
    executeVerticalSplit(draggedId, targetId, position) {
        console.log(`üìê Á∏¶ÂàÜÂâ≤ÂÆüË°å: ${draggedId} ‚Üí ${targetId} (${position})`);
        
        // Êñ∞„Åó„ÅÑCSS Grid„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÁîüÊàê
        const newLayout = this.generateVerticalSplitLayout(draggedId, targetId, position);
        
        // „É¨„Ç§„Ç¢„Ç¶„ÉàÈÅ©Áî®
        return this.applyNewLayout(newLayout);
    }

    /**
     * üìê Ê®™ÂàÜÂâ≤ÂÆüË°å
     */
    executeHorizontalSplit(draggedId, targetId, position) {
        console.log(`üìê Ê®™ÂàÜÂâ≤ÂÆüË°å: ${draggedId} ‚Üí ${targetId} (${position})`);
        
        // Êñ∞„Åó„ÅÑCSS Grid„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÁîüÊàê
        const newLayout = this.generateHorizontalSplitLayout(draggedId, targetId, position);
        
        // „É¨„Ç§„Ç¢„Ç¶„ÉàÈÅ©Áî®
        return this.applyNewLayout(newLayout);
    }

    /**
     * üé® Á∏¶ÂàÜÂâ≤„É¨„Ç§„Ç¢„Ç¶„ÉàÁîüÊàê
     */
    generateVerticalSplitLayout(draggedId, targetId, position) {
        // Âü∫Êú¨ÁöÑ„Å™ÂÆüË£ÖÔºöÂØæË±°„Éë„Éç„É´„ÅÆ‰ΩçÁΩÆ„Å´Âøú„Åò„Å¶grid-template-areas„ÇíÂãïÁöÑÁîüÊàê
        const currentAreas = this.getCurrentGridAreas();
        
        // „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢„Åß„ÅÆÂàÜÂâ≤ÔºàÁ©∫ÁôΩ„Çº„É≠ÂéüÂâáÈÅ©Áî®Ôºâ
        if (targetId === 'preview') {
            if (position === 'top') {
                // „Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´„Åå„Éó„É¨„Éì„É•„Éº„ÅÆ‰∏ä„Å´ÈÖçÁΩÆ„Åï„Çå„ÇãÂ†¥Âêà
                if (draggedId === 'outliner') {
                    // outliner‚Üípreview„ÅÆÂ†¥ÂêàÔºöÂ∑¶ÂÅ¥„ÇíÂÆåÂÖ®„Å´Âüã„ÇÅ„Çã
                    return {
                        areas: [
                            '"header header header"',
                            `"${draggedId} ${draggedId} properties"`,
                            `"${targetId} ${targetId} properties"`,
                            '"timeline timeline timeline"'
                        ],
                        columns: '1fr 2fr var(--properties-width, 300px)',
                        rows: '60px auto 1fr var(--timeline-height, 200px)'
                    };
                } else {
                    // ‰ªñ„ÅÆ„Éë„Éç„É´‚Üípreview„ÅÆÂ†¥Âêà
                    return {
                        areas: [
                            '"header header header"',
                            `"outliner ${draggedId} properties"`,
                            `"outliner ${targetId} properties"`,
                            '"timeline timeline timeline"'
                        ],
                        columns: 'var(--outliner-width, 300px) 1fr var(--properties-width, 300px)',
                        rows: '60px auto 1fr var(--timeline-height, 200px)'
                    };
                }
            } else { // bottom
                // „Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´„Åå„Éó„É¨„Éì„É•„Éº„ÅÆ‰∏ã„Å´ÈÖçÁΩÆ„Åï„Çå„ÇãÂ†¥Âêà
                if (draggedId === 'outliner') {
                    // outliner‚Üípreview„ÅÆÂ†¥ÂêàÔºöÂ∑¶ÂÅ¥„ÇíÂÆåÂÖ®„Å´Âüã„ÇÅ„Çã
                    return {
                        areas: [
                            '"header header header"',
                            `"${targetId} ${targetId} properties"`,
                            `"${draggedId} ${draggedId} properties"`,
                            '"timeline timeline timeline"'
                        ],
                        columns: '1fr 2fr var(--properties-width, 300px)',
                        rows: '60px 1fr auto var(--timeline-height, 200px)'
                    };
                } else {
                    // ‰ªñ„ÅÆ„Éë„Éç„É´‚Üípreview„ÅÆÂ†¥Âêà
                    return {
                        areas: [
                            '"header header header"',
                            `"outliner ${targetId} properties"`,
                            `"outliner ${draggedId} properties"`,
                            '"timeline timeline timeline"'
                        ],
                        columns: 'var(--outliner-width, 300px) 1fr var(--properties-width, 300px)',
                        rows: '60px 1fr auto var(--timeline-height, 200px)'
                    };
                }
            }
        }
        
        // „Éó„É≠„Éë„ÉÜ„Ç£„Éë„Éç„É´„Åß„ÅÆÂàÜÂâ≤ÔºàÁ©∫ÁôΩ„Çº„É≠ÂéüÂâáÈÅ©Áî®Ôºâ
        if (targetId === 'properties') {
            if (position === 'top') {
                // „Ç¢„Ç¶„Éà„É©„Ç§„Éä„Éº„Åå„Éó„É≠„Éë„ÉÜ„Ç£„ÅÆ‰∏ä„Å´ÈÖçÁΩÆ„Åï„Çå„ÇãÂ†¥Âêà
                // Á©∫ÁôΩ„Çí‰Ωú„Çâ„Åö„ÄÅ„Éó„É¨„Éì„É•„Éº„Çí‰∏ã„Å´Êã°Âºµ
                return {
                    areas: [
                        '"header header header"',
                        `"${draggedId} ${draggedId} ${targetId}"`,
                        `"preview preview ${targetId}"`,
                        '"timeline timeline timeline"'
                    ],
                    columns: 'var(--outliner-width, 300px) 1fr var(--properties-width, 300px)',
                    rows: '60px auto 1fr var(--timeline-height, 200px)'
                };
            } else { // bottom
                // „Ç¢„Ç¶„Éà„É©„Ç§„Éä„Éº„Åå„Éó„É≠„Éë„ÉÜ„Ç£„ÅÆ‰∏ã„Å´ÈÖçÁΩÆ„Åï„Çå„ÇãÂ†¥Âêà
                // Á©∫ÁôΩ„Çí‰Ωú„Çâ„Åö„ÄÅ„Éó„É¨„Éì„É•„Éº„Çí‰∏ä„Å´Êã°Âºµ
                return {
                    areas: [
                        '"header header header"',
                        `"preview preview ${targetId}"`,
                        `"${draggedId} ${draggedId} ${targetId}"`,
                        '"timeline timeline timeline"'
                    ],
                    columns: 'var(--outliner-width, 300px) 1fr var(--properties-width, 300px)',
                    rows: '60px 1fr auto var(--timeline-height, 200px)'
                };
            }
        }
        
        // „Ç¢„Ç¶„Éà„É©„Ç§„Éä„Éº„Åß„ÅÆÂàÜÂâ≤ÔºàÁ©∫ÁôΩ„Çº„É≠ÂéüÂâáÈÅ©Áî®Ôºâ
        if (targetId === 'outliner') {
            if (position === 'top') {
                // „Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´„Åå„Ç¢„Ç¶„Éà„É©„Ç§„Éä„Éº„ÅÆ‰∏ä„Å´ÈÖçÁΩÆ„Åï„Çå„ÇãÂ†¥Âêà
                // Á©∫ÁôΩ„Çí‰Ωú„Çâ„Åö„ÄÅ„Éó„É¨„Éì„É•„Éº„Å®„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÊ®™„Å´Êã°Âºµ
                return {
                    areas: [
                        '"header header header"',
                        `"${draggedId} preview properties"`,
                        `"${targetId} preview properties"`,
                        '"timeline timeline timeline"'
                    ],
                    columns: 'var(--outliner-width, 300px) 1fr var(--properties-width, 300px)',
                    rows: '60px auto 1fr var(--timeline-height, 200px)'
                };
            } else { // bottom
                // „Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´„Åå„Ç¢„Ç¶„Éà„É©„Ç§„Éä„Éº„ÅÆ‰∏ã„Å´ÈÖçÁΩÆ„Åï„Çå„ÇãÂ†¥Âêà
                // Á©∫ÁôΩ„Çí‰Ωú„Çâ„Åö„ÄÅ„Éó„É¨„Éì„É•„Éº„Å®„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÊ®™„Å´Êã°Âºµ
                return {
                    areas: [
                        '"header header header"',
                        `"${targetId} preview properties"`,
                        `"${draggedId} preview properties"`,
                        '"timeline timeline timeline"'
                    ],
                    columns: 'var(--outliner-width, 300px) 1fr var(--properties-width, 300px)',
                    rows: '60px 1fr auto var(--timeline-height, 200px)'
                };
            }
        }
        
        // „Çø„Ç§„É†„É©„Ç§„É≥„Åß„ÅÆÂàÜÂâ≤ÔºàÊñ∞Ë¶èÂÆüË£ÖÔºâ
        if (targetId === 'timeline') {
            if (position === 'top') {
                // „Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´„Åå„Çø„Ç§„É†„É©„Ç§„É≥„ÅÆ‰∏ä„Å´ÈÖçÁΩÆ„Åï„Çå„ÇãÂ†¥Âêà
                return {
                    areas: [
                        '"header header header"',
                        '"outliner preview properties"',
                        `"${draggedId} ${draggedId} ${draggedId}"`,
                        `"${targetId} ${targetId} ${targetId}"`
                    ],
                    columns: 'var(--outliner-width, 300px) 1fr var(--properties-width, 300px)',
                    rows: '60px 1fr auto var(--timeline-height, 200px)'
                };
            } else { // bottom
                // „Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´„Åå„Çø„Ç§„É†„É©„Ç§„É≥„ÅÆ‰∏ã„Å´ÈÖçÁΩÆ„Åï„Çå„ÇãÂ†¥Âêà
                return {
                    areas: [
                        '"header header header"',
                        '"outliner preview properties"',
                        `"${targetId} ${targetId} ${targetId}"`,
                        `"${draggedId} ${draggedId} ${draggedId}"`
                    ],
                    columns: 'var(--outliner-width, 300px) 1fr var(--properties-width, 300px)',
                    rows: '60px 1fr var(--timeline-height, 200px) auto'
                };
            }
        }
        
        // „Éá„Éï„Ç©„É´„ÉàÔºàÂ§âÊõ¥„Å™„ÅóÔºâ
        return null;
    }

    /**
     * üé® Ê®™ÂàÜÂâ≤„É¨„Ç§„Ç¢„Ç¶„ÉàÁîüÊàê
     */
    generateHorizontalSplitLayout(draggedId, targetId, position) {
        // Ê®™ÂàÜÂâ≤„ÅÆÂ†¥Âêà„ÄÅÁ©∫ÁôΩ„Ç®„É™„Ç¢„ÇíÂüã„ÇÅ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã
        const currentAreas = this.getCurrentGridAreas();
        
        // „Ç¢„Ç¶„Éà„É©„Ç§„Éä„Éº„Åß„ÅÆÊ®™ÂàÜÂâ≤
        if (targetId === 'outliner') {
            if (position === 'left') {
                // Â∑¶„Å´„Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´„ÄÅÂè≥„Å´„Ç¢„Ç¶„Éà„É©„Ç§„Éä„Éº
                return {
                    areas: [
                        '"header header header header"',
                        `"${draggedId} ${targetId} preview properties"`,
                        '"timeline timeline timeline timeline"'
                    ],
                    columns: 'var(--outliner-width, 150px) var(--outliner-width, 150px) 1fr var(--properties-width, 300px)',
                    rows: '60px 1fr var(--timeline-height, 200px)'
                };
            } else if (position === 'right') {
                // Â∑¶„Å´„Ç¢„Ç¶„Éà„É©„Ç§„Éä„Éº„ÄÅÂè≥„Å´„Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´
                return {
                    areas: [
                        '"header header header header"',
                        `"${targetId} ${draggedId} preview properties"`,
                        '"timeline timeline timeline timeline"'
                    ],
                    columns: 'var(--outliner-width, 150px) var(--outliner-width, 150px) 1fr var(--properties-width, 300px)',
                    rows: '60px 1fr var(--timeline-height, 200px)'
                };
            }
        }
        
        // „Éó„É¨„Éì„É•„Éº„Åß„ÅÆÊ®™ÂàÜÂâ≤
        if (targetId === 'preview') {
            if (position === 'left') {
                // Â∑¶„Å´„Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´„ÄÅÂè≥„Å´„Éó„É¨„Éì„É•„Éº„ÅåÊã°Âºµ
                return {
                    areas: [
                        '"header header header header"',
                        `"outliner ${draggedId} ${targetId} properties"`,
                        '"timeline timeline timeline timeline"'
                    ],
                    columns: 'var(--outliner-width, 300px) auto 1fr var(--properties-width, 300px)',
                    rows: '60px 1fr var(--timeline-height, 200px)'
                };
            } else if (position === 'right') {
                // Â∑¶„Å´„Éó„É¨„Éì„É•„Éº„ÅåÊã°Âºµ„ÄÅÂè≥„Å´„Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´
                return {
                    areas: [
                        '"header header header header"',
                        `"outliner ${targetId} ${draggedId} properties"`,
                        '"timeline timeline timeline timeline"'
                    ],
                    columns: 'var(--outliner-width, 300px) 1fr auto var(--properties-width, 300px)',
                    rows: '60px 1fr var(--timeline-height, 200px)'
                };
            }
        }
        
        // „Éó„É≠„Éë„ÉÜ„Ç£„Éë„Éç„É´„Åß„ÅÆÊ®™ÂàÜÂâ≤
        if (targetId === 'properties') {
            if (position === 'left') {
                // Â∑¶„Å´„Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´„ÄÅÂè≥„Å´„Éó„É≠„Éë„ÉÜ„Ç£
                return {
                    areas: [
                        '"header header header header"',
                        `"outliner preview ${draggedId} ${targetId}"`,
                        '"timeline timeline timeline timeline"'
                    ],
                    columns: 'var(--outliner-width, 300px) 1fr var(--properties-width, 150px) var(--properties-width, 150px)',
                    rows: '60px 1fr var(--timeline-height, 200px)'
                };
            } else if (position === 'right') {
                // Â∑¶„Å´„Éó„É≠„Éë„ÉÜ„Ç£„ÄÅÂè≥„Å´„Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´
                return {
                    areas: [
                        '"header header header header"',
                        `"outliner preview ${targetId} ${draggedId}"`,
                        '"timeline timeline timeline timeline"'
                    ],
                    columns: 'var(--outliner-width, 300px) 1fr var(--properties-width, 150px) var(--properties-width, 150px)',
                    rows: '60px 1fr var(--timeline-height, 200px)'
                };
            }
        }
        
        // „Çø„Ç§„É†„É©„Ç§„É≥„Åß„ÅÆÊ®™ÂàÜÂâ≤ÔºàÊñ∞Ë¶èÂÆüË£ÖÔºâ
        if (targetId === 'timeline') {
            if (position === 'left') {
                // Â∑¶„Å´„Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´„ÄÅÂè≥„Å´„Çø„Ç§„É†„É©„Ç§„É≥
                return {
                    areas: [
                        '"header header header header"',
                        '"outliner preview preview properties"',
                        `"${draggedId} ${draggedId} ${targetId} ${targetId}"`
                    ],
                    columns: 'var(--outliner-width, 300px) 1fr 1fr var(--properties-width, 300px)',
                    rows: '60px 1fr var(--timeline-height, 200px)'
                };
            } else if (position === 'right') {
                // Â∑¶„Å´„Çø„Ç§„É†„É©„Ç§„É≥„ÄÅÂè≥„Å´„Éâ„É©„ÉÉ„Ç∞„Éë„Éç„É´
                return {
                    areas: [
                        '"header header header header"',
                        '"outliner preview preview properties"',
                        `"${targetId} ${targetId} ${draggedId} ${draggedId}"`
                    ],
                    columns: 'var(--outliner-width, 300px) 1fr 1fr var(--properties-width, 300px)',
                    rows: '60px 1fr var(--timeline-height, 200px)'
                };
            }
        }
        
        return null;
    }

    /**
     * üìã ÁèæÂú®„ÅÆ„Ç∞„É™„ÉÉ„Éâ„Ç®„É™„Ç¢ÂèñÂæó
     */
    getCurrentGridAreas() {
        const computedStyle = getComputedStyle(document.body);
        return computedStyle.gridTemplateAreas;
    }

    /**
     * üé® Êñ∞„Åó„ÅÑ„É¨„Ç§„Ç¢„Ç¶„ÉàÈÅ©Áî®
     */
    applyNewLayout(layout) {
        if (!layout) {
            return { success: false, reason: 'No layout generated' };
        }
        
        try {
            // CSS GridË®≠ÂÆöÊõ¥Êñ∞
            document.body.style.setProperty('grid-template-areas', layout.areas.join(' '), 'important');
            document.body.style.setProperty('grid-template-columns', layout.columns, 'important');
            document.body.style.setProperty('grid-template-rows', layout.rows, 'important');
            
            // „Éë„Éç„É´Ë¶ÅÁ¥†„ÅÆgrid-areaÊõ¥Êñ∞
            this.updatePanelGridAreas(layout);
            
            return { 
                success: true, 
                action: 'layout_change',
                layout: layout
            };
        } catch (error) {
            console.error('‚ùå „É¨„Ç§„Ç¢„Ç¶„ÉàÈÅ©Áî®„Ç®„É©„Éº:', error);
            return { success: false, reason: error.message };
        }
    }

    /**
     * üìç „Éë„Éç„É´grid-areaÊõ¥Êñ∞
     */
    updatePanelGridAreas(layout) {
        // ÂêÑ„Éë„Éç„É´„ÅÆgrid-area„ÇíÊñ∞„Åó„ÅÑ„É¨„Ç§„Ç¢„Ç¶„Éà„Å´Âêà„Çè„Åõ„Å¶Êõ¥Êñ∞
        this.panelManager.getAllPanels().forEach(panelId => {
            const panel = this.panelManager.findPanel(panelId);
            if (panel) {
                panel.element.style.gridArea = panelId;
            }
        });
    }

    /**
     * üßπ „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
     */
    cleanupDragState() {
        this.isDragging = false;
        this.draggedPanel = null;
        this.state = 'ready';
        this.dropAreas.current = null;
        
        // „Éè„Ç§„É©„Ç§„ÉàÈùûË°®Á§∫
        this.hideAllHighlights();
        
        // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„Çπ„Çø„Ç§„É´„É™„Çª„ÉÉ„Éà
        const draggedHeader = document.querySelector('.panel-header.dragging');
        if (draggedHeader) {
            draggedHeader.classList.remove('dragging');
            draggedHeader.style.cursor = 'grab';
        }
        
        // „Éú„Éá„Ç£„Çπ„Çø„Ç§„É´„É™„Çª„ÉÉ„Éà
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
    }

    /**
     * ‚ùå „Éâ„É©„ÉÉ„Ç∞„Ç≠„É£„É≥„Çª„É´
     */
    cancelDrag() {
        console.log('‚ùå „Éâ„É©„ÉÉ„Ç∞„Ç≠„É£„É≥„Çª„É´');
        this.cleanupDragState();
    }

    /**
     * üìä „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±ÂèñÂæó
     */
    getDebugInfo() {
        return {
            state: this.state,
            isDragging: this.isDragging,
            draggedPanel: this.draggedPanel,
            currentDropArea: this.dropAreas.current?.type || 'none',
            highlightCount: this.dropAreas.highlights.length,
            config: this.dropAreaConfig
        };
    }

    /**
     * üßπ „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
     */
    cleanup() {
        if (this.isDragging) {
            this.cancelDrag();
        }
        
        // „Éè„Ç§„É©„Ç§„ÉàË¶ÅÁ¥†ÂâäÈô§
        this.dropAreas.highlights.forEach(highlight => {
            if (highlight.element && highlight.element.parentNode) {
                highlight.element.parentNode.removeChild(highlight.element);
            }
        });
        
        // Â¢ÉÁïåÁ∑ö„Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥Ë¶ÅÁ¥†ÂâäÈô§
        this.dropAreas.borderZones.forEach(borderZone => {
            if (borderZone.element && borderZone.element.parentNode) {
                borderZone.element.parentNode.removeChild(borderZone.element);
            }
        });
        
        this.state = 'cleanup';
        console.log('üßπ NewPanelSwapController „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü');
    }
}

export default NewPanelSwapController;