<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎯 StableSpineRenderer テスト</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 5px;
        }
        
        .spine-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 450px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e0e8ff;
        }
        
        #spine-canvas {
            border: 2px solid #ddd;
            border-radius: 8px;
            background: transparent;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        button {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            min-width: 120px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,107,107,0.4);
        }
        
        .secondary-btn {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
        }
        
        .secondary-btn:hover {
            box-shadow: 0 5px 15px rgba(78,205,196,0.4);
        }
        
        .status-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            padding: 20px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
            margin: 20px 0;
        }
        
        .comparison-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 StableSpineRenderer 安定性テスト</h1>
        
        <div class="info-box">
            <h3>📋 テスト概要</h3>
            <p><strong>目的</strong>: test-spine-basic-loading.html の成功パターンを基に作成した StableSpineRenderer の動作確認</p>
            <ul>
                <li><strong>基準ページ</strong>: test-spine-basic-loading.html（黒枠なし・位置正常）</li>
                <li><strong>重要設定</strong>: premultipliedAlpha: true, SceneRenderer使用</li>
                <li><strong>期待結果</strong>: 毎回エラーなく読み込み、黒枠問題なし</li>
                <li><strong>汎用性</strong>: 設定変更で他キャラクター・位置にも対応</li>
            </ul>
        </div>
        
        <div class="comparison-box">
            <h3>🔍 成功パターンとの比較</h3>
            <p><strong>成功パターン（test-spine-basic-loading.html）の重要要素</strong>:</p>
            <ul>
                <li>WebGL: <code>premultipliedAlpha: true</code></li>
                <li>AssetManager: ベースパス + 相対パス方式</li>
                <li>SceneRenderer: 高レベルAPI使用</li>
                <li>位置: <code>x: 0, y: -100, scale: 0.55</code></li>
            </ul>
            <p>→ これらの設定を StableSpineRenderer に統合済み</p>
        </div>
        
        <div class="controls">
            <button onclick="initializeStableRenderer()">
                🚀 StableSpineRenderer 初期化
            </button>
            <button class="secondary-btn" onclick="playAnimation('syutugen')">
                ✨ 出現アニメーション
            </button>
            <button class="secondary-btn" onclick="playAnimation('taiki')">
                😊 待機アニメーション
            </button>
            <button class="secondary-btn" onclick="playAnimation('yarare')">
                💥 やられアニメーション
            </button>
            <button class="secondary-btn" onclick="playSequence(['syutugen', 'taiki'])">
                🎬 出現→待機シーケンス
            </button>
        </div>
        
        <div class="controls">
            <button class="secondary-btn" onclick="testPositionChange()">
                📍 位置変更テスト
            </button>
            <button class="secondary-btn" onclick="testScaleChange()">
                🔍 スケール変更テスト
            </button>
            <button class="secondary-btn" onclick="showStatus()">
                📊 ステータス表示
            </button>
            <button class="secondary-btn" onclick="clearLog()">
                🗑️ ログクリア
            </button>
        </div>
        
        <div class="spine-container">
            <canvas id="spine-canvas" width="400" height="400"></canvas>
        </div>
        
        <div class="status-panel">
            <h3>📊 システム状態</h3>
            <div id="status-display">
                StableSpineRenderer 未初期化
            </div>
        </div>
        
        <div class="log-container" id="log-display">
            🎯 StableSpineRenderer テスト準備中...\n
        </div>
    </div>

    <!-- Spine WebGL Runtime（成功パターンと同じCDN版） -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.24/dist/iife/spine-webgl.js"></script>
    
    <!-- StableSpineRenderer モジュール -->
    <script src="micromodules/spine-renderer/StableSpineRenderer.js"></script>
    
    <script>
        // グローバル変数
        let stableRenderer = null;
        let logDisplay = null;
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            logDisplay = document.getElementById('log-display');
            testLog('🎯 StableSpineRenderer テストシステム起動', 'success');
            testLog('📋 基準: test-spine-basic-loading.html の成功パターン', 'info');
            testLog('🔧 premultipliedAlpha: true, SceneRenderer使用', 'info');
        });
        
        /**
         * ログ表示関数
         */
        function testLog(message, type = 'info') {
            if (!logDisplay) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const statusIcon = type === 'error' ? '❌' : 
                              type === 'success' ? '✅' : 
                              type === 'warning' ? '⚠️' : 'ℹ️';
            
            const logLine = `[${timestamp}] ${statusIcon} ${message}\n`;
            logDisplay.textContent += logLine;
            logDisplay.scrollTop = logDisplay.scrollHeight;
            
            console.log(`StableSpineRenderer テスト: ${message}`);
        }
        
        /**
         * StableSpineRenderer 初期化
         */
        async function initializeStableRenderer() {
            try {
                testLog('🚀 StableSpineRenderer 初期化開始', 'info');
                
                if (stableRenderer) {
                    testLog('⚠️ 既に初期化済み - 停止してから再初期化', 'warning');
                    stableRenderer.stop();
                }
                
                // StableSpineRenderer インスタンス作成
                stableRenderer = new StableSpineRenderer({
                    canvas: '#spine-canvas',
                    character: 'purattokun',
                    basePath: '/assets/spine/characters/',
                    position: {
                        x: 0,
                        y: -100,    // test-spine-basic-loading.html と同じ
                        scaleX: 0.55,
                        scaleY: 0.55
                    },
                    defaultAnimation: 'taiki',
                    debug: true,
                    logCallback: testLog
                });
                
                // 初期化実行
                const success = await stableRenderer.initialize();
                
                if (success) {
                    testLog('🎉 StableSpineRenderer 初期化完了！', 'success');
                    updateStatus();
                } else {
                    testLog('❌ StableSpineRenderer 初期化失敗', 'error');
                }
                
            } catch (error) {
                testLog(`❌ 初期化エラー: ${error.message}`, 'error');
                console.error('StableSpineRenderer 初期化エラー:', error);
            }
        }
        
        /**
         * アニメーション再生
         */
        function playAnimation(animationName) {
            if (!stableRenderer) {
                testLog('❌ StableSpineRenderer が未初期化です', 'error');
                return;
            }
            
            const success = stableRenderer.playAnimation(animationName);
            if (success) {
                testLog(`🎬 アニメーション再生: ${animationName}`, 'info');
            }
        }
        
        /**
         * アニメーションシーケンス再生
         */
        function playSequence(animations) {
            if (!stableRenderer) {
                testLog('❌ StableSpineRenderer が未初期化です', 'error');
                return;
            }
            
            const success = stableRenderer.playSequence(animations);
            if (success) {
                testLog(`🎬 シーケンス再生: ${animations.join(' → ')}`, 'info');
            }
        }
        
        /**
         * 位置変更テスト
         */
        function testPositionChange() {
            if (!stableRenderer) {
                testLog('❌ StableSpineRenderer が未初期化です', 'error');
                return;
            }
            
            // ランダムな位置に変更
            const x = Math.random() * 200 - 100;
            const y = Math.random() * 200 - 200;
            
            stableRenderer.setTransform(x, y);
            testLog(`📍 位置変更: (${x.toFixed(1)}, ${y.toFixed(1)})`, 'info');
        }
        
        /**
         * スケール変更テスト
         */
        function testScaleChange() {
            if (!stableRenderer) {
                testLog('❌ StableSpineRenderer が未初期化です', 'error');
                return;
            }
            
            // ランダムなスケール
            const scale = 0.3 + Math.random() * 0.7; // 0.3-1.0
            
            stableRenderer.setTransform(null, null, scale, scale);
            testLog(`🔍 スケール変更: ${scale.toFixed(2)}`, 'info');
        }
        
        /**
         * ステータス表示
         */
        function showStatus() {
            if (!stableRenderer) {
                testLog('❌ StableSpineRenderer が未初期化です', 'error');
                return;
            }
            
            const status = stableRenderer.getStatus();
            testLog('📊 システム状態:', 'info');
            testLog(`   - 初期化済み: ${status.initialized}`, 'info');
            testLog(`   - 読み込み中: ${status.loading}`, 'info');
            testLog(`   - アニメーション実行中: ${status.isAnimationRunning}`, 'info');
            testLog(`   - Canvas: ${status.hasCanvas}`, 'info');
            testLog(`   - WebGL: ${status.hasWebGL}`, 'info');
            testLog(`   - スケルトン: ${status.hasSkeleton}`, 'info');
            testLog(`   - キャラクター: ${status.config.character}`, 'info');
            
            updateStatus(status);
        }
        
        /**
         * ステータス更新
         */
        function updateStatus(status = null) {
            const statusDisplay = document.getElementById('status-display');
            if (!statusDisplay) return;
            
            if (!stableRenderer) {
                statusDisplay.innerHTML = 'StableSpineRenderer 未初期化';
                return;
            }
            
            if (!status) {
                status = stableRenderer.getStatus();
            }
            
            statusDisplay.innerHTML = `
                <strong>初期化状態:</strong> ${status.initialized ? '✅ 完了' : '❌ 未完了'}<br>
                <strong>読み込み状態:</strong> ${status.loading ? '⏳ 読み込み中' : '✅ 完了'}<br>
                <strong>アニメーション:</strong> ${status.isAnimationRunning ? '🎬 実行中' : '⏹️ 停止中'}<br>
                <strong>キャラクター:</strong> ${status.config.character}<br>
                <strong>コンポーネント:</strong> 
                Canvas: ${status.hasCanvas ? '✅' : '❌'}, 
                WebGL: ${status.hasWebGL ? '✅' : '❌'}, 
                スケルトン: ${status.hasSkeleton ? '✅' : '❌'}
            `;
        }
        
        /**
         * ログクリア
         */
        function clearLog() {
            if (logDisplay) {
                logDisplay.textContent = '🗑️ ログクリアされました\n';
            }
            testLog('🧪 ログクリア実行', 'info');
        }
        
        /**
         * クリーンアップ
         */
        window.addEventListener('beforeunload', () => {
            if (stableRenderer) {
                stableRenderer.stop();
            }
        });
        
        /**
         * デバッグ用グローバル関数
         */
        window.stableSpineDebug = {
            renderer: () => stableRenderer,
            testLog: testLog,
            reinitialize: initializeStableRenderer
        };
        
        // 初期化完了ログ
        testLog('🎯 StableSpineRenderer テストシステム準備完了', 'success');
        testLog('💡 "StableSpineRenderer 初期化" ボタンを押して開始', 'info');
        console.log('デバッグ用: window.stableSpineDebug でアクセス可能');
    </script>
</body>
</html>