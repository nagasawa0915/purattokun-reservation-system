<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spine WebGL - é»’æ é˜²æ­¢ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .spine-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 500px;
            background: rgba(240, 248, 255, 0.8);
            border-radius: 10px;
            position: relative;
            margin: 20px 0;
            border: 2px solid #e0e8ff;
        }
        
        #purattokun-canvas {
            /* é»’æ é˜²æ­¢ã®ãŸã‚ã®ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«CSS */
            background: transparent !important;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            
            /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’æ˜ç¤ºçš„ã«æŒ‡å®š */
            width: 400px;
            height: 400px;
            
            /* ã‚¢ãƒ³ãƒã‚¨ã‚¤ãƒªã‚¢ã‚·ãƒ³ã‚°è¨­å®š */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            
            /* GPUåŠ é€Ÿã‚’æœ‰åŠ¹åŒ– */
            transform: translateZ(0);
            will-change: transform;
        }
        
        .status-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .status-ok {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 20px 0;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ Spine WebGL é»’æ é˜²æ­¢ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="info-box">
            <h3>ğŸ“‹ é»’æ é˜²æ­¢å¯¾ç­–</h3>
            <p>ã“ã®ãƒšãƒ¼ã‚¸ã¯é»’æ å•é¡Œã‚’æ ¹æœ¬ã‹ã‚‰é˜²ããŸã‚ã«ä»¥ä¸‹ã®å¯¾ç­–ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ï¼š</p>
            <ul>
                <li>WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆæ™‚ã« <code>premultipliedAlpha: false</code> ã‚’æ˜ç¤ºæŒ‡å®š</li>
                <li>é©åˆ‡ãªãƒ–ãƒ¬ãƒ³ãƒ‰ãƒ¢ãƒ¼ãƒ‰è¨­å®š <code>SRC_ALPHA, ONE_MINUS_SRC_ALPHA</code></li>
                <li>ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã® <code>premultipliedAlpha</code> ã‚’ false ã«è¨­å®š</li>
                <li>ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’ <code>NEAREST</code> ã«å›ºå®š</li>
                <li>å¢ƒç•Œå‡¦ç†ã‚’ <code>CLAMP_TO_EDGE</code> ã«è¨­å®š</li>
            </ul>
        </div>
        
        <div class="status-panel">
            <h3>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
            <div class="status-item">
                <span>Spine WebGL ãƒ©ã‚¤ãƒ–ãƒ©ãƒª:</span>
                <span id="spine-status">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
            <div class="status-item">
                <span>WebGL ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ:</span>
                <span id="webgl-status">æœªåˆæœŸåŒ–</span>
            </div>
            <div class="status-item">
                <span>ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿:</span>
                <span id="asset-status">å¾…æ©Ÿä¸­</span>
            </div>
            <div class="status-item">
                <span>ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°çŠ¶æ…‹:</span>
                <span id="render-status">åœæ­¢ä¸­</span>
            </div>
            <div class="status-item">
                <span>é»’æ æ¤œå‡º:</span>
                <span id="border-status">ç›£è¦–ä¸­</span>
            </div>
        </div>
        
        <div class="spine-container">
            <canvas id="purattokun-canvas"></canvas>
        </div>
        
        <div class="controls">
            <button onclick="initializeSpine()">ğŸš€ SpineåˆæœŸåŒ–</button>
            <button onclick="playAnimation('taiki')">ğŸ­ å¾…æ©Ÿã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</button>
            <button onclick="playAnimation('syutugen')">âœ¨ ç™»å ´ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</button>
            <button onclick="playAnimation('yarare')">ğŸ’¥ ã‚„ã‚‰ã‚Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</button>
            <button onclick="toggleDebugInfo()">ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±</button>
        </div>
        
        <div class="warning-box" id="debug-info" style="display: none;">
            <h3>ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
            <div id="debug-content">
                <p>ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™...</p>
            </div>
        </div>
    </div>

    <!-- Spine WebGL ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="assets/js/libs/spine-webgl.js"></script>
    
    <script>
        /**
         * é»’æ é˜²æ­¢Spine WebGLã‚·ã‚¹ãƒ†ãƒ 
         * ==========================================
         * 
         * é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ:
         * 1. premultipliedAlpha ã‚’ false ã«è¨­å®š
         * 2. é©åˆ‡ãªãƒ–ãƒ¬ãƒ³ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š
         * 3. ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®æœ€é©åŒ–
         * 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Ÿè£…
         */
        
        class CleanSpineRenderer {
            constructor() {
                this.canvas = null;
                this.gl = null;
                this.shader = null;
                this.batcher = null;
                this.skeletonRenderer = null;
                this.assetManager = null;
                this.skeleton = null;
                this.animationState = null;
                this.animationStateData = null;
                this.debugMode = false;
                
                this.status = {
                    spineLibrary: false,
                    webglContext: false,
                    assetsLoaded: false,
                    rendering: false
                };
            }
            
            /**
             * åˆæœŸåŒ–
             */
            async initialize() {
                try {
                    console.log('ğŸ¯ CleanSpineRenderer: åˆæœŸåŒ–é–‹å§‹');
                    
                    // Spine WebGL ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ç¢ºèª
                    if (!this.checkSpineLibrary()) {
                        throw new Error('Spine WebGL ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    
                    // Canvasè¦ç´ ã®å–å¾—
                    this.canvas = document.getElementById('purattokun-canvas');
                    if (!this.canvas) {
                        throw new Error('Canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    
                    // WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ä½œæˆï¼ˆé»’æ é˜²æ­¢è¨­å®šï¼‰
                    this.createWebGLContext();
                    
                    // Spine WebGL ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®åˆæœŸåŒ–
                    this.initializeSpineComponents();
                    
                    // ã‚¢ã‚»ãƒƒãƒˆã®èª­ã¿è¾¼ã¿
                    await this.loadAssets();
                    
                    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹
                    this.startRendering();
                    
                    console.log('âœ… CleanSpineRenderer: åˆæœŸåŒ–å®Œäº†');
                    this.updateStatus('ã™ã¹ã¦æ­£å¸¸');
                    
                } catch (error) {
                    console.error('âŒ CleanSpineRenderer: åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    this.updateStatus('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
                    throw error;
                }
            }
            
            /**
             * Spine WebGL ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ç¢ºèª
             */
            checkSpineLibrary() {
                if (typeof window.spine === 'undefined') {
                    this.updateStatus('spine-status', 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœªèª­ã¿è¾¼ã¿', true);
                    return false;
                }
                
                const requiredClasses = [
                    'AssetManager', 'SkeletonJson', 'AtlasAttachmentLoader',
                    'PolygonBatcher', 'SkeletonRenderer', 'Skeleton', 'AnimationState'
                ];
                
                const missingClasses = requiredClasses.filter(className => !window.spine[className]);
                
                if (missingClasses.length > 0) {
                    this.updateStatus('spine-status', `ä¸è¶³ã‚¯ãƒ©ã‚¹: ${missingClasses.join(', ')}`, true);
                    return false;
                }
                
                this.status.spineLibrary = true;
                this.updateStatus('spine-status', 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ­£å¸¸', false);
                return true;
            }
            
            /**
             * WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ä½œæˆï¼ˆé»’æ é˜²æ­¢è¨­å®šï¼‰
             */
            createWebGLContext() {
                console.log('ğŸ”§ WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ - é»’æ é˜²æ­¢è¨­å®šé©ç”¨');
                
                // ğŸš¨ é»’æ é˜²æ­¢ã®æœ€é‡è¦è¨­å®š
                const webglOptions = {
                    alpha: true,
                    premultipliedAlpha: false,  // ğŸ”¥ ã“ã‚ŒãŒæœ€ã‚‚é‡è¦
                    antialias: true,
                    depth: false,
                    stencil: false,
                    preserveDrawingBuffer: false,
                    failIfMajorPerformanceCaveat: false
                };
                
                // WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
                this.gl = this.canvas.getContext('webgl', webglOptions) || 
                         this.canvas.getContext('experimental-webgl', webglOptions);
                
                if (!this.gl) {
                    throw new Error('WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                // ğŸš¨ é»’æ é˜²æ­¢ã®ãƒ–ãƒ¬ãƒ³ãƒ‰è¨­å®š
                this.gl.enable(this.gl.BLEND);
                this.gl.blendFunc(this.gl.SRC_ALPHA, this.gl.ONE_MINUS_SRC_ALPHA);
                
                // ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆè¨­å®š
                this.gl.viewport(0, 0, this.canvas.width, this.canvas.height);
                
                // ã‚¯ãƒªã‚¢ã‚«ãƒ©ãƒ¼è¨­å®šï¼ˆå®Œå…¨é€æ˜ï¼‰
                this.gl.clearColor(0, 0, 0, 0);
                
                // ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®è¨­å®šï¼ˆé»’æ é˜²æ­¢ï¼‰
                this.setupTextureFiltering();
                
                this.status.webglContext = true;
                this.updateStatus('webgl-status', 'ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆæˆåŠŸ', false);
                
                console.log('âœ… WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆå®Œäº† - premultipliedAlpha:', this.gl.getContextAttributes().premultipliedAlpha);
            }
            
            /**
             * ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°è¨­å®šï¼ˆé»’æ é˜²æ­¢ï¼‰
             */
            setupTextureFiltering() {
                // ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒã‚¤ãƒ³ãƒ‰æ™‚ã®è‡ªå‹•è¨­å®š
                const originalBindTexture = this.gl.bindTexture.bind(this.gl);
                this.gl.bindTexture = (target, texture) => {
                    const result = originalBindTexture(target, texture);
                    
                    if (target === this.gl.TEXTURE_2D && texture) {
                        try {
                            // ğŸš¨ é»’æ é˜²æ­¢: ãƒ”ã‚¯ã‚»ãƒ«ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆè¨­å®š
                            this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MIN_FILTER, this.gl.NEAREST);
                            this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MAG_FILTER, this.gl.NEAREST);
                            
                            // ğŸš¨ é»’æ é˜²æ­¢: å¢ƒç•Œå‡¦ç†
                            this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_S, this.gl.CLAMP_TO_EDGE);
                            this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_T, this.gl.CLAMP_TO_EDGE);
                        } catch (e) {
                            console.warn('âš ï¸ ãƒ†ã‚¯ã‚¹ãƒãƒ£è¨­å®šè­¦å‘Š:', e);
                        }
                    }
                    
                    return result;
                };
                
                console.log('âœ… ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°è¨­å®šå®Œäº†');
            }
            
            /**
             * Spine WebGL ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®åˆæœŸåŒ–
             */
            initializeSpineComponents() {
                // ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ä½œæˆ
                this.shader = window.spine.Shader.newTwoColoredTextured(this.gl);
                
                // ãƒãƒªã‚´ãƒ³ãƒãƒƒãƒãƒ£ãƒ¼ä½œæˆ
                this.batcher = new window.spine.PolygonBatcher(this.gl);
                
                // ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ä½œæˆ
                this.skeletonRenderer = new window.spine.SkeletonRenderer(this.gl);
                
                // ğŸš¨ é»’æ é˜²æ­¢: ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã®è¨­å®š
                this.skeletonRenderer.premultipliedAlpha = false;
                
                // ã‚¢ã‚»ãƒƒãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ä½œæˆ
                this.assetManager = new window.spine.AssetManager(this.gl);
                
                console.log('âœ… Spine WebGLã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–å®Œäº†');
                console.log('   - SkeletonRenderer premultipliedAlpha:', this.skeletonRenderer.premultipliedAlpha);
            }
            
            /**
             * ã‚¢ã‚»ãƒƒãƒˆã®èª­ã¿è¾¼ã¿
             */
            async loadAssets() {
                this.updateStatus('asset-status', 'èª­ã¿è¾¼ã¿ä¸­...', false);
                
                // ã‚¢ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®äºˆç´„
                this.assetManager.loadJson('/assets/spine/characters/purattokun/purattokun.json');
                this.assetManager.loadTextureAtlas('/assets/spine/characters/purattokun/purattokun.atlas');
                
                console.log('ğŸ“¦ ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿é–‹å§‹...');
                
                // èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…æ©Ÿ
                await this.waitForAssets();
                
                // ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
                this.createSkeletonData();
                
                this.status.assetsLoaded = true;
                this.updateStatus('asset-status', 'èª­ã¿è¾¼ã¿å®Œäº†', false);
                
                console.log('âœ… ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
            }
            
            /**
             * ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å®Œäº†å¾…ã¡
             */
            waitForAssets() {
                return new Promise((resolve, reject) => {
                    const checkLoading = () => {
                        if (this.assetManager.isLoadingComplete()) {
                            if (this.assetManager.hasErrors()) {
                                const errors = this.assetManager.getErrors();
                                console.error('âŒ ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', errors);
                                reject(new Error('ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + errors.join(', ')));
                            } else {
                                resolve();
                            }
                        } else {
                            setTimeout(checkLoading, 50);
                        }
                    };
                    checkLoading();
                });
            }
            
            /**
             * ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
             */
            createSkeletonData() {
                // Atlaså–å¾—
                const atlas = this.assetManager.require('/assets/spine/characters/purattokun/purattokun.atlas');
                
                // JSONãƒ‡ãƒ¼ã‚¿å–å¾—
                const jsonData = this.assetManager.require('/assets/spine/characters/purattokun/purattokun.json');
                
                // SkeletonJsonä½œæˆ
                const skeletonJson = new window.spine.SkeletonJson(new window.spine.AtlasAttachmentLoader(atlas));
                const skeletonData = skeletonJson.readSkeletonData(jsonData);
                
                // ã‚¹ã‚±ãƒ«ãƒˆãƒ³ä½œæˆ
                this.skeleton = new window.spine.Skeleton(skeletonData);
                this.skeleton.setToSetupPose();
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ä½œæˆ
                this.animationStateData = new window.spine.AnimationStateData(skeletonData);
                this.animationState = new window.spine.AnimationState(this.animationStateData);
                
                // ä½ç½®ã¨ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®š
                this.skeleton.x = 0;
                this.skeleton.y = 0;
                this.skeleton.scaleX = this.skeleton.scaleY = 0.5;
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
                this.animationState.setAnimation(0, 'taiki', true);
                
                console.log('âœ… ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒ‡ãƒ¼ã‚¿ä½œæˆå®Œäº†');
            }
            
            /**
             * ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹
             */
            startRendering() {
                this.status.rendering = true;
                this.updateStatus('render-status', 'ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­', false);
                this.updateStatus('border-status', 'æ­£å¸¸ï¼ˆé»’æ ãªã—ï¼‰', false);
                
                let lastTime = 0;
                
                const render = (currentTime) => {
                    if (!this.status.rendering) return;
                    
                    try {
                        // æ™‚é–“æ›´æ–°
                        const delta = (currentTime - lastTime) / 1000;
                        lastTime = currentTime;
                        
                        if (this.animationState && this.skeleton) {
                            this.animationState.update(Math.min(delta, 0.1)); // æœ€å¤§0.1ç§’ã«åˆ¶é™
                            this.animationState.apply(this.skeleton);
                            this.skeleton.updateWorldTransform();
                        }
                        
                        // ç”»é¢ã‚¯ãƒªã‚¢
                        this.gl.clear(this.gl.COLOR_BUFFER_BIT);
                        
                        if (this.skeleton) {
                            // ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ãƒã‚¤ãƒ³ãƒ‰
                            this.shader.bind();
                            this.shader.setUniformi(window.spine.Shader.SAMPLER, 0);
                            
                            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è¡Œåˆ—ã®è¨­å®š
                            this.shader.setUniform4x4f(window.spine.Shader.MVP_MATRIX, 
                                this.calculateProjectionMatrix(this.canvas.width, this.canvas.height));
                            
                            // ãƒãƒƒãƒãƒ£ãƒ¼é–‹å§‹
                            this.batcher.begin(this.shader);
                            
                            // ã‚¹ã‚±ãƒ«ãƒˆãƒ³æç”»
                            this.skeletonRenderer.draw(this.batcher, this.skeleton);
                            
                            // ãƒãƒƒãƒãƒ£ãƒ¼çµ‚äº†
                            this.batcher.end();
                            
                            // ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼è§£é™¤
                            this.shader.unbind();
                        }
                        
                    } catch (error) {
                        console.error('âŒ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
                        this.updateStatus('render-status', 'ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼', true);
                        this.updateStatus('border-status', 'ã‚¨ãƒ©ãƒ¼æ¤œå‡º', true);
                        
                        // ã‚¨ãƒ©ãƒ¼ãŒé€£ç¶šã§ç™ºç”Ÿã™ã‚‹å ´åˆã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’åœæ­¢
                        if (error.message.includes('position')) {
                            console.warn('âš ï¸ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼ã®ãŸã‚ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ä¸€æ™‚åœæ­¢');
                            this.status.rendering = false;
                            return;
                        }
                    }
                    
                    requestAnimationFrame(render);
                };
                
                requestAnimationFrame(render);
                console.log('âœ… ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹');
            }
            
            /**
             * ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è¡Œåˆ—ã®è¨ˆç®—
             */
            calculateProjectionMatrix(width, height) {
                const ortho = new Float32Array(16);
                const left = 0;
                const right = width;
                const bottom = 0;
                const top = height;
                const near = -1;
                const far = 1;
                
                ortho[0] = 2 / (right - left);
                ortho[1] = 0;
                ortho[2] = 0;
                ortho[3] = 0;
                ortho[4] = 0;
                ortho[5] = 2 / (top - bottom);
                ortho[6] = 0;
                ortho[7] = 0;
                ortho[8] = 0;
                ortho[9] = 0;
                ortho[10] = -2 / (far - near);
                ortho[11] = 0;
                ortho[12] = -(right + left) / (right - left);
                ortho[13] = -(top + bottom) / (top - bottom);
                ortho[14] = -(far + near) / (far - near);
                ortho[15] = 1;
                
                return ortho;
            }
            
            /**
             * ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ
             */
            playAnimation(animationName) {
                if (!this.animationState) {
                    console.warn('âš ï¸ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                try {
                    this.animationState.setAnimation(0, animationName, animationName === 'taiki');
                    console.log(`ğŸ­ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ: ${animationName}`);
                } catch (error) {
                    console.error('âŒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            /**
             * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
             */
            updateStatus(elementId, message, isError = false) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = message;
                    element.className = isError ? 'status-error' : 'status-ok';
                }
            }
            
            /**
             * ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
             */
            toggleDebugInfo() {
                this.debugMode = !this.debugMode;
                const debugInfo = document.getElementById('debug-info');
                const debugContent = document.getElementById('debug-content');
                
                if (this.debugMode) {
                    debugInfo.style.display = 'block';
                    debugContent.innerHTML = this.getDebugInfo();
                } else {
                    debugInfo.style.display = 'none';
                }
            }
            
            /**
             * ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®å–å¾—
             */
            getDebugInfo() {
                const contextAttribs = this.gl ? this.gl.getContextAttributes() : null;
                
                return `
                    <h4>WebGLæƒ…å ±</h4>
                    <ul>
                        <li>premultipliedAlpha: ${contextAttribs ? contextAttribs.premultipliedAlpha : 'N/A'}</li>
                        <li>alpha: ${contextAttribs ? contextAttribs.alpha : 'N/A'}</li>
                        <li>antialias: ${contextAttribs ? contextAttribs.antialias : 'N/A'}</li>
                        <li>depth: ${contextAttribs ? contextAttribs.depth : 'N/A'}</li>
                        <li>stencil: ${contextAttribs ? contextAttribs.stencil : 'N/A'}</li>
                    </ul>
                    <h4>Spineãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼</h4>
                    <ul>
                        <li>SkeletonRenderer premultipliedAlpha: ${this.skeletonRenderer ? this.skeletonRenderer.premultipliedAlpha : 'N/A'}</li>
                        <li>ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹: ${this.animationState ? 'åˆæœŸåŒ–æ¸ˆã¿' : 'æœªåˆæœŸåŒ–'}</li>
                        <li>ã‚¹ã‚±ãƒ«ãƒˆãƒ³ä½ç½®: ${this.skeleton ? `(${this.skeleton.x}, ${this.skeleton.y})` : 'N/A'}</li>
                        <li>ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚¹ã‚±ãƒ¼ãƒ«: ${this.skeleton ? `${this.skeleton.scaleX}` : 'N/A'}</li>
                    </ul>
                    <h4>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h4>
                    <ul>
                        <li>Spineãƒ©ã‚¤ãƒ–ãƒ©ãƒª: ${this.status.spineLibrary ? 'âœ…' : 'âŒ'}</li>
                        <li>WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ: ${this.status.webglContext ? 'âœ…' : 'âŒ'}</li>
                        <li>ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿: ${this.status.assetsLoaded ? 'âœ…' : 'âŒ'}</li>
                        <li>ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°: ${this.status.rendering ? 'âœ…' : 'âŒ'}</li>
                    </ul>
                `;
            }
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let spineRenderer = null;
        
        /**
         * SpineåˆæœŸåŒ–é–¢æ•°
         */
        async function initializeSpine() {
            try {
                console.log('ğŸš€ SpineåˆæœŸåŒ–é–‹å§‹...');
                
                if (spineRenderer) {
                    console.log('âš ï¸ æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã§ã™');
                    return;
                }
                
                spineRenderer = new CleanSpineRenderer();
                await spineRenderer.initialize();
                
                console.log('ğŸ‰ SpineåˆæœŸåŒ–å®Œäº†ï¼');
                
            } catch (error) {
                console.error('âŒ SpineåˆæœŸåŒ–å¤±æ•—:', error);
                alert('SpineåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        /**
         * ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿé–¢æ•°
         */
        function playAnimation(animationName) {
            if (!spineRenderer) {
                console.warn('âš ï¸ Spineãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            spineRenderer.playAnimation(animationName);
        }
        
        /**
         * ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
         */
        function toggleDebugInfo() {
            if (!spineRenderer) {
                console.warn('âš ï¸ Spineãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            spineRenderer.toggleDebugInfo();
        }
        
        // è‡ªå‹•åˆæœŸåŒ–
        window.addEventListener('load', () => {
            console.log('ğŸ“„ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº† - è‡ªå‹•åˆæœŸåŒ–ã¯è¡Œã„ã¾ã›ã‚“');
            console.log('ğŸ”˜ "SpineåˆæœŸåŒ–"ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„');
        });
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', (event) => {
            console.error('ğŸš¨ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', event.error);
        });
        
        // WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–ªå¤±æ™‚ã®å‡¦ç†
        document.getElementById('purattokun-canvas').addEventListener('webglcontextlost', (event) => {
            console.warn('âš ï¸ WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒå¤±ã‚ã‚Œã¾ã—ãŸ');
            event.preventDefault();
        });
        
        document.getElementById('purattokun-canvas').addEventListener('webglcontextrestored', () => {
            console.log('ğŸ”„ WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒå¾©å…ƒã•ã‚Œã¾ã—ãŸ');
            // å†åˆæœŸåŒ–ãŒå¿…è¦ãªå ´åˆã¯ã“ã“ã§å®Ÿè¡Œ
        });
    </script>
</body>
</html>