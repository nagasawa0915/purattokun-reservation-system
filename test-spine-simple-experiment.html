<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 Spine読み込み実験 - シンプルテスト</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        
        .title {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: bold;
        }
        
        .control-panel {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .control-button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .primary-button {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
        }
        
        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,107,107,0.4);
        }
        
        .secondary-button {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            color: white;
        }
        
        .secondary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78,205,196,0.4);
        }
        
        .spine-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 20px;
            position: relative;
        }
        
        #spine-canvas {
            border: 2px solid #ddd;
            border-radius: 8px;
            background: transparent;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            padding: 20px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .status-loading { background: #ffa500; }
        .status-success { background: #00ff88; }
        .status-error { background: #ff4444; }
        
        .info-panel {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info-panel h3 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        
        .info-panel ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .info-panel li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">
            🧪 Spine読み込み実験 - ぷらっとくん
        </div>
        
        <div class="info-panel">
            <h3>🎯 実験内容</h3>
            <ul>
                <li><strong>対象キャラクター</strong>: ぷらっとくん (purattokun)</li>
                <li><strong>テスト項目</strong>: .atlas/.json/.png ファイルの読み込み確認</li>
                <li><strong>アニメーション</strong>: syutugen（出現） → taiki（待機） → yarare（やられ）</li>
                <li><strong>描画エンジン</strong>: Spine WebGL 4.1</li>
                <li><strong>マイクロモジュール</strong>: PureSpineLoader v4 を使用</li>
            </ul>
        </div>
        
        <div class="control-panel">
            <button class="control-button primary-button" onclick="startSpineTest()">
                🚀 Spine読み込み開始
            </button>
            <button class="control-button secondary-button" onclick="playAnimation('syutugen')">
                🎬 出現アニメ
            </button>
            <button class="control-button secondary-button" onclick="playAnimation('taiki')">
                😊 待機アニメ
            </button>
            <button class="control-button secondary-button" onclick="playAnimation('yarare')">
                😵 やられアニメ
            </button>
            <button class="control-button secondary-button" onclick="clearLog()">
                🗑️ ログクリア
            </button>
        </div>
        
        <div class="spine-container">
            <canvas id="spine-canvas" width="400" height="400"></canvas>
        </div>
        
        <div class="log-container" id="log-display">
            🧪 Spine読み込み実験ログ - 待機中...\n
        </div>
    </div>

    <!-- Spine WebGL Runtime -->
    <script src="assets/spine/spine-webgl.js"></script>
    
    <!-- PureSpineLoader v4 マイクロモジュール -->
    <script src="micromodules/spine-loader/PureSpineLoader.js"></script>

    <script>
        // グローバル変数
        let spineLoader = null;
        let spineApp = null;
        let skeleton = null;
        let animationState = null;
        let logDisplay = null;
        
        // 設定
        const CONFIG = {
            atlasPath: 'assets/spine/characters/purattokun/purattokun.atlas',
            jsonPath: 'assets/spine/characters/purattokun/purattokun.json',
            basePath: 'assets/spine/characters/purattokun/',
            scale: 0.4,
            canvasWidth: 400,
            canvasHeight: 400
        };

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            logDisplay = document.getElementById('log-display');
            log('🧪 Spine読み込み実験システム起動', 'success');
            log(`📁 対象ファイル: ${CONFIG.atlasPath}`, 'info');
            log(`📊 設定: スケール${CONFIG.scale} キャンバス${CONFIG.canvasWidth}x${CONFIG.canvasHeight}`, 'info');
        });

        // ログ表示関数
        function log(message, type = 'info') {
            if (!logDisplay) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const statusIcon = type === 'error' ? '❌' : 
                              type === 'success' ? '✅' : 
                              type === 'warning' ? '⚠️' : 'ℹ️';
            
            const logLine = `[${timestamp}] ${statusIcon} ${message}\n`;
            logDisplay.textContent += logLine;
            logDisplay.scrollTop = logDisplay.scrollHeight;
            
            console.log(`Spine実験: ${message}`);
        }

        // Spine読み込みテスト開始
        async function startSpineTest() {
            log('🚀 Spine読み込みテスト開始', 'info');
            
            try {
                // Canvas取得
                const canvas = document.getElementById('spine-canvas');
                if (!canvas) {
                    throw new Error('Canvas要素が見つかりません');
                }
                
                log('📐 Canvas初期化中...', 'info');
                
                // WebGLコンテキスト作成（最適化設定適用）
                const gl = canvas.getContext('webgl', {
                    alpha: true,                  // アルファチャンネル有効
                    premultipliedAlpha: true,     // プリマルチプライアルファ有効（重要）
                    antialias: true,              // アンチエイリアシング有効
                    depth: false,                 // デプステスト無効化
                    stencil: false               // ステンシルテスト無効化
                });
                
                if (!gl) {
                    throw new Error('WebGLコンテキストの作成に失敗しました');
                }
                
                log('✅ WebGLコンテキスト作成成功（最適化設定適用済み）', 'success');
                
                // PureSpineLoader初期化
                log('📦 PureSpineLoader初期化中...', 'info');
                spineLoader = new PureSpineLoader(CONFIG);
                
                // Spine読み込み実行
                log('📁 Spineファイル読み込み中...', 'info');
                const result = await spineLoader.execute();
                
                if (!result.loaded) {
                    throw new Error(result.error || 'Spine読み込みに失敗しました');
                }
                
                log('✅ Spineファイル読み込み成功', 'success');
                log(`📊 読み込み結果: atlas=${!!result.spineData.atlas}, skeleton=${!!result.spineData.skeletonData}`, 'info');
                
                // Spine WebGL初期化
                log('🎨 Spine WebGL初期化中...', 'info');
                
                // SpineGL設定
                const config = new spine.webgl.ManagedWebGLRenderingContext(gl);
                spineApp = new spine.webgl.SpineGL(canvas, config);
                
                // アセット読み込み
                const assetManager = spineApp.assetManager;
                assetManager.loadTextureAtlas('atlas', CONFIG.atlasPath);
                assetManager.loadText('skeleton', CONFIG.jsonPath);
                
                // 読み込み待機
                await new Promise((resolve, reject) => {
                    const checkLoading = () => {
                        if (assetManager.isLoadingComplete()) {
                            log('✅ Spineアセット読み込み完了', 'success');
                            resolve();
                        } else if (assetManager.hasErrors()) {
                            reject(new Error('Spineアセット読み込みエラー'));
                        } else {
                            setTimeout(checkLoading, 100);
                        }
                    };
                    checkLoading();
                });
                
                // スケルトン初期化（drawOrder検証強化）
                log('🦴 スケルトン初期化中...', 'info');
                
                const atlas = assetManager.get('atlas');
                const skeletonJson = new spine.SkeletonJson(assetManager);
                const skeletonData = skeletonJson.readSkeletonData(assetManager.get('skeleton'));
                
                skeleton = new spine.Skeleton(skeletonData);
                skeleton.scaleX = CONFIG.scale;
                skeleton.scaleY = CONFIG.scale;
                skeleton.x = CONFIG.canvasWidth / 2;
                skeleton.y = CONFIG.canvasHeight * 0.8;
                
                // **🔍 初期化直後のskeleton状態詳細診断**
                log('🔍 Skeleton初期状態診断中...', 'info');
                console.log('🔍 Skeleton初期状態:', {
                    skeletonExists: !!skeleton,
                    slotsExists: !!skeleton.slots,
                    slotsLength: skeleton.slots ? skeleton.slots.length : 0,
                    drawOrderExists: !!skeleton.drawOrder,
                    drawOrderType: typeof skeleton.drawOrder,
                    drawOrderLength: skeleton.drawOrder ? skeleton.drawOrder.length : 0,
                    drawOrderIsArray: Array.isArray(skeleton.drawOrder)
                });
                
                // **🚨 drawOrder初期検証**
                if (!skeleton.drawOrder) {
                    log('⚠️ drawOrder初期状態でundefined - 手動初期化実行', 'warning');
                    if (skeleton.slots && skeleton.slots.length > 0) {
                        skeleton.drawOrder = skeleton.slots.slice();
                        log(`🔧 drawOrder手動初期化: ${skeleton.drawOrder.length}スロット`, 'info');
                    } else {
                        throw new Error('slotsもdrawOrderも利用不可 - Skeleton初期化失敗');
                    }
                }
                
                skeleton.updateWorldTransform();
                
                // **🔍 updateWorldTransform後の状態再確認**
                console.log('🔍 updateWorldTransform後の状態:', {
                    drawOrderExists: !!skeleton.drawOrder,
                    drawOrderLength: skeleton.drawOrder ? skeleton.drawOrder.length : 0,
                    drawOrderIsArray: Array.isArray(skeleton.drawOrder),
                    firstSlot: skeleton.drawOrder && skeleton.drawOrder[0] ? 'OK' : 'NG'
                });
                
                if (!skeleton.drawOrder || !Array.isArray(skeleton.drawOrder) || skeleton.drawOrder.length === 0) {
                    throw new Error('updateWorldTransform後もdrawOrder問題が継続 - Skeleton初期化失敗');
                }
                
                // アニメーション初期化
                animationState = new spine.AnimationState(new spine.AnimationStateData(skeletonData));
                
                log('✅ スケルトン・アニメーション初期化完了（drawOrder検証済み）', 'success');
                log('🎬 デフォルトアニメーション（taiki）を開始します', 'info');
                
                // デフォルトアニメーション再生
                animationState.setAnimation(0, 'taiki', true);
                
                // 描画ループ開始
                startRenderLoop();
                
                log('🎉 Spine読み込み実験完全成功！', 'success');
                
            } catch (error) {
                log(`❌ Spine読み込み失敗: ${error.message}`, 'error');
                console.error('Spine読み込みエラー:', error);
            }
        }
        
        // アニメーション再生
        function playAnimation(animationName) {
            if (!animationState) {
                log('❌ アニメーション未初期化（先にSpine読み込みを実行してください）', 'error');
                return;
            }
            
            log(`🎬 アニメーション再生: ${animationName}`, 'info');
            
            try {
                if (animationName === 'syutugen') {
                    // 出現 → 待機の自然遷移
                    animationState.setAnimation(0, 'syutugen', false);
                    animationState.addAnimation(0, 'taiki', true, 0);
                    log('📋 出現→待機の自然遷移アニメーション設定', 'info');
                } else {
                    // 単発アニメーション
                    const loop = animationName === 'taiki';
                    animationState.setAnimation(0, animationName, loop);
                    log(`📋 ${animationName}アニメーション設定（ループ: ${loop}）`, 'info');
                }
            } catch (error) {
                log(`❌ アニメーション再生エラー: ${error.message}`, 'error');
                console.error('アニメーション再生エラー:', error);
            }
        }
        
        // 描画ループ（緊急修正版 - drawOrder徹底検証）
        function startRenderLoop() {
            let animationId = null; // レンダリングループID管理
            
            const render = (timestamp) => {
                // 緊急停止条件の徹底チェック
                if (!spineApp || !skeleton || !animationState) {
                    log('⚠️ 必要オブジェクト未初期化 - レンダリング停止', 'warning');
                    return;
                }
                
                try {
                    // **🚨 drawOrder状態の詳細診断（緊急追加）**
                    if (!skeleton.drawOrder) {
                        log('❌ skeleton.drawOrder が undefined - レンダリング緊急停止', 'error');
                        console.error('❌ skeleton.drawOrder詳細診断:', {
                            drawOrder: skeleton.drawOrder,
                            slots: skeleton.slots,
                            slotsLength: skeleton.slots ? skeleton.slots.length : 'undefined',
                            skeletonState: !!skeleton,
                            updateCallStatus: 'skeleton.updateWorldTransform() 実行前'
                        });
                        return; // 緊急停止
                    }
                    
                    if (!Array.isArray(skeleton.drawOrder)) {
                        log('❌ skeleton.drawOrder が配列ではありません - レンダリング緊急停止', 'error');
                        console.error('❌ drawOrder型エラー:', {
                            drawOrderType: typeof skeleton.drawOrder,
                            drawOrderValue: skeleton.drawOrder,
                            isArray: Array.isArray(skeleton.drawOrder)
                        });
                        return; // 緊急停止
                    }
                    
                    if (skeleton.drawOrder.length === 0) {
                        log('⚠️ skeleton.drawOrder が空配列 - スキップ', 'warning');
                        console.warn('⚠️ drawOrder空配列:', {
                            slotsCount: skeleton.slots ? skeleton.slots.length : 0,
                            drawOrderLength: skeleton.drawOrder.length
                        });
                        // 空配列の場合は描画をスキップするが、ループは継続
                        animationId = requestAnimationFrame(render);
                        return;
                    }
                    
                    // アニメーション更新（60fps想定）
                    animationState.update(0.016);
                    animationState.apply(skeleton);
                    skeleton.updateWorldTransform();
                    
                    // **🔍 updateWorldTransform後のdrawOrder再検証**
                    if (!skeleton.drawOrder || !Array.isArray(skeleton.drawOrder)) {
                        log('❌ updateWorldTransform後にdrawOrderが破損 - 手動再構築試行', 'error');
                        console.error('❌ updateWorldTransform後のdrawOrder状態:', {
                            drawOrder: skeleton.drawOrder,
                            slotsAvailable: !!skeleton.slots,
                            slotsLength: skeleton.slots ? skeleton.slots.length : 0
                        });
                        
                        // **🛠️ drawOrder手動再構築（緊急対応）**
                        if (skeleton.slots && skeleton.slots.length > 0) {
                            log('🔧 drawOrder手動再構築を試行', 'info');
                            skeleton.drawOrder = skeleton.slots.slice(); // スロットの浅いコピー
                            console.log('🔧 手動再構築結果:', {
                                newDrawOrderLength: skeleton.drawOrder.length,
                                sampleSlot: skeleton.drawOrder[0]
                            });
                        } else {
                            log('❌ slots配列も利用不可 - レンダリング完全停止', 'error');
                            return;
                        }
                    }
                    
                    // 画面クリア
                    const gl = spineApp.context.gl;
                    gl.clearColor(0, 0, 0, 0);
                    gl.clear(gl.COLOR_BUFFER_BIT);
                    
                    // **🎨 Spine描画（drawOrder検証済み）**
                    spineApp.sceneRenderer.begin();
                    spineApp.sceneRenderer.drawSkeleton(skeleton, false);
                    spineApp.sceneRenderer.end();
                    
                    // 正常描画完了時のみ次フレーム予約
                    animationId = requestAnimationFrame(render);
                    
                } catch (error) {
                    log(`❌ 描画エラー（緊急停止）: ${error.message}`, 'error');
                    console.error('❌ 完全エラー情報:', {
                        error: error,
                        stack: error.stack,
                        skeletonState: !!skeleton,
                        drawOrder: skeleton ? skeleton.drawOrder : 'skeleton undefined',
                        animationState: !!animationState,
                        spineApp: !!spineApp
                    });
                    
                    // **🚨 エラー時は完全停止（無限ループ防止）**
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                        animationId = null;
                    }
                    return;
                }
            };
            
            log('🔄 描画ループ開始（drawOrder検証強化版）', 'info');
            animationId = requestAnimationFrame(render);
            
            // **🛠️ 緊急停止用グローバル関数**
            window.emergencyStopRender = () => {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                    log('🚨 レンダリングループ緊急停止実行', 'error');
                }
            };
        }
        
        // ログクリア
        function clearLog() {
            if (logDisplay) {
                logDisplay.textContent = '🗑️ ログクリアされました\n';
            }
            log('🧪 ログクリア実行', 'info');
        }
        
        // クリーンアップ
        window.addEventListener('beforeunload', () => {
            if (spineLoader) {
                spineLoader.cleanup();
            }
            if (spineApp) {
                spineApp.dispose();
            }
        });
        
        // デバッグ用グローバル関数
        window.spineDebug = {
            getLoader: () => spineLoader,
            getSkeleton: () => skeleton,
            getAnimationState: () => animationState,
            getApp: () => spineApp,
            config: CONFIG
        };
        
        // 初期化完了ログ
        console.log('🧪 Spine読み込み実験システム初期化完了');
        console.log('デバッグ用: window.spineDebug でアクセス可能');
    </script>
</body>
</html>