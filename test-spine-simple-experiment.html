<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª Spineèª­ã¿è¾¼ã¿å®Ÿé¨“ - ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        
        .title {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: bold;
        }
        
        .control-panel {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .control-button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .primary-button {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
        }
        
        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,107,107,0.4);
        }
        
        .secondary-button {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            color: white;
        }
        
        .secondary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78,205,196,0.4);
        }
        
        .spine-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 20px;
            position: relative;
        }
        
        #spine-canvas {
            border: 2px solid #ddd;
            border-radius: 8px;
            background: transparent;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            padding: 20px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .status-loading { background: #ffa500; }
        .status-success { background: #00ff88; }
        .status-error { background: #ff4444; }
        
        .info-panel {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info-panel h3 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        
        .info-panel ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .info-panel li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">
            ğŸ§ª Spineèª­ã¿è¾¼ã¿å®Ÿé¨“ - ã·ã‚‰ã£ã¨ãã‚“
        </div>
        
        <div class="info-panel">
            <h3>ğŸ¯ å®Ÿé¨“å†…å®¹</h3>
            <ul>
                <li><strong>å¯¾è±¡ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</strong>: ã·ã‚‰ã£ã¨ãã‚“ (purattokun)</li>
                <li><strong>ãƒ†ã‚¹ãƒˆé …ç›®</strong>: .atlas/.json/.png ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ç¢ºèª</li>
                <li><strong>ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</strong>: syutugenï¼ˆå‡ºç¾ï¼‰ â†’ taikiï¼ˆå¾…æ©Ÿï¼‰ â†’ yarareï¼ˆã‚„ã‚‰ã‚Œï¼‰</li>
                <li><strong>æç”»ã‚¨ãƒ³ã‚¸ãƒ³</strong>: Spine WebGL 4.1</li>
                <li><strong>ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«</strong>: PureSpineLoader v4 ã‚’ä½¿ç”¨</li>
            </ul>
        </div>
        
        <div class="control-panel">
            <button class="control-button primary-button" onclick="startSpineTest()">
                ğŸš€ Spineèª­ã¿è¾¼ã¿é–‹å§‹
            </button>
            <button class="control-button secondary-button" onclick="playAnimation('syutugen')">
                ğŸ¬ å‡ºç¾ã‚¢ãƒ‹ãƒ¡
            </button>
            <button class="control-button secondary-button" onclick="playAnimation('taiki')">
                ğŸ˜Š å¾…æ©Ÿã‚¢ãƒ‹ãƒ¡
            </button>
            <button class="control-button secondary-button" onclick="playAnimation('yarare')">
                ğŸ˜µ ã‚„ã‚‰ã‚Œã‚¢ãƒ‹ãƒ¡
            </button>
            <button class="control-button secondary-button" onclick="clearLog()">
                ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢
            </button>
        </div>
        
        <div class="spine-container">
            <canvas id="spine-canvas" width="400" height="400"></canvas>
        </div>
        
        <div class="log-container" id="log-display">
            ğŸ§ª Spineèª­ã¿è¾¼ã¿å®Ÿé¨“ãƒ­ã‚° - å¾…æ©Ÿä¸­...\n
        </div>
    </div>

    <!-- Spine WebGL Runtime -->
    <script src="assets/spine/spine-webgl.js"></script>
    
    <!-- PureSpineLoader v4 ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    <script src="micromodules/spine-loader/PureSpineLoader.js"></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let spineLoader = null;
        let spineApp = null;
        let skeleton = null;
        let animationState = null;
        let logDisplay = null;
        
        // è¨­å®š
        const CONFIG = {
            atlasPath: 'assets/spine/characters/purattokun/purattokun.atlas',
            jsonPath: 'assets/spine/characters/purattokun/purattokun.json',
            basePath: 'assets/spine/characters/purattokun/',
            scale: 0.4,
            canvasWidth: 400,
            canvasHeight: 400
        };

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logDisplay = document.getElementById('log-display');
            log('ğŸ§ª Spineèª­ã¿è¾¼ã¿å®Ÿé¨“ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•', 'success');
            log(`ğŸ“ å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: ${CONFIG.atlasPath}`, 'info');
            log(`ğŸ“Š è¨­å®š: ã‚¹ã‚±ãƒ¼ãƒ«${CONFIG.scale} ã‚­ãƒ£ãƒ³ãƒã‚¹${CONFIG.canvasWidth}x${CONFIG.canvasHeight}`, 'info');
        });

        // ãƒ­ã‚°è¡¨ç¤ºé–¢æ•°
        function log(message, type = 'info') {
            if (!logDisplay) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const statusIcon = type === 'error' ? 'âŒ' : 
                              type === 'success' ? 'âœ…' : 
                              type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            
            const logLine = `[${timestamp}] ${statusIcon} ${message}\n`;
            logDisplay.textContent += logLine;
            logDisplay.scrollTop = logDisplay.scrollHeight;
            
            console.log(`Spineå®Ÿé¨“: ${message}`);
        }

        // Spineèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆé–‹å§‹
        async function startSpineTest() {
            log('ğŸš€ Spineèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            
            try {
                // Canvaså–å¾—
                const canvas = document.getElementById('spine-canvas');
                if (!canvas) {
                    throw new Error('Canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                log('ğŸ“ CanvasåˆæœŸåŒ–ä¸­...', 'info');
                
                // WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆï¼ˆæœ€é©åŒ–è¨­å®šé©ç”¨ï¼‰
                const gl = canvas.getContext('webgl', {
                    alpha: true,                  // ã‚¢ãƒ«ãƒ•ã‚¡ãƒãƒ£ãƒ³ãƒãƒ«æœ‰åŠ¹
                    premultipliedAlpha: true,     // ãƒ—ãƒªãƒãƒ«ãƒãƒ—ãƒ©ã‚¤ã‚¢ãƒ«ãƒ•ã‚¡æœ‰åŠ¹ï¼ˆé‡è¦ï¼‰
                    antialias: true,              // ã‚¢ãƒ³ãƒã‚¨ã‚¤ãƒªã‚¢ã‚·ãƒ³ã‚°æœ‰åŠ¹
                    depth: false,                 // ãƒ‡ãƒ—ã‚¹ãƒ†ã‚¹ãƒˆç„¡åŠ¹åŒ–
                    stencil: false               // ã‚¹ãƒ†ãƒ³ã‚·ãƒ«ãƒ†ã‚¹ãƒˆç„¡åŠ¹åŒ–
                });
                
                if (!gl) {
                    throw new Error('WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                log('âœ… WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆæˆåŠŸï¼ˆæœ€é©åŒ–è¨­å®šé©ç”¨æ¸ˆã¿ï¼‰', 'success');
                
                // PureSpineLoaderåˆæœŸåŒ–
                log('ğŸ“¦ PureSpineLoaderåˆæœŸåŒ–ä¸­...', 'info');
                spineLoader = new PureSpineLoader(CONFIG);
                
                // Spineèª­ã¿è¾¼ã¿å®Ÿè¡Œ
                log('ğŸ“ Spineãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­...', 'info');
                const result = await spineLoader.execute();
                
                if (!result.loaded) {
                    throw new Error(result.error || 'Spineèª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                log('âœ… Spineãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ', 'success');
                log(`ğŸ“Š èª­ã¿è¾¼ã¿çµæœ: atlas=${!!result.spineData.atlas}, skeleton=${!!result.spineData.skeletonData}`, 'info');
                
                // Spine WebGLåˆæœŸåŒ–
                log('ğŸ¨ Spine WebGLåˆæœŸåŒ–ä¸­...', 'info');
                
                // SpineGLè¨­å®š
                const config = new spine.webgl.ManagedWebGLRenderingContext(gl);
                spineApp = new spine.webgl.SpineGL(canvas, config);
                
                // ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿
                const assetManager = spineApp.assetManager;
                assetManager.loadTextureAtlas('atlas', CONFIG.atlasPath);
                assetManager.loadText('skeleton', CONFIG.jsonPath);
                
                // èª­ã¿è¾¼ã¿å¾…æ©Ÿ
                await new Promise((resolve, reject) => {
                    const checkLoading = () => {
                        if (assetManager.isLoadingComplete()) {
                            log('âœ… Spineã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å®Œäº†', 'success');
                            resolve();
                        } else if (assetManager.hasErrors()) {
                            reject(new Error('Spineã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'));
                        } else {
                            setTimeout(checkLoading, 100);
                        }
                    };
                    checkLoading();
                });
                
                // ã‚¹ã‚±ãƒ«ãƒˆãƒ³åˆæœŸåŒ–
                log('ğŸ¦´ ã‚¹ã‚±ãƒ«ãƒˆãƒ³åˆæœŸåŒ–ä¸­...', 'info');
                
                const atlas = assetManager.get('atlas');
                const skeletonJson = new spine.SkeletonJson(assetManager);
                const skeletonData = skeletonJson.readSkeletonData(assetManager.get('skeleton'));
                
                skeleton = new spine.Skeleton(skeletonData);
                skeleton.scaleX = CONFIG.scale;
                skeleton.scaleY = CONFIG.scale;
                skeleton.x = CONFIG.canvasWidth / 2;
                skeleton.y = CONFIG.canvasHeight * 0.8;
                skeleton.updateWorldTransform();
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
                animationState = new spine.AnimationState(new spine.AnimationStateData(skeletonData));
                
                log('âœ… ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒ»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å®Œäº†', 'success');
                log('ğŸ¬ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆtaikiï¼‰ã‚’é–‹å§‹ã—ã¾ã™', 'info');
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ
                animationState.setAnimation(0, 'taiki', true);
                
                // æç”»ãƒ«ãƒ¼ãƒ—é–‹å§‹
                startRenderLoop();
                
                log('ğŸ‰ Spineèª­ã¿è¾¼ã¿å®Ÿé¨“å®Œå…¨æˆåŠŸï¼', 'success');
                
            } catch (error) {
                log(`âŒ Spineèª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}`, 'error');
                console.error('Spineèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ
        function playAnimation(animationName) {
            if (!animationState) {
                log('âŒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æœªåˆæœŸåŒ–ï¼ˆå…ˆã«Spineèª­ã¿è¾¼ã¿ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼‰', 'error');
                return;
            }
            
            log(`ğŸ¬ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ: ${animationName}`, 'info');
            
            try {
                if (animationName === 'syutugen') {
                    // å‡ºç¾ â†’ å¾…æ©Ÿã®è‡ªç„¶é·ç§»
                    animationState.setAnimation(0, 'syutugen', false);
                    animationState.addAnimation(0, 'taiki', true, 0);
                    log('ğŸ“‹ å‡ºç¾â†’å¾…æ©Ÿã®è‡ªç„¶é·ç§»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š', 'info');
                } else {
                    // å˜ç™ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    const loop = animationName === 'taiki';
                    animationState.setAnimation(0, animationName, loop);
                    log(`ğŸ“‹ ${animationName}ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šï¼ˆãƒ«ãƒ¼ãƒ—: ${loop}ï¼‰`, 'info');
                }
            } catch (error) {
                log(`âŒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // æç”»ãƒ«ãƒ¼ãƒ—
        function startRenderLoop() {
            const render = (timestamp) => {
                if (!spineApp || !skeleton || !animationState) {
                    return;
                }
                
                try {
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°ï¼ˆ60fpsæƒ³å®šï¼‰
                    animationState.update(0.016);
                    animationState.apply(skeleton);
                    skeleton.updateWorldTransform();
                    
                    // ç”»é¢ã‚¯ãƒªã‚¢
                    const gl = spineApp.context.gl;
                    gl.clearColor(0, 0, 0, 0);
                    gl.clear(gl.COLOR_BUFFER_BIT);
                    
                    // Spineæç”»
                    spineApp.sceneRenderer.begin();
                    spineApp.sceneRenderer.drawSkeleton(skeleton, false);
                    spineApp.sceneRenderer.end();
                    
                } catch (error) {
                    log(`âŒ æç”»ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    console.error('æç”»ã‚¨ãƒ©ãƒ¼:', error);
                    return; // æç”»ãƒ«ãƒ¼ãƒ—åœæ­¢
                }
                
                requestAnimationFrame(render);
            };
            
            log('ğŸ”„ æç”»ãƒ«ãƒ¼ãƒ—é–‹å§‹', 'info');
            requestAnimationFrame(render);
        }
        
        // ãƒ­ã‚°ã‚¯ãƒªã‚¢
        function clearLog() {
            if (logDisplay) {
                logDisplay.textContent = 'ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ\n';
            }
            log('ğŸ§ª ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Ÿè¡Œ', 'info');
        }
        
        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (spineLoader) {
                spineLoader.cleanup();
            }
            if (spineApp) {
                spineApp.dispose();
            }
        });
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        window.spineDebug = {
            getLoader: () => spineLoader,
            getSkeleton: () => skeleton,
            getAnimationState: () => animationState,
            getApp: () => spineApp,
            config: CONFIG
        };
        
        // åˆæœŸåŒ–å®Œäº†ãƒ­ã‚°
        console.log('ğŸ§ª Spineèª­ã¿è¾¼ã¿å®Ÿé¨“ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
        console.log('ãƒ‡ãƒãƒƒã‚°ç”¨: window.spineDebug ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½');
    </script>
</body>
</html>