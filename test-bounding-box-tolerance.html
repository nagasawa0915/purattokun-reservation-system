<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ PureBoundingBox Toleranceã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .hero-section {
            position: relative;
            width: 80vw;
            max-width: 800px;
            min-width: 400px;
            height: 60vh;
            min-height: 300px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            margin: 20px auto;
            overflow: visible;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        
        .layout-anchor {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 100px;
            height: 80px;
            background: rgba(255, 107, 107, 0.9);
            border-radius: 8px;
            transform: translate(-50%, -50%);
            z-index: 10;
            border: 3px solid #ff6b6b;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        .layout-anchor .interactive {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 70%;
            background: white;
            border-radius: 4px;
            transform: translate(-50%, -50%) translate(var(--tx, 0px), var(--ty, 0px));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }
        
        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 100;
            min-width: 250px;
        }
        
        .control-panel h3 {
            margin-top: 0;
            color: #007bff;
            font-size: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        .control-group {
            margin: 10px 0;
        }
        
        .control-group label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .control-group input, select, button {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .control-group button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin: 2px 0;
        }
        
        .control-group button:hover {
            background: #0056b3;
        }
        
        .status-panel {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 11px;
            line-height: 1.4;
        }
        
        .tolerance-display {
            background: #e8f5e8;
            border: 1px solid #28a745;
            padding: 8px;
            border-radius: 4px;
            margin: 8px 0;
        }
        
        .tolerance-display.warning {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .tolerance-display.error {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        /* ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºãƒ†ã‚¹ãƒˆç”¨ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¨­å®š */
        @media (max-width: 768px) {
            .hero-section {
                width: 95vw;
                height: 50vh;
            }
            
            .control-panel {
                position: static;
                margin: 20px auto;
                max-width: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¯ PureBoundingBox Toleranceã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ</h1>
        <p>è¨±å®¹ç¯„å›²å†…èª¤å·®æ–¹å¼ã®ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã™ã€‚ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ãƒªã‚µã‚¤ã‚ºã—ã¦ä½ç½®å¾©å…ƒã®ç²¾åº¦ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
        
        <div class="hero-section" id="hero-section">
            <div class="layout-anchor" id="test-anchor">
                <div class="interactive">
                    ğŸ¯ Test Element<br>
                    Tolerance Test
                </div>
            </div>
        </div>
        
        <div class="control-panel">
            <h3>ğŸ”§ Toleranceã‚·ã‚¹ãƒ†ãƒ åˆ¶å¾¡</h3>
            
            <div class="control-group">
                <label>Tolerance (px):</label>
                <input type="range" id="tolerance-slider" min="0" max="20" value="5" step="1">
                <span id="tolerance-value">5px</span>
            </div>
            
            <div class="control-group">
                <label>Gentle Correction Ratio:</label>
                <input type="range" id="correction-slider" min="0" max="1" value="0.5" step="0.1">
                <span id="correction-value">0.5</span>
            </div>
            
            <div class="control-group">
                <button onclick="testToleranceSystem()">ğŸ§ª Toleranceãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                <button onclick="simulateWindowResize()">ğŸ“ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ¨¡æ“¬</button>
                <button onclick="resetPosition()">ğŸ”„ ä½ç½®ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            
            <div class="control-group">
                <label>ğŸ¯ ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯å¾®èª¿æ•´:</label>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 4px;">
                    <button onclick="quickAdjust(-5, -5)" style="font-size: 10px;">â†– -5px</button>
                    <button onclick="quickAdjust(0, -5)" style="font-size: 10px;">â†‘ -5px</button>
                    <button onclick="quickAdjust(5, -5)" style="font-size: 10px;">â†— -5px</button>
                    <button onclick="quickAdjust(-5, 0)" style="font-size: 10px;">â† -5px</button>
                    <button onclick="quickCenter()" style="font-size: 10px;">ğŸ¯ ä¸­å¤®</button>
                    <button onclick="quickAdjust(5, 0)" style="font-size: 10px;">â†’ +5px</button>
                    <button onclick="quickAdjust(-5, 5)" style="font-size: 10px;">â†™ +5px</button>
                    <button onclick="quickAdjust(0, 5)" style="font-size: 10px;">â†“ +5px</button>
                    <button onclick="quickAdjust(5, 5)" style="font-size: 10px;">â†˜ +5px</button>
                </div>
            </div>
            
            <div class="control-group">
                <button onclick="autoCorrect()">âœ¨ è‡ªå‹•è£œæ­£å®Ÿè¡Œ</button>
                <button onclick="commitToleranceCorrection()">ğŸ’¾ Toleranceè£œæ­£ç¢ºå®š</button>
            </div>
            
            <div class="tolerance-display" id="tolerance-status">
                <strong>ğŸ“Š Toleranceã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong><br>
                å¾…æ©Ÿä¸­...
            </div>
            
            <div class="status-panel" id="debug-info">
                <strong>ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>
                ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...
            </div>
        </div>
    </div>

    <!-- å¿…è¦ãªãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿ -->
    <script src="micromodules/bounding-box/PureBoundingBoxCore.js"></script>
    <script src="micromodules/bounding-box/AutoPinConfigManager.js"></script>
    <script src="micromodules/bounding-box/AnchorCalculator.js"></script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let toleranceCore = null;
        let toleranceSettings = {
            tolerancePx: 5,
            gentleCorrectionRatio: 0.5
        };
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeToleranceTest();
            setupEventListeners();
        });
        
        function initializeToleranceTest() {
            const targetElement = document.getElementById('test-anchor');
            
            // Toleranceã‚·ã‚¹ãƒ†ãƒ çµ±åˆCoreåˆæœŸåŒ–
            toleranceCore = new PureBoundingBoxCore({
                targetElement: targetElement,
                nodeId: 'tolerance-test',
                tolerancePx: toleranceSettings.tolerancePx,
                gentleCorrectionRatio: toleranceSettings.gentleCorrectionRatio
            });
            
            updateDebugInfo('âœ… Toleranceã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
            console.log('ğŸ¯ Toleranceãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
        }
        
        function setupEventListeners() {
            const toleranceSlider = document.getElementById('tolerance-slider');
            const correctionSlider = document.getElementById('correction-slider');
            
            toleranceSlider.addEventListener('input', function() {
                toleranceSettings.tolerancePx = parseInt(this.value);
                document.getElementById('tolerance-value').textContent = this.value + 'px';
                updateToleranceSettings();
            });
            
            correctionSlider.addEventListener('input', function() {
                toleranceSettings.gentleCorrectionRatio = parseFloat(this.value);
                document.getElementById('correction-value').textContent = this.value;
                updateToleranceSettings();
            });
            
            // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆ
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    testToleranceSystem();
                }, 300);
            });
        }
        
        function updateToleranceSettings() {
            if (toleranceCore) {
                toleranceCore.config.tolerancePx = toleranceSettings.tolerancePx;
                toleranceCore.config.gentleCorrectionRatio = toleranceSettings.gentleCorrectionRatio;
                
                updateDebugInfo(`âš™ï¸ Toleranceæ›´æ–°: ${toleranceSettings.tolerancePx}px, è£œæ­£æ¯”ç‡: ${toleranceSettings.gentleCorrectionRatio}`);
            }
        }
        
        function testToleranceSystem() {
            if (!toleranceCore) {
                updateToleranceStatus('âŒ ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            const targetElement = document.getElementById('test-anchor');
            const parentElement = document.getElementById('hero-section');
            
            // ç¾åœ¨ã®ä½ç½®æƒ…å ±ã‚’å–å¾—
            const targetRect = targetElement.getBoundingClientRect();
            const parentRect = parentElement.getBoundingClientRect();
            
            // CSSå¤‰æ•°ã‹ã‚‰ç¾åœ¨ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’å–å¾—
            const interactive = targetElement.querySelector('.interactive');
            const cs = getComputedStyle(interactive);
            const tx = parseFloat(cs.getPropertyValue('--tx')) || 0;
            const ty = parseFloat(cs.getPropertyValue('--ty')) || 0;
            
            // Toleranceãƒã‚§ãƒƒã‚¯
            const withinToleranceX = Math.abs(tx) <= toleranceSettings.tolerancePx;
            const withinToleranceY = Math.abs(ty) <= toleranceSettings.tolerancePx;
            const isWithinTolerance = withinToleranceX && withinToleranceY;
            
            // çµæœè¡¨ç¤º
            let statusClass = 'tolerance-display';
            let statusText = '';
            
            if (isWithinTolerance) {
                statusClass += '';
                statusText = `âœ… è¨±å®¹ç¯„å›²å†…: Î”X=${tx.toFixed(1)}px, Î”Y=${ty.toFixed(1)}px<br>è£œæ­£ä¸è¦`;
            } else {
                statusClass += ' warning';
                const correctedTx = tx * toleranceSettings.gentleCorrectionRatio;
                const correctedTy = ty * toleranceSettings.gentleCorrectionRatio;
                statusText = `âš ï¸ è¨±å®¹ç¯„å›²å¤–: Î”X=${tx.toFixed(1)}px, Î”Y=${ty.toFixed(1)}px<br>è£œæ­£å¾Œ: Î”X=${correctedTx.toFixed(1)}px, Î”Y=${correctedTy.toFixed(1)}px`;
            }
            
            updateToleranceStatus(statusText, statusClass);
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°
            updateDebugInfo(`ğŸ§ª Toleranceãƒ†ã‚¹ãƒˆå®Œäº†<br>
                ä½ç½®: ${targetRect.left.toFixed(1)}, ${targetRect.top.toFixed(1)}<br>
                è¦ªã‚µã‚¤ã‚º: ${parentRect.width.toFixed(1)}Ã—${parentRect.height.toFixed(1)}<br>
                CSSå¤‰æ•°: --tx=${tx.toFixed(1)}px, --ty=${ty.toFixed(1)}px<br>
                è¨±å®¹ç¯„å›²: ${toleranceSettings.tolerancePx}px`);
            
            console.log('ğŸ¯ Toleranceãƒ†ã‚¹ãƒˆçµæœ:', {
                offset: {tx: tx, ty: ty},
                tolerance: toleranceSettings.tolerancePx,
                withinTolerance: isWithinTolerance,
                correctionRatio: toleranceSettings.gentleCorrectionRatio
            });
        }
        
        function simulateWindowResize() {
            const heroSection = document.getElementById('hero-section');
            const currentWidth = heroSection.style.width || '80vw';
            
            // å¹…ã‚’ä¸€æ™‚çš„ã«å¤‰æ›´ã—ã¦ãƒªã‚µã‚¤ã‚ºã‚’æ¨¡æ“¬
            heroSection.style.width = currentWidth === '80vw' ? '60vw' : '80vw';
            
            setTimeout(() => {
                testToleranceSystem();
            }, 100);
            
            updateDebugInfo('ğŸ“ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ¨¡æ“¬å®Ÿè¡Œ');
        }
        
        function resetPosition() {
            const targetElement = document.getElementById('test-anchor');
            const interactive = targetElement.querySelector('.interactive');
            
            // ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
            targetElement.style.left = '50%';
            targetElement.style.top = '50%';
            interactive.style.setProperty('--tx', '0px');
            interactive.style.setProperty('--ty', '0px');
            
            updateToleranceStatus('ğŸ”„ ä½ç½®ãƒªã‚»ãƒƒãƒˆå®Œäº†', '');
            updateDebugInfo('ğŸ”„ ä½ç½®ãƒªã‚»ãƒƒãƒˆå®Œäº† - ä¸­å¤®ä½ç½®ã«å¾©å¸°');
            
            setTimeout(() => {
                testToleranceSystem();
            }, 100);
        }
        
        function updateToleranceStatus(message, className = '') {
            const statusElement = document.getElementById('tolerance-status');
            statusElement.innerHTML = '<strong>ğŸ“Š Toleranceã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong><br>' + message;
            statusElement.className = className || 'tolerance-display';
        }
        
        function updateDebugInfo(message) {
            const debugElement = document.getElementById('debug-info');
            debugElement.innerHTML = '<strong>ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>' + message;
        }
        
        // ğŸ†• ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Šæ©Ÿèƒ½
        function quickAdjust(deltaX, deltaY) {
            const targetElement = document.getElementById('test-anchor');
            const interactive = targetElement.querySelector('.interactive');
            
            // ç¾åœ¨ã®CSSå¤‰æ•°ã‚’å–å¾—
            const cs = getComputedStyle(interactive);
            const currentTx = parseFloat(cs.getPropertyValue('--tx')) || 0;
            const currentTy = parseFloat(cs.getPropertyValue('--ty')) || 0;
            
            // æ–°ã—ã„å€¤ã‚’è¨­å®š
            const newTx = currentTx + deltaX;
            const newTy = currentTy + deltaY;
            
            interactive.style.setProperty('--tx', newTx + 'px');
            interactive.style.setProperty('--ty', newTy + 'px');
            
            updateDebugInfo(`ğŸ¯ ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯å¾®èª¿æ•´: Î”X=${deltaX}px, Î”Y=${deltaY}px<br>æ–°ã—ã„ä½ç½®: --tx=${newTx.toFixed(1)}px, --ty=${newTy.toFixed(1)}px`);
            
            setTimeout(() => {
                testToleranceSystem();
            }, 100);
        }
        
        function quickCenter() {
            const targetElement = document.getElementById('test-anchor');
            const interactive = targetElement.querySelector('.interactive');
            
            // ä¸­å¤®ã«æˆ»ã™
            interactive.style.setProperty('--tx', '0px');
            interactive.style.setProperty('--ty', '0px');
            
            updateDebugInfo('ğŸ¯ ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ä¸­å¤®å¾©å¸°å®Œäº†');
            
            setTimeout(() => {
                testToleranceSystem();
            }, 100);
        }
        
        function autoCorrect() {
            if (!toleranceCore) {
                updateToleranceStatus('âŒ ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            const targetElement = document.getElementById('test-anchor');
            const interactive = targetElement.querySelector('.interactive');
            
            // ç¾åœ¨ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’å–å¾—
            const cs = getComputedStyle(interactive);
            const tx = parseFloat(cs.getPropertyValue('--tx')) || 0;
            const ty = parseFloat(cs.getPropertyValue('--ty')) || 0;
            
            // Toleranceæ–¹å¼ã§è‡ªå‹•è£œæ­£
            const txTolerant = Math.abs(tx) <= toleranceSettings.tolerancePx ? 0 : tx * toleranceSettings.gentleCorrectionRatio;
            const tyTolerant = Math.abs(ty) <= toleranceSettings.tolerancePx ? 0 : ty * toleranceSettings.gentleCorrectionRatio;
            
            // è£œæ­£ã‚’é©ç”¨
            interactive.style.setProperty('--tx', txTolerant + 'px');
            interactive.style.setProperty('--ty', tyTolerant + 'px');
            
            updateDebugInfo(`âœ¨ è‡ªå‹•è£œæ­£å®Ÿè¡Œ<br>
                è£œæ­£å‰: --tx=${tx.toFixed(1)}px, --ty=${ty.toFixed(1)}px<br>
                è£œæ­£å¾Œ: --tx=${txTolerant.toFixed(1)}px, --ty=${tyTolerant.toFixed(1)}px<br>
                Tolerance: ${toleranceSettings.tolerancePx}px, è£œæ­£æ¯”ç‡: ${toleranceSettings.gentleCorrectionRatio}`);
            
            updateToleranceStatus('âœ¨ è‡ªå‹•è£œæ­£ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ', 'tolerance-display');
            
            setTimeout(() => {
                testToleranceSystem();
            }, 100);
        }
        
        function commitToleranceCorrection() {
            if (!toleranceCore) {
                updateToleranceStatus('âŒ ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            // PureBoundingBoxCoreã®commitToPercent()ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—
            const success = toleranceCore.commitToPercent();
            
            if (success) {
                updateToleranceStatus('ğŸ’¾ Toleranceè£œæ­£ç¢ºå®šå®Œäº†', 'tolerance-display');
                updateDebugInfo('ğŸ’¾ Toleranceè£œæ­£ç¢ºå®š - %å€¤ã«å¤‰æ›ã—ã¦å›ºå®šã•ã‚Œã¾ã—ãŸ');
            } else {
                updateToleranceStatus('âŒ Toleranceè£œæ­£ç¢ºå®šå¤±æ•—', 'error');
                updateDebugInfo('âŒ Toleranceè£œæ­£ç¢ºå®šã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            
            setTimeout(() => {
                testToleranceSystem();
            }, 200);
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‚’windowã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ 
        window.testToleranceSystem = testToleranceSystem;
        window.simulateWindowResize = simulateWindowResize;
        window.resetPosition = resetPosition;
        window.quickAdjust = quickAdjust;
        window.quickCenter = quickCenter;
        window.autoCorrect = autoCorrect;
        window.commitToleranceCorrection = commitToleranceCorrection;
    </script>
</body>
</html>