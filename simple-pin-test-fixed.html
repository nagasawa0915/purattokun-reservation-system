<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ ã‚·ãƒ³ãƒ—ãƒ«ãƒ”ãƒ³ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¤ãƒ¡ãƒ¼ã‚¸ */
        .hero-section {
            position: relative;
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, rgba(0,0,0,0.4), rgba(0,0,0,0.2)), 
                        url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80') no-repeat center;
            background-size: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        
        .hero-section::after {
            content: "ğŸ¯ ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒªã‚¢\A(èƒŒæ™¯ç”»åƒ: background-size: cover)";
            white-space: pre;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            background: rgba(0,0,0,0.3);
            padding: 16px;
            border-radius: 8px;
        }
        
        /* ç”»åƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .image-section {
            position: relative;
            width: 300px;
            height: 200px;
            margin: 30px auto;
            background: url('https://images.unsplash.com/photo-1516026672322-bc52d61a55d5?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80') no-repeat center;
            background-size: cover;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
        
        .image-section::after {
            content: "ğŸ“¸ ãƒ†ã‚¹ãƒˆç”»åƒ\A(300px Ã— 200px)";
            white-space: pre;
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            font-size: 14px;
        }
        
        /* ãƒ†ã‚­ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .text-section {
            padding: 40px;
        }
        
        .text-section h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 16px;
            border-bottom: 3px solid #ff6b35;
            padding-bottom: 8px;
        }
        
        .text-section p {
            font-size: 16px;
            line-height: 1.6;
            color: #666;
            margin-bottom: 16px;
        }
        
        /* Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ */
        #spine-canvas {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 400px;    /* æ˜ç¤ºçš„ã‚µã‚¤ã‚ºæŒ‡å®šã§ç¸¦æ¨ªæ¯”æ­ªã¿é˜²æ­¢ */
            height: 400px;   /* HTMLå±æ€§ã¨ä¸€è‡´ã•ã›ã‚‹ */
            z-index: 1000;
            border-radius: 4px;
        }
        
        /* ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 2000;
        }
        
        .control-button {
            display: block;
            width: 100%;
            margin: 4px 0;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #ff6b35;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .control-button:hover {
            background: #e55a2d;
            transform: translateY(-1px);
        }
        
        .control-button.secondary {
            background: #6c757d;
        }
        
        .control-button.secondary:hover {
            background: #5a6268;
        }
        
        /* ãƒ­ã‚°ãƒ‘ãƒãƒ« */
        .log-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 400px;
            max-height: 200px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            overflow-y: auto;
            z-index: 2000;
        }
        
        /* ğŸ¯ AutoPinåˆ†é›¢è¨ºæ–­ãƒ‘ãƒãƒ« */
        .separation-diagnosis-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #ff6b35;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 3000;
            min-width: 500px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }
        
        .separation-diagnosis-panel h3 {
            margin: 0 0 16px 0;
            color: #ff6b35;
            border-bottom: 2px solid #ff6b35;
            padding-bottom: 8px;
        }
        
        .separation-diagnosis-panel .close-btn {
            position: absolute;
            top: 12px;
            right: 16px;
            background: #ff6b35;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .diagnosis-section {
            margin-bottom: 16px;
            padding: 12px;
            border-left: 4px solid #ddd;
            background: #f8f9fa;
        }
        
        .diagnosis-section.success {
            border-left-color: #28a745;
            background: #f0f9ff;
        }
        
        .diagnosis-section.warning {
            border-left-color: #ffc107;
            background: #fffbf0;
        }
        
        .diagnosis-section.error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        
        .diagnosis-item {
            margin: 4px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        .score-display {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }
        
        .score-display.excellent { background: #d4edda; color: #155724; }
        .score-display.good { background: #fff3cd; color: #856404; }
        .score-display.poor { background: #f8d7da; color: #721c24; }
        
        .log-entry {
            margin: 2px 0;
        }
        
        .log-success { color: #28a745; }
        .log-warning { color: #ffc107; }
        .log-error { color: #dc3545; }
        .log-info { color: #17a2b8; }
        
        /* Canvasåˆ¶å¾¡UI */
        .canvas-controls-container {
            position: fixed;
            top: 350px;
            right: 20px;
            width: 280px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        
        .canvas-controls-container iframe {
            width: 100%;
            border: none;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¤ãƒ¡ãƒ¼ã‚¸ -->
        <div class="hero-section" id="hero-section">
            <!-- Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯ã“ã“ã«é…ç½® -->
            <canvas id="spine-canvas" width="400" height="400"></canvas>
        </div>
        
        <!-- ç”»åƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="image-section" id="image-section">
            <!-- èƒŒæ™¯ç”»åƒã¯CSSã§è¡¨ç¤º -->
        </div>
        
        <!-- ãƒ†ã‚­ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="text-section">
            <h1 id="main-heading">ğŸ¯ ã‚·ãƒ³ãƒ—ãƒ«ãƒ”ãƒ³ãƒ†ã‚¹ãƒˆ</h1>
            <p id="article-text">
                ã“ã®ãƒšãƒ¼ã‚¸ã¯ã€PureBoundingBoxAutoPinã‚·ã‚¹ãƒ†ãƒ ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ã‚·ãƒ³ãƒ—ãƒ«ãªç’°å¢ƒã§ã™ã€‚
                ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã€ç”»åƒã€ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ãŒã‚ã‚Šã€ãã‚Œãã‚Œã«ãƒ”ãƒ³ã‚’è¨­å®šã—ã¦ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚
            </p>
            <p>
                å³ä¸Šã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã‹ã‚‰å„æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚
                å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€å·¦ä¸‹ã®ãƒ­ã‚°ãƒ‘ãƒãƒ«ã§ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™ã€‚
            </p>
        </div>
    </div>
    
    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
    <div class="controls">
        <h4 style="margin: 0 0 12px 0; font-size: 14px;">ğŸ® ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h4>
        <button class="control-button" onclick="initializeSpineCharacter()">
            ğŸ¨ Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸåŒ–
        </button>
        <button class="control-button" onclick="startBoundingBoxEdit()">
            ğŸ“¦ BBç·¨é›†é–‹å§‹
        </button>
        <button class="control-button" onclick="startPinSetting()">
            ğŸ“ ãƒ”ãƒ³è¨­å®šé–‹å§‹
        </button>
        <button class="control-button secondary" onclick="showAllPins()">
            ğŸ‘ï¸ å…¨ãƒ”ãƒ³è¡¨ç¤º
        </button>
        <button class="control-button secondary" onclick="hideAllPins()">
            ğŸš« å…¨ãƒ”ãƒ³éè¡¨ç¤º
        </button>
        <button class="control-button secondary" onclick="cleanupAll()">
            ğŸ§¹ å…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        </button>
        <button class="control-button secondary" onclick="diagnoseSystem()">
            ğŸ” ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­
        </button>
        <button class="control-button secondary" onclick="checkAspectRatio()">
            ğŸ“ ç¸¦æ¨ªæ¯”ãƒã‚§ãƒƒã‚¯
        </button>
        <button class="control-button secondary" onclick="testSpineSettings()">
            ğŸ’¾ è¨­å®šä¿å­˜ãƒ†ã‚¹ãƒˆ
        </button>
        <button class="control-button secondary" onclick="loadSpineSettings()">
            ğŸ“¥ è¨­å®šèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
        </button>
        <button class="control-button" onclick="testScalingContain()">
            ğŸ¯ contain ãƒ¢ãƒ¼ãƒ‰ (æ­ªã¿é˜²æ­¢)
        </button>
        <button class="control-button" onclick="testScalingCover()">
            ğŸ¨ cover ãƒ¢ãƒ¼ãƒ‰ (é ˜åŸŸæº€ãŸã™)
        </button>
        <button class="control-button secondary" onclick="checkScalingConfig()">
            âš™ï¸ ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°è¨­å®šç¢ºèª
        </button>
        <button class="control-button secondary" onclick="testPinDataFormats()">
            ğŸ” ãƒ”ãƒ³ãƒ‡ãƒ¼ã‚¿å½¢å¼ãƒã‚§ãƒƒã‚¯
        </button>
        <button class="control-button secondary" onclick="forcePinDisplay()">
            ğŸ“Œ å¼·åˆ¶ãƒ”ãƒ³è¡¨ç¤º
        </button>
        <button class="control-button secondary" onclick="testResponsiveTracking()">
            ğŸ”„ è¿½å¾“ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ
        </button>
        <button class="control-button secondary" onclick="testBackgroundDetection()">
            ğŸ” èƒŒæ™¯æ¤œå‡ºãƒ†ã‚¹ãƒˆ
        </button>
        
        <!-- ğŸ¯ AutoPinå®Œå…¨åˆ†é›¢æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ  -->
        <hr style="margin: 8px 0; border: 1px solid #ddd;">
        <h5 style="margin: 4px 0; font-size: 11px; color: #666;">ğŸ¯ AutoPinå®Œå…¨åˆ†é›¢æ¤œè¨¼</h5>
        <button class="control-button secondary" onclick="diagnoseAutoPinSeparationState()">
            ğŸ” å®Œå…¨åˆ†é›¢è¨ºæ–­
        </button>
        <button class="control-button secondary" onclick="generateAutoPinSeparationReport()">
            ğŸ“Š AutoPinçŠ¶æ…‹ãƒ¬ãƒãƒ¼ãƒˆ
        </button>
        <button class="control-button secondary" onclick="runFullSeparationTest()">
            ğŸ§ª å®Œå…¨åˆ†é›¢ãƒ†ã‚¹ãƒˆ
        </button>
        
        <!-- ğŸ†• åº§æ¨™ç´”åº¦ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ -->
        <button class="control-button" onclick="checkCoordinatePurity()">
            ğŸ§ª åº§æ¨™ç´”åº¦ãƒã‚§ãƒƒã‚¯
        </button>
        <button class="control-button secondary" onclick="analyzeCoordinateOrigin()">
            ğŸ” åº§æ¨™ç”±æ¥åˆ†æ
        </button>
        <button class="control-button secondary" onclick="generateCoordinatePurityReport()">
            ğŸ“Š åº§æ¨™ç´”åº¦ãƒ¬ãƒãƒ¼ãƒˆ
        </button>
        <button class="control-button secondary" onclick="startCoordinateContaminationMonitor()">
            ğŸš¨ åº§æ¨™æ··å…¥ç›£è¦–é–‹å§‹
        </button>
        <button class="control-button secondary" onclick="startRealtimeMonitoring()">
            ğŸ“ˆ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
        </button>
        <button class="control-button secondary" onclick="stopRealtimeMonitoring()">
            â¹ï¸ ç›£è¦–åœæ­¢
        </button>
        
        <!-- ğŸ†• DOMçŠ¶æ…‹è©³ç´°ç¢ºèªæ©Ÿèƒ½ -->
        <button class="control-button secondary" onclick="captureBeforeState()">
            ğŸ“‹ DOMçŠ¶æ…‹ã‚­ãƒ£ãƒ—ãƒãƒ£
        </button>
        <button class="control-button secondary" onclick="debugSpineCanvasState()">
            ğŸ” DOMçŠ¶æ…‹ç¢ºèª
        </button>
        <button class="control-button secondary" onclick="compareAfterState()">
            ğŸ”„ ç·¨é›†å‰å¾Œæ¯”è¼ƒ
        </button>
        <button class="control-button secondary" onclick="startAdvancedContaminationWatch()">
            ğŸ•µï¸ é«˜åº¦ç›£è¦–é–‹å§‹
        </button>
        <button class="control-button secondary" onclick="stopAdvancedContaminationWatch()">
            ğŸ›‘ é«˜åº¦ç›£è¦–åœæ­¢
        </button>
    </div>
    
    <!-- ãƒ­ã‚°ãƒ‘ãƒãƒ« -->
    <div class="log-panel" id="log-panel">
        <div class="log-entry log-info">ğŸ¯ ã‚·ãƒ³ãƒ—ãƒ«ãƒ”ãƒ³ãƒ†ã‚¹ãƒˆé–‹å§‹æº–å‚™å®Œäº†</div>
    </div>
    
    <!-- ğŸ¯ AutoPinåˆ†é›¢è¨ºæ–­ãƒ‘ãƒãƒ« -->
    <div class="separation-diagnosis-panel" id="separation-diagnosis-panel">
        <button class="close-btn" onclick="closeDiagnosisPanel()" title="é–‰ã˜ã‚‹">Ã—</button>
        <h3>ğŸ¯ AutoPinå®Œå…¨åˆ†é›¢è¨ºæ–­çµæœ</h3>
        <div id="diagnosis-content">
            <!-- è¨ºæ–­çµæœãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
        </div>
    </div>
    
    <!-- Canvasåˆ¶å¾¡UIï¼ˆiframeçµ±åˆï¼‰ -->
    <div class="canvas-controls-container">
        <iframe 
            src="./micromodules/canvas-resize/ui.html?v=1725439200" 
            id="canvas-resize-iframe"
            width="280" 
            height="500"
            frameborder="0">
        </iframe>
    </div>

    <!-- å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ -->
    <!-- Spine WebGL -->
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.24/dist/iife/spine-webgl.js"></script>
    
    <!-- StableSpineRenderer -->
    <script src="micromodules/spine-renderer/StableSpineRenderer.js"></script>
    
    <!-- ğŸ”§ ElementObserver Phase 1ï¼ˆAutoPinå¿…é ˆä¾å­˜ï¼‰ -->
    <script src="micromodules/element-observer/ElementObserverCore.js"></script>
    <script src="micromodules/element-observer/ElementObserver.js"></script>
    
    <!-- PureBoundingBoxï¼ˆãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€šã‚Šã«å…¨ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼‰ -->
    <script src="micromodules/bounding-box/PureBoundingBoxCore.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxBounds.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxUI.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxEvents.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBox.js"></script>
    
    <!-- AutoPinæ©Ÿèƒ½ï¼ˆElementObserverä¾å­˜ï¼‰ -->
    <!-- AutoPinåˆ†å‰²ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆä¾å­˜é †ã«èª­ã¿è¾¼ã¿ï¼‰ -->
    <script src="micromodules/bounding-box/AutoPinConfigManager.js"></script>
    <script src="micromodules/bounding-box/BackgroundDetector.js"></script>
    <script src="micromodules/bounding-box/AnchorCalculator.js"></script>
    <script src="micromodules/bounding-box/PersistenceManager.js"></script>
    <script src="micromodules/bounding-box/PinDisplayManager.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxAutoPin.js"></script>
    
    <!-- TwoStageSelector -->
    <script src="micromodules/element-selector/ElementHighlighter.js"></script>
    <script src="micromodules/element-selector/ElementSelector.js"></script>
    <script src="micromodules/element-selector/TwoStageSelector.js"></script>
    
    <!-- SpineSettingsPersistenceï¼ˆãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€šã‚Šï¼‰ -->
    <script src="micromodules/spine-settings-persistence/SpineSettingsPersistence.js"></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let spineRenderer = null;
        let boundingBox = null;
        let autoPin = null;
        let spineSettingsPersistence = null;
        let canvasResizeHandler = null;
        
        // ãƒ­ã‚°æ©Ÿèƒ½
        function log(message, type = 'info') {
            const logPanel = document.getElementById('log-panel');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // 1. Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸåŒ–ï¼ˆStableSpineRendererãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€šã‚Šï¼‰
        window.initializeSpineCharacter = async function initializeSpineCharacter() {
            try {
                log('ğŸ¨ Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸåŒ–é–‹å§‹', 'info');
                
                // StableSpineRendererã‚’ä½¿ç”¨ï¼ˆãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€šã‚Šï¼‰
                spineRenderer = StableSpineRenderer.createForCharacter('purattokun');
                await spineRenderer.initialize();
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ
                spineRenderer.playAnimation('taiki');
                
                log('âœ… Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸåŒ–å®Œäº†', 'success');
                
                // ğŸ¯ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸåŒ–å®Œäº†æ™‚ã«Canvasæƒ…å ±ã‚’UIã«é€ä¿¡
                updateCanvasUI();
                
            } catch (error) {
                log(`âŒ Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // 2. ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ç·¨é›†é–‹å§‹ï¼ˆPureBoundingBoxãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€šã‚Šï¼‰
        window.startBoundingBoxEdit = async function startBoundingBoxEdit() {
            try {
                log('ğŸ“¦ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ç·¨é›†é–‹å§‹', 'info');
                
                const targetElement = document.getElementById('spine-canvas');
                if (!targetElement) {
                    throw new Error('spine-canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                // ğŸ¯ BBç·¨é›†å‰ã®AutoPinçŠ¶æ…‹ç¢ºèª
                if (window.pureBoundingBoxAutoPin) {
                    const preBBState = window.pureBoundingBoxAutoPin.getState();
                    log(`ğŸ” BBç·¨é›†å‰AutoPinçŠ¶æ…‹: ${preBBState.coordinateSystem.mode}`, 'info');
                }
                

                // ğŸ¯ ã€é‡è¦ä¿®æ­£ã€‘BBç·¨é›†é–‹å§‹æ™‚: AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¼·åˆ¶å‰Šé™¤
                if (window.pureBoundingBoxAutoPin) {
                    log("ğŸ›‘ BBç·¨é›†é–‹å§‹ â†’ AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼å¼·åˆ¶å‰Šé™¤å®Ÿè¡Œ", "warning");
                    
                    try {
                        // ç›´æ¥çš„ã«AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤
                        window.pureBoundingBoxAutoPin.forceStopAndClearCoordinateLayers();
                        log("âœ… AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼å¼·åˆ¶å‰Šé™¤å®Œäº†", "success");
                        
                        // spine-canvasã®CSSçŠ¶æ…‹ã‚‚ç¢ºèªãƒ»ã‚¯ãƒªã‚¢
                        const spineCanvas = document.getElementById("spine-canvas");
                        if (spineCanvas) {
                            // AutoPinã«ã‚ˆã‚‹ä½ç½®åˆ¶å¾¡ã‚’ç„¡åŠ¹åŒ–
                            spineCanvas.style.position = "";
                            spineCanvas.style.left = "";
                            spineCanvas.style.top = "";
                            // transformã¯å…ƒã®CSSã«å§”ã­ã‚‹
                            
                            log("ğŸ”„ spine-canvas AutoPinè¨­å®šã‚’ã‚¯ãƒªã‚¢", "info");
                            
                            const cleanStyle = {
                                position: spineCanvas.style.position || getComputedStyle(spineCanvas).position,
                                left: spineCanvas.style.left || getComputedStyle(spineCanvas).left,
                                top: spineCanvas.style.top || getComputedStyle(spineCanvas).top,
                                transform: spineCanvas.style.transform || getComputedStyle(spineCanvas).transform
                            };
                            log(`ğŸ“Š spine-canvasè¨­å®šå¾ŒçŠ¶æ…‹: ${JSON.stringify(cleanStyle)}`, "info");
                        }
                        
                    } catch (clearError) {
                        log(`âŒ AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${clearError.message}`, "error");
                    }
                } else {
                    log("âš ï¸ window.pureBoundingBoxAutoPin ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "warning");
                }

                // PureBoundingBoxä½œæˆï¼ˆãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€šã‚Šï¼‰
                boundingBox = new PureBoundingBox({
                    targetElement: targetElement
                });
                
                // ç·¨é›†é–‹å§‹
                const result = await boundingBox.execute();
                
                if (result.success) {
                    log('âœ… ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹æˆåŠŸ', 'success');
                    log('ğŸ’¡ BBç·¨é›†ä¸­ã¯AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå®Œå…¨åˆ†é›¢ã•ã‚Œã¦ã„ã¾ã™', 'info');
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                log(`âŒ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ç·¨é›†ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // 3. ãƒ”ãƒ³è¨­å®šé–‹å§‹ï¼ˆTwoStageSelectorä½¿ç”¨ï¼‰
        window.startPinSetting = async function startPinSetting() {
            try {
                log('ğŸ“ ãƒ”ãƒ³è¨­å®šé–‹å§‹', 'info');
                
                if (!boundingBox) {
                    log('âš ï¸ å…ˆã«ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ç·¨é›†ã‚’é–‹å§‹ã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                
                // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ãƒ”ãƒ³è¨­å®šã‚’é–‹å§‹
                // PureBoundingBoxUIã®å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚’ä½¿ç”¨
                log('ğŸ’¡ Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€Œãƒ”ãƒ³è¨­å®šã€ã‚’é¸æŠã—ã¦ãã ã•ã„', 'info');
                
            } catch (error) {
                log(`âŒ ãƒ”ãƒ³è¨­å®šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // 4. å…¨ãƒ”ãƒ³è¡¨ç¤º
        window.showAllPins = function showAllPins() {
            try {
                log('ğŸ‘ï¸ å…¨ãƒ”ãƒ³è¡¨ç¤ºé–‹å§‹', 'info');
                
                // AutoPinã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆæœŸåŒ–ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
                initializeAutoPin();
                
                // åˆ©ç”¨å¯èƒ½ãªãƒ”ãƒ³è¡¨ç¤ºæ©Ÿèƒ½ã‚’å®Ÿè¡Œ
                const nodeId = 'spine-canvas';
                
                if (window.currentAutoPin) {
                    window.currentAutoPin.showAnchorPoint(nodeId);
                    window.currentAutoPin.showUserPin(nodeId);
                    log('âœ… ã‚¢ãƒ³ã‚«ãƒ¼ãƒã‚¤ãƒ³ãƒˆã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ”ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ', 'success');
                } else {
                    log('âš ï¸ AutoPinã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                }
                
            } catch (error) {
                log(`âŒ ãƒ”ãƒ³è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // AutoPinåˆæœŸåŒ–ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆboundingBoxã«ä¾å­˜ã—ãªã„ç‹¬ç«‹åˆæœŸåŒ–ï¼‰
        window.initializeAutoPin = function initializeAutoPin() {
            if (!window.currentAutoPin) {
                try {
                    log('ğŸ”§ AutoPinåˆæœŸåŒ–é–‹å§‹', 'info');
                    
                    // ElementObserverã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰
                    let elementObserver = null;
                    if (window.ElementObserver) {
                        try {
                            elementObserver = new window.ElementObserver();
                            log('âœ… ElementObserver ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ', 'success');
                        } catch (error) {
                            log(`âš ï¸ ElementObserver ä½œæˆå¤±æ•—: ${error.message}`, 'warning');
                            elementObserver = null;
                        }
                    } else {
                        log('âš ï¸ ElementObserver ã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆnull ã§ç¶šè¡Œï¼‰', 'warning');
                    }
                    
                    log(`ğŸ” ElementObserverçŠ¶æ…‹: ${elementObserver ? 'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæ¸ˆã¿' : 'null'}`, 'info');
                    
                    // AutoPinã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                    const targetElement = document.getElementById('spine-canvas');
                    if (targetElement) {
                        // AutoPinåˆæœŸåŒ–ï¼ˆPureBoundingBoxCoreãŒå¿…è¦ï¼‰
                        log('ğŸ” AutoPinåˆæœŸåŒ–é–‹å§‹ - å¿…è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç¢ºèªä¸­', 'info');
                        log(`  PureBoundingBoxCore: ${typeof window.PureBoundingBoxCore}`, 'info');
                        log(`  PureBoundingBoxAutoPin: ${typeof window.PureBoundingBoxAutoPin}`, 'info');
                        log(`  ElementObserver: ${elementObserver ? elementObserver.constructor.name : 'null/undefined'}`, 'info');
                        
                        if (window.PureBoundingBoxCore && window.PureBoundingBoxAutoPin) {
                            try {
                                // PureBoundingBoxCore ã®è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
                                const coreConfig = {
                                    targetElement: targetElement,
                                    nodeId: 'spine-canvas-autopin'
                                };
                                const boundingBoxCore = new window.PureBoundingBoxCore(coreConfig);
                                log('âœ… PureBoundingBoxCore ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ', 'success');
                                
                                window.currentAutoPin = new window.PureBoundingBoxAutoPin(boundingBoxCore, elementObserver);
                                log('âœ… PureBoundingBoxAutoPin ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ', 'success');
                                
                                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç”¨ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹è¿½åŠ 
                                window.pureBoundingBoxAutoPin = window.currentAutoPin;
                                
                                log('âœ… PureBoundingBoxAutoPin åˆæœŸåŒ–å®Œäº†', 'success');
                                log('ğŸ¯ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹: window.pureBoundingBoxAutoPin ã§åˆ©ç”¨å¯èƒ½', 'info');
                                
                                // åˆæœŸè¨­å®šç¢ºèª
                                const config = window.pureBoundingBoxAutoPin.getConfig();
                                log(`ğŸ“Š åˆæœŸã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰: ${config.scaling.mode}`, 'info');
                                
                            } catch (error) {
                                log(`âŒ AutoPin ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                                log(`ğŸ“‹ ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.stack}`, 'error');
                            }
                        } else {
                            log('âŒ å¿…è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒä¸è¶³ã—ã¦ã„ã¾ã™:', 'error');
                            log(`  PureBoundingBoxCore: ${window.PureBoundingBoxCore ? 'âœ…' : 'âŒ'}`, 'error');
                            log(`  PureBoundingBoxAutoPin: ${window.PureBoundingBoxAutoPin ? 'âœ…' : 'âŒ'}`, 'error');
                        }
                    } else {
                        log('âŒ spine-canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    }
                    
                } catch (error) {
                    log(`âŒ AutoPinåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            }
        }
        
        // 5. å…¨ãƒ”ãƒ³éè¡¨ç¤º
        window.hideAllPins = function hideAllPins() {
            try {
                log('ğŸš« å…¨ãƒ”ãƒ³éè¡¨ç¤ºé–‹å§‹', 'info');
                
                // å…¨ã¦ã®è¦–è¦šçš„ãƒ”ãƒ³ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
                const pins = document.querySelectorAll('[id*="marker"], [class*="pin"], [class*="anchor"]');
                pins.forEach(pin => pin.remove());
                
                log(`âœ… ${pins.length}å€‹ã®ãƒ”ãƒ³ãƒãƒ¼ã‚«ãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ`, 'success');
                
            } catch (error) {
                log(`âŒ ãƒ”ãƒ³éè¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // 6. å…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.cleanupAll = function cleanupAll() {
            try {
                log('ğŸ§¹ å…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹', 'warning');
                
                // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                if (boundingBox) {
                    boundingBox.cleanup();
                    boundingBox = null;
                }
                
                // Spineãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                if (spineRenderer) {
                    spineRenderer.cleanup();
                    spineRenderer = null;
                }
                
                // ãƒ”ãƒ³ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
                const pins = document.querySelectorAll('[id*="marker"], [class*="pin"], [class*="anchor"]');
                pins.forEach(pin => pin.remove());
                
                // LocalStorageã‚¯ãƒªã‚¢ï¼ˆãƒ”ãƒ³é–¢é€£ã®ã¿ã€SpineSettingsPersistenceã‚’ä¿è­·ï¼‰
                const storageKeys = Object.keys(localStorage);
                const pinKeys = storageKeys.filter(key => {
                    // SpineSettingsPersistenceã®ã‚­ãƒ¼ï¼ˆspineSettings-ï¼‰ã¯ä¿è­·
                    if (key.startsWith('spineSettings-')) {
                        return false; // å‰Šé™¤å¯¾è±¡ã‹ã‚‰é™¤å¤–
                    }
                    // ãƒ”ãƒ³é–¢é€£ã®ã¿å‰Šé™¤
                    return key.includes('pin') || key.includes('autopin');
                });
                pinKeys.forEach(key => localStorage.removeItem(key));
                
                log(`âœ… å…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†ï¼ˆãƒ”ãƒ³${pins.length}å€‹ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸${pinKeys.length}å€‹å‰Šé™¤ï¼‰`, 'success');
                
            } catch (error) {
                log(`âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­
        window.diagnoseSystem = function diagnoseSystem() {
            try {
                log('ğŸ” ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­é–‹å§‹', 'info');
                
                // åŸºæœ¬ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç¢ºèª
                const modules = {
                    'Spine WebGL': typeof spine !== 'undefined',
                    'StableSpineRenderer': typeof window.StableSpineRenderer !== 'undefined',
                    'ElementObserver': typeof window.ElementObserver !== 'undefined',
                    'ElementObserverCore': typeof window.ElementObserverCore !== 'undefined',
                    'PureBoundingBox': typeof window.PureBoundingBox !== 'undefined',
                    'PureBoundingBoxAutoPin': typeof window.PureBoundingBoxAutoPin !== 'undefined',
                    'TwoStageSelector': typeof window.TwoStageSelector !== 'undefined'
                };
                
                log('ğŸ“‹ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çŠ¶æ³:', 'info');
                Object.entries(modules).forEach(([name, available]) => {
                    log(`  ${available ? 'âœ…' : 'âŒ'} ${name}: ${available ? 'Available' : 'Missing'}`, available ? 'success' : 'error');
                });
                
                // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç¢ºèª
                log('ğŸ¯ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹çŠ¶æ³:', 'info');
                log(`  SpineRenderer: ${spineRenderer ? 'âœ… åˆæœŸåŒ–æ¸ˆã¿' : 'âŒ æœªåˆæœŸåŒ–'}`, spineRenderer ? 'success' : 'warning');
                log(`  BoundingBox: ${boundingBox ? 'âœ… åˆæœŸåŒ–æ¸ˆã¿' : 'âŒ æœªåˆæœŸåŒ–'}`, boundingBox ? 'success' : 'warning');
                log(`  AutoPin: ${window.currentAutoPin ? 'âœ… åˆæœŸåŒ–æ¸ˆã¿' : 'âŒ æœªåˆæœŸåŒ–'}`, window.currentAutoPin ? 'success' : 'warning');
                
                // ğŸ¯ BBç·¨é›†ä¸­AutoPinå®Œå…¨åˆ†é›¢ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
                if (window.pureBoundingBoxAutoPin) {
                    const autoPinState = window.pureBoundingBoxAutoPin.getState();
                    log('ğŸ¯ AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†çŠ¶æ…‹:', 'info');
                    log(`  åº§æ¨™ã‚·ã‚¹ãƒ†ãƒ : ${autoPinState.coordinateSystem.mode}`, 'info');
                    log(`  ãƒ”ãƒ³åŒæœŸ: ${autoPinState.coordinateSystem.pinSyncEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`, 'info');
                    log(`  ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ•°: ${autoPinState.coordinateSystem.originalSpineSettingsCount}å€‹`, 'info');
                    log(`  ã‚¢ã‚¯ãƒ†ã‚£ãƒ–Canvas: [${autoPinState.coordinateSystem.activeCanvases.join(', ')}]`, 'info');
                } else {
                    log('âš ï¸ AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'warning');
                }
                
                // è¦ç´ ç¢ºèª
                const elements = {
                    'spine-canvas': document.getElementById('spine-canvas'),
                    'hero-section': document.getElementById('hero-section'),
                    'image-section': document.getElementById('image-section'),
                    'main-heading': document.getElementById('main-heading')
                };
                
                log('ğŸ­ è¦ç´ çŠ¶æ³:', 'info');
                Object.entries(elements).forEach(([name, element]) => {
                    if (element) {
                        const rect = element.getBoundingClientRect();
                        log(`  âœ… ${name}: ${rect.width.toFixed(0)}Ã—${rect.height.toFixed(0)}px`, 'success');
                    } else {
                        log(`  âŒ ${name}: è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'error');
                    }
                });
                
                log('âœ… ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­å®Œäº†', 'success');
                
            } catch (error) {
                log(`âŒ ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ç¸¦æ¨ªæ¯”ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
        window.checkAspectRatio = function checkAspectRatio() {
            try {
                log('ğŸ“ ç¸¦æ¨ªæ¯”ãƒã‚§ãƒƒã‚¯é–‹å§‹', 'info');
                
                const heroSection = document.getElementById('hero-section');
                const spineCanvas = document.getElementById('spine-canvas');
                
                if (!heroSection || !spineCanvas) {
                    log('âŒ è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                // åˆæœŸè¨ˆæ¸¬
                const heroRect = heroSection.getBoundingClientRect();
                const canvasRect = spineCanvas.getBoundingClientRect();
                
                const heroAspectRatio = heroRect.width / heroRect.height;
                const canvasAspectRatio = canvasRect.width / canvasRect.height;
                
                log('ğŸ“Š ç¾åœ¨ã®ã‚µã‚¤ã‚º:', 'info');
                log(`  ğŸ¯ ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³: ${heroRect.width.toFixed(1)}Ã—${heroRect.height.toFixed(1)}px (æ¯”ç‡: ${heroAspectRatio.toFixed(3)})`, 'info');
                log(`  ğŸ¨ Spineã‚­ãƒ£ãƒ³ãƒã‚¹: ${canvasRect.width.toFixed(1)}Ã—${canvasRect.height.toFixed(1)}px (æ¯”ç‡: ${canvasAspectRatio.toFixed(3)})`, 'info');
                
                // ResizeObserverã§å‹•çš„ç›£è¦–
                if (window.aspectRatioObserver) {
                    window.aspectRatioObserver.disconnect();
                }
                
                window.aspectRatioObserver = new ResizeObserver((entries) => {
                    for (let entry of entries) {
                        const { width, height } = entry.contentRect;
                        const newAspectRatio = width / height;
                        const element = entry.target;
                        
                        if (element.id === 'hero-section') {
                            log(`ğŸ“ ãƒ’ãƒ¼ãƒ­ãƒ¼ç¸¦æ¨ªæ¯”å¤‰åŒ–: ${width.toFixed(1)}Ã—${height.toFixed(1)}px â†’ æ¯”ç‡: ${newAspectRatio.toFixed(3)}`, 'warning');
                        } else if (element.id === 'spine-canvas') {
                            log(`ğŸ¨ ã‚­ãƒ£ãƒ³ãƒã‚¹ç¸¦æ¨ªæ¯”å¤‰åŒ–: ${width.toFixed(1)}Ã—${height.toFixed(1)}px â†’ æ¯”ç‡: ${newAspectRatio.toFixed(3)}`, 'warning');
                        }
                    }
                });
                
                // ä¸¡æ–¹ã®è¦ç´ ã‚’ç›£è¦–
                window.aspectRatioObserver.observe(heroSection);
                window.aspectRatioObserver.observe(spineCanvas);
                
                log('âœ… ç¸¦æ¨ªæ¯”ç›£è¦–é–‹å§‹ - ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ãƒªã‚µã‚¤ã‚ºã—ã¦ç¢ºèªã—ã¦ãã ã•ã„', 'success');
                log('ğŸ’¡ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¸¦æ¨ªæ¯”ã®å¤‰åŒ–ã‚’ãƒ­ã‚°ã«è¡¨ç¤ºã—ã¾ã™', 'info');
                
                // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºæƒ…å ±ã‚‚è¡¨ç¤º
                log(`ğŸ–¥ï¸ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚º: ${window.innerWidth}Ã—${window.innerHeight}px`, 'info');
                
            } catch (error) {
                log(`âŒ ç¸¦æ¨ªæ¯”ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // SpineSettingsPersistence ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
        window.testSpineSettings = function testSpineSettings() {
            try {
                log('ğŸ’¾ SpineSettingsä¿å­˜ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®è©³ç´°ãƒã‚§ãƒƒã‚¯
                log(`ğŸ” spineSettingsPersistence: ${!!spineSettingsPersistence}`, spineSettingsPersistence ? 'success' : 'error');
                if (spineSettingsPersistence) {
                    log(`ğŸ” ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—: ${spineSettingsPersistence.constructor.name}`, 'info');
                    log(`ğŸ” åˆ©ç”¨å¯èƒ½ãƒ¡ã‚½ãƒƒãƒ‰: ${Object.getOwnPropertyNames(Object.getPrototypeOf(spineSettingsPersistence)).filter(name => typeof spineSettingsPersistence[name] === 'function').join(', ')}`, 'info');
                }
                
                if (!spineSettingsPersistence) {
                    log('âŒ SpineSettingsPersistenceãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                    return;
                }
                
                // ä¿å­˜å‰ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
                log('ğŸ” ä¿å­˜å‰ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯:', 'info');
                const existsBefore = spineSettingsPersistence.exists('purattokun');
                log(`ğŸ“‹ ä¿å­˜å‰å­˜åœ¨ç¢ºèª: ${existsBefore ? 'âœ… æ—¢ã«å­˜åœ¨' : 'âŒ æœªå­˜åœ¨'}`, existsBefore ? 'warning' : 'info');
                
                // ãƒ†ã‚¹ãƒˆç”¨è¨­å®šãƒ‡ãƒ¼ã‚¿
                const testSettings = {
                    scaleX: 1.2,
                    scaleY: 1.1,
                    x: 150,
                    y: -50,
                    canvasWidth: 450,
                    canvasHeight: 450,
                    timestamp: Date.now()
                };
                
                log(`ğŸ“‹ ä¿å­˜äºˆå®šãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(testSettings, null, 2)}`, 'info');
                
                // ä¿å­˜ãƒ†ã‚¹ãƒˆï¼ˆãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€šã‚Šã®ä½¿ç”¨æ–¹æ³•ï¼‰
                log('ğŸ”„ save()ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—é–‹å§‹...', 'info');
                const saveResult = spineSettingsPersistence.save('purattokun', testSettings);
                log(`ğŸ” save()æˆ»ã‚Šå€¤: ${saveResult} (å‹: ${typeof saveResult})`, 'info');
                
                if (saveResult) { // booleanå‹ã®æˆ»ã‚Šå€¤
                    log('âœ… è¨­å®šä¿å­˜æˆåŠŸ', 'success');
                    
                    // ä¿å­˜å¾Œå³åº§ã«å­˜åœ¨ç¢ºèª
                    const existsAfter = spineSettingsPersistence.exists('purattokun');
                    log(`ğŸ” ä¿å­˜å¾Œå­˜åœ¨ç¢ºèª: ${existsAfter ? 'âœ… å­˜åœ¨ç¢ºèª' : 'âŒ å­˜åœ¨ã—ãªã„'}`, existsAfter ? 'success' : 'error');
                    
                    // localStorageç›´æ¥ç¢ºèª
                    const allKeys = Object.keys(localStorage);
                    const spineKeys = allKeys.filter(key => key.includes('spine'));
                    log(`ğŸ—‚ï¸ localStorageå†…ã®Spineé–¢é€£ã‚­ãƒ¼: ${spineKeys.length}å€‹`, 'info');
                    spineKeys.forEach(key => {
                        const value = localStorage.getItem(key);
                        log(`  ğŸ“„ ${key}: ${value ? `${value.substring(0, 100)}...` : 'null'}`, 'info');
                    });
                    
                } else {
                    log('âŒ è¨­å®šä¿å­˜å¤±æ•—', 'error');
                }
                
            } catch (error) {
                log(`âŒ SpineSettingsä¿å­˜ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ${error.stack}`, 'error');
            }
        }
        
        window.loadSpineSettings = function loadSpineSettings() {
            try {
                log('ğŸ“¥ SpineSettingsèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                if (!spineSettingsPersistence) {
                    log('âŒ SpineSettingsPersistenceãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                    return;
                }
                
                // å­˜åœ¨ç¢ºèª
                const exists = spineSettingsPersistence.exists('purattokun');
                if (!exists) {
                    log('âš ï¸ ä¿å­˜ã•ã‚ŒãŸè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ã€ŒğŸ’¾ è¨­å®šä¿å­˜ãƒ†ã‚¹ãƒˆã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                
                // èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
                const settings = spineSettingsPersistence.restore('purattokun');
                if (settings) {
                    log('âœ… è¨­å®šèª­ã¿è¾¼ã¿æˆåŠŸ', 'success');
                    log(`ğŸ“‹ èª­ã¿è¾¼ã¿å†…å®¹: ${JSON.stringify(settings, null, 2)}`, 'info');
                    
                    // å®Ÿéš›ã«SpineRendererã«é©ç”¨ï¼ˆãƒ†ã‚¹ãƒˆï¼‰
                    if (spineRenderer && spineRenderer.skeleton) {
                        if (settings.scaleX) spineRenderer.skeleton.scaleX = settings.scaleX;
                        if (settings.scaleY) spineRenderer.skeleton.scaleY = settings.scaleY;
                        if (settings.x) spineRenderer.skeleton.x = settings.x;
                        if (settings.y) spineRenderer.skeleton.y = settings.y;
                        
                        log('ğŸ¨ è¨­å®šã‚’Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«é©ç”¨ã—ã¾ã—ãŸ', 'success');
                    } else {
                        log('âš ï¸ SpineRendererãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€è¨­å®šé©ç”¨ã‚’ã‚¹ã‚­ãƒƒãƒ—', 'warning');
                    }
                } else {
                    log('âŒ è¨­å®šèª­ã¿è¾¼ã¿å¤±æ•—', 'error');
                }
                
            } catch (error) {
                log(`âŒ SpineSettingsèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // SpineSettingsPersistenceåˆæœŸåŒ–ï¼ˆãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€šã‚Šï¼‰
        window.initializeSpineSettingsPersistence = function initializeSpineSettingsPersistence() {
            try {
                log('ğŸ’¾ SpineSettingsPersistenceåˆæœŸåŒ–é–‹å§‹', 'info');
                
                // ãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€šã‚Šã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                spineSettingsPersistence = new SpineSettingsPersistence({
                    debug: true,
                    version: '1.0'
                });
                
                log('âœ… SpineSettingsPersistenceåˆæœŸåŒ–å®Œäº†', 'success');
                
                // æ—¢å­˜è¨­å®šãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const exists = spineSettingsPersistence.exists('purattokun');
                if (exists) {
                    log('ğŸ“‹ æ—¢å­˜ã®è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ', 'info');
                    const settings = spineSettingsPersistence.restore('purattokun');
                    log(`ğŸ“‹ è¨­å®šå†…å®¹: ${JSON.stringify(settings, null, 2)}`, 'info');
                } else {
                    log('ğŸ“‹ æ—¢å­˜è¨­å®šãªã— - æ–°è¦ä½œæˆ', 'info');
                }
                
            } catch (error) {
                log(`âŒ SpineSettingsPersistenceåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ğŸ¯ Canvasæƒ…å ±ã‚’UIã«é€ä¿¡ã™ã‚‹æ©Ÿèƒ½
        window.updateCanvasUI = function updateCanvasUI() {
            try {
                log('ğŸ”„ Canvasæƒ…å ±ã‚’UIã«é€ä¿¡é–‹å§‹', 'info');
                
                const canvas = document.getElementById('spine-canvas');
                if (!canvas) {
                    log('âŒ Canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                // Canvasæƒ…å ±ã¨Spineè¨­å®šã‚’å–å¾—
                const canvasData = {
                    // Canvasè§£åƒåº¦æƒ…å ±
                    canvasWidth: canvas.width,
                    canvasHeight: canvas.height,
                    
                    // Canvasè¡¨ç¤ºã‚µã‚¤ã‚ºæƒ…å ±
                    displayWidth: parseInt(canvas.style.width) || canvas.width,
                    displayHeight: parseInt(canvas.style.height) || canvas.height,
                    
                    // Spineã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šæƒ…å ±
                    scaleX: spineRenderer?.skeleton?.scaleX || 1.0,
                    scaleY: spineRenderer?.skeleton?.scaleY || 1.0,
                    x: spineRenderer?.skeleton?.x || 0,
                    y: spineRenderer?.skeleton?.y || 0,
                    
                    // å–å¾—æ™‚åˆ»
                    timestamp: Date.now()
                };
                
                log(`ğŸ“‹ å–å¾—ã—ãŸCanvasæƒ…å ±:`, 'info');
                log(`  è§£åƒåº¦: ${canvasData.canvasWidth}Ã—${canvasData.canvasHeight}px`, 'info');
                log(`  è¡¨ç¤ºã‚µã‚¤ã‚º: ${canvasData.displayWidth}Ã—${canvasData.displayHeight}px`, 'info');
                log(`  ã‚¹ã‚±ãƒ¼ãƒ«: X:${canvasData.scaleX}, Y:${canvasData.scaleY}`, 'info');
                log(`  ä½ç½®: X:${canvasData.x}, Y:${canvasData.y}`, 'info');
                
                // iframe UIã«é€ä¿¡
                const iframe = document.getElementById('canvas-resize-iframe');
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage({
                        type: 'updateCanvasData',
                        data: canvasData
                    }, '*');
                    
                    log('âœ… Canvasæƒ…å ±ã‚’UIã«é€ä¿¡å®Œäº†', 'success');
                } else {
                    log('âš ï¸ iframe UIãŒæº–å‚™ã§ãã¦ã„ã¾ã›ã‚“', 'warning');
                }
                
            } catch (error) {
                log(`âŒ Canvasæƒ…å ±é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // CanvasResizeControlleråˆæœŸåŒ–ï¼ˆiframeé€šä¿¡å‡¦ç†ï¼‰
        window.initializeCanvasResizeController = function initializeCanvasResizeController() {
            try {
                log('ğŸ›ï¸ CanvasResizeControlleråˆæœŸåŒ–é–‹å§‹', 'info');
                
                const iframe = document.getElementById('canvas-resize-iframe');
                if (!iframe) {
                    throw new Error('iframeè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                // postMessageé€šä¿¡ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€šã‚Šï¼‰
                window.addEventListener('message', (event) => {
                    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
                    const { type, data } = event.data;
                    
                    switch (type) {
                        case 'canvasResize':
                            handleCanvasResize(data.size);
                            break;
                        case 'scaleChanged':
                            handleScaleChanged(data);
                            break;
                        case 'positionChanged':
                            handlePositionChanged(data);
                            break;
                        case 'uiReady':
                            log('ğŸ›ï¸ Canvasåˆ¶å¾¡UIæº–å‚™å®Œäº†', 'success');
                            // UIæº–å‚™å®Œäº†æ™‚ã«ç¾åœ¨ã®Canvasæƒ…å ±ã‚’é€ä¿¡
                            if (spineRenderer) {
                                updateCanvasUI();
                            }
                            break;
                        case 'uiLog':
                            log(`[Canvas UI] ${data.message}`, 'info');
                            break;
                        case 'requestCanvasData':
                            // UIå´ã‹ã‚‰ç¾åœ¨ã®Canvasæƒ…å ±ã‚’è¦æ±‚ã•ã‚ŒãŸå ´åˆ
                            log('ğŸ“¨ UIå´ã‹ã‚‰Canvasæƒ…å ±è¦æ±‚ã‚’å—ä¿¡', 'info');
                            updateCanvasUI();
                            break;
                        case 'canvasDataUpdateComplete':
                            // UIå´ã‹ã‚‰Canvasæƒ…å ±åæ˜ å®Œäº†é€šçŸ¥ã‚’å—ä¿¡
                            if (data.success) {
                                log('âœ… UIå´ã§Canvasæƒ…å ±åæ˜ å®Œäº†', 'success');
                                log(`ğŸ“‹ åæ˜ ã•ã‚ŒãŸå€¤: Canvas:${data.reflectedData.canvasSize}px, Scale:${data.reflectedData.scaleX}/${data.reflectedData.scaleY}, Pos:${data.reflectedData.positionX}/${data.reflectedData.positionY}`, 'info');
                            } else {
                                log(`âŒ UIå´ã§Canvasæƒ…å ±åæ˜ ã‚¨ãƒ©ãƒ¼: ${data.error}`, 'error');
                            }
                            break;
                        default:
                            log(`[Canvas UI] ${type}: ${JSON.stringify(data)}`, 'info');
                    }
                });
                
                log('âœ… CanvasResizeControlleré€šä¿¡æº–å‚™å®Œäº†', 'success');
                
            } catch (error) {
                log(`âŒ CanvasResizeControlleråˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // Canvasåˆ¶å¾¡å‡¦ç†
        window.handleCanvasResize = function handleCanvasResize(size) {
            try {
                log(`ğŸ” Canvasã‚µã‚¤ã‚ºå¤‰æ›´: ${size}px`, 'info');
                
                const canvas = document.getElementById('spine-canvas');
                if (canvas && spineRenderer) {
                    canvas.width = size;
                    canvas.height = size;
                    
                    // WebGLãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆæ›´æ–°
                    if (spineRenderer.gl) {
                        spineRenderer.gl.viewport(0, 0, size, size);
                    }
                    
                    log(`âœ… Canvasã‚µã‚¤ã‚ºæ›´æ–°å®Œäº†: ${size}x${size}px`, 'success');
                } else {
                    log('âŒ Canvasè¦ç´ ã¾ãŸã¯SpineRendererãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                }
            } catch (error) {
                log(`âŒ Canvasã‚µã‚¤ã‚ºå¤‰æ›´ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        window.handleScaleChanged = function handleScaleChanged(data) {
            try {
                log(`ğŸ”„ ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´: X:${data.scaleX}, Y:${data.scaleY}`, 'info');
                
                if (spineRenderer && spineRenderer.skeleton) {
                    spineRenderer.skeleton.scaleX = data.scaleX;
                    spineRenderer.skeleton.scaleY = data.scaleY;
                    log(`âœ… ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´é©ç”¨å®Œäº†`, 'success');
                } else {
                    log('âŒ SpineRendererã¾ãŸã¯SkeletonãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                }
            } catch (error) {
                log(`âŒ ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        window.handlePositionChanged = function handlePositionChanged(data) {
            try {
                log(`ğŸ“ ä½ç½®å¤‰æ›´: X:${data.x}, Y:${data.y}`, 'info');
                
                if (spineRenderer && spineRenderer.skeleton) {
                    spineRenderer.skeleton.x = data.x;
                    spineRenderer.skeleton.y = data.y;
                    log(`âœ… ä½ç½®å¤‰æ›´é©ç”¨å®Œäº†`, 'success');
                } else {
                    log('âŒ SpineRendererã¾ãŸã¯SkeletonãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                }
            } catch (error) {
                log(`âŒ ä½ç½®å¤‰æ›´ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚
        window.addEventListener('load', () => {
            log('ğŸš€ ã‚·ãƒ³ãƒ—ãƒ«ãƒ”ãƒ³ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™å®Œäº†', 'success');
            
            // ãƒãƒ‹ãƒ¥ã‚¢ãƒ«é€šã‚Šã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–
            initializeSpineSettingsPersistence();
            initializeCanvasResizeController();
            
            // AutoPin ã‚‚è‡ªå‹•åˆæœŸåŒ–ï¼ˆé…å»¶å®Ÿè¡Œã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤ï¼‰
            setTimeout(() => {
                log('ğŸ”§ AutoPinè‡ªå‹•åˆæœŸåŒ–é–‹å§‹', 'info');
                initializeAutoPin();
            }, 1000);
            log('ğŸ’¡ å³ä¸Šã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‹ã‚‰å„æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„', 'info');
        });
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', (event) => {
            log(`âŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼: ${event.error?.message || event.message}`, 'error');
        });
        
        // ==========================================
        // ğŸ¯ BBç·¨é›†ä¸­AutoPinå®Œå…¨åˆ†é›¢ã‚·ã‚¹ãƒ†ãƒ ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼‰
        // ==========================================
        
        /**
         * ğŸ¯ BBç·¨é›†é–‹å§‹æ™‚: AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼å®Œå…¨åˆ†é›¢
         */
        document.addEventListener('boundingBoxSelected', (event) => {
            try {
                log('ğŸ¯ BBé¸æŠæ¤œå‡º â†’ AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼å®Œå…¨åˆ†é›¢é–‹å§‹', 'warning');
                log(`ğŸ“‹ BBé¸æŠè©³ç´°: ${JSON.stringify(event.detail)}`, 'info');
                
                // AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å®Œå…¨åœæ­¢ãƒ»å‰Šé™¤
                if (window.pureBoundingBoxAutoPin) {
                    window.pureBoundingBoxAutoPin.forceStopAndClearCoordinateLayers();
                    log('âœ… AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼å®Œå…¨åˆ†é›¢å®Œäº†', 'success');
                } else {
                    log('âš ï¸ AutoPinã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                }
                
                // spine-canvasã‚’å…ƒã®CSSçŠ¶æ…‹ã«å®Œå…¨å¾©å…ƒ
                const spineCanvas = document.getElementById('spine-canvas');
                if (spineCanvas) {
                    log('ğŸ”„ spine-canvas CSSçŠ¶æ…‹ã‚’ç¢ºèªä¸­...', 'info');
                    
                    // ç¾åœ¨ã®CSSè¨­å®šã‚’ãƒ­ã‚°å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                    const currentStyle = {
                        position: spineCanvas.style.position || getComputedStyle(spineCanvas).position,
                        left: spineCanvas.style.left || getComputedStyle(spineCanvas).left,
                        top: spineCanvas.style.top || getComputedStyle(spineCanvas).top,
                        transform: spineCanvas.style.transform || getComputedStyle(spineCanvas).transform
                    };
                    
                    log(`ğŸ“Š spine-canvasç¾åœ¨è¨­å®š: ${JSON.stringify(currentStyle)}`, 'info');
                    log('âœ… BBç·¨é›†ç”¨ã®ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã«è¨­å®šã•ã‚Œã¾ã—ãŸ', 'success');
                } else {
                    log('âŒ spine-canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                }
                
            } catch (error) {
                log(`âŒ BBç·¨é›†é–‹å§‹æ™‚ã®AutoPinåˆ†é›¢ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        });
        
        /**
         * ğŸ¯ BBç·¨é›†å®Œäº†æ™‚: AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼å®‰å…¨å¾©å…ƒ
         */
        document.addEventListener('boundingBoxDeselected', (event) => {
            try {
                log('ğŸ¯ BBé¸æŠè§£é™¤æ¤œå‡º â†’ AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼å®‰å…¨å¾©å…ƒé–‹å§‹', 'info');
                log(`ğŸ“‹ BBé¸æŠè§£é™¤è©³ç´°: ${JSON.stringify(event.detail)}`, 'info');
                
                // AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å®‰å…¨ã«å¾©å…ƒ
                if (window.pureBoundingBoxAutoPin) {
                    window.pureBoundingBoxAutoPin.restartWithCoordinateLayerProtection();
                    log('âœ… AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼å®‰å…¨å¾©å…ƒå®Œäº†', 'success');
                    
                    // å¾©å…ƒå¾Œã®çŠ¶æ…‹ç¢ºèª
                    const state = window.pureBoundingBoxAutoPin.getState();
                    log(`ğŸ“Š AutoPinå¾©å…ƒå¾ŒçŠ¶æ…‹: ${state.coordinateSystem.mode}`, 'info');
                    log(`ğŸ“Š ãƒ”ãƒ³åŒæœŸçŠ¶æ…‹: ${state.coordinateSystem.pinSyncEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`, 'info');
                } else {
                    log('âš ï¸ AutoPinã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                }
                
            } catch (error) {
                log(`âŒ BBç·¨é›†å®Œäº†æ™‚ã®AutoPinå¾©å…ƒã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        });
        
        /**
         * ğŸ¯ BBä¿å­˜å®Œäº†æ™‚ã®è¿½åŠ å‡¦ç†ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
         */
        document.addEventListener('boundingBoxSaved', (event) => {
            try {
                log('ğŸ’¾ BBä¿å­˜å®Œäº†æ¤œå‡º â†’ AutoPinçµ±åˆå‡¦ç†é–‹å§‹', 'info');
                log(`ğŸ“‹ BBä¿å­˜è©³ç´°: ${JSON.stringify(event.detail)}`, 'info');
                
                // BBä¿å­˜å¾Œã®è‡ªå‹•ãƒ”ãƒ³é©ç”¨ï¼ˆAutoPinã‚·ã‚¹ãƒ†ãƒ ã¨çµ±åˆï¼‰
                if (window.pureBoundingBoxAutoPin && event.detail?.saveData) {
                    // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦AutoPiné©ç”¨
                    setTimeout(async () => {
                        try {
                            const result = await window.pureBoundingBoxAutoPin.applyAutoPinOnSave(event.detail.saveData);
                            if (result.success) {
                                log('âœ… BBä¿å­˜ â†’ AutoPiné©ç”¨æˆåŠŸ', 'success');
                                log(`ğŸ“Œ ${result.message}`, 'info');
                            } else {
                                log(`âš ï¸ BBä¿å­˜ â†’ AutoPiné©ç”¨å¤±æ•—: ${result.error}`, 'warning');
                            }
                        } catch (applyError) {
                            log(`âŒ AutoPiné©ç”¨ã‚¨ãƒ©ãƒ¼: ${applyError.message}`, 'error');
                        }
                    }, 200); // BBä¿å­˜å‡¦ç†å®Œäº†ã‚’å¾…ã¤
                }
                
            } catch (error) {
                log(`âŒ BBä¿å­˜å®Œäº†æ™‚ã®AutoPinçµ±åˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        });
        
        // ==========================================
        // ğŸ¯ ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆé–¢æ•°
        // ==========================================
        
        window.testScalingContain = function testScalingContain() {
            try {
                if (window.pureBoundingBoxAutoPin) {
                    window.pureBoundingBoxAutoPin.setScalingMode('contain');
                    log('ğŸ¯ ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰: contain (æ­ªã¿é˜²æ­¢) ã«å¤‰æ›´ã—ã¾ã—ãŸ', 'success');
                    log('ğŸ’¡ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ãƒªã‚µã‚¤ã‚ºã—ã¦ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç¸¦æ¨ªæ¯”ã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'info');
                } else {
                    log('âŒ PureBoundingBoxAutoPin ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                }
            } catch (error) {
                log(`âŒ contain ãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        window.testScalingCover = function testScalingCover() {
            try {
                if (window.pureBoundingBoxAutoPin) {
                    window.pureBoundingBoxAutoPin.setScalingMode('cover');
                    log('ğŸ¨ ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰: cover (é ˜åŸŸæº€ãŸã™) ã«å¤‰æ›´ã—ã¾ã—ãŸ', 'success');
                    log('ğŸ’¡ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ãƒªã‚µã‚¤ã‚ºã—ã¦ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'info');
                } else {
                    log('âŒ PureBoundingBoxAutoPin ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                }
            } catch (error) {
                log(`âŒ cover ãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        window.checkScalingConfig = function checkScalingConfig() {
            try {
                if (window.pureBoundingBoxAutoPin) {
                    const config = window.pureBoundingBoxAutoPin.getConfig();
                    log('âš™ï¸ ç¾åœ¨ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°è¨­å®š:', 'info');
                    log(`  ãƒ¢ãƒ¼ãƒ‰: ${config.scaling.mode}`, 'info');
                    log(`  uniform ã®ã¿: ${config.scaling.uniformOnly}`, 'info');
                    log(`  ã‚¢ãƒ³ã‚«ãƒ¼è¨­å®š: ${JSON.stringify(config.anchor)}`, 'info');
                } else {
                    log('âŒ PureBoundingBoxAutoPin ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                }
            } catch (error) {
                log(`âŒ è¨­å®šç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ğŸ” ãƒ”ãƒ³ãƒ‡ãƒ¼ã‚¿å½¢å¼ãƒã‚§ãƒƒã‚¯
        window.testPinDataFormats = function testPinDataFormats() {
            try {
                log('ğŸ” ãƒ”ãƒ³ãƒ‡ãƒ¼ã‚¿å½¢å¼ãƒã‚§ãƒƒã‚¯é–‹å§‹', 'info');
                
                // localStorage ã®å…¨ã‚­ãƒ¼ã‚’ç¢ºèª
                const keys = Object.keys(localStorage);
                const autoPinKeys = keys.filter(key => key.startsWith('autopin-'));
                
                log(`ğŸ“‹ localStorageå†…ã®AutoPiné–¢é€£ã‚­ãƒ¼: ${autoPinKeys.length}å€‹`, 'info');
                
                for (const key of autoPinKeys) {
                    const data = localStorage.getItem(key);
                    log(`  ${key}: ${data ? 'ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š' : 'ãƒ‡ãƒ¼ã‚¿ãªã—'}`, 'info');
                    
                    if (data && key === 'autopin-active-pins') {
                        try {
                            const parsed = JSON.parse(data);
                            log(`    çµ±åˆãƒ‡ãƒ¼ã‚¿: ${Object.keys(parsed.pins || {}).length}å€‹ã®ãƒ”ãƒ³`, 'info');
                        } catch (e) {
                            log(`    ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'warning');
                        }
                    }
                }
                
                // PersistenceManageräº’æ›æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆå®Ÿéš›ã®APIã‚’ä½¿ç”¨ï¼‰
                if (window.currentAutoPin?.persistenceManager) {
                    // å®Ÿéš›ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒ‰IDã§ãƒ†ã‚¹ãƒˆ
                    const existingKeys = autoPinKeys.filter(key => key.startsWith('autopin-bb-'));
                    if (existingKeys.length > 0) {
                        const nodeId = existingKeys[0].replace('autopin-', '');
                        const result = window.currentAutoPin.persistenceManager.loadPinData(nodeId);
                        log(`ğŸ“Œ PersistenceManagerãƒ†ã‚¹ãƒˆ (${nodeId}): ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'}`, 
                            result.success ? 'success' : 'warning');
                        
                        if (result.success) {
                            log(`    ãƒ‡ãƒ¼ã‚¿è©³ç´°: anchor=${result.data.anchor}, target=${result.data.targetElement}`, 'info');
                        }
                    } else {
                        log('ğŸ“Œ ãƒ†ã‚¹ãƒˆç”¨ã®å€‹åˆ¥ã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                    }
                } else {
                    log('âŒ PersistenceManager ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                }
                
            } catch (error) {
                log(`âŒ ãƒ‡ãƒ¼ã‚¿å½¢å¼ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ğŸ“Œ å¼·åˆ¶ãƒ”ãƒ³è¡¨ç¤º
        window.forcePinDisplay = function forcePinDisplay() {
            try {
                log('ğŸ“Œ å¼·åˆ¶ãƒ”ãƒ³è¡¨ç¤ºé–‹å§‹', 'info');
                
                // ä¿å­˜ã•ã‚ŒãŸãƒ”ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥ä½¿ç”¨
                const activeData = localStorage.getItem('autopin-active-pins');
                if (!activeData) {
                    log('âŒ ä¿å­˜ã•ã‚ŒãŸãƒ”ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                const parsed = JSON.parse(activeData);
                const pins = parsed.pins || {};
                
                log(`ğŸ“‹ æ¤œå‡ºã•ã‚ŒãŸãƒ”ãƒ³æ•°: ${Object.keys(pins).length}`, 'info');
                
                for (const [nodeId, pinData] of Object.entries(pins)) {
                    log(`ğŸ“ ãƒ”ãƒ³ ${nodeId} ã‚’è¡¨ç¤ºä¸­...`, 'info');
                    
                    // ãƒ”ãƒ³è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
                    if (window.currentAutoPin?.pinDisplayManager) {
                        try {
                            // è¦ç´ ã®å­˜åœ¨ç¢ºèª
                            const targetElement = document.getElementById(pinData.targetElement);
                            const spineElement = document.getElementById(pinData.spineElement);
                            
                            log(`    è¦ç´ ç¢ºèª: target=${!!targetElement}, spine=${!!spineElement}`, 'info');
                            
                            if (targetElement && spineElement) {
                                // PinDisplayManagerã®å®Ÿéš›ã®APIã‚’ä½¿ç”¨
                                window.currentAutoPin.pinDisplayManager.showAnchorPoint(nodeId);
                                window.currentAutoPin.pinDisplayManager.showUserPin(nodeId);
                                log(`  âœ… ãƒ”ãƒ³ ${nodeId} è¡¨ç¤ºæˆåŠŸ`, 'success');
                            } else {
                                log(`  âš ï¸ è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (target: ${!!targetElement}, spine: ${!!spineElement})`, 'warning');
                            }
                            
                        } catch (pinError) {
                            log(`  âŒ ãƒ”ãƒ³è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ${pinError.message}`, 'error');
                        }
                    } else {
                        log(`  âŒ PinDisplayManager ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“`, 'error');
                    }
                }
                
            } catch (error) {
                log(`âŒ å¼·åˆ¶ãƒ”ãƒ³è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ğŸ”„ è¿½å¾“ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ
        window.testResponsiveTracking = function testResponsiveTracking() {
            try {
                log('ğŸ”„ è¿½å¾“ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                if (!window.currentAutoPin) {
                    log('âŒ AutoPinã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                    return;
                }
                
                // 1. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚·ã‚¹ãƒ†ãƒ ã®çŠ¶æ…‹ç¢ºèª
                const hasResizeHandler = !!window.currentAutoPin._resizeHandler;
                const hasMutationObserver = !!window.currentAutoPin.mutationObserver;
                
                log(`ğŸ“Š è¿½å¾“ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹:`, 'info');
                log(`  ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ©ãƒ¼: ${hasResizeHandler ? 'âœ… è¨­å®šæ¸ˆã¿' : 'âŒ æœªè¨­å®š'}`, 'info');
                log(`  è¦ç´ å¤‰æ›´ç›£è¦–: ${hasMutationObserver ? 'âœ… å‹•ä½œä¸­' : 'âŒ åœæ­¢ä¸­'}`, 'info');
                
                // 2. æ‰‹å‹•ã§ä½ç½®æ›´æ–°ã‚’ãƒ†ã‚¹ãƒˆ
                if (typeof window.currentAutoPin.updateAllPinPositions === 'function') {
                    log('ğŸ”„ æ‰‹å‹•ãƒ”ãƒ³ä½ç½®æ›´æ–°å®Ÿè¡Œä¸­...', 'info');
                    window.currentAutoPin.updateAllPinPositions();
                    log('âœ… æ‰‹å‹•ãƒ”ãƒ³ä½ç½®æ›´æ–°å®Œäº†', 'success');
                } else {
                    log('âŒ updateAllPinPositions ãƒ¡ã‚½ãƒƒãƒ‰ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                }
                
                // 3. PinDisplayManagerã®çŠ¶æ…‹ç¢ºèª
                if (window.currentAutoPin.pinDisplayManager) {
                    const debugInfo = window.currentAutoPin.pinDisplayManager.getDebugInfo();
                    log(`ğŸ“Œ PinDisplayManagerçŠ¶æ…‹: ${debugInfo.activeMarkersCount}å€‹ã®ãƒãƒ¼ã‚«ãƒ¼`, 'info');
                    log(`  ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ¼ã‚«ãƒ¼: ${JSON.stringify(debugInfo.activeMarkers)}`, 'info');
                } else {
                    log('âŒ PinDisplayManager ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                }
                
                // 4. è¿½å¾“ãƒ†ã‚¹ãƒˆã®ãŸã‚ã®å‹•çš„ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
                log('ğŸ§ª å‹•çš„ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´ãƒ†ã‚¹ãƒˆé–‹å§‹...', 'info');
                const heroSection = document.getElementById('hero-section');
                if (heroSection) {
                    const originalTransform = heroSection.style.transform || '';
                    
                    // ä¸€æ™‚çš„ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´ï¼ˆMutationObserverã‚’ãƒˆãƒªã‚¬ãƒ¼ï¼‰
                    heroSection.style.transform = 'translateX(10px)';
                    
                    setTimeout(() => {
                        heroSection.style.transform = originalTransform;
                        log('âœ… å‹•çš„ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                    }, 1000);
                    
                    log('â±ï¸ 1ç§’å¾Œã«å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ã«å¾©å…ƒã—ã¾ã™', 'info');
                } else {
                    log('âš ï¸ hero-section ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                }
                
            } catch (error) {
                log(`âŒ è¿½å¾“ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ==========================================
        // ğŸ¯ AutoPinå®Œå…¨åˆ†é›¢æ¤œè¨¼ãƒ»è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ 
        // ==========================================
        
        /**
         * ğŸ” AutoPinå®Œå…¨åˆ†é›¢çŠ¶æ…‹ã®è©³ç´°è¨ºæ–­ï¼ˆãƒ‘ãƒãƒ«è¡¨ç¤ºç‰ˆï¼‰
         * BBç·¨é›†ä¸­ã«AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç¢ºå®Ÿã«åˆ†é›¢ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’è©³ç´°ãƒã‚§ãƒƒã‚¯ã—ã€è¦–è¦šçš„ãªãƒ‘ãƒãƒ«ã§çµæœè¡¨ç¤º
         */
        window.diagnoseAutoPinSeparationState = function diagnoseAutoPinSeparationState() {
            const diagnosis = diagnoseAutoPinSeparationStateCore();
            
            if (diagnosis && !diagnosis.error) {
                // è¨ºæ–­ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
                const htmlContent = generateDiagnosisHTML(diagnosis);
                showDiagnosisPanel(htmlContent);
            }
            
            return diagnosis;
        }
        
        /**
         * ğŸ” AutoPinå®Œå…¨åˆ†é›¢çŠ¶æ…‹ã®è©³ç´°è¨ºæ–­ï¼ˆã‚³ã‚¢æ©Ÿèƒ½ï¼‰
         * å®Ÿéš›ã®è¨ºæ–­å‡¦ç†ã‚’è¡Œã†å†…éƒ¨é–¢æ•°
         */
        window.diagnoseAutoPinSeparationStateCore = function diagnoseAutoPinSeparationStateCore() {
            try {
                log('ğŸ” AutoPinå®Œå…¨åˆ†é›¢è¨ºæ–­é–‹å§‹', 'info');
                
                if (!window.pureBoundingBoxAutoPin) {
                    log('âŒ AutoPinã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return {
                        isFullySeparated: false,
                        error: 'AutoPinã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æœªå­˜åœ¨',
                        separationScore: 0
                    };
                }
                
                const diagnosis = {
                    timestamp: new Date().toISOString(),
                    autoPinStatus: {},
                    spineCanvasState: {},
                    separationQuality: {},
                    domElementState: {},
                    eventSystemState: {}
                };
                
                // 1. AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ç¢ºèª
                try {
                    const autoPinState = window.pureBoundingBoxAutoPin.getState();
                    diagnosis.autoPinStatus = {
                        pinSyncEnabled: autoPinState.coordinateSystem.pinSyncEnabled,
                        coordinateMode: autoPinState.coordinateSystem.mode,
                        activeCanvases: autoPinState.coordinateSystem.activeCanvases,
                        backupCount: autoPinState.coordinateSystem.originalSpineSettingsCount,
                        mutationObserverConnected: !!window.pureBoundingBoxAutoPin.mutationObserver,
                        resizeHandlerActive: !!window.pureBoundingBoxAutoPin._resizeHandler
                    };
                    
                    log('ğŸ“Š AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹:', 'info');
                    log(`  ãƒ”ãƒ³åŒæœŸ: ${diagnosis.autoPinStatus.pinSyncEnabled ? 'ğŸ”´ æœ‰åŠ¹ï¼ˆå•é¡Œã‚ã‚Šï¼‰' : 'âœ… ç„¡åŠ¹ï¼ˆæ­£å¸¸ï¼‰'}`, diagnosis.autoPinStatus.pinSyncEnabled ? 'error' : 'success');
                    log(`  åº§æ¨™ãƒ¢ãƒ¼ãƒ‰: ${diagnosis.autoPinStatus.coordinateMode}`, 'info');
                    log(`  MutationObserver: ${diagnosis.autoPinStatus.mutationObserverConnected ? 'ğŸ”´ æ¥ç¶šä¸­ï¼ˆå•é¡Œã‚ã‚Šï¼‰' : 'âœ… åˆ‡æ–­æ¸ˆã¿ï¼ˆæ­£å¸¸ï¼‰'}`, diagnosis.autoPinStatus.mutationObserverConnected ? 'error' : 'success');
                    log(`  ResizeHandler: ${diagnosis.autoPinStatus.resizeHandlerActive ? 'ğŸ”´ å‹•ä½œä¸­ï¼ˆå•é¡Œã‚ã‚Šï¼‰' : 'âœ… åœæ­¢æ¸ˆã¿ï¼ˆæ­£å¸¸ï¼‰'}`, diagnosis.autoPinStatus.resizeHandlerActive ? 'error' : 'success');
                    log(`  ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ•°: ${diagnosis.autoPinStatus.backupCount}å€‹`, 'info');
                    
                } catch (stateError) {
                    log(`âŒ AutoPinçŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼: ${stateError.message}`, 'error');
                    diagnosis.autoPinStatus.error = stateError.message;
                }
                
                // 2. spine-canvas CSSçŠ¶æ…‹è©³ç´°ç¢ºèª
                const spineCanvas = document.getElementById('spine-canvas');
                if (spineCanvas) {
                    const computedStyle = getComputedStyle(spineCanvas);
                    diagnosis.spineCanvasState = {
                        // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆAutoPinåˆ¶å¾¡ã«ã‚ˆã‚‹è¨­å®šï¼‰
                        inlinePosition: spineCanvas.style.position || 'æœªè¨­å®š',
                        inlineLeft: spineCanvas.style.left || 'æœªè¨­å®š',
                        inlineTop: spineCanvas.style.top || 'æœªè¨­å®š',
                        inlineTransform: spineCanvas.style.transform || 'æœªè¨­å®š',
                        inlineWidth: spineCanvas.style.width || 'æœªè¨­å®š',
                        inlineHeight: spineCanvas.style.height || 'æœªè¨­å®š',
                        
                        // è¨ˆç®—æ¸ˆã¿ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæœ€çµ‚çš„ãªè¡¨ç¤ºçŠ¶æ…‹ï¼‰
                        computedPosition: computedStyle.position,
                        computedLeft: computedStyle.left,
                        computedTop: computedStyle.top,
                        computedTransform: computedStyle.transform,
                        computedWidth: computedStyle.width,
                        computedHeight: computedStyle.height,
                        
                        // ä½ç½®ãƒ»ã‚µã‚¤ã‚ºæƒ…å ±
                        boundingRect: spineCanvas.getBoundingClientRect()
                    };
                    
                    log('ğŸ“Š spine-canvas CSSçŠ¶æ…‹:', 'info');
                    log(`  position: inline='${diagnosis.spineCanvasState.inlinePosition}' computed='${diagnosis.spineCanvasState.computedPosition}'`, 'info');
                    log(`  left: inline='${diagnosis.spineCanvasState.inlineLeft}' computed='${diagnosis.spineCanvasState.computedLeft}'`, 'info');
                    log(`  top: inline='${diagnosis.spineCanvasState.inlineTop}' computed='${diagnosis.spineCanvasState.computedTop}'`, 'info');
                    log(`  transform: inline='${diagnosis.spineCanvasState.inlineTransform}'`, 'info');
                    log(`  computed='${diagnosis.spineCanvasState.computedTransform}'`, 'info');
                    
                    // AutoPinåˆ¶å¾¡ã®ç—•è·¡ãƒã‚§ãƒƒã‚¯
                    const hasAutoPinTraces = (
                        diagnosis.spineCanvasState.inlinePosition === 'fixed' || 
                        diagnosis.spineCanvasState.inlineLeft !== 'æœªè¨­å®š' || 
                        diagnosis.spineCanvasState.inlineTop !== 'æœªè¨­å®š'
                    );
                    
                    log(`ğŸ¯ AutoPinåˆ¶å¾¡ç—•è·¡: ${hasAutoPinTraces ? 'ğŸ”´ æ¤œå‡ºï¼ˆå•é¡Œã‚ã‚Šï¼‰' : 'âœ… ãªã—ï¼ˆæ­£å¸¸ï¼‰'}`, hasAutoPinTraces ? 'error' : 'success');
                    
                } else {
                    log('âŒ spine-canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    diagnosis.spineCanvasState.error = 'spine-canvasè¦ç´ æœªå­˜åœ¨';
                }
                
                // 3. DOMè¦ç´ çŠ¶æ…‹ç¢ºèª
                const pinMarkers = document.querySelectorAll('[id*="marker"], [class*="pin"], [class*="anchor"]');
                const autoPinElements = document.querySelectorAll('[id*="autopin"]');
                
                diagnosis.domElementState = {
                    pinMarkersCount: pinMarkers.length,
                    autoPinElementsCount: autoPinElements.length,
                    visiblePinMarkers: Array.from(pinMarkers).filter(el => 
                        getComputedStyle(el).display !== 'none' && 
                        getComputedStyle(el).visibility !== 'hidden'
                    ).length
                };
                
                log('ğŸ“Š DOMè¦ç´ çŠ¶æ…‹:', 'info');
                log(`  ãƒ”ãƒ³ãƒãƒ¼ã‚«ãƒ¼ç·æ•°: ${diagnosis.domElementState.pinMarkersCount}å€‹`, 'info');
                log(`  è¡¨ç¤ºä¸­ãƒ”ãƒ³ãƒãƒ¼ã‚«ãƒ¼: ${diagnosis.domElementState.visiblePinMarkers}å€‹`, 'info');
                log(`  AutoPiné–¢é€£è¦ç´ : ${diagnosis.domElementState.autoPinElementsCount}å€‹`, 'info');
                
                // 4. åˆ†é›¢å“è³ªã‚¹ã‚³ã‚¢ç®—å‡º
                let separationScore = 0;
                const checks = [
                    { condition: !diagnosis.autoPinStatus.pinSyncEnabled, weight: 30, name: 'ãƒ”ãƒ³åŒæœŸç„¡åŠ¹åŒ–' },
                    { condition: !diagnosis.autoPinStatus.mutationObserverConnected, weight: 20, name: 'MutationObserveråˆ‡æ–­' },
                    { condition: !diagnosis.autoPinStatus.resizeHandlerActive, weight: 20, name: 'ResizeHandleråœæ­¢' },
                    { condition: diagnosis.spineCanvasState.inlinePosition !== 'fixed', weight: 15, name: 'positionå›ºå®šè§£é™¤' },
                    { condition: diagnosis.spineCanvasState.inlineLeft === 'æœªè¨­å®š', weight: 5, name: 'leftå€¤ã‚¯ãƒªã‚¢' },
                    { condition: diagnosis.spineCanvasState.inlineTop === 'æœªè¨­å®š', weight: 5, name: 'topå€¤ã‚¯ãƒªã‚¢' },
                    { condition: diagnosis.domElementState.visiblePinMarkers === 0, weight: 5, name: 'è¡¨ç¤ºãƒ”ãƒ³ãƒãƒ¼ã‚«ãƒ¼ãªã—' }
                ];
                
                const passedChecks = [];
                const failedChecks = [];
                
                checks.forEach(check => {
                    if (check.condition) {
                        separationScore += check.weight;
                        passedChecks.push(check.name);
                    } else {
                        failedChecks.push(check.name);
                    }
                });
                
                diagnosis.separationQuality = {
                    isFullySeparated: separationScore >= 95,
                    separationScore: separationScore,
                    totalChecks: checks.length,
                    passedChecks: passedChecks,
                    failedChecks: failedChecks,
                    remainingInterferences: failedChecks
                };
                
                // 5. è¨ºæ–­çµæœãƒ¬ãƒãƒ¼ãƒˆ
                log('\nğŸ¯ === AutoPinå®Œå…¨åˆ†é›¢è¨ºæ–­çµæœ ===', 'info');
                log(`ğŸ“Š åˆ†é›¢ã‚¹ã‚³ã‚¢: ${separationScore}/100 ${separationScore >= 95 ? 'âœ…' : separationScore >= 70 ? 'âš ï¸' : 'ğŸ”´'}`, 
                    separationScore >= 95 ? 'success' : separationScore >= 70 ? 'warning' : 'error');
                log(`âœ… æˆåŠŸãƒã‚§ãƒƒã‚¯ (${passedChecks.length}/${checks.length}):`, 'success');
                passedChecks.forEach(check => log(`  âœ“ ${check}`, 'success'));
                
                if (failedChecks.length > 0) {
                    log(`ğŸ”´ å¤±æ•—ãƒã‚§ãƒƒã‚¯ (${failedChecks.length}/${checks.length}):`, 'error');
                    failedChecks.forEach(check => log(`  âœ— ${check}`, 'error'));
                }
                
                const status = separationScore >= 95 ? 'å®Œå…¨åˆ†é›¢é”æˆ' : 
                              separationScore >= 70 ? 'éƒ¨åˆ†åˆ†é›¢é”æˆ' : 'åˆ†é›¢ä¸å®Œå…¨';
                log(`ğŸ¯ ç·åˆåˆ¤å®š: ${status}`, separationScore >= 95 ? 'success' : separationScore >= 70 ? 'warning' : 'error');
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨ºæ–­çµæœã‚’ä¿å­˜ï¼ˆä»–ã®é–¢æ•°ã‹ã‚‰å‚ç…§å¯èƒ½ï¼‰
                window.lastSeparationDiagnosis = diagnosis;
                
                return diagnosis;
                
            } catch (error) {
                log(`âŒ å®Œå…¨åˆ†é›¢è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                return {
                    isFullySeparated: false,
                    error: error.message,
                    separationScore: 0
                };
            }
        }
        
        /**
         * ğŸ“Š AutoPinçŠ¶æ…‹ã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
         */
        window.generateAutoPinSeparationReport = function generateAutoPinSeparationReport() {
            try {
                log('ğŸ“Š AutoPinçŠ¶æ…‹ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé–‹å§‹', 'info');
                
                // å…ˆã«ã‚³ã‚¢è¨ºæ–­ã‚’å®Ÿè¡Œï¼ˆãƒ‘ãƒãƒ«è¡¨ç¤ºãªã—ç‰ˆï¼‰
                const diagnosis = diagnoseAutoPinSeparationStateCore();
                
                if (!diagnosis || diagnosis.error) {
                    log('âŒ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¿…è¦ãªè¨ºæ–­ãŒå¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    return null;
                }
                
                // è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆæ§‹é€ ä½“
                const report = {
                    timestamp: diagnosis.timestamp,
                    summary: {
                        isFullySeparated: diagnosis.separationQuality.isFullySeparated,
                        separationScore: diagnosis.separationQuality.separationScore,
                        status: diagnosis.separationQuality.separationScore >= 95 ? 'FULLY_SEPARATED' : 
                               diagnosis.separationQuality.separationScore >= 70 ? 'PARTIALLY_SEPARATED' : 'SEPARATION_FAILED'
                    },
                    autoPinStatus: diagnosis.autoPinStatus,
                    spineCanvasState: diagnosis.spineCanvasState,
                    separationQuality: diagnosis.separationQuality,
                    domElementState: diagnosis.domElementState,
                    recommendations: [],
                    technicalDetails: {}
                };
                
                // æ”¹å–„æ¨å¥¨äº‹é …ã®ç”Ÿæˆ
                if (!report.summary.isFullySeparated) {
                    if (diagnosis.autoPinStatus.pinSyncEnabled) {
                        report.recommendations.push('AutoPinåº§æ¨™åŒæœŸã‚’ç„¡åŠ¹åŒ–ã—ã¦ãã ã•ã„');
                    }
                    if (diagnosis.autoPinStatus.mutationObserverConnected) {
                        report.recommendations.push('MutationObserverã‚’åˆ‡æ–­ã—ã¦ãã ã•ã„');
                    }
                    if (diagnosis.autoPinStatus.resizeHandlerActive) {
                        report.recommendations.push('WindowResizeHandlerã‚’åœæ­¢ã—ã¦ãã ã•ã„');
                    }
                    if (diagnosis.spineCanvasState.inlinePosition === 'fixed') {
                        report.recommendations.push('spine-canvasã®postion:fixedã‚’è§£é™¤ã—ã¦ãã ã•ã„');
                    }
                }
                
                // æŠ€è¡“è©³ç´°æƒ…å ±ã®è¿½åŠ 
                report.technicalDetails = {
                    browserInfo: {
                        userAgent: navigator.userAgent,
                        viewportSize: `${window.innerWidth}x${window.innerHeight}`,
                        devicePixelRatio: window.devicePixelRatio
                    },
                    moduleVersions: {
                        StableSpineRenderer: typeof window.StableSpineRenderer !== 'undefined' ? 'loaded' : 'missing',
                        PureBoundingBox: typeof window.PureBoundingBox !== 'undefined' ? 'loaded' : 'missing',
                        PureBoundingBoxAutoPin: typeof window.PureBoundingBoxAutoPin !== 'undefined' ? 'loaded' : 'missing',
                        ElementObserver: typeof window.ElementObserver !== 'undefined' ? 'loaded' : 'missing'
                    },
                    localStorage: {
                        autoPinKeys: Object.keys(localStorage).filter(key => key.startsWith('autopin-')),
                        spineKeys: Object.keys(localStorage).filter(key => key.startsWith('spine'))
                    }
                };
                
                // ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
                log('\nğŸ“Š === AutoPinè©³ç´°çŠ¶æ…‹ãƒ¬ãƒãƒ¼ãƒˆ ===', 'info');
                log(`ğŸ•’ ç”Ÿæˆæ™‚åˆ»: ${report.timestamp}`, 'info');
                log(`ğŸ“‹ ç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${report.summary.status}`, 
                    report.summary.status === 'FULLY_SEPARATED' ? 'success' : 
                    report.summary.status === 'PARTIALLY_SEPARATED' ? 'warning' : 'error');
                log(`ğŸ“Š åˆ†é›¢ã‚¹ã‚³ã‚¢: ${report.summary.separationScore}/100`, 'info');
                
                // AutoPinè©³ç´°çŠ¶æ…‹
                log('\nğŸ¯ AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼è©³ç´°:', 'info');
                Object.entries(report.autoPinStatus).forEach(([key, value]) => {
                    if (key !== 'error') {
                        log(`  ${key}: ${value}`, 'info');
                    }
                });
                
                // Canvasè©³ç´°çŠ¶æ…‹
                log('\nğŸ¨ spine-canvasè©³ç´°çŠ¶æ…‹:', 'info');
                if (report.spineCanvasState.error) {
                    log(`  âŒ ã‚¨ãƒ©ãƒ¼: ${report.spineCanvasState.error}`, 'error');
                } else {
                    log(`  inline styles: position=${report.spineCanvasState.inlinePosition}, left=${report.spineCanvasState.inlineLeft}, top=${report.spineCanvasState.inlineTop}`, 'info');
                    log(`  computed styles: position=${report.spineCanvasState.computedPosition}, left=${report.spineCanvasState.computedLeft}, top=${report.spineCanvasState.computedTop}`, 'info');
                    log(`  ç”»é¢ä½ç½®: x=${Math.round(report.spineCanvasState.boundingRect.x)}, y=${Math.round(report.spineCanvasState.boundingRect.y)}`, 'info');
                    log(`  ã‚µã‚¤ã‚º: ${Math.round(report.spineCanvasState.boundingRect.width)}Ã—${Math.round(report.spineCanvasState.boundingRect.height)}px`, 'info');
                }
                
                // æ¨å¥¨äº‹é …
                if (report.recommendations.length > 0) {
                    log('\nğŸ’¡ æ”¹å–„æ¨å¥¨äº‹é …:', 'warning');
                    report.recommendations.forEach((rec, index) => {
                        log(`  ${index + 1}. ${rec}`, 'warning');
                    });
                }
                
                // æŠ€è¡“è©³ç´°
                log('\nğŸ”§ æŠ€è¡“è©³ç´°æƒ…å ±:', 'info');
                log(`  ãƒ–ãƒ©ã‚¦ã‚¶: ${report.technicalDetails.browserInfo.userAgent.split(' ').slice(-2).join(' ')}`, 'info');
                log(`  ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆ: ${report.technicalDetails.browserInfo.viewportSize}`, 'info');
                log(`  ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: ${Object.entries(report.technicalDetails.moduleVersions).filter(([,v]) => v === 'loaded').length}å€‹èª­ã¿è¾¼ã¿æ¸ˆã¿`, 'info');
                log(`  localStorage: autopin=${report.technicalDetails.localStorage.autoPinKeys.length}å€‹, spine=${report.technicalDetails.localStorage.spineKeys.length}å€‹`, 'info');
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜
                window.lastSeparationReport = report;
                
                log('\nâœ… AutoPinçŠ¶æ…‹ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†', 'success');
                log('ğŸ’¾ ãƒ¬ãƒãƒ¼ãƒˆã¯ window.lastSeparationReport ã§å‚ç…§å¯èƒ½ã§ã™', 'info');
                
                return report;
                
            } catch (error) {
                log(`âŒ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                return null;
            }
        }
        
        /**
         * ğŸ§ª BBç·¨é›†å®Œå…¨ãƒ•ãƒ­ãƒ¼ã®è‡ªå‹•ãƒ†ã‚¹ãƒˆ
         * BBç·¨é›†é–‹å§‹â†’ç·¨é›†ä¸­â†’ç·¨é›†çµ‚äº†ã®å„æ®µéšã§è‡ªå‹•çš„ã«çŠ¶æ…‹ç¢ºèªã‚’å®Ÿè¡Œ
         */
        window.runFullSeparationTest = async function runFullSeparationTest() {
            try {
                log('ğŸ§ª BBç·¨é›†å®Œå…¨åˆ†é›¢ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                log('ğŸ“‹ ãƒ†ã‚¹ãƒˆæ‰‹é †: åˆæœŸçŠ¶æ…‹â†’BBé–‹å§‹â†’åˆ†é›¢ç¢ºèªâ†’BBçµ‚äº†â†’å¾©å…ƒç¢ºèª', 'info');
                
                if (!window.pureBoundingBoxAutoPin) {
                    log('âŒ AutoPinã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå¿…è¦ã§ã™', 'error');
                    return { success: false, error: 'AutoPinã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æœªå­˜åœ¨' };
                }
                
                const testResults = {
                    timestamp: new Date().toISOString(),
                    phases: {},
                    overall: { success: false, score: 0 }
                };
                
                // Phase 1: åˆæœŸçŠ¶æ…‹ç¢ºèª
                log('\nğŸ“‹ Phase 1: åˆæœŸçŠ¶æ…‹ç¢ºèª', 'info');
                const initialDiagnosis = diagnoseAutoPinSeparationStateCore();
                testResults.phases.initial = {
                    separationScore: initialDiagnosis.separationQuality.separationScore,
                    isFullySeparated: initialDiagnosis.separationQuality.isFullySeparated,
                    pinSyncEnabled: initialDiagnosis.autoPinStatus.pinSyncEnabled
                };
                log(`åˆæœŸçŠ¶æ…‹: åˆ†é›¢ã‚¹ã‚³ã‚¢=${initialDiagnosis.separationQuality.separationScore}/100`, 'info');
                
                // Phase 2: BBç·¨é›†é–‹å§‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                log('\nğŸ“‹ Phase 2: BBç·¨é›†é–‹å§‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', 'info');
                const boundingBoxSelectedEvent = new CustomEvent('boundingBoxSelected', {
                    detail: {
                        targetElement: document.getElementById('spine-canvas'),
                        testMode: true,
                        timestamp: Date.now()
                    }
                });
                document.dispatchEvent(boundingBoxSelectedEvent);
                
                // çŠ¶æ…‹å¤‰åŒ–ã‚’å¾…ã¤
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Phase 3: BBç·¨é›†ä¸­ã®åˆ†é›¢çŠ¶æ…‹ç¢ºèª
                log('\nğŸ“‹ Phase 3: BBç·¨é›†ä¸­ã®å®Œå…¨åˆ†é›¢ç¢ºèª', 'info');
                const separationDiagnosis = diagnoseAutoPinSeparationStateCore();
                testResults.phases.separated = {
                    separationScore: separationDiagnosis.separationQuality.separationScore,
                    isFullySeparated: separationDiagnosis.separationQuality.isFullySeparated,
                    pinSyncEnabled: separationDiagnosis.autoPinStatus.pinSyncEnabled,
                    mutationObserverConnected: separationDiagnosis.autoPinStatus.mutationObserverConnected,
                    resizeHandlerActive: separationDiagnosis.autoPinStatus.resizeHandlerActive
                };
                
                const separationSuccess = separationDiagnosis.separationQuality.separationScore >= 95;
                log(`åˆ†é›¢çŠ¶æ…‹: ${separationSuccess ? 'âœ… å®Œå…¨åˆ†é›¢é”æˆ' : 'âŒ åˆ†é›¢ä¸å®Œå…¨'} (${separationDiagnosis.separationQuality.separationScore}/100)`, 
                    separationSuccess ? 'success' : 'error');
                
                if (separationSuccess) {
                    log('  âœ… AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼: å®Œå…¨åœæ­¢', 'success');
                    log('  âœ… spine-canvas CSS: ã‚¯ãƒªãƒ¼ãƒ³çŠ¶æ…‹', 'success');
                    log('  âœ… ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼: å…¨åœæ­¢', 'success');
                } else {
                    log('  ğŸ”´ åˆ†é›¢ä¸å®Œå…¨ - ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:', 'error');
                    separationDiagnosis.separationQuality.failedChecks.forEach(check => {
                        log(`    âœ— ${check}`, 'error');
                    });
                }
                
                // Phase 4: BBç·¨é›†çµ‚äº†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                log('\nğŸ“‹ Phase 4: BBç·¨é›†çµ‚äº†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', 'info');
                const boundingBoxDeselectedEvent = new CustomEvent('boundingBoxDeselected', {
                    detail: {
                        targetElement: document.getElementById('spine-canvas'),
                        saveData: {
                            bounds: { x: 100, y: 100, width: 200, height: 200 },
                            targetElement: document.getElementById('spine-canvas')
                        },
                        testMode: true,
                        timestamp: Date.now()
                    }
                });
                document.dispatchEvent(boundingBoxDeselectedEvent);
                
                // å¾©å…ƒå‡¦ç†ã‚’å¾…ã¤
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Phase 5: å¾©å…ƒçŠ¶æ…‹ç¢ºèª
                log('\nğŸ“‹ Phase 5: AutoPinå¾©å…ƒçŠ¶æ…‹ç¢ºèª', 'info');
                const restoredDiagnosis = diagnoseAutoPinSeparationStateCore();
                testResults.phases.restored = {
                    separationScore: restoredDiagnosis.separationQuality.separationScore,
                    isFullySeparated: restoredDiagnosis.separationQuality.isFullySeparated,
                    pinSyncEnabled: restoredDiagnosis.autoPinStatus.pinSyncEnabled,
                    mutationObserverConnected: restoredDiagnosis.autoPinStatus.mutationObserverConnected,
                    resizeHandlerActive: restoredDiagnosis.autoPinStatus.resizeHandlerActive
                };
                
                const restorationSuccess = restoredDiagnosis.autoPinStatus.pinSyncEnabled;
                log(`å¾©å…ƒçŠ¶æ…‹: ${restorationSuccess ? 'âœ… AutoPinå¾©å…ƒæˆåŠŸ' : 'âŒ å¾©å…ƒå¤±æ•—'}`, 
                    restorationSuccess ? 'success' : 'error');
                
                if (restorationSuccess) {
                    log('  âœ… ãƒ”ãƒ³åŒæœŸ: å†æœ‰åŠ¹åŒ–', 'success');
                    log('  âœ… ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼: å¾©å…ƒå®Œäº†', 'success');
                } else {
                    log('  ğŸ”´ å¾©å…ƒä¸å®Œå…¨ - AutoPinãŒå†é–‹ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                }
                
                // ç·åˆåˆ¤å®š
                const overallScore = Math.round((
                    (separationSuccess ? 50 : 0) + 
                    (restorationSuccess ? 50 : 0)
                ));
                
                testResults.overall = {
                    success: separationSuccess && restorationSuccess,
                    score: overallScore,
                    separationPhase: separationSuccess,
                    restorationPhase: restorationSuccess
                };
                
                // æœ€çµ‚çµæœå ±å‘Š
                log('\nğŸ¯ === å®Œå…¨åˆ†é›¢ãƒ†ã‚¹ãƒˆçµæœ ===', 'info');
                log(`ğŸ“Š ç·åˆã‚¹ã‚³ã‚¢: ${overallScore}/100`, overallScore >= 90 ? 'success' : overallScore >= 70 ? 'warning' : 'error');
                log(`ğŸ¯ åˆ†é›¢ãƒ•ã‚§ãƒ¼ã‚º: ${separationSuccess ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`, separationSuccess ? 'success' : 'error');
                log(`ğŸ”„ å¾©å…ƒãƒ•ã‚§ãƒ¼ã‚º: ${restorationSuccess ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`, restorationSuccess ? 'success' : 'error');
                
                const finalStatus = testResults.overall.success ? 'ãƒ†ã‚¹ãƒˆåˆæ ¼ - BBç·¨é›†ä¸­AutoPinå®Œå…¨åˆ†é›¢ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸' : 
                                   'ãƒ†ã‚¹ãƒˆä¸åˆæ ¼ - ã‚·ã‚¹ãƒ†ãƒ ã«å•é¡ŒãŒã‚ã‚Šã¾ã™';
                log(`ğŸ† æœ€çµ‚åˆ¤å®š: ${finalStatus}`, testResults.overall.success ? 'success' : 'error');
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ãƒ†ã‚¹ãƒˆçµæœã‚’ä¿å­˜
                window.lastFullSeparationTest = testResults;
                
                return testResults;
                
            } catch (error) {
                log(`âŒ å®Œå…¨åˆ†é›¢ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }
        
        /**
         * ğŸ“ˆ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ 
         * BBç·¨é›†ä¸­ã®çŠ¶æ…‹å¤‰åŒ–ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
         */
        let realtimeMonitoringInterval = null;
        
        window.startRealtimeMonitoring = function startRealtimeMonitoring() {
            try {
                log('ğŸ“ˆ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹', 'info');
                
                if (realtimeMonitoringInterval) {
                    log('âš ï¸ æ—¢ã«ç›£è¦–ä¸­ã§ã™ - å…ˆã«åœæ­¢ã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                
                if (!window.pureBoundingBoxAutoPin) {
                    log('âŒ AutoPinã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå¿…è¦ã§ã™', 'error');
                    return;
                }
                
                let previousState = null;
                let monitoringCount = 0;
                
                log('ğŸ“Š ç›£è¦–é …ç›®: AutoPinçŠ¶æ…‹ã€CSSå¤‰æ›´ã€åº§æ¨™ç«¶åˆã€DOMå¤‰æ›´', 'info');
                log('â±ï¸ ç›£è¦–é–“éš”: 1ç§’', 'info');
                
                realtimeMonitoringInterval = setInterval(() => {
                    try {
                        monitoringCount++;
                        
                        // è»½é‡ãªçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
                        const currentState = {
                            pinSyncEnabled: window.pureBoundingBoxAutoPin.getState().coordinateSystem.pinSyncEnabled,
                            mutationObserverConnected: !!window.pureBoundingBoxAutoPin.mutationObserver,
                            resizeHandlerActive: !!window.pureBoundingBoxAutoPin._resizeHandler
                        };
                        
                        // spine-canvas CSSç›£è¦–
                        const spineCanvas = document.getElementById('spine-canvas');
                        if (spineCanvas) {
                            currentState.spineCanvasCSS = {
                                position: spineCanvas.style.position || 'æœªè¨­å®š',
                                left: spineCanvas.style.left || 'æœªè¨­å®š',
                                top: spineCanvas.style.top || 'æœªè¨­å®š'
                            };
                        }
                        
                        // çŠ¶æ…‹å¤‰åŒ–ã®æ¤œå‡º
                        if (previousState && JSON.stringify(previousState) !== JSON.stringify(currentState)) {
                            log(`ğŸ”„ [ç›£è¦– #${monitoringCount}] çŠ¶æ…‹å¤‰åŒ–æ¤œå‡º:`, 'warning');
                            
                            // å¤‰æ›´ç®‡æ‰€ã®ç‰¹å®šã¨å ±å‘Š
                            Object.keys(currentState).forEach(key => {
                                if (JSON.stringify(previousState[key]) !== JSON.stringify(currentState[key])) {
                                    if (key === 'spineCanvasCSS') {
                                        log(`  CSSå¤‰æ›´: ${JSON.stringify(currentState[key])}`, 'warning');
                                        
                                        // AutoPinåˆ¶å¾¡ã®æ„å›³ã—ãªã„å®Ÿè¡Œã‚’ãƒã‚§ãƒƒã‚¯
                                        if (currentState[key].position === 'fixed') {
                                            log('  âš ï¸ AutoPinåº§æ¨™åˆ¶å¾¡ãŒå®Ÿè¡Œã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™', 'warning');
                                        }
                                    } else {
                                        log(`  ${key}: ${previousState[key]} â†’ ${currentState[key]}`, 'info');
                                        
                                        // é‡è¦ãªçŠ¶æ…‹å¤‰åŒ–ã®ã‚¢ãƒ©ãƒ¼ãƒˆ
                                        if (key === 'pinSyncEnabled' && currentState[key]) {
                                            log('  ğŸš¨ BBç·¨é›†ä¸­ã«AutoPinåŒæœŸãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸï¼', 'error');
                                        }
                                    }
                                }
                            });
                        }
                        
                        // å®šæœŸãƒ¬ãƒãƒ¼ãƒˆï¼ˆ10ç§’ã”ã¨ï¼‰
                        if (monitoringCount % 10 === 0) {
                            log(`ğŸ“Š [ç›£è¦– #${monitoringCount}] å®šæœŸãƒ¬ãƒãƒ¼ãƒˆ: ãƒ”ãƒ³åŒæœŸ=${currentState.pinSyncEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}, ç›£è¦–=${currentState.mutationObserverConnected ? 'å‹•ä½œä¸­' : 'åœæ­¢ä¸­'}, CSSåˆ¶å¾¡=${currentState.spineCanvasCSS?.position !== 'æœªè¨­å®š' ? 'ã‚ã‚Š' : 'ãªã—'}`, 'info');
                        }
                        
                        previousState = JSON.parse(JSON.stringify(currentState));
                        
                    } catch (monitorError) {
                        log(`âŒ ç›£è¦–ã‚¨ãƒ©ãƒ¼: ${monitorError.message}`, 'error');
                    }
                }, 1000);
                
                log('âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–é–‹å§‹ - stopRealtimeMonitoring() ã§åœæ­¢', 'success');
                
            } catch (error) {
                log(`âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–é–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        window.stopRealtimeMonitoring = function stopRealtimeMonitoring() {
            try {
                if (realtimeMonitoringInterval) {
                    clearInterval(realtimeMonitoringInterval);
                    realtimeMonitoringInterval = null;
                    log('â¹ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–åœæ­¢', 'success');
                } else {
                    log('âš ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã¯å‹•ä½œã—ã¦ã„ã¾ã›ã‚“', 'warning');
                }
            } catch (error) {
                log(`âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–åœæ­¢ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«ç›£è¦–ã‚’è‡ªå‹•åœæ­¢
        window.addEventListener('beforeunload', () => {
            if (realtimeMonitoringInterval) {
                clearInterval(realtimeMonitoringInterval);
            }
        });
        
        // ğŸ” èƒŒæ™¯æ¤œå‡ºãƒ†ã‚¹ãƒˆ
        window.testBackgroundDetection = function testBackgroundDetection() {
            try {
                log('ğŸ” èƒŒæ™¯æ¤œå‡ºãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                if (!window.currentAutoPin?.backgroundDetector) {
                    log('âŒ BackgroundDetectorãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                    return;
                }
                
                // è¤‡æ•°ã®è¦ç´ ã§èƒŒæ™¯æ¤œå‡ºã‚’ãƒ†ã‚¹ãƒˆ
                const testElements = [
                    document.getElementById('spine-canvas'),
                    document.querySelector('.hero-section'),
                    document.querySelector('img'),
                    document.body
                ];
                
                testElements.forEach((element, index) => {
                    if (element) {
                        log(`ğŸ“ ãƒ†ã‚¹ãƒˆ ${index + 1}: ${element.tagName}${element.id ? '#' + element.id : ''}${element.className ? '.' + element.className.split(' ')[0] : ''}`, 'info');
                        
                        const detectedBackground = window.currentAutoPin.backgroundDetector.detectBackgroundElement(element);
                        
                        if (detectedBackground) {
                            const bgInfo = `${detectedBackground.tagName}${detectedBackground.id ? '#' + detectedBackground.id : ''}${detectedBackground.className ? '.' + detectedBackground.className.split(' ')[0] : ''}`;
                            log(`  âœ… æ¤œå‡ºçµæœ: ${bgInfo}`, 'success');
                            
                            // èƒŒæ™¯ç”»åƒæƒ…å ±
                            const style = getComputedStyle(detectedBackground);
                            const hasBackgroundImage = style.backgroundImage !== 'none';
                            const hasBackgroundColor = style.backgroundColor !== 'rgba(0, 0, 0, 0)' && style.backgroundColor !== 'transparent';
                            
                            log(`  ğŸ¨ èƒŒæ™¯æƒ…å ±: ç”»åƒ=${hasBackgroundImage ? 'âœ…' : 'âŒ'}, è‰²=${hasBackgroundColor ? 'âœ…' : 'âŒ'}`, 'info');
                        } else {
                            log(`  âŒ èƒŒæ™¯è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`, 'warning');
                        }
                    } else {
                        log(`ğŸ“ ãƒ†ã‚¹ãƒˆ ${index + 1}: è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'warning');
                    }
                });
                
                // ç¾åœ¨ã®ãƒ”ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚‚ç¢ºèª
                const activeData = localStorage.getItem('autopin-active-pins');
                if (activeData) {
                    const parsed = JSON.parse(activeData);
                    const pins = parsed.pins || {};
                    
                    log(`ğŸ¯ ä¿å­˜æ¸ˆã¿ãƒ”ãƒ³ã®èƒŒæ™¯è¦ç´ :`, 'info');
                    Object.entries(pins).forEach(([nodeId, pinData]) => {
                        const bgElement = pinData.backgroundElement;
                        if (bgElement) {
                            log(`  ${nodeId}: ${bgElement.tagName}#${bgElement.id} (${bgElement.selector})`, 'info');
                        }
                    });
                }
                
            } catch (error) {
                log(`âŒ èƒŒæ™¯æ¤œå‡ºãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        /**
         * è¨ºæ–­ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºåˆ¶å¾¡
         */
        window.showDiagnosisPanel = function showDiagnosisPanel(content) {
            const panel = document.getElementById('separation-diagnosis-panel');
            const contentDiv = document.getElementById('diagnosis-content');
            
            contentDiv.innerHTML = content;
            panel.style.display = 'block';
        }
        
        window.closeDiagnosisPanel = function closeDiagnosisPanel() {
            const panel = document.getElementById('separation-diagnosis-panel');
            panel.style.display = 'none';
        }
        
        /**
         * è¨ºæ–­çµæœã®HTMLç”Ÿæˆ
         */
        window.generateDiagnosisHTML = function generateDiagnosisHTML(diagnosis) {
            if (!diagnosis) return '<p>è¨ºæ–­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            
            const scoreClass = diagnosis.separationQuality.separationScore >= 95 ? 'excellent' : 
                              diagnosis.separationQuality.separationScore >= 70 ? 'good' : 'poor';
            
            const statusText = diagnosis.separationQuality.separationScore >= 95 ? 'ğŸ¯ å®Œå…¨åˆ†é›¢é”æˆ' : 
                              diagnosis.separationQuality.separationScore >= 70 ? 'âš ï¸ éƒ¨åˆ†åˆ†é›¢' : 'âŒ åˆ†é›¢ä¸å®Œå…¨';
            
            let html = `
                <div class="score-display ${scoreClass}">
                    ${statusText}<br>
                    åˆ†é›¢ã‚¹ã‚³ã‚¢: ${diagnosis.separationQuality.separationScore}/100
                </div>
            `;
            
            // AutoPinçŠ¶æ…‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            const autoPinClass = !diagnosis.autoPinStatus.pinSyncEnabled ? 'success' : 'error';
            html += `
                <div class="diagnosis-section ${autoPinClass}">
                    <h4>ğŸ¯ AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹</h4>
                    <div class="diagnosis-item">ãƒ”ãƒ³åŒæœŸ: ${diagnosis.autoPinStatus.pinSyncEnabled ? 'ğŸ”´ æœ‰åŠ¹ï¼ˆå•é¡Œã‚ã‚Šï¼‰' : 'âœ… ç„¡åŠ¹ï¼ˆæ­£å¸¸ï¼‰'}</div>
                    <div class="diagnosis-item">åº§æ¨™ãƒ¢ãƒ¼ãƒ‰: ${diagnosis.autoPinStatus.coordinateMode}</div>
                    <div class="diagnosis-item">MutationObserver: ${diagnosis.autoPinStatus.mutationObserverConnected ? 'ğŸ”´ æ¥ç¶šä¸­ï¼ˆå•é¡Œã‚ã‚Šï¼‰' : 'âœ… åˆ‡æ–­æ¸ˆã¿ï¼ˆæ­£å¸¸ï¼‰'}</div>
                    <div class="diagnosis-item">ResizeHandler: ${diagnosis.autoPinStatus.resizeHandlerActive ? 'ğŸ”´ å‹•ä½œä¸­ï¼ˆå•é¡Œã‚ã‚Šï¼‰' : 'âœ… åœæ­¢æ¸ˆã¿ï¼ˆæ­£å¸¸ï¼‰'}</div>
                    <div class="diagnosis-item">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ•°: ${diagnosis.autoPinStatus.backupCount}å€‹</div>
                </div>
            `;
            
            // spine-canvasçŠ¶æ…‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            if (diagnosis.spineCanvasState.error) {
                html += `
                    <div class="diagnosis-section error">
                        <h4>ğŸ¨ spine-canvasçŠ¶æ…‹</h4>
                        <div class="diagnosis-item">âŒ ã‚¨ãƒ©ãƒ¼: ${diagnosis.spineCanvasState.error}</div>
                    </div>
                `;
            } else {
                const hasAutoPinTraces = (
                    diagnosis.spineCanvasState.inlinePosition === 'fixed' ||
                    diagnosis.spineCanvasState.inlineLeft !== 'æœªè¨­å®š' ||
                    diagnosis.spineCanvasState.inlineTop !== 'æœªè¨­å®š'
                );
                const canvasClass = !hasAutoPinTraces ? 'success' : 'error';
                
                html += `
                    <div class="diagnosis-section ${canvasClass}">
                        <h4>ğŸ¨ spine-canvas CSSçŠ¶æ…‹</h4>
                        <div class="diagnosis-item">position: inline='${diagnosis.spineCanvasState.inlinePosition}' computed='${diagnosis.spineCanvasState.computedPosition}'</div>
                        <div class="diagnosis-item">left: inline='${diagnosis.spineCanvasState.inlineLeft}' computed='${diagnosis.spineCanvasState.computedLeft}'</div>
                        <div class="diagnosis-item">top: inline='${diagnosis.spineCanvasState.inlineTop}' computed='${diagnosis.spineCanvasState.computedTop}'</div>
                        <div class="diagnosis-item">transform: inline='${diagnosis.spineCanvasState.inlineTransform?.substring(0,50) || 'æœªè¨­å®š'}${diagnosis.spineCanvasState.inlineTransform?.length > 50 ? '...' : ''}'</div>
                        <div class="diagnosis-item">AutoPinåˆ¶å¾¡ç—•è·¡: ${hasAutoPinTraces ? 'ğŸ”´ æ¤œå‡ºï¼ˆå•é¡Œã‚ã‚Šï¼‰' : 'âœ… ãªã—ï¼ˆæ­£å¸¸ï¼‰'}</div>
                    </div>
                `;
            }
            
            // DOMè¦ç´ çŠ¶æ…‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            html += `
                <div class="diagnosis-section info">
                    <h4>ğŸ­ DOMè¦ç´ çŠ¶æ…‹</h4>
                    <div class="diagnosis-item">ãƒ”ãƒ³ãƒãƒ¼ã‚«ãƒ¼ç·æ•°: ${diagnosis.domElementState.pinMarkersCount}å€‹</div>
                    <div class="diagnosis-item">è¡¨ç¤ºä¸­ãƒ”ãƒ³ãƒãƒ¼ã‚«ãƒ¼: ${diagnosis.domElementState.visiblePinMarkers}å€‹</div>
                    <div class="diagnosis-item">AutoPiné–¢é€£è¦ç´ : ${diagnosis.domElementState.autoPinElementsCount}å€‹</div>
                </div>
            `;
            
            // æˆåŠŸãƒ»å¤±æ•—ãƒã‚§ãƒƒã‚¯é …ç›®
            if (diagnosis.separationQuality.passedChecks.length > 0) {
                html += `
                    <div class="diagnosis-section success">
                        <h4>âœ… æˆåŠŸãƒã‚§ãƒƒã‚¯é …ç›® (${diagnosis.separationQuality.passedChecks.length}é …ç›®)</h4>
                        ${diagnosis.separationQuality.passedChecks.map(check => `<div class="diagnosis-item">âœ“ ${check}</div>`).join('')}
                    </div>
                `;
            }
            
            if (diagnosis.separationQuality.failedChecks.length > 0) {
                html += `
                    <div class="diagnosis-section error">
                        <h4>âŒ å¤±æ•—ãƒã‚§ãƒƒã‚¯é …ç›® (${diagnosis.separationQuality.failedChecks.length}é …ç›®)</h4>
                        ${diagnosis.separationQuality.failedChecks.map(check => `<div class="diagnosis-item">âœ— ${check}</div>`).join('')}
                    </div>
                `;
            }
            
            // è¨ºæ–­æ™‚åˆ»
            html += `
                <div class="diagnosis-section info">
                    <h4>ğŸ“Š è¨ºæ–­æƒ…å ±</h4>
                    <div class="diagnosis-item">è¨ºæ–­æ™‚åˆ»: ${new Date(diagnosis.timestamp).toLocaleString()}</div>
                    <div class="diagnosis-item">ãƒ–ãƒ©ã‚¦ã‚¶: ${navigator.userAgent.split(' ').slice(-2).join(' ')}</div>
                    <div class="diagnosis-item">ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆ: ${window.innerWidth}Ã—${window.innerHeight}px</div>
                </div>
            `;
            
            return html;
        }
        
        // ğŸ¯ BBåº§æ¨™åˆ†é›¢ãƒ†ã‚¹ãƒˆ
        window.testCoordinateLayerSeparation = function testCoordinateLayerSeparation() {
            try {
                log('ğŸ¯ BBåº§æ¨™åˆ†é›¢ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                if (!window.pureBoundingBoxAutoPin) {
                    log('âŒ AutoPinã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå¿…è¦ã§ã™', 'error');
                    return;
                }
                
                // ãƒ†ã‚¹ãƒˆå‰ã®çŠ¶æ…‹ç¢ºèª
                const beforeState = window.pureBoundingBoxAutoPin.getState();
                log(`ãƒ†ã‚¹ãƒˆå‰çŠ¶æ…‹: ${beforeState.coordinateSystem.mode}`, 'info');
                log(`ãƒ”ãƒ³åŒæœŸ: ${beforeState.coordinateSystem.pinSyncEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`, 'info');
                
                // æ‰‹å‹•ã§BBç·¨é›†é–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç”Ÿã•ã›ã‚‹
                const testEvent = new CustomEvent('boundingBoxSelected', {
                    detail: {
                        targetElement: document.getElementById('spine-canvas'),
                        testMode: true,
                        timestamp: Date.now()
                    }
                });
                
                document.dispatchEvent(testEvent);
                
                // ãƒ†ã‚¹ãƒˆå¾Œã®çŠ¶æ…‹ç¢ºèª
                setTimeout(() => {
                    const afterState = window.pureBoundingBoxAutoPin.getState();
                    log(`ãƒ†ã‚¹ãƒˆå¾ŒçŠ¶æ…‹: ${afterState.coordinateSystem.mode}`, 'info');
                    log(`ãƒ”ãƒ³åŒæœŸ: ${afterState.coordinateSystem.pinSyncEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`, 'info');
                    
                    if (!afterState.coordinateSystem.pinSyncEnabled) {
                        log('âœ… BBåº§æ¨™åˆ†é›¢ãƒ†ã‚¹ãƒˆæˆåŠŸ - AutoPinã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ', 'success');
                    } else {
                        log('âš ï¸ BBåº§æ¨™åˆ†é›¢ãƒ†ã‚¹ãƒˆéƒ¨åˆ†æˆåŠŸ - ãƒ”ãƒ³åŒæœŸãŒã¾ã æœ‰åŠ¹ã§ã™', 'warning');
                    }
                    
                    // spine-canvasã®CSSçŠ¶æ…‹ã‚’ç¢ºèª
                    const spineCanvas = document.getElementById('spine-canvas');
                    if (spineCanvas) {
                        const style = {
                            position: spineCanvas.style.position || 'ç©º',
                            left: spineCanvas.style.left || 'ç©º',
                            top: spineCanvas.style.top || 'ç©º',
                            transform: spineCanvas.style.transform || 'ç©º'
                        };
                        log(`spine-canvasã‚¹ã‚¿ã‚¤ãƒ«: ${JSON.stringify(style)}`, 'info');
                    }
                }, 100);
                
            } catch (error) {
                log(`âŒ BBåº§æ¨™åˆ†é›¢ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ğŸ”„ AutoPinå¾©å…ƒãƒ†ã‚¹ãƒˆ
        window.testCoordinateLayerRestore = function testCoordinateLayerRestore() {
            try {
                log('ğŸ”„ AutoPinå¾©å…ƒãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                if (!window.pureBoundingBoxAutoPin) {
                    log('âŒ AutoPinã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå¿…è¦ã§ã™', 'error');
                    return;
                }
                
                // ãƒ†ã‚¹ãƒˆå‰ã®çŠ¶æ…‹ç¢ºèª
                const beforeState = window.pureBoundingBoxAutoPin.getState();
                log(`å¾©å…ƒå‰çŠ¶æ…‹: ${beforeState.coordinateSystem.mode}`, 'info');
                log(`ãƒ”ãƒ³åŒæœŸ: ${beforeState.coordinateSystem.pinSyncEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`, 'info');
                
                // æ‰‹å‹•ã§BBç·¨é›†å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç”Ÿã•ã›ã‚‹
                const testEvent = new CustomEvent('boundingBoxDeselected', {
                    detail: {
                        targetElement: document.getElementById('spine-canvas'),
                        saveData: {
                            bounds: { x: 100, y: 100, width: 200, height: 200 },
                            targetElement: document.getElementById('spine-canvas')
                        },
                        testMode: true,
                        timestamp: Date.now()
                    }
                });
                
                document.dispatchEvent(testEvent);
                
                // ãƒ†ã‚¹ãƒˆå¾Œã®çŠ¶æ…‹ç¢ºèªã‚’é…å»¶å®Ÿè¡Œï¼ˆéåŒæœŸå¾©å…ƒã‚’å¾…ã¤ï¼‰
                setTimeout(() => {
                    const afterState = window.pureBoundingBoxAutoPin.getState();
                    log(`å¾©å…ƒå¾ŒçŠ¶æ…‹: ${afterState.coordinateSystem.mode}`, 'info');
                    log(`ãƒ”ãƒ³åŒæœŸ: ${afterState.coordinateSystem.pinSyncEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`, 'info');
                    
                    if (afterState.coordinateSystem.pinSyncEnabled) {
                        log('âœ… AutoPinå¾©å…ƒãƒ†ã‚¹ãƒˆæˆåŠŸ - AutoPinã‚’å†æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ', 'success');
                    } else {
                        log('âš ï¸ AutoPinå¾©å…ƒãƒ†ã‚¹ãƒˆéƒ¨åˆ†æˆåŠŸ - ãƒ”ãƒ³åŒæœŸãŒã¾ã ç„¡åŠ¹ã§ã™', 'warning');
                    }
                    
                    // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚·ã‚¹ãƒ†ãƒ ã®çŠ¶æ…‹ç¢ºèª
                    const hasResizeHandler = !!window.pureBoundingBoxAutoPin._resizeHandler;
                    const hasMutationObserver = !!window.pureBoundingBoxAutoPin.mutationObserver;
                    
                    log(`ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚·ã‚¹ãƒ†ãƒ : ãƒªã‚µã‚¤ã‚º=${hasResizeHandler ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}, ç›£è¦–=${hasMutationObserver ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`, 'info');
                    
                    if (hasResizeHandler && hasMutationObserver) {
                        log('âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚·ã‚¹ãƒ†ãƒ ã‚‚æ­£å¸¸ã«å¾©å…ƒã•ã‚Œã¾ã—ãŸ', 'success');
                    } else {
                        log('âš ï¸ ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚·ã‚¹ãƒ†ãƒ ã®ä¸€éƒ¨ãŒå¾©å…ƒã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
                    }
                    
                }, 300); // 300msé…å»¶ã§éåŒæœŸå¾©å…ƒã‚’å¾…ã¤
                
            } catch (error) {
                log(`âŒ AutoPinå¾©å…ƒãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // =========================================================================
        // ğŸ†• åº§æ¨™ç´”åº¦ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
        // BBç·¨é›†ä¸­ã®åº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«AutoPinåº§æ¨™ãŒæ··å…¥ã—ã¦ã„ãªã„ã‹ã‚’è©³ç´°ç¢ºèª
        // =========================================================================
        
        /**
         * ğŸ§ª åº§æ¨™ç´”åº¦ãƒã‚§ãƒƒã‚¯ - BBç·¨é›†ä¸­ã®åº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç´”åº¦ç¢ºèª
         */
        window.checkCoordinatePurity = function checkCoordinatePurity() {
            try {
                log('ğŸ§ª åº§æ¨™ç´”åº¦ãƒã‚§ãƒƒã‚¯é–‹å§‹', 'info');
                
                const spineCanvas = document.getElementById('spine-canvas');
                if (!spineCanvas) {
                    log('âŒ spine-canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                // åº§æ¨™ç”±æ¥åˆ†æ
                const analysis = analyzeCoordinateOriginDetailed(spineCanvas);
                
                // ç´”åº¦ã‚¹ã‚³ã‚¢è¨ˆç®—
                const purityScore = calculateCoordinatePurity(analysis);
                
                log('\nğŸ¯ === åº§æ¨™ç´”åº¦ãƒã‚§ãƒƒã‚¯çµæœ ===', 'info');
                log(`ğŸ“Š åº§æ¨™ç´”åº¦ã‚¹ã‚³ã‚¢: ${purityScore}%`, purityScore >= 90 ? 'success' : purityScore >= 70 ? 'warning' : 'error');
                
                // å„åº§æ¨™ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®è©³ç´°è¡¨ç¤º
                displayCoordinateAnalysis(analysis);
                
                // æ··å…¥æ¤œå‡ºæ™‚ã®è­¦å‘Š
                if (purityScore < 90) {
                    log(`ğŸš¨ AutoPinåº§æ¨™æ··å…¥ã®å¯èƒ½æ€§: ${100 - purityScore}%`, 'warning');
                    showContaminationRecommendations(analysis);
                }
                
                return { purityScore, analysis };
                
            } catch (error) {
                log(`âŒ åº§æ¨™ç´”åº¦ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        /**
         * ğŸ” åº§æ¨™ç”±æ¥åˆ†æ - åº§æ¨™å€¤ã®è©³ç´°ç”±æ¥åˆ†æ
         */
        window.analyzeCoordinateOrigin = function analyzeCoordinateOrigin() {
            try {
                log('ğŸ” åº§æ¨™ç”±æ¥åˆ†æé–‹å§‹', 'info');
                
                const spineCanvas = document.getElementById('spine-canvas');
                if (!spineCanvas) {
                    log('âŒ spine-canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                const analysis = analyzeCoordinateOriginDetailed(spineCanvas);
                
                log('\nğŸ“‹ === åº§æ¨™ç”±æ¥è©³ç´°åˆ†æ ===', 'info');
                
                // position ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è©³ç´°
                log(`ğŸ¯ position: ${analysis.position.value}`, 'info');
                log(`  ç”±æ¥åˆ¤å®š: ${analysis.position.isPinDerived ? 'ğŸš¨ AutoPinç”±æ¥' : 'âœ… BBå°‚ç”¨'}`, analysis.position.isPinDerived ? 'warning' : 'success');
                log(`  ç´”åº¦çŠ¶æ…‹: ${analysis.position.isClean ? 'âœ… ã‚¯ãƒªãƒ¼ãƒ³' : 'âŒ æ±šæŸ“'}`, analysis.position.isClean ? 'success' : 'error');
                
                // left ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è©³ç´°
                log(`ğŸ¯ left: ${analysis.left.value}`, 'info');
                log(`  ç”±æ¥åˆ¤å®š: ${analysis.left.isPinDerived ? 'ğŸš¨ ãƒ”ãƒ³åº§æ¨™ç”±æ¥' : 'âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ç”±æ¥'}`, analysis.left.isPinDerived ? 'warning' : 'success');
                log(`  ç´”åº¦çŠ¶æ…‹: ${analysis.left.isClean ? 'âœ… ã‚¯ãƒªãƒ¼ãƒ³' : 'âŒ æ±šæŸ“'}`, analysis.left.isClean ? 'success' : 'error');
                
                // top ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è©³ç´°
                log(`ğŸ¯ top: ${analysis.top.value}`, 'info');
                log(`  ç”±æ¥åˆ¤å®š: ${analysis.top.isPinDerived ? 'ğŸš¨ ãƒ”ãƒ³åº§æ¨™ç”±æ¥' : 'âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ç”±æ¥'}`, analysis.top.isPinDerived ? 'warning' : 'success');
                log(`  ç´”åº¦çŠ¶æ…‹: ${analysis.top.isClean ? 'âœ… ã‚¯ãƒªãƒ¼ãƒ³' : 'âŒ æ±šæŸ“'}`, analysis.top.isClean ? 'success' : 'error');
                
                // transform ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è©³ç´°
                log(`ğŸ¯ transform: ${analysis.transform.value}`, 'info');
                log(`  ç”±æ¥åˆ¤å®š: ${analysis.transform.isPinDerived ? 'ğŸš¨ AutoPinå‹•çš„å¤‰æ›´' : 'âœ… æ­£å¸¸ãªå¤‰æ›'}`, analysis.transform.isPinDerived ? 'warning' : 'success');
                log(`  ç´”åº¦çŠ¶æ…‹: ${analysis.transform.isClean ? 'âœ… ã‚¯ãƒªãƒ¼ãƒ³' : 'âŒ æ±šæŸ“'}`, analysis.transform.isClean ? 'success' : 'error');
                
                return analysis;
                
            } catch (error) {
                log(`âŒ åº§æ¨™ç”±æ¥åˆ†æã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        /**
         * ğŸ“Š åº§æ¨™ç´”åº¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
         */
        window.generateCoordinatePurityReport = function generateCoordinatePurityReport() {
            try {
                log('ğŸ“Š åº§æ¨™ç´”åº¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé–‹å§‹', 'info');
                
                const spineCanvas = document.getElementById('spine-canvas');
                if (!spineCanvas) {
                    log('âŒ spine-canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                const analysis = analyzeCoordinateOriginDetailed(spineCanvas);
                const purityScore = calculateCoordinatePurity(analysis);
                const contaminations = findCoordinateContaminations(analysis);
                const recommendations = generateCleanupRecommendations(analysis);
                
                const report = {
                    timestamp: Date.now(),
                    canvasElement: 'spine-canvas',
                    purityScore: purityScore,
                    coordinates: analysis,
                    contaminations: contaminations,
                    recommendations: recommendations,
                    systemState: {
                        boundingBoxActive: !!window.boundingBox,
                        autoPinActive: window.pureBoundingBoxAutoPin ? window.pureBoundingBoxAutoPin.getState().coordinateSystem.pinSyncEnabled : false
                    }
                };
                
                // ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
                log('\nğŸ“‹ === åº§æ¨™ç´”åº¦è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ ===', 'info');
                log(`â° ç”Ÿæˆæ—¥æ™‚: ${new Date(report.timestamp).toLocaleString()}`, 'info');
                log(`ğŸ¯ å¯¾è±¡è¦ç´ : ${report.canvasElement}`, 'info');
                log(`ğŸ“Š ç·åˆç´”åº¦ã‚¹ã‚³ã‚¢: ${report.purityScore}%`, report.purityScore >= 90 ? 'success' : report.purityScore >= 70 ? 'warning' : 'error');
                
                if (contaminations.length > 0) {
                    log(`ğŸš¨ æ¤œå‡ºã•ã‚ŒãŸæ±šæŸ“: ${contaminations.length}ä»¶`, 'warning');
                    contaminations.forEach((contamination, index) => {
                        log(`  ${index + 1}. ${contamination.property}: ${contamination.issue}`, 'warning');
                    });
                } else {
                    log('âœ… æ±šæŸ“ãªã— - åº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ç´”ç²‹ã§ã™', 'success');
                }
                
                if (recommendations.length > 0) {
                    log(`ğŸ’¡ æ”¹å–„æ¨å¥¨äº‹é …: ${recommendations.length}ä»¶`, 'info');
                    recommendations.forEach((recommendation, index) => {
                        log(`  ${index + 1}. ${recommendation}`, 'info');
                    });
                }
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                window.lastCoordinatePurityReport = report;
                
                return report;
                
            } catch (error) {
                log(`âŒ åº§æ¨™ç´”åº¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        /**
         * ğŸš¨ åº§æ¨™æ··å…¥ç›£è¦–é–‹å§‹ - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
         */
        let coordinateContaminationObserver = null;
        
        window.startCoordinateContaminationMonitor = function startCoordinateContaminationMonitor() {
            try {
                log('ğŸš¨ åº§æ¨™æ··å…¥ç›£è¦–é–‹å§‹', 'info');
                
                if (coordinateContaminationObserver) {
                    log('âš ï¸ æ—¢ã«ç›£è¦–ä¸­ã§ã™ - å…ˆã«åœæ­¢ã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                
                const spineCanvas = document.getElementById('spine-canvas');
                if (!spineCanvas) {
                    log('âŒ spine-canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                log('ğŸ‘ï¸ ç›£è¦–å¯¾è±¡: spine-canvas ã® style å±æ€§å¤‰æ›´', 'info');
                log('ğŸ” æ¤œå‡ºé …ç›®: AutoPinåº§æ¨™æ··å…¥ã€ãƒ”ã‚¯ã‚»ãƒ«å€¤è¨­å®šã€positionå¤‰æ›´', 'info');
                
                coordinateContaminationObserver = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            // åº§æ¨™å¤‰æ›´ã‚’å³åº§ã«ãƒã‚§ãƒƒã‚¯
                            const analysis = analyzeCoordinateOriginDetailed(spineCanvas);
                            const purityScore = calculateCoordinatePurity(analysis);
                            
                            if (purityScore < 90) {
                                log(`ğŸš¨ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ±šæŸ“æ¤œå‡º! ç´”åº¦: ${purityScore}%`, 'warning');
                                
                                // è©³ç´°ãªæ±šæŸ“æƒ…å ±
                                const contaminations = findCoordinateContaminations(analysis);
                                contaminations.forEach(contamination => {
                                    log(`  âš ï¸ ${contamination.property}: ${contamination.issue}`, 'warning');
                                });
                                
                                // å³åº§ã«è­¦å‘Šè¡¨ç¤º
                                showContaminationAlert(analysis);
                            }
                        }
                    });
                });
                
                coordinateContaminationObserver.observe(spineCanvas, {
                    attributes: true,
                    attributeFilter: ['style']
                });
                
                log('âœ… åº§æ¨™æ··å…¥ç›£è¦–é–‹å§‹å®Œäº† - BBç·¨é›†ä¸­ã®æ±šæŸ“ã‚’æ¤œå‡ºã—ã¾ã™', 'success');
                
                // ç›£è¦–åœæ­¢ç”¨é–¢æ•°ã‚‚ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¿½åŠ 
                window.stopCoordinateContaminationMonitor = function() {
                    if (coordinateContaminationObserver) {
                        coordinateContaminationObserver.disconnect();
                        coordinateContaminationObserver = null;
                        log('ğŸ›‘ åº§æ¨™æ··å…¥ç›£è¦–åœæ­¢', 'info');
                    }
                };
                
                return coordinateContaminationObserver;
                
            } catch (error) {
                log(`âŒ åº§æ¨™æ··å…¥ç›£è¦–é–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // =========================================================================
        // åº§æ¨™ç´”åº¦ãƒã‚§ãƒƒã‚¯ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤
        // =========================================================================
        
        /**
         * åº§æ¨™ç”±æ¥ã®è©³ç´°åˆ†æ
         */
        function analyzeCoordinateOriginDetailed(spineCanvas) {
            const style = spineCanvas.style;
            const computed = getComputedStyle(spineCanvas);
            
            return {
                position: {
                    value: style.position || computed.position,
                    isPinDerived: style.position === 'fixed',  // AutoPinç”±æ¥ãƒã‚§ãƒƒã‚¯
                    isClean: !style.position || style.position !== 'fixed'
                },
                left: {
                    value: style.left || computed.left,
                    isPinDerived: /^\d+px$/.test(style.left),  // ãƒ”ã‚¯ã‚»ãƒ«å€¤=ãƒ”ãƒ³åº§æ¨™ç”±æ¥
                    isClean: !style.left || style.left.includes('%') || style.left === 'auto'
                },
                top: {
                    value: style.top || computed.top,
                    isPinDerived: /^\d+px$/.test(style.top),   // ãƒ”ã‚¯ã‚»ãƒ«å€¤=ãƒ”ãƒ³åº§æ¨™ç”±æ¥
                    isClean: !style.top || style.top.includes('%') || style.top === 'auto'
                },
                transform: {
                    value: style.transform || computed.transform,
                    isPinDerived: style.transform && style.transform !== 'none' && /translate\(\d+px,\s*\d+px\)/.test(style.transform),
                    isClean: !style.transform || style.transform === 'none' || !style.transform.includes('px')
                },
                // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«å…¨ä½“ã®æ±šæŸ“ãƒã‚§ãƒƒã‚¯
                inlineStyles: {
                    hasInlineStyles: !!style.cssText,
                    cssText: style.cssText,
                    suspiciousProperties: findSuspiciousInlineProperties(style)
                }
            };
        }
        
        /**
         * ğŸ” ç´”åº¦ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆè©³ç´°å†…è¨³ä»˜ãï¼‰
         */
        function calculateCoordinatePurity(analysis) {
            let score = 100;
            const breakdown = []; // æ¸›ç‚¹è©³ç´°è¨˜éŒ²
            
            // position ãŒå›ºå®šå€¤ãªã‚‰å¤§å¹…æ¸›ç‚¹
            if (!analysis.position.isClean) {
                score -= 30;
                breakdown.push(`ğŸ“ Positionæ±šæŸ“: -30pt (å€¤: "${analysis.position.value}")`);
            }
            
            // left/top ãŒãƒ”ã‚¯ã‚»ãƒ«å€¤ãªã‚‰æ¸›ç‚¹
            if (!analysis.left.isClean) {
                score -= 25;
                breakdown.push(`ğŸ“ Leftæ±šæŸ“: -25pt (å€¤: "${analysis.left.value}")`);
            }
            if (!analysis.top.isClean) {
                score -= 25;
                breakdown.push(`ğŸ“ Topæ±šæŸ“: -25pt (å€¤: "${analysis.top.value}")`);
            }
            
            // transform ãŒæ€ªã—ã„ãªã‚‰æ¸›ç‚¹
            if (!analysis.transform.isClean) {
                score -= 15;
                breakdown.push(`ğŸ”„ Transformæ±šæŸ“: -15pt (å€¤: "${analysis.transform.value}")`);
            }
            
            // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã®æ€ªã—ã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚Œã°æ¸›ç‚¹
            const suspiciousCount = analysis.inlineStyles.suspiciousProperties.length;
            if (suspiciousCount > 0) {
                const points = suspiciousCount * 5;
                score -= points;
                breakdown.push(`ğŸ“ æ€ªã—ã„Style: -${points}pt (${suspiciousCount}å€‹ã®ç–‘ã‚ã—ã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£)`);
            }
            
            const finalScore = Math.max(0, score);
            
            // è©³ç´°å†…è¨³ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¨ãƒ­ã‚°ã«å‡ºåŠ›
            console.log('ğŸ” === ç´”åº¦ã‚¹ã‚³ã‚¢è©³ç´°å†…è¨³ ===');
            console.log('åŸºæœ¬ã‚¹ã‚³ã‚¢: 100pt');
            breakdown.forEach(item => console.log(item));
            console.log(`æœ€çµ‚ã‚¹ã‚³ã‚¢: ${finalScore}pt`);
            
            log('\nğŸ” === ç´”åº¦ã‚¹ã‚³ã‚¢è©³ç´°å†…è¨³ ===', 'info');
            log('åŸºæœ¬ã‚¹ã‚³ã‚¢: 100pt', 'info');
            breakdown.forEach(item => log(item, 'warning'));
            log(`ğŸ¯ æœ€çµ‚ç´”åº¦ã‚¹ã‚³ã‚¢: ${finalScore}%`, finalScore >= 90 ? 'success' : finalScore >= 70 ? 'warning' : 'error');
            
            return finalScore;
        }
        
        /**
         * æ±šæŸ“æ¤œå‡º
         */
        function findCoordinateContaminations(analysis) {
            const contaminations = [];
            
            if (!analysis.position.isClean) {
                contaminations.push({
                    property: 'position',
                    issue: `å›ºå®šå€¤ "${analysis.position.value}" ã¯AutoPinç”±æ¥ã®å¯èƒ½æ€§`
                });
            }
            
            if (!analysis.left.isClean) {
                contaminations.push({
                    property: 'left',
                    issue: `ãƒ”ã‚¯ã‚»ãƒ«å€¤ "${analysis.left.value}" ã¯ãƒ”ãƒ³åº§æ¨™ç”±æ¥ã®å¯èƒ½æ€§`
                });
            }
            
            if (!analysis.top.isClean) {
                contaminations.push({
                    property: 'top',
                    issue: `ãƒ”ã‚¯ã‚»ãƒ«å€¤ "${analysis.top.value}" ã¯ãƒ”ãƒ³åº§æ¨™ç”±æ¥ã®å¯èƒ½æ€§`
                });
            }
            
            if (!analysis.transform.isClean) {
                contaminations.push({
                    property: 'transform',
                    issue: `ãƒ”ã‚¯ã‚»ãƒ«å¤‰æ› "${analysis.transform.value}" ã¯AutoPinå‹•çš„å¤‰æ›´ã®å¯èƒ½æ€§`
                });
            }
            
            analysis.inlineStyles.suspiciousProperties.forEach(prop => {
                contaminations.push({
                    property: prop.name,
                    issue: `æ€ªã—ã„ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«: ${prop.value}`
                });
            });
            
            return contaminations;
        }
        
        /**
         * æ€ªã—ã„ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æ¤œå‡º
         */
        function findSuspiciousInlineProperties(style) {
            const suspicious = [];
            const suspiciousPatterns = [
                'position', 'left', 'top', 'right', 'bottom', 'transform',
                'margin-left', 'margin-top', 'translate'
            ];
            
            for (let prop of suspiciousPatterns) {
                const value = style.getPropertyValue(prop);
                if (value && value !== 'auto' && value !== 'none') {
                    suspicious.push({ name: prop, value: value });
                }
            }
            
            return suspicious;
        }
        
        /**
         * ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ¨å¥¨äº‹é …ç”Ÿæˆ
         */
        function generateCleanupRecommendations(analysis) {
            const recommendations = [];
            
            if (!analysis.position.isClean) {
                recommendations.push('AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å†å‰Šé™¤ã—ã¦ãã ã•ã„');
            }
            
            if (!analysis.left.isClean || !analysis.top.isClean) {
                recommendations.push('ãƒ”ãƒ³åº§æ¨™ã‚’å‰Šé™¤ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–åº§æ¨™ã«æˆ»ã—ã¦ãã ã•ã„');
            }
            
            if (!analysis.transform.isClean) {
                recommendations.push('AutoPinå‹•çš„å¤‰æ›´ã‚’åœæ­¢ã—ã¦ãã ã•ã„');
            }
            
            if (analysis.inlineStyles.suspiciousProperties.length > 0) {
                recommendations.push('æ€ªã—ã„ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é™¤å»ã—ã¦ãã ã•ã„');
            }
            
            if (recommendations.length === 0) {
                recommendations.push('åº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ç´”ç²‹ã§ã™ - æ”¹å–„ä¸è¦');
            }
            
            return recommendations;
        }
        
        /**
         * æ±šæŸ“è­¦å‘Šè¡¨ç¤º
         */
        function showContaminationAlert(analysis) {
            const contaminations = findCoordinateContaminations(analysis);
            if (contaminations.length > 0) {
                log('ğŸš¨ === AutoPinåº§æ¨™æ··å…¥è­¦å‘Š ===', 'error');
                contaminations.forEach(contamination => {
                    log(`âŒ ${contamination.property}: ${contamination.issue}`, 'error');
                });
                log('ğŸ’¡ æ¨å¥¨: BBç·¨é›†å‰ã«AutoPinåº§æ¨™ãƒ¬ã‚¤ãƒ¤ãƒ¼å®Œå…¨å‰Šé™¤ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'warning');
            }
        }
        
        /**
         * åº§æ¨™åˆ†æçµæœè¡¨ç¤º
         */
        function displayCoordinateAnalysis(analysis) {
            log('ğŸ¯ position:', analysis.position.isClean ? 'success' : 'error');
            log(`  å€¤: ${analysis.position.value}`, 'info');
            log(`  åˆ¤å®š: ${analysis.position.isClean ? 'âœ… BBå°‚ç”¨' : 'âŒ AutoPinç”±æ¥'}`, analysis.position.isClean ? 'success' : 'error');
            
            log('ğŸ¯ left:', analysis.left.isClean ? 'success' : 'error');
            log(`  å€¤: ${analysis.left.value}`, 'info');
            log(`  åˆ¤å®š: ${analysis.left.isClean ? 'âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–' : 'âŒ ãƒ”ãƒ³åº§æ¨™ç”±æ¥'}`, analysis.left.isClean ? 'success' : 'error');
            
            log('ğŸ¯ top:', analysis.top.isClean ? 'success' : 'error');
            log(`  å€¤: ${analysis.top.value}`, 'info');
            log(`  åˆ¤å®š: ${analysis.top.isClean ? 'âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–' : 'âŒ ãƒ”ãƒ³åº§æ¨™ç”±æ¥'}`, analysis.top.isClean ? 'success' : 'error');
            
            log('ğŸ¯ transform:', analysis.transform.isClean ? 'success' : 'error');
            log(`  å€¤: ${analysis.transform.value}`, 'info');
            log(`  åˆ¤å®š: ${analysis.transform.isClean ? 'âœ… æ­£å¸¸ãªå¤‰æ›' : 'âŒ AutoPinå‹•çš„å¤‰æ›´'}`, analysis.transform.isClean ? 'success' : 'error');
        }
        
        /**
         * æ±šæŸ“æ¨å¥¨äº‹é …è¡¨ç¤º
         */
        
        // =========================================================================
        // ğŸ†• DOMçŠ¶æ…‹è©³ç´°ç¢ºèªã‚·ã‚¹ãƒ†ãƒ 
        // AutoPinåº§æ¨™æ··å…¥95%å•é¡Œã®æ ¹æœ¬åŸå› ç‰¹å®šç”¨
        // =========================================================================
        
        // BBç·¨é›†å‰å¾Œæ¯”è¼ƒç”¨ã®çŠ¶æ…‹ä¿æŒ
        let beforeState = null;
        
        /**
         * ğŸ” spine-canvas DOMçŠ¶æ…‹ã®è©³ç´°ç¢ºèª
         */
        window.debugSpineCanvasState = function debugSpineCanvasState() {
            const canvas = document.getElementById('spine-canvas');
            
            console.log('ğŸ” === spine-canvas DOMçŠ¶æ…‹è©³ç´°ç¢ºèª ===');
            console.log('element:', canvas);
            console.log('style.position:', canvas.style.position);
            console.log('style.left:', canvas.style.left);
            console.log('style.top:', canvas.style.top);
            console.log('style.transform:', canvas.style.transform);
            console.log('style.cssText:', canvas.style.cssText);
            console.log('getAttribute("style"):', canvas.getAttribute('style'));
            console.log('computed style:', getComputedStyle(canvas));
            
            // AutoPinã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
            console.log('AutoPin system exists:', typeof window.pureBoundingBoxAutoPin);
            if (window.pureBoundingBoxAutoPin) {
                console.log('pinSyncEnabled:', window.pureBoundingBoxAutoPin.pinSyncEnabled);
            }
            
            const state = {
                element: canvas,
                stylePosition: canvas.style.position,
                styleLeft: canvas.style.left,
                styleTop: canvas.style.top,
                styleTransform: canvas.style.transform,
                cssText: canvas.style.cssText,
                styleAttribute: canvas.getAttribute('style')
            };
            
            // ãƒ­ã‚°ã«ã‚‚è©³ç´°æƒ…å ±å‡ºåŠ›
            log('\nğŸ” === DOMçŠ¶æ…‹è©³ç´°ç¢ºèªçµæœ ===', 'info');
            log(`ğŸ“ Position: ${state.stylePosition || 'æœªè¨­å®š'}`, 'info');
            log(`ğŸ“ Left: ${state.styleLeft || 'æœªè¨­å®š'}`, 'info');
            log(`ğŸ“ Top: ${state.styleTop || 'æœªè¨­å®š'}`, 'info');
            log(`ğŸ”„ Transform: ${state.styleTransform || 'æœªè¨­å®š'}`, 'info');
            log(`ğŸ“ Styleå±æ€§: ${state.styleAttribute || 'æœªè¨­å®š'}`, 'info');
            
            return state;
        }
        
        /**
         * ğŸ“‹ BBç·¨é›†å‰çŠ¶æ…‹ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
         */
        window.captureBeforeState = function captureBeforeState() {
            beforeState = debugSpineCanvasState();
            log('ğŸ“‹ BBç·¨é›†å‰çŠ¶æ…‹ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¾ã—ãŸ', 'success');
            return beforeState;
        }
        
        /**
         * ğŸ”„ BBç·¨é›†å‰å¾Œã®DOMçŠ¶æ…‹æ¯”è¼ƒ
         */
        window.compareAfterState = function compareAfterState() {
            if (!beforeState) {
                log('âš ï¸ æ¯”è¼ƒç”¨ã®ç·¨é›†å‰çŠ¶æ…‹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ã€ŒğŸ“‹ DOMçŠ¶æ…‹ã‚­ãƒ£ãƒ—ãƒãƒ£ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', 'warning');
                return;
            }
            
            const afterState = debugSpineCanvasState();
            
            console.log('ğŸ”„ === BBç·¨é›†å‰å¾Œæ¯”è¼ƒ ===');
            console.log('Before position:', beforeState?.stylePosition);
            console.log('After position:', afterState.stylePosition);
            console.log('Before left:', beforeState?.styleLeft);
            console.log('After left:', afterState.styleLeft);
            console.log('Before top:', beforeState?.styleTop);
            console.log('After top:', afterState.styleTop);
            console.log('Before transform:', beforeState?.styleTransform);
            console.log('After transform:', afterState.styleTransform);
            
            const changed = {
                position: beforeState?.stylePosition !== afterState.stylePosition,
                left: beforeState?.styleLeft !== afterState.styleLeft,
                top: beforeState?.styleTop !== afterState.styleTop,
                transform: beforeState?.styleTransform !== afterState.styleTransform
            };
            
            console.log('å¤‰æ›´æ¤œå‡º:', changed);
            
            // ãƒ­ã‚°ã«ã‚‚æ¯”è¼ƒçµæœå‡ºåŠ›
            log('\nğŸ”„ === BBç·¨é›†å‰å¾Œæ¯”è¼ƒçµæœ ===', 'info');
            if (changed.position) {
                log(`ğŸ“ Positionå¤‰æ›´: ${beforeState?.stylePosition || 'æœªè¨­å®š'} â†’ ${afterState.stylePosition || 'æœªè¨­å®š'}`, 'warning');
            }
            if (changed.left) {
                log(`ğŸ“ Leftå¤‰æ›´: ${beforeState?.styleLeft || 'æœªè¨­å®š'} â†’ ${afterState.styleLeft || 'æœªè¨­å®š'}`, 'warning');
            }
            if (changed.top) {
                log(`ğŸ“ Topå¤‰æ›´: ${beforeState?.styleTop || 'æœªè¨­å®š'} â†’ ${afterState.styleTop || 'æœªè¨­å®š'}`, 'warning');
            }
            if (changed.transform) {
                log(`ğŸ”„ Transformå¤‰æ›´: ${beforeState?.styleTransform || 'æœªè¨­å®š'} â†’ ${afterState.styleTransform || 'æœªè¨­å®š'}`, 'warning');
            }
            
            const changeCount = Object.values(changed).filter(v => v).length;
            if (changeCount === 0) {
                log('âœ… DOMçŠ¶æ…‹ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'success');
            } else {
                log(`âš ï¸ ${changeCount}å€‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ`, 'warning');
            }
            
            return { before: beforeState, after: afterState, changed };
        }
        
        /**
         * ğŸ•µï¸ AutoPinåº§æ¨™æ··å…¥ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–å¼·åŒ–ç‰ˆ
         */
        window.startAdvancedContaminationWatch = function startAdvancedContaminationWatch() {
            log('ğŸ•µï¸ é«˜åº¦åº§æ¨™æ··å…¥ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã™', 'info');
            
            const canvas = document.getElementById('spine-canvas');
            if (!canvas) {
                log('âŒ spine-canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            // MutationObserverã§DOMå¤‰æ›´ã‚’è©³ç´°ç›£è¦–
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const timestamp = new Date().toISOString();
                        log(`ğŸ•µï¸ [${timestamp}] spine-canvas styleå±æ€§å¤‰æ›´æ¤œå‡º`, 'warning');
                        log(`  å¤‰æ›´å‰: ${mutation.oldValue}`, 'info');
                        log(`  å¤‰æ›´å¾Œ: ${canvas.getAttribute('style')}`, 'info');
                        
                        // åº§æ¨™ç´”åº¦ãƒã‚§ãƒƒã‚¯è‡ªå‹•å®Ÿè¡Œ
                        setTimeout(() => {
                            log('ğŸ” å¤‰æ›´å¾Œã®åº§æ¨™ç´”åº¦ã‚’è‡ªå‹•ãƒã‚§ãƒƒã‚¯ä¸­...', 'info');
                            window.checkCoordinatePurity();
                        }, 100);
                    }
                });
            });
            
            observer.observe(canvas, {
                attributes: true,
                attributeOldValue: true,
                attributeFilter: ['style']
            });
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ï¼ˆåœæ­¢ç”¨ï¼‰
            window._advancedContaminationObserver = observer;
            
            log('âœ… é«˜åº¦åº§æ¨™æ··å…¥ç›£è¦–ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ', 'success');
            return observer;
        }
        
        /**
         * ğŸ›‘ é«˜åº¦åº§æ¨™æ··å…¥ç›£è¦–åœæ­¢
         */
        window.stopAdvancedContaminationWatch = function stopAdvancedContaminationWatch() {
            if (window._advancedContaminationObserver) {
                window._advancedContaminationObserver.disconnect();
                window._advancedContaminationObserver = null;
                log('ğŸ›‘ é«˜åº¦åº§æ¨™æ··å…¥ç›£è¦–ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'success');
            } else {
                log('âš ï¸ ç›£è¦–ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
            }
        }
        
    </script>
</body>
</html>