<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElementObserver Phase 2çµ±åˆãƒ†ã‚¹ãƒˆ - é«˜åº¦åº§æ¨™ç³»çµ±åˆ</title>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            margin: 0;
            touch-action: none;
            color: white;
        }
        .test-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            max-width: 1400px;
            margin: 0 auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .test-area {
            position: relative;
            width: 1000px;
            height: 600px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.3);
            margin: 20px auto;
            border-radius: 15px;
            touch-action: none;
            overflow: hidden;
        }
        .layout-anchor {
            position: absolute;
            background: rgba(255, 107, 107, 0.4);
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            transform: translate(-50%, -50%);
            touch-action: none;
            transition: all 0.2s ease;
        }
        .interactive {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transform: translate(var(--tx, 0), var(--ty, 0)) scale(var(--scale, 1)) rotate(var(--rotation, 0deg));
            touch-action: none;
        }
        .canvas-element {
            border: 2px solid #4ecdc4;
            border-radius: 8px;
            background: rgba(78, 205, 196, 0.2);
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .control-group {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .control-group h3 {
            margin: 0 0 10px 0;
            color: #feca57;
            font-size: 16px;
        }
        button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 15px;
            margin: 3px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button.primary {
            background: rgba(78, 205, 196, 0.3);
            border-color: #4ecdc4;
        }
        button.secondary {
            background: rgba(255, 107, 107, 0.3);
            border-color: #ff6b6b;
        }
        .coordinate-display {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .coord-system {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 11px;
        }
        .coord-system h4 {
            margin: 0 0 5px 0;
            color: #feca57;
            font-size: 12px;
        }
        .coord-value {
            color: #4ecdc4;
            font-family: monospace;
        }
        .log {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .success { color: #26de81; }
        .error { color: #fc5c65; }
        .warning { color: #fed330; }
        .info { color: #45aaf2; }
        .debug { color: #a55eea; }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            margin: 0 5px;
            font-weight: bold;
        }
        .status.active {
            background: rgba(38, 222, 129, 0.3);
            color: #26de81;
            border: 1px solid #26de81;
        }
        .status.inactive {
            background: rgba(252, 92, 101, 0.3);
            color: #fc5c65;
            border: 1px solid #fc5c65;
        }
        .instructions {
            background: rgba(69, 170, 242, 0.2);
            border: 1px solid #45aaf2;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .instructions h3 {
            margin-top: 0;
            color: #45aaf2;
        }
        .phase-indicator {
            background: linear-gradient(45deg, #667eea, #764ba2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .phase-indicator h1 {
            margin: 0;
            font-size: 24px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="phase-indicator">
            <h1>ğŸš€ ElementObserver Phase 2çµ±åˆãƒ†ã‚¹ãƒˆ</h1>
            <p>é«˜åº¦åº§æ¨™ç³»çµ±åˆã‚·ã‚¹ãƒ†ãƒ  - 5ã¤ã®åº§æ¨™ç³»å®Œå…¨åŒæœŸãƒ†ã‚¹ãƒˆ</p>
        </div>
        
        <div class="instructions">
            <h3>ğŸ“ Phase 2çµ±åˆãƒ†ã‚¹ãƒˆé …ç›®</h3>
            <ol>
                <li><strong>5åº§æ¨™ç³»çµ±åˆåˆæœŸåŒ–</strong> - DOMãƒ»Transformãƒ»WebGLãƒ»Skeletonãƒ»Canvasåº§æ¨™ã®çµ±åˆç®¡ç†</li>
                <li><strong>çµ±ä¸€åº§æ¨™API</strong> - `setUnifiedPosition()`ã«ã‚ˆã‚‹å…¨åº§æ¨™ç³»è‡ªå‹•åŒæœŸ</li>
                <li><strong>åº§æ¨™ç³»é–“å¤‰æ›</strong> - DOMâŸ·WebGLãƒ»%âŸ·pxå¤‰æ›ã®åŒæ–¹å‘å¯¾å¿œ</li>
                <li><strong>ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–WebGL</strong> - CSSè¡¨ç¤ºã‚µã‚¤ã‚ºã¨WebGLæç”»ãƒãƒƒãƒ•ã‚¡ã®åˆ†é›¢ç®¡ç†</li>
                <li><strong>PureBoundingBoxé«˜åº¦çµ±åˆ</strong> - Phase 2æ©Ÿèƒ½ã«ã‚ˆã‚‹æ¬¡ä¸–ä»£BBåˆ¶å¾¡</li>
                <li><strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ</strong> - å…¨åº§æ¨™ç³»ã®120fpsåŒæœŸãƒ»å¤‰åŒ–ç›£è¦–</li>
            </ol>
            <p><strong>ğŸ¯ æœŸå¾…çµæœ</strong>ï¼šå…¨åº§æ¨™ç³»ãŒå®Œå…¨åŒæœŸã—ã€1ã¤ã®å¤‰æ›´ãŒè‡ªå‹•çš„ã«å…¨åº§æ¨™ç³»ã«åæ˜ ã•ã‚Œã‚‹</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <h3>ğŸš€ Phase 2åˆæœŸåŒ–</h3>
                <button class="primary" onclick="initializePhase2()">Phase 2é«˜åº¦åˆæœŸåŒ–</button>
                <button onclick="createTestElements()">ãƒ†ã‚¹ãƒˆè¦ç´ ä½œæˆ</button>
                <button onclick="showPhase2Status()">Phase 2çŠ¶æ…‹ç¢ºèª</button>
            </div>
            
            <div class="control-group">
                <h3>ğŸ¯ çµ±ä¸€åº§æ¨™API</h3>
                <button onclick="testUnifiedPosition()">çµ±ä¸€åº§æ¨™ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testCoordinateConversion()">åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="animateCoordinates()">åº§æ¨™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</button>
            </div>
            
            <div class="control-group">
                <h3>ğŸŒ WebGLçµ±åˆ</h3>
                <button onclick="testWebGLSync()">WebGLåŒæœŸãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testSkeletonSync()">SkeletonåŒæœŸ</button>
                <button onclick="testCanvasMatrix()">Canvas Matrix</button>
            </div>
            
            <div class="control-group">
                <h3>ğŸ“± ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ†ã‚¹ãƒˆ</h3>
                <button onclick="testResponsiveCanvas()">ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–Canvas</button>
                <button onclick="testDPRChange()">DPRå¤‰åŒ–ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testBreakpoints()">ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆ</button>
            </div>
            
            <div class="control-group">
                <h3>ğŸ® BBé«˜åº¦çµ±åˆ</h3>
                <button onclick="startAdvancedBoundingBox()">Phase 2 BBé–‹å§‹</button>
                <button onclick="testAdvancedCommit()">é«˜åº¦ã‚³ãƒŸãƒƒãƒˆ</button>
                <button onclick="testBBSync()">BBåº§æ¨™åŒæœŸ</button>
            </div>
            
            <div class="control-group">
                <h3>ğŸ› ï¸ ãƒ‡ãƒãƒƒã‚°ãƒ»åˆ¶å¾¡</h3>
                <button onclick="showCoordinateSystems()">å…¨åº§æ¨™ç³»è¡¨ç¤º</button>
                <button onclick="showAdvancedDebugInfo()">è©³ç´°ãƒ‡ãƒãƒƒã‚°</button>
                <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            </div>
        </div>
        
        <div>
            Phase 2çŠ¶æ…‹: 
            <span id="phase2-status" class="status inactive">Phase 2 Inactive</span>
            <span id="transform-status" class="status inactive">Transform Inactive</span>
            <span id="webgl-status" class="status inactive">WebGL Inactive</span>
            <span id="responsive-status" class="status inactive">Responsive Inactive</span>
            <span id="sync-status" class="status inactive">Sync Inactive</span>
        </div>
        
        <!-- 5åº§æ¨™ç³»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º -->
        <div class="coordinate-display" id="coordinate-display">
            <div class="coord-system">
                <h4>ğŸ“ DOMåº§æ¨™ç³»</h4>
                <div class="coord-value" id="dom-coords">æœªåˆæœŸåŒ–</div>
            </div>
            <div class="coord-system">
                <h4>ğŸ¯ Transformåº§æ¨™ç³»</h4>
                <div class="coord-value" id="transform-coords">æœªåˆæœŸåŒ–</div>
            </div>
            <div class="coord-system">
                <h4>ğŸŒ WebGLåº§æ¨™ç³»</h4>
                <div class="coord-value" id="webgl-coords">æœªåˆæœŸåŒ–</div>
            </div>
            <div class="coord-system">
                <h4>ğŸ® Skeletonåº§æ¨™ç³»</h4>
                <div class="coord-value" id="skeleton-coords">æœªåˆæœŸåŒ–</div>
            </div>
            <div class="coord-system">
                <h4>ğŸ“± Canvasåº§æ¨™ç³»</h4>
                <div class="coord-value" id="canvas-coords">æœªåˆæœŸåŒ–</div>
            </div>
        </div>
        
        <!-- ğŸ¯ ãƒ¡ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆã‚¨ãƒªã‚¢ -->
        <div class="test-area" id="test-area">
            <!-- ãƒ†ã‚¹ãƒˆè¦ç´ ã¯å‹•çš„ã«ä½œæˆ -->
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <!-- ğŸš€ ElementObserver Phase 2 ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç¾¤ -->
    <!-- Phase 1åŸºæœ¬æ©Ÿèƒ½ -->
    <script src="micromodules/element-observer/ElementObserverCore.js"></script>
    <script src="micromodules/element-observer/ElementObserver.js"></script>
    
    <!-- Phase 2é«˜åº¦æ©Ÿèƒ½ -->
    <script src="micromodules/element-observer/ElementObserverTransform.js"></script>
    <script src="micromodules/element-observer/ElementObserverWebGL.js"></script>
    <script src="micromodules/element-observer/ElementObserverResponsive.js"></script>
    <script src="micromodules/element-observer/ElementObserverAdvanced.js"></script>
    
    <!-- ğŸ¯ PureBoundingBox ãƒã‚¤ã‚¯ãƒ­ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç¾¤ -->
    <script src="micromodules/bounding-box/PureBoundingBoxCore.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxBounds.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxUI.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBoxEvents.js"></script>
    <script src="micromodules/bounding-box/PureBoundingBox.js"></script>
    
    <!-- âœ¨ Phase 2çµ±åˆãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ  -->
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let elementObserverAdvanced = null;
        let currentBoundingBox = null;
        let testElements = {};
        let animationId = null;
        let coordinateUpdateInterval = null;
        
        const logElement = document.getElementById('log');
        const statusElements = {
            phase2: document.getElementById('phase2-status'),
            transform: document.getElementById('transform-status'),
            webgl: document.getElementById('webgl-status'),
            responsive: document.getElementById('responsive-status'),
            sync: document.getElementById('sync-status')
        };
        
        // ãƒ­ã‚°é–¢æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            const logLine = `[${timestamp}] ${message}\n`;
            
            const span = document.createElement('span');
            span.className = className;
            span.textContent = logLine;
            logElement.appendChild(span);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            logElement.innerHTML = '';
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(elementName, isActive) {
            const element = statusElements[elementName];
            if (element) {
                element.textContent = isActive ? 
                    elementName.charAt(0).toUpperCase() + elementName.slice(1) + ' Active' : 
                    elementName.charAt(0).toUpperCase() + elementName.slice(1) + ' Inactive';
                element.className = `status ${isActive ? 'active' : 'inactive'}`;
            }
        }
        
        // ãƒ†ã‚¹ãƒˆè¦ç´ ä½œæˆ
        function createTestElements() {
            log('=== ãƒ†ã‚¹ãƒˆè¦ç´ ä½œæˆé–‹å§‹ ===', 'success');
            
            const testArea = document.getElementById('test-area');
            
            // Layout Anchor + Interactive Layerä½œæˆ
            const layoutAnchor = document.createElement('div');
            layoutAnchor.id = 'test-layout-anchor';
            layoutAnchor.className = 'layout-anchor';
            layoutAnchor.style.left = '40%';
            layoutAnchor.style.top = '50%';
            layoutAnchor.style.width = '150px';
            layoutAnchor.style.height = '100px';
            
            const interactive = document.createElement('div');
            interactive.className = 'interactive';
            
            // Canvasè¦ç´ ä½œæˆï¼ˆWebGLç”¨ï¼‰
            const canvas = document.createElement('canvas');
            canvas.id = 'test-canvas';
            canvas.className = 'canvas-element';
            canvas.width = 120;
            canvas.height = 80;
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            
            // Canvaså†…å®¹è¨­å®š
            const ctx = canvas.getContext('2d');
            if (ctx) {
                // ç°¡æ˜“æç”»ï¼ˆWebGLã®ä»£æ›¿ï¼‰
                ctx.fillStyle = 'rgba(78, 205, 196, 0.5)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Test Canvas', canvas.width/2, canvas.height/2);
            }
            
            interactive.appendChild(canvas);
            layoutAnchor.appendChild(interactive);
            testArea.appendChild(layoutAnchor);
            
            // ç–‘ä¼¼Skeletonãƒ»Rendererä½œæˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
            testElements = {
                targetElement: layoutAnchor,
                canvas: canvas,
                skeleton: {
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    scaleX: 1,
                    scaleY: 1,
                    updateWorldTransform: () => {},
                    getBounds: () => ({ x: 0, y: 0, width: 100, height: 80 })
                },
                renderer: {
                    camera: {
                        position: { x: canvas.width / 2, y: canvas.height / 2 },
                        zoom: 1.0,
                        setViewport: (w, h) => {}
                    },
                    canvas: canvas
                }
            };
            
            log('âœ… ãƒ†ã‚¹ãƒˆè¦ç´ ä½œæˆå®Œäº†', 'success');
            log(`  Layout Anchor: ${layoutAnchor.id}`, 'info');
            log(`  Canvas: ${canvas.id} (${canvas.width}x${canvas.height})`, 'info');
            log('  ç–‘ä¼¼Skeletonãƒ»Rendererä½œæˆå®Œäº†', 'info');
        }
        
        // ğŸš€ Phase 2é«˜åº¦åˆæœŸåŒ–
        async function initializePhase2() {
            log('=== ElementObserver Phase 2é«˜åº¦åˆæœŸåŒ–é–‹å§‹ ===', 'success');
            
            try {
                // ãƒ†ã‚¹ãƒˆè¦ç´ ç¢ºèª
                if (!testElements.targetElement) {
                    log('âš ï¸ ãƒ†ã‚¹ãƒˆè¦ç´ æœªä½œæˆ - è‡ªå‹•ä½œæˆã—ã¾ã™', 'warning');
                    createTestElements();
                }
                
                // ElementObserverAdvancedä½œæˆ
                elementObserverAdvanced = new ElementObserverAdvanced();
                
                // Phase 2é«˜åº¦åˆæœŸåŒ–
                const initialized = await elementObserverAdvanced.initializeAdvanced(
                    testElements.targetElement,
                    testElements.canvas,
                    testElements.skeleton,
                    testElements.renderer,
                    {
                        cssWidth: '25%',
                        cssHeight: '25%',
                        bufferWidth: 512,
                        bufferHeight: 512,
                        quality: 'high'
                    }
                );
                
                if (initialized) {
                    // çµ±åˆå¤‰åŒ–ç›£è¦–é–‹å§‹
                    elementObserverAdvanced.onIntegrationChange((event) => {
                        log(`ğŸ”„ çµ±åˆå¤‰åŒ–æ¤œå‡º: ${event.type}`, 'debug');
                        updateCoordinateDisplay();
                    });
                    
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åº§æ¨™è¡¨ç¤ºé–‹å§‹
                    startCoordinateDisplay();
                    
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                    updateStatus('phase2', true);
                    updateStatus('transform', !!elementObserverAdvanced.transform);
                    updateStatus('webgl', !!elementObserverAdvanced.webgl);
                    updateStatus('responsive', !!elementObserverAdvanced.responsive);
                    updateStatus('sync', true);
                    
                    log('âœ… ElementObserver Phase 2åˆæœŸåŒ–å®Œäº†', 'success');
                    log('ğŸ¯ 5åº§æ¨™ç³»çµ±åˆã‚·ã‚¹ãƒ†ãƒ ä½œå‹•é–‹å§‹', 'success');
                    
                } else {
                    throw new Error('Phase 2åˆæœŸåŒ–å¤±æ•—');
                }
                
            } catch (error) {
                log(`âŒ Phase 2åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStatus('phase2', false);
            }
        }
        
        // çµ±ä¸€åº§æ¨™ãƒ†ã‚¹ãƒˆ
        function testUnifiedPosition() {
            if (!elementObserverAdvanced || !elementObserverAdvanced.integrationState.initialized) {
                log('âš ï¸ Phase 2æœªåˆæœŸåŒ–', 'warning');
                return;
            }
            
            log('=== çµ±ä¸€åº§æ¨™APIãƒ†ã‚¹ãƒˆé–‹å§‹ ===', 'success');
            
            const testPositions = [
                { x: 30, y: 40, unit: '%', name: 'å·¦ä¸Š' },
                { x: 70, y: 40, unit: '%', name: 'å³ä¸Š' },
                { x: 70, y: 70, unit: '%', name: 'å³ä¸‹' },
                { x: 30, y: 70, unit: '%', name: 'å·¦ä¸‹' },
                { x: 50, y: 50, unit: '%', name: 'ä¸­å¤®' }
            ];
            
            let index = 0;
            const moveNext = () => {
                if (index >= testPositions.length) {
                    log('âœ… çµ±ä¸€åº§æ¨™APIãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                    return;
                }
                
                const pos = testPositions[index];
                log(`ğŸ¯ çµ±ä¸€åº§æ¨™è¨­å®š: ${pos.name} (${pos.x}${pos.unit}, ${pos.y}${pos.unit})`, 'info');
                
                const success = elementObserverAdvanced.setUnifiedPosition(pos.x, pos.y, pos.unit);
                if (success) {
                    log(`âœ… ${pos.name}ç§»å‹•å®Œäº† - å…¨åº§æ¨™ç³»åŒæœŸç¢ºèª`, 'success');
                } else {
                    log(`âŒ ${pos.name}ç§»å‹•å¤±æ•—`, 'error');
                }
                
                index++;
                setTimeout(moveNext, 1500);
            };
            
            moveNext();
        }
        
        // åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆ
        function testCoordinateConversion() {
            if (!elementObserverAdvanced || !elementObserverAdvanced.integrationState.initialized) {
                log('âš ï¸ Phase 2æœªåˆæœŸåŒ–', 'warning');
                return;
            }
            
            log('=== åº§æ¨™ç³»é–“å¤‰æ›ãƒ†ã‚¹ãƒˆé–‹å§‹ ===', 'success');
            
            const testCoords = { x: 50, y: 60, unit: '%' };
            
            // DOM â†’ WebGL
            const webglCoords = elementObserverAdvanced.convertBetweenCoordinateSystems(
                'dom', 'webgl', testCoords
            );
            log(`DOMâ†’WebGLå¤‰æ›: (${testCoords.x}%, ${testCoords.y}%) â†’ (${webglCoords.x.toFixed(1)}, ${webglCoords.y.toFixed(1)})`, 'info');
            
            // WebGL â†’ DOM
            const domCoords = elementObserverAdvanced.convertBetweenCoordinateSystems(
                'webgl', 'dom', webglCoords
            );
            log(`WebGLâ†’DOMå¤‰æ›: (${webglCoords.x.toFixed(1)}, ${webglCoords.y.toFixed(1)}) â†’ (${domCoords.x.toFixed(1)}%, ${domCoords.y.toFixed(1)}%)`, 'info');
            
            // % â†’ px
            const pixelCoords = elementObserverAdvanced.convertBetweenCoordinateSystems(
                'percent', 'pixel', testCoords
            );
            log(`%â†’pxå¤‰æ›: (${testCoords.x}%, ${testCoords.y}%) â†’ (${pixelCoords.x.toFixed(1)}px, ${pixelCoords.y.toFixed(1)}px)`, 'info');
            
            // px â†’ %
            const percentCoords = elementObserverAdvanced.convertBetweenCoordinateSystems(
                'pixel', 'percent', pixelCoords
            );
            log(`pxâ†’%å¤‰æ›: (${pixelCoords.x.toFixed(1)}px, ${pixelCoords.y.toFixed(1)}px) â†’ (${percentCoords.x.toFixed(1)}%, ${percentCoords.y.toFixed(1)}%)`, 'info');
            
            log('âœ… åº§æ¨™ç³»é–“å¤‰æ›ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
        }
        
        // åº§æ¨™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function animateCoordinates() {
            if (!elementObserverAdvanced || !elementObserverAdvanced.integrationState.initialized) {
                log('âš ï¸ Phase 2æœªåˆæœŸåŒ–', 'warning');
                return;
            }
            
            log('=== åº§æ¨™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ ===', 'success');
            
            let startTime = performance.now();
            const duration = 5000; // 5ç§’
            const centerX = 50, centerY = 50;
            const radiusX = 20, radiusY = 15;
            
            const animate = (currentTime) => {
                const elapsed = currentTime - startTime;
                const progress = (elapsed % duration) / duration;
                const angle = progress * 2 * Math.PI;
                
                const x = centerX + Math.cos(angle) * radiusX;
                const y = centerY + Math.sin(angle) * radiusY;
                
                elementObserverAdvanced.setUnifiedPosition(x, y, '%');
                
                if (elapsed < duration) {
                    animationId = requestAnimationFrame(animate);
                } else {
                    log('âœ… åº§æ¨™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†', 'success');
                    animationId = null;
                }
            };
            
            animationId = requestAnimationFrame(animate);
        }
        
        // WebGLåŒæœŸãƒ†ã‚¹ãƒˆ
        function testWebGLSync() {
            if (!elementObserverAdvanced?.webgl) {
                log('âš ï¸ WebGLæœªåˆæœŸåŒ–', 'warning');
                return;
            }
            
            log('=== WebGLåŒæœŸãƒ†ã‚¹ãƒˆé–‹å§‹ ===', 'success');
            
            // Skeletonä½ç½®ã‚’ç›´æ¥å¤‰æ›´
            const skeleton = elementObserverAdvanced.webgl.skeleton;
            const oldX = skeleton.x;
            const oldY = skeleton.y;
            
            skeleton.x = 300;
            skeleton.y = 200;
            skeleton.updateWorldTransform();
            
            log(`Skeletonä½ç½®å¤‰æ›´: (${oldX}, ${oldY}) â†’ (${skeleton.x}, ${skeleton.y})`, 'info');
            
            // WebGLâ†’DOMåº§æ¨™é€†ç®—
            const domCoords = elementObserverAdvanced.webgl.webGLToDOM(skeleton.x, skeleton.y, {
                coordinateType: 'percent'
            });
            
            log(`WebGLâ†’DOMé€†ç®—: (${skeleton.x}, ${skeleton.y}) â†’ (${domCoords.x.toFixed(1)}%, ${domCoords.y.toFixed(1)}%)`, 'info');
            
            // çµ±ä¸€åº§æ¨™ã§åŒæœŸ
            elementObserverAdvanced.setUnifiedPosition(domCoords.x, domCoords.y, '%');
            
            log('âœ… WebGLåŒæœŸãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
        }
        
        // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–Canvasãƒ†ã‚¹ãƒˆ
        function testResponsiveCanvas() {
            if (!elementObserverAdvanced?.responsive) {
                log('âš ï¸ ResponsiveæœªåˆæœŸåŒ–', 'warning');
                return;
            }
            
            log('=== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–Canvasãƒ†ã‚¹ãƒˆé–‹å§‹ ===', 'success');
            
            const responsive = elementObserverAdvanced.responsive;
            const currentConfig = responsive.getState();
            
            log('ç¾åœ¨ã®è¨­å®š:', 'info');
            log(`  CSSè¡¨ç¤ºã‚µã‚¤ã‚º: ${currentConfig.actualSizes.css.width}x${currentConfig.actualSizes.css.height}`, 'info');
            log(`  æç”»ãƒãƒƒãƒ•ã‚¡: ${currentConfig.actualSizes.buffer.width}x${currentConfig.actualSizes.buffer.height}`, 'info');
            log(`  ã‚¹ã‚±ãƒ¼ãƒ«æ¯”ç‡: ${currentConfig.actualSizes.scaleRatio.x.toFixed(2)}x${currentConfig.actualSizes.scaleRatio.y.toFixed(2)}`, 'info');
            
            // è¨­å®šå¤‰æ›´ãƒ†ã‚¹ãƒˆ
            responsive.updateConfig({
                cssSize: {
                    width: '30%',
                    height: '30%'
                },
                bufferSize: {
                    quality: 'ultra'
                }
            });
            
            setTimeout(() => {
                const newConfig = responsive.getState();
                log('è¨­å®šå¤‰æ›´å¾Œ:', 'success');
                log(`  CSSè¡¨ç¤ºã‚µã‚¤ã‚º: ${newConfig.actualSizes.css.width}x${newConfig.actualSizes.css.height}`, 'info');
                log(`  æç”»ãƒãƒƒãƒ•ã‚¡: ${newConfig.actualSizes.buffer.width}x${newConfig.actualSizes.buffer.height}`, 'info');
                log(`  å“è³ª: ${newConfig.config.bufferSize.quality}`, 'info');
                
                log('âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–Canvasãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
            }, 1000);
        }
        
        // Phase 2 BBé–‹å§‹
        async function startAdvancedBoundingBox() {
            if (!elementObserverAdvanced || !elementObserverAdvanced.integrationState.initialized) {
                log('âš ï¸ Phase 2æœªåˆæœŸåŒ–', 'warning');
                return;
            }
            
            log('=== Phase 2é«˜åº¦BBé–‹å§‹ ===', 'success');
            
            try {
                // æ—¢å­˜ã®BBã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                if (currentBoundingBox) {
                    currentBoundingBox.cleanup();
                    currentBoundingBox = null;
                }
                
                // PureBoundingBoxä½œæˆ
                currentBoundingBox = new PureBoundingBox({
                    targetElement: testElements.targetElement,
                    nodeId: 'phase2-advanced-bb'
                });
                
                // Phase 2é«˜åº¦çµ±åˆ
                const integrated = elementObserverAdvanced.integratePureBoundingBox(currentBoundingBox);
                if (!integrated) {
                    throw new Error('PureBoundingBoxçµ±åˆå¤±æ•—');
                }
                
                // BBå®Ÿè¡Œé–‹å§‹
                const result = await currentBoundingBox.execute({ visible: true });
                
                if (result.success) {
                    log('âœ… Phase 2é«˜åº¦BBé–‹å§‹æˆåŠŸ', 'success');
                    log(`  nodeId: ${result.nodeId}`, 'info');
                    log('  ğŸš€ Phase 2çµ±åˆæ©Ÿèƒ½é©ç”¨æ¸ˆã¿', 'success');
                    
                    // BBé¸æŠè§£é™¤ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–
                    document.addEventListener('boundingBoxDeselected', onAdvancedBoundingBoxDeselected);
                    
                } else {
                    throw new Error(result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
                }
                
            } catch (error) {
                log(`âŒ Phase 2é«˜åº¦BBé–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // Phase 2 BBé¸æŠè§£é™¤ã‚¤ãƒ™ãƒ³ãƒˆ
        function onAdvancedBoundingBoxDeselected(event) {
            log('=== Phase 2é«˜åº¦BBé¸æŠè§£é™¤ã‚¤ãƒ™ãƒ³ãƒˆ ===', 'info');
            log(`  nodeId: ${event.detail.nodeId}`, 'info');
            log(`  finalPosition: ${JSON.stringify(event.detail.finalPosition)}`, 'info');
            log('  ğŸŒŠ Phase 2é«˜åº¦ã‚³ãƒŸãƒƒãƒˆå‡¦ç†å®Ÿè¡Œæ¸ˆã¿', 'success');
            
            updateCoordinateDisplay();
        }
        
        // Phase 2çŠ¶æ…‹è¡¨ç¤º
        function showPhase2Status() {
            if (!elementObserverAdvanced) {
                log('âš ï¸ ElementObserverAdvancedæœªä½œæˆ', 'warning');
                return;
            }
            
            const debugInfo = elementObserverAdvanced.getAdvancedDebugInfo();
            
            log('=== Phase 2è©³ç´°çŠ¶æ…‹ ===', 'info');
            log(`åˆæœŸåŒ–: ${debugInfo.phase2Integration.initialized}`, 'info');
            log(`ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: [${debugInfo.phase2Integration.activeModules.join(', ')}]`, 'info');
            log(`åº§æ¨™ç³»æ•°: ${debugInfo.phase2Integration.coordinateSystemsActive}`, 'info');
            log(`æœ€çµ‚åŒæœŸ: ${debugInfo.phase2Integration.syncAge.toFixed(1)}mså‰`, 'info');
            
            if (debugInfo.modules.transform) {
                log('Transform: âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', 'success');
            }
            if (debugInfo.modules.webgl) {
                log('WebGL: âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', 'success');
            }
            if (debugInfo.modules.responsive) {
                log('Responsive: âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', 'success');
            }
        }
        
        // å…¨åº§æ¨™ç³»è¡¨ç¤º
        function showCoordinateSystems() {
            if (!elementObserverAdvanced || !elementObserverAdvanced.integrationState.initialized) {
                log('âš ï¸ Phase 2æœªåˆæœŸåŒ–', 'warning');
                return;
            }
            
            const coords = elementObserverAdvanced.coordinateSystems;
            
            log('=== å…¨åº§æ¨™ç³»ç¾åœ¨å€¤ ===', 'success');
            log(`ğŸ“ DOM: (${coords.dom.x}${coords.dom.unit}, ${coords.dom.y}${coords.dom.unit})`, 'info');
            log(`ğŸ¯ Transform: tx=${coords.transform.tx}px, ty=${coords.transform.ty}px`, 'info');
            log(`ğŸŒ WebGL: (${coords.webgl.x.toFixed(1)}, ${coords.webgl.y.toFixed(1)})`, 'info');
            log(`ğŸ® Skeleton: (${coords.skeleton.x.toFixed(1)}, ${coords.skeleton.y.toFixed(1)})`, 'info');
            log(`ğŸ“± Canvas: ${coords.canvas.displayWidth}x${coords.canvas.displayHeight} (è¡¨ç¤º) / ${coords.canvas.bufferWidth}x${coords.canvas.bufferHeight} (ãƒãƒƒãƒ•ã‚¡)`, 'info');
        }
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åº§æ¨™è¡¨ç¤º
        function startCoordinateDisplay() {
            if (coordinateUpdateInterval) {
                clearInterval(coordinateUpdateInterval);
            }
            
            coordinateUpdateInterval = setInterval(() => {
                updateCoordinateDisplay();
            }, 100); // 10fpsæ›´æ–°
            
            log('ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åº§æ¨™è¡¨ç¤ºé–‹å§‹', 'info');
        }
        
        function updateCoordinateDisplay() {
            if (!elementObserverAdvanced || !elementObserverAdvanced.integrationState.initialized) {
                return;
            }
            
            const coords = elementObserverAdvanced.coordinateSystems;
            
            document.getElementById('dom-coords').textContent = 
                `${coords.dom.x}${coords.dom.unit}, ${coords.dom.y}${coords.dom.unit}`;
                
            document.getElementById('transform-coords').textContent = 
                `tx: ${coords.transform.tx.toFixed(1)}px\nty: ${coords.transform.ty.toFixed(1)}px\nscale: ${coords.transform.scale}`;
                
            document.getElementById('webgl-coords').textContent = 
                `${coords.webgl.x.toFixed(1)}, ${coords.webgl.y.toFixed(1)}\ncamera: ${coords.webgl.camera.x.toFixed(1)}, ${coords.webgl.camera.y.toFixed(1)}`;
                
            document.getElementById('skeleton-coords').textContent = 
                `${coords.skeleton.x.toFixed(1)}, ${coords.skeleton.y.toFixed(1)}\nscale: ${coords.skeleton.scaleX}, ${coords.skeleton.scaleY}`;
                
            document.getElementById('canvas-coords').textContent = 
                `${coords.canvas.displayWidth}x${coords.canvas.displayHeight}\n${coords.canvas.bufferWidth}x${coords.canvas.bufferHeight}`;
        }
        
        // è©³ç´°ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        function showAdvancedDebugInfo() {
            if (!elementObserverAdvanced) {
                log('âš ï¸ ElementObserverAdvancedæœªä½œæˆ', 'warning');
                return;
            }
            
            const debugInfo = elementObserverAdvanced.getAdvancedDebugInfo();
            
            log('=== Phase 2è©³ç´°ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===', 'debug');
            log(`Phase 2çµ±åˆ: ${JSON.stringify(debugInfo.phase2Integration, null, 2)}`, 'debug');
            log(`åº§æ¨™ç³»: ${JSON.stringify(debugInfo.coordinateSystems, null, 2)}`, 'debug');
            
            if (debugInfo.modules.transform) {
                log(`Transformè©³ç´°: ${JSON.stringify(debugInfo.modules.transform, null, 2)}`, 'debug');
            }
            if (debugInfo.modules.webgl) {
                log(`WebGLè©³ç´°: ${JSON.stringify(debugInfo.modules.webgl, null, 2)}`, 'debug');
            }
            if (debugInfo.modules.responsive) {
                log(`Responsiveè©³ç´°: ${JSON.stringify(debugInfo.modules.responsive, null, 2)}`, 'debug');
            }
        }
        
        // ã‚ªãƒªã‚¸ãƒŠãƒ«ã®consoleã‚’ãƒ©ãƒƒãƒ—
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            if (!args.join(' ').includes('ğŸ‘ï¸') || args.join(' ').includes('ElementObserver') || args.join(' ').includes('Phase 2')) {
                log(args.join(' '), 'info');
            }
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            log(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            log(args.join(' '), 'warning');
        };
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
        window.addEventListener('load', () => {
            log('ğŸŒ ElementObserver Phase 2çµ±åˆãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            log('');
            log('ğŸš€ Phase 2çµ±åˆãƒ†ã‚¹ãƒˆç›®æ¨™:');
            log('  1. 5åº§æ¨™ç³»ã®å®Œå…¨çµ±åˆãƒ»çµ±ä¸€APIå‹•ä½œç¢ºèª');
            log('  2. DOMâŸ·WebGLãƒ»%âŸ·pxåº§æ¨™å¤‰æ›ã®åŒæ–¹å‘ç¢ºèª');
            log('  3. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–WebGLãƒ»DPRå¯¾å¿œã®å‹•ä½œç¢ºèª');
            log('  4. PureBoundingBox Phase 2çµ±åˆæ©Ÿèƒ½ç¢ºèª');
            log('  5. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ 120fpsåº§æ¨™åŒæœŸã®ç¢ºèª');
            log('');
            log('â–¶ï¸ ã€ŒPhase 2é«˜åº¦åˆæœŸåŒ–ã€â†’ã€Œçµ±ä¸€åº§æ¨™ãƒ†ã‚¹ãƒˆã€ã®é †ã§ãƒ†ã‚¹ãƒˆé–‹å§‹');
        });
        
        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            if (coordinateUpdateInterval) {
                clearInterval(coordinateUpdateInterval);
            }
            if (currentBoundingBox) {
                currentBoundingBox.cleanup();
            }
            if (elementObserverAdvanced) {
                elementObserverAdvanced.cleanup();
            }
        });
    </script>
</body>
</html>