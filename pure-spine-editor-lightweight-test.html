<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PureSpineEditorè»½é‡ãƒ†ã‚¹ãƒˆ - ç¬é–“ç§»å‹•è¨ºæ–­</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .mock-canvas {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 150px;
            background: #ffeeee;
            border: 2px solid #ff6666;
        }
        .mock-character {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 100px;
            background: #66ccff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        .bounding-box {
            position: absolute;
            border: 2px solid #66ff66;
            background: rgba(102, 255, 102, 0.2);
            display: none;
            cursor: move;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 8px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .log {
            background: #2d2d2d;
            color: #fff;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ¯ PureSpineEditorè»½é‡ãƒ†ã‚¹ãƒˆ - ç¬é–“ç§»å‹•è¨ºæ–­</h1>
    <p>å®Ÿéš›ã®Spine WebGLã‚’ä½¿ã‚ãšã«ã€åº§æ¨™è¨ˆç®—ã¨ç¬é–“ç§»å‹•å•é¡Œã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™</p>
    
    <div>
        <button onclick="initializeMockEditor()">ğŸš€ ãƒ¢ãƒƒã‚¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼åˆæœŸåŒ–</button>
        <button onclick="showBoundingBoxTest()">ğŸ“¦ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºãƒ†ã‚¹ãƒˆ</button>
        <button onclick="simulateInstantMovement()">âš¡ ç¬é–“ç§»å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
        <button onclick="clearLog()">ğŸ§¹ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
    </div>

    <div class="status" id="status">å¾…æ©Ÿä¸­...</div>

    <div style="position: relative; width: 800px; height: 600px; border: 1px solid #ccc; margin: 20px 0; background: #fafafa;">
        <div id="mockCanvas" class="mock-canvas">
            <div id="mockCharacter" class="mock-character">ã·ã‚‰ã£ã¨ãã‚“</div>
        </div>
        <div id="boundingBox" class="bounding-box"></div>
    </div>

    <div id="log" class="log">è¨ºæ–­ãƒ­ã‚°...\n</div>

    <script>
        let logDiv = document.getElementById('log');
        let mockEditor = null;
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // ãƒ¢ãƒƒã‚¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼åˆæœŸåŒ–
        function initializeMockEditor() {
            addLog('ğŸš€ ãƒ¢ãƒƒã‚¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼åˆæœŸåŒ–é–‹å§‹');
            
            const canvas = document.getElementById('mockCanvas');
            const character = document.getElementById('mockCharacter');
            
            // åˆæœŸä½ç½®è¨˜éŒ²
            const initialRect = canvas.getBoundingClientRect();
            
            mockEditor = {
                canvas: canvas,
                character: character,
                initialPosition: {
                    x: initialRect.left + initialRect.width / 2,
                    y: initialRect.top + initialRect.height / 2
                },
                currentPosition: {
                    x: initialRect.left + initialRect.width / 2,
                    y: initialRect.top + initialRect.height / 2
                }
            };
            
            addLog(`âœ… åˆæœŸä½ç½®è¨˜éŒ²: (${mockEditor.initialPosition.x}, ${mockEditor.initialPosition.y})`);
            updateStatus('âœ… ãƒ¢ãƒƒã‚¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼åˆæœŸåŒ–å®Œäº†');
        }

        // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºãƒ†ã‚¹ãƒˆï¼ˆPureSpineEditoråŒæ§˜ã®è¨ˆç®—ï¼‰
        function showBoundingBoxTest() {
            if (!mockEditor) {
                addLog('âš ï¸ å…ˆã«ãƒ¢ãƒƒã‚¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„');
                return;
            }

            addLog('ğŸ“¦ ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºãƒ†ã‚¹ãƒˆé–‹å§‹');
            addLog('--- PureSpineEditor.calculateBoundingBox() æ¨¡æ“¬å®Ÿè¡Œ ---');

            const canvas = mockEditor.canvas;
            const boundingBox = document.getElementById('boundingBox');
            
            // ğŸ¯ PureSpineEditorã¨åŒã˜åº§æ¨™è¨ˆç®—
            const rect = canvas.getBoundingClientRect();
            const parentRect = canvas.parentElement.getBoundingClientRect();
            
            addLog(`Canvas rect: (${rect.left}, ${rect.top}, ${rect.width}, ${rect.height})`);
            addLog(`Parent rect: (${parentRect.left}, ${parentRect.top})`);

            // Canvasä¸­å¤®ç‚¹è¨ˆç®—ï¼ˆborderè€ƒæ…®ç‰ˆï¼‰
            const computedStyle = getComputedStyle(canvas);
            const borderLeft = parseFloat(computedStyle.borderLeftWidth) || 0;
            const borderTop = parseFloat(computedStyle.borderTopWidth) || 0;
            
            const canvasCenterX = rect.left + borderLeft + canvas.clientWidth / 2;
            const canvasCenterY = rect.top + borderTop + canvas.clientHeight / 2;
            
            addLog(`Canvasä¸­å¤®ç‚¹ï¼ˆborderè€ƒæ…®ï¼‰: (${canvasCenterX}, ${canvasCenterY})`);

            // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚ºãƒ»ä½ç½®è¨ˆç®—
            const boundingWidth = 120;
            const boundingHeight = 90;
            
            // PureSpineEditoræ–¹å¼ï¼šCanvasç¾åœ¨ä½ç½®ã®ä¸­å¤®ç‚¹ã‹ã‚‰ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½ç½®ã‚’é€†ç®—
            const boundingLeft = canvasCenterX - boundingWidth / 2;
            const boundingTop = canvasCenterY - boundingHeight / 2;
            
            // è¦ªè¦ç´ åŸºæº–ã®ç›¸å¯¾åº§æ¨™ã«å¤‰æ›
            const relativeLeft = Math.round(boundingLeft - parentRect.left);
            const relativeTop = Math.round(boundingTop - parentRect.top);
            
            addLog(`ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä½ç½®ï¼ˆç›¸å¯¾ï¼‰: (${relativeLeft}, ${relativeTop})`);

            // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤º
            boundingBox.style.left = relativeLeft + 'px';
            boundingBox.style.top = relativeTop + 'px';
            boundingBox.style.width = boundingWidth + 'px';
            boundingBox.style.height = boundingHeight + 'px';
            boundingBox.style.display = 'block';

            addLog('âœ… ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºå®Œäº†');

            // ä½ç½®æ¤œè¨¼ï¼ˆç¬é–“ç§»å‹•ãƒã‚§ãƒƒã‚¯ï¼‰
            setTimeout(() => {
                const newBoundingRect = boundingBox.getBoundingClientRect();
                const boxCenterX = newBoundingRect.left + newBoundingRect.width / 2;
                const boxCenterY = newBoundingRect.top + newBoundingRect.height / 2;
                
                const diffX = Math.abs(boxCenterX - canvasCenterX);
                const diffY = Math.abs(boxCenterY - canvasCenterY);
                
                addLog(`æ¤œè¨¼: ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ä¸­å¤® = (${boxCenterX}, ${boxCenterY})`);
                addLog(`æ¤œè¨¼: Canvasä¸­å¤®ã¨ã®å·® = (${diffX}, ${diffY})`);
                
                if (diffX < 2 && diffY < 2) {
                    addLog('âœ… åº§æ¨™è¨ˆç®—æ­£å¸¸: ç¬é–“ç§»å‹•ãªã—');
                    updateStatus('âœ… ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºæˆåŠŸ - ç¬é–“ç§»å‹•ãªã—');
                } else {
                    addLog('âŒ åº§æ¨™è¨ˆç®—ç•°å¸¸: ç¬é–“ç§»å‹•ç™ºç”Ÿã®å¯èƒ½æ€§');
                    updateStatus('âš ï¸ åº§æ¨™è¨ˆç®—ã«å•é¡ŒãŒã‚ã‚Šã¾ã™');
                }
            }, 100);
        }

        // ç¬é–“ç§»å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå•é¡ŒãŒç™ºç”Ÿã™ã‚‹å ´åˆã®æ¨¡æ“¬ï¼‰
        function simulateInstantMovement() {
            if (!mockEditor) {
                addLog('âš ï¸ å…ˆã«ãƒ¢ãƒƒã‚¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„');
                return;
            }

            addLog('âš¡ ç¬é–“ç§»å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹');
            addLog('--- å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¨¡æ“¬ ---');

            const canvas = mockEditor.canvas;
            const rect = canvas.getBoundingClientRect();
            
            // ç¾åœ¨ä½ç½®ã‚’è¨˜éŒ²
            const beforeX = rect.left + rect.width / 2;
            const beforeY = rect.top + rect.height / 2;
            addLog(`ç§»å‹•å‰ä½ç½®: (${beforeX}, ${beforeY})`);

            // ğŸš¨ å•é¡Œã®ã‚ã‚‹å‡¦ç†ã‚’æ¨¡æ“¬ï¼šãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºæ™‚ã«Canvasä½ç½®ã‚’çªç„¶å¤‰æ›´
            // PureSpineEditor.syncBoundingToSpine() ã®ã‚ˆã†ãªå‡¦ç†ã§ç™ºç”Ÿã™ã‚‹ç¬é–“ç§»å‹•
            
            // 1ç§’å¾Œã«çªç„¶ä½ç½®å¤‰æ›´
            setTimeout(() => {
                addLog('ğŸš¨ syncBoundingToSpine() æ¨¡æ“¬å®Ÿè¡Œ - Canvasä½ç½®ã‚’çªç„¶å¤‰æ›´');
                
                // åº§æ¨™è¨ˆç®—ã®ã‚ºãƒ¬ã‚’æ¨¡æ“¬
                const newLeft = beforeX - 50; // 50pxå·¦ã«ç§»å‹•
                const newTop = beforeY - 30;  // 30pxä¸Šã«ç§»å‹•
                
                canvas.style.left = newLeft + 'px';
                canvas.style.top = newTop + 'px';
                canvas.style.transform = 'translate(-50%, -50%)';
                
                addLog(`ç§»å‹•å¾Œä½ç½®: (${newLeft}, ${newTop})`);
                addLog('âš¡ ç¬é–“ç§»å‹•ç™ºç”Ÿï¼ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒçªç„¶ç§»å‹•ã—ã¾ã—ãŸ');
                updateStatus('âš¡ ç¬é–“ç§»å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†');
                
                // 3ç§’å¾Œã«å…ƒã«æˆ»ã™
                setTimeout(() => {
                    canvas.style.left = '50%';
                    canvas.style.top = '50%';
                    canvas.style.transform = 'translate(-50%, -50%)';
                    addLog('ğŸ”„ ä½ç½®ã‚’å…ƒã«æˆ»ã—ã¾ã—ãŸ');
                    updateStatus('ğŸ”„ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº† - å…ƒã®ä½ç½®ã«æˆ»ã—ã¾ã—ãŸ');
                }, 3000);
            }, 1000);
        }

        function clearLog() {
            logDiv.textContent = 'è¨ºæ–­ãƒ­ã‚°...\n';
        }

        // åˆæœŸåŒ–
        window.addEventListener('load', () => {
            updateStatus('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº† - ãƒ¢ãƒƒã‚¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼åˆæœŸåŒ–ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
            addLog('ğŸ¯ PureSpineEditorè»½é‡ãƒ†ã‚¹ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
            addLog('ã“ã®ãƒ†ã‚¹ãƒˆã§ã¯å®Ÿéš›ã®Spine WebGLã‚’ä½¿ã‚ãšã«åº§æ¨™è¨ˆç®—å•é¡Œã‚’è¨ºæ–­ã—ã¾ã™');
        });
    </script>
</body>
</html>