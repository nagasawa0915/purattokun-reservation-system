<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PureSpineEditor軽量テスト - 瞬間移動診断</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .mock-canvas {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 150px;
            background: #ffeeee;
            border: 2px solid #ff6666;
        }
        .mock-character {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 100px;
            background: #66ccff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        .bounding-box {
            position: absolute;
            border: 2px solid #66ff66;
            background: rgba(102, 255, 102, 0.2);
            display: none;
            cursor: move;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 8px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .log {
            background: #2d2d2d;
            color: #fff;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>🎯 PureSpineEditor軽量テスト - 瞬間移動診断</h1>
    <p>実際のSpine WebGLを使わずに、座標計算と瞬間移動問題をテストします</p>
    
    <div>
        <button onclick="initializeMockEditor()">🚀 モックエディター初期化</button>
        <button onclick="showBoundingBoxTest()">📦 バウンディングボックス表示テスト</button>
        <button onclick="simulateInstantMovement()">⚡ 瞬間移動シミュレーション</button>
        <button onclick="clearLog()">🧹 ログクリア</button>
    </div>

    <div class="status" id="status">待機中...</div>

    <div style="position: relative; width: 800px; height: 600px; border: 1px solid #ccc; margin: 20px 0; background: #fafafa;">
        <div id="mockCanvas" class="mock-canvas">
            <div id="mockCharacter" class="mock-character">ぷらっとくん</div>
        </div>
        <div id="boundingBox" class="bounding-box"></div>
    </div>

    <div id="log" class="log">診断ログ...\n</div>

    <script>
        let logDiv = document.getElementById('log');
        let mockEditor = null;
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // モックエディター初期化
        function initializeMockEditor() {
            addLog('🚀 モックエディター初期化開始');
            
            const canvas = document.getElementById('mockCanvas');
            const character = document.getElementById('mockCharacter');
            
            // 初期位置記録
            const initialRect = canvas.getBoundingClientRect();
            
            mockEditor = {
                canvas: canvas,
                character: character,
                initialPosition: {
                    x: initialRect.left + initialRect.width / 2,
                    y: initialRect.top + initialRect.height / 2
                },
                currentPosition: {
                    x: initialRect.left + initialRect.width / 2,
                    y: initialRect.top + initialRect.height / 2
                }
            };
            
            addLog(`✅ 初期位置記録: (${mockEditor.initialPosition.x}, ${mockEditor.initialPosition.y})`);
            updateStatus('✅ モックエディター初期化完了');
        }

        // バウンディングボックス表示テスト（PureSpineEditor同様の計算）
        function showBoundingBoxTest() {
            if (!mockEditor) {
                addLog('⚠️ 先にモックエディターを初期化してください');
                return;
            }

            addLog('📦 バウンディングボックス表示テスト開始');
            addLog('--- PureSpineEditor.calculateBoundingBox() 模擬実行 ---');

            const canvas = mockEditor.canvas;
            const boundingBox = document.getElementById('boundingBox');
            
            // 🎯 PureSpineEditorと同じ座標計算
            const rect = canvas.getBoundingClientRect();
            const parentRect = canvas.parentElement.getBoundingClientRect();
            
            addLog(`Canvas rect: (${rect.left}, ${rect.top}, ${rect.width}, ${rect.height})`);
            addLog(`Parent rect: (${parentRect.left}, ${parentRect.top})`);

            // Canvas中央点計算（border考慮版）
            const computedStyle = getComputedStyle(canvas);
            const borderLeft = parseFloat(computedStyle.borderLeftWidth) || 0;
            const borderTop = parseFloat(computedStyle.borderTopWidth) || 0;
            
            const canvasCenterX = rect.left + borderLeft + canvas.clientWidth / 2;
            const canvasCenterY = rect.top + borderTop + canvas.clientHeight / 2;
            
            addLog(`Canvas中央点（border考慮）: (${canvasCenterX}, ${canvasCenterY})`);

            // バウンディングボックスサイズ・位置計算
            const boundingWidth = 120;
            const boundingHeight = 90;
            
            // PureSpineEditor方式：Canvas現在位置の中央点からバウンディングボックス位置を逆算
            const boundingLeft = canvasCenterX - boundingWidth / 2;
            const boundingTop = canvasCenterY - boundingHeight / 2;
            
            // 親要素基準の相対座標に変換
            const relativeLeft = Math.round(boundingLeft - parentRect.left);
            const relativeTop = Math.round(boundingTop - parentRect.top);
            
            addLog(`バウンディングボックス位置（相対）: (${relativeLeft}, ${relativeTop})`);

            // バウンディングボックス表示
            boundingBox.style.left = relativeLeft + 'px';
            boundingBox.style.top = relativeTop + 'px';
            boundingBox.style.width = boundingWidth + 'px';
            boundingBox.style.height = boundingHeight + 'px';
            boundingBox.style.display = 'block';

            addLog('✅ バウンディングボックス表示完了');

            // 位置検証（瞬間移動チェック）
            setTimeout(() => {
                const newBoundingRect = boundingBox.getBoundingClientRect();
                const boxCenterX = newBoundingRect.left + newBoundingRect.width / 2;
                const boxCenterY = newBoundingRect.top + newBoundingRect.height / 2;
                
                const diffX = Math.abs(boxCenterX - canvasCenterX);
                const diffY = Math.abs(boxCenterY - canvasCenterY);
                
                addLog(`検証: バウンディングボックス中央 = (${boxCenterX}, ${boxCenterY})`);
                addLog(`検証: Canvas中央との差 = (${diffX}, ${diffY})`);
                
                if (diffX < 2 && diffY < 2) {
                    addLog('✅ 座標計算正常: 瞬間移動なし');
                    updateStatus('✅ バウンディングボックス表示成功 - 瞬間移動なし');
                } else {
                    addLog('❌ 座標計算異常: 瞬間移動発生の可能性');
                    updateStatus('⚠️ 座標計算に問題があります');
                }
            }, 100);
        }

        // 瞬間移動シミュレーション（問題が発生する場合の模擬）
        function simulateInstantMovement() {
            if (!mockEditor) {
                addLog('⚠️ 先にモックエディターを初期化してください');
                return;
            }

            addLog('⚡ 瞬間移動シミュレーション開始');
            addLog('--- 問題のあるコード実行パターンを模擬 ---');

            const canvas = mockEditor.canvas;
            const rect = canvas.getBoundingClientRect();
            
            // 現在位置を記録
            const beforeX = rect.left + rect.width / 2;
            const beforeY = rect.top + rect.height / 2;
            addLog(`移動前位置: (${beforeX}, ${beforeY})`);

            // 🚨 問題のある処理を模擬：バウンディングボックス表示時にCanvas位置を突然変更
            // PureSpineEditor.syncBoundingToSpine() のような処理で発生する瞬間移動
            
            // 1秒後に突然位置変更
            setTimeout(() => {
                addLog('🚨 syncBoundingToSpine() 模擬実行 - Canvas位置を突然変更');
                
                // 座標計算のズレを模擬
                const newLeft = beforeX - 50; // 50px左に移動
                const newTop = beforeY - 30;  // 30px上に移動
                
                canvas.style.left = newLeft + 'px';
                canvas.style.top = newTop + 'px';
                canvas.style.transform = 'translate(-50%, -50%)';
                
                addLog(`移動後位置: (${newLeft}, ${newTop})`);
                addLog('⚡ 瞬間移動発生！ キャラクターが突然移動しました');
                updateStatus('⚡ 瞬間移動シミュレーション完了');
                
                // 3秒後に元に戻す
                setTimeout(() => {
                    canvas.style.left = '50%';
                    canvas.style.top = '50%';
                    canvas.style.transform = 'translate(-50%, -50%)';
                    addLog('🔄 位置を元に戻しました');
                    updateStatus('🔄 シミュレーション完了 - 元の位置に戻しました');
                }, 3000);
            }, 1000);
        }

        function clearLog() {
            logDiv.textContent = '診断ログ...\n';
        }

        // 初期化
        window.addEventListener('load', () => {
            updateStatus('ページ読み込み完了 - モックエディター初期化ボタンをクリックしてください');
            addLog('🎯 PureSpineEditor軽量テスト読み込み完了');
            addLog('このテストでは実際のSpine WebGLを使わずに座標計算問題を診断します');
        });
    </script>
</body>
</html>