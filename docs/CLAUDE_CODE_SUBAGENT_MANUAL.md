# 📚 Claude Code サブエージェント実践マニュアル

**最終更新**: 2025年1月29日  
**対象**: Claude Code v1.0.60以降  
**用途**: ローカル環境でのサブエージェント設定・運用ガイド

---

## 🎯 サブエージェントとは

### 定義
Claude Codeの**専門特化型AI助手**。特定タスクに特化した独立したAIで、メイン会話のコンテキストとは別に動作します。

### メリット
- **コンテキスト保護**: メイン会話の文脈を汚染しない
- **専門性**: 特定分野に特化した深い知識
- **再利用性**: プロジェクト間で共有可能
- **並列処理**: 複数エージェントの同時実行

---

## 📁 必須ファイル構造

```
プロジェクトルート/
├── .claude/
│   ├── agents/              # エージェント格納フォルダ（必須）
│   │   ├── agent-name.md    # 各エージェントファイル
│   │   └── ...
│   └── settings.local.json  # 権限設定（オプション）
└── ...
```

### 優先順位
1. **プロジェクトレベル**: `.claude/agents/` （最優先）
2. **ユーザーレベル**: `~/.claude/agents/` （共通利用）

---

## 📝 エージェントファイル形式

### 必須構造
```markdown
---
name: エージェント名
description: このエージェントをいつ使うかの説明
tools: Tool1, Tool2, Tool3  # オプション（省略時は全ツール継承）
---

ここにシステムプロンプトを記述。
エージェントの役割、制約、手順などを詳細に書く。
```

### ⚠️ 重要な注意点
- **YAMLヘッダー**: `---` のみ（`---yaml` は誤り）
- **ファイル拡張子**: 必ず `.md`（`.yml` は不可）
- **name**: 小文字とハイフン使用（例: `code-reviewer`）
- **改行**: YAMLヘッダーの後に必ず空行

---

## 🛠️ セットアップ手順

### Step 1: フォルダ作成
```bash
mkdir -p .claude/agents
```

### Step 2: エージェントファイル作成
```bash
# 例：コードレビューエージェント
cat > .claude/agents/code-reviewer.md << 'EOF'
---
name: code-reviewer
description: コードレビューを専門とするエージェント
tools: Read, Grep, Glob
---

あなたはコードレビュー専門のエージェントです。
以下の観点でレビューを行ってください：

1. コーディング規約の遵守
2. パフォーマンスの問題
3. セキュリティリスク
4. 保守性・可読性
EOF
```

### Step 3: 権限設定（オプション）
```bash
cat > .claude/settings.local.json << 'EOF'
{
  "permissions": {
    "allow": [
      "Bash(git:*)",
      "Bash(ls:*)",
      "WebFetch(domain:docs.anthropic.com)"
    ],
    "deny": []
  }
}
EOF
```

---

## 🚀 使用方法

### 1. 明示的な呼び出し
```
# 日本語
「code-reviewerサブエージェントを使って」
「code-reviewerエージェントでレビューして」

# 英語
"Use the code-reviewer subagent"
"Please use code-reviewer to review"
```

### 2. 自動委託
Claude Codeが文脈に応じて自動的に適切なエージェントを選択します。

### 3. `/agents`コマンド
```
/agents
```
利用可能なエージェントの一覧表示・管理

---

## 📋 実装例：5つの基本エージェント

### 1. トラブル診断エージェント
```markdown
---
name: trouble-diagnosis
description: エラーや不具合の診断を専門とする
tools: Read, Bash, Grep, LS
---

体系的な診断手順に従ってトラブルシューティングを行います。
```

### 2. 高速修正エージェント
```markdown
---
name: fast-fixer
description: 明らかなバグの即座修正
tools: Read, Edit, MultiEdit
---

タイポやシンタックスエラーを素早く修正します。
確認不要な軽微な修正のみ行います。
```

### 3. 作業計画エージェント
```markdown
---
name: planning
description: 複雑なタスクの計画立案
tools: Read, Grep, Glob, LS, TodoWrite
---

タスクを分析し、段階的な実装計画を立案します。
実装は行わず、計画のみ作成します。
```

### 4. 慎重編集エージェント
```markdown
---
name: careful-editor
description: 重要なファイルの慎重な編集
tools: Read, Edit, MultiEdit, Glob, LS
---

すべての変更前に確認を取り、
影響範囲を詳細に説明します。
```

### 5. 設計レビューエージェント
```markdown
---
name: review-first
description: 新機能の設計検討
tools: Read, Write, Glob, Grep
---

実装前に設計を検討し、
複数の選択肢を提示します。
```

---

## 🔧 トラブルシューティング

### ❌ エージェントが認識されない

#### チェックリスト
1. ✅ Claude Code v1.0.60以降か確認
2. ✅ `.claude/agents/`フォルダが存在するか
3. ✅ ファイル拡張子が`.md`か
4. ✅ YAMLヘッダーが`---`のみか（`---yaml`は不可）
5. ✅ nameフィールドが正しいか

#### 対処法
```bash
# ファイル構造確認
ls -la .claude/agents/

# YAMLヘッダー確認
head -n 5 .claude/agents/*.md

# Claude Code再起動
# → 新しいセッションで再度試す
```

### ❌ エージェントが期待通り動作しない

#### 改善方法
1. **システムプロンプト強化**
   - より具体的な指示を追加
   - 制約事項を明確化
   - 手順を詳細化

2. **ツール権限調整**
   - 必要最小限のツールのみ許可
   - 不要なツールは削除

3. **名前と説明の見直し**
   - わかりやすい名前に変更
   - descriptionを具体的に

---

## 💡 ベストプラクティス

### 1. 単一責任の原則
```markdown
❌ 悪い例：all-in-one-helper（何でもやる）
✅ 良い例：test-runner（テスト実行専門）
```

### 2. 詳細なプロンプト
```markdown
❌ 悪い例：「コードをレビューしてください」
✅ 良い例：
「以下の観点でレビューしてください：
1. 命名規則（camelCase使用）
2. エラーハンドリング（try-catch必須）
3. コメント（JSDoc形式）」
```

### 3. ツールの制限
```markdown
❌ 悪い例：tools省略（全ツール継承）
✅ 良い例：tools: Read, Grep（必要最小限）
```

### 4. バージョン管理
```bash
# プロジェクトエージェントは必ずコミット
git add .claude/agents/
git commit -m "Add custom subagents"
```

---

## 🎯 効果的な活用パターン

### パターン1: 診断→修正の流れ
```
1. trouble-diagnosis → 問題特定
2. fast-fixer → 即座修正
```

### パターン2: 計画→設計→実装
```
1. planning → 全体計画
2. review-first → 設計検討
3. careful-editor → 慎重実装
```

### パターン3: 並列処理
```
同時に複数エージェント起動：
- code-reviewer（品質チェック）
- test-runner（テスト実行）
- doc-writer（ドキュメント作成）
```

---

## 📊 パフォーマンスTips

### 1. コンテキスト管理
- メイン会話が長くなったらエージェントに委託
- 専門的なタスクは最初からエージェント使用

### 2. 応答速度
- 初回呼び出しは若干遅い（コンテキスト収集のため）
- 2回目以降は高速化

### 3. メモリ効率
- エージェントごとに独立したコンテキスト
- 不要な情報を持ち込まない

---

## 🚨 セキュリティ注意事項

### 1. ツール権限
```json
{
  "permissions": {
    "deny": [
      "Bash(rm:*)",     // 削除コマンド制限
      "Bash(sudo:*)",   // 管理者権限制限
      "WebFetch(*)"     // 外部アクセス制限
    ]
  }
}
```

### 2. 機密情報
- パスワード・APIキーは記載しない
- 個人情報は含めない
- 本番環境の接続情報は避ける

---

## 🔄 継続的改善

### 1. エージェントの育成
```markdown
# 成功パターンを追記
## 💡 実績のある解決策
- パターンA: 〜の場合は〜で解決
- パターンB: 〜エラーは〜が原因

# 失敗パターンを制約に追加
## 🚨 絶対禁止事項
- 〜は絶対にしない（過去に失敗）
```

### 2. プロジェクト固有知識の追加
```markdown
## 📚 このプロジェクト固有の知識
- 使用技術: React, TypeScript
- コーディング規約: ESLint設定準拠
- ディレクトリ構造: src/components/...
```

### 3. 定期的な見直し
- 月1回：使用頻度と効果を評価
- 四半期ごと：プロンプト最適化
- 必要に応じて：新エージェント追加

---

## 📞 サポート

### 問題が解決しない場合
1. このマニュアルを再確認
2. Claude Codeを最新版に更新
3. `.claude/`フォルダを再作成
4. 新しいセッションで再試行

### 改善提案
- 新しいエージェントのアイデア
- より良いプロンプトの書き方
- 成功事例の共有

---

## 🎉 まとめ

サブエージェントシステムは：
- **専門性**：特定タスクのエキスパート
- **効率性**：並列処理と高速実行
- **保守性**：知識の体系化と再利用
- **拡張性**：継続的な改善と成長

正しく設定・活用することで、開発効率を大幅に向上させることができます。

---

**このマニュアルは定期的に更新されます。最新情報は公式ドキュメントも参照してください。**