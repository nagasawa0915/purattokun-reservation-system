# 失敗分析レポート: Canvas サイズ変更問題

**発生日**: 2024年7月25日  
**問題**: ウィンドウリサイズ時にぷらっとくんのサイズが変化する問題  
**影響度**: 高（ユーザー体験に直接影響）

---

## 🚨 問題の概要

### 発生した現象
- ウィンドウサイズを変更すると、ぷらっとくんのサイズが急激に変化
- データ整理前は問題なかったが、新システム導入後に発生

### ユーザーからの報告
> "ウインドウを大きくしたり小さくしたりするとぷらっとくんの大きさが変化するようになりました。なぜだと思いますか？データを整理する前はそんな事なかったと思うのですが。"

---

## 🔍 根本原因分析

### 1. **直接的原因**
新しく追加したSpine Positioning System v2の `resizeCanvasToBackground` メソッドが、ウィンドウリサイズ時にCanvasサイズを背景画像サイズに合わせて動的変更していた。

```javascript
// 問題のコード (spine-responsive-coordinate-system.js:254行目)
this.resizeCanvasToBackground(character.element, backgroundElement);
```

### 2. **設計上の問題**
- CSS設定とJavaScript処理の責任分離が不明確
- 新機能追加時の既存機能への影響検証不足
- 「レスポンシブ対応」の名目で不要な自動リサイズ機能を実装

### 3. **検証不足の問題**
- 新システム追加後のウィンドウリサイズテスト未実施
- データ整理前後の動作比較検証不足

---

## 🛠️ 問題解決プロセス

### Phase 1: 問題の誤認識
**誤った仮説**: CSS設定の固定ピクセル値が原因
```css
/* 誤った修正（一時的）*/
width: 200px !important;
height: 200px !important;
```

### Phase 2: 正しい原因特定
**調査により判明**: JavaScript側の自動リサイズ処理が原因
- `handleResize` → `resizeCanvasToBackground` の呼び出しチェーンを発見

### Phase 3: 根本解決
1. JavaScript自動リサイズ機能を無効化
2. CSS設定を元の相対サイズ（16%）に復元
3. 位置設定も希望の場所（35%, 75%）に調整

---

## 📋 失敗要因の詳細分析

### 1. **設計思想の混乱**
**問題**: "レスポンシブ対応"という名目で過度な自動化を実装
```javascript
// 不要だった自動リサイズ機能
resizeCanvasToBackground(canvasElement, backgroundElement) {
    canvasElement.style.width = `${bgRect.width}px`;
    canvasElement.style.height = `${bgRect.height}px`;
}
```

**教訓**: レスポンシブ対応 ≠ 自動リサイズ。CSS相対単位で十分な場合が多い。

### 2. **機能追加時の影響範囲検証不足**
**問題**: 新しいPositioning Systemが既存のCanvasサイズ制御に干渉
- リサイズイベントリスナーの重複登録
- 複数の箇所からのCanvas操作競合

**教訓**: 新機能は既存機能への影響を必ず検証する。

### 3. **テスト項目の不備**
**実施したテスト**: 基本的な表示確認のみ  
**不足していたテスト**:
- ウィンドウリサイズ時の動作確認
- 異なる画面サイズでの検証
- データ整理前後の比較テスト

### 4. **ドキュメント不足**
**問題**: 既存のCanvas制御方式が文書化されていない
- なぜ16%相対サイズを使用していたかの記録なし
- CSS vs JavaScript の責任分担が不明確

---

## 🎯 再発防止策

### 1. **設計原則の明確化**

#### Canvas サイズ制御のベストプラクティス
```css
/* ✅ 推奨: CSS相対サイズ */
canvas {
    width: 16%;  /* 背景画像に対して一定の比率 */
    height: 16%; /* レスポンシブ対応 */
}

/* ❌ 避ける: JavaScript動的リサイズ */
canvas.style.width = backgroundRect.width + 'px';
```

#### 責任分離の原則
- **CSS**: 見た目・レイアウト・基本的なレスポンシブ対応
- **JavaScript**: 動的なロジック・インタラクション・データ処理

### 2. **機能追加時のチェックリスト**

#### 必須検証項目
- [ ] 既存機能への影響確認
- [ ] ウィンドウリサイズ動作テスト
- [ ] 異なる画面サイズでの表示確認
- [ ] 追加前後の動作比較

#### コードレビューポイント
- [ ] グローバルイベントリスナーの重複チェック
- [ ] CSS設定の上書き・競合チェック
- [ ] 自動化機能の必要性検証

### 3. **テスト強化**

#### 必須テストケース
```javascript
// リサイズテスト例
function testResponsiveResize() {
    const canvas = document.querySelector('#purattokun-canvas');
    const initialSize = { 
        width: canvas.style.width, 
        height: canvas.style.height 
    };
    
    // ウィンドウサイズ変更シミュレーション
    window.dispatchEvent(new Event('resize'));
    
    // サイズが意図せず変更されていないかチェック
    assert(canvas.style.width === initialSize.width);
    assert(canvas.style.height === initialSize.height);
}
```

### 4. **ドキュメント整備**

#### 設計決定の記録
```markdown
## Canvas サイズ設定の設計方針

### 採用方式: CSS相対サイズ (16%)
- **理由**: 背景画像との比率を一定に保つため
- **利点**: ウィンドウリサイズ時も安定した表示
- **制約**: JavaScript による動的サイズ変更は禁止

### 位置設定: ビューポート基準 (35%, 75%)
- **理由**: 背景画像内の特定位置への配置
- **制御方法**: CSS + HTML data-* 属性
```

---

## 💡 学んだ教訓

### 1. **"自動化"は慎重に**
- 自動化は便利だが、予期せぬ副作用を生む可能性
- 既存の安定した仕組みを変更する際は特に注意
- "改善"のつもりが改悪になるケースを警戒

### 2. **既存コードを理解してから拡張**
- なぜその設定になっているかの背景を理解
- 一見古い方法でも、理由がある場合が多い
- 段階的な変更でリスクを最小化

### 3. **ユーザー視点でのテスト**
- 開発者の想定外の使用パターンを考慮
- ウィンドウサイズ変更は基本的な操作
- 実際のユーザー環境での検証重要

### 4. **変更の影響範囲を正確に把握**
- 一つの変更が複数の機能に影響する可能性
- 特にグローバルな設定（CSS、イベントリスナー）は注意
- 変更前後の比較テストを習慣化

---

## 🔧 今後のアクション

### 即座に実施
- [ ] Canvas関連のドキュメント整備
- [ ] テストケースの追加
- [ ] チェックリストの作成・共有

### 中長期的改善
- [ ] 自動テスト環境の構築
- [ ] 設計レビュープロセスの導入
- [ ] 既存コードの設計意図文書化

---

**教訓**: "動いているコードには理由がある。変更は慎重に、検証は徹底的に。"

**作成者**: Claude Code  
**最終更新**: 2024年7月25日