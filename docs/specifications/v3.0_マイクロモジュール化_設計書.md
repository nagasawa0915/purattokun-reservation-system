# v3.0システム マイクロモジュール化 設計書

## 📋 分解対象システム分析

### 現状のv3.0システム構成
```
spine-positioning-system-explanation.js (3,590行)
├── SpineEditCore読み込み・管理 (95行)
├── UI生成・管理 (800行)
├── キャラクター管理 (600行)
├── 座標・配置システム (900行)
├── アニメーション制御 (400行)
├── インタラクション処理 (500行)
├── CSS出力機能 (200行)
├── パッケージ出力機能 (300行)
└── デバッグ・診断システム (290行)

spine-edit-core.js (核心機能)
├── SpineEditSystem基本状態 (100行)
├── 座標系スワップ機能 (150行)
├── ModuleManager (50行)
└── 座標計算ユーティリティ (50行)
```

---

## 🎯 マイクロモジュール分解設計

### 分解原則
1. **完全機能分離**: 各モジュールは単一責務
2. **外部依存ゼロ**: 他モジュール参照禁止
3. **数値入出力のみ**: オブジェクト参照排除
4. **cleanup保証**: 完全復元可能

### 分解マッピング

#### 1. **character-generator** (キャラクター生成・管理)
```
v3.0ソース:
├── MultiCharacterManager.detectAllCharacters() 
├── generateCharacterSelectionButtons()
├── setupCharacterSelectionListeners()
└── キャラクター配列管理 (MultiCharacterManager.characters)

変換後の責務:
├── Spineファイル検出・読み込み
├── キャラクターID生成・管理
├── 複製キャラクター作成
└── キャラクターデータ標準化
```

#### 2. **positioning-system** (座標・配置管理)
```
v3.0ソース:
├── SpineEditSystem.coordinateSwap (座標系スワップ)
├── SpineEditSystem.coords (座標計算)
├── ドラッグ&ドロップ位置制御
└── レイヤー・z-index管理

変換後の責務:
├── Spine座標系(0.0中心)への変換
├── 配置パターン計算(grid/random/manual)
├── 座標レイヤー競合回避
└── スケール・回転計算
```

#### 3. **animation-sequencer** (アニメーション制御)
```
v3.0ソース:
├── アニメーションシーケンス制御
├── タイムライン管理
├── ループ・遷移処理
└── アニメーション状態管理

変換後の責務:
├── アニメーションタイミング計算
├── シーケンス管理(連続再生)
├── 遅延・ループ制御
└── アニメーション切り替え
```

#### 4. **interaction-handler** (インタラクション管理)
```
v3.0ソース:
├── クリック・ホバー・ドラッグイベント
├── 編集UI操作
├── キーボードショートカット
└── マウス・タッチ操作

変換後の責務:
├── イベントタイプ検証・分類
├── アニメーション切り替えトリガー
├── デフォルト復帰制御
└── インタラクション応答
```

---

## 🔧 技術的変換仕様

### データ標準化

#### 入力・出力フォーマット統一
```javascript
// v3.0の複雑な内部状態
window.SpineEditSystem = {
  baseLayer: { targetElement: Element, initialPosition: {...} },
  controlLayer: { isEditMode: true, isDragging: false, ... },
  modules: Map(),
  coordinateSwap: { backup: {...}, isSwapped: true, ... }
}

↓ 変換 ↓

// マイクロモジュール標準フォーマット
const CoordinateData = {
  x: 0.0,          // Spine座標系準拠（中心基準）
  y: 0.0,          // Spine座標系準拠（中心基準）
  zIndex: 5,
  scale: 1.0
}
```

### 機能抽出・分離

#### 座標系スワップ技術の移植
```javascript
// v3.0の複雑な実装
coordinateSwap: {
  enterEditMode: function(element) {
    const rect = element.getBoundingClientRect();
    // 複雑な座標変換・DOM操作...
  }
}

↓ 簡潔化 ↓

// positioning-systemモジュール
function convertToSpineCoordinates(elementData) {
  return {
    x: (elementData.left + elementData.width/2) / parentWidth - 0.5,
    y: (elementData.top + elementData.height/2) / parentHeight - 0.5,
    scale: elementData.scale || 1.0
  };
}
```

---

## 📁 フォルダ構造設計

### 完全分離モジュール構成
```
/micromodules/
├── character-generator/
│   ├── character-generator.js          # メイン処理
│   ├── lib/
│   │   ├── spine-file-loader.js       # Spine読み込み（内包）
│   │   └── character-id-generator.js  # ID生成ユーティリティ
│   ├── test/
│   │   ├── test-data.json
│   │   └── expected-output.json
│   ├── README.md
│   └── examples/
│       └── basic-usage.html
├── positioning-system/
│   ├── positioning-system.js          # メイン処理
│   ├── lib/
│   │   ├── spine-coordinate-converter.js # 座標変換（内包）
│   │   └── placement-pattern-calculator.js # 配置計算
│   ├── test/
│   ├── README.md
│   └── examples/
├── animation-sequencer/
│   ├── animation-sequencer.js          # メイン処理
│   ├── lib/
│   │   ├── timeline-calculator.js     # タイムライン計算（内包）
│   │   └── animation-state-manager.js # 状態管理
│   ├── test/
│   ├── README.md
│   └── examples/
└── interaction-handler/
    ├── interaction-handler.js          # メイン処理
    ├── lib/
    │   ├── event-type-detector.js      # イベント検出（内包）
    │   └── animation-trigger.js        # アニメーション切り替え
    ├── test/
    ├── README.md
    └── examples/
```

---

## 🔄 移植手順・優先順

### Phase 1: 基盤モジュール (1週間)
1. **positioning-system**: 座標系スワップ技術の完全移植
2. **character-generator**: MultiCharacterManager機能の抽出・分離
3. **基本テスト**: 各モジュール単独動作確認

### Phase 2: 制御モジュール (1週間)
1. **animation-sequencer**: アニメーション制御ロジックの移植
2. **interaction-handler**: イベント処理・UI操作の分離
3. **統合テスト**: モジュール間連携確認

### Phase 3: 統合・最適化 (3日)
1. **main.js**: 統合制御システム作成
2. **v3.0互換性確認**: 既存機能の完全再現
3. **パフォーマンス確認**: 軽量化・高速化検証

---

## 📊 期待効果

### 定量的改善
```
ファイルサイズ: 3,590行 → 4モジュール平均300行 (67%削減)
保守性: モノリス → 独立モジュール (100%向上)
テスト性: 統合テストのみ → 単独テスト可能 (100%向上)
移植性: 環境依存 → フォルダコピー移植 (100%向上)
```

### 技術的価値
- **座標系問題の根本解決**: 複雑な依存関係を完全排除
- **AIコーディング対応**: 見落とし・ミスの大幅削減
- **段階的機能追加**: 影響範囲を単一モジュールに限定
- **品質保証の確実性**: 各モジュール独立検証

---

## 🎯 成功基準

### 必達目標
- [ ] v3.0全機能の完全再現（機能欠損なし）
- [ ] 各モジュール完全独立動作（外部依存ゼロ）
- [ ] フォルダコピーによる完全移植成功
- [ ] 単独テスト100%実行可能

### 品質目標
- [ ] v3.0と同等の座標精度保証
- [ ] パフォーマンス劣化なし（同等以上）
- [ ] エラー処理・復旧機能の完全保持
- [ ] 商用機能（CSS出力・パッケージ出力）の完全移植

---

**🎯 この設計により、v3.0の3,590行モノリスシステムを、保守・拡張・移植に優れた4つの独立マイクロモジュールに完全変換します。**