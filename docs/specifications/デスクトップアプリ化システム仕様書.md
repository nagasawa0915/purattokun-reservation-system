# Spine配置システム デスクトップアプリ化仕様書

**プロジェクト名**: Spine Character Position Editor Desktop  
**作成日**: 2025-08-10  
**バージョン**: v1.0  

---

## 📋 1. システム概要

### 1.1 現在のWeb版システム分析

#### **技術構成** 
- **メインシステム**: `spine-positioning-system-explanation.js` (v3.0 モジュール化版)
- **コアモジュール**: `spine-edit-core.js` (基本機能・座標系スワップ)
- **Spine統合**: WebGL実装による高品質アニメーション
- **データ管理**: localStorage基盤・リアルタイム永続化
- **UI方式**: URLパラメータ(`?edit=true`)による動的編集モード

#### **主要機能**
1. **複数キャラクター管理**: purattokun・nezumi両対応
2. **リアルタイム編集**: ドラッグ移動・スケール調整・レイヤー制御
3. **精密位置制御**: 矢印キー微調整(0.1%/1%刻み)・バウンディングボックス編集
4. **商用機能**: CSS出力・完全パッケージ出力(ZIP生成)
5. **モジュール設計**: 動的読み込み・フォールバック対応

#### **アーキテクチャの優位性**
- **2レイヤー設計**: CSS基本配置 + JavaScript動的制御による座標競合防止
- **座標系スワップ技術**: 複雑座標系→シンプル絶対座標の自動変換
- **モジュール化基盤**: 機能追加・拡張が容易な設計

### 1.2 デスクトップアプリ化の目的・価値

#### **ビジネス価値**
1. **制作効率の飛躍的向上**: オフライン動作・高速ファイル処理による作業時間短縮
2. **プロフェッショナル制作ツール**: デスクトップ専用機能による制作品質向上
3. **ポータブル制作環境**: どこでも制作可能な独立ツール
4. **クライアント配布可能**: 制作プロセスの共有・承認フロー効率化

#### **技術的価値**
1. **Web制約からの解放**: ブラウザセキュリティ制限・CORS問題の完全解決
2. **ネイティブファイルシステム**: 高速読み書き・プロジェクト管理
3. **システムリソース活用**: メモリ・CPU最適化・高解像度対応
4. **プラットフォーム統合**: OS標準機能(ドラッグ&ドロップ・通知)

### 1.3 Mac・Windows両対応の技術方針

#### **統一アーキテクチャ**
- **Electron Framework**: 既存Web技術の完全活用
- **ネイティブモジュール**: プラットフォーム固有機能の統合
- **共通コードベース**: 95%の機能を共通化・5%のプラットフォーム特化

---

## 🔧 2. 技術スタック

### 2.1 Electron + 既存Webアプリの統合方針

#### **Phase 1: 基盤統合**
```
デスクトップアプリ構造:
├── main.js (Electronメインプロセス)
├── renderer/ (既存Web版の統合)
│   ├── index.html (メイン編集画面)
│   ├── spine-positioning-system-explanation.js (v3.0統合)
│   ├── spine-edit-core.js (コアモジュール)
│   └── assets/spine/ (既存アセット完全移植)
├── native-modules/ (デスクトップ専用機能)
│   ├── file-manager.js (プロジェクト・ファイル管理)
│   ├── project-exporter.js (エクスポート機能拡張)
│   └── preference-manager.js (設定管理)
└── build/ (配布パッケージ)
    ├── mac/ (macOS向けビルド)
    └── windows/ (Windows向けビルド)
```

#### **統合レベル**
- **Level 1**: 既存機能完全移植(100%互換性保証)
- **Level 2**: デスクトップ拡張機能追加
- **Level 3**: ネイティブ機能統合

### 2.2 ファイルI/O実装

#### **プロジェクトファイル管理**
```javascript
// プロジェクト構造(.spine-project形式)
{
  "meta": {
    "name": "ぷらっとくん配置プロジェクト",
    "version": "1.0",
    "created": "2025-08-10",
    "lastModified": "2025-08-10"
  },
  "characters": {
    "purattokun": {
      "position": { "left": "35%", "top": "75%" },
      "scale": { "x": 0.55, "y": 0.55 },
      "assets": ["purattokun.atlas", "purattokun.json", "purattokun.png"]
    },
    "nezumi": {
      "position": { "left": "60%", "top": "65%" },
      "scale": { "x": 0.45, "y": 0.45 },
      "assets": ["nezumi.atlas", "nezumi.json", "nezumi.png"]
    }
  },
  "settings": {
    "canvas": { "width": "100%", "height": "auto" },
    "background": "scene-background.jpg",
    "export": { "format": "css", "precision": 4 }
  }
}
```

#### **ファイル操作API**
```javascript
// ネイティブファイル操作
const FileManager = {
  // プロジェクト新規作成
  createProject: async (name, template) => { /* 実装 */ },
  
  // プロジェクト読み込み
  loadProject: async (filePath) => { /* 実装 */ },
  
  // プロジェクト保存
  saveProject: async (projectData, filePath) => { /* 実装 */ },
  
  // アセット一括インポート
  importSpineAssets: async (folderPath) => { /* 実装 */ },
  
  // 自動バックアップ
  autoBackup: (projectData, interval = 300000) => { /* 5分間隔 */ }
};
```

### 2.3 既存コード活用率・移行計画

#### **活用率: 85%**
- **完全活用**: spine-edit-core.js・座標系システム・UI制御
- **軽微修正**: ファイルパス処理・ローカルストレージ→ファイルシステム
- **新規実装**: プロジェクト管理・エクスポート機能・設定管理

#### **移行戦略**
1. **Web版並行開発**: 既存システムを破壊しない
2. **段階的機能移植**: Phase毎の安全な移行
3. **互換性保証**: Web版プロジェクトのインポート対応

---

## 🎯 3. 機能要件

### 3.1 現在の配置システム機能の完全移植

#### **Core機能 (100%移植)**
- [x] **リアルタイム編集**: ドラッグ移動・スケール調整
- [x] **精密制御**: 矢印キー移動・数値入力
- [x] **複数キャラクター**: 選択切り替え・レイヤー管理
- [x] **座標系スワップ**: 複雑座標→簡単座標変換
- [x] **ビジュアルフィードバック**: ハンドル・境界線表示

#### **商用機能 (100%移植+強化)**
- [x] **CSS出力**: 軽量CSS生成・商用精度保証
- [x] **パッケージ出力**: ZIP形式・完全パッケージ
- [x] **データ永続化**: リアルタイム保存・復元

### 3.2 デスクトップ版独自機能

#### **🚀 高優先度機能**

##### **1. プロジェクト管理システム**
```
機能詳細:
├── プロジェクト新規作成・テンプレート選択
├── ファイル一括インポート(ドラッグ&ドロップ対応)
├── プロジェクト履歴・最近使用したファイル
├── 自動バックアップ・バージョン管理
└── プロジェクト設定・メタデータ管理
```

##### **2. 高速ファイル処理**
```
対応形式:
├── Spineファイル(.atlas, .json, .png) - 完全対応
├── プロジェクトファイル(.spine-project) - 新規
├── エクスポート(.css, .html, .zip) - 拡張
└── 設定ファイル(.json) - 環境設定
```

##### **3. 拡張エクスポート機能**
```
出力オプション:
├── 軽量CSS出力 - 既存機能拡張
├── 完全HTMLパッケージ - CDN排除・オフライン対応
├── 複数解像度対応 - @media queries自動生成
├── プロジェクト配布用ZIP - クライアント共有向け
└── 設定テンプレート - 再利用可能な設定保存
```

#### **🔧 中優先度機能**

##### **4. 作業効率化ツール**
- **一括編集**: 複数キャラクターの同時調整
- **プリセット管理**: よく使う配置パターンの保存
- **グリッド・スナップ**: 精密配置支援
- **アンドゥ・リドゥ**: 作業履歴20ステップ対応

##### **5. プレビュー・検証機能**
- **リアルタイムプレビュー**: 複数デバイスサイズ同時表示
- **品質チェック**: 配置精度・パフォーマンス検証
- **クロスプラットフォーム確認**: Mac/Windows表示差異チェック

### 3.3 将来のタイムライン統合準備

#### **統合インターフェース設計**
```javascript
// タイムライン統合用API (準備)
const TimelineIntegration = {
  // キーフレーム作成
  createKeyframe: (character, time, properties) => { /* 将来実装 */ },
  
  // アニメーションシーケンス
  createSequence: (keyframes, duration) => { /* 将来実装 */ },
  
  // タイムライン制御
  playTimeline: (sequence, options) => { /* 将来実装 */ },
  
  // 既存システムとの連携
  exportTimelineProject: () => { /* 将来実装 */ }
};
```

#### **データ構造拡張対応**
```javascript
// プロジェクトファイル拡張(v2.0想定)
{
  "characters": { /* 既存構造 */ },
  "timeline": {  // 将来追加予定
    "keyframes": [],
    "sequences": [],
    "settings": {}
  }
}
```

---

## 🎨 4. UI/UX設計

### 4.1 デスクトップアプリとしてのUI改良

#### **メインウィンドウ構成**
```
┌─────────────────────────────────────────────────────┐
│ File  Edit  View  Project  Export  Help             │ メニューバー
├─────────────────────────────────────────────────────┤
│ 🗀 📁 💾 ⚙️ 📤      [プロジェクト名.spine-project] │ ツールバー
├──────────────┬──────────────────────────────────────┤
│              │                                      │
│ 📁 プロジェクト │           🎮 メイン編集エリア          │
│   Assets     │         (既存Web版UIを改良)           │
│   History    │                                      │
│   Settings   │                                      │
│              │                                      │ 
├──────────────┼──────────────────────────────────────┤
│ 🎯 キャラクター │        🔧 プロパティパネル               │
│   Selection  │     位置・スケール・レイヤー制御           │
│   Layer      │                                      │
│              │                                      │
└──────────────┴──────────────────────────────────────┘
```

#### **操作性向上**
- **キーボードショートカット**: Ctrl+S保存・Ctrl+Z取り消し等
- **ドラッグ&ドロップ**: ファイル・画像の直接追加
- **コンテキストメニュー**: 右クリック操作・効率的機能アクセス
- **カスタマイズ可能UI**: パネル配置・サイズ調整・テーマ選択

### 4.2 メニューバー・ファイル操作・ウィンドウ管理

#### **メニューバー構成**

##### **File メニュー**
```
File
├── New Project... (Ctrl+N)
├── Open Project... (Ctrl+O)
├── Recent Projects ▶
├── ─────────────────
├── Save (Ctrl+S)
├── Save As... (Ctrl+Shift+S)
├── Auto Save ✓
├── ─────────────────
├── Import Spine Assets...
├── Import Web Project...
├── ─────────────────
├── Exit (Ctrl+Q)
```

##### **Edit メニュー**
```
Edit
├── Undo (Ctrl+Z)
├── Redo (Ctrl+Y)
├── ─────────────────
├── Copy Character (Ctrl+C)
├── Paste Character (Ctrl+V)
├── Duplicate Character
├── Delete Character (Del)
├── ─────────────────
├── Select All Characters (Ctrl+A)
├── Deselect All (Ctrl+D)
├── ─────────────────
├── Preferences... (Ctrl+,)
```

##### **Export メニュー**
```
Export
├── Export CSS... (Ctrl+E)
├── Export HTML Package...
├── Export Multi-Resolution...
├── ─────────────────
├── Export Project Template...
├── Export Settings...
```

#### **ウィンドウ管理**
- **メインウィンドウ**: 最小サイズ1200x800・最大化対応
- **フローティングパネル**: プロパティ・プレビューを独立ウィンドウ化
- **マルチモニター対応**: パネル配置記憶・モニター間移動
- **ダークモード**: システム設定連動・手動切り替え

### 4.3 プロ制作ツールとしての操作性向上

#### **制作効率化UI**
1. **ワークスペース保存**: パネル配置・ツールバー設定の保存
2. **プリセット管理**: ワンクリック適用・カテゴリ分類
3. **バッチ処理**: 複数プロジェクトの一括エクスポート
4. **プロジェクト統計**: 作業時間・変更履歴・品質指標

#### **精密制御UI**
- **数値入力欄**: 小数点4桁対応・計算式入力
- **グリッド機能**: カスタムグリッド・スナップ設定
- **定規・ガイド**: 位置合わせ支援・ピクセル精度確認
- **拡大・縮小**: 最大500%まで・座標値リアルタイム表示

---

## 📅 5. 開発計画

### 5.1 Phase分け開発計画（7-21日詳細スケジュール）

#### **🚀 Phase 1: 基盤構築 (日数: 3-5日)**
**期間**: Day 1-5  
**目標**: Electron基盤・既存機能移植・基本動作確認

```
Day 1-2: Electron環境構築
├── プロジェクト初期化・package.json設定
├── main.js・renderer設計
├── 既存Web版コード統合テスト
└── 基本ウィンドウ表示・メニューバー実装

Day 3-4: Core機能移植
├── spine-edit-core.js統合・動作確認
├── キャラクター編集機能テスト
├── 座標系スワップ機能検証
└── 基本UI要素配置

Day 5: 統合テスト・Phase 1完了
├── Mac・Windows環境での動作確認
├── 既存機能100%動作検証
└── Phase 2準備・設計詳細化
```

#### **⚡ Phase 2: ファイル管理機能 (日数: 4-6日)**
**期間**: Day 6-11  
**目標**: プロジェクト管理・ファイルI/O・データ永続化

```
Day 6-7: プロジェクトファイル設計
├── .spine-project形式設計・実装
├── JSONスキーマ定義・バリデーション
├── インポート・エクスポート基盤
└── ファイルダイアログ統合

Day 8-9: データ管理システム
├── プロジェクト新規作成・読み込み
├── 自動保存・バックアップ機能
├── 最近使用したファイル管理
└── プロジェクト設定・メタデータ

Day 10-11: ファイル処理最適化
├── 大容量ファイル対応・進捗表示
├── ドラッグ&ドロップ機能
├── エラーハンドリング・回復機能
└── Phase 2完了・統合テスト
```

#### **🎨 Phase 3: UI/UX改良 (日数: 4-6日)**
**期間**: Day 12-17  
**目標**: デスクトップUI・操作性向上・プロ仕様化

```
Day 12-13: メニューシステム構築
├── メニューバー全機能実装
├── キーボードショートカット
├── コンテキストメニュー
└── ツールバー・アイコン設計

Day 14-15: パネルシステム・レイアウト
├── フローティングパネル実装
├── ドッキング・リサイズ機能
├── ワークスペース保存・復元
└── マルチモニター対応

Day 16-17: 操作性向上・最適化
├── ダークモード・テーマシステム
├── パフォーマンス最適化
├── アクセシビリティ対応
└── Phase 3完了・品質確認
```

#### **📤 Phase 4: 拡張機能・配布準備 (日数: 4-6日)**
**期間**: Day 18-23  
**目標**: 拡張エクスポート・ビルド・配布パッケージ

```
Day 18-19: 拡張エクスポート機能
├── 複数解像度対応エクスポート
├── HTMLパッケージ生成拡張
├── プロジェクトテンプレート機能
└── バッチ処理・一括操作

Day 20-21: ビルド・配布システム
├── electron-builder設定・最適化
├── Mac・Windowsビルドテスト
├── インストーラー作成・署名
└── 更新機能・自動アップデート

Day 22-23: 最終調整・リリース準備
├── 包括的品質テスト・バグ修正
├── ドキュメント作成・使用方法
├── パフォーマンステスト・最適化
└── リリース版ビルド・配布準備
```

### 5.2 Mac・Windows向けビルド・テスト手順

#### **ビルド環境構築**
```bash
# 依存関係インストール
npm install --save-dev electron electron-builder

# プラットフォーム別ビルド設定
npm run build:mac      # macOS用 (.app + .dmg)
npm run build:windows  # Windows用 (.exe + installer)
npm run build:all      # 全プラットフォーム
```

#### **electron-builder設定**
```javascript
// build section in package.json
"build": {
  "appId": "com.spine-editor.desktop",
  "productName": "Spine Character Position Editor",
  "directories": {
    "output": "dist"
  },
  "mac": {
    "category": "public.app-category.graphics-design",
    "icon": "assets/icon.icns",
    "target": ["dmg", "zip"]
  },
  "win": {
    "icon": "assets/icon.ico",
    "target": ["nsis", "portable"]
  }
}
```

#### **テスト手順**
```
段階的テストフロー:
1. 開発環境テスト (npm run dev)
   ├── 機能動作確認・デバッグ
   └── ホットリロード・即座フィードバック

2. プロダクションビルドテスト
   ├── Mac: npm run test:mac
   └── Windows: npm run test:windows

3. インストーラーテスト
   ├── 新規インストール・アンインストール
   ├── アップデート動作確認
   └── 権限・署名検証

4. 実機テスト
   ├── 異なるマシンスペックでの動作確認
   ├── 複数OS版での互換性テスト
   └── パフォーマンス・メモリ使用量検証
```

### 5.3 配布・インストーラー作成方針

#### **配布チャネル**
1. **直接配布**: GitHub Releases・公式サイト
2. **自動更新**: アプリ内アップデート機能
3. **将来対応**: Mac App Store・Microsoft Store

#### **インストーラー仕様**
```
Mac版 (.dmg):
├── ドラッグ&ドロップインストール
├── 64KB未満の軽量インストーラー
├── コード署名・公証対応
└── 自動更新・セキュリティ確認

Windows版 (.exe):
├── NSIS形式・ウィザード型インストール
├── レジストリ設定・ファイル関連付け
├── Authenticode署名・SmartScreen対応
└── サイレントインストール・企業配布対応
```

---

## 🛡️ 6. 品質保証

### 6.1 クロスプラットフォーム対応確認項目

#### **🖥️ 表示・UI確認項目**
```
✓ フォント・レンダリング
  ├── Mac: San Francisco・Retina対応
  ├── Windows: Segoe UI・高DPI対応
  └── 共通: Web フォントフォールバック

✓ ウィンドウ・パネル動作
  ├── リサイズ・最大化・最小化
  ├── マルチモニター対応
  └── フローティングパネル・ドッキング

✓ 色・テーマ表示
  ├── ダークモード・ライトモード
  ├── システム設定連動・手動切り替え
  └── アクセシビリティ対応
```

#### **⚙️ システム統合確認項目**
```
✓ ファイルシステム操作
  ├── パス区切り文字 (Windows: \, Mac: /)
  ├── ファイル権限・アクセス制御
  └── 特殊文字・Unicode対応

✓ キーボードショートカット
  ├── Mac: Cmd系ショートカット
  ├── Windows: Ctrl系ショートカット
  └── 国際キーボード対応

✓ ドラッグ&ドロップ
  ├── ファイル・フォルダー対応
  ├── 複数ファイル・バッチ処理
  └── セキュリティ制限・許可確認
```

### 6.2 既存機能の完全保持チェックリスト

#### **🎯 Core機能保持確認**
- [ ] **キャラクター編集**
  - [ ] ドラッグ移動動作・精度確認
  - [ ] スケール調整・比率保持
  - [ ] レイヤー制御・z-index管理
  - [ ] 複数キャラクター選択・切り替え

- [ ] **座標システム**
  - [ ] 座標系スワップ機能・精度確認
  - [ ] パーセント⟷ピクセル変換・計算精度
  - [ ] レスポンシブ対応・画面サイズ変更
  - [ ] バウンディングボックス・境界線表示

- [ ] **データ管理**
  - [ ] リアルタイム保存・復元機能
  - [ ] プロジェクト設定・メタデータ保持
  - [ ] インポート・エクスポート・互換性
  - [ ] エラーハンドリング・データ保護

#### **📤 商用機能保持確認**
- [ ] **CSS出力機能**
  - [ ] 出力内容・精度・軽量性確認
  - [ ] 商用品質・小数点4桁精度保持
  - [ ] 複数キャラクター・統合CSS生成
  - [ ] カスタム設定・フォーマット対応

- [ ] **パッケージ出力機能**  
  - [ ] ZIP生成・完全パッケージ作成
  - [ ] HTML固定化・編集システム除去
  - [ ] Spine WebGL統合・CDN排除
  - [ ] 画像・アセット・依存関係の完全包含

### 6.3 デスクトップ特有の動作テスト項目

#### **🔋 パフォーマンステスト**
```
テスト項目:
├── メモリ使用量 (目標: 200MB以下)
├── CPU使用率 (アイドル時: 1%以下)  
├── 起動時間 (目標: 3秒以下)
├── ファイル読み込み (1MB/秒以上)
└── レスポンス性能 (UI操作遅延<100ms)

測定方法:
├── Mac: Activity Monitor・Instruments
├── Windows: タスクマネージャー・Resource Monitor
└── 自動測定: electron-performance-monitor
```

#### **💾 ストレージ・ファイルテスト**
```
テスト内容:
├── 大容量プロジェクト処理 (100MB以上)
├── 多数ファイル処理 (1000ファイル以上)
├── 権限エラー・読み取り専用対応
├── ファイル破損・回復機能
└── 自動バックアップ・履歴管理

検証方法:
├── 人工的大容量データ生成・処理
├── 権限変更・アクセス制限テスト
├── 停電・強制終了シミュレーション
└── ネットワークドライブ・外部媒体対応
```

#### **🔐 セキュリティ・安定性テスト**
```
セキュリティ項目:
├── ファイルアクセス範囲・サンドボックス制限
├── 外部通信・ネットワークアクセス制御
├── 権限昇格・システムファイル保護
└── 悪意ファイル・不正データ対応

安定性項目:
├── 長時間動作・メモリリーク検出
├── 異常終了・クラッシュ耐性
├── 復旧機能・データ回復能力
└── 多重起動・排他制御
```

---

## 📋 7. 実装詳細・技術仕様

### 7.1 Electronアーキテクチャ詳細

#### **メインプロセス設計**
```javascript
// main.js - Electronメインプロセス
const { app, BrowserWindow, Menu, ipcMain, dialog } = require('electron');
const path = require('path');
const fs = require('fs-extra');

class SpineEditorMain {
  constructor() {
    this.mainWindow = null;
    this.projectManager = new ProjectManager();
    this.setupEventHandlers();
  }

  createMainWindow() {
    this.mainWindow = new BrowserWindow({
      width: 1400,
      height: 900,
      minWidth: 1200,
      minHeight: 800,
      webPreferences: {
        nodeIntegration: false,
        contextIsolation: true,
        enableRemoteModule: false,
        preload: path.join(__dirname, 'preload.js')
      },
      titleBarStyle: 'default', // Mac: 'hiddenInset'
      show: false
    });

    // レンダラープロセス読み込み
    this.mainWindow.loadFile('renderer/index.html');
    
    // 表示最適化
    this.mainWindow.once('ready-to-show', () => {
      this.mainWindow.show();
      if (process.env.NODE_ENV === 'development') {
        this.mainWindow.webContents.openDevTools();
      }
    });
  }

  setupEventHandlers() {
    // アプリ生命周期
    app.whenReady().then(() => this.createMainWindow());
    app.on('activate', () => {
      if (BrowserWindow.getAllWindows().length === 0) {
        this.createMainWindow();
      }
    });
    
    // IPC通信ハンドラー
    ipcMain.handle('project:create', this.handleProjectCreate.bind(this));
    ipcMain.handle('project:load', this.handleProjectLoad.bind(this));
    ipcMain.handle('project:save', this.handleProjectSave.bind(this));
    ipcMain.handle('project:export', this.handleProjectExport.bind(this));
  }
}

// アプリケーション起動
const spineEditor = new SpineEditorMain();
```

#### **レンダラープロセス統合**
```javascript
// preload.js - セキュアなAPI公開
const { contextBridge, ipcRenderer } = require('electron');

contextBridge.exposeInMainWorld('electronAPI', {
  // プロジェクト管理
  project: {
    create: (name, template) => ipcRenderer.invoke('project:create', name, template),
    load: (filePath) => ipcRenderer.invoke('project:load', filePath),
    save: (projectData) => ipcRenderer.invoke('project:save', projectData),
    export: (format, options) => ipcRenderer.invoke('project:export', format, options)
  },
  
  // ファイルシステム
  fs: {
    selectFolder: () => ipcRenderer.invoke('dialog:selectFolder'),
    selectFile: (filters) => ipcRenderer.invoke('dialog:selectFile', filters),
    importAssets: (paths) => ipcRenderer.invoke('fs:importAssets', paths)
  },
  
  // システム統合
  system: {
    getPath: (name) => ipcRenderer.invoke('system:getPath', name),
    openExternal: (url) => ipcRenderer.invoke('system:openExternal', url),
    showNotification: (options) => ipcRenderer.invoke('system:showNotification', options)
  }
});
```

### 7.2 プロジェクトファイル設計

#### **ファイル形式仕様**
```typescript
// プロジェクトファイル型定義
interface SpineProject {
  meta: {
    name: string;
    version: string;
    created: string; // ISO 8601
    lastModified: string;
    author?: string;
    description?: string;
  };
  
  characters: Record<string, CharacterConfig>;
  
  settings: {
    canvas: {
      width: string | number;
      height: string | number;
      background?: string;
    };
    export: {
      format: 'css' | 'html' | 'json';
      precision: number;
      minify: boolean;
    };
    grid?: {
      enabled: boolean;
      size: number;
      snap: boolean;
    };
  };
  
  timeline?: {
    keyframes: Keyframe[];
    sequences: AnimationSequence[];
    settings: TimelineSettings;
  };
}

interface CharacterConfig {
  id: string;
  name: string;
  position: { left: string | number; top: string | number; };
  scale: { x: number; y: number; };
  rotation?: number;
  zIndex: number;
  assets: {
    atlas: string;
    json: string;
    textures: string[];
  };
  animations?: {
    idle: string;
    click?: string;
  };
  visible: boolean;
}
```

### 7.3 ファイルI/O実装

#### **ProjectManager クラス**
```javascript
class ProjectManager {
  constructor() {
    this.currentProject = null;
    this.projectPath = null;
    this.autoSaveInterval = null;
  }

  async createProject(name, template = 'default') {
    const projectData = {
      meta: {
        name,
        version: '1.0.0',
        created: new Date().toISOString(),
        lastModified: new Date().toISOString()
      },
      characters: template === 'purattokun' ? this.getDefaultCharacters() : {},
      settings: this.getDefaultSettings()
    };

    this.currentProject = projectData;
    return projectData;
  }

  async loadProject(filePath) {
    try {
      const fileContent = await fs.readFile(filePath, 'utf8');
      const projectData = JSON.parse(fileContent);
      
      // バリデーション
      this.validateProject(projectData);
      
      this.currentProject = projectData;
      this.projectPath = filePath;
      
      // 自動保存開始
      this.startAutoSave();
      
      return projectData;
    } catch (error) {
      console.error('プロジェクト読み込み失敗:', error);
      throw new Error(`プロジェクト読み込みに失敗しました: ${error.message}`);
    }
  }

  async saveProject(projectData = null, filePath = null) {
    const dataToSave = projectData || this.currentProject;
    const pathToSave = filePath || this.projectPath;

    if (!dataToSave) {
      throw new Error('保存するプロジェクトデータがありません');
    }

    // メタデータ更新
    dataToSave.meta.lastModified = new Date().toISOString();

    try {
      const jsonString = JSON.stringify(dataToSave, null, 2);
      await fs.writeFile(pathToSave, jsonString, 'utf8');
      
      this.currentProject = dataToSave;
      this.projectPath = pathToSave;
      
      return { success: true, path: pathToSave };
    } catch (error) {
      console.error('プロジェクト保存失敗:', error);
      throw new Error(`プロジェクト保存に失敗しました: ${error.message}`);
    }
  }

  startAutoSave(interval = 300000) { // 5分間隔
    if (this.autoSaveInterval) {
      clearInterval(this.autoSaveInterval);
    }

    this.autoSaveInterval = setInterval(async () => {
      if (this.currentProject && this.projectPath) {
        try {
          await this.saveProject();
          console.log('自動保存完了:', new Date().toLocaleTimeString());
        } catch (error) {
          console.error('自動保存失敗:', error);
        }
      }
    }, interval);
  }
}
```

### 7.4 既存システム統合

#### **Web版コード統合戦略**
```javascript
// renderer/js/spine-desktop-integration.js
class SpineDesktopIntegration {
  constructor() {
    this.webSystemLoaded = false;
    this.desktopFeatures = new Map();
  }

  async initializeWebSystem() {
    // 既存Web版システム読み込み
    await this.loadScript('spine-positioning-system-explanation.js');
    await this.loadScript('spine-edit-core.js');
    
    // Web版初期化
    if (window.SpineEditSystem) {
      this.webSystemLoaded = true;
      console.log('✅ Web版システム統合完了');
    }
  }

  async loadScript(src) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = `js/${src}`;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  // デスクトップ拡張機能
  enhanceWithDesktopFeatures() {
    // ファイルシステム連携
    this.addFileSystemIntegration();
    
    // メニューシステム連携
    this.addMenuIntegration();
    
    // ネイティブ通知
    this.addNotificationSystem();
  }

  addFileSystemIntegration() {
    // 既存のlocalStorage保存をファイルシステムに置き換え
    const originalSave = window.SpineEditSystem?.storage?.save;
    if (originalSave) {
      window.SpineEditSystem.storage.save = async (data) => {
        // デスクトップ版ファイル保存
        return await window.electronAPI.project.save(data);
      };
    }
  }
}

// 初期化
document.addEventListener('DOMContentLoaded', async () => {
  const desktopApp = new SpineDesktopIntegration();
  await desktopApp.initializeWebSystem();
  desktopApp.enhanceWithDesktopFeatures();
});
```

---

## 🎯 8. 想定される課題と対策

### 8.1 技術的課題

#### **Web→Desktop移行課題**
```
課題1: Electronのセキュリティ制限
├── 問題: nodeIntegration無効化によるファイルアクセス制限  
├── 対策: contextBridge + preload.js による安全なAPI公開
└── 実装: IPC通信による機能分離・権限最小化

課題2: パフォーマンス問題
├── 問題: Electronアプリの重量化・メモリ消費
├── 対策: 遅延読み込み・メモリ最適化・V8フラグ調整
└── 実装: プロファイリング・ボトルネック特定・最適化

課題3: プラットフォーム依存問題  
├── 問題: Mac・Windows固有の動作差異
├── 対策: 抽象化レイヤー・プラットフォーム判定
└── 実装: 条件分岐・テスト自動化・互換性確保
```

#### **データ移行課題**
```
課題4: localStorage → ファイルシステム移行
├── 問題: Web版プロジェクトとの互換性確保
├── 対策: 変換機能・インポートツール・段階移行
└── 実装: データ変換API・バージョン管理・フォールバック

課題5: ファイルパス・文字コード問題
├── 問題: 日本語・特殊文字・長いパス対応
├── 対策: UTF-8統一・パス正規化・制限確認
└── 実装: path.normalize・文字コード検証・エラーハンドリング
```

### 8.2 UI/UX課題

#### **デスクトップUI適応課題**
```
課題6: Web UI → ネイティブUI変換
├── 問題: ブラウザ固有UI要素のデスクトップ適応
├── 対策: ネイティブコンポーネント・OS標準UI活用
└── 実装: Menu・Dialog・FileSystem API統合

課題7: 高DPI・マルチモニター対応
├── 問題: Retina・4K表示・複数画面での表示問題
├── 対策: スケール対応・DPI認識・画面情報取得
└── 実装: CSS zoom・electron-screen-manager
```

### 8.3 配布・保守課題

#### **配布・更新課題**
```
課題8: コード署名・セキュリティ対応
├── 問題: Mac公証・Windows Defender対応
├── 対策: 開発者証明書・署名プロセス・信頼性確保
└── 実装: electron-builder署名設定・証明書管理

課題9: 自動更新・バージョン管理
├── 問題: アプリ更新・設定移行・下位互換性
├── 対策: electron-updater・段階更新・ロールバック
└── 実装: 更新サーバー・差分更新・設定マイグレーション
```

---

## 🚀 9. 成功指標・期待効果

### 9.1 定量的目標

#### **パフォーマンス目標**
- **起動時間**: 3秒以下（Web版5-8秒から改善）
- **メモリ使用量**: 200MB以下（安定動作）
- **ファイル処理速度**: 1MB/秒以上（大容量対応）
- **UI応答性**: 100ms以下（快適操作）

#### **機能目標**
- **既存機能保持**: 100%互換性確保
- **新機能追加**: 10以上のデスクトップ専用機能
- **プラットフォーム対応**: Mac・Windows完全対応
- **品質目標**: クラッシュ率0.1%以下

### 9.2 定性的効果

#### **制作効率向上**
- **オフライン作業**: インターネット不要・どこでも制作
- **ファイル管理効率**: プロジェクト管理・バックアップ自動化
- **操作性向上**: ネイティブUI・キーボードショートカット
- **品質向上**: 精密制御・リアルタイム保存

#### **ビジネス価値**
- **プロツール化**: 本格的制作ツールとしての価値
- **顧客満足度**: 高品質・効率的な制作体験  
- **競争優位性**: 独自デスクトップツール・差別化要因
- **拡張性**: 将来機能追加・カスタマイズ対応

---

## 📝 10. 補足・注意事項

### 10.1 開発リスク管理

#### **技術リスク**
- **Web版への影響**: 既存システムの完全保護・並行開発
- **プラットフォーム依存**: 動作確認・互換性テストの徹底
- **セキュリティリスク**: Electron脆弱性・定期更新対応

#### **スケジュールリスク**  
- **複雑度増大**: 予想以上の実装コスト・工数増加
- **テスト工数**: クロスプラットフォーム検証・品質保証時間
- **学習コスト**: Electron新技術・デスクトップ開発知識

### 10.2 将来拡張計画

#### **Phase 2機能 (将来)**
- **タイムライン統合**: 既存タイムライン機能の完全統合
- **プラグインシステム**: カスタム機能・拡張機能対応
- **クラウド連携**: プロジェクト同期・チーム作業対応
- **AI支援**: 自動配置提案・最適化機能

#### **エコシステム拡張**
- **Web版連携**: プロジェクト共有・双方向同期
- **外部ツール統合**: Photoshop・After Effects連携
- **ワークフロー自動化**: バッチ処理・CI/CD統合

---

## 📖 まとめ

このデスクトップアプリ化により、現在のWeb版Spine配置システムは**プロフェッショナル制作ツール**として大幅に進化します。

### 主要メリット
1. **既存機能の完全保持** + **デスクトップ専用機能追加**
2. **制作効率の飛躍的向上** + **プロ仕様のワークフロー**
3. **クロスプラットフォーム対応** + **将来拡張性確保**

### 実現可能性
- **技術的実現性**: 95% (既存コード85%活用・Electron実績多数)
- **開発期間**: 14-21日 (段階的実装・リスク分散)
- **投資対効果**: 高い (制作ツール価値・長期活用可能)

この仕様書に基づき、安全で効率的なデスクトップアプリ化を実現し、Spine配置システムを次のレベルに引き上げることができます。

---

**📅 最終更新**: 2025-08-10  
**📋 ドキュメント管理**: docs/specifications/デスクトップアプリ化システム仕様書.md