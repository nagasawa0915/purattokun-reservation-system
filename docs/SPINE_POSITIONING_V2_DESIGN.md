# 🎯 Spine Positioning System v2.0 設計仕様書

**作成日**: 2025-01-31  
**目標**: 軽量・確実・保守性・拡張性を重視したシンプル版

---

## 📊 現状分析結果

### 現在のシステム問題点
- **ファイルサイズ**: spine-positioning-system-minimal.js は **3,169行以上・約150KB**
- **複雑性**: 高度なマルチキャラクター管理・マイグレーション機能・高度UI
- **保守性**: 理解困難・修正リスク大
- **安定性**: 一部機能が不安定（ドラッグ&ドロップ並び替え等）

### 確実に動作する機能（移植対象）
1. ✅ **キャラクター画面クリック選択** - `setupCharacterClickSelection()`
2. ✅ **キーボード矢印キー移動** - `enableKeyboardMovement()` (0.1%/1%刻み)
3. ✅ **レイヤー矢印ボタン移動** - `moveCharacterLayer()` (↑前面/↓背面)
4. ✅ **スケール調整** - `updateScale()` (スライダー・数値・リセット)
5. ✅ **最小化可能メニュー** - モバイル対応パネル配置

### 問題機能（v2.0では除外）
1. ❌ **ドラッグ&ドロップ並び替え** - 複雑すぎる・不安定
2. ❌ **リアルタイムプレビュー配置** - パフォーマンス問題・UI複雑化

---

## 🎯 v2.0設計目標

| 項目 | 現在の課題 | v2.0目標 | 実現方法 |
|------|-----------|----------|---------|
| **軽量性** | 3,169行・150KB | **1,000行以内・50KB以下** | 必要機能のみ抽出 |
| **確実性** | 複雑で不安定 | **動作確認済み機能のみ** | 実証済み機能の移植 |
| **保守性** | 理解困難 | **理解しやすい構造** | モジュール分割・明確命名 |
| **拡張性** | 密結合 | **後から機能追加可能** | プラグイン設計 |

---

## 📁 ファイル構成設計

### 新規ファイル: `spine-positioning-v2.js`

```
spine-positioning-v2.js (1,000行以内)
├── 📦 コア機能モジュール (300行)
│   ├── キャラクター検出・選択
│   ├── 基本移動・スケール調整
│   └── localStorage永続化
├── 🎨 UI管理モジュール (400行)
│   ├── シンプルパネル生成
│   ├── イベントハンドリング
│   └── モバイル対応
├── 🔄 レイヤー管理モジュール (200行)
│   ├── z-index制御
│   └── 前面・背面移動
└── 🔍 デバッグ・診断モジュール (100行)
    ├── 状態表示
    └── エラー検出
```

### 既存システムとの関係
- **完全独立**: 既存ファイルは一切変更しない
- **並行動作**: URLパラメータで切り替え可能
- **段階的移行**: ユーザー選択による移行

---

## 🔧 技術仕様

### 依存関係
```javascript
// ✅ 外部依存ゼロ - バニラJS のみ
// ✅ 既存システムとの競合回避
// ✅ 軽量・高速動作保証
// ✅ モダンブラウザ対応（ES6+）
```

### API設計（シンプル・直感的）
```javascript
// 初期化
SpinePositioningV2.init();

// キャラクター選択
SpinePositioningV2.selectCharacter(index);

// 位置移動
SpinePositioningV2.moveCharacter(deltaX, deltaY);

// スケール調整
SpinePositioningV2.scaleCharacter(scale);

// レイヤー操作
SpinePositioningV2.moveLayer(index, direction); // 'up' | 'down'

// 保存・復元
SpinePositioningV2.save();
SpinePositioningV2.restore();

// 状態取得
SpinePositioningV2.getStatus();
```

### データ構造設計
```javascript
// シンプルな状態管理
const state = {
    characters: [
        {
            id: "purattokun-canvas",
            name: "ぷらっとくん",
            element: HTMLElement,
            position: { left: "18%", top: "49%" },
            scale: 0.55,
            zIndex: 1000,
            isActive: true
        }
    ],
    activeIndex: 0,
    editMode: true,
    unsavedChanges: false
};
```

---

## 🎨 UI設計（シンプル・高速）

### パネル構成

#### 1. キャラクター選択パネル（簡素版）
```
┌─────────────────────┐
│ 🎭 キャラクター選択    │
├─────────────────────┤
│ ⚪ ぷらっとくん       │
│ ⚫ 背景要素1         │
│ ⚪ 背景要素2         │
└─────────────────────┘
```

#### 2. 操作パネル（統合版）
```
┌─────────────────────┐
│ ⚡ 操作パネル         │
├─────────────────────┤
│ ⌨️ 矢印キー: 位置移動  │
│ 📏 スケール: [▓▓▓░] │
│ 🔢 数値: [1.25] [⟲] │
│ 📚 レイヤー: [↑][↓]  │
└─────────────────────┘
```

#### 3. 状況表示パネル（オプション・最小化可能）
```
┌─────────────────────┐
│ 📊 状況 [_]          │
├─────────────────────┤
│ 📍 X: 18.5%, Y: 49.2% │
│ 📏 Scale: 1.25       │
│ 📚 Layer: 2/3        │
└─────────────────────┘
```

### モバイル対応
- **縦積み配置**: パネルを縦に配置
- **タッチ最適化**: ボタンサイズ・間隔調整
- **最小化対応**: 必要時のみ展開

---

## 🔄 実装計画

### Phase 1: コア機能実装（300行目標）

#### 1.1 キャラクター検出システム
```javascript
// spine-positioning-system-minimal.js の detectCharacters() ベース
function detectCharacters() {
    // 5種類のセレクターで検出
    // - #purattokun-canvas（メイン）
    // - canvas[id*="purattokun"]
    // - .spine-character
    // - [data-spine-character]
    // - canvas（fallback）
}
```

#### 1.2 選択システム
```javascript
// setupCharacterClickSelection() 簡略版
function setupCharacterSelection() {
    // クリック・タッチイベント統合
    // 重なった要素の最前面選択
    // 視覚的フィードバック（境界線ハイライト）
}
```

#### 1.3 基本移動システム
```javascript
// enableKeyboardMovement() 移植
function enableKeyboardMovement() {
    // ArrowUp/Down/Left/Right 対応
    // 0.1%刻み（通常）・1%刻み（Shift押下）
    // 入力フィールドでの無効化
}
```

#### 1.4 スケール調整システム
```javascript
// updateScale() 移植
function updateScale(newScale) {
    // CSS transform: scale() 適用
    // 0.1-3.0 範囲・0.01刻み
    // リアルタイム反映
}
```

#### 1.5 基本永続化
```javascript
// savePositionV2() 簡略版
function saveToStorage() {
    // localStorage 'spine-positioning-v2' キー
    // 必要最小限のデータのみ保存
    // エラーハンドリング
}
```

### Phase 2: シンプルUI実装（400行目標）

#### 2.1 パネル生成システム
```javascript
function createPanels() {
    // 3つのパネルを動的生成
    // CSS-in-JS による軽量スタイル
    // モバイル・デスクトップ両対応
}
```

#### 2.2 イベントハンドリング
```javascript
function setupEventHandlers() {
    // 統合イベントシステム
    // マウス・タッチ・キーボード対応
    // メモリリーク防止
}
```

#### 2.3 レスポンシブ対応
```javascript
function applyResponsiveStyles() {
    // 768px ブレークポイント
    // 動的レイアウト調整
    // パフォーマンス最適化
}
```

### Phase 3: レイヤー管理実装（200行目標）

#### 3.1 z-index管理
```javascript
// moveCharacterLayer() 移植
function manageZIndex() {
    // 動的z-index計算
    // 重なり順序制御
    // 全キャラクター同期
}
```

#### 3.2 前面・背面移動UI
```javascript
function createLayerControls() {
    // ↑↓ ボタンUI
    // 最前面・最背面制限
    // 視覚的フィードバック
}
```

---

## 🚀 移行・テスト計画

### 切り替え機能
```javascript
// URLパラメータによる版切り替え
// ?edit=true&version=v2    → v2.0システム使用
// ?edit=true               → 既存システム使用（デフォルト）
// ?edit=true&version=test  → テストモード（両方読み込み）
```

### 並行テスト期間
1. **既存システム完全保持** - 削除・変更禁止
2. **v2.0 独立動作確认** - 新規ファイルのみ
3. **ユーザー選択移行** - 段階的切り替え
4. **フィードバック収集** - 問題点特定・改善

### 品質保証チェックリスト
- [ ] **軽量性**: 1,000行以内・50KB以下
- [ ] **動作確認**: 全機能テスト完了
- [ ] **互換性**: 既存システム非破壊
- [ ] **レスポンシブ**: モバイル・デスクトップ対応
- [ ] **エラーハンドリング**: 安全な障害対応
- [ ] **メモリリーク**: イベントリスナー適切解放

---

## 📈 期待効果

### 開発効率向上
- **理解時間**: 3,169行 → 1,000行（約70%削減）
- **修正リスク**: 複雑システム → シンプル設計（大幅軽減）
- **新機能追加**: 密結合 → プラグイン設計（容易化）

### ユーザー体験向上
- **読み込み速度**: 150KB → 50KB（約67%削減）
- **動作安定性**: 不安定機能除去（信頼性向上）
- **操作性**: 複雑UI → シンプルUI（直感性向上）

### 保守性向上
- **障害対応**: 複雑デバッグ → 明確構造（高速化）
- **機能拡張**: 全体修正 → モジュール追加（安全化）
- **チームワーク**: 属人化 → 標準化（共有化）

---

## 🛡️ リスク管理

### 技術リスク
- **互換性問題**: 並行テスト期間での入念確認
- **機能不足**: 段階的実装・フィードバック収集
- **パフォーマンス**: 軽量設計・最適化重視

### 運用リスク
- **移行混乱**: URLパラメータ切り替えによる安全移行
- **データ損失**: 既存保存データ完全保持
- **ユーザー困惑**: 十分な説明・サポート提供

---

## 📋 実装チェックリスト

### Phase 1: コア機能（300行）
- [ ] キャラクター検出システム実装
- [ ] 選択システム実装（クリック・タッチ対応）
- [ ] キーボード移動システム実装
- [ ] スケール調整システム実装
- [ ] 基本永続化システム実装
- [ ] Phase 1動作テスト完了

### Phase 2: UI実装（400行）
- [ ] パネル生成システム実装
- [ ] イベントハンドリング統合
- [ ] レスポンシブ対応実装
- [ ] モバイル最適化実装
- [ ] Phase 2動作テスト完了

### Phase 3: レイヤー管理（200行）
- [ ] z-index管理システム実装
- [ ] 前面・背面移動UI実装
- [ ] レイヤー操作テスト完了
- [ ] Phase 3動作テスト完了

### 総合テスト
- [ ] 全機能統合テスト
- [ ] モバイル・デスクトップ両対応確認
- [ ] 既存システム非破壊確認
- [ ] URLパラメータ切り替え確認
- [ ] データ保存・復元テスト
- [ ] エラーハンドリングテスト

### 品質確認
- [ ] ファイルサイズ: 1,000行以内・50KB以下
- [ ] 動作速度: 既存システム同等以上
- [ ] メモリ使用量: 軽量化確認
- [ ] コード品質: ESLint チェック通過

---

**次のステップ**: Phase 1 コア機能実装開始