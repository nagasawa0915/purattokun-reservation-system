# 🚨 レスポンシブ版位置ズレ問題

## 📋 問題の概要

### 症状
- デスクトップ版でキャラクターの位置がズレる（20%, 70%の位置に表示）
- モバイル版では正常に表示される
- 同じページなのにデバイスによって位置が異なる

### 発生条件
- デスクトップ版（768px以上）でのみ発生
- モバイル版（768px以下）では正常
- index.htmlとspine-character-manager.jsの両方が読み込まれている環境

### 影響範囲
- ビジュアル/表示の問題
- 機能は正常に動作

---

## 🔍 原因分析

### 根本原因
**Canvas要素のCSSでwidth指定がなかったため、JavaScriptの設定値と競合していた**

### 詳細な原因
1. **2つの異なるSpine初期化システムの競合**
   - index.html: Canvas内部解像度200x200
   - spine-character-manager.js: Canvas内部解像度120x120、位置20%, 70%

2. **CSSのwidth指定の有無による挙動の違い**
   - モバイル版: `width: 30%`が明示的に指定されている → CSS優先で正常
   - デスクトップ版: width指定なし → JavaScriptの値が適用されてズレる

3. **位置計算への影響**
   - `transform: translate(-50%, -50%)`は要素のサイズに基づいて計算
   - サイズが異なると中心点の計算結果も変わる

---

## ⚡ 有効な解決策・回避策

### 解決策1: CSSでwidth指定を追加 ✅ 【確定済み解決策】
**モバイル版と同じwidth値を指定することで解決**

```css
/* デスクトップ版CSS */
#purattokun-canvas {
    position: absolute;
    left: 18%;
    top: 49%;
    width: 30%;    /* ← これを追加（モバイル版と同じ値） */
    height: auto;
    transform: translate(-50%, -50%);
}
```

**なぜこれで解決するのか:**
- モバイル版が正常な理由は`width: 30%`の明示的指定
- 同じ値にすることで位置計算が一致
- JavaScriptの固定値（120px）がCSSで上書きされる

---

## 📝 試行錯誤の履歴

### Case 1: width: 10%で試行 ❌ 失敗
- **日時**: 2025-01-30
- **内容**: デスクトップ版は画面が広いので小さく表示と推測
- **結果**: 位置ズレは改善されず
- **原因**: サイズの一致が位置の一致に必要だった
- **教訓**: 推測より実証を優先すべき

### Case 2: width: 30%で試行 ✅ 成功
- **日時**: 2025-01-30
- **内容**: モバイル版と同じ30%を適用
- **結果**: 完全に解決、位置ズレなし
- **原因**: サイズ一致により位置計算も一致

---

## 🎯 重要な教訓

### 1. モバイル版が正常 = その設定を完全にコピーすべき
レスポンシブで片方だけ正常な場合、正常な方の設定を分析して同じ条件を適用する

### 2. CSSのwidth指定は見た目だけでなく位置計算にも影響
- width未指定 → JavaScriptの値が適用される
- width指定あり → CSSが優先される
- 位置計算（translate）はサイズに依存する

### 3. 複数の初期化システムの競合に注意
- index.htmlの独自Spine初期化
- spine-character-manager.jsの初期化
- 両方が動作すると予期しない挙動になる

---

## 🔧 予防策

### 1. CSSでの明示的なサイズ指定
```css
/* 基本スタイルに必ずwidth/heightを含める */
#purattokun-canvas {
    width: [適切な値];
    height: auto;
}
```

### 2. レスポンシブ設計の統一
- モバイル版とデスクトップ版で同じ設計思想を適用
- 片方だけ特別扱いしない

### 3. 初期化システムの一元化
- 複数の初期化コードが存在する場合は統合を検討
- または明確な優先順位を設定

---

## 🏷️ タグ
`#位置` `#レスポンシブ` `#CSS` `#Canvas` `#width` `#競合`

## 📌 関連ファイル
- index.html (行156-168, 行483-489)
- assets/spine/spine-character-manager.js (行226-249)

## 🔗 関連する問題
- [ウィンドウリサイズ問題.md](./ウィンドウリサイズ問題.md)
- [Canvasサイズ変更問題.md](./Canvasサイズ変更問題.md)
- [編集モード位置ずれ問題.md](./編集モード位置ずれ問題.md)