---
title: 編集モードでキャラクター位置がずれる問題
status: 解決済み
tags: [位置, レイヤー, 編集システム, Canvas]
aliases: 
  - 編集モードで枠がずれる
  - キャラクター編集で違う場所に枠が出る
  - edit mode position mismatch
created: 2025-01-27
updated: 2025-01-27
---

# 🎯 編集モードでキャラクター位置がずれる問題

## 📊 現在の状況
**ステータス**: 解決済み - 編集Canvas作成時の位置計算を修正して解決

## ⚡ 有効な解決策・回避策

### 解決策1: 診断ツール - 編集モード起動時の要素確認
```javascript
// F12コンソールで実行
console.log('🔍 編集モード診断開始...');
const character = document.querySelector('#purattokun-canvas');
const charRect = character.getBoundingClientRect();
console.log('キャラクター位置:', {
    left: charRect.left,
    top: charRect.top,
    width: charRect.width,
    height: charRect.height,
    style: {
        left: character.style.left,
        top: character.style.top,
        transform: character.style.transform
    }
});
```

### 解決策2: spine-positioning-system-explanation.js の修正
編集Canvas作成時に実際のキャラクター位置を正確に取得し、編集終了時に元の位置に戻す処理を実装：

```javascript
// createCharacterCanvas関数の修正
function createCharacterCanvas() {
    characterCanvas = document.querySelector('.character-canvas');
    if (!characterCanvas) {
        characterCanvas = document.createElement('div');
        characterCanvas.className = 'character-canvas';
        characterCanvas.id = 'character-canvas-edit';
        
        // ぷらっとくんの実際の位置とサイズを取得
        const charRect = character.getBoundingClientRect();
        const parentRect = character.parentElement.getBoundingClientRect();
        
        // 編集用Canvasをキャラクターの位置に配置
        characterCanvas.style.position = 'absolute';
        characterCanvas.style.left = (charRect.left - parentRect.left) + 'px';
        characterCanvas.style.top = (charRect.top - parentRect.top) + 'px';
        characterCanvas.style.width = charRect.width + 'px';
        characterCanvas.style.height = charRect.height + 'px';
        characterCanvas.style.transform = 'none';
        
        // 親要素に追加してキャラクターを中に移動
        const parent = character.parentElement;
        parent.appendChild(characterCanvas);
        characterCanvas.appendChild(character);
        
        // キャラクターの位置を編集Canvas内での相対位置に調整
        character.style.position = 'absolute';
        character.style.left = '50%';
        character.style.top = '50%';
        character.style.transform = 'translate(-50%, -50%)';
        
        // リサイズハンドル追加...
    }
}
```

### 解決策3: 編集終了時の位置復元処理
```javascript
// endEditMode関数の修正
function endEditMode() {
    if (characterCanvas && character) {
        const originalParent = document.querySelector('.hero-content') || document.body;
        
        // 元の親要素に戻す
        originalParent.appendChild(character);
        
        // 編集Canvas内での位置から元の位置を計算して復元
        // （詳細な計算ロジックは実装済み）
        
        // 編集Canvasを削除
        if (characterCanvas.parentElement) {
            characterCanvas.parentElement.removeChild(characterCanvas);
        }
        characterCanvas = null;
    }
    // その他の終了処理...
}
```

## 🔍 問題の詳細
### 発生条件
- index.html?edit=true で編集モードを開いた時
- 「キャラクター編集」ボタンをクリックした時

### 症状
- キャラクター（ぷらっとくん）がいる位置と違う場所に編集枠が表示される
- 編集枠が画面の別の場所に出現する

### 環境情報
- ブラウザ: 全ブラウザで発生
- index.html の本番環境での編集モード

## 📝 試行錯誤の履歴

### ✅ Case #1: 2025-01-27 - 編集Canvas作成時の位置計算修正

**問題**: 編集モード開始時、キャラクターの実際の位置と編集枠の位置がずれる

**試した方法**: 
```javascript
// spine-positioning-system-explanation.js の createCharacterCanvas 関数を修正
// 修正前：編集Canvasの位置を固定値で作成
// 修正後：実際のキャラクター位置を取得して編集Canvasを配置

const charRect = character.getBoundingClientRect();
const parentRect = character.parentElement.getBoundingClientRect();

characterCanvas.style.left = (charRect.left - parentRect.left) + 'px';
characterCanvas.style.top = (charRect.top - parentRect.top) + 'px';
characterCanvas.style.width = charRect.width + 'px';
characterCanvas.style.height = charRect.height + 'px';
```

**結果**: ✅ 完全に解決

**原因推測/学び**: 
- 編集システムは`#purattokun-canvas`の位置を親要素からの相対位置として計算する必要があった
- index.htmlではキャラクターがパーセント位置（18%, 49%）で配置されているため、実際の位置を正確に取得する必要があった
- 編集終了時にキャラクターを元の親要素に戻す処理も必要だった

**環境**: Chrome/Firefox/Edge, Windows/Mac, localhost:8000

