# デスクトップアプリウィンドウリサイズ問題 - トラブルシューティング

## 📋 問題分類
**分類**: レイアウト・表示問題 - ウィンドウリサイズ対応  
**発生場所**: デスクトップアプリ Spineプレビュー機能  
**影響範囲**: Spineキャラクターの表示品質・デバッグ機能  

## 🚨 問題の症状

### 問題1: ウィンドウリサイズ時のキャラクター縦横比変化

#### 具体的な症状
- **キャラクター歪み**: ウィンドウサイズ変更時にSpineキャラクターが横長・縦長に変形
- **アスペクト比異常**: 正方形が期待されるキャラクターが長方形に歪む
- **表示品質劣化**: キャラクターの本来の見た目が損なわれる

#### 症状確認方法
1. デスクトップアプリでSpineプレビューを表示
2. ウィンドウサイズを横方向・縦方向に変更
3. Spineキャラクターの縦横比を観察
4. キャラクターが歪んで表示されることを確認

### 問題2: デバッグ関数アクセシビリティ問題

#### 具体的な症状
- **関数未定義エラー**: `window.enableSpineDebugMode is not a function`
- **デバッグ機能利用不可**: 開発時のデバッグモードにアクセスできない
- **トラブルシューティング困難**: 問題調査時のツールが使用不可

#### 症状確認方法
1. デスクトップアプリを起動
2. F12開発者ツールでコンソールを開く
3. `window.enableSpineDebugMode()`を実行
4. 「is not a function」エラーが表示されることを確認

## 🔍 根本原因

### 問題1の技術的原因
**Canvas要素のアスペクト比制御不足**:
- **Canvas要素**: ウィンドウサイズに追従してwidth/heightが変化
- **Spine表示**: Canvas内容がウィンドウ形状に合わせて伸縮
- **歪み発生**: 正方形コンテンツが長方形Canvasに表示されて変形

### 問題2の技術的原因
**Electron環境でのデバッグモード判定問題**:
- **条件分岐**: `isDev && isElectron`条件でデバッグ関数が制限
- **環境判定**: Electron環境でデバッグモードが正しく判定されない
- **関数未登録**: デバッグ関数がwindowオブジェクトに登録されない

## ⚡ 有効な解決策・回避策

### ✅ **解決策1: Canvas要素アスペクト比固定**（解決済み - 2025-08-15）

**修正対象ファイル**: `src/renderer/spine-preview-layer.js`

#### **修正箇所**: Canvas要素CSS設定
**場所**: `updateCanvasSize`関数内  
**修正内容**:
```javascript
// 修正前（問題のあるコード）
this.canvas.width = targetWidth;
this.canvas.height = targetHeight;

// 修正後（正しいアスペクト比制御）
this.canvas.width = targetWidth;
this.canvas.height = targetWidth; // 常に正方形に固定

// CSS追加（歪み防止）
this.canvas.style.objectFit = 'contain';
this.canvas.style.objectPosition = 'center';
```

#### **技術的詳細**
- **正方形Canvas**: width = height で常に正方形を維持
- **object-fit: contain**: コンテンツのアスペクト比を保持
- **object-position: center**: コンテンツを中央配置
- **歪み防止**: ウィンドウ形状に関わらずキャラクター形状を保持

#### **実装結果**
- ✅ **アスペクト比維持**: ウィンドウリサイズ時もキャラクター形状が保持
- ✅ **表示品質保証**: 歪みのない正確なキャラクター表示
- ✅ **レスポンシブ対応**: 様々なウィンドウサイズで適切に表示

**ユーザー確認済み評価**:
- 「キャラクターの歪みはなくなりました」

**ステータス**: <!-- 🔒 確定済み解決策 - 変更禁止 --> **完全解決済み**

### ✅ **解決策2: デバッグ関数常時利用可能化**（解決済み - 2025-08-15）

**修正対象ファイル**: `src/renderer/spine-preview-layer.js`

#### **修正箇所**: デバッグ関数登録条件
**場所**: `initializeDebugMode`関数呼び出し部分  
**修正内容**:
```javascript
// 修正前（問題のあるコード）
if (isDev && isElectron) {
    this.initializeDebugMode();
}

// 修正後（常時利用可能）
this.initializeDebugMode(); // 条件を削除
```

#### **技術的詳細**
- **条件削除**: `isDev && isElectron`条件を撤廃
- **常時登録**: 環境に関わらずデバッグ関数を登録
- **アクセス保証**: 開発・本番問わずデバッグ機能を利用可能

#### **実装結果**
- ✅ **関数利用可能**: `window.enableSpineDebugMode()`が正常動作
- ✅ **デバッグ機能**: 問題調査時のツールが常時利用可能
- ✅ **トラブルシューティング効率化**: 開発・調査作業の改善

**動作確認済み**:
- `window.enableSpineDebugMode()`が正常実行
- エラーなくデバッグモードに移行

**ステータス**: <!-- 🔒 確定済み解決策 - 変更禁止 --> **完全解決済み**

## 📊 問題解決実績

| 問題要素 | 解決状況 | 解決日 | 解決策 |
|---------|---------|-------|-------|
| ウィンドウリサイズ時キャラクター歪み | ✅ 完全解決 | 2025-08-15 | Canvas正方形固定 + object-fit |
| デバッグ関数アクセス不可 | ✅ 完全解決 | 2025-08-15 | 環境条件削除 + 常時利用化 |

## 🔧 診断・テスト方法

### 問題1確認手順（ウィンドウリサイズ）
1. **デスクトップアプリ起動**
   ```bash
   npm start
   ```

2. **Spineプレビュー表示**
   - フォルダ選択 → HTMLファイル選択 → プレビュー表示

3. **リサイズテスト**
   - ウィンドウを横長・縦長に変更
   - キャラクターの縦横比を確認
   - 歪みがないことを確認

### 問題2確認手順（デバッグ関数）
1. **デベロッパーツール起動**
   - F12キーでコンソールを開く

2. **デバッグ関数テスト**
   ```javascript
   // 関数存在確認
   typeof window.enableSpineDebugMode
   
   // 関数実行テスト
   window.enableSpineDebugMode()
   ```

3. **正常動作確認**
   - エラーが発生しないこと
   - デバッグモードが有効になること

### コンソール診断コマンド
```javascript
// Canvas情報確認
console.log('Canvas size:', canvas.width, 'x', canvas.height);
console.log('Canvas style:', canvas.style.objectFit);

// デバッグ関数確認
console.log('Debug functions:', Object.keys(window).filter(k => k.includes('Debug')));
```

## 💡 予防策・ベストプラクティス

### ウィンドウリサイズ対応の基本原則
1. **アスペクト比保持**: コンテンツの形状を維持する設計
2. **CSS活用**: object-fit/object-positionによる適切な配置制御
3. **レスポンシブテスト**: 様々な画面サイズでの動作確認
4. **視覚的品質確保**: ユーザー体験を損なわない表示品質

### デバッグ機能設計の基本原則
1. **常時利用可能**: 環境に依存しないデバッグツール提供
2. **アクセス性確保**: 開発・調査時の利便性優先
3. **機能分離**: デバッグ機能の独立性確保
4. **エラーハンドリング**: デバッグ機能自体がエラーの原因にならない設計

### 類似問題の予防
- **新UI追加時**: レスポンシブ動作の事前確認
- **Canvas操作機能追加時**: アスペクト比制御の整合性確認
- **デバッグ機能追加時**: 環境依存しない設計の採用
- **Electronアップデート時**: 環境判定ロジックの再確認

## 📚 関連情報

### 技術仕様
- **Canvas要素**: object-fit: contain による歪み防止
- **Electron環境**: 環境判定に依存しないデバッグ機能設計
- **レスポンシブ対応**: 様々なウィンドウサイズでの表示品質保証

### 学習リソース
- [CSS object-fit プロパティ](https://developer.mozilla.org/ja/docs/Web/CSS/object-fit)
- [Electron デバッグ機能設計](https://www.electronjs.org/docs/latest/tutorial/debugging-main-process)
- [Canvas要素のレスポンシブ対応](https://developer.mozilla.org/ja/docs/Web/API/Canvas_API)

---

**📝 最終更新**: 2025-08-15  
**記録者**: Claude Code  
**ステータス**: 全問題完全解決済み