# Spine Editor Desktop v2.0 - index.html自動パラメーター注入問題

## 🚨 問題概要

**現象**: Spine Editor Desktop v2.0のHTMLプレビュー機能で、「index.html」ファイルのみにSpine Editorパラメーターが自動的に追加される問題

**重要度**: 中（回避策あり・機能に支障なし）
**ステータス**: 調査中・回避策で対応済み
**発見日**: 2025-08-13
**最終更新**: 2025-08-13

---

## 🔍 問題詳細

### 発生パターン
| ファイル名 | Spine Editorパラメーター | 結果 |
|------------|----------------------|------|
| **index.html** | ✅ 自動追加される | 編集モードが起動してしまう |
| test-pure.html | ❌ 追加されない | 正常なHTMLプレビュー |
| index_.html | ❌ 追加されない | 正常なHTMLプレビュー |

### 環境情報
- **アプリケーション**: Spine Editor Desktop v2.0
- **機能**: HTMLプレビュー（iFrame + HTTPサーバー）
- **対象OS**: Windows (WSL2)
- **Node.js版**: 確認済み

---

## 🕵️ 実施した調査

### Stage 1: クライアント側プレビュー機構分析 ✅
**結果**: HTMLプレビューはiframe + HTTPサーバー経由で配信
- プレビューメカニズム: 正常動作確認
- iframe実装: 問題なし

### Stage 2: サーバー側特殊処理分析 ✅
**結果**: HTTPサーバーがプロジェクトフォルダ全体を配信
- サーバー設定: 標準的な静的ファイル配信
- 特殊なルーティング: 検出されず

### Stage 3: ファイル名基準の自動検知分析 ✅
**結果**: spine-positioning-system-explanation.jsが?edit=trueを自動検知
- 自動検知機能: 存在確認済み
- 条件: ファイル名「index.html」が対象

### Stage 4: Spine Editor自動起動条件分析 ✅
**結果**: 純粋なindex.htmlにはSpine関連スクリプトタグが存在しない
- HTMLファイル内容: JavaScriptなし
- 自動注入: 何らかの仕組みで発生

### Stage 5: 根本原因特定 ✅
**決定的証拠 - コンソールログ**:
```
🚀 Spine Editor v2.0 initializing...
spine-core.js, app.js, ui.js等が自動実行
index.html:203, index.html:250 からJavaScript実行ログ出力
```

**重要な矛盾点**: 
- 実際のindex.htmlファイルには一切JavaScriptが含まれていない
- しかし「index.html:203, index.html:250」からスクリプトが実行されている

---

## 🎯 根本原因（推定）

**HTTPサーバーによる動的JavaScript注入機能**

1. **トリガー条件**: リクエストされたファイル名が「index.html」の場合
2. **注入タイミング**: HTMLファイル配信時
3. **注入内容**: Spine Editor関連のJavaScript
4. **注入場所**: HTMLの特定行（203行目、250行目）

**推定される実装場所**:
- `/src/main/server.js` - HTTPサーバー実装
- `/src/renderer/js/project-loader.js` - プロジェクト読み込み処理
- その他のサーバーミドルウェア

---

## 🛠️ 試行した解決策

### ❌ 失敗: project-loader.js修正
**実施内容**:
```javascript
// 修正前
isIndex: fileName.toLowerCase() === 'index.html'
// 修正後  
isIndex: false
```

**結果**: 効果なし・問題継続
**原因**: 注入機能が別の場所に実装されている可能性

---

## ✅ 確立済み回避策

### 🎯 ファイル名変更による回避
**方法**: ファイル名を「index.html」以外に変更
**推奨名**: `index_.html`, `main.html`, `preview.html`
**効果**: 完全に問題回避・正常なHTMLプレビュー
**制約**: なし（機能に一切影響なし）

**実装例**:
```bash
# ファイル名変更
mv index.html index_.html

# プレビュー
# → index_.htmlは正常なHTMLプレビューとして動作
```

---

## 📋 今後の調査計画

### Phase A: サーバー側詳細分析（優先度: 中）
- [ ] `/src/main/server.js`のリクエスト処理詳細分析
- [ ] ミドルウェアによるHTML変換処理の特定
- [ ] 動的注入機能の実装場所特定

### Phase B: 注入機能の制御方法調査（優先度: 低）
- [ ] 注入機能の無効化設定の調査
- [ ] 条件分岐による制御方法の検討
- [ ] 設定ファイルによる動作変更の可能性調査

### Phase C: 根本修正の実装（優先度: 低）
- [ ] 注入機能の条件変更
- [ ] ユーザー設定による制御機能追加
- [ ] プレビューモードの選択機能実装

**注意**: 現在は回避策で十分対応できており、緊急性は低い

---

## 🔧 開発者向け情報

### デバッグ方法
**ブラウザ開発者ツールでの確認**:
1. F12でコンソールを開く
2. 「🚀 Spine Editor v2.0 initializing...」ログを確認
3. JavaScriptファイルの読み込み状況を確認
4. `index.html:行数` 形式のログで注入箇所を特定

### 関連ファイル
- **サーバー実装**: `/src/main/server.js`
- **プロジェクト読み込み**: `/src/renderer/js/project-loader.js`
- **HTMLプレビュー**: `/src/renderer/js/html-previewer.js`
- **Spine初期化**: `/src/renderer/js/spine-core.js`

### 技術的制約
- HTTPサーバーによる動的処理のため、静的解析では限界あり
- 実行時デバッグが必要
- サーバー側コードの詳細理解が必要

---

## 📊 影響評価

### ✅ 影響範囲
- **対象**: HTMLプレビュー機能のみ
- **ファイル**: 「index.html」という名前のファイルのみ
- **機能**: プレビュー時の表示内容

### ❌ 影響しない範囲
- アプリケーション本体機能: 影響なし
- エクスポート機能: 影響なし
- その他のHTMLファイル: 影響なし
- 開発作業: 回避策により影響なし

### 🎯 重要度判定
**総合評価: 中（対応済み）**
- 機能への重大な影響: なし
- 開発効率への影響: 軽微（ファイル名変更で解決）
- ユーザビリティへの影響: 軽微

---

## 📝 学習事項・教訓

### 🔍 技術的発見
1. **動的JavaScript注入技術の存在**
   - HTTPサーバーレベルでのHTML変換処理
   - ファイル名による条件分岐処理
   - ランタイムでのスクリプト追加機能

2. **デスクトップアプリでのWeb技術統合**
   - Electronベースアプリでの複雑な処理
   - 静的ファイルと動的処理の組み合わせ
   - ブラウザ環境とデスクトップ環境の橋渡し

### 💡 問題解決手法
1. **段階的調査の有効性**
   - クライアント→サーバー→ファイル名→コード分析の順序
   - 各段階での仮説検証
   - 証拠に基づく原因推定

2. **回避策の重要性**
   - 根本解決を待たずに開発継続
   - シンプルで確実な回避方法
   - ビジネス影響の最小化

### 🚨 注意事項
- ファイル名「index.html」は特別な意味を持つ可能性
- デスクトップアプリの内部処理は複雑な場合がある
- 完全な理解よりも実用的な解決策を優先すべき場合がある

---

## 📚 参考情報

### 関連する既知問題
- [HTMLプレビュー404エラー問題.md](../HTMLプレビュー404エラー問題.md)

### 外部リソース
- Electron公式ドキュメント: webContents.executeJavaScript
- Express.js ミドルウェア: HTML変換処理
- Node.js HTTPサーバー: 動的レスポンス生成

---

**📅 最終更新**: 2025-08-13  
**👤 調査者**: Claude Code  
**✅ ステータス**: 回避策で対応済み・根本調査は今後継続